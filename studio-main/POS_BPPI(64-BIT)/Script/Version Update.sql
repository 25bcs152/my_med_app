
 --------------------------------Table Related Query-------------------------

 GO
 iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='POSStartUpPath' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [SO_DETAIL] 
		ADD			[POSStartUpPath] nvarchar(2000) NULL
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CurrentVersion' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [SO_DETAIL] 
		ADD			[CurrentVersion] nvarchar(200) NULL;
		UPDATE		ConfigurationMaster 
		SET			CurrentVersion='1.0.0.6',
					POSStartUpPath='E:\BPPI POS\Application',
					CurrentDbId=7,
					CurrentExeId=7
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Po_IsSync' And object_id=OBJECT_ID('PoHeader'))
	BEGiN
		ALTER TABLE [PoHeader] 
		ADD			[Po_IsSync] BIT NULL;
		UPDATE		PoHeader 
		SET			Po_IsSync=0;
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_IsSync' And object_id=OBJECT_ID('SalesInvoiceHeader'))
	BEGiN
		ALTER TABLE [SalesInvoiceHeader] 
		ADD			[Sih_IsSync] BIT NULL;
		UPDATE		SalesInvoiceHeader 
		SET			Sih_IsSync=0;
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pid_Sales_Rate' And object_id=OBJECT_ID('PurchaseInvoiceDetail'))
	BEGiN
		ALTER TABLE [PurchaseInvoiceDetail] 
		ADD			[Pid_Sales_Rate] NUMERIC(18,3) NULL;
	END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pih_LastSyncDate' And object_id=OBJECT_ID('PurchaseInvoiceHeader'))
	BEGiN
		ALTER TABLE [PurchaseInvoiceHeader] 
		ADD			[Pih_LastSyncDate] DATETIME NULL;
	END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pid_Com_Perc' And object_id=OBJECT_ID('PurchaseInvoiceDetail'))
	BEGiN
		ALTER TABLE [PurchaseInvoiceDetail] 
		ADD			[Pid_Com_Perc] NUMERIC(5,2) NULL;
	END
GO


iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Act_Narration' And object_id=OBJECT_ID('AccountTransaction'))
	BEGiN
		ALTER TABLE [AccountTransaction] 
		ADD			[Act_Narration] VARCHAR(MAX) NULL;
	END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='PO_LastSyncDate' And object_id=OBJECT_ID('POHeader'))
	BEGiN
		ALTER TABLE [POHeader] 
		ADD			[PO_LastSyncDate] DATETIME NULL;
	END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_LastSyncDate' And object_id=OBJECT_ID('SalesInvoiceHeader'))
	BEGiN
		ALTER TABLE [SalesInvoiceHeader] 
		ADD			[Sih_LastSyncDate] DATETIME NULL;
	END
GO

IF EXISTS(SELECT * FROM sys.tables WHERE name='##TEMP_INV_PRINT_DATA')
BEGIN
	 DROP TABLE		##TEMP_INV_PRINT_DATA
END
GO
Update				TblDependency 
Set					Active=0 
Where				[Table]='PoItemDetails'
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CurrentExeId' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			[CurrentExeId] BIGINT NULL
	END

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CurrentDbId' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			[CurrentDbId]  BIGINT NULL
	END

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CheckForUpdate' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			[CheckForUpdate] BIT NULL
	END
GO

update				ConfigurationMaster 
SET					CheckForUpdate=1;
GO
ALTER TABLE			[MedicineMaster] 
ALTER COLUMN		[Mm_Name] VARCHAR (1000)  NULL
ALTER TABLE			[MedicineMaster] 
ALTER COLUMN		[Mm_SaltName]  VARCHAR (1000)  NULL
ALTER TABLE			[MedicineMaster] 
ALTER COLUMN		[Mm_SearchKey] VARCHAR (1000)  NULL
GO
iF EXiSTS(SELECT * FROM sys.tables WHERE name='SyncConfig')
	BEGiN
		DROP TABLE	SyncConfig
	END
GO
CREATE TABLE [dbo].[SyncConfig]
(
			[id] [int] NULL,
			[Module] [varchar](500) NULL,
			[Sync_Min] [int] NULL,
			[IsActive] [bit] NULL,
			[LastExecutionTime] [datetime] NULL
) ON		[PRIMARY]

GO
SET ANSI_PADDING OFF
GO
DELETE 
FROM		SyncConfig
GO
SET ANSI_PADDING OFF
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(1, N'Medicine', 1440, 1, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(2, N'All Medicine', 10080, 1, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(3, N'Dispatch Detail', 1440, 1, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(4, N'Purchase Order', 180, 1, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(5, N'Sales Detail', 240, 1, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(6, N'Opening Sales/Purchase', 30, 0, NULL)
GO
INSERT		[dbo].[SyncConfig] ([id], [Module], [Sync_Min], [IsActive], [LastExecutionTime]) 
VALUES		(7, N'Medicine Stock', 1440, 1, NULL)
GO
GO

GO
if EXiSTS(SELECT * FROM sys.tables WHERE name='VendorTypeMaster')
BEGiN
	DROP TABLE VendorTypeMaster
END
	
CREATE TABLE [dbo].[VendorTypeMaster](
		[Vt_Id] [int] NOT NULL,
		[Vt_Name] [varchar](100) NOT NULL,
	CONSTRAINT [PK_VendorTypeMaster] PRIMARY KEY CLUSTERED 
(
	[Vt_Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
	
GO
INSERT [dbo].[VendorTypeMaster] ([Vt_Id], [Vt_Name]) VALUES (1, N'BPPI')
INSERT [dbo].[VendorTypeMaster] ([Vt_Id], [Vt_Name]) VALUES (2, N'Other')
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Vendor_Vt_Id' And object_id=OBJECT_ID('VendorMaster'))
	BEGiN
		ALTER TABLE VendorMaster 
		ADD			Vendor_Vt_Id  INT NULL
	END

GO
UPDATE				VendorMaster 
SET					Vendor_Vt_Id =1
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CurrentAuId' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			CurrentAuId int NULL
		
	END
GO
if EXiSTS(SELECT * FROM ConfigurationMaster WHERE ISNULL(CurrentAuId,0)=0)
	BEGIN
		UPDATE		ConfigurationMaster 
		SET			CurrentAuId=1
	END

GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='CurrentAuVersion' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			CurrentAuVersion NVARCHAR(200) NULL
	END
GO
if EXiSTS(SELECT * FROM ConfigurationMaster WHERE ISNULL(CurrentAuVersion,'')='')
	BEGIN
		UPDATE		ConfigurationMaster 
		SET			CurrentAuVersion='1.0.0.2'
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='ReportsConfig')
	BEGiN
		CREATE TABLE [dbo].[ReportsConfig](
			[id] [int] NOT NULL,
			[DocType] [int] NULL,
			[ReportName] [nvarchar](500) NULL,
			[ReportSize] [nvarchar](500) NULL,
			[DirectPrint] [bit] NULL,
			[IsActive] [bit] NULL,
		 CONSTRAINT [PK_ReportsConfig] PRIMARY KEY CLUSTERED 
		(
			[id] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
		
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(1, 2, N'A4_SalesInvoice.rdlc', N'A4', 0, 1)
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(2, 2, N'A5_SalesInvoice.rdlc', N'A5', 0, 0)
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(3, 2, N'SalesInvoiceWithOneHeader.rdlc', N'13*15-With Repeat Header', 0, 0)
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(4, 2, N'SalesInvoice.rdlc', N'13*15-Without Repeat Header', 0, 0)
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(5, 2, N'SalesInvoice_DotMatrix.rdlc', N'A4-Dot Matrix Printer', 0, 0)
		INSERT		[dbo].[ReportsConfig] ([id], [DocType], [ReportName], [ReportSize], [DirectPrint], [IsActive]) 
		VALUES		(6, 2, N'SalesInvoice_4inch.rdlc', N'4*6 Inch', 0, 0)
	END
GO

iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Report Configuration')
	BEGiN
		INSERT		[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
		VALUES		((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Report Configuration', N'frmReportConfig', 14, N'Y', NULL, 2, N'E', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	END
GO
if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Report Configuration') AND [UserRights_UserId]=1)
BEGiN
	DECLARE			@ID	INT=0
	SELECT			@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	INSERT			[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], 
					[UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	VALUES			(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Report Configuration'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
END

GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='cPOS_PoApprovalHistory')
	BEGiN
		 CREATE TABLE [dbo].[cPOS_PoApprovalHistory](
	           [Poh_Id] [bigint] NULL,
	           [Poh_Po_Key] [bigint] NULL,
	           [Poh_Po_No] [varchar](100) NULL,
	           [Poh_ApproveStatus] [varchar](100) NULL,
	           [Poh_SalesOrderNo] [varchar](100) NULL,
	           [Poh_Remarks] [nvarchar](max) NULL,
	           [Poh_UpdatedBy] [int] NULL,
	           [Poh_UpdatedDt] [datetime] NULL
           ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END
GO
iF NOT EXiSTS(SELECT * FROM [MenuMaster] WHERE [Menu_FormName]='frmResolveConflictBatch')
BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], 
					[Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Resolve Batch Conflict', N'frmResolveConflictBatch', 46, N'Y', NULL, 3, N'E', N'Expired Medicine Stock.png', NULL, NULL, NULL, NULL, NULL, NULL, 1, 1)
END
GO
DECLARE				@USER_RIGHT_ID	INT=0
SELECT				@USER_RIGHT_ID=ISNULL(MAX(UserRights_ID),0)+1
FROM				UserRights

iF NOT EXiSTS( SELECT * FROM UserRights WHERE UserRights_MenuId=(SELECT TOP 1 Menu_ID FROM [MenuMaster] WHERE [Menu_FormName]='frmResolveConflictBatch'))
BEGiN
	INSERT			[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], [UserRights_Export],
					[UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	VALUES			(513, 1, (SELECT TOP 1 Menu_ID FROM [MenuMaster] WHERE [Menu_FormName]='frmResolveConflictBatch'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 11, 1, CAST(0x0000A94301897F76 AS DateTime), NULL, NULL)
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='AutoSyncDays' And object_id=OBJECT_ID('ConfigurationMaster'))
	BEGiN
		ALTER TABLE [ConfigurationMaster] 
		ADD			[AutoSyncDays] INT NULL
	END
GO
UPDATE				ConfigurationMaster 
SET					AutoSyncDays=2
GO
IF NOT EXISTS(SELECT * FROM ReportsConfig WHERE ReportName='A4_SalesInvoice_DPOS.rdlc')
BEGIN
     INSERT INTO	ReportsConfig(id,DocType,ReportName,ReportSize,DirectPrint,IsActive)
     VALUES						((SELECT ISNULL(MAX(Id),0)+1 FROM ReportsConfig),2,'A4_SalesInvoice_DPOS.rdlc','DPosSalesInvoice',0,0)
END

IF NOT EXISTS(SELECT * FROM ReportsConfig WHERE ReportName='SalesInvoice_4inch.rdlc')
BEGIN
     INSERT INTO	ReportsConfig(id,DocType,ReportName,ReportSize,DirectPrint,IsActive)
     VALUES						((SELECT ISNULL(MAX(Id),0)+1 FROM ReportsConfig),2,'SalesInvoice_4inch.rdlc','4*6 Inch',0,0)
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Taluka' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Taluka] nvarchar(500) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_PoVillage' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_PoVillage] nvarchar(500) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Landmark' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Landmark] nvarchar(500) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Pincode' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Pincode] nvarchar(30) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_StoreOwner' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_StoreOwner] nvarchar(500) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_ContactPerson' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_ContactPerson] nvarchar(500) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_ContactPersonPh' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_ContactPersonPh] nvarchar(50) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Email2' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Email2] nvarchar(199) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_PanDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_PanDoc] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Adhaar_No' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Adhaar_No] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_AdhaarDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_AdhaarDoc] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_GstDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_GstDoc] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_Aadhar_No' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_Aadhar_No] nvarchar(50) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_NoDecDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_NoDecDoc] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_DrugLicDoc1' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_DrugLicDoc1] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_DrugLicDoc2' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster]
	ADD			[Store_DrugLicDoc2] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_DrugLiceDt2' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_DrugLiceDt2] datetime NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_DrugLice2' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_DrugLice2] nvarchar(50) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_PermOpenDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_PermOpenDoc] nvarchar(max) NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_StoreAggreDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_StoreAggreDoc] nvarchar(max) NULL
END
   GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_AuthPersonPhoto' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_AuthPersonPhoto] nvarchar(max) NULL
END
 GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_AuthLetterDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_AuthLetterDoc] nvarchar(max) NULL
END
 GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_SecChequeDoc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_SecChequeDoc] nvarchar(max) NULL
END
 GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_SecCheque2Doc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_SecCheque2Doc] nvarchar(max) NULL
END
 GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_SecCheque2Doc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE [StoreMaster] 
	ADD			[Store_SecCheque3Doc] nvarchar(max) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='StateId' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[StateId] int NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='StoreCode' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[StoreCode] varchar(200) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Contact_PersonName' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[Contact_PersonName] varchar(150) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='StoreId' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[StoreId] int NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Gst_no' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[Gst_no] nvarchar(50) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Gst_Date' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[Gst_Date] datetime NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Drug_Lic' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[Drug_Lic] nvarchar(50) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Drug_Lic_Date' And object_id=OBJECT_ID('PatientMaster'))
BEGiN
	ALTER TABLE [PatientMaster] 
	ADD			[Drug_Lic_Date] datetime NULL
END

--GO
--iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
--BEGiN
--	iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockRegister_MRP_SALES_RATE_UPDATE')
--		BEGiN
--			SELECT		*
--			iNTO		StockRegister_MRP_SALES_RATE_UPDATE
--			FROM		StockRegister
--		END
--	UPDATE				StockRegister
--	SET					Stk_SalesRate=CONVERT(NUMERIC(12,2),((X.Stk_Mrp-(X.Stk_Mrp*C.Mtm_TaxValue)/(100+C.Mtm_TaxValue))/100*80))
--	FROM				StockRegister X
--						iNNER JOIN MedicineMaster B
--	ON					X.Stk_MmId=B.MM_ID
--						LEFT JOIN MedicineWiseTaxMaster C
--	ON					B.Mm_ID=C.Mtm_MmId
--						AND C.Mtm_TaxId=4
--END
Go
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='PoHeader_Store')
BEGiN
     CREATE TABLE [dbo].[PoHeader_Store](
     					[Po_POS_KEY] [numeric](18, 0) NULL,
     					[Po_Key] [numeric](18, 0) NOT NULL,
     					[Po_No] [numeric](18, 0) NOT NULL,
     					[Po_Date] [datetime] NULL,
     					[Po_RefNo] [nvarchar](50) NULL,
     					[Po_RefDate] [datetime] NULL,
     					[Po_RevNo] [int] NULL,
     					[Po_RevDate] [datetime] NULL,
     					[Po_DelDate] [datetime] NULL,
     					[Po_BasicVal] [numeric](18, 0) NULL,
     					[Po_Disc] [numeric](18, 0) NULL,
     					[Po_Disc_Val] [numeric](18, 0) NULL,
     					[Po_TotVal] [numeric](18, 0) NULL,
     					[Po_Annexure] [nvarchar](max) NULL,
     					[Po_CoverLetter] [nvarchar](max) NULL,
     					[Po_Remarks] [varchar](500) NULL,
     					[Po_PaymentTerms] [nvarchar](max) NULL,
     					[Po_CreditDays] [int] NULL,
     					[Po_AuthDate] [datetime] NULL,
     					[Po_CreatedBy] [int] NULL,
     					[Po_CreatedDt] [datetime] NULL,
     					[Po_Store_Code] [varchar](50) NULL
     ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='PoItemDetails_Store')
BEGiN
	CREATE TABLE [dbo].[PoItemDetails_Store](
						[Pi_Key] [numeric](18, 0) NOT NULL,
						[Pi_PoKey] [numeric](18, 0) NOT NULL,
						[Pi_SrNo] [bigint] NOT NULL,
						[Pi_ItemId] [numeric](8, 0) NULL,
						[Pi_ItemName] [nvarchar](500) NULL,
						[Pi_Qty] [numeric](14, 3) NULL,
						[Pi_Rate] [numeric](14, 3) NULL,
						[Pi_Disc] [numeric](14, 3) NULL,
						[Pi_Disc_Val] [numeric](14, 3) NULL,
						[Pi_Amt] [numeric](18, 3) NULL,
						[Pi_Net_Amt] [numeric](18, 3) NULL,
						[Pi_Remarks] [varchar](max) NULL,
						[PI_SO_QTY] [numeric](12, 2) NULL,
						[PI_Po_POS_KEY] [numeric](18, 0) NULL
    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_Po_Key' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_Po_Key] int NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_LR_NO' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_LR_NO] varchar(500) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_Lr_Date' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_Lr_Date] Datetime NULL
END
Go

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_TrasporterName' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_TrasporterName] nvarchar(max) NULL
END
Go

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_No_Of_Cases' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_No_Of_Cases] int NULL
END
Go

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_Freight_Amount' And object_id=OBJECT_ID('SalesInvoiceHeader'))
BEGiN
	ALTER TABLE [SalesInvoiceHeader] 
	ADD			[Sih_Freight_Amount] numeric(12,2) NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sid_Po_Key' And object_id=OBJECT_ID('SalesInvoiceItemDetail'))
BEGiN
	ALTER TABLE [SalesInvoiceItemDetail] 
	ADD			[Sid_Po_Key] int NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='SO_HEADER')
BEGiN
    CREATE TABLE [dbo].[SO_HEADER]
	(
       			[Po_Key] [numeric](18, 0) NOT NULL,
       			[Po_No] [numeric](18, 0) NOT NULL,
       			[Po_Date] [datetime] NULL,
       			[Po_RefNo] [nvarchar](50) NULL,
       			[Po_RefDate] [datetime] NULL,
       			[Po_RevNo] [int] NULL,
       			[Po_RevDate] [datetime] NULL,
       			[Po_Cate] [numeric](8, 0) NULL,
       			[Po_Type1] [numeric](8, 0) NULL,
       			[Po_Type2] [numeric](8, 0) NULL,
       			[Po_IsCashPurchase] [bit] NULL,
       			[Po_EnqMode] [int] NULL,
       			[Po_QtNo] [nvarchar](15) NULL,
       			[Po_IsAmmendment] [bit] NULL,
       			[Po_VenId] [bigint] NULL,
       			[Po_VenAddId] [bigint] NULL,
       			[Po_DelDate] [datetime] NULL,
       			[Po_Cur] [numeric](8, 0) NULL,
       			[Po_ExchRate] [numeric](18, 0) NULL,
       			[Po_BasicVal] [numeric](18, 0) NULL,
       			[Po_Disc] [numeric](18, 0) NULL,
       			[Po_Disc_Val] [numeric](18, 0) NULL,
       			[Po_TotVal] [numeric](18, 0) NULL,
       			[Po_Annexure] [nvarchar](max) NULL,
       			[Po_CoverLetter] [nvarchar](max) NULL,
       			[Po_Remarks] [varchar](500) NULL,
       			[Po_PaymentTerms] [nvarchar](max) NULL,
       			[Po_CreditDays] [int] NULL,
       			[Po_BmId] [bigint] NULL,
       			[Po_YearId] [numeric](4, 0) NULL,
       			[Po_AuthId] [int] NULL,
       			[Po_AuthDate] [datetime] NULL,
       			[Po_CreatedBy] [int] NULL,
       			[Po_CreatedDt] [datetime] NULL,
       			[Po_UpdatedBy] [int] NULL,
       			[Po_UpdatedDt] [datetime] NULL,
       			[Po_ApproveStatus] [varchar](250) NOT NULL,
       			[Po_ApproveStatusRemark] [nvarchar](500) NULL,
       			[Po_IsSync] [bit] NULL,
       			[Po_LastSyncDate] [datetime] NULL,
       			[Po_POS_KEY] [numeric](18, 0) NULL,
				CONSTRAINT [PK_SO_HEADER] PRIMARY KEY CLUSTERED 
       (
       	[Po_Key] ASC
       )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
    ) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='SO_DETAIL')
	BEGiN
		CREATE TABLE [dbo].[SO_DETAIL](
        		[Pi_Key] [numeric](18, 0) NOT NULL,
        		[Pi_PoKey] [numeric](18, 0) NOT NULL,
        		[Pi_SrNo] [bigint] NOT NULL,
        		[Pi_InddKey] [numeric](18, 0) NULL,
        		[Pi_IndKey] [numeric](18, 0) NULL,
        		[Pi_IndSrNo] [bigint] NULL,
        		[Pi_IndNo] [varchar](15) NULL,
        		[Pi_ItemId] [numeric](8, 0) NULL,
        		[Pi_ItemName] [nvarchar](500) NULL,
        		[Pi_Qty] [numeric](14, 3) NULL,
        		[Pi_Rate] [numeric](14, 3) NULL,
        		[Pi_Disc] [numeric](14, 3) NULL,
        		[Pi_Disc_Val] [numeric](14, 3) NULL,
        		[Pi_Uom] [numeric](8, 0) NULL,
        		[Pi_Amt] [numeric](18, 3) NULL,
        		[Pi_Net_Amt] [numeric](18, 3) NULL,
        		[Pi_PiQty] [numeric](18, 2) NULL,
        		[Pi_Remarks] [varchar](max) NULL,
        		[Pi_ShortCloseQty] [numeric](18, 2) NULL,
        		[Pi_ShortCloseBy] [int] NULL,
        		[Pi_ShortCloseDt] [datetime] NULL,
		  CONSTRAINT [PK_SO_DETAILS] PRIMARY KEY CLUSTERED 
		 (
        		[Pi_Key] ASC
		 )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
	END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Prh_IsSync' And object_id=OBJECT_ID('PurchaseReturnHeader'))
BEGiN
	ALTER TABLE PurchaseReturnHeader  
	ADD			[Prh_IsSync] [BIT]  NULL
END
Go
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Prh_LastSyncDate' And object_id=OBJECT_ID('PurchaseReturnHeader'))
BEGiN
	ALTER TABLE PurchaseReturnHeader 
	ADD			[Prh_LastSyncDate] datetime NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Store_SecCheque3Doc' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE StoreMaster 
	ADD			[Store_SecCheque3Doc] nvarchar(max) NULL
END
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='PharmacistName' And object_id=OBJECT_ID('StoreMaster'))
BEGiN
	ALTER TABLE StoreMaster 
	ADD			PharmacistName varchar(200) NULL
END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Srh_IsSync' And object_id=OBJECT_ID('SalesReturnHeader'))
BEGiN
	ALTER TABLE SalesReturnHeader 
	ADD			[Srh_IsSync] BIT NULL
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Srh_LastSyncDate' And object_id=OBJECT_ID('SalesReturnHeader'))
BEGiN
	ALTER TABLE SalesReturnHeader 
	ADD			[Srh_LastSyncDate] datetime NULL
END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='IsForDpos' And object_id=OBJECT_ID('ConfigurationMaster'))
BEGiN
	ALTER TABLE ConfigurationMaster 
	ADD			[IsForDpos] BIT NULL;
END
GO
iF EXiSTS(SELECT * FROM ConfigurationMaster A WHERE A.IsForDpos IS NULL)
BEGiN
	UPDATE		ConfigurationMaster 
	SET			IsForDpos=0 ;
END	
GO

GO
IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=1)
BEGIN
	 update		MenuMaster 
	 set		Menu_Name='Store Master',Menu_IsActive=1 where Menu_Name like '%Patient%';
END
GO
IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
BEGIN
	IF EXISTS(SELECT * FROM StockRegister A INNER JOIN MedicineMaster B ON A.Stk_MmId=B.Mm_ID WHERE B.Mm_Code='33')
	BEGIN
		update		MedicineMaster 
		set			MM_PurchaseRatio=1,
					MM_SalesRatio=15,
					MM_PurchaseUom=(SELECT TOP(1) Uom_ID FROM UomMaster WHERE Uom_Name ='15''s'),
					Mm_StkUom=(SELECT TOP(1) Uom_ID FROM UomMaster WHERE Uom_Name ='15''s') 
		WHERE		Mm_Code='33';
		update		StockRegister 
		set			Stk_SalesQty=Stk_PurchaseQty*15 
		FROM		StockRegister  A
					iNNER JOIN MedicineMaster B
		ON				A.Stk_MmId=B.Mm_ID
		WHERE		B.Mm_Code='33';
	END
END

iF NOT EXiSTS(SELECT * FROM AreaMaster WHERE Area_Name='Bilaspur')
	BEGiN
		DECLARE		@A_ID	INT
		SELECT		@A_ID=ISNULL(MAX(Area_ID),0)+1
		FROM		AreaMaster	
		iNSERT iNTO AreaMaster(Area_ID, Area_Code, Area_Name, Area_Pincode, Area_ContryId, Area_StateId, Area_CityId, Area_CreatedBy, Area_CreatedDt, Area_IsActive)
		VALUES		(@A_ID,'Bilaspur','Bilaspur','122413',8,12,162,1,GETDATE(),1)
	END
GO
UPDATE				VendorAddMaster 
SET					VendAdd_Addr1='Sugal Logistic Park, Warehouse No.1',
					VendAdd_Add2=',Opp. GITM College, Bilaspur-Tauru Road,Khasra No. 60//14/2, 17,24,6,15, 16, 25, 7/1, 14/1,  61//9, 10, 11, 62//3/2, 4,of Village Bilaspur and Khasra No. 10//17, 24, 19//3, 8/2, 9/1/1, 12/2/2/2 min 13/1/1 min of Village  Pathrari,',
					VendAdd_Add3='District Gurgaon Haryana India -122413' ,
					VendAdd_CityId=162,
					VendAdd_AreaId=(SELECT TOP(1) Area_ID FROM AreaMaster WHERE Area_Name='Bilaspur'),
					VendAdd_GstNo='06AABAB0710E1ZN',
					VendAdd_DrugLic1='HR-6600-424-OW\H ,HR-6600-424-W\H' 
WHERE				VendAdd_Id=1
	
GO
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='GSTR 3')
BEGiN
	INSERT			[dbo].[MenuMaster]	([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], 
											[Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
								VALUES	((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'GSTR 3', N'frmGSTR3', 455, N'Y', NULL, 3, N'R', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='GSTR 3') AND [UserRights_UserId]=1)
    BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	     VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='GSTR 3'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
   END
END
GO
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Backup Database')
BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], 
					[Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Backup Database', N'frmBackupDbMenu', 14, N'Y', NULL, 2, N'E', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Backup Database') AND [UserRights_UserId]=1)
    BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], 
					[UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		 VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Backup Database'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
   END
END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Drug Wise Stock')
BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], 
					[Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Drug Wise Stock', N'frmMedicineWiseStock', 46, N'Y', NULL, 3, N'E', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Drug Wise Stock') AND [UserRights_UserId]=1)
	BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], 
					[UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		 VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Drug Wise Stock'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
END
END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
    iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Sales Invoice Wise Profit')
    BEGiN
    INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], 
					[Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Sales Invoice Wise Profit', N'frmSalesBillWiseProfit', 98, N'Y', NULL, 16, N'R', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
    if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Sales Invoice Wise Profit') AND [UserRights_UserId]=1)
    BEGiN
		DECLARE		@ID	INT=0
		SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
		INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
    				[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], 
					[UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Sales Invoice Wise Profit'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
    END
END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
     iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Drug Wise Profit')
     BEGiN
     INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey],
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Drug Wise Profit', N'frmDrugWiseProfit', 98, N'Y', NULL, 17, N'R', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
     
     if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT  TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Drug Wise Profit') AND [UserRights_UserId]=1)
     BEGiN
		DECLARE		@ID	INT=0
		SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
		INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
		 			[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Drug Wise Profit'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
     END
     END
END
GO
 iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
	iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Party Wise Profit')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey],
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Party Wise Profit', N'frmPartyWiseProfit', 98, N'Y', NULL, 18, N'R', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)

	 if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Party Wise Profit') AND [UserRights_UserId]=1)
	 BEGiN
		DECLARE		@ID	INT=0
		SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
		INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Party Wise Profit'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	 END
	END
END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
	iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Party Wise Sales')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Party Wise Sales', N'frmPartyWiseSales', 98, N'Y', NULL, 19, N'R', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Party Wise Sales') AND [UserRights_UserId]=1)
	 BEGiN
		DECLARE		@ID	INT=0
		SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
		INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Party Wise Sales'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	 END
	END
END
GO
	
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Stock Transaction')
BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Stock Transaction', N'frmStockTransactionReport', 103, N'Y', NULL, 14, N'R', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Stock Transaction') AND [UserRights_UserId]=1)
    BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	     VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Stock Transaction'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
   END
END

GO
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='H-1 Drug Register')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'H-1 Drug Register', N'frmH1DrugReport', 98, N'Y', NULL, 20, N'R', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='H-1 Drug Register') AND [UserRights_UserId]=1)
	BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	     VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='H-1 Drug Register'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
	END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
	iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='So Short Qty List')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster),  N'So Short Qty List', N'frmsoshortqty', 98, N'Y', NULL, 21, N'R', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)

	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='So Short Qty List') AND [UserRights_UserId]=1)
	BEGiN
	     DECLARE	@ID	INT=0
	     SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	     INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	     VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='So Short Qty List'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
	END
END
GO
iF EXiSTS(SELECT * FROM StoreMaster WHERE Store_Code LIKE '%LS%')
BEGiN
	iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='So Report')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'So Report', N'frmsoreport', 98, N'Y', NULL, 22, N'R', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='So Report') AND [UserRights_UserId]=1)
	BEGiN
	   DECLARE		@ID	INT=0
	   SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	   INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	   VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='So Report'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
	END
END
GO
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Transfer Out')
	BEGiN
	INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Transfer Out', N'frmStockOutTransList', 46, N'Y', NULL, 13, N'E', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 1)
	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Stock Out') AND [UserRights_UserId]=1)
	BEGiN
	   DECLARE		@ID	INT=0
	   SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
	   INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
	   VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Transfer Out'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	END
	END
GO
iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_Name='Transfer In')
	BEGiN
	 INSERT			[dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], 
					[Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
	VALUES			((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Transfer In', N'frmStockInTransList', 46, N'Y', NULL, 14, N'E', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 1)

	if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Stock In') AND [UserRights_UserId]=1)
	BEGiN
		 DECLARE	@ID	INT=0
		 SELECT		@ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
		 INSERT		[dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], 
					[UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
		 VALUES		(@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_Name='Transfer In'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
	   END
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='Help')
	BEGiN
		CREATE TABLE [dbo].[Help](
				[HM_Id] [int] NULL,
				[HM_Title] [varchar](200) NULL,
				[HM_Url] [varchar](300) NULL
		) ON [PRIMARY]
	END
GO
DELETE FROM Help
IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
	BEGIN
		INSERT [dbo].[Help] ([HM_Id], [HM_Title], [HM_Url]) VALUES (1, N'Training Part-1', N'https://www.youtube.com/watch?v=DzgzpkiuxtE')
		INSERT [dbo].[Help] ([HM_Id], [HM_Title], [HM_Url]) VALUES (2, N'Training Part-2', N'https://www.youtube.com/watch?v=gFlrN_1BnUA')
		INSERT [dbo].[Help] ([HM_Id], [HM_Title], [HM_Url]) VALUES (3, N'Training Part-3', N'https://www.youtube.com/watch?v=BCg2ApSwMCs')
		INSERT [dbo].[Help] ([HM_Id], [HM_Title], [HM_Url]) VALUES (4, N'Training Part-4', N'https://www.youtube.com/watch?v=RyYObbkucaw')
	END

INSERT [dbo].[Help] ([HM_Id], [HM_Title], [HM_Url]) VALUES (5, N'Help & Support', N'http://support.ethicsinnovations.com/login.php')
GO
 
If EXISTS(select * from ConfigurationMaster WHERE IsForDpos=1)
BEGIN
     IF NOT EXISTS(SELECT * FROM LocationMaster WHERE Lm_Name='Saleable')
     BEGIN
          INSERT INTO LocationMaster(Lm_Id,Lm_Code,Lm_Name,Lm_LmId,Lm_CreatedBy,Lm_IsActive)
          VALUES((SELECT ISNULL(MAX(Lm_Id),0)+1 FROM LocationMaster),'Saleable','Saleable',0,1,1);
     END
     IF NOT EXISTS(SELECT * FROM LocationMaster WHERE Lm_Name='Non-Saleable')
     BEGIN
          INSERT INTO LocationMaster(Lm_Id,Lm_Code,Lm_Name,Lm_LmId,Lm_CreatedBy,Lm_IsActive)
          VALUES((SELECT ISNULL(MAX(Lm_Id),0)+1 FROM LocationMaster),'Non-Saleable','Non-Saleable',0,1,1);
     END
      IF NOT EXISTS(SELECT * FROM LocationMaster WHERE Lm_Name='Hold')
     BEGIN
          insert into LocationMaster(Lm_Id,Lm_Code,Lm_Name,Lm_LmId,Lm_CreatedBy,Lm_IsActive)
          values((SELECT ISNULL(MAX(Lm_Id),0)+1 FROM LocationMaster),'Hold','Hold',0,1,1);
     END
END
GO
	
IF NOT EXISTS(SELECT  * FROM CityMaster WHERE City_Name='Guwahati' AND City_StateId=(select State_ID from StateMaster WHERE State_Name='Assam'))
BEGIN
     INSERT INTO CityMaster(City_ID,City_Code,City_Name,City_StateId,City_CountryId,City_CreatedBy,City_IsActive)
     VALUES((SELECT ISNULL(MAX(City_ID),0)+1 FROM CityMaster),'Guwahati','Guwahati',
     (select State_ID from StateMaster WHERE State_Name='Assam'),8,1,1
     )
END
DECLARE @CityId INT
SET @CityId=(SELECT TOP 1 City_Id FROM CityMaster WHERE City_Name='Guwahati' AND City_StateId=(select State_ID from StateMaster WHERE State_Name='Assam'));
IF NOT EXISTS(SELECT  * FROM AreaMaster WHERE Area_Name='Kamrup' AND Area_CityId=(select City_ID from CityMaster WHERE City_Name='Guwahati' 
		AND City_StateId=(select State_ID from StateMaster WHERE State_Name='Assam')))
BEGIN
     INSERT INTO AreaMaster(Area_ID,Area_Code,Area_Name,Area_CityId,Area_StateId,Area_ContryId,Area_CreatedBy,Area_IsActive)
     VALUES((SELECT ISNULL(MAX(Area_ID),0)+1 FROM AreaMaster),'Kamrup','Kamrup',
      @CityId,(select State_ID from StateMaster WHERE State_Name='Assam'),8,1,1
     )
END
DECLARE @Areaid INT
SET @Areaid=(SELECT TOP 1 Area_ID FROM AreaMaster WHERE Area_Name='Kamrup')


IF NOT EXISTS(SELECT * 
                FROM VendorAddMaster 
                     INNER JOIN CityMaster 
                  ON CityMaster.City_ID=VendorAddMaster.VendAdd_CityId 
                     INNER JOIN StateMaster 
                  ON StateMaster.State_ID=CityMaster.City_StateId
               WHERE VendAdd_VendorId=(SELECT VendorMaster.Vendor_ID FROM VendorMaster WHERE Vendor_Name='BPPI') 
                     AND StateMaster.State_Name='Assam')
	BEGIN
		insert into VendorAddMaster(VendAdd_Id,VendAdd_VendorId,VendAdd_Addr1,VendAdd_Add2,VendAdd_Add3,VendAdd_CityId,
		VendAdd_AreaId,VendAdd_PhNo,VendAdd_MobNo,VendAdd_GstNo,VendAdd_GstDt,VendAdd_DrugLic1,VendAdd_CreatedBy,VendAdd_IsActive)
		VALUES((SELECT ISNULL(MAX(VendAdd_Id),0)+1 FROM VendorAddMaster),(SELECT Vendor_ID FROM VendorMaster WHERE Vendor_Name='BPPI'),
		'DAG No.884 of K P PATTA No 04','Mughuapara, Pamohi Village,','Dist.Kamrup(M) Guwahati, Assam India-781035',@CityId,
		@Areaid,'011-49431800','','18AABAB0710E1ZI',CONVERT(DATE,'15-07-2018',105),'D/OL/KMP/19451,D/OL/KMP/19452',1,1)
	END
GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		IF NOT EXISTS(SELECT * FROM VendorMaster WHERE Vendor_Name='S.K ENTERPRISE')
--		BEGIN
--			INSERT [dbo].[VendorMaster] ([Vendor_ID], [Vendor_Code], [Vendor_Name], [Vendor_CreditDays], [Vendor_CreditLimit], [Vendor_CreatedBy], [Vendor_CreatedDt], [Vendor_UpdatedBy], [Vendor_UpdatedDt], [Vendor_IsActive], [Vendor_Ledger_id], [Vendor_Vt_Id]) 
--			VALUES ((SELECT ISNULL(MAX(Vendor_ID),0)+1 FROM VendorMaster), N'LS00055', N'S.K ENTERPRISE', 1, CAST(1.00 AS Numeric(18, 2)), 1, CAST(0x0000A91F00BB53A1 AS DateTime), NULL, NULL, 1, 67, 1)
--		END
--	END
--GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		IF NOT EXISTS (SELECT * FROM CityMaster WHERE City_Name='Jalpaiguri' AND City_StateId=35)
--		BEGIN
--			 INSERT INTO CityMaster(City_ID,City_Name,City_Code,City_StateId,City_CountryId,City_IsActive)
--			VALUES((SELECT ISNULL(MAX(City_ID),0)+1 FROM CityMaster),'Jalpaiguri','Jalpaiguri',35,8,1)
--		END
--	END

--GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		IF NOT EXISTS (SELECT * FROM AreaMaster WHERE Area_Name='Siliguri' AND Area_CityId=(SELECT City_ID FROM CityMaster WHERE City_Name='Jalpaiguri' AND City_StateId=35))
--		BEGIN
--			 INSERT INTO AreaMaster(Area_ID,Area_Name,Area_Code,Area_CityId,Area_StateId,Area_ContryId,Area_IsActive)
--			VALUES((SELECT ISNULL(MAX(Area_ID),0)+1 FROM AreaMaster),'Siliguri','Siliguri',(SELECT City_ID FROM CityMaster WHERE City_Name='Jalpaiguri' AND City_StateId=35),35,8,1)
--		END
--	END
--GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		IF NOT EXISTS(SELECT * FROM VendorAddMaster   WHERE VendAdd_VendorId=(SELECT Vendor_ID FROM VendorMaster WHERE Vendor_Name='S.K ENTERPRISE'))
--		BEGIN
--			INSERT [dbo].[VendorAddMaster] ([VendAdd_Id], [VendAdd_VendorId], [VendAdd_Addr1], [VendAdd_Add2], [VendAdd_Add3], [VendAdd_CityId], [VendAdd_AreaId], [VendAdd_PhNo], [VendAdd_PhNo1], [VendAdd_MobNo], [VendAdd_FaxNo], [VendAdd_Email], [VendAdd_Web], [VendAdd_CstNo], [VendAdd_CstDt], [VendAdd_GstNo], [VendAdd_GstDt], [VendAdd_RegNo], [VendAdd_RegDt], [VendAdd_DrugLic1], [VendAdd_DrugLic2], [VendAdd_DrugLic3], [VendAdd_CreatedBy], [VendAdd_CreatedDt], [VendAdd_UpdatedBy], [VendAdd_UpdatedDt], [VendAdd_IsActive]) 
--			VALUES ((SELECT ISNULL(MAX(VendAdd_Id),0)+1 FROM VendorAddMaster), (SELECT Vendor_ID FROM VendorMaster WHERE Vendor_Name='S.K ENTERPRISE'), N'145 Hill Cat Road( 3rd Floor)', N'Siliguri(Near SENCO Gold And Diamond)', N'', (SELECT City_ID FROM CityMaster WHERE City_Name='Jalpaiguri' AND City_StateId=35),(SELECT Area_ID FROM AreaMaster where Area_Name='Siliguri' AND Area_CityId=(SELECT City_ID FROM CityMaster WHERE City_Name='Jalpaiguri' AND City_StateId=35)) , N'', N'', N'8953267999', N'', N'	siliguri.bppi@gmail.com', N'', N'', NULL, N'19ACZPG3203E1ZM', NULL, N'', NULL, N'DLDJ3070SW3071DBW', N'', N'', 1, CAST(0x0000A91F01241731 AS DateTime), NULL, NULL, 1)
--		END
--	END
--GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		IF NOT EXISTS(SELECT * FROM LedgerMaster WHERE Lm_Name='S.K ENTERPRISE')
--		BEGIN
--			INSERT [dbo].[LedgerMaster] ([Lm_Id], [Lm_Name], [Lm_GroupId], [Lm_PVId], [Lm_Address], [Lm_PhoneNo], [Lm_PanNo], [Lm_GstNo], [Lm_OpeningBalance], [Lm_Description], [Lm_IsStockAffected], [Lm_TaxPer], [Lm_TaxMethod], [Lm_OpeningDate], [Lm_IsActive], [Lm_OpeningDrCr], [LM_IsSysGen]) 
--			VALUES ((SELECT ISNULL(MAX(Lm_Id),0)+1 FROM LedgerMaster), N'S.K ENTERPRISE', 30, (SELECT TOP 1 Vendor_ID FROM VendorMaster WHERE Vendor_Name='S.K ENTERPRISE'), NULL, NULL, NULL, NULL, CAST(0.00 AS Decimal(18, 2)), NULL, NULL, NULL, NULL, CAST(0x0000A90C01565A7C AS DateTime), 1, N'Cr', NULL)
--		END
--	END
--GO
--IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=0)
--	BEGIN
--		UPDATE VendorMaster SET Vendor_Ledger_id=(SELECT TOP 1 Lm_Id FROM LedgerMaster WHERE Lm_Name='S.K ENTERPRISE')
--		WHERE Vendor_ID=(SELECT TOP 1 Vendor_ID FROM VendorMaster WHERE Vendor_Name='S.K ENTERPRISE');
--	END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='SalesChallanHeader')
	BEGiN
	     CREATE TABLE [dbo].[SalesChallanHeader] (
    [Sc_Key]            BIGINT          NULL,
    [Sc_No]             NUMERIC (18)    NULL,
    [Sc_Date]           DATETIME        NULL,
    [Sc_Invtype]        INT             NULL,
    [Sc_Account]        VARCHAR (50)    NULL,
    [Sc_Pm_Id]          BIGINT          NULL,
    [Sc_Dm_Id]          BIGINT          NULL,
    [Sc_GstType]        INT             NULL,
    [Sc_RateType]       INT             NULL,
    [Sc_SubTotal]       NUMERIC (18, 3) NULL,
    [Sc_Total]          NUMERIC (18, 3) NULL,
    [Sc_CreatedBy]      INT             NULL,
    [Sc_CreatedDate]    DATETIME        NULL,
    [Sc_UpdatedBy]      INT             NULL,
    [Sc_UpdatedOn]      DATETIME        NULL,
    [Sc_YearId]         BIGINT          NULL,
    [Sc_Disc]           NUMERIC (5, 2)  NULL,
    [Sc_DiscAmount]     NUMERIC (18, 3) NULL,
    [Sc_Status]         VARCHAR (15)    NULL,
    [Sc_BranchId]       INT             NULL,
    [Sc_CardPay]        DECIMAL (18, 2) NULL,
    [Sc_CashPay]        DECIMAL (18, 2) NULL,
    [Sc_TotalPay]       DECIMAL (18, 3) NULL,
    [Sc_IsCreditBill]   BIT             NULL,
    [Sc_AccId]          INT             NULL,
    [Sc_BookId]         INT             NULL,
    [Sc_DueDate]        DATE            NULL,
    [Sc_IsOriginal]     BIT             NULL,
    [Sc_CardRemarks]    VARCHAR (50)    NULL,
    [Sc_Remark]         VARCHAR (1000)  NULL,
    [Sc_CusRefNo]       VARCHAR (100)   NULL,
    [Sc_IsSync]         BIT             NULL,
    [Sc_LastSyncDate]   DATETIME        NULL,
    [Sc_Po_Key]         INT             NULL,
    [Sc_LR_NO]          VARCHAR (500)   NULL,
    [Sc_Lr_Date]        DATETIME        NULL,
    [Sc_TrasporterName] NVARCHAR (MAX)  NULL,
    [Sc_No_Of_Cases]    INT             NULL,
    [Sc_Freight_Amount] NUMERIC (12, 2) NULL
);
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='SalesChallenItemDetails')
	BEGiN
		CREATE TABLE [dbo].[SalesChallenItemDetails] (
    [Scd_Key]           BIGINT          NOT NULL,
    [Scd_Sch_Key]       BIGINT          NULL,
    [Scd_SrNo]          INT             NULL,
    [Scd_Mm_Id]         BIGINT          NULL,
    [Scd_MRP]           NUMERIC (12, 2) NULL,
    [Scd_BatchNo]       NVARCHAR (MAX)  NULL,
    [Scd_ExpDate]       DATE            NULL,
    [Scd_SalesQty]      NUMERIC (12, 3) NULL,
    [Scd_SalesUomId]    INT             NULL,
    [Scd_SalesRate]     NUMERIC (12, 2) NULL,
    [Scd_SubTotal]      NUMERIC (12, 2) NULL,
    [Scd_Total]         NUMERIC (12, 2) NULL,
    [Scd_MnfDate]       DATE            NULL,
    [Scd_Disc]          NUMERIC (5, 2)  NULL,
    [Scd_DiscAmount]    NUMERIC (18, 2) NULL,
    [Scd_PurchaseQty]   NUMERIC (12, 3) NULL,
    [Scd_PurchaseUomId] INT             NULL,
    [Scd_PurchaseRate]  NUMERIC (12, 2) NULL,
    [Scd_LmId]          INT             NULL,
    [Scd_Po_Key]        INT             NULL,
    [Scd_Po_SrNo]       INT             NULL
);
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockInDetail')
	BEGiN
		CREATE TABLE [dbo].[StockInDetail](
			[Stid_Key] [bigint] NOT NULL,
			[Stid_Stih_Key] [bigint] NULL,
			[Stid_MmId] [numeric](18, 0) NULL,
			[Stid_BatchNo] [varchar](500) NULL,
			[Stid_MnfDate] [date] NULL,
			[Stid_ExpDate] [date] NULL,
			[Stid_SalesQty] [numeric](18, 2) NULL,
			[Stid_SalesRate] [numeric](18, 2) NULL,
			[Stid_SalesUom] [int] NULL,
			[Stid_Mrp] [numeric](18, 2) NULL,
			[Stid_PurchaseQty] [numeric](18, 2) NULL,
			[Stid_PurchaseUom] [int] NULL,
			[Stid_PurchaseRate] [numeric](18, 2) NULL,
			[Stid_LmId] [int] NULL,
		 CONSTRAINT [PK_StockInDetail] PRIMARY KEY CLUSTERED 
		(
			[Stid_Key] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockInHeader')
	BEGiN
		CREATE TABLE [dbo].[StockInHeader](
			[Stih_Key] [bigint] NULL,
			[Stih_No] [numeric](18, 0) NULL,
			[Stih_Date] [datetime] NULL,
			[Stih_Stot_Key] [bigint] NULL,
			[Stih_YearId] [int] NULL,
			[Stih_CreatedBy] [int] NULL,
			[Stih_CreatedOn] [datetime] NULL,
			[Stih_UpdatedBy] [int] NULL,
			[Stih_UpdatedOn] [datetime] NULL,
			[Stih_Status] [varchar](100) NULL,
			[Stih_Remarks] [varchar](5000) NULL
		) ON [PRIMARY]
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockOutDetail')
	BEGiN
		CREATE TABLE [dbo].[StockOutDetail](
			[Stod_Key] [bigint] NULL,
			[Stod_Stoh_Key] [bigint] NULL,
			[Stod_MmId] [numeric](18, 0) NULL,
			[Stod_BatchNo] [varchar](500) NULL,
			[Stod_MnfDate] [date] NULL,
			[Stod_ExpDate] [date] NULL,
			[Stod_SalesQty] [numeric](18, 2) NULL,
			[Stod_SalesRate] [numeric](18, 2) NULL,
			[Stod_SalesUom] [int] NULL,
			[Stod_Mrp] [numeric](18, 2) NULL,
			[Stod_PurchaseQty] [numeric](18, 2) NULL,
			[Stod_PurchaseUom] [int] NULL,
			[Stod_PurchaseRate] [numeric](18, 2) NULL,
			[Stoh_LmId] [int] NULL
		) ON [PRIMARY]
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockOutDetail_Temp')
	BEGiN
		CREATE TABLE [dbo].[StockOutDetail_Temp](
			[tStod_Key] [bigint] NOT NULL,
			[tStod_tStoh_Key] [bigint] NULL,
			[tStod_MmId] [numeric](18, 0) NULL,
			[tStod_BatchNo] [varchar](500) NULL,
			[tStod_MnfDate] [date] NULL,
			[tStod_ExpDate] [date] NULL,
			[tStod_SalesQty] [numeric](18, 2) NULL,
			[tStod_SalesRate] [numeric](18, 2) NULL,
			[tStod_SalesUom] [int] NULL,
			[tStod_Mrp] [numeric](18, 2) NULL,
			[tStod_PurchaseQty] [numeric](18, 2) NULL,
			[tStod_PurchaseUom] [int] NULL,
			[tStod_PurchaseRate] [numeric](18, 2) NULL,
			[tStod_LmId] [int] NULL,
		 CONSTRAINT [PK_StockOutDetail_Temp] PRIMARY KEY CLUSTERED 
		(
			[tStod_Key] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockOutHeader')
	BEGiN
		CREATE TABLE [dbo].[StockOutHeader](
			[Stoh_Key] [bigint] NOT NULL,
			[Stoh_No] [numeric](18, 0) NULL,
			[Stoh_Date] [datetime] NULL,
			[Stoh_To] [nvarchar](50) NULL,
			[Stoh_YearId] [int] NULL,
			[Stoh_CreatedBy] [int] NULL,
			[Stoh_CreatedOn] [datetime] NULL,
			[Stoh_UpdatedBy] [int] NULL,
			[Stoh_UpdatedOn] [datetime] NULL,
			[Stoh_Remarks] [varchar](5000) NULL,
			[Stoh_Status] [varchar](100) NULL,
		 CONSTRAINT [PK_StockOutHeader] PRIMARY KEY CLUSTERED 
		(
			[Stoh_Key] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
	END
	GO
iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='StockOutHeader_Temp')
	BEGiN
		CREATE TABLE [dbo].[StockOutHeader_Temp](
			[tStoh_Key] [bigint] NOT NULL,
			[tStoh_cStoh_Key] [bigint] NOT NULL,
			[tStoh_cStoh_From] [nvarchar](50) NULL,
			[tStoh_Date] [datetime] NULL,
			[tStoh_YearId] [int] NULL,
			[tStoh_CreatedBy] [int] NULL,
			[tStoh_CreatedOn] [datetime] NULL,
			[tStoh_UpdatedBy] [int] NULL,
			[tStoh_UpdatedOn] [datetime] NULL,
			[tStoh_Status] [varchar](100) NULL,
			[tStoh_Remarks] [varchar](5000) NULL,
		 CONSTRAINT [PK_StockOutHeader_Temp] PRIMARY KEY CLUSTERED 
		(
			[tStoh_Key] ASC
		)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
		) ON [PRIMARY]
		
	END
	GO
	iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sih_Type' And object_id=OBJECT_ID('SalesInvoiceHeader'))
		BEGiN
			ALTER TABLE SalesInvoiceHeader ADD [Sih_Type] INT NULL;
		END
	GO
	iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Prh_IsSync' And object_id=OBJECT_ID('PurchaseReturnHeader'))
		BEGiN
			ALTER TABLE PurchaseReturnHeader ADD [Prh_IsSync] INT NULL;
		END
	GO
	Alter table [PurchaseInvoiceDetail] alter column [Pid_DoKey] FLOAT   NULL
    GO
    Alter table [PurchaseInvoiceDetail] alter column [Pid_PoKey] FLOAT   NULL
	GO
	iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pm_PanNo' And object_id=OBJECT_ID('PatientMaster'))
		BEGiN
			ALTER TABLE PatientMaster ADD [Pm_PanNo] NVARCHAR (100) NULL;
		END
	GO
	IF EXISTS(SELECT * FROM ConfigurationMaster WHERE IsForDpos=1)
		BEGIN
				update MenuMaster set Menu_Order=6 WHERE Menu_FormName='frmDSalesInvoiceList'
				iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_FormName='frmSalesChallanList')
					BEGiN
						INSERT [dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
						VALUES ((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Sales Challan', N'frmSalesChallanList', 20, N'Y', NULL, 5, N'E', N'', NULL, NULL, NULL, NULL, NULL, NULL, 1, 1)
					END
				if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_FormName='frmSalesChallanList') AND [UserRights_UserId]=1)
					BEGiN
						DECLARE @ID	INT=0
						SELECT @ID=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
						INSERT [dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
						VALUES (@ID, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_FormName='frmSalesChallanList'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
					END

				iF NOT EXiSTS(SELECT * FROM MenuMaster WHERE Menu_FormName='frmAddManufactureToBatch')
					BEGiN
						INSERT [dbo].[MenuMaster] ([Menu_ID], [Menu_Name], [Menu_FormName], [Menu_ParentId], [Menu_HaveForm], [Menu_Prifix], [Menu_Order], [Menu_Type], [Menu_Icon], [Menu_ShortCutKey], [Menu_Code], [Menu_CreatedBy], [Menu_CreatedDt], [Menu_UpdatedBy], [Menu_UpdatedDt], [Menu_IsActive], [Menu_IsOpenFlMode]) 
						VALUES ((SELECT ISNULL(MAX(Menu_ID),0)+1 FROM MenuMaster), N'Drug Manufaturer Details', N'frmAddManufactureToBatch', 46, N'Y', NULL, 4, N'E', N'Expired Medicine Stock.png', NULL, NULL, NULL, NULL, NULL, NULL, 1, 1)
					END

				if NOT EXiSTS(SELECT * FROM UserRights WHERE [UserRights_MenuId]=(SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_FormName='frmAddManufactureToBatch') AND [UserRights_UserId]=1)
					BEGiN
						DECLARE @ID_A	INT=0
						SELECT @ID_A=ISNULL(MAX([UserRights_ID]),0)+1 FROM UserRights
						INSERT [dbo].[UserRights] ([UserRights_ID], [UserRights_UserId], [UserRights_MenuId], [UserRights_View], [UserRights_Add], [UserRights_Update], [UserRights_Delete], [UserRights_Print], [UserRights_Export], [UserRights_Year], [UserRights_BranchId], [UserRights_CreatedBy], [UserRights_CreatedDt], [UserRights_UpdatedBy], [UserRights_UpdatedDt]) 
						VALUES (@ID_A, 1, (SELECT TOP 1 Menu_ID FROM MenuMaster WHERE Menu_FormName='frmAddManufactureToBatch'), 1, 1, 1, 1, 1, 1, CAST(0 AS Numeric(4, 0)), 9, 1, CAST(0x0000A935017062A2 AS DateTime), NULL, NULL)
					END
		END
	
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pi_Scd_SalesQty' And object_id=OBJECT_ID('SO_DETAIL'))
	BEGiN
		ALTER TABLE [SO_DETAIL] ADD [Pi_Scd_SalesQty] NUMERIC(18,2) NULL
	END

GO

IF EXISTS(SElECT * FROM ConfigurationMaster WHERE IsForDpos=0)
BEGIN
     UPDATE ConfigurationMaster set SrExpDays=0,PrExpDays=0
END
GO



IF EXISTS(SElECT * FROM ConfigurationMaster WHERE IsForDpos=1)
	BEGiN
		UPDATE ConfigurationMaster  SET  AmountRoundOf=2
	END
ELSE
	BEGiN
		UPDATE ConfigurationMaster  SET  AmountRoundOf=3
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pi_Sid_Qty' And object_id=OBJECT_ID('SO_DETAIL'))
	BEGiN
		ALTER TABLE SO_DETAIL ADD [Pi_Sid_Qty] NUMERIC(12,0) NULL;
	END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pi_Sid_Qty' And object_id=OBJECT_ID('SO_DETAIL'))
	BEGiN
		ALTER TABLE SO_DETAIL ADD [Pi_Sid_Qty] NUMERIC(12,0) NULL;
	END
GO


ALTER TABLE AccountTransaction
ALTER COLUMN Act_Key NUMERIC(18,0)
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('AccountTransaction') AND name='IX_Act_DocKey_Act_DocNo_Act_PaidAmount')
	BEGIN
		DROP INDEX IX_Act_DocKey_Act_DocNo_Act_PaidAmount   
		ON AccountTransaction; 
	END
GO

IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('AccountTransaction') AND name='SP_SalesInvoice_SalesDetailForReportWithFilter_AccountTransaction')
	BEGIN
		DROP INDEX [SP_SalesInvoice_SalesDetailForReportWithFilter_AccountTransaction] ON [dbo].[AccountTransaction]
	END
GO
ALTER TABLE AccountTransaction
ALTER COLUMN Act_DocKey NUMERIC(18,0)
GO
ALTER TABLE AccountTransaction
ALTER COLUMN Act_LedgerId NUMERIC(18,0)
GO
ALTER TABLE AccountTransactionRef
ALTER COLUMN Acr_Id NUMERIC(18,0)
GO
ALTER TABLE AccountTransactionRef
ALTER COLUMN Acr_ActKey NUMERIC(18,0)
GO
ALTER TABLE AccountTransactionRef
ALTER COLUMN Acr_DocKey NUMERIC(18,0)
GO


ALTER TABLE AttachmentTransaction
ALTER COLUMN At_DocNo NUMERIC(18,0)
GO
ALTER TABLE AttachmentTransaction
ALTER COLUMN At_DocKey NUMERIC(18,0)
GO


ALTER TABLE cPOS_PoApprovalHistory
ALTER COLUMN Poh_Id NUMERIC(18,0)
GO
ALTER TABLE cPOS_PoApprovalHistory
ALTER COLUMN Poh_Po_Key NUMERIC(18,0)
GO
ALTER TABLE cPOS_SalesInvoiceHeader
ALTER COLUMN Sih_Key NUMERIC(18,0)
GO
ALTER TABLE cPOS_SalesInvoiceItemDetail
ALTER COLUMN Sid_Key NUMERIC(18,0)
GO
ALTER TABLE cPOS_SalesInvoiceItemDetail
ALTER COLUMN Sid_Sih_Key NUMERIC(18,0)
GO

ALTER TABLE DoctorMaster
DROP Constraint PK_Doctor_Master  
GO
ALTER TABLE DoctorMaster
ALTER COLUMN Dm_ID  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_Doctor_Master')
BEGIN
	ALTER TABLE DoctorMaster
	ADD CONSTRAINT PK_Doctor_Master PRIMARY KEY (Dm_ID) ;
END
GO

ALTER TABLE IndentItemSchedule
ALTER COLUMN Inds_IndKey NUMERIC(18,0)
GO
ALTER TABLE IndentItemSchedule
ALTER COLUMN Inds_InddId NUMERIC(18,0)
GO


ALTER TABLE IndentItemSchedule
DROP Constraint PK_INDENT_ITEM_SCHEDULE  
GO
ALTER TABLE IndentItemSchedule
ALTER COLUMN Inds_Id  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_INDENT_ITEM_SCHEDULE')
BEGIN
	ALTER TABLE IndentItemSchedule
	ADD CONSTRAINT PK_INDENT_ITEM_SCHEDULE PRIMARY KEY (Inds_Id) ;
END
GO
ALTER TABLE IndentItemSchedule
ALTER COLUMN Inds_ItmId NUMERIC(18,0)
GO

ALTER TABLE LedgerMaster
DROP Constraint PK_Led_Master  
GO
ALTER TABLE LedgerMaster
ALTER COLUMN Lm_Id NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_Led_Master')
BEGIN
	ALTER TABLE LedgerMaster
	ADD CONSTRAINT PK_Led_Master PRIMARY KEY (Lm_Id) ;
END
GO
ALTER TABLE LedgerMaster
ALTER COLUMN Lm_PVId NUMERIC(18,0)
GO
ALTER TABLE LoginHistory
DROP Constraint PK_LoginHistoryTable  
GO
ALTER TABLE LoginHistory
ALTER COLUMN Lh_Id NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_LoginHistoryTable')
BEGIN
	ALTER TABLE LoginHistory
	ADD CONSTRAINT PK_LoginHistoryTable PRIMARY KEY (Lh_Id) ;
END
GO
ALTER TABLE MedicineMaster
DROP Constraint PK_MedicineMaster  
GO
ALTER TABLE MedicineMaster
ALTER COLUMN Mm_ID NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_MedicineMaster')
BEGIN
	ALTER TABLE MedicineMaster
	ADD CONSTRAINT PK_MedicineMaster PRIMARY KEY (Mm_ID) ;
END
GO

ALTER TABLE MedicineWiseTaxMaster
ALTER COLUMN Mtm_Id NUMERIC(18,0) NOT NULL
GO 
ALTER TABLE MedicineWiseTaxMaster
ALTER COLUMN Mtm_MmId  NUMERIC(18,0)
GO


ALTER TABLE PatientMaster
DROP Constraint PK_PatientMaster  
GO
ALTER TABLE PatientMaster
ALTER COLUMN Pm_Id NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_PatientMaster')
BEGIN
	ALTER TABLE PatientMaster
	ADD CONSTRAINT PK_PatientMaster PRIMARY KEY (Pm_Id) ;
END
GO
ALTER TABLE PatientMaster
ALTER COLUMN Pm_Ledger_Id NUMERIC(18,0)
GO
ALTER TABLE PatientMaster
ALTER COLUMN StoreId  NUMERIC(18,0)
GO

ALTER TABLE PoHeader
ALTER COLUMN Po_VenId  NUMERIC(18,0)
GO
ALTER TABLE PoHeader
ALTER COLUMN Po_VenAddId  NUMERIC(18,0)
GO
ALTER TABLE PurchaseInvoiceHeader
ALTER COLUMN Pih_VenId  NUMERIC(18,0)
GO
ALTER TABLE PurchaseInvoiceHeader
ALTER COLUMN Pih_VenAddId  NUMERIC(18,0)
GO
ALTER TABLE PurchaseReturnDetail
DROP Constraint PK_PurchaseReturnDetail  
GO
ALTER TABLE PurchaseReturnDetail
ALTER COLUMN Prd_Id  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_PurchaseReturnDetail')
BEGIN
	ALTER TABLE PurchaseReturnDetail
	ADD CONSTRAINT PK_PurchaseReturnDetail PRIMARY KEY (Prd_Id) ;
END
GO
ALTER TABLE PurchaseReturnDetail
ALTER COLUMN Prd_PrhId NUMERIC(18,0) 
GO
ALTER TABLE PurchaseReturnDetail
ALTER COLUMN Prd_PidKey NUMERIC(18,0) 
GO
ALTER TABLE PurchaseReturnDetail
ALTER COLUMN Prd_PihKey NUMERIC(18,0) 
GO
ALTER TABLE PurchaseReturnHeader
ALTER COLUMN Prh_Id NUMERIC(18,0) 
GO
ALTER TABLE PurchaseReturnHeader
ALTER COLUMN Prh_PihKey NUMERIC(18,0) 
GO
ALTER TABLE PurchaseReturnHeader
ALTER COLUMN Prh_VendorId NUMERIC(18,0) 
GO
ALTER TABLE SalesChallanHeader
ALTER COLUMN Sc_Key NUMERIC(18,0) 
GO
ALTER TABLE SalesChallanHeader
ALTER COLUMN Sc_Pm_Id NUMERIC(18,0) 
GO
ALTER TABLE SalesChallanHeader
ALTER COLUMN Sc_Po_Key NUMERIC(18,0) 
GO
ALTER TABLE SalesChallenItemDetails
ALTER COLUMN Scd_Key NUMERIC(18,0) 
GO
ALTER TABLE SalesChallenItemDetails
ALTER COLUMN Scd_Mm_Id NUMERIC(18,0) 
GO
ALTER TABLE SalesChallenItemDetails
ALTER COLUMN Scd_Sch_Key NUMERIC(18,0) 
GO
ALTER TABLE SalesChallenItemDetails
ALTER COLUMN Scd_Po_Key NUMERIC(18,0) 
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('SalesInvoiceHeader') AND name='IX_Sih_Key_Sih_No_Sih_Pm_Id_Sih_SubTotal_Sih_Total_Sih_DiscAmount_Sih_BranchId')
BEGIN
	DROP INDEX IX_Sih_Key_Sih_No_Sih_Pm_Id_Sih_SubTotal_Sih_Total_Sih_DiscAmount_Sih_BranchId   
    ON SalesInvoiceHeader; 
END
GO
ALTER TABLE SalesInvoiceHeader
ALTER COLUMN Sih_Key NUMERIC(18,0) 
GO
ALTER TABLE SalesInvoiceHeader
ALTER COLUMN Sih_Pm_Id NUMERIC(18,0) 
GO
ALTER TABLE SalesInvoiceHeader
ALTER COLUMN Sih_Dm_Id NUMERIC(18,0) 
GO
ALTER TABLE SalesInvoiceHeader
ALTER COLUMN Sih_Po_Key NUMERIC(18,0) 
GO


ALTER TABLE SalesInvoiceItemDetail
DROP Constraint PK_SalesInvoiceItemDetail  
GO
ALTER TABLE SalesInvoiceItemDetail
ALTER COLUMN Sid_Key  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_SalesInvoiceItemDetail')
BEGIN
	ALTER TABLE SalesInvoiceItemDetail
	ADD CONSTRAINT PK_SalesInvoiceItemDetail PRIMARY KEY (Sid_Key) ;
END
GO
ALTER TABLE SalesInvoiceItemDetail
ALTER COLUMN Sid_Sih_Key  NUMERIC(18,0) 
GO 
ALTER TABLE SalesInvoiceItemDetail
ALTER COLUMN Sid_Po_Key  NUMERIC(18,0) 
GO 
ALTER TABLE SalesInvoiceItemDetail
ALTER COLUMN Sid_Mm_Id  NUMERIC(18,0) 
GO 

ALTER TABLE SalesReturnDetail
DROP Constraint PK_SalesReturnDetail  
GO
ALTER TABLE SalesReturnDetail
ALTER COLUMN Srd_Id  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_SalesReturnDetail')
BEGIN
	ALTER TABLE SalesReturnDetail
	ADD CONSTRAINT PK_SalesReturnDetail PRIMARY KEY (Srd_Id) ;
END
GO
ALTER TABLE SalesReturnDetail
ALTER COLUMN Srd_SrhId  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnDetail
ALTER COLUMN Srd_SidKey  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnDetail
ALTER COLUMN Sid_SihKey  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnDetail
ALTER COLUMN Srd_MmId  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnHeader
ALTER COLUMN Srh_Id  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnHeader
ALTER COLUMN Srh_SihKey  NUMERIC(18,0) 
GO
ALTER TABLE SalesReturnHeader
ALTER COLUMN Srh_CustId  NUMERIC(18,0) 
GO
ALTER TABLE SO_HEADER
ALTER COLUMN Po_VenId  NUMERIC(18,0) 
GO
ALTER TABLE SO_HEADER
ALTER COLUMN Po_VenAddId  NUMERIC(18,0) 
GO
-----Pending In Server----
ALTER TABLE StockRegister
DROP Constraint PK_STOCK_REGISTER  
GO
ALTER TABLE StockRegister
ALTER COLUMN Stk_ID  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_STOCK_REGISTER')
BEGIN
	ALTER TABLE StockRegister
	ADD CONSTRAINT PK_STOCK_REGISTER PRIMARY KEY (Stk_ID) ;
END
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('StockRegister') AND name='IX_StockRegister_2')
BEGIN
	DROP INDEX IX_StockRegister_2   
    ON StockRegister; 
END
GO
ALTER TABLE StockRegister
ALTER COLUMN Stk_MmId  NUMERIC(18,0)
GO
ALTER TABLE StockRegister
ALTER COLUMN Stk_MmmId  NUMERIC(18,0)
GO
ALTER TABLE TaxTransaction
ALTER COLUMN Tr_DocId  NUMERIC(18,0)
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal')
BEGIN
	DROP INDEX IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal   
    ON TaxTransaction; 
END
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxTot')
BEGIN
	DROP INDEX IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxTot   
    ON TaxTransaction; 
END
GO
IF EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DdocKey_Tr_TxVal_Tr_TxTot')
BEGIN
	DROP INDEX IX_Tr_DocTyp_Tr_DdocKey_Tr_TxVal_Tr_TxTot   
    ON TaxTransaction; 
END
GO

ALTER TABLE TaxTransaction
ALTER COLUMN Tr_DocKey  NUMERIC(18,0)
GO
ALTER TABLE TaxTransaction
ALTER COLUMN Tr_DdocKey  NUMERIC(18,0)
GO
ALTER TABLE TaxTransaction
ALTER COLUMN Tr_MmId  NUMERIC(18,0)
GO
ALTER TABLE VendorAddMaster
DROP Constraint PK_VendorAddMaster  
GO
ALTER TABLE VendorAddMaster
ALTER COLUMN VendAdd_Id  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_VendorAddMaster')
BEGIN
	ALTER TABLE VendorAddMaster
	ADD CONSTRAINT PK_VendorAddMaster PRIMARY KEY (VendAdd_Id) ;
END
GO
ALTER TABLE VendorAddMaster
ALTER COLUMN VendAdd_VendorId  NUMERIC(18,0)
GO
ALTER TABLE VendorMaster
DROP Constraint PK_VendorMaster  
GO
ALTER TABLE VendorMaster
ALTER COLUMN Vendor_ID  NUMERIC(18,0) NOT NULL
GO 
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.CHECK_CONSTRAINTS WHERE CONSTRAINT_NAME='PK_VendorMaster')
BEGIN
	ALTER TABLE VendorMaster
	ADD CONSTRAINT PK_VendorMaster PRIMARY KEY (Vendor_ID) ;
END
GO
ALTER TABLE VendorMaster
ALTER COLUMN Vendor_Ledger_id  NUMERIC(18,0)
GO


 


IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('AccountTransaction') AND name='SP_SalesInvoice_SalesDetailForReportWithFilter_AccountTransaction')
BEGIN
	CREATE NONCLUSTERED INDEX [SP_SalesInvoice_SalesDetailForReportWithFilter_AccountTransaction] ON [dbo].[AccountTransaction]
	(
		[Act_DocType] ASC,
		[Act_DocKey] ASC
	)
END
GO


IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('StockRegister') AND name='IX_StockRegister_2')
BEGIN
    CREATE NONCLUSTERED INDEX IX_StockRegister_2
    ON	StockRegister (Stk_MmId)
    INCLUDE	(Stk_BatchNo,Stk_MnfDate,Stk_ExpDate,Stk_SalesQty,Stk_SalesUom,Stk_LmId,Stk_Mrp,Stk_Tran_Typ,Stk_PurchaseQty,Stk_PurchaseUom,Stk_PurchaseRate);
END
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('SalesInvoiceHeader') AND name='IX_Sih_Key_Sih_No_Sih_Pm_Id_Sih_SubTotal_Sih_Total_Sih_DiscAmount_Sih_BranchId')
BEGIN
    CREATE NONCLUSTERED INDEX IX_Sih_Key_Sih_No_Sih_Pm_Id_Sih_SubTotal_Sih_Total_Sih_DiscAmount_Sih_BranchId
    ON	SalesInvoiceHeader (Sih_Date)
    INCLUDE	([Sih_Key],
	[Sih_No],
	[Sih_Pm_Id],
	[Sih_SubTotal],
	[Sih_Total],
	[Sih_DiscAmount],
	[Sih_BranchId]);
END
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxTot')
BEGIN
    CREATE NONCLUSTERED INDEX IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxTot
    ON	TaxTransaction (Tr_TxId)
    INCLUDE	([Tr_DocTyp],
	[Tr_DocKey],
	[Tr_DdocKey],
	[Tr_TxTot]);
END
GO


IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal')
BEGIN
    CREATE NONCLUSTERED INDEX IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal
    ON	TaxTransaction (Tr_TxId)
    INCLUDE	([Tr_DocTyp],
	[Tr_DocKey],
	[Tr_DdocKey],
	[Tr_TxVal]);
END
GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('TaxTransaction') AND name='IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal')
BEGIN
    CREATE NONCLUSTERED INDEX IX_Tr_DocTyp_Tr_DocKey_Tr_DdocKey_Tr_TxVal
    ON	TaxTransaction (Tr_TxId)
    INCLUDE	([Tr_DocTyp],
	[Tr_DocKey],
	[Tr_DdocKey],
	[Tr_TxVal]);
END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Scd_Sid_SalesQty' And object_id=OBJECT_ID('SalesChallenItemDetails'))
		BEGiN
			ALTER TABLE SalesChallenItemDetails ADD [Scd_Sid_SalesQty] NUMERIC(12,0) NULL;
		END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pid_MnfName' And object_id=OBJECT_ID('PurchaseInvoiceDetail'))
		BEGiN
			ALTER TABLE PurchaseInvoiceDetail ADD [Pid_MnfName] VARCHAR(5000) NULL;
		END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Sid_MnfName' And object_id=OBJECT_ID('cPOS_SalesInvoiceItemDetail'))
		BEGiN
			ALTER TABLE cPOS_SalesInvoiceItemDetail ADD [Sid_MnfName] VARCHAR(5000) NULL;
		END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Prh_Vendor_Add_id' And object_id=OBJECT_ID('PurchaseReturnHeader'))
		BEGiN
			ALTER TABLE PurchaseReturnHeader ADD [Prh_Vendor_Add_id] INT NULL;
		END
GO


iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Prh_Based_On' And object_id=OBJECT_ID('PurchaseReturnHeader'))
		BEGiN
			ALTER TABLE PurchaseReturnHeader ADD [Prh_Based_On] INT NULL;
		END
GO

iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Pm_IsSync' And object_id=OBJECT_ID('PatientMaster'))
		BEGiN
			ALTER TABLE PatientMaster ADD [Pm_IsSync] BIT NULL;
		END
GO




iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Mm_Primary_Size' And object_id=OBJECT_ID('MedicineMaster'))
		BEGiN
			ALTER TABLE MedicineMaster ADD [Mm_Primary_Size] VARCHAR(50) NULL;
		END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Mm_Second_Size' And object_id=OBJECT_ID('MedicineMaster'))
		BEGiN
			ALTER TABLE MedicineMaster ADD [Mm_Second_Size] VARCHAR(100) NULL;
		END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Mm_Tertairy_Size' And object_id=OBJECT_ID('MedicineMaster'))
		BEGiN
			ALTER TABLE MedicineMaster ADD [Mm_Tertairy_Size] VARCHAR(100) NULL;
		END
GO
iF NOT EXiSTS(SELECT * FROM sys.columns WHERE name='Mm_Schedule' And object_id=OBJECT_ID('MedicineMaster'))
		BEGiN
			ALTER TABLE MedicineMaster ADD [Mm_Schedule] VARCHAR(50) NULL;
		END
GO

iF NOT EXiSTS(select * from Sys.tables where name='MedicineBatchManufacture')
		BEGiN
			CREATE TABLE [dbo].[MedicineBatchManufacture](
				[MBM_ID] [bigint] NULL,
				[MBM_MM_ID] [bigint] NULL,
				[MBM_MM_CODE] [varchar](15) NULL,
				[MBM_BATCH_NO] [varchar](250) NULL,
				[MBM_MANU_NAME] [varchar](5000) NULL,
				[MBM_CRETED_DATE] [datetime] NULL,
				[MBM_CREATED_BY] [int] NULL,
				[MBM_UPDATED_DATE] [datetime] NULL,
				[MBM_UPDATED_BY] [int] NULL
			) ON [PRIMARY]
		END
GO

DELETE FROM YearMaster
iNSERT iNTO YearMaster
SELECT (SELECT ISNULL(MAX(Year_Id),0)+1 FROM YearMaster),'2017-04-01','2018-03-31',0
iNSERT iNTO YearMaster
SELECT (SELECT ISNULL(MAX(Year_Id),0)+1 FROM YearMaster),'2018-04-01','2019-04-01',1
GO
UPDATE		ConfigurationMaster 
SET			CurrentVersion='1.0.0.16',
					CurrentDbId=17,
					CurrentExeId=17
GO

iF NOT EXiSTS(SELECT * FROM sys.tables WHERE name='YEAR_END_LAST_DOCUMNT_KEY')
	BEGiN
		CREATE TABLE YEAR_END_LAST_DOCUMNT_KEY(DOC_TYPE VARCHAR(250),DOC_KEY BIGINT)
	END
GO


 -- drop all user defined stored procedures
Declare @procName varchar(500) 
Declare @oType varchar(500) 
Declare cur Cursor For Select [name],type From sys.objects where type IN('p','TF','FN','V')
Open cur 
Fetch Next From cur Into @procName ,@oType
While @@fetch_status = 0 
Begin 
	iF @oType='P'
		BEGiN
			Exec('drop procedure ' + @procName) 
		END
	ELSE iF @oType='TF'
		BEGiN
			Exec('drop FUNCTION ' + @procName) 
		END
	ELSE iF @oType='FN'
		BEGiN
			Exec('drop FUNCTION ' + @procName) 
		END
	ELSE iF @oType='V'
		BEGiN
			Exec('drop VIEW ' + @procName) 
		END
 Fetch Next From cur Into @procName,@oType 
End
Close cur 
Deallocate cur



GO
/****** Object:  StoredProcedure [dbo].[SP_AccountTransactionRef]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_AccountTransactionRef] @SP_STATUS nvarchar(100),
@Acr_Id int = 0,
@Acr_ActKey NUMERIC(18,0) = 0,
@Acr_BookId int = 0,
@Acr_DocKey NUMERIC(18,0) = 0,
@Acr_SrNo int = 0,
@Acr_PayAmount decimal(18,2) = 0,
@Acr_AdjAmount decimal(18,2) = 0
AS
BEGIN
	IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Acr_Id = ISNULL(MAX(Acr_Id),0) + 1
			FROM		AccountTransactionRef

			INSERT INTO		[dbo].[AccountTransactionRef]([Acr_Id],
							[Acr_ActKey],
							[Acr_BookId],
							[Acr_DocKey],
							[Acr_SrNo],
							[Acr_PayAmount],
							[Acr_AdjAmount]) 
			VALUES			(@Acr_Id
							,@Acr_ActKey
							,@Acr_BookId
							,@Acr_DocKey
							,@Acr_SrNo
							,@Acr_PayAmount
							,@Acr_AdjAmount)
		END

	ELSE IF @SP_STATUS = 'GetPaymentDetail'
	BEGIN
		SELECT		*
		FROM		AccountTransactionRef(NOLOCK)
		WHERE		Acr_ActKey = @Acr_ActKey
	END

END
GO
/****** Object:  StoredProcedure [dbo].[SP_AttachmentTransaction]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_AttachmentTransaction] @SP_STATUS nvarchar(200) = '',
		@At_Key [Bigint] = 0,
		@At_DocNo NUMERIC(18,0) = 0,
		@At_DocRevNo [Bigint] = 0,
		@At_DocKey NUMERIC(18,0) = 0,
		@At_SrNo [Bigint] = 0,
		@At_FileName [varchar](250) = '',
		@At_FilePath [varchar](250) = '',
		@At_Remarks [varchar](500) = '',
		@At_BData [varbinary](MAX) = NULL,
		@At_CmpId [Bigint] = 0,
		@At_UnitId [Bigint] = 0,
		@At_YearID [numeric](4,0) = 0,
		@At_DocType int = 0
AS
BEGIN
	IF @SP_STATUS = 'INSERT_ATTACHMENT_TRANSACTION'
		BEGIN
			SELECT		@At_Key = ISNULL(MAX(At_Key),0) + 1
			FROM		AttachmentTransaction(NOLOCK)

			INSERT INTO		[dbo].[AttachmentTransaction]([At_Key],[At_DocNo],[At_DocRevNo],[At_DocKey],[At_SrNo],
							[At_FileName],[At_FilePath],
							[At_Remarks],[At_BData],[At_CmpId],[At_UnitId],[At_YearID],[At_DocType]) 
			VALUES			(@At_Key,@At_DocNo,@At_DocRevNo,@At_DocKey,@At_SrNo,@At_FileName,@At_FilePath,@At_Remarks,
							@At_BData,@At_CmpId,@At_UnitId,@At_YearID,@At_DocType)
		END

	ELSE IF @SP_STATUS = 'UDPATE_ATTACHMENT_TRANSACTION'
		BEGIN
			UPDATE		[dbo].[AttachmentTransaction]
			SET			[At_DocNo] = @At_DocNo,
						[At_DocRevNo] = @At_DocRevNo,
						[At_DocKey] = @At_DocKey,
						[At_SrNo] = @At_SrNo,
						[At_FileName] = @At_FileName,
						[At_FilePath] = @At_FilePath,
						[At_Remarks] = @At_Remarks,
						[At_BData] = @At_BData,
						[At_CmpId] = @At_CmpId,
						[At_UnitId] = @At_UnitId,
						[At_YearID] = @At_YearID,
						[At_DocType] = @At_DocType
			WHERE		[At_Key] = @At_Key
		END

	ELSE IF @SP_STATUS = 'DELETE_ATTACHMENT_TRANSACTION'
	BEGIN
		DELETE 
		FROM		[dbo].[AttachmentTransaction]
		WHERE		[At_DocType] = @At_DocType
					AND [At_DocKey] = @At_DocKey
	END

	ELSE IF @SP_STATUS = 'RETRIVE_ATTACHMENT_TRANSACTION'
	BEGIN
		SELECT		[At_Key],[At_DocRevNo],[At_SrNo],[At_FileName],[At_FilePath],
					REVERSE(LEFT(REVERSE(At_FileName),CHARINDEX('.',REVERSE(At_FileName)) - 1)) AS TA_FILE_TYPE,
					[At_Remarks],[At_BData],[At_CmpId],[At_UnitId],[At_YearID],[At_DocType]
		FROM		[AttachmentTransaction](NOLOCK)
		WHERE		[At_DocType] = @At_DocType
					AND [At_DocKey] = @At_DocKey
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_AuditMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_AuditMaster] @SP_STATUS varchar(200),
		@Am_Id int = 0,
		@Am_MmId NUMERIC(18,0) = 0,
		@Am_MmBatchNo varchar(50) = NULL,
		@Am_LmId int = 0,
		@Am_Qty decimal = 0,
		@Am_Remarks varchar(max) = NULL,
		@User int = 0,
		@Am_CreatedDt datetime = NULL,
		@Am_Date datetime = NULL,
		@Am_AdjustQty decimal(18,3) = 0,
		@Am_Status varchar(50) = NULL,
		@Am_CrDr varchar(10) = NULL
AS
BEGIN
	IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Am_Id = ISNULL(MAX(Am_Id),0) + 1
			FROM		AuditMaster(nolock);

			INSERT INTO		[dbo].[AuditMaster]
							(Am_Id,Am_MmId,Am_MmBatchNo,Am_LmId,Am_Qty,
							Am_Remarks,Am_CreatedBy,Am_CreatedDt,Am_Date,Am_AdjustQty,Am_Status,Am_CrDr) 
			VALUES			(@Am_Id,@Am_MmId,@Am_MmBatchNo,@Am_LmId,@Am_Qty,@Am_Remarks,@User,GETDATE(),
							@Am_Date,@Am_AdjustQty,@Am_Status,@Am_CrDr);
		END;

	ELSE IF @SP_STATUS = 'Update'
		BEGIN

			UPDATE		[dbo].[AuditMaster]
			SET			[Am_MmId] = @Am_MmId,
						[Am_MmBatchNo] = @Am_MmBatchNo,
						[Am_LmId] = @Am_LmId,
						[Am_Qty] = @Am_Qty,
						[Am_Remarks] = @Am_Remarks,
						[Am_CreatedBy] = @User,
						[Am_CreatedDt] = @Am_CreatedDt,
						[Am_Date] = @Am_Date,
						[Am_AdjustQty] = @Am_AdjustQty,
						[Am_Status] = @Am_Status,
						[Am_CrDr] = @Am_CrDr
			WHERE		[Am_Id] = @Am_Id
		END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DELETE FROM AuditMaster
			WHERE Am_Id = @Am_Id;
		END;
	
	ELSE IF @SP_STATUS = 'GetAuditDetail'
		BEGIN
			SELECT		Am_Id,Am_MmId,Am_MmBatchNo,Am_LmId,Am_Qty,Am_Remarks,Am_CreatedDt,C.User_Name AS [User],
						lm.Lm_Name AS Am_Location,mm.Mm_Code AS Am_MmCode,mm.Mm_Name AS Am_MmName
			FROM		AuditMaster AS am (NOLOCK)
					LEFT JOIN dbo.UserMaster C
			ON			am.Am_CreatedBy = C.User_ID
					LEFT JOIN LocationMaster lm
			ON			am.Am_LmId = lm.Lm_Id
					LEFT JOIN MedicineMaster mm
			ON			am.Am_MmId = mm.Mm_ID
		END;

	ELSE IF @SP_STATUS = 'Retrive'
		BEGIN
			SELECT		Am_Id,Am_MmId,Am_MmBatchNo,Am_LmId,Am_Qty,Am_Remarks,lm.Lm_Name AS Am_Location,mm.Mm_Code AS Am_MmCode,
						mm.Mm_Name AS Am_MmName,vwStock.Item_Stock AS Am_Stock,Am_CrDr
			FROM		AuditMaster AS am (NOLOCK)
					LEFT JOIN vwStock
			ON			am.Am_MmId = Item_Id
					AND am.Am_LmId = Stk_LmId
					AND am.Am_MmBatchNo = Item_Batchno
					LEFT JOIN dbo.UserMaster C
			ON			am.Am_CreatedBy = C.User_ID
					LEFT JOIN LocationMaster lm
			ON			am.Am_LmId = lm.Lm_Id
					LEFT JOIN MedicineMaster mm
			ON			am.Am_MmId = mm.Mm_ID
			WHERE		Am_Id = @Am_Id
		END;
	ELSE IF @SP_STATUS = 'GetAuditList'
		BEGIN
			SELECT		Am_Date,usr.User_Name AS Am_CreatedBy,
						CASE WHEN SUM(ISNULL(Am_Qty,0)) = SUM(ISNULL(Am_AdjustQty,0)) THEN 'Completed' WHEN SUM(ISNULL(Am_AdjustQty,0)) = 0 THEN 'Pending' WHEN SUM(Am_Qty) > SUM(ISNULL(Am_AdjustQty,0)) THEN 'Partial' END AS Am_Status
			FROM		AuditMaster(NOLOCK) am
					LEFT JOIN UserMaster usr
			ON			am.Am_CreatedBy = usr.User_ID 
			GROUP BY Am_Date,usr.User_Name
		END

	ELSE IF @SP_STATUS = 'GetAuditDetail'
		BEGIN
			SELECT	*
			FROM		AuditMaster(NOLOCK)
			WHERE		Am_Date = @Am_Date
		END

	IF @SP_STATUS = 'UpdateStatusAndQty'
		BEGIN
			UPDATE		AuditMaster
			SET			Am_AdjustQty = ISNULL(@Am_AdjustQty,0),
						Am_Status = 'Partial'
			WHERE		Am_Id = @Am_Id

			UPDATE		AuditMaster
			SET			Am_Status = 'Completed'
			WHERE		Am_Id = @Am_Id
					AND ISNULL(Am_AdjustQty,0) = ISNULL(Am_Qty,0)
		END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_AUTO_UPDATE]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_AUTO_UPDATE]
 @SP_STATUS		VARCHAR(199)
,@id			int
,@Filepath		nvarchar(2000)
,@FileType		nvarchar(100)

,@Filename		nvarchar(500)
,@ExeId			bigint
,@DbId			bigint
,@Version		nvarchar(200)

,@SyncDate		datetime
,@IsActive		bit
	
AS
BEGiN
	iF @SP_STATUS='GET_CONFIG'
		BEGiN
			Select	CposApi,CposApiKey,
					(Select TOP(1) Store_Code from StoreMaster) as Store_Code,
					POSStartUpPath,
					CurrentExeId,
					CurrentDbId,
					ISNULL(CheckForUpdate,0) as CheckForUpdate,
					CurrentVersion
			FROM ConfigurationMaster (NOLOCK)	
		END

	ELSE IF @SP_STATUS ='CURRENT_VERSION'
		BEGIN
			Select CurrentVersion,CurrentExeId,CurrentDbId FROM ConfigurationMaster
		END	

	ELSE IF @SP_STATUS ='UPDATE_VERSION'
		BEGIN
			update tblPOSVersion Set IsActive=0;	
			SELECT @id = ISNULL(MAX(id), 0) + 1 FROM tblPOSVersion (NOLOCK) 
			INSERT INTO tblPOSVersion
			(
				id,	
				Filepath,	
				FileType,
				[Filename],
				ExeId,
				[DbId],
				[Version],	
				SyncDate,	
				IsActive
			)
			VALUES
			(
				@id,
				@Filepath,
				@FileType,
				@Filename,
				@ExeId,
				Null,
				@Version,
				GETDATE(),
				1
			)
		END	

	ELSE IF @SP_STATUS ='UPDATE_VERSION_1'
		BEGIN
			update tblPOSVersion Set [DbId]=@DbId where IsActive=1;	
		END	
END
GO
/****** Object:  StoredProcedure [dbo].[SP_BATCH_MANUFACTURE]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_BATCH_MANUFACTURE]
 @SP_STATUS			VARCHAR(199)=''
,@MBM_ID			bigint
,@MBM_MM_ID			bigint
,@MBM_MM_CODE		varchar(15)

,@MBM_BATCH_NO		varchar(250)
,@MBM_MANU_NAME		varchar(5000)
,@MBM_USER			INT
	
AS
BEGiN
	iF @SP_STATUS='GET_BATCH_LIST'
		BEGiN
			SELECT	DISTINCT
					A.Stk_MmId AS MBM_MM_ID,
					B.Mm_Code AS MBM_MM_CODE,
					B.Mm_Name AS Mm_Name,
					A.Stk_BatchNo AS MBM_BATCH_NO,
					ISNULL(C.MBM_MANU_NAME,'') AS MBM_MANU_NAME
			FROM	StockRegister A
					iNNER JOIN MedicineMaster B
			ON			A.Stk_MmId=B.Mm_ID
					LEFT JOIN MedicineBatchManufacture C
			ON			B.Mm_ID=C.MBM_MM_ID
					AND A.Stk_BatchNo=C.MBM_BATCH_NO
					AND B.Mm_Code=C.MBM_MM_CODE
		END

	ELSE iF @SP_STATUS='ADD_MANU_NAME_TO_BATCH'
		BEGiN
			iF EXiSTS(SELECT * FROM MedicineBatchManufacture A WHERE A.MBM_MM_ID=@MBM_MM_ID AND A.MBM_BATCH_NO=@MBM_BATCH_NO)
				BEGiN
					UPDATE	MedicineBatchManufacture 
					SET		MBM_MANU_NAME=@MBM_MANU_NAME,
							MBM_UPDATED_BY=@MBM_USER,
							MBM_CRETED_DATE=GETDATE()
					WHERE		MBM_MM_ID=@MBM_MM_ID 
							AND MBM_BATCH_NO=@MBM_BATCH_NO
				END
			ELSE
				BEGiN
					SELECT	@MBM_ID=ISNULL(MAX(MBM_ID),0)+1
					FROM	MedicineBatchManufacture
					iNSERT iNTO MedicineBatchManufacture(MBM_ID,MBM_MM_ID,MBM_MM_CODE,MBM_BATCH_NO,MBM_MANU_NAME,MBM_CRETED_DATE,MBM_CREATED_BY)
					VALUES(@MBM_ID,@MBM_MM_ID,@MBM_MM_CODE,@MBM_BATCH_NO,@MBM_MANU_NAME,GETDATE(),@MBM_USER)
				END
		END
	ELSE iF @SP_STATUS='GET_MANU_NAME_LIST'
		BEGiN
			SELECT	DISTINCT
					ISNULL(MBM_MANU_NAME,'') AS MBM_MANU_NAME
			FROM	MedicineBatchManufacture
		END
END


--maxalbumapp@gmail.com
--max@123
GO
/****** Object:  StoredProcedure [dbo].[SP_Branch_Master]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:    <Author,,Name>
-- Create date: <Create Date,,>
-- Description:  <Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_Branch_Master] @SP_STATUS nvarchar(100),
	@USER			  int = 0,
	@Branch_Id		  [bigint] = 0,
	@Branch_Name	  [nvarchar](50) = 0,
	@Branch_Address1  [nvarchar](199) = '',
	@Branch_Address2  [nvarchar](199) = '',
	@Branch_Address3  [nvarchar](199) = '',
	@Branch_CountryId [BIGINT] = 0,
	@Branch_StateId	 [BIGINT] = 0,
	@Branch_CityId	 [bigint] = 0,
	@Branch_AreaId	 [bigint] = 0,
	@Branch_PhNo	 [nvarchar](50) = 0,
	@Branch_PhNo1	 [nvarchar](50) = 0,
	@Branch_MobNo	 [nvarchar](50) = 0,
	@Branch_FaxNo	 [nvarchar](50) = 0,
	@Branch_Email	 [nvarchar](199) = 0,
	@Branch_Web		 [nvarchar](199) = 0,
	@Branch_CstNo	 [nvarchar](50) = 0,
	@Branch_CstDt	 [datetime] = 0,
	@Branch_GstNo	 [nvarchar](50) = 0,
	@Branch_GstDt	 [datetime] = 0,
	@Branch_RegNo	 [nvarchar](50) = 0,
	@Branch_RegDt	 [datetime] = 0,
	@Branch_UsActive [bit] = 0,
	@Branch_Logo	 image
AS
BEGIN
	IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT @Branch_Id = ISNULL(MAX(Branch_Id),0) + 1
			FROM BranchMaster(NOLOCK)
			INSERT INTo		BranchMaster
							(Branch_Id,Branch_Name,Branch_Address1,Branch_Address2,Branch_Address3,
							Branch_CountryId,Branch_StateId,Branch_CityId,Branch_AreaId,Branch_PhNo,
							Branch_PhNo1,Branch_MobNo,Branch_FaxNo,Branch_Email,Branch_Web,
							Branch_CstNo,Branch_CstDt,Branch_GstNo,Branch_GstDt,Branch_RegNo,
							Branch_RegDt,Branch_CreatedBy,Branch_CreatedDt,Branch_UsActive,Branch_Logo) 
			VALUES			(@Branch_Id,@Branch_Name,@Branch_Address1,@Branch_Address2,@Branch_Address3,@Branch_CountryId,
							@Branch_StateId,@Branch_CityId,@Branch_AreaId,@Branch_PhNo,
							@Branch_PhNo1,@Branch_MobNo,@Branch_FaxNo,@Branch_Email,@Branch_Web,@Branch_CstNo,
							@Branch_CstDt,@Branch_GstNo,@Branch_GstDt,@Branch_RegNo,@Branch_RegDt,@USER,GETDATE(),
							@Branch_UsActive,@Branch_Logo)
		END

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		BranchMaster
			SET			Branch_Name = @Branch_Name,
						Branch_Address1 = @Branch_Address1,
						Branch_Address2 = @Branch_Address2,
						Branch_Address3 = @Branch_Address3,
						Branch_CountryId = @Branch_CountryId,
						Branch_StateId = @Branch_StateId,
						Branch_CityId = @Branch_CityId,
						Branch_AreaId = @Branch_AreaId,
						Branch_PhNo = @Branch_PhNo,
						Branch_PhNo1 = @Branch_PhNo1,
						Branch_MobNo = @Branch_MobNo,
						Branch_FaxNo = @Branch_Email,
						Branch_Email = @Branch_Email,
						Branch_Web = @Branch_Web,
						Branch_CstNo = @Branch_CstNo,
						Branch_CstDt = @Branch_CstDt,
						Branch_GstNo = @Branch_GstNo,
						Branch_GstDt = @Branch_GstDt,
						Branch_RegNo = @Branch_RegNo,
						Branch_RegDt = @Branch_RegDt,
						Branch_UpdatedBy = @USER,
						Branch_UpdatedDt = GETDATE(),
						Branch_UsActive = @Branch_UsActive,
						Branch_Logo = @Branch_Logo
			WHERE		Branch_Id = @Branch_Id
		END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'COUNTRY_MASTER',@Branch_Id,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE BEGIN
					DELETE FROM BranchMaster
					WHERE Branch_Id = @Branch_Id
				END
		END

	ELSE IF @SP_STATUS = 'FILL_GRID_BRANCH'
		BEGIN
			SELECT		BM.Branch_Id,BM.Branch_Name,BM.Branch_Address1,BM.Branch_Address2,BM.Branch_Address3,
						BM.Branch_CityId,BM.Branch_AreaId,BM.Branch_PhNo,BM.Branch_PhNo1,BM.Branch_MobNo,BM.Branch_FaxNo,
						BM.Branch_Email,BM.Branch_Web,BM.Branch_CstNo,BM.Branch_CstDt,BM.Branch_GstNo,BM.Branch_GstDt,
						BM.Branch_RegNo,BM.Branch_RegDt,BM.Branch_CreatedBy,BM.Branch_CreatedDt,
						CASE WHEN BM.Branch_UsActive = 1 THEN 'Yes' ELSE 'No' END AS Branch_UsActive,BM.Branch_Logo,CM.Country_Name,
						CM.Country_Id,CTM.City_Name,SM.State_Name,SM.State_ID,AM.Area_Name,UM.User_Name
			FROM		BranchMaster(NOLOCK) BM
					LEFT JOIN CountryMaster(NOLOCK) CM
			ON			BM.Branch_CountryId = CM.Country_Id
					LEFT JOIN CityMaster(NOLOCK) CTM
			ON			BM.Branch_CityId = CTM.City_ID
					LEFT JOIN StateMaster(NOLOCK) SM
			ON			BM.Branch_StateId = SM.State_ID
					LEFT JOIN AreaMaster(NOLOCK) AM
			ON			BM.Branch_AreaId = AM.Area_ID
					LEFT JOIN UserMaster(NOLOCK) UM
			ON			BM.Branch_CreatedBy = UM.User_ID
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_COUNTRY'
		BEGIN
			SELECT		0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		Country_Id AS ID,Country_Name AS NAME
			FROM		CountryMaster(NOLOCK)
			WHERE		Country_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_STATE'
		BEGIN
			SELECT		0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		State_ID AS ID,State_Name AS NAME
			FROM		StateMaster(NOLOCK)
			WHERE		State_CountryId = @Branch_CountryId
			AND			State_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_CITY'
		BEGIN
			SELECT		0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		City_ID AS ID,City_Name AS NAME
			FROM		CityMaster(NOLOCK)
			WHERE		City_StateId = @Branch_StateId
					AND	City_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_AREA'
		BEGIN
			SELECT		0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		Area_ID AS ID,Area_Name AS NAME
			FROM		AreaMaster(NOLOCK)
			WHERE		Area_ContryId = @Branch_CountryId
			AND			Area_StateId = @Branch_StateId
			AND			Area_CityId = @Branch_CityId
			AND			Area_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'COUNT_BRANCH_MASTER'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		BranchMaster(NOLOCK)
			WHERE		Branch_Name = @Branch_Name
					AND Branch_Id <> @Branch_Id
		END

	ELSE IF @SP_STATUS = 'VALIDATE_MOBILE'
		BEGIN
			SELECT		COUNT(*) AS ASCountOf
			FROM		BranchMaster(NOLOCK)
			WHERE		Branch_MobNo = @Branch_MobNo
					AND Branch_Id <> @Branch_Id
		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_BrandMater]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_BrandMater] @SP_STATUS varchar(200),
@BM_ID int = 0,
@BM_Code varchar(30) = NULL,
@BM_Name varchar(250) = NULL,
@BM_IsActive bit = 0,
@BM_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			SELECT		COUNT(*) CountOf
			FROM		BrandMater(nolock)
			WHERE		(BM_Code = @BM_Code
					OR	BM_Name = @BM_Name)
					AND	BM_ID <> @BM_ID;
		END;
	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@BM_ID = ISNULL(MAX(BM_ID),0) + 1
			FROM		BrandMater(nolock);

			INSERT INTO			[dbo].[BrandMater](BM_ID,
								BM_Code,
								BM_Name,
								BM_CreatedBy,
								BM_CreatedDate,
								BM_IsActive) 
			VALUES				(@BM_ID,@BM_Code,@BM_Name,@BM_User,
								GETDATE(),@BM_IsActive);
		END;
	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		[dbo].[BrandMater]
			SET			[BM_Name] = @BM_Name,
						[BM_Code] = @BM_Code,
						[BM_UpdatedBy] = @BM_User,
						[BM_UpdatedDate] = GETDATE(),
						[BM_IsActive] = @BM_IsActive
			WHERE		BM_ID = @BM_ID;
		END;
	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'BrandMater',@BM_ID,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE BEGIN
					DELETE FROM BrandMater
					WHERE BM_ID = @BM_ID;
				END
		END
	ELSE IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT		BM.*,C.User_Name AS BM_User
			FROm		BrandMater AS BM (NOLOCK)
					LEFT JOIN dbo.UserMaster C
			ON			BM.BM_CreatedBy = C.User_ID;
		END;
	ELSE IF @SP_STATUS = 'FillCombo'
		BEGIN
			SELECT		BM_ID,BM_Code
			FROM		BrandMater(nolock)
			WHERE		BM_IsActive = 1;
		END;
	ELSE IF @SP_STATUS = 'FillGridHelp'
		BEGIN
			SELECT		CONVERT(bit,0) AS chk,BM_ID,BM_Name,BM_Code
			FROM		BrandMater(NOLOCK)
			WHERE		BM_IsActive = 1;
		END;
	ELSE IF @SP_STATUS = 'GetCheckData'
		BEGIN
			SELECT		0 AS MBM_ID,BM_ID AS MBM_BmId,BM_Name AS MBM_BmName,BM_Code AS MBM_BmCode
			FROM		BrandMater(NOLOCK)
			WHERE		BM_IsActive = 1;
		END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_Common]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		VishalR
-- Create date: <Create Date,,>
-- Description:	For General Purchase
-- =============================================
CREATE PROCEDURE [dbo].[SP_Common]
@Sp_Status varchar(500)='',

@str1 varchar(500)='',
@str2 varchar(500)='',

@int1 varchar(500)=0
AS
BEGIN
	if @Sp_Status='Get_Mfg_Exp'
	BEGIN
		Select Stk_MnfDate,Stk_ExpDate,Stk_Mrp,Stk_SalesRate
		from StockRegister
		Where Stk_BatchNo=@str1  and Stk_MmId=@int1
	END
	ELSE iF @Sp_Status='GET_POS_TYPE'
		BEGiN
			SELECT	ISNULL(IsForDpos,0) AS IsForDpos
			FROM	ConfigurationMaster
		END
    ELSE iF @Sp_Status='GET_Help'
		BEGiN
			SELECT H.HM_Title,
			       H.HM_Url
			  FROM Help H
		END
		else if @Sp_Status ='GET_Stock_Qty'
         begin
		  select * from vwStockBatchWise 
		  where 
		    Stk_MmId = @int1  and Stk_BatchNo = @str1  

		 end 
END

GO
/****** Object:  StoredProcedure [dbo].[sp_ConfigurationMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[sp_ConfigurationMaster] @SP_STATUS nvarchar(50) = '',
@id [int] = 0,
@StockWithExpDate [bit] = 0,
@DefaultNoGap [nvarchar](10) = 0,
@DefualtPath [varchar](MAX) = '',
@CposApi [nvarchar](500) = '',
@CposApiKey [nvarchar](1000) = '',
@SrExpDays [int] = 0,
@PrExpDays [int] = 0,
@QtyRoungOf [int] = 0,
@AmountRoundOf [int] = 0,
@NearByExpiryDays int = 0
AS
BEGIN
	IF (@SP_STATUS = 'Update')
		BEGIN
			UPDATE		ConfigurationMaster
			SET			StockWithExpDate = @StockWithExpDate,DefaultNoGap = @DefaultNoGap,DefualtPath = @DefualtPath,CposApi = @CposApi,CposApiKey = @CposApiKey,
						SrExpDays = @SrExpDays,PrExpDays = @PrExpDays,QtyRoungOf = @QtyRoungOf,AmountRoundOf = @AmountRoundOf,NearByExpiryDays = @NearByExpiryDays
			WHERE		id = @id
		END

	ELSE IF (@SP_STATUS = 'FillControl')
	BEGIN
			SELECT		id,StockWithExpDate,DefaultNoGap,DefualtPath,CposApi,CposApiKey,SrExpDays,
						PrExpDays,QtyRoungOf,AmountRoundOf,NearByExpiryDays
			FROM		ConfigurationMaster(NOLOCK)

	END

	ELSE IF (@SP_STATUS = 'FillGlobal')
	BEGIN
	SELECT		id,
				StockWithExpDate,
				DefaultNoGap,
				DefualtPath,
				CposApi,
				CposApiKey,
				SrExpDays,
				PrExpDays,
				QtyRoungOf,
				AmountRoundOf,
				NearByExpiryDays
	FROm		ConfigurationMaster(NOLOCK)

	SELECT *
	FROM		StoreMaster(NOLOCK)
	WHERE		Store_UsActive = 1

	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_CountryStateCityArea]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_CountryStateCityArea] @SP_STATUS varchar(200),
@Country_Id int,
@State_Id int,
@City_Id int,
@Area_Id bigint,
@Area_Pincode int,
@Code varchar(30),
@Name varchar(200),
@User int,
@Is_Active bit
AS
BEGIN
	--=============================COMMON=======================================
	IF @SP_STATUS = 'FillComboCountry'
		BEGIN
			SELECT		0 AS ID,
						'--Select--'	AS NAME
			UNION
			SELECT		Country_Id		AS ID,
						Country_Name	AS NAME
			FROM		CountryMaster(nolock)
			WHERE		ISNULL(Country_IsActive,0) = 1;
		END;

	ELSE IF @SP_STATUS = 'FillComboState'
		BEGIN
			SELECT		0 AS ID,
						'--Select--'	AS NAME
			UNION
			SELECT		State_ID		AS ID,
						State_Name	AS NAME
			FROM		StateMaster(nolock)
			WHERE		State_CountryId = @Country_Id;
		END;
	ELSE IF @SP_STATUS = 'FillComboState1'
		BEGIN
			SELECT		0 AS ID,
						'--Select--'	AS NAME
			UNION
			SELECT		State_ID		AS ID,
						State_Name	AS NAME
			FROM		StateMaster(nolock)
			WHERE		State_CountryId = @Country_Id;
		END;
	ELSE IF @SP_STATUS = 'FillComboCity'
		BEGIN
			SELECT		0	AS ID,
						'--Select--'	AS NAME
			UNION
			SELECT		City_ID		AS ID,
						City_Name	AS NAME
			FROM		CityMaster(nolock)
			WHERE		City_StateId = @State_Id;
		END;
	--=============================COUNTRY=======================================
	IF @SP_STATUS = 'COUNT_COUNTRY'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		CountryMaster(nolock)
			WHERE		(Country_Name = @Name
					OR	Country_Code = @Code)
					AND	Country_Id <> @Country_Id;
		END;

	ELSE IF @SP_STATUS = 'INSERT_COUNTRY'
		BEGIN
			SELECT		@Country_Id = ISNULL(MAX(Country_Id),0) + 1
			FROM		CountryMaster(nolock);
			INSERT INTO		CountryMaster(Country_Id,
							Country_Code,
							Country_Name,
							Country_CreatedBy,
							Country_CreatedDt,
							Country_IsActive) 
			VALUES			(@Country_Id,@Code,@Name,@User,GETDATE(),@Is_Active);
		END;

	ELSE IF @SP_STATUS = 'UPDATE_COUNTRY'
		BEGIN
			UPDATE		CountryMaster
			SET			Country_Name = @Name,
						Country_Code = @Code,
						Country_UpdatedBy = @User,
						Country_UpdatedDt = GETDATE(),
						Country_IsActive = @Is_Active
			WHERE		Country_Id = @Country_Id;
		END;

	ELSE IF @SP_STATUS = 'DELETE_COUNTRY'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'CountryMaster',@Country_Id,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE BEGIN
				DELETE 
				FROM		CountryMaster
				WHERE		Country_Id = @Country_Id;
				END
		END
	ELSE IF @SP_STATUS = 'FILLGRID_COUNTRY'
		BEGIN
			SELECT		Country_Id,
						Country_Code,
						Country_Name,
						Country_CreatedBy,
						Country_CreatedDt,
						Country_UpdatedBy,
						Country_UpdatedDt,
						CASE
							WHEN Country_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END			AS Country_IsActive,
						B.User_Name	AS U_NAME
			FROM		CountryMaster A (NOLOCK)
					LEFT JOIN dbo.UserMaster AS B
			ON			A.Country_CreatedBy = B.User_ID;
		END;
	--=============================STATE=======================================

	IF @SP_STATUS = 'COUNT_STATE'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		StateMaster(nolock)
			WHERE		(State_Name = @Name OR State_Code = @Code)
					AND State_ID <> @State_Id;
		END;

	ELSE IF @SP_STATUS = 'INSERT_STATE'
		BEGIN
			SELECT		@State_Id = ISNULL(MAX(State_ID),0) + 1
			FROM		StateMaster(nolock);
			INSERT INTO		StateMaster(State_ID,
							State_Code,
							State_Name,
							State_CountryId,
							State_CreatedBy,
							State_CreatedDt,
							State_IsActive) 
			VALUES			(@State_Id,@Code,@Name,@Country_Id,
							@User,GETDATE(),@Is_Active);
		END;

	ELSE IF @SP_STATUS = 'UPDATE_STATE'
		BEGIN
			UPDATE		StateMaster
			SET			State_Name = @Name,
						State_Code = @Code,
						State_CountryId = @Country_Id,
						State_UpdatedBy = @User,
						State_UpdatedDt = GETDATE(),
						State_IsActive = @Is_Active
			WHERE		State_ID = @State_Id;
		END;
	ELSE IF @SP_STATUS = 'DELETE_STATE'
		BEGIN
			DECLARE @MSG_OUT_1 nvarchar(max)
			EXEC SP_Tbl_Dependency	'StateMaster',@State_Id,@MSG_OUT_1 OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_1)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT_1,14,9)
				END
			ELSE 
				BEGIN
					DELETE		FROM StateMaster
					WHERE		State_ID = @State_Id;
				END
		END

	ELSE IF @SP_STATUS = 'FILLGRID_STATE'
		BEGIN
			SELECT		State_ID,
						State_CountryId,
						State_Name,
						State_Code,
						State_CreatedBy,
						State_CreatedDt,
						State_UpdatedBy,
						State_UpdatedDt,
						CASE
							WHEN State_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END				AS State_IsActive,
						B.Country_Name	AS ST_Country_Name,
						C.User_Name		AS U_NAME1
			FROM		StateMaster AS A (NOLOCK)
					LEFT JOIN CountryMaster AS B (NOLOCK)
			ON			A.State_CountryId = B.Country_Id
					LEFT JOIN dbo.UserMaster AS C (NOLOCK)
			ON			A.State_CreatedBy = C.User_ID;
		END;
	--=============================CITY=======================================
	IF @SP_STATUS = 'COUNT_CITY'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		CityMaster(nolock)
			WHERE		(City_Name = @Name OR City_Code = @Code)
					AND City_ID <> @City_Id;
		END;

	ELSE IF @SP_STATUS = 'INSERT_CITY'
	BEGIN
		SELECT		@City_Id = ISNULL(MAX(City_ID),0) + 1
		FROM		CityMaster(nolock);

		INSERT INTO		CityMaster(City_ID,
						City_Code,
						City_Name,
						City_CountryId,
						City_StateId,
						City_CreatedBy,
						City_CreatedDt,
						City_IsActive) 
		VALUES			(@City_Id,@Code,@Name,@Country_Id,@State_Id,
						@User,GETDATE(),@Is_Active);
	END;
	ELSE IF @SP_STATUS = 'UPDATE_CITY'
		BEGIN
			UPDATE		CityMaster
			SET			City_Name = @Name,
						City_Code = @Code,
						City_CountryId = @Country_Id,
						City_StateId = @State_Id,
						City_UpdatedBy = @User,
						City_UpdatedDt = GETDATE(),
						City_IsActive = @Is_Active
			WHERE		City_ID = @City_Id;
		END;

	ELSE IF @SP_STATUS = 'DELETE_CITY'
		BEGIN
			DECLARE @MSG_OUT_2 nvarchar(max)
			EXEC SP_Tbl_Dependency	'CityMaster',
											@City_Id,
											@MSG_OUT_2 OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_2)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT_2,14,9)
				END
			ELSE 
				BEGIN
					DELETE		
					FROM		CityMaster
					WHERE		City_ID = @City_Id;
				END
		END
	ELSE IF @SP_STATUS = 'FILLGRID_CITY'
		BEGIN
			SELECT		City_ID,
						City_Code,
						City_Name,
						City_CountryId,
						City_StateId,
						City_CreatedBy,
						City_CreatedDt,
						City_UpdatedBy,
						City_UpdatedDt,
						CASE
							WHEN City_IsActive = 1 THEN 'Yes'
						ELSE 'No'END AS City_IsActive,
						B.Country_Name	AS CT_Country_Name,
						C.State_Name	AS CT_State_Name,
						D.User_Name		AS U_NAME2
			FROM		CityMaster AS A (NOLOCK)
					LEFT JOIN CountryMaster AS B (NOLOCK)
			ON			A.City_CountryId = B.Country_Id
					LEFT JOIN StateMaster AS C (NOLOCK)
			ON			A.City_StateId = C.State_ID
					LEFT JOIN dbo.UserMaster AS D (NOLOCK)
			ON			A.City_CreatedBy = D.User_ID;
		END;
	--=============================AREA=======================================

	IF @SP_STATUS = 'COUNT_AREA'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		AreaMaster(nolock)
			WHERE		(Area_Name = @Name OR Area_Code = @Code)
					AND Area_ID <> @Area_Id;
		END;

	ELSE IF @SP_STATUS = 'INSERT_AREA'
		BEGIN
			SELECT		@Area_Id = ISNULL(MAX(Area_ID),0) + 1
			FROM		AreaMaster(nolock);
			INSERT INTO		AreaMaster(Area_ID,
							Area_Name,
							Area_Code,
							Area_Pincode,
							Area_ContryId,
							Area_StateId,
							Area_CityId,
							Area_CreatedBy,
							Area_CreatedDt,
							Area_IsActive) 
			VALUES			(@Area_Id,@Name,@Code,@Area_Pincode,@Country_Id,
							@State_Id,@City_Id,@User,GETDATE(),@Is_Active);
		END;

	ELSE IF @SP_STATUS = 'UPDATE_AREA'
		BEGIN
			UPDATE		AreaMaster
			SET			Area_Name = @Name,
						Area_Code = @Code,
						Area_Pincode = @Area_Pincode,
						Area_ContryId = @Country_Id,
						Area_StateId = @State_Id,
						Area_CityId = @City_Id,
						Area_UpdatedBy = @User,
						Area_UpdatedDt = GETDATE(),
						Area_IsActive = @Is_Active
			WHERE		Area_ID = @Area_Id;
		END;
	ELSE IF @SP_STATUS = 'DELETE_AREA'
	
		BEGIN
			DECLARE @MSG_OUT_3 nvarchar(max)
			EXEC SP_Tbl_Dependency	'AreaMaster',@Area_Id,@MSG_OUT_3 OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_3)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT_3,14,9)
				END
			ELSE BEGIN
				DELETE 
				FROM		AreaMaster
				WHERE		Area_ID = @Area_Id;
				END
		END
	ELSE IF @SP_STATUS = 'FILLGRID_AREA'

	BEGIN
		SELECT		Area_ID,
					Area_Code,
					Area_Name,
					Area_Pincode,
					Area_ContryId,
					Area_StateId,
					Area_CityId,
					Area_CreatedBy,
					Area_CreatedDt,
					Area_UpdatedBy,
					Area_UpdatedDt,
					CASE
						WHEN Area_IsActive = 1 THEN 'Yes'
						ELSE 'No'
					END				AS Area_IsActive,
					B.Country_Name	AS AREA_CNTRY_NAME,
					C.State_Name	AS AREA_State_Name,
					D.City_Name		AS AREA_City_Name,
					E.User_Name		AS U_NAME3
		FROM		AreaMaster AS A (NOLOCK)
				LEFT JOIN CountryMaster AS B (NOLOCK)
		ON			A.Area_ContryId = B.Country_Id
				LEFT JOIN StateMaster AS C (NOLOCK)
		ON			A.Area_StateId = C.State_ID
				LEFT JOIN CityMaster AS D (NOLOCK)
		ON			A.Area_CityId = D.City_ID
				LEFT JOIN dbo.UserMaster AS E (NOLOCK)
		ON A.Area_CreatedBy = E.User_ID;
	END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_Dispatch]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 08-04-2018
-- Description:	For Sync Dispatch Detail from cPOS
-- =============================================
CREATE PROCEDURE [dbo].[SP_Dispatch] @SP_STATUS varchar(100) = '',
	@StoreCode varchar(15) = '',
	@Dih_Key numeric(18,0) = 0,
	@Dih_No bigint = 0,
	@Dih_Date datetime = NULL,
	@Dih_RefNo nvarchar(50) = '',
	@Dih_VenId bigint = 0,
	@Dih_VenAddId bigint = 0,
	@Dih_GrossValue numeric(18,3) = 0,
	@Dih_Disc numeric(18,3) = 0,
	@Dih_DiscAmt numeric(18,3) = 0,
	@Dih_NetValue numeric(18,3) = 0,
	@Dih_Duedate datetime = NULL,
	@Dih_BmId bigint = 0,
	@Dih_YearId bigint = 0,
	@Dih_CreatedDt datetime = NULL,
	@Dih_RefDate datetime = NULL
AS
BEGIN
	IF @SP_STATUS = 'INSERT'
		BEGIN
			INSERT INTO		DispatchHeader
							(StoreCode,Dih_Key,Dih_No,Dih_Date,Dih_RefNo,Dih_VenId,
							Dih_VenAddId,Dih_GrossValue,Dih_Disc,Dih_DiscAmt,Dih_NetValue,
							Dih_Duedate,Dih_BmId,Dih_YearId,Dih_CreatedDt,Dih_RefDate) 
			VALUES			(@StoreCode,@Dih_Key,@Dih_No,@Dih_Date,@Dih_RefNo,@Dih_VenId,
							@Dih_VenAddId,@Dih_GrossValue,@Dih_Disc,@Dih_DiscAmt,
							@Dih_NetValue,@Dih_Duedate,@Dih_BmId,@Dih_YearId,@Dih_CreatedDt,@Dih_RefDate)
	END

	ELSE IF @SP_STATUS = 'UPDATE'
		BEGIN
			UPDATE		DispatchHeader
			SET			StoreCode = @StoreCode,
						Dih_Date = @Dih_Date,
						Dih_RefNo = @Dih_RefNo,
						Dih_VenId = @Dih_VenId,
						Dih_VenAddId = @Dih_VenAddId,
						Dih_GrossValue = @Dih_GrossValue,
						Dih_Disc = @Dih_Disc,
						Dih_DiscAmt = @Dih_DiscAmt,
						Dih_NetValue = @Dih_NetValue,
						Dih_Duedate = @Dih_Duedate,
						Dih_BmId = @Dih_BmId,
						Dih_YearId = @Dih_YearId,
						Dih_CreatedDt = @Dih_YearId,
						Dih_RefDate = @Dih_RefDate
			WHERE		Dih_Key = @Dih_Key
		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_DoctorMater]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- AUTHOR:    <AUTHOR,,NAME>  
-- CREATE DATE: <CREATE DATE,,>  
-- DESCRIPTION: <DESCRIPTION,,>  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_DoctorMater] @SP_STATUS varchar(200),  
  @Dm_ID NUMERIC(18,0) = 0,  
  @Dm_Name varchar(250) = NULL,  
  @Dm_ClinicName varchar(250) = NULL,  
  @Dm_Address varchar(500) = NULL,  
  @Dm_MobileNo varchar(15) = NULL,  
  @Dm_EmailId varchar(200) = NULL,  
  @Dm_IsActive bit = 0,  
  @Dm_User int = 0  
AS  
BEGIN  
 IF @SP_STATUS = 'DublicateCount'  
  BEGIN  
   SELECT  COUNT(*) CountOf  
   FROM  DoctorMaster(nolock)  
   WHERE  (Dm_Name = @Dm_Name) AND Dm_Id <> @Dm_ID;  
  END;  
  
 ELSE IF @SP_STATUS = 'Insert'  
  BEGIN  
   SELECT  @Dm_ID = ISNULL(MAX(Dm_Id),0) + 1  
   FROM  DoctorMaster(nolock);  
   INSERT INTO  [dbo].[DoctorMaster]([Dm_Id],  
       [Dm_Name],  
       [Dm_ClinicName],  
       [Dm_Address],  
       [Dm_MobileNo],  
       [Dm_EmailId],  
       [Dm_IsActive],  
       [Dm_CreatedBy],  
       [Dm_CreatedDate])   
   VALUES   (@Dm_ID,@Dm_Name,@Dm_ClinicName,@Dm_Address,@Dm_MobileNo,  
       @Dm_EmailId,@Dm_IsActive,@Dm_User,GETDATE());  
  END;  
  
 ELSE IF @SP_STATUS = 'Update'  
  BEGIN  
   UPDATE  [dbo].[DoctorMaster]  
   SET   [Dm_Name] = @Dm_Name,  
      [Dm_ClinicName] = @Dm_ClinicName,  
      [Dm_Address] = @Dm_Address,  
      [Dm_MobileNo] = @Dm_MobileNo,  
      [Dm_EmailId] = @Dm_EmailId,  
      [Dm_IsActive] = @Dm_IsActive,  
      [Dm_UpdatedBy] = @Dm_User,  
      [Dm_UpdatedDate] = GETDATE()  
   WHERE  [Dm_Id] = @Dm_ID;  
  END;  
  
 ELSE IF @SP_STATUS = 'DublicateMobile'  
  BEGIN  
   SELECT  COUNT(*) CountOf  
   FROM  DoctorMaster(NOLOCK)  
   WHERE  Dm_MobileNo = @Dm_MobileNo AND Dm_Id <> @Dm_Id AND ISNULL(Dm_MobileNo,'') != ''  
  END;  
  
 ELSE IF @SP_STATUS = 'Delete'  
  BEGIN  
   DECLARE @MSG_OUT nvarchar(max)  
   EXEC SP_Tbl_Dependency 'DoctorMaster',  
           @Dm_ID,  
           @MSG_OUT OUTPUT  
   IF (RTRIM(LTRIM(@MSG_OUT)) <> '')  
    BEGIN  
     RAISERROR (@MSG_OUT,14,9)  
    END  
   ELSE   
    BEGIN  
     DELETE   
     FROM  DoctorMaster  
     WHERE  [Dm_Id] = @Dm_ID;  
    END  
  END  
  
 ELSE IF @SP_STATUS = 'Fillgrid'  
  BEGIN  
   SELECT  Dm_Id,  
      Dm_Name,  
      Dm_ClinicName,  
      Dm_Address,  
      Dm_MobileNo,  
      Dm_EmailId,  
      --Dm_IsActive,  
      CASE  
       WHEN Dm_IsActive = 1 THEN 'Yes'  
       ELSE 'No'  
      END   AS Dm_IsActive,  
      Dm_CreatedDate,  
      C.User_Name AS Bm_User  
   FROM  DoctorMaster AS BM (NOLOCK)  
     LEFT JOIN dbo.UserMaster C  
   ON   BM.Dm_CreatedBy = C.User_ID;  
  END;  
  
 ELSE IF @SP_STATUS = 'FillDoctor'  
  BEGIN  
   SELECT  Dm_Id,Dm_Name  
   FROM  DoctorMaster AS BM (NOLOCK)  
   WHERE  BM.Dm_IsActive = 1;  
  END;  
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_Fill_Dashboard]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_Fill_Dashboard] 
@SP_STATUS varchar(199) = '',
@FROMDATE varchar(50)=NULL,
@TODATE varchar(50)=NULL,
@MM_MtmId int=null,
@MM_LmId int=null
AS
BEGIN
	IF @SP_STATUS = 'GETDATA'
	BEGIN
	--NearBy Expiry
			DECLARE @Days1 int=0
			SELECT		@Days1=isnull(NearByExpiryDays,0)  
			FROM		dbo.ConfigurationMaster cm	

	SELECT	convert(decimal(18,2),((SELECT		ISNULL(SUM(Sih_Total), 0)
			FROM		SalesInvoiceHeader  (NOLOCK) SH
			WHERE		CONVERT(date, SH.Sih_Date, 105) = CONVERT(date, GETDATE(), 105))-(Select ISNULL(SUM(Srh_Total), 0) from SalesReturnHeader as SR
WHERE		CONVERT(date, SR.Srh_Date, 105) = CONVERT(date, GETDATE(), 105)))) AS DAYSALES,

			isnull((SELECT sum(isnull(isnull(at.Act_Amount,0)-isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0),0))
			FROM		dbo.AccountTransaction   (NOLOCK) at
					LEFT JOIN	dbo.SalesInvoiceHeader sih	 ON  at.Act_DocNo=sih.Sih_No 
			WHERE		isnull(at.Act_Amount,0)>isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0) and  
						at.Act_DocType=2  AND at.Act_SrNo=1  and  isnull(at.Act_Amount,0)>isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0) 
						AND CONVERT(date,sih.Sih_DueDate)<CONVERT(date,getdate())),0) AS OverDueBillsCount,
						
			isnull((SELECT sum(isnull(isnull(at.Act_Amount,0)-isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0),0))
			FROM dbo.AccountTransaction   (NOLOCK) at
					LEFT JOIN	dbo.PurchaseInvoiceHeader   pih	 ON  at.Act_DocNo=pih.Pih_No 
			WHERE at.Act_DocType=4  AND at.Act_SrNo=1  and  isnull(at.Act_Amount,0)>isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0) and 
						CONVERT(date,pih.Pih_DueDate)<CONVERT(date,getdate())),0) AS OverDueBillsamount,

			convert(decimal(18,2),((SELECT ISNULL(SUM(Sih_Total), 0)
			FROM SalesInvoiceHeader (NOLOCK) SH
			WHERE MONTH(CONVERT(date, SH.Sih_Date, 105)) = MONTH(CONVERT(date, GETDATE())))-(Select ISNULL(SUM(Srh_Total), 0) from SalesReturnHeader as SR
WHERE MONTH(CONVERT(date, SR.Srh_Date, 105)) = MONTH(CONVERT(date, GETDATE()))) )) AS MonthSALES,


			

			(SELECT COUNT(*)
			FROM (
				SELECT		mm.Mm_Code,
							ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock
				FROM		dbo.MedicineMaster(NOLOCK) mm
						LEFT JOIN dbo.vwStock
				ON			mm.Mm_ID = dbo.vwStock.Item_Id
				WHERE		Mm_IsActive = 1
				GROUP BY	mm.Mm_Code) AS OutStock
				WHERE		Stock = 0)
				AS OutStockCount,
				(SELECT		COUNT(*)
				FROM		vwStockBatchWise (NOLOCK)
				WHERE		(CONVERT(date, Stk_ExpDate) <= CONVERT(date, DATEADD(DAY, @Days1, GETDATE()))
							AND CONVERT(date, Stk_ExpDate) >= CONVERT(date, GETDATE()))
							AND ISNULL(QTY, 0) > 0)
				AS NearByExpiry
	END;
	ELSE IF 
	@SP_STATUS = 'NearByExpiryStock'
		BEGIN
			DECLARE @Days int=0
			SELECT		@Days=isnull(NearByExpiryDays,0)  
			FROM		dbo.ConfigurationMaster cm	

			SELECT		vwStockBatchWise.*,
						'' as Branch_Name, 
						'' as Branch_Address, 
						'' as Branch_GstNo,
						Mm_HsnCode AS HsnCode,
						MTM.Mtm_TypeName AS DrugType,
						MGM.Mgm_Name  AS DrugGroup,
						MCM.Mcm_Name AS DrugCategory
			FROM		vwStockBatchWise  (NOLOCK)
					--inner  join (select top 1 * from BranchMaster (NOLOCK) )as BranchMaster  on 0=0
					Left join MedicineMaster (NOLOCK)  MM
			ON			MM.Mm_ID=vwStockBatchWise.Stk_MmId
					Left join MedicineTypeMaster (NOLOCK) MTM
			ON			MTM.Mtm_ID=MM.Mm_MtmId
					Left join MedicineGroupMaster (NOLOCK) MGM
			ON			MGM.Mgm_ID=MM.Mm_MgmId
					Left join MedicineCategoryMaster  (NOLOCK) MCM
			ON			MCM.Mcm_ID=MM.Mm_McmId
			WHERE		(CONVERT(date, Stk_ExpDate) <= CONVERT(date, DATEADD(day,@Days , GETDATE()))
						AND CONVERT(date, Stk_ExpDate) >= CONVERT(date, GETDATE()))
						AND ISNULL(QTY, 0) > 0
		END;
	ELSE
	IF @SP_STATUS = 'OUTOFSTOCKLIST'
	BEGIN
	     IF(@Mm_MtmId!=0)
		 BEGIN
	            SELECT		ROW_NUMBER() OVER (ORDER BY Mm_ID DESC) AS SrNo,Code,Name,LASTSALEDATE,Branch_Name,Branch_Address,
							Branch_GstNo,Mgm_Name,Mcm_Name,Mtm_TypeName,Mm_HsnCode
	            FROM		(SELECT		mm.Mm_Code AS Code,
	            						mm.Mm_HsnCode,
	            						mm.Mm_ID,
	            						mm.Mm_Name AS Name,
	            						ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock,
	            						(CASE
	            							WHEN LSDT.Sih_Date = '1900-01-01 00:00:00.000' THEN ''
	            							ELSE LSDT.Sih_Date
	            						END) AS LASTSALEDATE,
	            						BM.Branch_Name,
	            						Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	            						bm.Branch_GstNo,
	            						Mgm_Name,
	            						Mcm_Name,
	            						Mtm_TypeName,
										mm.Mm_MtmId
								FROM		MedicineMaster(NOLOCK) mm
										LEFT JOIN MedicineGroupMaster (NOLOCK) mgm
	            				ON mgm.Mgm_ID = mm.Mm_MgmId
										LEFT JOIN MedicineCategoryMaster (NOLOCK) mcm
	            				ON mcm.Mcm_ID = mm.Mm_McmId
										LEFT JOIN MedicineTypeMaster (NOLOCK) mtm
								ON mtm.Mtm_ID=mm.Mm_MtmId
										LEFT JOIN dbo.vwStock (NOLOCK)
	            				ON mm.Mm_ID = dbo.vwStock.Item_Id
										LEFT JOIN (SELECT		MAX(ISNULL(Sih_Date, '')) AS Sih_Date,SIID.Sid_Mm_Id
													FROM		SalesInvoiceItemDetail (NOLOCK) SIID
															INNER JOIN SalesInvoiceHeader SIH
	            									ON			SIID.Sid_Sih_Key = SIH.Sih_Key
													GROUP BY	SIID.Sid_Mm_Id) AS LSDT
	            									ON			LSDT.Sid_Mm_Id = mm.Mm_ID
															LEFT JOIN BranchMaster Bm  
													on			Bm.Branch_Id=1
													 WHERE Mm_IsActive = 1
													 GROUP BY	mm.Mm_Code,
	            												mm.Mm_ID,
	            												mm.Mm_Name,
	            												Sih_Date,
	            												Branch_Name,
	            												Branch_Address1,
																Branch_Address2,
																Branch_Address3,
	            												Branch_GstNo,
	            												Mgm_Name,
	            												Mcm_Name,
	            												Mtm_TypeName,
	            												Mm_HsnCode,
																Mm_MtmId) AS OutStock
														WHERE Stock = 0 AND Mm_MtmId=@Mm_MtmId
	      END

		  ELSE
		  BEGIN
				SELECT		ROW_NUMBER() OVER (ORDER BY Mm_ID DESC) AS SrNo,Code,Name,LASTSALEDATE,Branch_Name,Branch_Address,
							Branch_GstNo,Mgm_Name,Mcm_Name,Mtm_TypeName,Mm_HsnCode
	            FROM		(SELECT		mm.Mm_Code AS Code,
	            						mm.Mm_HsnCode,
	            						mm.Mm_ID,
	            						mm.Mm_Name AS Name,
	            						ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock,
	            						(CASE
	            							WHEN LSDT.Sih_Date = '1900-01-01 00:00:00.000' THEN ''
	            							ELSE LSDT.Sih_Date
	            						END) AS LASTSALEDATE,
	            						Mgm_Name,
	            						Mcm_Name,
	            						Mtm_TypeName,
										mm.Mm_MtmId,
										BM.Branch_Name,
	            						Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	            						bm.Branch_GstNo
							FROM		MedicineMaster(NOLOCK) mm
									LEFT JOIN	MedicineGroupMaster (NOLOCK) mgm
	            			ON			mgm.Mgm_ID = mm.Mm_MgmId
									LEFT JOIN MedicineCategoryMaster (NOLOCK) mcm
	            			ON			mcm.Mcm_ID = mm.Mm_McmId
									LEFT JOIN MedicineTypeMaster (NOLOCK) mtm
							ON			mtm.Mtm_ID=mm.Mm_MtmId
									LEFT JOIN dbo.vwStock (NOLOCK)
	            			ON			mm.Mm_ID = dbo.vwStock.Item_Id
									LEFT JOIN (SELECT		MAX(ISNULL(Sih_Date, '')) AS Sih_Date,SIID.Sid_Mm_Id
												FROM		SalesInvoiceItemDetail  (NOLOCK) SIID
														INNER JOIN SalesInvoiceHeader (NOLOCK) SIH
	            								ON			SIID.Sid_Sih_Key = SIH.Sih_Key
												GROUP BY	SIID.Sid_Mm_Id) AS LSDT
												
							ON				LSDT.Sid_Mm_Id = mm.Mm_ID
									LEFT JOIN BranchMaster (NOLOCK) BM  on Bm.Branch_Id=1
							 WHERE Mm_IsActive = 1
							GROUP BY		mm.Mm_Code,
	            							mm.Mm_ID,
	            							mm.Mm_Name,
	            							Sih_Date,
	            							Branch_Name,
	            							Branch_Address1,
											Branch_Address2,
											Branch_Address3,
	            							Branch_GstNo,
	            							Mgm_Name,
	            							Mcm_Name,
	            							Mtm_TypeName,
	            							Mm_HsnCode,
											Mm_MtmId) AS OutStock
							WHERE Stock = 0
		  END
	END;

	ELSE

	IF @SP_STATUS = 'LocationWiseStock'
	BEGIN
	     IF(@MM_MtmId>0 OR @MM_LmId>0 )
         BEGIN
             
           IF(@MM_MtmId>0)
           BEGIN
                
                IF(@MM_LmId>0)
                BEGIN
                     SELECT MTM.Mtm_TypeName AS DRUGTYPE,  
                            MGM.Mgm_Name AS DRUGGROUP,  
                            MCM.Mcm_Name AS DRUGCATEGORY,
					        MM.Mm_HsnCode AS HSNCODE,  
                            MM.Mm_Code AS DRUGCODE,  
                            MM.Mm_Name AS DRUGNAME,  
                            LM.Lm_Name AS LOCATIONNAME,  
                            STOCK.BATCHNO,  
                            STOCK.PURCHASEUNITWISEQTY,  
                            STOCK.PURCHASERATE,  
                            STOCK.SALESUNITWISEQTY,  
                            STOCK.SALESRATE,  
                            STOCK.PURCHASEUOM,  
                            STOCK.SALESUOM,
			                BM.Branch_Name,
                            BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS Branch_Address,
                            BM.Branch_GstNo   
                        FROM LocationMaster (NOLOCK) LM 
	                         LEFT JOIN BranchMaster (NOLOCK) BM ON BM.Branch_Id=1
                             INNER JOIN (SELECT *   
                                          FROM (SELECT (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END))AS PURCHASEUNITWISEQTY,  
                                                     PUOM.Uom_Name AS PURCHASEUOM,  
                                                     SR.Stk_PurchaseRate AS PURCHASERATE,  
                                                    (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END))AS SALESUNITWISEQTY,  
                                                     SUOM.Uom_Name AS SALESUOM,  
                                                     SR.Stk_SalesRate AS SALESRATE,  
                                                     SR.Stk_LmId,  
                                                     SR.Stk_MmId,  
                                                     SR.Stk_BatchNo AS BATCHNO  
                                                FROM StockRegister (NOLOCK) SR  
                                                     INNER JOIN UomMaster (NOLOCK) PUOM   
                                                  ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                                                     INNER JOIN UomMaster (NOLOCK) SUOM   
                            ON SUOM.Uom_ID=SR.Stk_PurchaseUom  
                               GROUP BY SR.Stk_MmId,SR.Stk_BatchNo,SR.Stk_LmId,PUOM.Uom_Name,SUOM.Uom_Name,SR.Stk_PurchaseRate,SR.Stk_SalesRate)AS DT  
                               WHERE DT.PURCHASEUNITWISEQTY>0)AS STOCK  
                            ON LM.Lm_Id=STOCK.Stk_LmId  
                               LEFT JOIN MedicineMaster MM   
                            ON MM.Mm_ID=STOCK.Stk_MmId  
                               LEFT JOIN MedicineTypeMaster MTM  
                            ON MTM.Mtm_ID=MM.Mm_MtmId  
                               LEFT JOIN MedicineCategoryMaster MCM  
                            ON MCM.Mcm_ID=MM.Mm_McmId  
                               LEFT JOIN MedicineGroupMaster MGM  
                            ON MGM.Mgm_ID=MM.Mm_McmId 
					     WHERE MM.Mm_MtmId=@MM_MtmId AND LM.Lm_Id=@MM_LmId
                END
				ELSE
				BEGIN
				      SELECT MTM.Mtm_TypeName AS DRUGTYPE,  
                            MGM.Mgm_Name AS DRUGGROUP,  
                            MCM.Mcm_Name AS DRUGCATEGORY,
					        MM.Mm_HsnCode AS HSNCODE,  
                            MM.Mm_Code AS DRUGCODE,  
                            MM.Mm_Name AS DRUGNAME,  
                            LM.Lm_Name AS LOCATIONNAME,  
                            STOCK.BATCHNO,  
                            STOCK.PURCHASEUNITWISEQTY,  
                            STOCK.PURCHASERATE,  
                            STOCK.SALESUNITWISEQTY,  
                            STOCK.SALESRATE,  
                            STOCK.PURCHASEUOM,  
                            STOCK.SALESUOM,
			                BM.Branch_Name,
                            BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS Branch_Address,
                            BM.Branch_GstNo   
                        FROM LocationMaster (NOLOCK) LM 
	                         LEFT JOIN BranchMaster (NOLOCK) BM ON BM.Branch_Id=1
                             INNER JOIN (SELECT *   
                                          FROM (SELECT (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END))AS PURCHASEUNITWISEQTY,  
                                                     PUOM.Uom_Name AS PURCHASEUOM,  
                                                     SR.Stk_PurchaseRate AS PURCHASERATE,  
                                                    (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END))AS SALESUNITWISEQTY,  
                                                     SUOM.Uom_Name AS SALESUOM,  
                                                     SR.Stk_SalesRate AS SALESRATE,  
                                                     SR.Stk_LmId,  
                                                     SR.Stk_MmId,  
                                                     SR.Stk_BatchNo AS BATCHNO  
                                                FROM StockRegister (NOLOCK) SR  
                                                     INNER JOIN UomMaster (NOLOCK) PUOM   
                                                  ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                                                     INNER JOIN UomMaster (NOLOCK) SUOM   
                            ON SUOM.Uom_ID=SR.Stk_PurchaseUom  
                               GROUP BY SR.Stk_MmId,SR.Stk_BatchNo,SR.Stk_LmId,PUOM.Uom_Name,SUOM.Uom_Name,SR.Stk_PurchaseRate,SR.Stk_SalesRate)AS DT  
                               WHERE DT.PURCHASEUNITWISEQTY>0)AS STOCK  
                            ON LM.Lm_Id=STOCK.Stk_LmId  
                               LEFT JOIN MedicineMaster MM   
                            ON MM.Mm_ID=STOCK.Stk_MmId  
                               LEFT JOIN MedicineTypeMaster MTM  
                            ON MTM.Mtm_ID=MM.Mm_MtmId  
                               LEFT JOIN MedicineCategoryMaster MCM  
                            ON MCM.Mcm_ID=MM.Mm_McmId  
                               LEFT JOIN MedicineGroupMaster MGM  
                            ON MGM.Mgm_ID=MM.Mm_McmId 
					     WHERE MM.Mm_MtmId=@MM_MtmId 
				END
           END
           ELSE
           BEGIN
                SELECT MTM.Mtm_TypeName AS DRUGTYPE,  
                            MGM.Mgm_Name AS DRUGGROUP,  
                            MCM.Mcm_Name AS DRUGCATEGORY,
					        MM.Mm_HsnCode AS HSNCODE,  
                            MM.Mm_Code AS DRUGCODE,  
                            MM.Mm_Name AS DRUGNAME,  
                            LM.Lm_Name AS LOCATIONNAME,  
                            STOCK.BATCHNO,  
                            STOCK.PURCHASEUNITWISEQTY,  
                            STOCK.PURCHASERATE,  
                            STOCK.SALESUNITWISEQTY,  
                            STOCK.SALESRATE,  
                            STOCK.PURCHASEUOM,  
                            STOCK.SALESUOM,
			                BM.Branch_Name,
                            BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS Branch_Address,
                            BM.Branch_GstNo   
                        FROM LocationMaster (NOLOCK) LM 
	                         LEFT JOIN BranchMaster (NOLOCK) BM ON BM.Branch_Id=1
                             INNER JOIN (SELECT *   
                                          FROM (SELECT (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END))AS PURCHASEUNITWISEQTY,  
                                                     PUOM.Uom_Name AS PURCHASEUOM,  
                                                     SR.Stk_PurchaseRate AS PURCHASERATE,  
                                                    (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END))AS SALESUNITWISEQTY,  
                                                     SUOM.Uom_Name AS SALESUOM,  
                                                     SR.Stk_SalesRate AS SALESRATE,  
                                                     SR.Stk_LmId,  
                                                     SR.Stk_MmId,  
                                                     SR.Stk_BatchNo AS BATCHNO  
                                                FROM StockRegister (NOLOCK) SR  
                                                     INNER JOIN UomMaster (NOLOCK) PUOM   
                                                  ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                                                     INNER JOIN UomMaster (NOLOCK) SUOM   
                            ON SUOM.Uom_ID=SR.Stk_PurchaseUom  
                               GROUP BY SR.Stk_MmId,SR.Stk_BatchNo,SR.Stk_LmId,PUOM.Uom_Name,SUOM.Uom_Name,SR.Stk_PurchaseRate,SR.Stk_SalesRate)AS DT  
                               WHERE DT.PURCHASEUNITWISEQTY>0)AS STOCK  
                            ON LM.Lm_Id=STOCK.Stk_LmId  
                               LEFT JOIN MedicineMaster MM   
                            ON MM.Mm_ID=STOCK.Stk_MmId  
                               LEFT JOIN MedicineTypeMaster MTM  
                            ON MTM.Mtm_ID=MM.Mm_MtmId  
                               LEFT JOIN MedicineCategoryMaster MCM  
                            ON MCM.Mcm_ID=MM.Mm_McmId  
                               LEFT JOIN MedicineGroupMaster MGM  
                            ON MGM.Mgm_ID=MM.Mm_McmId 
					     WHERE  LM.Lm_Id=@MM_LmId
           END  
	    END
		ELSE
		BEGIN
		      SELECT MTM.Mtm_TypeName AS DRUGTYPE,  
                            MGM.Mgm_Name AS DRUGGROUP,  
                            MCM.Mcm_Name AS DRUGCATEGORY,
					        MM.Mm_HsnCode AS HSNCODE,  
                            MM.Mm_Code AS DRUGCODE,  
                            MM.Mm_Name AS DRUGNAME,  
                            LM.Lm_Name AS LOCATIONNAME,  
                            STOCK.BATCHNO,  
                            STOCK.PURCHASEUNITWISEQTY,  
                            STOCK.PURCHASERATE,  
                            STOCK.SALESUNITWISEQTY,  
                            STOCK.SALESRATE,  
                            STOCK.PURCHASEUOM,  
                            STOCK.SALESUOM,
			                BM.Branch_Name,
                            BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS Branch_Address,
                            BM.Branch_GstNo   
                        FROM LocationMaster (NOLOCK) LM 
	                         LEFT JOIN BranchMaster (NOLOCK) BM ON BM.Branch_Id=1
                             INNER JOIN (SELECT *   
                                          FROM (SELECT (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END))AS PURCHASEUNITWISEQTY,  
                                                     PUOM.Uom_Name AS PURCHASEUOM,  
                                                     SR.Stk_PurchaseRate AS PURCHASERATE,  
                                                    (SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)-  
                                                    SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END))AS SALESUNITWISEQTY,  
                                                     SUOM.Uom_Name AS SALESUOM,  
                                                     SR.Stk_SalesRate AS SALESRATE,  
                                                     SR.Stk_LmId,  
                                                     SR.Stk_MmId,  
                                                     SR.Stk_BatchNo AS BATCHNO  
                                                FROM StockRegister (NOLOCK) SR  
                                                     INNER JOIN UomMaster (NOLOCK) PUOM   
                                                  ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                                                     INNER JOIN UomMaster (NOLOCK) SUOM   
                            ON SUOM.Uom_ID=SR.Stk_PurchaseUom  
                               GROUP BY SR.Stk_MmId,SR.Stk_BatchNo,SR.Stk_LmId,PUOM.Uom_Name,SUOM.Uom_Name,SR.Stk_PurchaseRate,SR.Stk_SalesRate)AS DT  
                               WHERE DT.PURCHASEUNITWISEQTY>0)AS STOCK  
                            ON LM.Lm_Id=STOCK.Stk_LmId  
                               LEFT JOIN MedicineMaster MM   
                            ON MM.Mm_ID=STOCK.Stk_MmId  
                               LEFT JOIN MedicineTypeMaster MTM  
                            ON MTM.Mtm_ID=MM.Mm_MtmId  
                               LEFT JOIN MedicineCategoryMaster MCM  
                            ON MCM.Mcm_ID=MM.Mm_McmId  
                               LEFT JOIN MedicineGroupMaster MGM  
                            ON MGM.Mgm_ID=MM.Mm_McmId 
					     
		
	    END
	END
	ELSE
	IF @SP_STATUS = 'SP_RPT_SalesAndStockPivotTable'
	BEGIN
          IF(@MM_MtmId!=0)
          BEGIN
            SELECT MM.Mm_Code AS DRUGCODE,        
                   MM.Mm_Name AS DRUGNAME,       
                   ISNULL(STOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS  PURCHASEUNIT,       
                   MM.MM_PackSize AS PACKSIZE,     
                   ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                             FROM StockRegister     
                            WHERE CONVERT(DATE,StockRegister.Stk_Date,105)<CONVERT(DATE,@FROMDATE,105) AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                                  GROUP BY StockRegister.Stk_MmId),0)AS OPENINGSTOCK,    
                   ISNULL(SUM(STOCK.OPENINGSTOCKQTY),0)AS ADDOPENINGSTOCKQTY,      
                   ISNULL(SUM(STOCK.SALESQTY),0)AS SALESQTY,      
                   ISNULL(SUM(STOCK.SALESRETURNQTY),0)AS SALESRETURNQTY,        
                   ISNULL(SUM(STOCK.PURCHASEQTY),0)AS PURCHASEQTY,      
                   ISNULL(SUM(STOCK.PURCHASERETURNQTY),0)AS PURCHASERETURNQTY,      
                   ISNULL(SUM(STOCK.ADJUSTQTY),0)AS ADJUSTQTY,    
                   ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                             FROM StockRegister     
                            WHERE CONVERT(DATE,StockRegister.Stk_Date,105)<=CONVERT(DATE,@TODATE,105)  AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                                  GROUP BY StockRegister.Stk_MmId),0)AS CLOSINGSTOCK,    
                   STOCK.MONTH1,    
                   STOCK.YEAR1,
            	   BM.Branch_Name,
            	   ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
            	   BM.Branch_GstNo,
				   MTM.Mtm_TypeName AS DrugType,
				   MGM.Mgm_Name AS DrugGroup,
				   MCM.Mcm_Name AS DrugCategory,
				   MM.Mm_HsnCode AS HsnCode      
              FROM MedicineMaster (NOLOCK) MM
			       LEFT JOIN MedicineTypeMaster (NOLOCK) MTM
				   ON MTM.Mtm_ID=MM.Mm_MtmId
				   LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
				   ON MGM.Mgm_ID=MM.Mm_MgmId
				   LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
				   ON MCM.Mcm_ID=MM.Mm_McmId
                   LEFT JOIN BranchMaster BM 
            	   ON BM.Branch_Id=1    
                   INNER JOIN (SELECT SR.Stk_MmId,    
                                      SR.Stk_Date,    
                                      (CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,        
                                      (CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,      
                                      (CASE WHEN SR.Stk_DocType=6 AND SR.Stk_Tran_Typ='C'  THEN SR.Stk_PurchaseQty ELSE 0 END)AS OPENINGSTOCKQTY,      
                                      (CASE WHEN SR.Stk_DocType=2 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESQTY,       
                                      (CASE WHEN SR.Stk_DocType=3 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESRETURNQTY,       
                                      (CASE WHEN SR.Stk_DocType in(4,6) AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASEQTY,      
                                      (CASE WHEN SR.Stk_DocType=5 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASERETURNQTY,          
                                       (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='D' THEN -SR.Stk_PurchaseQty ELSE 0 END) END)AS ADJUSTQTY,          
                                       PUOM.Uom_Name AS PURCHASEUNIT,    
                                       DATENAME(MONTH,SR.Stk_Date)AS MONTH1,       
                                       YEAR(SR.Stk_Date)AS YEAR1,    
                                       MONTH(SR.Stk_Date)AS MONTHNO     
                                  FROM StockRegister (NOLOCK) SR      
                                       INNER JOIN UomMaster (NOLOCK) PUOM        
                                    ON PUOM.Uom_ID=SR.Stk_PurchaseUom 
									WHERE CONVERT(DATE,SR.Stk_Date,105) BETWEEN CONVERT(DATE,@FROMDATE,105)  AND CONVERT(DATE,@TODATE,105)
									)AS STOCK    
               ON STOCK.Stk_MmId=MM.Mm_ID     
                  LEFT JOIN UomMaster PPUOM         
              ON  PPUOM.Uom_ID=MM.MM_PurchaseUom 
		   WHERE  MM.Mm_MtmId=@Mm_MtmId  
                  GROUP BY MM.Mm_Code,MM.Mm_Name,STOCK.Stk_MmId,STOCK.PURCHASEUNIT,MM.MM_PackSize,MONTHNO,PPUOM.Uom_Name,YEAR1,MONTH1,BM.Branch_Name,
            	  BM.Branch_Address1,BM.Branch_Address2,BM.Branch_Address3,BM.Branch_GstNo,MTM.Mtm_TypeName,
				   MGM.Mgm_Name,
				   MCM.Mcm_Name,
				   MM.Mm_HsnCode     
                  ORDER BY MM.Mm_Name ASC
		   END
		   ELSE
		   BEGIN
		        SELECT MM.Mm_Code AS DRUGCODE,        
                   MM.Mm_Name AS DRUGNAME,       
                   ISNULL(STOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS  PURCHASEUNIT,       
                   MM.MM_PackSize AS PACKSIZE,     
                   ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                             FROM StockRegister     
                            WHERE CONVERT(DATE,StockRegister.Stk_Date,105)<CONVERT(DATE,@FROMDATE,105) AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                                  GROUP BY StockRegister.Stk_MmId),0)AS OPENINGSTOCK,    
                   ISNULL(SUM(STOCK.OPENINGSTOCKQTY),0)AS ADDOPENINGSTOCKQTY,      
                   ISNULL(SUM(STOCK.SALESQTY),0)AS SALESQTY,      
                   ISNULL(SUM(STOCK.SALESRETURNQTY),0)AS SALESRETURNQTY,        
                   ISNULL(SUM(STOCK.PURCHASEQTY),0)AS PURCHASEQTY,      
                   ISNULL(SUM(STOCK.PURCHASERETURNQTY),0)AS PURCHASERETURNQTY,      
                   ISNULL(SUM(STOCK.ADJUSTQTY),0)AS ADJUSTQTY,    
                   ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                             FROM StockRegister     
                            WHERE CONVERT(DATE,StockRegister.Stk_Date,105)<=CONVERT(DATE,@TODATE,105)  AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                                  GROUP BY StockRegister.Stk_MmId),0)AS CLOSINGSTOCK,    
                   STOCK.MONTH1,    
                   STOCK.YEAR1,
            	   BM.Branch_Name,
            	   ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
            	   BM.Branch_GstNo,
				   MTM.Mtm_TypeName AS DrugType,
				   MGM.Mgm_Name AS DrugGroup,
				   MCM.Mcm_Name AS DrugCategory,
				   MM.Mm_HsnCode AS HsnCode            
              FROM MedicineMaster (NOLOCK) MM
			       LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
				   ON MTM.Mtm_ID=MM.Mm_MtmId
				   LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
				   ON MGM.Mgm_ID=MM.Mm_MgmId
				   LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
				   ON MCM.Mcm_ID=MM.Mm_McmId
                   LEFT JOIN BranchMaster BM 
            	   ON BM.Branch_Id=1    
                   INNER JOIN (SELECT SR.Stk_MmId,    
                                      SR.Stk_Date,    
                                      (CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,        
                                      (CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,      
                                      (CASE WHEN SR.Stk_DocType=6 AND SR.Stk_Tran_Typ='C'  THEN SR.Stk_PurchaseQty ELSE 0 END)AS OPENINGSTOCKQTY,      
                                      (CASE WHEN SR.Stk_DocType=2 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESQTY,       
                                      (CASE WHEN SR.Stk_DocType=3 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESRETURNQTY,       
                                      (CASE WHEN SR.Stk_DocType in(4,6) AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASEQTY,      
                                      (CASE WHEN SR.Stk_DocType=5 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASERETURNQTY,          
                                       (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='D' THEN -SR.Stk_PurchaseQty ELSE 0 END) END)AS ADJUSTQTY,          
                                       PUOM.Uom_Name AS PURCHASEUNIT,    
                                       DATENAME(MONTH,SR.Stk_Date)AS MONTH1,       
                                       YEAR(SR.Stk_Date)AS YEAR1,    
                                       MONTH(SR.Stk_Date)AS MONTHNO     
                                  FROM StockRegister (NOLOCK) SR      
                                       INNER JOIN UomMaster (NOLOCK) PUOM        
                                    ON PUOM.Uom_ID=SR.Stk_PurchaseUom 
									WHERE CONVERT(DATE,SR.Stk_Date,105) BETWEEN CONVERT(DATE,@FROMDATE,105)  AND CONVERT(DATE,@TODATE,105)
									)AS STOCK    
               ON STOCK.Stk_MmId=MM.Mm_ID     
                  LEFT JOIN UomMaster (NOLOCK) PPUOM         
              ON  PPUOM.Uom_ID=MM.MM_PurchaseUom  
                  GROUP BY MM.Mm_Code,MM.Mm_Name,STOCK.Stk_MmId,STOCK.PURCHASEUNIT,MM.MM_PackSize,MONTHNO,PPUOM.Uom_Name,YEAR1,MONTH1,BM.Branch_Name,
            	  BM.Branch_Address1,BM.Branch_Address2,BM.Branch_Address3,BM.Branch_GstNo,MTM.Mtm_TypeName,
				   MGM.Mgm_Name,
				   MCM.Mcm_Name,
				   MM.Mm_HsnCode         
                  ORDER BY MM.Mm_Name ASC
		   END
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_FormDetail]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_FormDetail] @SP_STATUS varchar(200),
		@Id int = 0
AS
BEGIN
	IF @SP_STATUS = 'GetFormCode'
		BEGIN
			SELECT		FormPrefix
			FROM		FormDetailTable(nolock)
			WHERE		Id = @Id
		END;
	---Comment By Rohit
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_Journal]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_Journal] @Result nvarchar(100),
@Journals JournalMaster READONLY,
@Jm_Id int = NULL,
@Jm_VoucherNo nvarchar(100) = NULL,
@Jm_VoucherDate datetime = NULL,
@Jm_VoucherTypeId nvarchar(max) = NULL,
@Jm_Description nvarchar(50) = NULL
AS
BEGIN
	IF @Result = 'Insert'--INSERT
	BEGIN
	INSERT INTO VoucherMaster(Vm_VoucherNo,
	Vm_VoucherDate,
	Vm_VoucherTypeId,
	Vm_Description) VALUES
	(@Jm_VoucherNo,@Jm_VoucherDate,@Jm_VoucherTypeId,@Jm_Description);
	SELECT @Jm_Id = SCOPE_IDENTITY();
	INSERT INTO JournalMaster(Jm_VoucherId,
	Jm_LedgerId,
	Jm_Amount,
	Jm_DrCr)
		SELECT	@Jm_Id,
					LedgerId,
					Amount,
					DrCr
		FROM @Journals;
	UPDATE VoucherTypeMaster
	SET Vtm_LastNo = CAST(@Jm_VoucherNo AS int)
	WHERE Vtm_Id = @Jm_VoucherTypeId;
	END
	ELSE IF @Result = 'Update'--UPDATE
	BEGIN
	DELETE FROM JournalMaster
	WHERE Jm_VoucherId = @Jm_Id;
	UPDATE VoucherMaster
	SET	Vm_VoucherNo = @Jm_VoucherNo,
			Vm_VoucherDate = @Jm_VoucherDate,
			Vm_VoucherTypeId = @Jm_VoucherTypeId,
			Vm_Description = @Jm_Description
	WHERE Vm_Id = @Jm_Id;
	SELECT @Jm_Id = @Jm_Id; -- SCOPE_IDENTITY();
	INSERT INTO JournalMaster(Jm_VoucherId,
	Jm_LedgerId,
	Jm_Amount,
	Jm_DrCr)
		SELECT	@Jm_Id,
					LedgerId,
					Amount,
					DrCr
		FROM @Journals;
	END
	ELSE IF @Result = 'Delete'--DELETE
	BEGIN
	DELETE FROM VoucherMaster
	WHERE Vm_Id = @Jm_Id
	END
	ELSE IF @Result = 'Fillgrid'--FILLGRID
	BEGIN
	SELECT	j.Jm_Id,
				j.VoucherId,
				j.LedgerId,
				j.Amount,
				j.DrCr
	FROM JournalMaster(NOLOCK) j
	LEFT JOIN Ledger l
		ON l.Jm_Id = j.LedgerId
	WHERE VoucherId = @Jm_Id;
	END
	ELSE IF @Result = 'FillLedger'--FILLLEDGER
	BEGIN
	SELECT	0					AS Lm_Id,
				'--Select--'	AS Lm_Name
	UNION
	SELECT	Lm_Id,
				Lm_Name
	FROM LedgerMaster(NOLOCK)
	WHERE Lm_IsActive = 1;
	END
	ELSE IF @Result = 'Retrive'--GET
	BEGIN
	SELECT	j.*,
				l.Lm_Name	AS LedgerName
	FROM JournalMaster(NOLOCK) j
	LEFT JOIN LedgerMaster l
		ON j.Jm_LedgerId = l.Lm_Id
	WHERE Jm_VoucherId = @Jm_Id;
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_Ledger]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_Ledger] @Result nvarchar(100),
		@Lm_Id NUMERIC(18,0) = NULL,
		@Lm_Name nvarchar(100) = NULL,
		@Lm_GroupId int = NULL,
		@Lm_Address nvarchar(max) = NULL,
		@Lm_PhoneNo nvarchar(50) = NULL,
		@Lm_PanNo nvarchar(50) = NULL,
		@Lm_GstNo nvarchar(50) = NULL,
		@Lm_OpeningBalance decimal(18,2) = NULL,
		@Lm_TaxPer decimal(18,2) = NULL,
		@Lm_TaxMethod nvarchar(255) = NULL,
		@Lm_OpeningDate datetime = NULL,
		@Lm_OpeningDrCr nvarchar(2) = NULL,
		@Lm_Description nvarchar(max) = NULL,
		@Lm_IsActive bit = NULL,
		@Lm_IsStockAffected bit = NULL,
		@Lm_PVId NUMERIC(18,0) = 0
AS
BEGIN
	IF @Result = 'Insert'
		BEGIN
			SELECT		@Lm_Id = ISNULL(MAX(Lm_Id),0) + 1
			FROM		LedgerMaster(nolock);

			INSERT INTO		LedgerMaster
							(Lm_Id,Lm_Name,Lm_GroupId,Lm_Address,Lm_Description,Lm_IsActive,Lm_IsStockAffected,Lm_PhoneNo,
							Lm_PanNo,Lm_GstNo,Lm_OpeningBalance,Lm_TaxPer,Lm_TaxMethod,Lm_OpeningDate,Lm_OpeningDrCr,Lm_PVId) 
			VALUES
							(@Lm_Id,@Lm_Name,@Lm_GroupId,@Lm_Address,@Lm_Description,@Lm_IsActive,@Lm_IsStockAffected,
							@Lm_PhoneNo,@Lm_PanNo,@Lm_GstNo,@Lm_OpeningBalance,@Lm_TaxPer,@Lm_TaxMethod,@Lm_OpeningDate,@Lm_OpeningDrCr,@Lm_PVId);
		END

	ELSE IF @Result = 'InsertFromVendor'
		BEGIN
			SELECT		@Lm_Id = ISNULL(MAX(Lm_Id),0) + 1
			FROM		LedgerMaster(nolock);
			INSERT INTO		LedgerMaster
							(Lm_Id,Lm_Name,Lm_GroupId,Lm_Address,Lm_Description,Lm_IsActive,Lm_IsStockAffected,Lm_PhoneNo,Lm_PanNo,Lm_GstNo,
							Lm_OpeningBalance,Lm_TaxPer,Lm_TaxMethod,Lm_OpeningDate,Lm_OpeningDrCr,Lm_PVId) 
			VALUES
							(@Lm_Id,@Lm_Name,@Lm_GroupId,@Lm_Address,@Lm_Description,@Lm_IsActive,@Lm_IsStockAffected,
							@Lm_PhoneNo,@Lm_PanNo,@Lm_GstNo,@Lm_OpeningBalance,@Lm_TaxPer,@Lm_TaxMethod,@Lm_OpeningDate,@Lm_OpeningDrCr,@Lm_PVId);

			UPDATE		VendorMaster
			SET			Vendor_Ledger_id = @Lm_Id
			WHERE		Vendor_ID = @Lm_PVId
		END

	ELSE IF @Result = 'InsertFromPatient'
		BEGIN
			iF NOT EXiSTS(SELECT * FROM LedgerMaster A WHERE A.Lm_PVId=@Lm_PVId AND Lm_GroupId=46)
				BEGiN
					SELECT		@Lm_Id = ISNULL(MAX(Lm_Id),0) + 1
					FROM		LedgerMaster(nolock);

					INSERT INTO		LedgerMaster
									(Lm_Id,Lm_Name,Lm_GroupId,Lm_Address,Lm_Description,Lm_IsActive,Lm_IsStockAffected,Lm_PhoneNo,Lm_PanNo,
									Lm_GstNo,Lm_OpeningBalance,Lm_TaxPer,Lm_TaxMethod,Lm_OpeningDate,Lm_OpeningDrCr,Lm_PVId) 
					VALUES
									(@Lm_Id,@Lm_Name,@Lm_GroupId,@Lm_Address,@Lm_Description,@Lm_IsActive,@Lm_IsStockAffected,
									@Lm_PhoneNo,@Lm_PanNo,@Lm_GstNo,@Lm_OpeningBalance,@Lm_TaxPer,@Lm_TaxMethod,@Lm_OpeningDate,@Lm_OpeningDrCr,@Lm_PVId);
					UPDATE		PatientMaster
					SET			Pm_Ledger_Id = @Lm_Id
					WHERE		Pm_Id = @Lm_PVId
				END
			ELSE
				BEGiN
					SELECT	@Lm_Id=Lm_Id
					FROM	LedgerMaster A
					WHERE	A.Lm_PVId=@Lm_PVId
							AND A.Lm_GroupId=46
				    DECLARE @LStoreCode VARCHAR(20) 
					SET @LStoreCode=(SELECT StoreCode FROM PatientMaster WHERE Pm_Id=@Lm_PVId)

					UPDATE	LedgerMaster
					SET		Lm_Name=@Lm_Name,
							Lm_Address=@Lm_Address
					WHERE	Lm_Id=@Lm_Id
				END
		END

	ELSE IF @Result = 'DublicateCount'
		BEGIN
			SELECT		COUNT(*) CountOf
			FROM		LedgerMaster(NOLOCK)
			WHERE		Lm_Name = @Lm_Name
					AND	Lm_GroupId = @Lm_GroupId
					AND Lm_Id <> @Lm_Id
		END

	ELSE IF @Result = 'Update'
	BEGIN
	UPDATE		LedgerMaster
	SET			Lm_Name = @Lm_Name,
				Lm_GroupId = @Lm_GroupId,
				Lm_Address = @Lm_Address,
				Lm_Description = @Lm_Description,
				Lm_IsActive = @Lm_IsActive,
				Lm_IsStockAffected = @Lm_IsStockAffected,
				Lm_PhoneNo = @Lm_PhoneNo,
				Lm_PanNo = @Lm_PanNo,
				Lm_GstNo = @Lm_GstNo,
				Lm_OpeningBalance = @Lm_OpeningBalance,
				Lm_TaxPer = @Lm_TaxPer,
				Lm_TaxMethod = @Lm_TaxMethod,
				Lm_OpeningDate = @Lm_OpeningDate,
				Lm_OpeningDrCr = @Lm_OpeningDrCr
	WHERE		Lm_Id = @Lm_Id
	END

	ELSE IF @Result = 'UpdateLedgerName'
		BEGIN
			UPDATE		LedgerMaster
			SET			Lm_Name = @Lm_Name
			WHERE		Lm_Id = @Lm_Id
		END

	IF @Result = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'LedgerMaster',@Lm_Id,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE 
				BEGIN
					DELETE 
					FROM		LedgerMaster
					WHERE		Lm_Id = @Lm_Id

					UPDATE		PatientMaster
					SET			Pm_Ledger_Id = 0
					WHERE		Pm_Ledger_Id = @Lm_Id

					UPDATE		VendorMaster
					SET			Vendor_Ledger_id = 0
					WHERE		Vendor_Ledger_id = @Lm_Id

				END
		END

	ELSE IF @Result = 'FillGrid'
		BEGIN
			SELECT		lm.Lm_Id,lm.Lm_Name,lm.Lm_GroupId,lm.Lm_PVId,lm.Lm_Address,lm.Lm_PhoneNo,
						lm.Lm_PanNo,lm.Lm_GstNo,lm.Lm_OpeningBalance,lm.Lm_Description,lm.Lm_IsStockAffected,lm.Lm_TaxPer,lm.Lm_TaxMethod,
						Lm.Lm_OpeningDate,lm.LM_IsSysGen,CASE WHEN lm.Lm_IsActive = 1 THEN 'Yes'ELSE 'No'END			AS IsActive,lm.Lm_OpeningDrCr,lg.Lgm_Name	AS GroupName
			FROM		LedgerMaster(NOLOCK) lm
					LEFT JOIN LedgerGroupMaster lg
			ON			lg.Lgm_Id = lm.Lm_GroupId
			ORDER BY	Lm_Name;
		END

	ELSE IF @Result = 'FillLedgerGroup'
		BEGIN
			SELECT		0	AS Lgm_Id,
						'--Select--'	AS Lgm_Name
			UNION
			SELECT		Lgm_Id,
						Lgm_Name
			FROM		LedgerGroupMaster(NOLOCK)
			WHERE		Lgm_IsActive = 1
		END
		
	ELSE IF @Result = 'Retrive'--Get
		BEGIN
			SELECT *
			FROM		LedgerMaster(NOLOCK)
			WHERE		Lm_Id = @Lm_Id
		END

	ELSE IF @Result = 'GetBook'
		BEGIN
			DECLARE		@IsRegisterd bit = 0
			DECLARE		@IsUnderCompositeScheme bit = 0
			SELECT		@IsRegisterd = Store_GstRegisted,
						@IsUnderCompositeScheme=Store_UnderCompositeScheme
			FROM		dbo.StoreMaster sm
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK)
			WHERE		Lm_GroupId = @Lm_GroupId
					AND Lm_IsActive = 1
					AND dbo.LedgerMaster.Lm_Id <>
													CASE
													WHEN @IsRegisterd = 0  THEN 3
													ELSE CASE
														 WHEN @IsRegisterd=1 AND @IsUnderCompositeScheme=1 THEN 3
														 ELSE 0
														 END
													END;
													

		END

	ELSE IF @Result = 'CheckLedger'
		BEGIN
			SELECT *
			FROM		LedgerMaster(NOLOCK)
			WHERE		Lm_Name = @Lm_Name
		END

	ELSE IF @Result = 'BindCashAccount'
		SELECT		Lm_Id,Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 44
				AND Lm_IsActive = 1;

	IF @Result = 'BindBankAccount'
		SELECT		Lm_Id,Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 45
				AND Lm_IsActive = 1;

	IF @Result = 'BindCreditAccount'
		SELECT		Lm_Id,Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 51
				AND Lm_IsActive = 1;

	IF @Result = 'BindDebitAccount'
		SELECT		Lm_Id,
					Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 50
				AND Lm_IsActive = 1;

	IF @Result = 'BindLedgerHead'
		SELECT		0						AS Lgm_Id,
					'--Select All--'	AS Lgm_Name
		UNION
		SELECT		Lgm_Id,
					Lgm_Name
		FROM		LedgerGroupMaster(NOLOCK)
		WHERE		Lgm_IsActive = 1;


	IF @Result = 'BindDebitNoteAccount'
		SELECT		Lm_Id,
					Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 50
				AND Lm_IsActive = 1;

	IF @Result = 'BindCreditNoteAccount'
		SELECT		Lm_Id,Lm_Name
		FROM		LedgerMaster(NOLOCK)
		WHERE		Lm_GroupId = 51
				AND Lm_IsActive = 1;

	IF @Result = 'GetOpeningBalance'
		IF @Lm_GroupId > 0
			SELECT		Lm_Id,Lm_Name,ISNULL(Lm_OpeningBalance,0) AS Lm_OpeningBalance,Lm_OpeningDrCr,BM.Branch_Name,
						(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,''))	AS Branch_Address,
						BM.Branch_GstNo
			FROM		LedgerMaster(NOLOCK)
					LEFT JOIN BranchMaster(NOLOCK) BM
			ON			BM.Branch_Id = 1
			WHERE		Lm_GroupId = @Lm_GroupId

		ELSE		SELECT		Lm_Id,Lm_Name,ISNULL(Lm_OpeningBalance,0) AS Lm_OpeningBalance,Lm_OpeningDrCr,BM.Branch_Name,
						(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,''))	AS Branch_Address,BM.Branch_GstNo
					FROM		LedgerMaster(NOLOCK)
							LEFT JOIN BranchMaster(NOLOCK) BM
					ON			BM.Branch_Id = 1

	END
GO
/****** Object:  StoredProcedure [dbo].[SP_LedgerGroup]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_LedgerGroup] @Result nvarchar(100) = '',
		@Lgm_Id int = 0,
		@Lgm_Name nvarchar(100) = '',
		@Lgm_ParentId int = 0,
		@Lgm_GroupType nvarchar(50) = '',
		@Lgm_Description nvarchar(max) = '',
		@Lgm_IsProfit bit = 0,
		@Lgm_IsActive bit = 0,
		@Lgm_IsSysGen bit = 0
AS
BEGIN
	IF @Result = 'Insert'
		BEGIN
			SELECT		@Lgm_Id = ISNULL(MAX(Lgm_Id),0) + 1
			FROM		LedgerGroupMaster(nolock);

			INSERT INTO		LedgerGroupMaster
							(Lgm_Id,Lgm_Name,Lgm_ParentId,Lgm_GroupType,Lgm_Description,Lgm_IsProfit,Lgm_IsActive,Lgm_IsSysGen) 
			VALUES			(@Lgm_Id,@Lgm_Name,@Lgm_ParentId,@Lgm_GroupType,@Lgm_Description,@Lgm_IsProfit,@Lgm_IsActive,@Lgm_IsSysGen);
		END

	ELSE IF @Result = 'DublicateCount'
		BEGIN
			SELECT		COUNT(*) CountOf
			FROM		LedgerGroupMaster(NOLOCK)
			WHERE		Lgm_Name = @Lgm_Name
					AND Lgm_ParentId = @Lgm_ParentId
					AND Lgm_Id <> @Lgm_Id
		END

	ELSE IF @Result = 'Update'
		BEGIN
			UPDATE		LedgerGroupMaster
			SET			Lgm_Name = @Lgm_Name,
						Lgm_ParentId = @Lgm_ParentId,
						Lgm_GroupType = @Lgm_GroupType,
						Lgm_Description = @Lgm_Description,
						Lgm_IsProfit = @Lgm_IsProfit,
						Lgm_IsActive = @Lgm_IsActive,
						Lgm_IsSysGen = @Lgm_IsSysGen
			WHERE		Lgm_Id = @Lgm_Id
		END

	ELSE IF @Result = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'LedgerGroupMaster',@Lgm_Id,@MSG_OUT OUTPUT

			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE 
				BEGIN
					DELETE 
					FROM		LedgerGroupMaster
					WHERE		Lgm_Id = @Lgm_Id


					update		LedgerMaster
					set			Lm_GroupId=0		 
					where		Lm_GroupId=@Lgm_Id
				END
		END

	ELSE IF @Result = 'FillGrid'
		BEGIN
			SELECT		lg.Lgm_Id,lg.Lgm_Name,lg.Lgm_ParentId,lg.Lgm_GroupType,lg.Lgm_IsActive,
						CASE
							WHEN lg.Lgm_ParentId = 1 THEN 'Trading A/C'
							WHEN lg.Lgm_ParentId = 2 THEN 'Profit & Loss A/C'
							WHEN lg.Lgm_ParentId = 3 THEN 'Balance Sheet'
							ELSE ISNULL(lg1.Lgm_Name,'')
						END	AS ParentName,
						lg.Lgm_IsProfit,lg.Lgm_Description,lg.Lgm_IsSysGen
			FROM		LedgerGroupMaster(NOLOCK) lg
					LEFT JOIN LedgerGroupMaster(NOLOCK) lg1
			ON			lg.Lgm_ParentId = lg1.Lgm_Id
			ORDER BY	Lgm_Name;
		END

	ELSE IF @Result = 'FillParentGroup'
		BEGIN
			SELECT		0	AS Lgm_Id,
						'--Select--'	AS Lgm_Name
			UNION
			SELECT		A.Lgm_Id,
						A.Lgm_Name + ' - ' + CASE
							WHEN A.Lgm_ParentId = 1 THEN 'Trading A/C'
							WHEN A.Lgm_ParentId = 2 THEN 'Profit & Loss A/C'
							WHEN A.Lgm_ParentId = 3 THEN 'Balance Sheet'
							ELSE ISNULL(B.Lgm_Name,'')
						END	AS Lgm_Name
			FROM		LedgerGroupMaster(NOLOCK) A
					LEFT JOIN LedgerGroupMaster(NOLOCK) B
			ON			A.Lgm_ParentId = B.Lgm_Id
		END

	ELSE IF @Result = 'Retrive'
		BEGIN
			SELECT	 *
			FROM		LedgerGroupMaster(NOLOCK)
			WHERE		Lgm_Id = @Lgm_Id
		END

	ELSE IF @Result = 'GetBook'
		BEGIN
			SELECT		Lgm_Id,Lgm_Name
			FROM		LedgerGroupMaster(NOLOCK)
			WHERE		Lgm_ParentId = @Lgm_ParentId
					AND Lgm_IsActive = 1;
		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_LocationMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_LocationMaster] @SP_STATUS varchar(200),
		@Lm_Id int = 0,
		@Lm_Code varchar(200) = NULL,
		@Lm_Name varchar(500) = NULL,
		@Lm_LmId int = 0,
		@Lm_IsActive bit = 0,
		@Lm_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			IF EXISTS (SELECT
				*
				FROM tempdb.sys.tables
				WHERE NAME = '##TEMP_LOCATION_MASTER'
				AND type = 'U')
				BEGIN
				DROP TABLE ##TEMP_LOCATION_MASTER
				END
			SELECT COUNT(*) CountOf INTO ##TEMP_LOCATION_MASTER
			FROM LocationMaster(NOLOCK) A
			WHERE (Lm_Name = @Lm_Name
			OR Lm_Code = @Lm_Code)
			AND Lm_LmId = @Lm_LmId
			AND Lm_Id <> @Lm_Id
			UNION ALL
			SELECT COUNT(*) CountOf
			FROM LocationMaster(NOLOCK) A
			WHERE (Lm_Name = @Lm_Name
			OR Lm_Code = @Lm_Code)
			AND Lm_Id <> @Lm_Id;
			SELECT SUM(CountOf) AS CountOf
			FROM ##TEMP_LOCATION_MASTER
		
		END;

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT @Lm_Id = ISNULL(MAX(Lm_Id),0) + 1
			FROM LocationMaster(NOLOCK);
			INSERT INTO [dbo].[LocationMaster]([Lm_Id],
			[Lm_Code],
			[Lm_Name],
			[Lm_LmId],
			[Lm_CreatedBy],
			[Lm_CreatedDt],
			[Lm_IsActive]) VALUES
			(@Lm_Id,@Lm_Code,@Lm_Name,@Lm_LmId,@Lm_User,GETDATE(),@Lm_IsActive);
		END;

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			DECLARE @MSG_OUT_Update nvarchar(max)
			EXEC SP_Tbl_Dependency	'LocationMaster',@Lm_Id,@MSG_OUT_Update OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_Update)) <> '')
				BEGIN
					UPDATE		[dbo].[LocationMaster]
					SET			[Lm_Code] = @Lm_Code,
								[Lm_Name] = @Lm_Name,
								[Lm_LmId] = @Lm_LmId,
								[Lm_UpdatedBy] = @Lm_User,
								[Lm_UpdatedDt] = GETDATE()
					WHERE		[Lm_Id] IN (@Lm_Id)
					RAISERROR ('But You Can''t Change Parent and Status.',14,9)
				END
			ELSE BEGIN

				DECLARE @cont int = 0

				SELECT		@cont = COUNT(Lm_LmId)
				FROM		LocationMaster
				WHERE		Lm_LmId = @Lm_Id

				IF @cont > 0
					BEGIN
						UPDATE		[dbo].[LocationMaster]
						SET			[Lm_Code] = @Lm_Code,
									[Lm_Name] = @Lm_Name,
									[Lm_LmId] = @Lm_LmId,
									[Lm_UpdatedBy] = @Lm_User,
									[Lm_UpdatedDt] = GETDATE()
						WHERE		[Lm_Id] IN (@Lm_Id)
						RAISERROR ('But You Can''t Change Parent and Status.',14,9)
					END
				ELSE 
					UPDATE		[dbo].[LocationMaster]
					SET			[Lm_Code] = @Lm_Code,
								[Lm_Name] = @Lm_Name,
								[Lm_LmId] = @Lm_LmId,
								[Lm_UpdatedBy] = @Lm_User,
								[Lm_UpdatedDt] = GETDATE(),
								[Lm_IsActive] = @Lm_IsActive
					WHERE		[Lm_Id] = @Lm_Id;
				END

		END;

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'LocationMaster',@Lm_Id,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE 
			BEGIN
				DECLARE @cont1 int = 0
					SELECT		@cont1 = COUNT(Lm_LmId)
					FROM		LocationMaster
					WHERE		Lm_LmId = @Lm_Id
					IF @cont1 > 0
						RAISERROR ('This location is other location''s parent. so can''t delete it. .',14,9)
					ELSE 
						DELETE  FROM LocationMaster
						WHERE   Lm_Id = @Lm_Id;
			END
		END;

	ELSE IF @SP_STATUS = 'DeleteCount'
		BEGIN
			SELECT	*
			FROM		LocationMaster(NOLOCK)
			WHERE		[Lm_Id] = @Lm_Id;
		END;

	ELSE IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT		LM.Lm_Id,LM.Lm_Code,LM.Lm_Name,ISNULL(LTM.Lm_Id,0)	AS Lm_Id,LM.Lm_CreatedBy,LM.Lm_CreatedDt,LM.Lm_UpdatedBy,LM.Lm_UpdatedDt,
						CASE
							WHEN LM.Lm_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END	AS Lm_IsActive,
						C.User_Name	AS [USER],ISNULL(LTM.Lm_Id,0)	AS PLm_Id,LTM.Lm_Code	AS PLm_Code,LTM.Lm_Name AS PLm_Name
			FROM		LocationMaster AS LM (NOLOCK)
					LEFT JOIN dbo.UserMaster(NOLOCK) C
			ON			LM.Lm_CreatedBy = C.User_ID
					LEFT JOIN LocationMaster(NOLOCK) LTM
			ON			LM.Lm_LmId = LTM.Lm_Id;
		END;

	IF @SP_STATUS = 'FillHelp'
		BEGIN
			SELECT		Lm_Id AS hc_Lm_Id,Lm_Code AS hc_Lm_Code,Lm_Name	AS hc_Lm_Name
			FROM		LocationMaster(NOLOCK)
			WHERE		Lm_IsActive = 1;
		END;

	ELSE IF @SP_STATUS = 'LocationMasterFillHelp'
		BEGIN
			SELECT		Lm_Id AS hc_LTM_Id,Lm_Code AS hc_LTM_Code,Lm_Name AS hc_LTM_Name
			FROM		LocationMaster(NOLOCK)
			WHERE		Lm_IsActive = 1;
		END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_LocationTypeMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- [dbo].[SP_LocationTypeMaster] @SP_STATUS = 'DublicateCount', @Ltm_Name = 'Vadodara', @Ltm_Code = 'BRC', @Ltm_LtmId = 1
-- =============================================
CREATE PROCEDURE [dbo].[SP_LocationTypeMaster] @SP_STATUS varchar(200),
@Ltm_Id int = 0,
@Ltm_Code varchar(200) = NULL,
@Ltm_Name varchar(500) = NULL,
@Ltm_LtmId int = 0,
@Ltm_IsActive bit = 0,
@Ltm_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			WITH c
					AS (SELECT		COUNT(*) CountOf
					FROM			LocationTypeMaster
					WHERE			Ltm_Code = @Ltm_Code
							AND		Ltm_Id <> @Ltm_Id
					UNION

					SELECT		COUNT(*) CountOf
					FROM		LocationTypeMaster(NOLOCK)
					WHERE		Ltm_Name = @Ltm_Name
							AND Ltm_LtmID = @Ltm_LtmID
							AND Ltm_Id <> @Ltm_Id)
					SELECT		SUM(CountOf) AS CountOf
					FROM		c

		END;
	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Ltm_Id = ISNULL(MAX(Ltm_Id),0) + 1
			FROM		LocationTypeMaster(NOLOCK);
			INSERT INTO		[dbo].[LocationTypeMaster]
							([Ltm_Id],[Ltm_Code],[Ltm_Name],[Ltm_LtmID],[Ltm_CreatedBy],[Ltm_CreatedDt],[Ltm_IsActive]) VALUES
							(@Ltm_Id,@Ltm_Code,@Ltm_Name,@Ltm_LtmId,@Ltm_User,GETDATE(),@Ltm_IsActive);
		END;

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		[dbo].[LocationTypeMaster]
			SET			[Ltm_Code] = @Ltm_Code,
						[Ltm_Name] = @Ltm_Name,
						[Ltm_LtmID] = @Ltm_LtmId,
						[Ltm_UpdatedBy] = @Ltm_User,
						[Ltm_UpdatedDt] = GETDATE(),
						[Ltm_IsActive] = @Ltm_IsActive
			WHERE		[Ltm_Id] = @Ltm_Id;
		END;

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'LocationTypeMaster',
											@Ltm_Id,
											@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE 
				BEGIN
					DELETE 
					FROM		LocationTypeMaster
					WHERE		[Ltm_Id] = @Ltm_Id;
				END
			END

	ELSE IF @SP_STATUS = 'DeleteCount'
		BEGIN
			SELECT *
			FROM		LocationTypeMaster(NOLOCK)
			WHERE		[Ltm_Id] = @Ltm_Id;
		END;

	ELSE IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT		A.Ltm_Id,A.Ltm_Name,A.Ltm_Code,A.Ltm_LtmID,A.Ltm_CreatedBy,A.Ltm_CreatedDt,A.Ltm_UpdatedBy,A.Ltm_UpdatedDt,
						CASE
							WHEN A.Ltm_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END	AS Ltm_IsActive,
						C.User_Name	AS [USER],B.Ltm_Code	AS LocCode,B.Ltm_Name	AS LocName
			FROM		LocationTypeMaster AS A (NOLOCK)
					LEFT JOIN dbo.UserMaster C (NOLOCK)
			ON			A.Ltm_CreatedBy = C.User_ID
					LEFT JOIN LocationTypeMaster B (NOLOCK)
			ON			B.Ltm_Id = A.Ltm_LtmID;
		END;
		
	ELSE IF @SP_STATUS = 'FillHelp'
		BEGIN
			SELECT		Ltm_Id	AS LTM_LtmID,
						Ltm_Code	AS LocCode,
						Ltm_Name	AS LocName
			FROM		LocationTypeMaster(NOLOCK);
		END;

	ELSE IF @SP_STATUS = 'LocationMasterFillHelp'
		BEGIN
			SELECT		Ltm_Id	AS hc_LTM_Id,
						Ltm_Code	AS hc_LTM_Code,
						Ltm_Name	AS hc_LTM_Name
			FROM		LocationTypeMaster(NOLOCK)
			WHERE		Ltm_IsActive = 1;
		END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_MANAGE_MENU]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_MANAGE_MENU] @SP_STATUS varchar(250) = ''
AS
BEGIN
	IF @SP_STATUS = 'GET_MENU'
	BEGIN
	SELECT	A.Menu_ID							AS M_ID,
				A.Menu_Name							AS M_NAME,
				ISNULL(A.Menu_FormName,'')		AS M_FORM_NAME,
				A.Menu_ParentId					AS M_PARENT_ID,
				A.Menu_IsActive					AS M_IS_ACTIVE,
				ISNULL(A.Menu_Icon,'')			AS M_ICON,
				ISNULL(A.Menu_IsOpenFlMode,0)	AS M_IS_OPEN_FL_MODE,
				A.Menu_Prifix						AS M_PRIFIX,
				A.Menu_Type
	FROM MenuMaster A (NOLOCK)
	WHERE A.Menu_IsActive = 1
	--AND ISNULL(Menu_FormName,'')<>''
	ORDER BY A.Menu_Order
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_MedicineBrandMater]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_MedicineBrandMater] @SP_STATUS varchar(200),
@MBM_ID int = 0,
@MBM_MmId int = 0,
@MBM_BmId int = 0
AS
BEGIN
	IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @MBM_ID = ISNULL(MAX(MBM_ID),0) + 1
	FROM MedicineBrandMater(NOLOCK);
	INSERT INTO [dbo].[MedicineBrandMater]([MBM_ID],
	[MBM_MmId],
	MBM_BmId) VALUES
	(@MBM_ID,@MBM_MmId,@MBM_BmId);
	END;
	ELSE IF @SP_STATUS = 'Delete'
	--BEGIN
	--  DELETE FROM MedicineBrandMater
	--  WHERE MBM_MmId = @MBM_MmId;
	--END;
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'MedicineBrandMater',
									@MBM_MmId,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		DELETE FROM MedicineBrandMater
		WHERE MBM_MmId = @MBM_MmId;
		END
	END
	ELSE IF @SP_STATUS = 'Fillgrid'
	BEGIN
	SELECT	MBM.MBM_ID,
				MBM.MBM_MmId,
				MBM.MBM_BmId,
				BM.BM_Code	AS MBM_BmCode,
				BM.BM_Name	AS MBM_BmName
	FROM MedicineBrandMater AS MBM (NOLOCK)
	LEFT JOIN BrandMater BM (NOLOCK)
		ON MBM.MBM_BmId = BM.BM_ID
	WHERE MBM_MmId = @MBM_MmId;
	END;
--ELSE IF @SP_STATUS='FillCombo'
--	BEGIN
--	--select BM_ID,BM_Code from BrandMater where BM_IsActive=1;
--	end
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_MedicineCategoryMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_MedicineCategoryMaster] @SP_STATUS varchar(200),
@Mcm_ID int = 0,
@Mcm_Code varchar(200) = NULL,
@Mcm_Name varchar(500) = NULL,
@Mcm_IsActive bit = 0,
@Mcm_User int = 0,
@Mcm_SyncDt datetime = NULL
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
	BEGIN
	SELECT COUNT(*) CountOf
	FROM MedicineCategoryMaster(NOLOCK)
	WHERE (
	Mcm_Code = @Mcm_Code
	OR Mcm_Name = @Mcm_Name
	)
	AND Mcm_ID <> @Mcm_ID;
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Mcm_ID = ISNULL(MAX(Mcm_ID),0) + 1
	FROM MedicineCategoryMaster(NOLOCK);
	INSERT INTO [dbo].[MedicineCategoryMaster](Mcm_ID,
	[Mcm_Code],
	[Mcm_Name],
	[Mcm_CreatedBy],
	[Mcm_CreatedDt],
	[Mcm_IsActive]) VALUES
	(@Mcm_ID,@Mcm_Code,@Mcm_Name,@Mcm_User,GETDATE(),@Mcm_IsActive);
	END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
	UPDATE [dbo].[MedicineCategoryMaster]
	SET	[Mcm_Code] = @Mcm_Code,
			[Mcm_Name] = @Mcm_Name,
			[Mcm_UpdatedBy] = @Mcm_User,
			[Mcm_UpdatedDt] = GETDATE(),
			[Mcm_IsActive] = @Mcm_IsActive
	WHERE Mcm_ID = @Mcm_ID;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'MedicineCategoryMaster',
									@Mcm_ID,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		DELETE FROM MedicineCategoryMaster
		WHERE Mcm_ID = @Mcm_ID;
		END
	END
	ELSE IF @SP_STATUS = 'Fillgrid'
	BEGIN
	SELECT	MCM.Mcm_ID,
				MCM.Mcm_Code,
				MCM.Mcm_Name,
				MCM.Mcm_CreatedBy,
				MCM.Mcm_CreatedDt,
				MCM.Mcm_UpdatedBy,
				MCM.Mcm_UpdatedDt,
				--MCM.Mcm_IsActive,
				CASE
					WHEN MCM.Mcm_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END			AS Mcm_IsActive,
				MCM.Mcm_IsSysGen,
				MCM.Mcm_IsSync,
				MCM.Mcm_SyncDt,
				C.User_Name	AS Mcm_User
	FROM MedicineCategoryMaster AS MCM (NOLOCK)
	LEFT JOIN dbo.UserMaster C (NOLOCK)
		ON MCM.Mcm_CreatedBy = C.User_ID;
	END;
	ELSE IF @SP_STATUS = 'FillHelp'
	BEGIN
	SELECT	Mcm_ID	AS hc_Mcm_ID,
				Mcm_Code	AS hc_Mcm_Code,
				Mcm_Name	AS hc_Mcm_Name
	FROM MedicineCategoryMaster(NOLOCK)
	WHERE Mcm_IsActive = 1;
	END;
	--***======================================For Sync cPOS=============================================================***
	ELSE IF @SP_STATUS = 'Sync_InsertUpdate'
	BEGIN
	IF NOT EXISTS (SELECT
		*
		FROM MedicineCategoryMaster(NOLOCK)
		WHERE Mcm_Code = @Mcm_Code
		AND Mcm_SyncDt = @Mcm_SyncDt)
		BEGIN
		SELECT @Mcm_ID = Mcm_ID
		FROM MedicineCategoryMaster(NOLOCK)
		WHERE Mcm_Code = @Mcm_Code
		IF (@Mcm_ID = 0)
		BEGIN
			SELECT @Mcm_ID = ISNULL(MAX(Mcm_ID),0) + 1
			FROM MedicineCategoryMaster(NOLOCK);
			INSERT INTO MedicineCategoryMaster(Mcm_ID,Mcm_Code,Mcm_Name,Mcm_IsActive,Mcm_CreatedBy,Mcm_CreatedDt,Mcm_IsSync,Mcm_SyncDt) VALUES
			(@Mcm_ID,@Mcm_Code,@Mcm_Name,@Mcm_IsActive,@Mcm_User,GETDATE(),1,@Mcm_SyncDt);
		END
		ELSE BEGIN
			UPDATE MedicineCategoryMaster
			SET	Mcm_Code = @Mcm_Code,
					Mcm_Name = @Mcm_Name,
					Mcm_IsActive = @Mcm_IsActive,
					Mcm_UpdatedBy = @Mcm_User,
					Mcm_UpdatedDt = GETDATE(),
					Mcm_IsSync = 1,
					Mcm_SyncDt = @Mcm_SyncDt
			WHERE Mcm_ID = @Mcm_ID
		END
		END
	END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_MedicineGroupMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    Vishal
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_MedicineGroupMaster] @SP_STATUS varchar(200),
@Mgm_ID int = 0,
@Mgm_Code varchar(30) = NULL,
@Mgm_Name varchar(250) = NULL,
@Mgm_ParentId int = 0,
@Mgm_IsActive int = 0,
@Mgm_User int = 0,
@Mgm_SyncDt datetime = NULL
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
	BEGIN
	IF EXISTS (SELECT
		*
		FROM tempdb.sys.tables
		WHERE NAME = '##TEMP_MGROUP_MASTER'
		AND type = 'U')
		BEGIN
		DROP TABLE ##TEMP_MGROUP_MASTER
		END
	SELECT COUNT(*) CountOf INTO ##TEMP_MGROUP_MASTER
	FROM MedicineGroupMaster(NOLOCK)
	WHERE (
	Mgm_Code = @Mgm_Code
	OR Mgm_Name = @Mgm_Name
	AND Mgm_ParentId = @Mgm_ParentId
	)
	AND Mgm_ID <> @Mgm_ID
	UNION ALL
	SELECT COUNT(*) CountOf
	FROM MedicineGroupMaster(NOLOCK)
	WHERE (
	Mgm_Code = @Mgm_Code
	OR Mgm_Name = @Mgm_Name
	)
	AND Mgm_ID <> @Mgm_ID
	SELECT SUM(CountOf) AS CountOf
	FROM ##TEMP_MGROUP_MASTER
	--;with c as (
	--			select COUNT(*) CountOf from MedicineGroupMaster where Mgm_Code <> @Mgm_Code  and (Mgm_ID <> @Mgm_ID)
	--		union
	--			select COUNT(*) CountOf from MedicineGroupMaster where Mgm_Name = Mgm_Name AND Mgm_ParentId = @Mgm_ParentId and (Mgm_ID <> @Mgm_ID))
	--		select sum(CountOf) as CountOf from  c
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Mgm_ID = ISNULL(MAX(Mgm_ID),0) + 1
	FROM MedicineGroupMaster(NOLOCK);
	INSERT INTO [dbo].[MedicineGroupMaster]([Mgm_ID],
	[Mgm_Code],
	[Mgm_Name],
	[Mgm_ParentId],
	[Mgm_CreatedBy],
	[Mgm_CreatedDt],
	[Mgm_IsActive]) VALUES
	(@Mgm_ID,@Mgm_Code,@Mgm_Name,@Mgm_ParentId,@Mgm_User,GETDATE(),@Mgm_IsActive);
	END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
	UPDATE [dbo].[MedicineGroupMaster]
	SET	Mgm_Code = @Mgm_Code,
			Mgm_Name = @Mgm_Name,
			Mgm_ParentId = @Mgm_ParentId,
			Mgm_UpdatedBy = @Mgm_User,
			Mgm_UpdatedDt = GETDATE(),
			Mgm_IsActive = @Mgm_IsActive
	WHERE Mgm_ID = @Mgm_ID;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	--BEGIN
	--  DELETE FROM MedicineGroupMaster
	--  WHERE Mgm_ID = @Mgm_ID;
	--END;
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'MedicineGroupMaster',
									@Mgm_ID,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		DELETE FROM MedicineGroupMaster
		WHERE Mgm_ID = @Mgm_ID;
		END
	END
	ELSE IF @SP_STATUS = 'Fillgrid'
	BEGIN
	SELECT	mgm.Mgm_ID,
				mgm.Mgm_Code,
				mgm.Mgm_Name,
				mgm.Mgm_ParentId,
				mgm.Mgm_CreatedBy,
				mgm.Mgm_CreatedDt,
				mgm.Mgm_UpdatedBy,
				mgm.Mgm_UpdatedDt,
				--mgm.Mgm_IsActive,
				CASE
					WHEN mgm.Mgm_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END					AS Mgm_IsActive,
				mgm.Mgm_IsSysGen,
				mgm.Mgm_IsSync,
				mgm.Mgm_SyncDt,
				C.User_Name			AS Mgm_User,
				mgmNew.Mgm_Code	AS Mgm_ParentCode,
				mgmNew.Mgm_Name	AS Mgm_ParentName
	FROM MedicineGroupMaster AS mgm (NOLOCK)
	LEFT JOIN dbo.UserMaster C (NOLOCK)
		ON mgm.Mgm_CreatedBy = C.User_ID
	LEFT JOIN MedicineGroupMaster mgmNew (NOLOCK)
		ON mgm.Mgm_ParentId = mgmNew.Mgm_ID;
	END;
	ELSE IF @SP_STATUS = 'FillHelp'
	BEGIN
	SELECT	Mgm_ID	AS hc_Mgm_ID,
				Mgm_Code	AS hc_Mgm_Code,
				Mgm_Name	AS hc_Mgm_Name
	FROM MedicineGroupMaster(NOLOCK)
	WHERE Mgm_IsActive = 1;
	END;
	--***======================================For Sync cPOS=============================================================***
	ELSE IF @SP_STATUS = 'Sync_InsertUpdate'
	BEGIN
	IF NOT EXISTS (SELECT
		*
		FROM MedicineGroupMaster(NOLOCK)
		WHERE Mgm_Code = @Mgm_Code
		AND @Mgm_SyncDt = @Mgm_SyncDt)
		BEGIN
		SELECT @Mgm_ID = Mgm_ID
		FROM MedicineGroupMaster(NOLOCK)
		WHERE Mgm_Code = @Mgm_Code
		IF (@Mgm_ID = 0)
		BEGIN
			SELECT @Mgm_ID = ISNULL(MAX(Mgm_ID),0) + 1
			FROM MedicineGroupMaster(NOLOCK);
			INSERT INTO MedicineGroupMaster(Mgm_ID,Mgm_Code,Mgm_Name,Mgm_IsActive,Mgm_CreatedBy,Mgm_CreatedDt,Mgm_IsSync,Mgm_SyncDt) VALUES
			(@Mgm_ID,@Mgm_Code,@Mgm_Name,@Mgm_IsActive,@Mgm_User,GETDATE(),1,@Mgm_SyncDt);
		END
		ELSE BEGIN
			UPDATE MedicineGroupMaster
			SET	Mgm_Code = @Mgm_Code,
					Mgm_Name = @Mgm_Name,
					Mgm_IsActive = @Mgm_IsActive,
					Mgm_UpdatedBy = @Mgm_User,
					Mgm_UpdatedDt = GETDATE(),
					Mgm_IsSync = 1,
					Mgm_SyncDt = @Mgm_SyncDt
			WHERE Mgm_ID = @Mgm_ID
		END
		END
	END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_MedicineMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[SP_MedicineMaster] @SP_STATUS        VARCHAR(200), 

--@Uom_ID int=0,   
--@Uom_Code VARCHAR(200)=NULL,   
--@Uom_Name VARCHAR(500)=NULL,   
--@Uom_IsActive bit=0,   
--@Uom_User INT=0   
@Mm_ID            NUMERIC(18,0) = 0, 
@Mm_Code          VARCHAR(200) = NULL, 
@Mm_Name          VARCHAR(250) = NULL, 
@Mm_SaltName      VARCHAR(250) = NULL, 
@Mm_SearchKey     VARCHAR(250) = NULL, 
@Mm_HsnCode       VARCHAR(50) = NULL, 
@Mm_MtmId         INT = 0, 
@Mm_MgmId         INT = 0, 
@Mm_McmId         INT = 0, 
@Mm_LmId          INT = 0, 
@Mm_SaleRate      NUMERIC(18, 3) = 0, 
@Mm_PurRate       NUMERIC(18, 3) = 0, 
@Mm_MktRate       NUMERIC(18, 3) = 0, 
@Mm_MRP           NUMERIC(18, 3) = 0, 
@Mm_MaxLevel      NUMERIC(18, 3) = 0, 
@Mm_ReorderLevel  NUMERIC(18, 3) = 0, 
@Mm_MinLevel      NUMERIC(18, 3) = 0, 
@Mm_IsStockable   BIT = 0, 
@Mm_StkUom        INT = 0, 
@Mm_IsInventory   BIT = 0, 
@Mm_Sales         BIT = 0, 
@Mm_MaintainQc    BIT = 0, 
@Mm_FixedAsset    BIT = 0, 
@Mm_MaintainExp   BIT = 0, 
@Mm_LeadTime      INT = 0, 
@Mm_IsActive      BIT = 0, 
@Mm_SapCode       VARCHAR(50) = '', 
@MM_PackSize      VARCHAR(50) = '', 

--@Mm_BarCode   
@Mm_User          INT = 0, 
@ID               NUMERIC(18,0) = 0 out, 

----Medicine wise tax detail   
@Mtm_Id           NUMERIC(18,0) = 0, 
@Mtm_MmId         NUMERIC(18,0) = 0, 
@Mtm_TaxId        BIGINT = 0, 
@Mtm_TaxValue     NUMERIC(18, 3) = 0, 
@MedicineIdstr    VARCHAR(max) = '', 
@Store_Code       VARCHAR(15) = '', 
@MM_UPDATED_DATE  DATETIME = NULL, 
@MM_PurchaseUom   NUMERIC(18, 2) = 0, 
@MM_PurchaseRatio NUMERIC(18, 2) = 0, 
@MM_SalesRatio    NUMERIC(18, 2) = 0, 
@MM_MarketingBy   VARCHAR(max) = NULL, 
@MM_ManufactureBy VARCHAR(max) = NULL, 
@MedSalesUOM      VARCHAR(500) = '', 
@MedPurchaseUOM   VARCHAR(500) = '', 
@MedCategory      VARCHAR(500) = '', 
@MedCategoryCode  VARCHAR(500) = '', 
@MedGroup         VARCHAR(500) = '', 
@MedGroupCode     VARCHAR(500) = '',

@Mm_Primary_Size	varchar(50)='',
@Mm_Second_Size		varchar(100)='',
@Mm_Tertairy_Size	varchar(100)='',
@Mm_Schedule		varchar(50)=''
AS 
  BEGIN 
	IF @SP_STATUS = 'DublicateCount' 
		BEGIN 
            SELECT Count(*) CountOf 
            FROM   medicinemaster(nolock) 
            WHERE  ( mm_code = @Mm_Code 
                      OR mm_name = @Mm_Name ) 
                   AND mm_id <> @Mm_ID; 
        END; 
      --IF @SP_STATUS = 'FillTree'   
      --  BEGIN   
      --    --WITH ABC   
      --    --AS (SELECT   
      --    --  Lm_Id AS id,   
      --    --  ltm.Ltm_Id,   
      --    --  Lm_Name AS name,   
      --    --  ltm.Lm_LmId AS ParentID   
      --    --FROM LocationMaster lm   
      --    --INNER JOIN LocationMaster ltm   
      --    --  ON lm.Lm_LmId = ltm.Lm_Id)   
      --    --SELECT Id,   
      --    --       CASE   
      --    --         WHEN ParentID = 0 THEN Lm_Id * -1   
      --    --         ELSE Parentid   
      --    --       END AS Parentid,   
      --    --       Name,   
      --    --       ABC.ParentID   
      --    --FROM ABC   
      -- --WITH Emp_CTE (id, ParentID, name,Lm_LmId)   
      -- --AS (   
      -- -- SELECT A.Lm_Id, Lm_LmId, A.Lm_Name,IWM_WAREHOUSE_ID   
      -- -- FROM ITEM_WAREHOUSE_MASTER as A   
      -- -- WHERE Lm_LmId=0   
      -- -- UNION ALL   
      -- -- SELECT e.Lm_Id, e.Lm_LmId, e.Lm_Name,e.IWM_WAREHOUSE_ID   
      -- -- FROM ITEM_WAREHOUSE_MASTER e   
      -- -- INNER JOIN Emp_CTE ecte ON ecte.id = e.Lm_LmId   
      -- -- )   
      -- -- SELECT Id, CASE WHEN ParentID=0 THEN Lm_LmId*-1 ELSE Parentid END AS  Parentid,Name,Lm_LmId   
      -- -- FROM Emp_CTE   
      -- -- UNION ALL   
      -- -- SELECT A.SLM_ID*-1,0,A.SLM_NAME,0   
      -- -- FROM STORE_LOCATION_MASTER A   
      --  END;   
      --ELSE   
      ELSE IF @SP_STATUS = 'GET_PO_DATA' 
        BEGIN 
            DECLARE @ST_CODE VARCHAR(20) = '' 

            SELECT TOP (1) @ST_CODE = A.store_code 
            FROM   storemaster (nolock) A 
            -------------------------------------------   
            SELECT @ST_CODE      AS Po_Store_Code, 
                   A.*, 
                   B.vendor_code AS Po_Ven_Code 
            FROM   poheader (nolock) AS A 
                   INNER JOIN vendormaster (nolock) AS B 
                           ON A.po_venid = B.vendor_id 
            WHERE  A.po_approvestatus = 'Approve' 
                   AND A.po_issync = 'false' 
                   ---Synch Not Done List Access Only--Add Hasmukh   
                   --AND  B.Vendor_ID=1---Only Bppi Po synch---Add Hasmukh   
                   AND B.vendor_vt_id = 1 
            ---Only Bppi & Distributor Po synch---Add Hasmukh   

            ---------------------------------------------        
            SELECT A.*, 
                   MM.mm_code 
            FROM   poitemdetails (nolock) AS A 
                   INNER JOIN poheader (nolock) AS B 
                           ON A.pi_pokey = B.po_key 
                   INNER JOIN vendormaster (nolock) AS C 
                           ON B.po_venid = C.vendor_id 
                   LEFT JOIN medicinemaster (nolock)AS MM 
                          ON A.pi_itemid = MM.mm_id 
            WHERE  B.po_approvestatus = 'Approve' 
                   AND po_issync = 'false' 
                   ---Synch Not Done List Access Only--Add Hasmukh   
                   --AND B.Po_VenId=1---Only Bppi Po synch---Add Hasmukh   
                   AND C.vendor_vt_id = 1---Only Bppi Po synch---Add Hasmukh   
        END 
      ELSE IF @SP_STATUS = 'GET_PR_DATA' 
        BEGIN 
            DECLARE @PRST_CODE VARCHAR(20) = '' 

            SELECT TOP (1) @PRST_CODE = A.store_code 
            FROM   storemaster (nolock) A 
            -------------------------------------------Header   
            SELECT @PRST_CODE    AS Prh_StoreCode, 
                   A.*, 
                   B.vendor_code AS Po_Ven_Code 
            FROM   purchasereturnheader (nolock) AS A 
                   INNER JOIN vendormaster (nolock) AS B 
                           ON A.prh_vendorid = B.vendor_id 
            WHERE  A.prh_issync = 'false' 
                   ---Synch Not Done List Access Only--Add Hasmukh   
                   AND B.vendor_vt_id = 1 
            ---Only Bppi & Distributor Po synch---Add Hasmukh   

            ---------------------------------------------        
            SELECT A.*, 
                   MM.mm_code 
            FROM   purchasereturndetail (nolock) AS A 
                   INNER JOIN purchasereturnheader (nolock) AS B 
                           ON A.prd_prhid = B.prh_id 
                   INNER JOIN vendormaster (nolock) AS C 
                           ON B.prh_vendorid = C.vendor_id 
                   LEFT JOIN medicinemaster (nolock)AS MM 
                          ON A.prd_mmid = MM.mm_id 
            WHERE  prh_issync = 'false' 
                   ---Synch Not Done List Access Only--Add Hasmukh   
                   AND C.vendor_vt_id = 1---Only Bppi Po synch---Add Hasmukh   
        END 
      ELSE IF @SP_STATUS = 'GET_OPE_DATA' 
        BEGIN 
            SELECT A.*, 
                   (SELECT store_code 
                    FROM   storemaster) AS Ope_Store_Code 
            FROM   openingsalespurchase (nolock) AS A 
            WHERE  Isnull(A.ope_issync, 0) = 0 
        --Select A.*,(Select Store_Code from StoreMaster) as Ope_Store_Code from OpeningSalesPurchase as A   
        --Where ISNULL(A.Ope_IsSync,0)=0   
        END 
      ELSE IF @SP_STATUS = 'Update_Opening' 
        BEGIN 
            UPDATE openingsalespurchase 
            SET    ope_issync = 1 
            WHERE  ope_id = @Mm_ID 
        END 
      ELSE IF @SP_STATUS = 'GET_SI_DATA' 
        BEGIN 
            IF EXISTS(SELECT * 
                      FROM   tempdb.sys.tables 
                      WHERE  NAME = '##TEMP_SALES_DATA' 
                             AND type = 'U') 
              BEGIN 
                  DROP TABLE ##temp_sales_data 
              END 

            SELECT TOP(300) (SELECT Isnull(store_code, '') Store_Code 
                             FROM   dbo.storemaster) AS Sih_Store_Code, 
                            B.storecode              AS Sih_Cust_Code, 
                            sih.* 
            INTO   ##temp_sales_data 
            FROM   dbo.salesinvoiceheader (nolock) sih 
                   LEFT JOIN patientmaster (nolock) B 
                          ON Sih.sih_pm_id = B.pm_id 
            WHERE  sih_issync = 'false' 
            ---Only Synch Pending Record Access---Add Hasmukh   

            SELECT * 
            FROM   ##temp_sales_data 

            SELECT siid.*, 
                   MM.mm_code, 
                   MM.mm_name 
            FROM   dbo.salesinvoiceitemdetail (nolock) siid 
                   LEFT JOIN medicinemaster (nolock) AS MM 
                          ON siid.sid_mm_id = MM.mm_id 
                   INNER JOIN dbo.salesinvoiceheader (nolock) sih 
                           ON sih.sih_key = siid.sid_sih_key 
            WHERE  sih.sih_key IN(SELECT sih_key 
                                  FROM   ##temp_sales_data) 
        --WHERE sih.Sih_IsSync='false'---Only Synch Pending Record Access---Add Hasmukh   
        END 
      ELSE IF @SP_STATUS = 'GET_SR_DATA' 
        BEGIN 
            SELECT (SELECT Isnull(store_code, '') 
                    FROM   dbo.storemaster)AS Srh_StoreCode, 
                   SRH.* 
            FROM   salesreturnheader SRH 
            WHERE  srh_issync = 'false'; ---Add BY Hasmukh 10 10 2018 
            SELECT MM.mm_code, 
                   MM.mm_name, 
                   SRD.* 
            FROM   salesreturndetail SRD 
                   INNER JOIN salesreturnheader SRH 
                           ON SRH.srh_id = SRD.srd_srhid 
                   LEFT JOIN medicinemaster MM 
                          ON MM.mm_id = SRD.srd_mmid 
            WHERE  SRH.srh_issync = 'false'; ---Add BY Hasmukh 10 10 2018 
        END 
      ELSE IF @SP_STATUS = 'FillGridTax' 
        BEGIN 
            SELECT A.tax_id, 
                   A.tax_name, 
                   B.tax_name                            AS Tax_BaseOn, 
                   CONVERT(DECIMAL(18, 2), A.tax_defval) AS Tax_DefVal 
            FROM   taxmaster (nolock)AS A 
                   LEFT JOIN taxmaster (nolock)AS B 
                          ON A.tax_baseon = B.tax_id 
            WHERE  A.tax_isactive = 1 
        END 
      ELSE IF @SP_STATUS = 'DeleteTax' 
        --BEGIN   
        --  DELETE FROM MedicineWiseTaxMaster   
        --  WHERE Mtm_MmId = @Mtm_MmId   
        --END   
        BEGIN 
            DECLARE @MSG_OUT NVARCHAR(max) 

            EXEC Sp_tbl_dependency 
              'MedicineWiseTaxMaster', 
              @Mtm_MmId, 
              @MSG_OUT output 

            IF ( Rtrim(Ltrim(@MSG_OUT)) <> '' ) 
              BEGIN 
                  RAISERROR (@MSG_OUT,14,9) 
              END 
            ELSE 
              BEGIN 
                  DELETE FROM medicinewisetaxmaster 
                  WHERE  mtm_mmid = @Mtm_MmId 
              END 
        END 
      ELSE IF @SP_STATUS = 'SEARCH_BY_ITEM_NAME' 
        BEGIN 
            SELECT chk                                    AS 'IND_SEL', 
                   mm.mm_id                               AS ITM_ID, 
                   mm.mm_name                             AS ITM_NAME, 
                   mm.mm_code                             AS ITM_CODE, 
                   mm.mm_purrate                          AS ItemRate, 
                   uom.uom_name                           AS UOM_NAME, 
                   uom.uom_code                           AS UOM_CODE, 
                   uom.uom_id                             AS Uom_ID, 
                   0                                      AS INDD_SR_NO, 
                   mm.mm_leadtime                         AS ITM_LEAD_TIME, 
                   Isnull(Sum(dbo.vwstock.item_stock), 0) AS Stock, 
                   mm.mm_minlevel                         AS ITM_MIN_LEVEL, 
                   mm.mm_maxlevel                         AS ITM_MAX_LEVEL 
            FROM   dbo.medicinemaster(nolock) mm 
                   LEFT JOIN dbo.vwstock 
                          ON mm.mm_id = dbo.vwstock.item_id 
                   LEFT JOIN uommaster(nolock) uom 
                          ON uom.uom_id = mm.mm_stkuom 
            WHERE  mm_isactive = 1 
                   --AND ISNULL(Item_Name, '') <> ''   
                   AND item_code LIKE '%' + Isnull(@Mm_Name, '') + '%' 
                    OR item_name LIKE '%' + Isnull(@Mm_Name, '') + '%' 
            GROUP  BY chk, 
                      mm.mm_id, 
                      mm.mm_name, 
                      mm.mm_code, 
                      uom.uom_code, 
                      uom.uom_name, 
                      uom.uom_id, 
                      mm_leadtime, 
                      mm_minlevel, 
                      mm_maxlevel, 
                      mm.mm_purrate 
            ORDER  BY mm.mm_name 
        END; 
      --ELSE IF @SP_STATUS = 'BIND_ITEM'   
      --BEGIN   
      -- SELECT Chk AS 'IND_SEL',   
      --    mm.Mm_ID AS ITM_ID,   
      --    mm.Mm_Name AS ITM_NAME,   
      --    mm.Mm_Code AS ITM_CODE,   
      --    mm.Mm_PurRate AS ItemRate,   
      --    uom.Uom_Name AS UOM_NAME,   
      --    uom.Uom_ID AS Uom_ID,   
      --    0 AS INDD_SR_NO,   
      --    mm.Mm_LeadTime AS ITM_LEAD_TIME,   
      --    ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock,   
      --    mm.Mm_MinLevel AS ITM_MIN_LEVEL,   
      --    mm.Mm_MaxLevel AS ITM_MAX_LEVEL,   
      --    mm.MM_PackSize AS Ps_Code,   
      --    mm.Mm_MRP,   
      --    mm.MM_ManufactureBy   
      -- FROM dbo.MedicineMaster(NOLOCK) mm   
      -- LEFT JOIN dbo.vwStock   
      --  ON mm.Mm_ID = dbo.vwStock.Item_Id   
      -- LEFT JOIN UomMaster(NOLOCK) uom   
      --  ON uom.Uom_ID = mm.MM_PurchaseUom   
      -- WHERE Mm_IsActive = 1   
      -- GROUP BY Chk,   
      --    mm.Mm_ID,   
      --    mm.Mm_Name,   
      --    mm.Mm_Code,   
      --    uom.Uom_Code,   
      --    uom.Uom_Name,   
      --    uom.Uom_ID,   
      --    Mm_LeadTime,   
      --    Mm_MinLevel,   
      --    Mm_MaxLevel,   
      --    mm.Mm_PurRate,   
      --    mm.MM_PackSize,   
      --    mm.Mm_MRP,   
      --    MM_ManufactureBy   
      -- ORDER BY mm.Mm_Name   
      --END   
      ELSE IF @SP_STATUS = 'BIND_ITEM' 
        BEGIN 
            --SELECT Chk AS 'IND_SEL',   
            --   mm.Mm_ID AS ITM_ID,   
            --   mm.Mm_Name AS ITM_NAME,   
            --   mm.Mm_Code AS ITM_CODE,   
            --   mm.Mm_PurRate AS ItemRate,   
            --   uom.Uom_Name AS UOM_NAME,   
            --   uom.Uom_ID AS Uom_ID,   
            --   0 AS INDD_SR_NO,   
            --   mm.Mm_LeadTime AS ITM_LEAD_TIME,   
            --   ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock,   
            --   mm.Mm_MinLevel AS ITM_MIN_LEVEL,   
            --   mm.Mm_MaxLevel AS ITM_MAX_LEVEL,   
            --   mm.MM_PackSize AS Ps_Code,   
            --   mm.Mm_MRP,   
            --   mm.MM_ManufactureBy   
            --FROM dbo.MedicineMaster(NOLOCK) mm   
            --LEFT JOIN dbo.vwStock   
            -- ON mm.Mm_ID = dbo.vwStock.Item_Id   
            --LEFT JOIN UomMaster(NOLOCK) uom   
            -- ON uom.Uom_ID = mm.MM_PurchaseUom   
            --left join IndentDetail id on mm.Mm_ID=id.Indd_ItmId   
            --left join IndentHeader ih on id.Indd_IndKey=ih.Ind_Key   
            --WHERE Mm_IsActive = 1   and ih.Ind_ApproveStatus!='Cancel'   
            --GROUP BY Chk,   
            --   mm.Mm_ID,   
            --   mm.Mm_Name,   
            --   mm.Mm_Code,   
            --   uom.Uom_Code,   
            --   uom.Uom_Name,   
            --   uom.Uom_ID,   
            --   Mm_LeadTime,   
            --   Mm_MinLevel,   
            --   Mm_MaxLevel,   
            --   mm.Mm_PurRate,   
            --   mm.MM_PackSize,   
            --   mm.Mm_MRP,   
            --   MM_ManufactureBy   
            --   --having  convert(decimal,ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_AcceptedQty),0))=0   
            --   having  convert(decimal,ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_AcceptedQty),0))=0   
            --ORDER BY mm.Mm_Name   
            SELECT  CONVERT(BIT,0)						AS SEL,
			       CONVERT(BIT,0)						AS 'IND_SEL', 
                   mm.mm_id                               AS ITM_ID, 
                   mm.mm_name                             AS ITM_NAME, 
                   mm.mm_code                             AS ITM_CODE, 
                   mm.mm_purrate                          AS ItemRate, 
                   uom.uom_name                           AS UOM_NAME, 
                   uom.uom_id                             AS Uom_ID, 
                   0                                      AS INDD_SR_NO, 
                   mm.mm_leadtime                         AS ITM_LEAD_TIME, 
                   Isnull(Sum(dbo.vwstock.item_stock), 0) AS Stock, 
                   mm.mm_minlevel                         AS ITM_MIN_LEVEL, 
                   mm.mm_maxlevel                         AS ITM_MAX_LEVEL, 
                   mm.mm_packsize                         AS Ps_Code, 
                   mm.mm_mrp, 
                   mm.mm_manufactureby, 
                   ( CASE 
                       WHEN mm.mm_maintainexp = 'true' THEN 'YES' 
                       ELSE 'NO' 
                     END )                                AS 
                   mm_MaintainExpStatus, 
                   ---Add Hasmukh,   
                   Isnull(mm.mm_mtmid, 0)                 AS Mm_MtmId 
            ---Add For Check On Opening Stock   
            FROM   dbo.medicinemaster(nolock) mm 
                   LEFT JOIN dbo.vwstock 
                          ON mm.mm_id = dbo.vwstock.item_id 
                   LEFT JOIN uommaster(nolock) uom 
                          ON uom.uom_id = mm.mm_purchaseuom 
                   ---LEFT JOIN IndentDetail id----Commment By Hasmukh   
                   ---ON mm.Mm_ID = id.Indd_ItmId   
                   ---LEFT JOIN IndentHeader ih   
                   ----ON id.Indd_IndKey = ih.Ind_Key   
                   ---Add Purchase Indent-Accepted qty=0 Not Exist Then Check Purchase Indent Cancel Or Not----Add Hasmukh   
                   INNER JOIN (SELECT MM1.mm_id, 
                                      MM1.mm_code, 
                                      Isnull((SELECT TOP 1 ( CASE 
                                             WHEN CONVERT(DECIMAL, 
                                             Isnull(( id.indd_qty ), 0) - 
  Isnull(( id.indd_acceptedqty ), 0) - 
  Isnull(( id.indd_shortcloseqty ), 0)) = 0 
                  THEN 
  'TRUE' 
  ELSE ( CASE 
  WHEN ih.ind_approvestatus = 'Cancel' THEN 
  'TRUE' 
  ELSE 'False' 
  END ) 
  END ) 
   FROM   indentdetail (nolock) id 
          LEFT JOIN indentheader (nolock) 
          ih 
                 ON id.indd_indkey = 
                    ih.ind_key 
   WHERE  id.indd_itmid = MM1.mm_id 
   ORDER  BY id.indd_key DESC), 'True') AS 
  Status 
  FROM   medicinemaster MM1) AS MMIndentStatus 
  ON MMIndentStatus.mm_id = MM.mm_id 
  ----Finish Add By Hasmukh   
  WHERE  mm_isactive = 1 
  AND MMIndentStatus.status = 'TRUE' 
  ---Add Hasmukh---OR ih.Ind_ApproveStatus='Cancel' Rmove Hasmukh  -- and isnull(ih.Ind_ApproveStatus,'')!='Cancel'      --comment by yogini 21/04/2018   
  GROUP  BY ---Ind_ApproveStatus, Remove Hasmukh   
  chk, 
  mm.mm_id, 
  mm.mm_name, 
  mm.mm_code, 
  uom.uom_code, 
  uom.uom_name, 
  uom.uom_id, 
  mm_leadtime, 
  mm_minlevel, 
  mm_maxlevel, 
  mm.mm_purrate, 
  mm.mm_packsize, 
  mm.mm_mrp, 
  mm_manufactureby, 
  mm.mm_maintainexp, 
  mm.mm_mtmid 
  --having  convert(decimal,ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_AcceptedQty),0))=0   
  --having  convert(decimal,ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_AcceptedQty),0))=0   
  --HAVING (CONVERT(decimal,ISNULL(SUM(id.Indd_Qty),0) - ISNULL(SUM(id.Indd_AcceptedQty),0)) = 0)----Remove Hasmukh   
  ORDER  BY mm.mm_name 
  END 
  ELSE IF @SP_STATUS = 'BindOpeningStockMedicine' 
  BEGIN 
  SELECT CONVERT(BIT,0)						AS SEL,
		CONVERT(BIT,0)						AS 'IND_SEL', 
  mm.mm_id                               AS ITM_ID, 
  mm.mm_name                             AS ITM_NAME, 
  mm.mm_code                             AS ITM_CODE, 
  mm.mm_purrate                          AS ItemRate, 
  uom.uom_name                           AS UOM_NAME, 
  uom.uom_id                             AS Uom_ID, 
  0                                      AS INDD_SR_NO, 
  mm.mm_leadtime                         AS ITM_LEAD_TIME, 
  Isnull(Sum(dbo.vwstock.item_stock), 0) AS Stock, 
  mm.mm_minlevel                         AS ITM_MIN_LEVEL, 
  mm.mm_maxlevel                         AS ITM_MAX_LEVEL, 
  mm.mm_packsize                         AS Ps_Code, 
  mm.mm_mrp, 
  mm.mm_manufactureby, 
  ( CASE 
  WHEN mm.mm_maintainexp = 'true' THEN 'YES' 
  ELSE 'NO' 
  END )                                AS mm_MaintainExpStatus, 
  ---Add Hasmukh   
  Isnull(mm.mm_mtmid, 0)                 AS Mm_MtmId 
  ---Add For Stock BPPI Or Other   
  FROM   dbo.medicinemaster(nolock) mm 
  LEFT JOIN dbo.vwstock 
  ON mm.mm_id = dbo.vwstock.item_id 
  LEFT JOIN uommaster(nolock) uom 
  ON uom.uom_id = mm.mm_stkuom 
  LEFT JOIN indentdetail (nolock)id 
  ON mm.mm_id = id.indd_itmid 
  LEFT JOIN indentheader (nolock) ih 
  ON id.indd_indkey = ih.ind_key 
  WHERE  mm_isactive = 1 
  AND Isnull(ih.ind_approvestatus, '') != 'Cancel' 
  GROUP  BY chk, 
  mm.mm_id, 
  mm.mm_name, 
  mm.mm_code, 
  uom.uom_code, 
  uom.uom_name, 
  uom.uom_id, 
  mm_leadtime, 
  mm_minlevel, 
  mm_maxlevel, 
  mm.mm_purrate, 
  mm.mm_packsize, 
  mm.mm_mrp, 
  mm_manufactureby, 
  mm_maintainexp, 
  mm.mm_mtmid 
  --having  convert(decimal,ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_Qty),0)-ISNULL(sum(id.Indd_AcceptedQty),0))=0   
  HAVING CONVERT(DECIMAL, Isnull(Sum(id.indd_qty), 0) - 
  Isnull(Sum(id.indd_acceptedqty), 0)) = 0 
  ORDER  BY mm.mm_name 
  END 
  ELSE IF @SP_STATUS = 'Insert' 
  BEGIN 
  SELECT @Mm_ID = Isnull(Max(mm_id), 0) + 1 
  FROM   medicinemaster(nolock); 

  INSERT INTO [dbo].[medicinemaster] 
  (mm_id, 
  [mm_code], 
  [mm_name], 
  [mm_saltname], 
  [mm_searchkey], 
  [mm_hsncode], 
  [mm_mtmid], 
  [mm_mgmid], 
  [mm_mcmid], 
  [mm_salerate], 
  [mm_purrate], 
  [mm_mktrate], 
  [mm_mrp], 
  [mm_maxlevel], 
  [mm_reorderlevel], 
  [mm_minlevel], 
  [mm_isstockable], 
  [mm_stkuom], 
  [mm_isinventory], 
  [mm_sales], 
  [mm_maintainqc], 
  [mm_fixedasset], 
  [mm_maintainexp], 
  [mm_leadtime], 
  [mm_isactive], 
  [mm_sapcode],--,[Mm_BarCode]   
  [mm_createdby], 
  [mm_createddate], 
  mm_purchaseuom, 
  mm_purchaseratio, 
  mm_salesratio, 
  mm_packsize, 
  mm_marketingby, 
  mm_manufactureby) 
  VALUES      (@Mm_ID, 
  @Mm_Code, 
  @Mm_Name, 
  @Mm_SaltName, 
  @Mm_SearchKey, 
  @Mm_HsnCode, 
  @Mm_MtmId, 
  @Mm_MgmId, 
  @Mm_McmId, 
  @Mm_SaleRate, 
  @Mm_PurRate, 
  @Mm_MktRate, 
  @Mm_MRP, 
  @Mm_MaxLevel, 
  @Mm_ReorderLevel, 
  @Mm_MinLevel, 
  @Mm_IsStockable, 
  @Mm_StkUom, 
  @Mm_IsInventory, 
  @Mm_Sales, 
  @Mm_MaintainQc, 
  @Mm_FixedAsset, 
  @Mm_MaintainExp, 
  @Mm_LeadTime, 
  @Mm_IsActive, 
  @Mm_SapCode,--,@Mm_BarCode, varchar(50),>   
  @Mm_User, 
  Getdate(), 
  @MM_PurchaseUom, 
  @MM_PurchaseRatio, 
  @MM_SalesRatio, 
  @MM_PackSize, 
  @MM_MarketingBy, 
  @MM_ManufactureBy); 

  SELECT @ID = @Mm_ID; 
  END; 
  ELSE IF @SP_STATUS = 'Update' 
  BEGIN 
  UPDATE [dbo].[medicinemaster] 
  SET    [mm_code] = @Mm_Code, 
  [mm_name] = @Mm_Name, 
  [mm_saltname] = @Mm_SaltName, 
  [mm_searchkey] = @Mm_SearchKey, 
  [mm_hsncode] = @Mm_HsnCode, 
  [mm_mtmid] = @Mm_MtmId, 
  [mm_mgmid] = @Mm_MgmId, 
  [mm_mcmid] = @Mm_McmId, 
  [mm_salerate] = @Mm_SaleRate, 
  [mm_purrate] = @Mm_PurRate, 
  [mm_mktrate] = @Mm_MktRate, 
  [mm_mrp] = @Mm_MRP, 
  [mm_maxlevel] = @Mm_MaxLevel, 
  [mm_reorderlevel] = @Mm_ReorderLevel, 
  [mm_minlevel] = @Mm_MinLevel, 
  [mm_isstockable] = @Mm_IsStockable, 
  [mm_stkuom] = @Mm_StkUom, 
  [mm_isinventory] = @Mm_IsInventory, 
  [mm_sales] = @Mm_Sales, 
  [mm_maintainqc] = @Mm_MaintainQc, 
  [mm_fixedasset] = @Mm_FixedAsset, 
  [mm_maintainexp] = @Mm_MaintainExp, 
  [mm_leadtime] = @Mm_LeadTime, 
  [mm_isactive] = @Mm_IsActive, 
  [mm_sapcode] = @Mm_SapCode, 
  --,[Mm_BarCode] = @Mm_BarCode   
  [mm_updatedby] = @Mm_User, 
  [mm_updateddate] = Getdate(), 
  mm_packsize = @MM_PackSize, 
  mm_purchaseuom = @MM_PurchaseUom, 
  mm_purchaseratio = @MM_PurchaseRatio, 
  mm_salesratio = @MM_SalesRatio, 
  mm_marketingby = @MM_MarketingBy, 
  mm_manufactureby = @MM_ManufactureBy 
  WHERE  [mm_id] = @Mm_ID; 

  DELETE FROM [medicinelocationmaster] 
  WHERE  mlm_mmid = @Mm_ID 

  DELETE FROM medicinewisetaxmaster 
  WHERE  mtm_mmid = @Mtm_MmId 

  SELECT @ID = @Mm_ID; 
  END 
  ELSE IF @SP_STATUS = 'Delete' 
  BEGIN 
  DECLARE @MSG_OUT_1 NVARCHAR(max) 

  EXEC Sp_tbl_dependency 
  'MedicineMaster', 
  @Mm_ID, 
  @MSG_OUT_1 output 

  IF ( Rtrim(Ltrim(@MSG_OUT_1)) <> '' ) 
  BEGIN 
  RAISERROR (@MSG_OUT_1,14,9) 
  END 
  ELSE 
  BEGIN 
  DELETE FROM medicinemaster 
  WHERE  mm_id = @Mm_ID 

  DELETE FROM medicinewisetaxmaster 
  WHERE  mtm_mmid = @Mm_ID 

  DELETE FROM medicinelocationmaster 
  WHERE  mlm_mmid = @Mm_ID 
  END 
  END 
  ELSE IF @SP_STATUS = 'RETRIVE' 
  BEGIN 
  SELECT MM.mm_id, 
  MM.mm_code, 
  MM.mm_name, 
  MM.mm_saltname, 
  MM.mm_searchkey, 
  MM.mm_hsncode, 
  MM.mm_mtmid, 
  MM.mm_mgmid, 
  MM.mm_mcmid, 
  MM.mm_salerate, 
  MM.mm_purrate, 
  MM.mm_mktrate, 
  MM.mm_mrp, 
  MM.mm_maxlevel, 
  MM.mm_reorderlevel, 
  MM.mm_minlevel, 
  MM.mm_isstockable, 
  MM.mm_stkuom, 
  MM.mm_isinventory, 
  MM.mm_sales, 
  MM.mm_maintainqc, 
  MM.mm_fixedasset, 
  MM.mm_maintainexp, 
  MM.mm_leadtime, 
  --Mm_IsActive,   
  CASE 
  WHEN MM.mm_isactive = 1 THEN 'Yes' 
  ELSE 'No' 
  END                AS Mm_IsActive, 
  MM.mm_issysgen, 
  MM.mm_issync, 
  MM.mm_lastsyncdate, 
  MM.mm_barcode, 
  MM.mm_sapitemid, 
  MM.mm_cpositemid, 
  MM.mm_sapcode, 
  MM.mm_createdby, 
  MM.mm_createddate, 
  MM.mm_updatedby, 
  MM.mm_updateddate, 
  C.user_name        AS Uom_User, 
  MCategory.mcm_code AS Mm_McmCode, 
  MCategory.mcm_name AS Mm_McmName, 
  MGroup.mgm_code    AS Mm_MgmCode, 
  MGroup.mgm_name    AS Mm_MgmName, 
  MType.mtm_typecode AS Mm_MtmCode, 
  MType.mtm_typename AS Mm_MtmName, 
  MM.mm_purchaseuom, 
  MM.mm_purchaseratio, 
  MM.mm_salesratio, 
  Mm.mm_packsize, 
  mm_marketingby, 
  mm_manufactureby--,   
  --lm.Lm_Id as Mm_LmId   
  ,ISNULL(Mm_Primary_Size,'') AS Mm_Primary_Size
  ,ISNULL(Mm_Second_Size,'') AS Mm_Second_Size
  ,ISNULL(Mm_Tertairy_Size,'') AS Mm_Tertairy_Size
  FROM   medicinemaster AS MM (nolock) 
  LEFT JOIN dbo.usermaster C (nolock) 
  ON MM.mm_createdby = C.user_id 
  LEFT JOIN medicinecategorymaster MCategory (nolock) 
  ON MM.mm_mcmid = MCategory.mcm_id 
  LEFT JOIN medicinegroupmaster MGroup (nolock) 
  ON MM.mm_mgmid = MGroup.mgm_id 
  LEFT JOIN medicinetypemaster MType (nolock) 
  ON MM.mm_mtmid = MType.mtm_id 
  --LEFT JOIN LocationMaster (NOLOCK) lm   
  --    ON lm.Lm_Id = MM.Mm_LmId   
  WHERE  MM.mm_id = @Mm_ID 

  SELECT @ID = @Mm_ID; 
  END 
  ELSE IF @SP_STATUS = 'Fillgrid' 
  BEGIN 
  SELECT MM.mm_id, 
  MM.mm_code, 
  MM.mm_name, 
  MM.mm_saltname, 
  MM.mm_searchkey, 
  MM.mm_hsncode, 
  MM.mm_mtmid, 
  MM.mm_mgmid, 
  MM.mm_mcmid, 
  MM.mm_salerate, 
  MM.mm_purrate, 
  MM.mm_mktrate, 
  MM.mm_mrp, 
  MM.mm_maxlevel, 
  MM.mm_reorderlevel, 
  MM.mm_minlevel, 
  MM.mm_isstockable, 
  MM.mm_stkuom, 
  MM.mm_isinventory, 
  MM.mm_sales, 
  MM.mm_maintainqc, 
  MM.mm_fixedasset, 
  MM.mm_maintainexp, 
  MM.mm_leadtime, 
  --Mm_IsActive,   
  CASE 
  WHEN MM.mm_isactive = 1 THEN 'Yes' 
  ELSE 'No' 
  END                AS Mm_IsActive, 
  MM.mm_issysgen, 
  MM.mm_issync, 
  MM.mm_lastsyncdate, 
  MM.mm_barcode, 
  MM.mm_sapitemid, 
  MM.mm_cpositemid, 
  MM.mm_sapcode, 
  MM.mm_createdby, 
  MM.mm_createddate, 
  MM.mm_updatedby, 
  MM.mm_updateddate, 
  C.user_name        AS Uom_User, 
  MCategory.mcm_code AS Mm_McmCode, 
  MCategory.mcm_name AS Mm_McmName, 
  MGroup.mgm_code    AS Mm_MgmCode, 
  MGroup.mgm_name    AS Mm_MgmName, 
  MType.mtm_typecode AS Mm_MtmCode, 
  MType.mtm_typename AS Mm_MtmName, 
  MM.mm_purchaseuom, 
  MM.mm_purchaseratio, 
  MM.mm_salesratio, 
  Mm.mm_packsize, 
  mm_marketingby, 
  mm_manufactureby 
  FROM   medicinemaster AS MM (nolock) 
  LEFT JOIN dbo.usermaster C (nolock) 
  ON MM.mm_createdby = C.user_id 
  LEFT JOIN medicinecategorymaster MCategory (nolock) 
  ON MM.mm_mcmid = MCategory.mcm_id 
  LEFT JOIN medicinegroupmaster MGroup (nolock) 
  ON MM.mm_mgmid = MGroup.mgm_id 
  LEFT JOIN medicinetypemaster MType (nolock) 
  ON MM.mm_mtmid = MType.mtm_id; 
  END 
  ELSE IF @SP_STATUS = 'Fill_TREE' 
  BEGIN ; 
  WITH emp_cte (lm_id, lm_lmid, lm_name) 
  AS (SELECT A.lm_id, 
  lm_lmid, 
  A.lm_name 
  FROM   locationmaster (nolock) AS A 
  WHERE  lm_lmid = 0 
  AND lm_isactive = 1 
  UNION ALL 
  SELECT e.lm_id, 
  e.lm_lmid, 
  e.lm_name 
  FROM   locationmaster (nolock) e 
  INNER JOIN emp_cte ecte 
  ON ecte.lm_id = e.lm_lmid 
  WHERE  e.lm_isactive = 1) 
  SELECT lm_id, 
  CASE 
  WHEN lm_lmid = 0 THEN lm_lmid * -1 
  ELSE lm_lmid 
  END AS Lm_LmId, 
  lm_name 
  FROM   emp_cte 
  END 
  ELSE IF @SP_STATUS = 'GET_WAREHOUSE_LOCATION' 
  BEGIN 
  SELECT DISTINCT mlm_lmid 
  FROM   medicinelocationmaster(nolock) 
  WHERE  mlm_mmid = @Mm_ID 
  END 
  ELSE IF @SP_STATUS = 'INSERT_MEDICINE_LOCATION_MASTER' 
  BEGIN 
  INSERT INTO [dbo].[medicinelocationmaster] 
  ([mlm_mmid], 
  [mlm_lmid], 
  [mlm_isdefualt]) 
  VALUES      (@Mm_ID, 
  @Mm_LmId, 
  0) 
  END 
  ELSE IF @SP_STATUS = 'InsertTax' 
  BEGIN 
  SELECT @Mtm_ID = Isnull(Max(mtm_id), 0) + 1 
  FROM   medicinewisetaxmaster (nolock) 

  INSERT INTO medicinewisetaxmaster 
  (mtm_id, 
  mtm_mmid, 
  mtm_taxid, 
  mtm_taxvalue) 
  VALUES      (@Mtm_Id, 
  @Mtm_MmId, 
  @Mtm_TaxId, 
  @Mtm_TaxValue) 
  --SELECT @Mtm_Id   
  END 
  ELSE IF @SP_STATUS = 'GetTaxDetail' 
  BEGIN 
  SELECT tm.tax_id                     AS Tax_ID, 
  tm.tax_name                   AS TAX_NAME, 
  tmNew.tax_name                AS Tax_BaseOn, 
  Isnull(mt.mtm_taxvalue, 0.00) AS Tax_DefVal 
  FROM   medicinewisetaxmaster (nolock) mt 
  RIGHT JOIN taxmaster (nolock) tm 
  ON mt.mtm_taxid = tm.tax_id 
  AND mt.mtm_mmid = @Mtm_MmId 
  LEFT JOIN taxmaster (nolock) AS tmNew 
  ON tm.tax_baseon = tmNew.tax_id 
  END 
  ELSE IF @SP_STATUS = 'GET_DRUG_BY_ID' 
  BEGIN 
  SELECT mm_id, 
  mm_code, 
  mm_createddate, 
  mm_updateddate 
  FROM   medicinemaster (nolock) 
  WHERE  mm_id IN (SELECT * 
  FROM   dbo.String_split(@MedicineIdstr, ',')) 
  END 
  ELSE IF @SP_STATUS = 'UPDATE_FROM_CPOS' 
  BEGIN 
  UPDATE [dbo].[medicinemaster] 
  SET    [mm_code] = @Mm_Code, 
  [mm_name] = @Mm_Name, 
  [mm_saltname] = @Mm_SaltName, 
  [mm_searchkey] = @Mm_SearchKey, 
  [mm_hsncode] = @Mm_HsnCode, 
  [mm_salerate] = @Mm_SaleRate, 
  [mm_purrate] = @Mm_PurRate, 
  [mm_mktrate] = @Mm_MktRate, 
  [mm_mrp] = @Mm_MRP, 
  [mm_isactive] = @Mm_IsActive, 
  [mm_sapcode] = @Mm_SapCode, 
  [mm_updatedby] = 1, 
  [mm_updateddate] = @MM_UPDATED_DATE 
  WHERE  mm_code = @Mm_Code 
  END 
  ELSE IF @SP_STATUS = 'UpdateDefualtValue' 
  BEGIN 
  UPDATE medicinelocationmaster 
  SET    mlm_isdefualt = 0 
  WHERE  mlm_id = @Mm_ID 

  UPDATE medicinelocationmaster 
  SET    mlm_isdefualt = 1 
  WHERE  mlm_id = @Mm_ID 
  AND mlm_lmid = @Mm_LmId 
  END 
  ELSE IF @SP_STATUS = 'GetDefaultData' 
  BEGIN 
  SELECT * 
  FROM   configurationmaster 
  END 

      IF @SP_STATUS = 'FillHelp' 
        BEGIN 
            SELECT mm_id   AS hc_MmID, 
                   mm_code AS hc_MmCode, 
                   mm_name AS hc_MmName 
            FROM   medicinemaster (nolock) 
            WHERE  mm_isactive = 1 
        END 

      IF @SP_STATUS = 'FillHelp_Report' 
        BEGIN 
            SELECT mm_id   AS hc_MmID, 
                   mm_code AS hc_MmCode, 
                   mm_name AS hc_MmName 
            FROM   medicinemaster (nolock) 
            WHERE  mm_isactive = 1 
                   AND mm_mtmid = CASE 
                                    WHEN @Mm_MtmId > 0 THEN @Mm_MtmId 
                                    ELSE mm_mtmid 
                                  END 
        END
		IF @SP_STATUS = 'FillHelp_AllDrug' 
        BEGIN 
            SELECT mm_id   AS hc_MmID, 
                   mm_code AS hc_MmCode, 
                   mm_name AS hc_MmName 
            FROM   medicinemaster (nolock) 
            WHERE  mm_isactive = 1 
                   
                                   
        END 
		ELSE
		IF @SP_STATUS = 'Fill_Drug_BatchList' 
        BEGIN 
			SELECT	DISTINCT
					STK.Stk_BatchNo
			FROM	StockRegister  STK
					INNER JOIN  MedicineMaster MM
				ON	MM.Mm_ID=STK.Stk_MmId 
			WHERE	MM.Mm_Code=@Mm_Code;
        END 
      ELSE IF @SP_STATUS = 'SP_RPT_SalesAndStockPivotTable' 
        BEGIN 
            SELECT MM.mm_code                                    AS DRUGCODE, 
                   MM.mm_name                                    AS DRUGNAME, 
                   Isnull(STOCK.purchaseunit, PPUOM.uom_name)    AS PURCHASEUNIT 
                   , 
                   MM.mm_packsize 
                   AS PACKSIZE, 
                   Isnull((SELECT ( Sum(CASE 
                                          WHEN stk_tran_typ = 'C' THEN 
                                          stk_purchaseqty 
                                          ELSE 0 
                                        END) - Sum(CASE 
                                                     WHEN stk_tran_typ = 'D' 
                                                   THEN 
                                                     stk_purchaseqty 
                                                     ELSE 0 
                                                   END) ) 
                           FROM   stockregister 
                           WHERE  CONVERT(DATE, stockregister.stk_date) < 
                                  CONVERT(DATE, 
                                  Cast(year1 AS 
                                  VARCHAR(4)) 
                                          + '-' 
                                  + Cast(monthno AS 
                                  VARCHAR( 
                                          2)) + 
                                  '-01') 
                                  AND stockregister.stk_mmid = STOCK.stk_mmid 
                           GROUP  BY stockregister.stk_mmid), 0) AS OPENINGSTOCK 
                   , 
                   Isnull(Sum(STOCK.openingstockqty), 0) 
                   AS 
                   ADDOPENINGSTOCKQTY 
                   , 
                   Isnull(Sum(STOCK.salesqty), 0)                AS 
                   SALESQTY, 
                   Isnull(Sum(STOCK.salesreturnqty), 0)          AS 
                   SALESRETURNQTY 
                   , 
                   Isnull(Sum(STOCK.purchaseqty), 0) 
                   AS PURCHASEQTY, 
                   Isnull(Sum(STOCK.purchasereturnqty), 0)       AS 
                   PURCHASERETURNQTY, 
                   Isnull(Sum(STOCK.adjustqty), 0)               AS ADJUSTQTY, 
                   Isnull((SELECT ( Sum(CASE 
                                          WHEN stk_tran_typ = 'C' THEN 
                                          stk_purchaseqty 
                                          ELSE 0 
                                        END) - Sum(CASE 
                                                     WHEN stk_tran_typ = 'D' 
                                                   THEN 
                                                     stk_purchaseqty 
                                                     ELSE 0 
                                                   END) ) 
                           FROM   stockregister 
                           WHERE  Month(stockregister.stk_date) <= monthno 
                                  AND Year(stockregister.stk_date) <= year1 
                                  AND stockregister.stk_mmid = STOCK.stk_mmid 
                           GROUP  BY stockregister.stk_mmid), 0) AS CLOSINGSTOCK 
                   , 
                   STOCK.month1, 
                   STOCK.year1, 
                   BM.branch_name, 
                   Isnull(BM.branch_address1, '') + ' ' 
                   + Isnull(BM.branch_address2, '') + ' ' 
                   + Isnull(BM.branch_address3, '')              AS 
                   Branch_Address 
                   , 
                   BM.branch_gstno 
            FROM   medicinemaster (nolock) MM 
                   LEFT JOIN branchmaster (nolock) BM 
                          ON BM.branch_id = 1 
                   INNER JOIN 
                   (SELECT SR.stk_mmid, 
                           SR.stk_date, 
                           ( CASE 
                               WHEN SR.stk_tran_typ = 'D' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS PUSALESQTY 
                           , 
                           ( CASE 
                               WHEN SR.stk_tran_typ = 'C' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS 
                           PUPURCHASEQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype = 6 
                                    AND SR.stk_tran_typ = 'C' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS 
                           OPENINGSTOCKQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype = 2 
                                    AND SR.stk_tran_typ = 'D' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS SALESQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype = 3 
                                    AND SR.stk_tran_typ = 'C' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS 
                           SALESRETURNQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype IN ( 4, 6 ) 
                                    AND SR.stk_tran_typ = 'C' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS PURCHASEQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype = 5 
                                    AND SR.stk_tran_typ = 'D' THEN 
                               SR.stk_purchaseqty 
                               ELSE 0 
                             END )                      AS 
                           PURCHASERETURNQTY, 
                           ( CASE 
                               WHEN SR.stk_doctype = 14 
                                    AND SR.stk_tran_typ = 'C' THEN 
                               SR.stk_purchaseqty 
                               ELSE ( CASE 
                                        WHEN SR.stk_doctype = 14 
                                             AND SR.stk_tran_typ = 'D' 
                                      THEN 
                                        -SR.stk_purchaseqty 
                                        ELSE 0 
                                      END ) 
                             END )                      AS ADJUSTQTY, 
                           PUOM.uom_name                AS PURCHASEUNIT 
                           , 
                   Datename(month, SR.stk_date) AS MONTH1, 
                   Year(SR.stk_date)            AS YEAR1, 
                   Month(SR.stk_date)           AS MONTHNO 
                               FROM   stockregister (nolock)SR 
                                      INNER JOIN uommaster (nolock) PUOM 
                                              ON PUOM.uom_id = 
                                                 SR.stk_purchaseuom) 
                              AS 
                              STOCK 
                           ON STOCK.stk_mmid = MM.mm_id 
                   LEFT JOIN uommaster (nolock) PPUOM 
                          ON PPUOM.uom_id = MM.mm_purchaseuom 
            GROUP  BY MM.mm_code, 
                      MM.mm_name, 
                      STOCK.stk_mmid, 
                      STOCK.purchaseunit, 
                      MM.mm_packsize, 
                      monthno, 
                      PPUOM.uom_name, 
                      year1, 
                      month1, 
                      BM.branch_name, 
                      BM.branch_address1, 
                      BM.branch_address2, 
                      BM.branch_address3, 
                      BM.branch_gstno 
            ORDER  BY MM.mm_name ASC 
        END 
      ELSE IF @SP_STATUS = 'SP_RPT_StockComparisionWithStockLevel' 
        BEGIN 
            IF ( Isnull(@Mm_MtmId, 0) != 0 ) 
              BEGIN 
                  SELECT Isnull(MTM.mtm_typename, '') 
                         AS 
                         DRUGTYPENAME 
                         , 
                         Isnull(MCM.mcm_name, '') 
                         AS 
                         DRUGCATEGORY, 
                         Isnull(MGM.mgm_name, '') 
                         AS 
                         DRUGGROUP, 
                         MM.mm_code 
                         AS 
                         DRUGCODE, 
                         MM.mm_name 
                         AS 
                         DRUGNAME, 
                         MM.mm_hsncode 
                         AS 
                         HSNCODE, 
                         Isnull(( STOCK.supurchaseqty - STOCK.susalesqty ), 0) 
                         AS 
                         SALEUNITWISEQTY, 
                         Isnull(STOCK.salesunit, SSUOM.uom_name) 
                         AS 
                         SALESUNIT, 
                         Isnull(( STOCK.pupurchaseqty - STOCK.pusalesqty ), 0) 
                         AS 
                         PURCHASEUNITWISEQTY, 
                         Isnull(STOCK.purchaseunit, PPUOM.uom_name) 
                         AS 
                         PURCHASEUNIT 
                         , 
                         MM.mm_packsize 
                         AS 
                         PACKSIZE, 
                         MM.mm_maxlevel 
                         AS 
                         MAXLEVEL, 
                         MM.mm_reorderlevel 
                         AS 
                         REORDERLEVEL 
                         , 
                         MM.mm_minlevel 
                         AS 
                         MINLEVEL, 
                         BM.branch_name, 
                         Isnull(BM.branch_address1, '') + ' ' 
                         + Isnull(BM.branch_address2, '') + ' ' 
                         + Isnull(BM.branch_address3, '') 
                         AS 
                         Branch_Address, 
                         BM.branch_gstno, 
                         MM.mm_salesratio 
                  FROM   medicinemaster (nolock) MM 
                         LEFT JOIN branchmaster (nolock) BM 
                                ON branch_id = 1 
                         LEFT JOIN medicinetypemaster (nolock) MTM 
                                ON MTM.mtm_id = MM.mm_mtmid 
                         LEFT JOIN medicinecategorymaster (nolock) MCM 
                                ON MCM.mcm_id = MM.mm_mcmid 
                         LEFT JOIN medicinegroupmaster (nolock) MGM 
                                ON MGM.mgm_id = MM.mm_mgmid 
                         LEFT JOIN (SELECT SR.stk_mmid, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'D' THEN 
                                                 SR.stk_salesqty 
                                                 ELSE 0 
                                               END)      AS SUSALESQTY, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'C' THEN 
                                                 SR.stk_salesqty 
                                                 ELSE 0 
                                               END)      AS SUPURCHASEQTY, 
                                           SUOM.uom_name AS SALESUNIT, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'D' THEN 
                                                 SR.stk_purchaseqty 
                                                 ELSE 0 
                                               END)      AS PUSALESQTY, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'C' THEN 
                                                 SR.stk_purchaseqty 
                                                 ELSE 0 
                                               END)      AS PUPURCHASEQTY, 
                                           PUOM.uom_name AS PURCHASEUNIT 
                                    FROM   stockregister (nolock) SR 
                                           INNER JOIN uommaster (nolock) SUOM 
                                                   ON SUOM.uom_id = 
                                                      SR.stk_salesuom 
                                           INNER JOIN uommaster (nolock) PUOM 
                                                   ON PUOM.uom_id = 
                                                      SR.stk_purchaseuom 
                                    GROUP  BY SR.stk_mmid, 
                                              SUOM.uom_name, 
                                              PUOM.uom_name) AS STOCK 
                                ON STOCK.stk_mmid = MM.mm_id 
                         LEFT JOIN uommaster (nolock) SSUOM 
                                ON SSUOM.uom_id = MM.mm_stkuom 
                         LEFT JOIN uommaster (nolock) PPUOM 
                                ON PPUOM.uom_id = MM.mm_purchaseuom 
                  WHERE  MM.mm_mtmid = @Mm_MtmId 
                  ORDER  BY MM.mm_name, 
                            MTM.mtm_typename, 
                            MCM.mcm_name, 
                            MGM.mgm_name ASC 
              END 
            ELSE 
              BEGIN 
                  SELECT Isnull(MTM.mtm_typename, '') 
                         AS 
                         DRUGTYPENAME 
                         , 
                         Isnull(MCM.mcm_name, '') 
                         AS 
                         DRUGCATEGORY, 
                         Isnull(MGM.mgm_name, '') 
                         AS 
                         DRUGGROUP, 
                         MM.mm_code 
                         AS 
                         DRUGCODE, 
                         MM.mm_name 
                         AS 
                         DRUGNAME, 
                         MM.mm_hsncode 
                         AS 
                         HSNCODE, 
                         Isnull(( STOCK.supurchaseqty - STOCK.susalesqty ), 0) 
                         AS 
                         SALEUNITWISEQTY, 
                         Isnull(STOCK.salesunit, SSUOM.uom_name) 
                         AS 
                         SALESUNIT, 
                         Isnull(( STOCK.pupurchaseqty - STOCK.pusalesqty ), 0) 
                         AS 
                         PURCHASEUNITWISEQTY, 
                         Isnull(STOCK.purchaseunit, PPUOM.uom_name) 
                         AS 
                         PURCHASEUNIT 
                         , 
                         MM.mm_packsize 
                         AS 
                         PACKSIZE, 
                         MM.mm_maxlevel 
                         AS 
                         MAXLEVEL, 
                         MM.mm_reorderlevel 
                         AS 
                         REORDERLEVEL 
                         , 
                         MM.mm_minlevel 
                         AS 
                         MINLEVEL, 
                         BM.branch_name, 
                         Isnull(BM.branch_address1, '') + ' ' 
                         + Isnull(BM.branch_address2, '') + ' ' 
                         + Isnull(BM.branch_address3, '') 
                         AS 
                         Branch_Address, 
                         BM.branch_gstno, 
                         MM.mm_salesratio 
                  FROM   medicinemaster MM 
                         LEFT JOIN branchmaster BM 
                                ON branch_id = 1 
                         LEFT JOIN medicinetypemaster MTM 
                                ON MTM.mtm_id = MM.mm_mtmid 
                         LEFT JOIN medicinecategorymaster MCM 
                                ON MCM.mcm_id = MM.mm_mcmid 
                         LEFT JOIN medicinegroupmaster MGM 
                                ON MGM.mgm_id = MM.mm_mgmid 
                         LEFT JOIN (SELECT SR.stk_mmid, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'D' THEN 
                                                 SR.stk_salesqty 
                                                 ELSE 0 
                                               END)      AS SUSALESQTY, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'C' THEN 
                                                 SR.stk_salesqty 
                                                 ELSE 0 
                                               END)      AS SUPURCHASEQTY, 
                                           SUOM.uom_name AS SALESUNIT, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'D' THEN 
                                                 SR.stk_purchaseqty 
                                                 ELSE 0 
                                               END)      AS PUSALESQTY, 
                                           Sum(CASE 
                                                 WHEN SR.stk_tran_typ = 'C' THEN 
                                                 SR.stk_purchaseqty 
                                                 ELSE 0 
                                               END)      AS PUPURCHASEQTY, 
                                           PUOM.uom_name AS PURCHASEUNIT 
                                    FROM   stockregister (nolock) SR 
                                           INNER JOIN uommaster (nolock) SUOM 
                                                   ON SUOM.uom_id = 
                                                      SR.stk_salesuom 
                                           INNER JOIN uommaster (nolock) PUOM 
                                                   ON PUOM.uom_id = 
                                                      SR.stk_purchaseuom 
                                    GROUP  BY SR.stk_mmid, 
                                              SUOM.uom_name, 
                                              PUOM.uom_name) AS STOCK 
                                ON STOCK.stk_mmid = MM.mm_id 
                         LEFT JOIN uommaster (nolock) SSUOM 
                                ON SSUOM.uom_id = MM.mm_stkuom 
                         LEFT JOIN uommaster (nolock) PPUOM 
                                ON PPUOM.uom_id = MM.mm_purchaseuom 
                  ORDER  BY MM.mm_name, 
                            MTM.mtm_typename, 
                            MCM.mcm_name, 
                            MGM.mgm_name ASC 
              END 
        END 
      --***======================================For Sync cPOS=============================================================***  
      ELSE IF @SP_STATUS = 'Sync_InsertUpdate' 
        BEGIN 
            --if NOT EXISTS (SELECT * FROM MedicineMaster WHERE Mm_Code = @Mm_Code and Mm_LastSyncDate = @MM_UPDATED_DATE)  
            -- begin   
            IF NOT EXISTS (SELECT * 
                           FROM   medicinegroupmaster (nolock) A 
                           WHERE  A.mgm_name = @MedGroup) 
              BEGIN 
                  SELECT @Mm_MgmId = Isnull(Max(mgm_id), 0) + 1 
                  FROM   medicinegroupmaster 
				  IF(@MedGroup IS NOT NULL)
				  BEGIN
						INSERT INTO medicinegroupmaster 
						             (mgm_id, 
						              mgm_code, 
						              mgm_name, 
						              mgm_isactive, 
						              mgm_syncdt, 
						              mgm_createdby, 
						              mgm_createddt, 
						              mgm_issync, 
						              mgm_issysgen) 
						 VALUES      (@Mm_MgmId, 
						              CONVERT(VARCHAR(10), @Mm_MgmId), 
						              @MedGroup, 
						              1, 
						              Getdate(), 
						              -1, 
						              Getdate(), 
						              1, 
						              1) 
				  END
              END 
            ELSE 
              BEGIN 
                  SELECT TOP (1) @Mm_MgmId = A.mgm_id 
                  FROM   medicinegroupmaster (nolock) A 
                  WHERE  A.mgm_name = @MedGroup 
              END 

            IF NOT EXISTS (SELECT * 
                           FROM   medicinecategorymaster (nolock) A 
                           WHERE  A.mcm_name = @MedCategory) 
              BEGIN 
				IF(@MedCategory IS NOT NULL)
				  BEGIN
						SELECT @Mm_McmId = Isnull(Max(mcm_id), 0) + 1 
						FROM   medicinecategorymaster (nolock) 
						
						INSERT INTO medicinecategorymaster 
						            (mcm_id, 
						             mcm_code, 
						             mcm_name, 
						             mcm_isactive, 
						             mcm_syncdt, 
						             mcm_createdby, 
						             mcm_createddt, 
						             mcm_issync, 
						             mcm_issysgen) 
						VALUES      (@Mm_McmId, 
						             @MedCategoryCode, 
						             @MedCategory, 
						             1, 
						             Getdate(), 
						             -1, 
						             Getdate(), 
						             1, 
						             1) 
				  END
              END 
            ELSE 
              BEGIN 
                  SELECT TOP (1) @Mm_McmId = A.mcm_id 
                  FROM   medicinecategorymaster (nolock) A 
                  WHERE  A.mcm_name = @MedCategory 
              END 

            IF NOT EXISTS (SELECT * 
                           FROM   uommaster (nolock) A 
                           WHERE  A.uom_name = @MedSalesUOM) 
              BEGIN 
				IF(@MedSalesUOM IS NOT NULL)
				  BEGIN
						SELECT @Mm_StkUom = Isnull(Max(A.uom_id), 0) + 1
						FROM   uommaster (nolock) A 
						INSERT INTO uommaster 
						            (uom_id, 
						             uom_code, 
						             uom_name, 
						             uom_isactive, 
						             uom_createddate, 
						             uom_createdby, 
						             uom_issysgen, 
						             uom_issync) 
						VALUES      (@Mm_StkUom, 
						             @MedSalesUOM, 
						             @MedSalesUOM, 
						             1, 
						             Getdate(), 
						             -1, 
						             1, 
						             1) 
				  END
              END 
            ELSE 
              BEGIN 
                  SELECT TOP (1) @Mm_StkUom = A.uom_id 
                  FROM   uommaster (nolock) A 
                  WHERE  A.uom_name = @MedSalesUOM 
              END 

            IF NOT EXISTS (SELECT * 
                           FROM   uommaster (nolock) A 
                           WHERE  A.uom_name = @MedPurchaseUOM) 
              BEGIN 
				IF(@MedPurchaseUOM IS NOT NULL)
				  BEGIN
						SELECT @MM_PurchaseUom = Isnull(Max(A.uom_id), 0) + 1 
						FROM   uommaster (nolock)A 
						INSERT INTO uommaster 
						            (uom_id, 
						             uom_code, 
						             uom_name, 
						             uom_isactive, 
						             uom_createddate, 
						             uom_createdby) 
						VALUES      (@MM_PurchaseUom, 
						             @MedPurchaseUOM, 
						             @MedPurchaseUOM, 
						             1, 
						             Getdate(), 
						             -1) 
				  END
              END 
            ELSE 
              BEGIN 
                  SELECT TOP (1) @MM_PurchaseUom = A.uom_id 
                  FROM   uommaster (nolock) A 
                  WHERE  A.uom_name = @MedPurchaseUOM 
              END 

            DECLARE @CheckIsDpos BIT = NULL; 

            SELECT @CheckIsDpos = isfordpos 
            FROM   configurationmaster (nolock) 

            SELECT @Mm_ID = mm_id 
            FROM   medicinemaster (nolock) 
            WHERE  mm_code = @Mm_Code 

            IF ( @Mm_ID = 0 ) 
              BEGIN 
				 SELECT @Mm_ID = Isnull(Max(mm_id), 0) + 1 
                 FROM   medicinemaster(nolock); 
                  IF( @CheckIsDpos = 'TRUE' ) 
                    BEGIN 
                        INSERT INTO [dbo].[medicinemaster] 
                                    (mm_id, 
                                     mm_code, 
                                     mm_name, 
                                     mm_searchkey, 
                                     mm_saltname, 
                                     mm_hsncode, 
                                     mm_mtmid, 
                                     mm_mgmid, 
                                     mm_mcmid, 
                                     mm_salerate, 
                                     mm_purrate, 
                                     mm_mrp, 
                                     mm_stkuom, 
                                     mm_isactive, 
                                     mm_sapcode, 
                                     mm_purchaseuom, 
                                     mm_purchaseratio, 
                                     mm_salesratio, 
                                     mm_packsize, 
                                     mm_maintainqc, 
                                     mm_fixedasset, 
                                     mm_maintainexp, 
                                     mm_sales, 
                                     mm_isstockable, 
                                     mm_isinventory, 
                                     mm_issync, 
                                     mm_lastsyncdate, 
                                     mm_issysgen, 
                                     mm_createdby, 
                                     mm_createddate,
									 Mm_Primary_Size,
									 Mm_Second_Size,
									 Mm_Tertairy_Size,
									 Mm_Schedule
									 ) 
                        SELECT @Mm_ID, 
                               @Mm_Code, 
                               @Mm_Name, 
                               @Mm_Name, 
                               @Mm_Name, 
                               @Mm_HsnCode, 
                               @Mm_MtmId, 
                               @Mm_MgmId, 
                               @Mm_McmId, 
                               @Mm_SaleRate, 
                               @Mm_PurRate, 
                               @Mm_MRP, 
                               @MM_PurchaseUom, 
                               @Mm_IsActive AS Mm_IsActive, 
                               @Mm_SapCode, 
                               @MM_PurchaseUom, 
                               @MM_PurchaseRatio, 
                               @MM_PurchaseRatio, 
                               @MM_PackSize, 
                               1 AS Mm_MaintainQc, 
                               0 AS Mm_FixedAsset, 
                               1 AS Mm_MaintainExp, 
                               1 AS Mm_Sales, 
                               1 AS Mm_IsStockable, 
                               1 AS Mm_IsInventory, 
                               1 AS Mm_IsSync, 
                               @MM_UPDATED_DATE, 
                               1, 
                               -1, 
                               Getdate() ,
								@Mm_Primary_Size,
								@Mm_Second_Size,
								@Mm_Tertairy_Size,
								@Mm_Schedule
                    END 
                  ELSE 
                    BEGIN 
						IF(@Mm_Name IS NOT NULL)
							BEGIN
								INSERT INTO [dbo].[medicinemaster] 
								            (mm_id, 
								             mm_code, 
								             mm_name, 
								             mm_searchkey, 
								             mm_saltname, 
								             mm_hsncode, 
								             mm_mtmid, 
								             mm_mgmid, 
								             mm_mcmid, 
								             mm_salerate, 
								             mm_purrate, 
								             mm_mrp, 
								             mm_stkuom, 
								             mm_isactive, 
								             mm_sapcode, 
								             mm_purchaseuom, 
								             mm_purchaseratio, 
								             mm_salesratio, 
								             mm_packsize, 
								             mm_maintainqc, 
								             mm_fixedasset, 
								             mm_maintainexp, 
								             mm_sales, 
								             mm_isstockable, 
								             mm_isinventory, 
								             mm_issync, 
								             mm_lastsyncdate, 
								             mm_issysgen, 
								             mm_createdby, 
								             mm_createddate,
											 Mm_Primary_Size,
											Mm_Second_Size,
											Mm_Tertairy_Size,
											Mm_Schedule) 
								SELECT @Mm_ID, 
								       @Mm_Code, 
								       @Mm_Name, 
								       @Mm_Name, 
								       @Mm_Name, 
								       @Mm_HsnCode, 
								       @Mm_MtmId, 
								       @Mm_MgmId, 
								       @Mm_McmId, 
								       @Mm_SaleRate, 
								       @Mm_PurRate, 
								       @Mm_MRP, 
								       @Mm_StkUom, 
								       @Mm_IsActive AS Mm_IsActive,
								       @Mm_SapCode, 
								       @MM_PurchaseUom, 
								       @MM_PurchaseRatio, 
								       @MM_SalesRatio, 
								       @MM_PackSize, 
								       1 AS Mm_MaintainQc, 
								       0 AS Mm_FixedAsset, 
								       1 AS Mm_MaintainExp, 
								       1 AS Mm_Sales, 
								       1 AS Mm_IsStockable, 
								       1 AS Mm_IsInventory, 
								       1 AS Mm_IsSync, 
								       @MM_UPDATED_DATE, 
								       1, 
								       -1, 
								       Getdate(),
								
									    @Mm_Primary_Size,
										@Mm_Second_Size,
										@Mm_Tertairy_Size,
										@Mm_Schedule
							END
                    END 
              END 
            ELSE 
              BEGIN 
                  IF( @CheckIsDpos = 'TRUE' ) 
                    BEGIN 
                        UPDATE medicinemaster 
                        SET    mm_name = @Mm_Name, 
                               mm_hsncode = @Mm_HsnCode, 
                               mm_mtmid = @Mm_MtmId, 
                               mm_mgmid = @Mm_MgmId, 
                               mm_mcmid = @Mm_McmId, 
                               mm_salerate = @Mm_SaleRate, 
                               mm_purrate = @Mm_PurRate, 
                               mm_mrp = @Mm_MRP, 
                               mm_stkuom = @MM_PurchaseUom, 
                               mm_isactive = @Mm_IsActive, 
                               mm_sapcode = @Mm_SapCode, 
                               mm_updatedby = @Mm_User, 
                               mm_updateddate = Getdate(), 
                               mm_purchaseuom = @MM_PurchaseUom, 
                               mm_purchaseratio = @MM_PurchaseRatio, 
                               mm_salesratio = @MM_PurchaseRatio, 
                               mm_issync = 1, 
                               mm_lastsyncdate = @MM_UPDATED_DATE, 
                               mm_packsize = @MM_PackSize ,
							   Mm_Primary_Size=@Mm_Primary_Size,
								Mm_Second_Size=@Mm_Second_Size,
								Mm_Tertairy_Size=@Mm_Tertairy_Size,
								Mm_Schedule=@Mm_Schedule
                        WHERE  mm_id = @Mm_ID 
                    END 
                  ELSE 
                    BEGIN 
                        UPDATE	medicinemaster 
                        SET		mm_name = @Mm_Name, 
								mm_hsncode = @Mm_HsnCode, 
								mm_mtmid = @Mm_MtmId, 
								mm_mgmid = @Mm_MgmId, 
								mm_mcmid = @Mm_McmId, 
								mm_salerate = @Mm_SaleRate, 
								mm_purrate = @Mm_PurRate, 
								mm_mrp = @Mm_MRP, 
								mm_stkuom = @Mm_StkUom, 
								mm_isactive = @Mm_IsActive, 
								mm_sapcode = @Mm_SapCode, 
								mm_updatedby = @Mm_User, 
								mm_updateddate = Getdate(), 
								mm_purchaseuom = @MM_PurchaseUom, 
								mm_purchaseratio = @MM_PurchaseRatio, 
								mm_salesratio = @MM_SalesRatio, 
								mm_issync = 1, 
								mm_lastsyncdate = @MM_UPDATED_DATE, 
								mm_packsize = @MM_PackSize,

								Mm_Primary_Size=@Mm_Primary_Size,
								Mm_Second_Size=@Mm_Second_Size,
								Mm_Tertairy_Size=@Mm_Tertairy_Size,
								Mm_Schedule=@Mm_Schedule
                        WHERE	mm_id = @Mm_ID 
                    END 
              END 

            ---SGST   
            IF NOT EXISTS(SELECT * 
                          FROM   medicinewisetaxmaster A 
                          WHERE  A.mtm_mmid = @Mm_ID 
                                 AND A.mtm_taxid = 2) 
              BEGIN 
                  SELECT @Mtm_Id = Isnull(Max(mtm_id), 0) + 1 
                  FROM   medicinewisetaxmaster (nolock) 

                  INSERT INTO medicinewisetaxmaster 
                              (mtm_id, 
                               mtm_mmid, 
                               mtm_taxid, 
                               mtm_taxvalue) 
                  VALUES     (@Mtm_Id, 
                              @Mm_ID, 
                              2, 
                              CONVERT(NUMERIC(5, 2), @Mtm_TaxValue / 2)) 
              END 
            ELSE 
              BEGIN 
                  UPDATE medicinewisetaxmaster 
                  SET    mtm_taxvalue = @Mtm_TaxValue / 2 
                  WHERE  mtm_mmid = @Mm_ID 
                         AND mtm_taxid = 2 
              END 

            ---CGST   
            IF NOT EXISTS(SELECT * 
                          FROM   medicinewisetaxmaster (nolock) A 
                          WHERE  A.mtm_mmid = @Mm_ID 
                                 AND A.mtm_taxid = 3) 
              BEGIN 
                  SELECT @Mtm_Id = Isnull(Max(mtm_id), 0) + 1 
                  FROM   medicinewisetaxmaster (nolock) 

                  INSERT INTO medicinewisetaxmaster 
                              (mtm_id, 
                               mtm_mmid, 
                               mtm_taxid, 
                               mtm_taxvalue) 
                  VALUES     (@Mtm_Id, 
                              @Mm_ID, 
                              3, 
                              CONVERT(NUMERIC(5, 2), @Mtm_TaxValue / 2)) 
              END 
            ELSE 
              BEGIN 
                  UPDATE medicinewisetaxmaster 
                  SET    mtm_taxvalue = @Mtm_TaxValue / 2 
                  WHERE  mtm_mmid = @Mm_ID 
                         AND mtm_taxid = 3 
              END 

            ---IGST   
            IF NOT EXISTS(SELECT * 
                          FROM   medicinewisetaxmaster (nolock) A 
                          WHERE  A.mtm_mmid = @Mm_ID 
                                 AND A.mtm_taxid = 4) 
              BEGIN 
                  SELECT @Mtm_Id = Isnull(Max(mtm_id), 0) + 1 
                  FROM   medicinewisetaxmaster (nolock) 

                  INSERT INTO medicinewisetaxmaster 
                              (mtm_id, 
                               mtm_mmid, 
                               mtm_taxid, 
                               mtm_taxvalue) 
                  VALUES     (@Mtm_Id, 
                              @Mm_ID, 
                              4, 
                              CONVERT(NUMERIC(5, 2), @Mtm_TaxValue)) 
              END 
            ELSE 
              BEGIN 
                  UPDATE medicinewisetaxmaster 
                  SET    mtm_taxvalue = @Mtm_TaxValue 
                  WHERE  mtm_mmid = @Mm_ID 
                         AND mtm_taxid = 4 
              END 
        --end   
        END 
  END; 
GO
/****** Object:  StoredProcedure [dbo].[SP_MedicineTypeMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_MedicineTypeMaster] 
@SP_STATUS varchar(200)= '',
@Mtm_ID int = 0,
@Mtm_TypeCode varchar(200) = NULL,
@Mtm_TypeName varchar(500) = NULL,
@Mtm_IsActive bit = 0,
@Mtm_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
	BEGIN
	SELECT COUNT(*) CountOf
	FROM MedicineTypeMaster(NOLOCK)
	WHERE (
	Mtm_TypeCode = @Mtm_TypeCode
	OR Mtm_TypeName = @Mtm_TypeName
	)
	AND Mtm_ID <> @Mtm_ID;
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Mtm_ID = ISNULL(MAX(Mtm_ID),0) + 1
	FROM MedicineTypeMaster(NOLOCK);
	INSERT INTO [dbo].[MedicineTypeMaster]([Mtm_TypeCode],
	[Mtm_TypeName],
	[Mtm_CreatedBy],
	[Mtm_CreatedDt],
	[Mtm_IsActive]) VALUES
	(@Mtm_TypeCode,@Mtm_TypeName,@Mtm_User,GETDATE(),@Mtm_IsActive);
	END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
	UPDATE [dbo].[MedicineTypeMaster]
	SET	[Mtm_TypeCode] = @Mtm_TypeCode,
			[Mtm_TypeName] = @Mtm_TypeName,
			[Mtm_UpdatedBy] = @Mtm_User,
			[Mtm_UpdatedDt] = GETDATE(),
			[Mtm_IsActive] = @Mtm_IsActive
	WHERE Mtm_ID = @Mtm_ID;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	--BEGIN
	--  DELETE FROM MedicineTypeMaster
	--  WHERE Mtm_ID = @Mtm_ID;
	--END;
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'MedicineTypeMaster',
									@Mtm_ID,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		DELETE FROM MedicineTypeMaster
		WHERE Mtm_ID = @Mtm_ID;
		END
	END
	ELSE IF @SP_STATUS = 'Fillgrid'
	BEGIN
	SELECT	MTM.Mtm_ID,
				MTM.Mtm_TypeCode,
				MTM.Mtm_TypeName,
				MTM.Mtm_CreatedBy,
				MTM.Mtm_CreatedDt,
				MTM.Mtm_UpdatedBy,
				MTM.Mtm_UpdatedDt,
				--MTM.Mtm_IsActive,
				CASE
					WHEN MTM.Mtm_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END			AS Mtm_IsActive,
				MTM.Mtm_IsSysGen,
				MTM.Mtm_IsSync,
				MTM.Mtm_SyncDt,
				C.User_Name	AS mtm_UserName
	FROM MedicineTypeMaster(NOLOCK) AS MTM
	LEFT JOIN UserMaster C
		ON MTM.Mtm_CreatedBy = C.User_ID;
	END;


	ELSE IF @SP_STATUS = 'Fillgrid_dpos'
	BEGIN
	SELECT	MTM.Mtm_ID,
				MTM.Mtm_TypeCode,
				MTM.Mtm_TypeName,
				MTM.Mtm_CreatedBy,
				MTM.Mtm_CreatedDt,
				MTM.Mtm_UpdatedBy,
				MTM.Mtm_UpdatedDt,
				--MTM.Mtm_IsActive,
				CASE
					WHEN MTM.Mtm_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END			AS Mtm_IsActive,
				MTM.Mtm_IsSysGen,
				MTM.Mtm_IsSync,
				MTM.Mtm_SyncDt,
				C.User_Name	AS mtm_UserName
	FROM MedicineTypeMaster(NOLOCK) AS MTM
	LEFT JOIN UserMaster C
		ON MTM.Mtm_CreatedBy = C.User_ID
		where  	MTM.Mtm_ID!= 2  
	END;
	ELSE IF @SP_STATUS = 'FillHelp'
	BEGIN
	SELECT	Mtm_ID			AS hc_Mtm_ID,
				Mtm_TypeCode	AS hc_Mtm_TypeCode,
				Mtm_TypeName	AS hc_Mtm_TypeName
	FROM MedicineTypeMaster(NOLOCK)
	WHERE Mtm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'FillHelp_OTHER'
	BEGIN
	SELECT	Mtm_ID			AS hc_Mtm_ID,
				Mtm_TypeCode	AS hc_Mtm_TypeCode,
				Mtm_TypeName	AS hc_Mtm_TypeName
	FROM MedicineTypeMaster(NOLOCK)
	WHERE Mtm_IsActive = 1 AND Mtm_ID!=1;
	END;
	ELSE IF @SP_STATUS = 'FillHelp_Dpos'
	BEGIN
	SELECT	Mtm_ID			AS hc_Mtm_ID,
				Mtm_TypeCode	AS hc_Mtm_TypeCode,
				Mtm_TypeName	AS hc_Mtm_TypeName
	FROM MedicineTypeMaster(NOLOCK)
	WHERE Mtm_IsActive = 1 AND Mtm_ID!=2;
	END;

END;
GO
/****** Object:  StoredProcedure [dbo].[SP_OpeningSalesPurchase]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_OpeningSalesPurchase]
@SP_STATUS	               VARCHAR(199)='',
@ID [NUMERIC](18, 0) = 0 OUT,
@Ope_ID                    INT=0       ,
@Ope_FromDate              DATETIME=NULL  ,
@Ope_ToDate                DATETIME=NULL  ,
@Ope_SalesAmt              NUMERIC(18,2)=0,
@Ope_PurchaseAmt           NUMERIC(18,2)=0,
@Ope_UserId                INT=0          ,
@Ope_IsSync                BIT='false'                    
AS
BEGiN
	iF @SP_STATUS='DUPLICATE'
		BEGiN
		     DECLARE @COUNT INT
			 IF(@Ope_ID>0)
			 BEGIN
			      SET @COUNT=(SELECT COUNT(*) 
			                     FROM (SELECT Ope_ID,  
				                             (CASE WHEN CONVERT(DATE,Ope_fromDate)>CONVERT(DATE,@Ope_fromDate) 
									               THEN (CASE WHEN CONVERT(DATE,Ope_fromDate)>CONVERT(DATE,@Ope_ToDate)
									                          THEN 'false' 
									         			   ELSE 'true' 
									         	       END) 
									               ELSE (CASE WHEN  CONVERT(DATE,Ope_fromDate)<CONVERT(DATE,@Ope_fromDate) 
									         	           THEN (CASE WHEN CONVERT(DATE,Ope_ToDate)<CONVERT(DATE,@Ope_fromDate)
									         			              THEN 'false'
									         						  ELSE 'true' 
									         			         END)
									         			   ELSE 
									         			         'true' 
									                    END)
									            END)AS Status
			                           FROM OpeningSalesPurchase)AS DT
			             WHERE  Ope_ID!=@Ope_ID AND  Status='true');
			 END
			 ELSE
			 BEGIN
			  SET @COUNT=(SELECT COUNT(*) 
			                     FROM (SELECT Ope_ID,  
				                             (CASE WHEN CONVERT(DATE,Ope_fromDate)>CONVERT(DATE,@Ope_fromDate) 
									               THEN (CASE WHEN CONVERT(DATE,Ope_fromDate)>CONVERT(DATE,@Ope_ToDate)
									                          THEN 'false' 
									         			   ELSE 'true' 
									         	       END) 
									               ELSE (CASE WHEN  CONVERT(DATE,Ope_fromDate)<CONVERT(DATE,@Ope_fromDate) 
									         	           THEN (CASE WHEN CONVERT(DATE,Ope_ToDate)<CONVERT(DATE,@Ope_fromDate)
									         			              THEN 'false'
									         						  ELSE 'true' 
									         			         END)
									         			   ELSE 
									         			         'true' 
									                    END)
									            END)AS Status
			                           FROM OpeningSalesPurchase)AS DT
			             WHERE Status='true');
			 END
		     
			SELECT @ID=@COUNT;
		END;
	ELSE
	iF @SP_STATUS='INSERT'
		BEGiN
		     SELECT @Ope_ID = ISNULL(MAX(Ope_ID),0) + 1
			   FROM OpeningSalesPurchase(NOLOCK);
		     INSERT INTO OpeningSalesPurchase
			 (Ope_ID,
			  Ope_FromDate,
			  Ope_ToDate,
			  Ope_SalesAmt,
			  Ope_PurchaseAmt,
			  Ope_CreatedBy,
			  Ope_CreatedDt,
			  Ope_IsSync)
			  VALUES
			  (@Ope_ID,
			   @Ope_FromDate,
			   @Ope_ToDate,
			   @Ope_SalesAmt,
			   @Ope_PurchaseAmt,
			   @Ope_UserId,
			   GETDATE(),
			   'false'
			  )
			SELECT @ID=@Ope_ID;
		END;
    ELSE
	iF @SP_STATUS='UPDATE'
		BEGiN
		     UPDATE OpeningSalesPurchase
			    SET Ope_FromDate=@Ope_FromDate,
			        Ope_ToDate=@Ope_ToDate,
			        Ope_SalesAmt=@Ope_SalesAmt,
			        Ope_PurchaseAmt=@Ope_PurchaseAmt,
			        Ope_UpdatedBy=@Ope_UserId,
			        Ope_UpdatedDt=GETDATE()
			  WHERE Ope_ID=@Ope_ID;
			SELECT @ID=@Ope_ID;
		END
	ELSE IF @SP_STATUS = 'DELETE'
		BEGIN
		      DELETE  
			    FROM OpeningSalesPurchase
			   WHERE Ope_ID = @Ope_ID;
			   SELECT @ID=@Ope_ID;
		END;
    ELSE
	IF @SP_STATUS = 'SYNCH'
		BEGIN
		      UPDATE OpeningSalesPurchase 
			     SET Ope_IsSync='true'
			   WHERE Ope_ID = @Ope_ID;
		END;
    ELSE
	iF @SP_STATUS='FillGrid'
		BEGiN
			SELECT	Ope_ID,
					Ope_fromDate,
					Ope_Todate,
					ISNULL(A.Ope_SalesAmt,0) AS Ope_SalesAmt,
					ISNULL(A.Ope_PurchaseAmt,0) AS Ope_PurchaseAmt,
					ISNULL(A.Ope_IsSync,0) AS Ope_IsSync,
					(CASE WHEN ISNULL(Ope_IsSync,'false')='false' THEN 'true' ELSE 'false' END)AS Ope_Enabled
			FROM	OpeningSalesPurchase A
		END
END



GO
/****** Object:  StoredProcedure [dbo].[SP_PatientMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
CREATE PROCEDURE [dbo].[SP_PatientMaster]  
 @SP_STATUS varchar(200) = '',  
@Pm_Id int = 0,  
@Pm_Fullname varchar(250) = '',  
@Pm_Gender int = 0,  
@Pm_Dob datetime = NULL,  
@Pm_Mob varchar(12) = '',  
@Pm_EmailId nvarchar(199) = '',  
@Pm_Address nvarchar(1000) = '',  
@Pm_IsActive bit = 0,  
@Pm_User int = 0,  
@pm_AadharNo varchar(30) = '',  
@StateId  int = 0,  
@StoreCode  nvarchar(50)='',  
@Store_Name  nvarchar(50) ='',  
@Contact_PersonName nvarchar(150) = '',  
@StoreId   int = 0,  
@Gst_no   nvarchar(50) = '',  
@Gst_Date datetime = null,  
@Drug_Lic  nvarchar(50) = '',  
@Drug_Lic_Date datetime = null,  
@ID int = 0 OUT,  
@State_Name VARCHAR(500)='' ,
@Pm_PanNo   nvarchar(200)  = ''
 
AS  
BEGIN  
 IF @SP_STATUS = 'DublicateCount'  
 BEGIN  
 SELECT COUNT(*) CountOf  
 FROM PatientMaster(NOLOCK)  
 WHERE (  
 Pm_Fullname = @Pm_Fullname  
 OR Pm_Mob = @Pm_Mob  
 )  
 AND Pm_Id <> @Pm_Id;  
 END;  
 ELSE IF @SP_STATUS = 'DublicateCountNew'  
 BEGIN  
 SELECT COUNT(*) CountOf  
 FROM PatientMaster(NOLOCK)  
 WHERE Pm_Fullname = @Pm_Fullname  
 AND Pm_Id <> @Pm_Id  
 END;  
 ELSE IF @SP_STATUS = 'DublicateMobile'  
 BEGIN  
 SELECT COUNT(*) CountOf  
 FROM PatientMaster(NOLOCK)  
 WHERE Pm_Mob = @Pm_Mob  
 AND Pm_Id <> @Pm_Id  
 AND ISNULL(Pm_Mob,'') <> ''  
 END;  
 ELSE IF @SP_STATUS = 'DublicateAdharNo'  
 BEGIN  
 SELECT COUNT(*) CountOf  
 FROM PatientMaster(NOLOCK)  
 WHERE pm_AadharNo = @pm_AadharNo  
 AND Pm_Id <> @Pm_Id  
 AND ISNULL(pm_AadharNo,'') <> ''  
 END;  
 ELSE IF @SP_STATUS = 'Insert'  
 BEGIN  
 SELECT @Pm_Id = ISNULL(MAX(Pm_Id),0) + 1  
 FROM PatientMaster(NOLOCK);  
 SELECT @StoreId = Store_Id, @Store_Name=Store_Name,@StateId=Store_StateId --,@StoreCode=Store_Code   
 FROM StoreMaster (nolock) sm  
  
 INSERT INTO [dbo].[PatientMaster](Pm_Id,  
 Pm_Fullname,Pm_Address,Pm_Gender,Pm_Dob,Pm_EmailId,Pm_Mob,Pm_CreatedBy,Pm_CreatedDate,  
 Pm_IsActive,  
 pm_AadharNo,  
 --Store_Name,  
 StateId,  
 StoreCode,  
 Contact_PersonName,  
 StoreId,  
 Gst_no    
 ,Gst_Date   
 ,Drug_Lic   
 ,Drug_Lic_Date ,
 Pm_PanNo  
 ) VALUES  
 (@Pm_Id,@Pm_Fullname,@Pm_Address,@Pm_Gender,@Pm_Dob,@Pm_EmailId,@Pm_Mob,@Pm_User,GETDATE(),@Pm_IsActive,@pm_AadharNo,@StateId,@StoreCode,@Contact_PersonName,@StoreId  
 ,@Gst_no    
 ,@Gst_Date   
 ,@Drug_Lic   
 ,@Drug_Lic_Date  
 ,@Pm_PanNo 
 );  
 SELECT @ID = @Pm_Id;  
 END;  
 ELSE IF @SP_STATUS = 'Update'  
 BEGIN  
  
 SELECT @StoreId = Store_Id, @Store_Name=Store_Name,@StateId=Store_StateId --,@StoreCode=Store_Code   
 FROM StoreMaster (nolock) sm  
  
 UPDATE [dbo].[PatientMaster]  
 SET Pm_Fullname = @Pm_Fullname,  
   Pm_Gender = @Pm_Gender,  
   Pm_Address = @Pm_Address,  
   Pm_Dob = @Pm_Dob,  
   Pm_Mob = @Pm_Mob,  
   Pm_EmailId = @Pm_EmailId,  
   Pm_UpdatedBy = @Pm_User,  
   Pm_UpdatedDate = GETDATE(),  
   Pm_IsActive = @Pm_IsActive,  
   pm_AadharNo = @pm_AadharNo  
   ,StateId = @StateId,  
   StoreCode = @StoreCode,  
   Contact_PersonName = @Contact_PersonName,  
   Gst_no =@Gst_no   
   ,Gst_Date =@Gst_Date  
   ,Drug_Lic =@Drug_Lic  
   ,Drug_Lic_Date =@Drug_Lic_Date
   ,Pm_PanNo=@Pm_PanNo 
   ,StoreId = @StoreId  
 WHERE Pm_Id = @Pm_Id;  
 SELECT @ID = @Pm_Id;  
 END;  
 ELSE IF @SP_STATUS = 'Delete'  
 --BEGIN  
 --  DELETE FROM [PatientMaster]  
 --  WHERE Pm_Id = @Pm_Id;  
 --END;  
 BEGIN  
 DECLARE @MSG_OUT nvarchar(max)  
 EXEC SP_Tbl_Dependency 'PatientMaster',  
         @Pm_Id,  
         @MSG_OUT OUTPUT  
 IF (RTRIM(LTRIM(@MSG_OUT)) <> '')  
  BEGIN  
  RAISERROR (@MSG_OUT,14,9)  
  END  
 ELSE BEGIN  
  DELETE FROM LedgerMaster  
  WHERE Lm_Id = (SELECT  
   Pm_Ledger_Id  
  FROM PatientMaster  
  WHERE pm_Id = @Pm_Id)  
  DELETE FROM [PatientMaster]  
  WHERE Pm_Id = @Pm_Id;  
  END  
 END  
 ELSE IF @SP_STATUS = 'Fillgrid'  
 BEGIN  
 SELECT PM.Pm_Id,  
    PM.Pm_Fullname,  
    PM.Pm_Address,  
    CONVERT(date,Pm_Dob,101) AS Pm_Dob,  
    PM.Pm_Mob,  
    PM.Pm_EmailId,  
    PM.Pm_CreatedBy,  
    PM.Pm_CreatedDate,  
    --PM.Pm_IsActive,  
    CASE  
     WHEN PM.Pm_IsActive = 1 THEN 'Yes'  
     ELSE 'No'  
    END        AS Pm_IsActive,  
    UM.User_Name     AS Pm_User,  
    CASE  
     WHEN PM.Pm_Gender = 1 THEN 'Male'  
     WHEN PM.Pm_Gender = 2 THEN 'Female'  
    END        AS Pm_Gender,  
    pm_AadharNo,  
    Pm_Ledger_Id,  
    Contact_PersonName,  
    StoreCode  
    ,Gst_no  
    ,Gst_Date  
    ,Drug_Lic  
    ,Drug_Lic_Date ,
	Pm_PanNo,
	STATE.State_Name AS StateName
 FROM PatientMaster PM (NOLOCK)  
 LEFT JOIN dbo.UserMaster UM (NOLOCK)  

  ON PM.Pm_CreatedBy = UM.User_ID
 LEFT JOIN StateMaster STATE 
  ON STATE.State_ID=PM.StateId   
 END;  
 ELSE IF @SP_STATUS = 'FillPatient'  
  BEGIN  
   SELECT 0 AS Pm_Id,  
      '' AS Pm_Fullname  
   UNION  
   SELECT Pm_Id,  
      Pm_Fullname  
   FROM dbo.PatientMaster(NOLOCK)  
   WHERE Pm_IsActive = 1;  
  END;  
  
 ELSE iF @SP_STATUS='GET_PATIENT_LIST_SYNC'  
	BEGiN  
		SELECT  TOP(300)
				(SELECT TOP(1) Store_Code FROM StoreMaster) AS Store_Code,
				A.*  
		FROM	PatientMaster A
		WHERE	ISNULL(A.Pm_IsSync,0)=0
	END  

ELSE iF @SP_STATUS='UPDATE_PATIENT_SYNC_STATUS'
	BEGiN
		UPDATE	PatientMaster
		SET		Pm_IsSync=1
		WHERE	Pm_Id=@Pm_Id
	END
 ---======================================cPOS Sync============================================  
 ELSE IF @SP_STATUS = 'Insert-cPOS'  
 BEGIN  
  
  SELECT TOP(1)   
    @StateId=State_ID  
  FROM StateMaster A  
  WHERE A.State_Name=@State_Name  
  if not exists(select * from PatientMaster Where PatientMaster.StoreCode=@StoreCode)  
   begin  
  
    SELECT @Pm_Id = ISNULL(MAX(Pm_Id),0) + 1   
    FROM PatientMaster(NOLOCK);  
    INSERT INTO [dbo].[PatientMaster](Pm_Id,  
     Pm_Fullname,Pm_Address,Pm_Gender,Pm_Dob,Pm_EmailId,Pm_Mob,Pm_CreatedBy,Pm_CreatedDate,  
     Pm_IsActive,  
     pm_AadharNo,  
     --Store_Name,  
     StateId,  
     StoreCode,  
     Contact_PersonName,  
     StoreId,  
     Gst_no    
     ,Gst_Date   
     ,Drug_Lic   
     ,Drug_Lic_Date   
    ) VALUES  
    ( @Pm_Id,@Pm_Fullname+'('+@StoreCode+')',@Pm_Address,@Pm_Gender,@Pm_Dob,@Pm_EmailId,@Pm_Mob,@Pm_User,GETDATE(),@Pm_IsActive,@pm_AadharNo,@StateId,  
     @StoreCode,@Contact_PersonName,@StoreId  
     ,@Gst_no    
     ,@Gst_Date   
     ,@Drug_Lic   
     ,@Drug_Lic_Date   
    );  
    SET @ID = @Pm_Id;  
   end  
  else  
   begin  
    SELECT @ID=A.Pm_Id  
    FROM PatientMaster A  
    WHERE A.StoreCode=@StoreCode  
    UPDATE PatientMaster  
    SET  Pm_Fullname=@Pm_Fullname+'('+@StoreCode+')',  
      Pm_Address=@Pm_Address,  
      Pm_EmailId=@Pm_EmailId,  
      Pm_Mob=@Pm_Mob,  
      Pm_CreatedBy=@Pm_User,  
      Pm_CreatedDate=GETDATE(),  
      Pm_IsActive=1,  
      pm_AadharNo=@pm_AadharNo,  
      StateId=@StateId,  
      Contact_PersonName=@Contact_PersonName,  
      Gst_no=@Gst_no,  
      Gst_Date=@Gst_Date,  
      Drug_Lic=@Drug_Lic,  
      Drug_Lic_Date=@Drug_Lic_Date  
    WHERE StoreCode=@StoreCode  
   end  
 END;  
END;  
  
  
GO
/****** Object:  StoredProcedure [dbo].[SP_PurchaseIndent]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- exec  [dbo].[SP_PurchaseIndent]  @SP_STATUS ='CHECK_DEPENDENCY_EXIST' ,  @Indd_ItmName ='1,2,11'
CREATE PROCEDURE [dbo].[SP_PurchaseIndent]
--========INDENT HEADER=================
@SP_STATUS varchar(200) = '',
@USER int = 0,
@Ind_Key numeric(18,0) = 0,
@Ind_No numeric(18,0) = 0,
@Ind_Date datetime = NULL,
@Ind_RefNo nvarchar(50) = '',
@Ind_RefDate datetime = NULL,
@Ind_Type int = 0,
@Ind_Purpose int = 0,
@Ind_Category int = 0,
@Ind_Department int = 0,
@Ind_Status int = 0,
@Ind_ReqBy int = 0,
@Ind_AppBy int = 0,
@Ind_AppDt datetime = NULL,
@Ind_AuthBy int = 0,
@Ind_AuthDt datetime = NULL,
@Ind_Remarks varchar(max) = '',
@Ind_BmId int = 0,
@Ind_YearId int = 0,
@Ind_StartDate datetime = NULL,
@Ind_EndDate datetime = NULL,
--==============INDENT ITEM DETAILS==============
@Indd_Key numeric(18,0) = 0,
@Indd_IndKey numeric(18,0) = 0,
@Indd_SrNo int = 0,
@Indd_ItmId NUMERIC(18,0) = 0,
@Indd_ItmCode nvarchar(50) = '',
@Indd_ItmName varchar(500) = '',
@Indd_CurStk numeric(18,3) = 0,
@Indd_Qty numeric(18,3) = 0,
@Indd_Uom int = 0,
@Indd_LeadTime int = 0,
--=============INDENT_ITEM_SCHEDULE==============
@Inds_Id numeric(18,0) = 0,
@Inds_IndKey numeric(18,0) = 0,
@Inds_InddId nvarchar(50) = '',
@Inds_ItmId numeric(18,0) = 0,
@Inds_Qty numeric(18,0) = 0,
@Inds_Date datetime = NULL,
@Indd_shortCloseQty numeric(18,3) = 0,
@Indd_shortCloseBy int = 0,
@Indd_shortCloseDt datetime = NULL,
@Ind_ApproveStatus varchar(250) = NULL,
@Ind_ApproveStatusRemark nvarchar(500) = NULL,
@ID decimal(18,0) = 0 OUTPUT
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	--=================== BIND FOR INDENT HEADER =====================

	IF @SP_STATUS = 'FILL_COMBO_IND_TYPE'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Indt_Id		AS ID,
				Indt_Name	AS NAME
	FROM IndentTypeMaster(nolock)
	END

	ELSE IF @SP_STATUS = 'FILL_COMBO_IND_PURPOSE'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Indp_Id		AS ID,
				Indp_Name	AS NAME
	FROM IndentPurposeMaster(nolock)
	END
	ELSE IF @SP_STATUS = 'FILL_COMBO_IND_CATEGORY'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Cust_CatId		AS ID,
				Cust_CatName	AS NAME
	FROM CustomerCategoryMaster(nolock)
	END
	ELSE IF @SP_STATUS = 'FILL_COMBO_DEPARTMENT'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Dm_ID		AS ID,
				Dm_Name	AS NAME
	FROM DepartmentMaster(nolock)
	END
	ELSE IF @SP_STATUS = 'FILL_COMBO_STATUS'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Int_StatusId	AS ID,
				Int_StatusName	AS NAME
	FROM InventoryStatusMaster(nolock)
	END
	ELSE IF @SP_STATUS = 'FILL_COMBO_REQUESTBY'
	BEGIN
	SELECT	0					AS ID,
				'--Select--'	AS NAME
	UNION
	SELECT	Emp_Id		AS ID,
				Emp_FName	AS NAME
	FROM EmployeeMaster(nolock)
	END
	--======================INDENT HEADER=======================
	ELSE IF @SP_STATUS = 'AUTO_INDENT_NO'
	BEGIN
	DECLARE @FormPrefix AS nvarchar(max) = '';
	SELECT @FormPrefix = FormPrefix
	FROM FormDetailTable
	WHERE Id = 14
	SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Ind_No,0)))
	FROM IndentHeader(NOLOCK)
	WHERE	IndentHeader.Ind_Date BETWEEN @FROM_DATE AND @TO_DATE
	END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
	BEGIN
	DECLARE @MSG_OUT1 nvarchar(max)

	EXEC [SP_Tbl_Dependency1]	'IndentDetail',
										@Indd_ItmName,
										@MSG_OUT1 OUTPUT

	IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT1,14,9)
		END
	END
	ELSE IF @SP_STATUS = 'INSERT_INDENT'
	BEGIN
	SELECT @Ind_Key = ISNULL(MAX(Ind_Key),0) + 1
	FROM IndentHeader(nolock)

	SELECT @Ind_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Ind_No,0)))
	FROM IndentHeader(NOLOCK)
	WHERE	IndentHeader.Ind_Date BETWEEN @FROM_DATE AND @TO_DATE
	INSERT INTO [dbo].[IndentHeader]([Ind_Key],
	[Ind_No],
	[Ind_Date],
	[Ind_RefNo],
	[Ind_RefDate],
	[Ind_Type],
	[Ind_Purpose],
	[Ind_Category],
	[Ind_Department],
	[Ind_Status],
	[Ind_ReqBy],
	[Ind_AppBy],
	[Ind_AppDt],
	[Ind_AuthBy],
	[Ind_AuthDt],
	[Ind_Remarks],
	[Ind_BmId],
	[Ind_YearId],
	[Ind_CreatedBy],
	[Ind_CreatedDt],Ind_ApproveStatus,Ind_ApproveStatusRemark) VALUES
	(@Ind_Key,@Ind_No,@Ind_Date,@Ind_RefNo,@Ind_RefDate,@Ind_Type,@Ind_Purpose,@Ind_Category,@Ind_Department,@Ind_Status,
	@Ind_ReqBy,@Ind_AppBy,@Ind_AppDt,@Ind_AuthBy,@Ind_AuthDt,@Ind_Remarks,@Ind_BmId,@Ind_YearId,@USER,GETDATE(),@Ind_ApproveStatus,@Ind_ApproveStatusRemark)
	SELECT @ID = @Ind_Key
	END
	ELSE IF @SP_STATUS = 'UPDATE_INDENT'
	BEGIN
	DECLARE @MSG_OUT_update nvarchar(max)
	EXEC SP_Tbl_Dependency	'[IndentHeader]',
									@IND_KEY,
									@MSG_OUT_update OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT_update,14,9)
		END
	ELSE BEGIN
		UPDATE [dbo].[IndentHeader]
		SET	--[Ind_No] = @Ind_No,
		[Ind_Date] = @Ind_Date,
		[Ind_RefNo] = @Ind_RefNo,
		[Ind_RefDate] = @Ind_RefDate,
		[Ind_Type] = @Ind_Type,
		[Ind_Purpose] = @Ind_Purpose,
		[Ind_Category] = @Ind_Category,
		[Ind_Department] = @Ind_Department,
		[Ind_Status] = @Ind_Status,
		[Ind_ReqBy] = @Ind_ReqBy,
		[Ind_AppBy] = @Ind_AppBy,
		[Ind_AppDt] = @Ind_AppDt,
		[Ind_AuthBy] = @Ind_AuthBy,
		[Ind_AuthDt] = @Ind_AuthDt,
		[Ind_Remarks] = @Ind_Remarks,
		[Ind_BmId] = @Ind_BmId,
		[Ind_YearId] = @Ind_YearId,
		[Ind_UpdatedBy] = @USER,
		[Ind_UpdatedDt] = GETDATE(),
		Ind_ApproveStatus = @Ind_ApproveStatus,
		Ind_ApproveStatusRemark = @Ind_ApproveStatusRemark
		WHERE [Ind_Key] = @Ind_Key
		SELECT @ID = @IND_KEY
		DELETE FROM IndentDetail
		WHERE Indd_IndKey = @Ind_Key
		END
	END
	ELSE IF @SP_STATUS = 'GET_INDENT_SCH_SUM'
	BEGIN
	SELECT SUM(Inds_Qty)
	FROM IndentItemSchedule(NOLOCK)
	WHERE Inds_IndKey = @Inds_IndKey
	AND Inds_InddId = @Inds_InddId
	AND Inds_ItmId = @Inds_ItmId
	END
	ELSE IF @SP_STATUS = 'DELETE_INDENT_ITEM'
	BEGIN
	DELETE FROM IndentItemSchedule
	WHERE Inds_IndKey = @Inds_IndKey
		AND Inds_InddId = @Inds_InddId
		AND Inds_ItmId = @Inds_ItmId
	END
	ELSE IF @SP_STATUS = 'DELETE_INDENT'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'IndentHeader',
									@Ind_Key,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		DELETE FROM IndentHeader
		WHERE Ind_Key = @Ind_Key
		DELETE FROM IndentDetail
		WHERE Indd_IndKey = @Ind_Key
		DELETE FROM IndentItemSchedule
		WHERE Inds_IndKey = @Ind_Key
		END
	END
	ELSE IF @SP_STATUS = 'FILL_GRID_INDENT'
	BEGIN
	DECLARE @FormPrefix_Fill_dgv AS nvarchar(max) = '';
	SELECT @FormPrefix_Fill_dgv = FormPrefix
	FROM FormDetailTable
	WHERE Id = 14
	SELECT	A.Ind_Key,
				@FormPrefix_Fill_dgv + CAST(A.Ind_No AS nvarchar(max))	AS Ind_No,
				A.Ind_Date,
				A.Ind_RefNo,
				A.Ind_RefDate,
				A.Ind_Remarks,
				A.Ind_AppBy,
				A.Ind_AppDt,
				A.Ind_AuthBy,
				A.Ind_AuthDt,
				A.Ind_BmId,
				A.IND_CATEGORY,
				A.Ind_CreatedBy,
				A.Ind_CreatedDt,
				A.Ind_Department,
				A.Ind_Purpose,
				A.Ind_ReqBy,
				A.Ind_Status,
				A.Ind_ReqBy,
				A.Ind_UpdatedBy,
				A.Ind_UpdatedDt,
				A.Ind_YearId,
				B.Indp_Name,
				C.Cust_CatName,
				D.Indt_Name,
				E.[User_Name],
				A.Ind_ApproveStatus,
				A.Ind_ApproveStatusRemark
	FROM IndentHeader(nolock) AS A
	LEFT JOIN IndentPurposeMaster(nolock) AS B
		ON A.Ind_Purpose = B.Indp_Id
	LEFT JOIN CustomerCategoryMaster(nolock) AS C
		ON A.Ind_Category = C.Cust_CatId
	LEFT JOIN IndentTypeMaster(nolock) AS D
		ON A.Ind_Type = D.Indt_Id
	LEFT JOIN dbo.UserMaster(nolock) AS E
		ON A.Ind_CreatedBy = E.[User_ID]
	--LEFT JOIN YearMaster(nolock) F
	--	ON F.Year_Id = @Ind_YearId
	----WHERE  	A.Ind_Date 
	----		BETWEEN F.Year_FromDate 
	----		AND F.Year_ToDate
	----		AND Ind_BmId=@Ind_BmId 
	--WHERE Ind_BmId = @Ind_BmId
	WHERE		A.Ind_ApproveStatus=@Ind_ApproveStatus 
			AND CAST(A.Ind_Date AS DATE) BETWEEN @Ind_StartDate AND @Ind_EndDate
	ORDER BY Ind_Key DESC
	END
	IF @SP_STATUS = 'FILL_GRID_INDENT_APPROVAL_SETTING'
	BEGIN
	DECLARE @FormPrefix_Fill_dgv_APP AS nvarchar(max) = '';
	SELECT @FormPrefix_Fill_dgv_APP = FormPrefix
	FROM FormDetailTable
	WHERE Id = 14
	SELECT	A.Ind_Key,
				@FormPrefix_Fill_dgv_APP + CAST(A.Ind_No AS nvarchar(max))	AS Ind_No,
				CAST(A.Ind_Date AS date)												AS ApprovalDate,
				A.Ind_RefNo																	AS RefNo,
				A.Ind_RefDate																AS RefDate,
				A.Ind_Remarks																AS Remark,
				A.Ind_AppBy,
				A.Ind_AppDt,
				A.Ind_AuthBy,
				A.Ind_AuthDt,
				A.Ind_BmId,
				A.IND_CATEGORY,
				A.Ind_CreatedBy,
				A.Ind_CreatedDt,
				A.Ind_Department,
				A.Ind_Purpose,
				A.Ind_ReqBy,
				A.Ind_Status,
				A.Ind_ReqBy,
				A.Ind_UpdatedBy,
				A.Ind_UpdatedDt,
				A.Ind_YearId,
				B.Indp_Name,
				C.Cust_CatName,
				D.Indt_Name,
				E.[User_Name],
				A.Ind_ApproveStatus,
				ISNULL(A.Ind_ApproveStatusRemark,'')								AS Ind_ApproveStatusRemark
	FROM IndentHeader(nolock) AS A
	LEFT JOIN IndentPurposeMaster(nolock) AS B
		ON A.Ind_Purpose = B.Indp_Id
	LEFT JOIN CustomerCategoryMaster(nolock) AS C
		ON A.Ind_Category = C.Cust_CatId
	LEFT JOIN IndentTypeMaster(nolock) AS D
		ON A.Ind_Type = D.Indt_Id
	LEFT JOIN dbo.UserMaster(nolock) AS E
		ON A.Ind_CreatedBy = E.[User_ID]
	WHERE ISNULL(Ind_ApproveStatus,'') IN ('Pending')
	ORDER BY Ind_Key DESC
	END
	ELSE IF @SP_STATUS = 'RETRIVE_INDENT'
	BEGIN
	-----------------------------------INDENT HEADER------------------------------------------	
	DECLARE @FormPrefix_ret AS nvarchar(max) = '';
	SELECT @FormPrefix_ret = FormPrefix
	FROM FormDetailTable
	WHERE Id = 14
	SELECT	A.Ind_Key,
				@FormPrefix_ret + CAST(A.IND_NO AS nvarchar(max))	AS IND_NO,
				A.IND_DATE,
				A.Ind_RefNo,
				A.Ind_RefDate,
				A.IND_REMARKS,
				A.Ind_AppBy,
				A.Ind_AppDt,
				A.Ind_AuthBy,
				A.Ind_AuthDt,
				A.Ind_BmId,
				A.IND_CATEGORY,
				A.Ind_CreatedBy,
				A.Ind_CreatedDt,
				A.IND_DEPARTMENT,
				A.IND_PURPOSE,
				A.Ind_ReqBy,
				A.IND_STATUS,
				A.Ind_ReqBy,
				A.Ind_UpdatedBy,
				A.Ind_UpdatedDt,
				A.Ind_YearId,
				A.IND_TYPE,
				B.INDP_NAME,
				C.Cust_CatName,
				D.INDT_NAME
	FROM IndentHeader(nolock) AS A
	LEFT JOIN IndentPurposeMaster(nolock) AS B
		ON A.IND_PURPOSE = B.INDP_ID
	LEFT JOIN CustomerCategoryMaster(nolock) AS C
		ON A.IND_CATEGORY = C.Cust_CatId
	LEFT JOIN IndentTypeMaster(nolock) AS D
		ON A.IND_TYPE = D.Indt_Id
	WHERE IND_KEY = @IND_KEY
	------------------------------------INDENT DETAIL-----------------------------------------
	--SELECT	A.Indd_IndKey,
	--			A.INDD_KEY,
	--			A.Indd_ItmId,
	--			A.Indd_SrNo,
	--			A.Indd_ItmCode,
	--			A.Indd_ItmName,
	--			A.Indd_Qty,
	--			A.Indd_Uom,
	--			A.Indd_CurStk,
	--			A.Indd_LeadTime,
	--			A.Indd_AcceptedQty,
	--			B.Mm_ID AS ID,
	--			B.Mm_Name AS NAME,
	--			B.Mm_Code AS CODE,
	--			B.Mm_LeadTime,
	--			B.Mm_StkUom,
	--			C.Uom_Name,
	--			A.Indd_AcceptedQty,
	--			C.Uom_Code
	--FROM IndentDetail(nolock) AS A
	--LEFT JOIN MedicineMaster(nolock) AS B
	--	ON A.Indd_ItmId = B.Mm_ID
	--LEFT JOIN UomMaster(NOLOCK) AS C
	--	ON B.MM_PurchaseUom = C.Uom_ID
	--WHERE Indd_IndKey = @Ind_Key
	SELECT	A.Indd_IndKey,
				A.INDD_KEY,
				A.Indd_ItmId,
				A.Indd_SrNo,
				A.Indd_ItmCode,
				A.Indd_ItmName,
				A.Indd_Qty,
				A.Indd_Uom,
				A.Indd_CurStk,
				A.Indd_LeadTime,
				A.Indd_AcceptedQty,
				B.Mm_ID			AS ID,
				B.Mm_Name		AS NAME,
				B.Mm_Code		AS CODE,
				B.Mm_LeadTime,
				B.Mm_StkUom,
				B.Mm_MaxLevel	AS INDD_MAXLEVEL,
				B.Mm_MinLevel	AS INDD_MINLEVEL,
				B.MM_PackSize	AS INDD_PACKSIZE,
				B.Mm_PurRate	AS INND_Rate,
				C.Uom_Name,
				A.Indd_AcceptedQty,
				C.Uom_Code
	FROM IndentDetail(nolock) AS A
	LEFT JOIN MedicineMaster(nolock) AS B
		ON A.Indd_ItmId = B.Mm_ID
	LEFT JOIN UomMaster(NOLOCK) AS C
		ON B.MM_PurchaseUom = C.Uom_ID
	WHERE Indd_IndKey = @Ind_Key
	------------------------------------INDENT SCHEDULING-------------------------------------
	SELECT *
	FROM IndentItemSchedule(nolock)
	WHERE Inds_Id = @Ind_Key
	END
	--====================INDENT DETAILS=======================
	ELSE IF @SP_STATUS = 'INSERT_INDENT_DETAILS'
	BEGIN
	SELECT @Indd_Key = ISNULL(MAX(Indd_Key),0) + 1
	FROM IndentDetail(nolock)
	INSERT INTO IndentDetail(Indd_Key,
	Indd_IndKey,
	Indd_SrNo,
	Indd_ItmId,
	Indd_ItmCode,
	Indd_ItmName,
	Indd_CurStk,
	Indd_Qty,
	Indd_Uom,
	Indd_LeadTime,Indd_shortCloseQty,Indd_shortCloseBy,Indd_shortCloseDt) VALUES
	(@Indd_Key,@Indd_IndKey,@Indd_SrNo,@Indd_ItmId,@Indd_ItmCode,@Indd_ItmName,@Indd_CurStk,@Indd_Qty,@Indd_Uom,@Indd_LeadTime,@Indd_shortCloseQty,@Indd_shortCloseBy,@Indd_shortCloseDt)
	SELECT @ID = @Indd_Key
	END
	--===================INDENT_ITEM_SCHEDULE=========
	ELSE IF @SP_STATUS = 'GET_INDENT_SCHEDULING'
	BEGIN
	SELECT	IIS.Inds_IndKey,
				IIS.Inds_ItmId,
				IIS.Inds_Qty,
				IIS.Inds_Date
	FROM IndentItemSchedule(NOLOCK) IIS
	WHERE Inds_IndKey = @Inds_IndKey
	AND Inds_InddId = @Inds_InddId
	AND Inds_ItmId = @Inds_ItmId
	END
	ELSE IF @SP_STATUS = 'INSERT_INDENT_ITEM_SCHEDULE'
	BEGIN
	SELECT @Inds_Id = ISNULL(MAX(Inds_Id),0) + 1
	FROM IndentItemSchedule(NOLOCK)
	INSERT INTO IndentItemSchedule(Inds_Id,
	Inds_IndKey,
	Inds_InddId,
	Inds_ItmId,
	Inds_Qty,
	Inds_Date) VALUES
	(@Inds_Id,@Inds_IndKey,@Inds_InddId,@Inds_ItmId,@Inds_Qty,@Inds_Date)
	END
	ELSE IF @SP_STATUS = 'SEARCH_BY_ITEM_NAME'
	BEGIN
	DECLARE @query nvarchar(max) = '';
	SET @query = 'SELECT MM.Mm_ID, MM.Mm_Name, MM.Mm_Code, MM.Mm_MktRate AS ItemRate, UOM.Uom_Code, 
						UOM.Uom_ID,0 as INDD_SR_NO, .ITM_ID,0 AS Stock, MM.Mm_LeadTime
			FROM		MedicineMaster (nolock) MM
					INNER JOIN UOMMASTER (nolock) UOM
			ON			MM.Mm_StkUom = UOM.Uom_ID
			WHERE	MM.Mm_IsActive=1 and 	MM.Mm_Name like ''%' + @Indd_ItmName + '%'''
	EXEC (@query)
	END
	ELSE IF @SP_STATUS = 'GET_ITEM'
		BEGIN
			--SELECT distinct(mm.Mm_Code),mm.*
			--FROM MedicineMaster(NOLOCK) MM
			--left join IndentDetail id on id.Indd_ItmId =mm.Mm_ID
			--WHERE MM.Mm_IsActive = 1 and (ISNULL(id.Indd_Qty,0)-ISNULL(id.Indd_shortCloseQty,0)-ISNULL(id.Indd_AcceptedQty,0))<=0
			--SELECT DISTINCT	(mm.Mm_Code),
			--		mm.*
			--FROM	MedicineMaster(NOLOCK) MM
			--		LEFT JOIN IndentDetail id
			--ON		id.Indd_ItmId = mm.Mm_ID
			--WHERE	MM.Mm_IsActive = 1 
			--GROUP BY	Mm_ID,Mm_Code,Mm_Name,Mm_SaltName,Mm_SearchKey,Mm_HsnCode,Mm_MtmId,Mm_MgmId,Mm_McmId,Mm_SaleRate,Mm_PurRate,Mm_MktRate,Mm_MRP,Mm_MaxLevel,Mm_ReorderLevel,Mm_MinLevel,Mm_IsStockable,Mm_StkUom,Mm_IsInventory,Mm_Sales,Mm_MaintainQc,Mm_FixedAsset,Mm_MaintainExp,Mm_LeadTime,Mm_IsActive,Mm_IsSysGen,Mm_IsSync,Mm_LastSyncDate,Mm_BarCode,Mm_SapItemId,Mm_CposItemId,Mm_SapCode,Mm_CreatedBy,Mm_CreatedDate,Mm_UpdatedBy,Mm_UpdatedDate,MM_PurchaseUom,MM_PurchaseRatio,MM_SalesRatio,MM_PackSize,MM_MarketingBy,MM_ManufactureBy
			--HAVING (ISNULL(SUM(id.Indd_Qty),0) - ISNULL(SUM(id.Indd_shortCloseQty),0) - ISNULL(SUM(id.Indd_AcceptedQty),0)) <= 0

			SELECT DISTINCT	(mm.Mm_Code),
					mm.*
			FROM	MedicineMaster(NOLOCK) MM
					LEFT JOIN(	
								SELECT	X.Indd_ItmId,
										SUM(X.Indd_Qty) AS Indd_Qty,
										SUM(X.Indd_shortCloseQty) AS Indd_shortCloseQty,
										SUM(X.Indd_AcceptedQty) AS Indd_AcceptedQty
								FROM	IndentDetail X
								GROUP BY X.Indd_ItmId
							) ID
			ON		id.Indd_ItmId = mm.Mm_ID
			WHERE	MM.Mm_IsActive = 1 
					AND ISNULL(id.Indd_Qty,0) - ISNULL(id.Indd_shortCloseQty,0) - ISNULL(id.Indd_AcceptedQty,0) <= 0
		END
	ELSE IF @SP_STATUS = 'GET_ITEM_DETAIL'
	BEGIN
	SELECT	MM.Mm_ID,
				MM.Mm_Code,
				MM.Mm_Name,
				MM.Mm_LeadTime,
				MM.Mm_StkUom	AS UMO
	FROM MedicineMaster(nolock) MM
	WHERE Mm_Code =
						CASE
							WHEN ISNULL(@Indd_ItmCode,'') = '' THEN Mm_Code
							ELSE @Indd_ItmCode
						END
	AND Mm_Name =
						CASE
						WHEN ISNULL(@Indd_ItmName,'') = '' THEN Mm_Name
						ELSE @Indd_ItmName
						END
	AND MM.Mm_LeadTime =
								CASE
								WHEN ISNULL(@Indd_LeadTime,'') = '' THEN MM.Mm_LeadTime
								ELSE @Indd_LeadTime
								END
	AND MM.Mm_StkUom =
							CASE
								WHEN ISNULL(@Indd_Uom,'') = '' THEN MM.Mm_StkUom
								ELSE @Indd_Uom
							END
	AND MM.Mm_IsActive = 1
	END
	ELSE IF @SP_STATUS = 'GET_INDENT_SCHEDULE'
	BEGIN
	SELECT	INDDET.Indd_SrNo	AS INDS_ITM_SRNO,
				INDITMSCH.Inds_ItmId,
				INDITMSCH.INDS_QTY,
				INDITMSCH.INDS_DATE
	FROM IndentItemSchedule(NOLOCK) INDITMSCH
	INNER JOIN IndentDetail(NOLOCK) INDDET
		ON INDDET.INDD_KEY = INDITMSCH.Inds_InddId
	WHERE INDITMSCH.Inds_IndKey = @Inds_IndKey
	END
	ELSE IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
	SELECT	MM.MM_ID					AS INDD_ITM_ID,
				MM.Mm_Name				AS ITM_NAME,
				MM.Mm_Code,
				MM.Mm_LeadTime,
				MM.Mm_ID,
				UM.Uom_Name				AS Uom_Name,
				MM_PurchaseUom			AS Indd_Uom,
				mm.Mm_PurRate,
				mm.Mm_MaxLevel,
				mm.Mm_MinLevel,
				mm.MM_PackSize,
				ISNULL(VW.STOCK,0)	AS Stock
	FROM MedicineMaster(NOLOCK) MM
	LEFT JOIN UomMaster(NOLOCK) UM
		ON MM.MM_PurchaseUom = UM.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VW
		ON MM.Mm_ID = VW.STK_ITEM_ID
	WHERE MM.Mm_ID = @Indd_ItmId
	AND MM.Mm_IsActive = 1
	END
	ELSE IF @SP_STATUS = 'RETRIVE_ITEM_SCHEDULE'
	BEGIN
	SELECT	0	AS INDS_ITM_SRNO,
				Inds_ItmId,
				INDS_QTY,
				INDS_DATE
	FROM IndentItemSchedule(nolock) AS A
	WHERE A.Inds_IndKey = @IND_KEY
	END
	ELSE IF @SP_STATUS = 'BIND_ITEM'
	BEGIN
	SELECT	MM.Mm_ID,
				MM.Mm_Name,
				MM.Mm_Code,
				MM.Mm_MktRate			AS ItemRate,
				Uom.Uom_Code,
				Uom.Uom_ID,
				0							AS INDD_SR_NO,
				MM.Mm_LeadTime,
				ISNULL(VW.STOCK,0)	AS Stock
	FROM MedicineMaster(NOLOCK) MM
	INNER JOIN UomMaster(NOLOCK) Uom
		ON MM.Mm_StkUom = Uom.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VW
		ON MM.Mm_ID = VW.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	END
	ELSE IF @SP_STATUS = 'GET_PENDING_PURCHASE_INDENT'
	BEGIN
	SELECT	CONVERT(bit,0)																										AS SEL,
				INDD.Indd_SrNo																										AS SR_NO,
				INDD.Indd_ItmId																									AS ITEM_ID,
				mm.Mm_Code																											AS ITEM_CODE,
				mm.Mm_Name																											AS ITEM_NAME,
				mm.Mm_HsnCode																										AS HSN_CODE,
				INDH.Ind_Key																										AS [KEY],
				INDH.IND_NO																											AS [KEY_NO],
				INDD.INDD_KEY																										AS MASTER_KEY,
				ISNULL(INDD.INDD_QTY,0)																							AS QTY,
				INDD.INDD_UOM																										AS UOM,
				UM.UOM_CODE																											AS UOM_CODE,
				--ISNULL(INDD.INDD_QTY,0)- ISNULL(INDD.INDD_CUR_STK,0)-ISNULL(INDD.INDD_SHORT_CLOSE_QTY,0) as PENDING_QTY,
				ISNULL(INDD.INDD_QTY,0) - SUM(ISNULL(pod.Pi_Qty,0)) - ISNULL(INDD.Indd_shortCloseQty,0)	AS PENDING_QTY,
				CONVERT(numeric,0)																								AS SHORT_CLOSE_QTY
	FROM IndentHeader(NOLOCK) INDH
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDD.Indd_IndKey = INDH.Ind_Key
	LEFT JOIN MedicineMaster(NOLOCK) mm
		ON INDD.Indd_ItmId = mm.Mm_ID
	LEFT JOIN UomMaster(NOLOCK) UM
		ON INDD.INDD_UOM = UM.UOM_ID
	LEFT JOIN PoItemDetails(NOLOCK) pod
		ON INDD.Indd_Key = pod.Pi_InddKey
	WHERE INDH.Ind_Key = @Ind_Key AND INDH.Ind_ApproveStatus='Approve'---Cancel,UnApproved Indent Not Display In Short Close--->Add Hasmukh
	GROUP BY INDD.Indd_SrNo,INDD.Indd_ItmId,mm.Mm_Code,mm.Mm_Name,mm.Mm_HsnCode,INDH.Ind_Key,INDH.IND_NO,INDH.IND_NO,INDD.INDD_KEY,ISNULL(INDD.INDD_QTY,0),INDD.INDD_UOM,UM.UOM_CODE,ISNULL(INDD.Indd_shortCloseQty,0)
	HAVING ISNULL(INDD.INDD_QTY,0) - SUM(ISNULL(pod.Pi_Qty,0)) - ISNULL(INDD.Indd_shortCloseQty,0) > 0
	END
	ELSE IF @SP_STATUS = 'GetPendingIndentNo'
	BEGIN
	SELECT	Ih.Ind_Key			AS Id,
				Ih.IND_NO			AS [No],
				Ind_Date				AS [Date],
				--(ISNULL(SUM(INDD.Indd_Qty),0) - ISNULL(SUM(INDD.Indd_AcceptedQty),0)- ISNULL(SUM(INDD.Indd_shortCloseQty),0) ) as PendingQty,
				--ISNULL((SUM(ISNULL(INDD.INDD_QTY,0)) - (select sum(ISNULL(pod.Pi_Qty,0)) from PoItemDetails pod where  INDD.Indd_Key=pod.Pi_InddKey)- SUM(ISNULL(INDD.Indd_shortCloseQty,0))),0) as PendingQty,
				Ind_Remarks			AS Remark,
				[user].User_Name	AS CreatedBy,
				Ind_CreatedDt		AS CreatedDt
	FROM IndentHeader(NOLOCK) Ih
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDD.Indd_IndKey = Ih.Ind_Key
	LEFT JOIN UserMaster(NOLOCK) [user]
		ON Ih.Ind_CreatedBy = [user].User_ID 
		WHERE IH.Ind_ApproveStatus='Approve'---Cancel,UnApproved Indent Not Display In Short Close--->Add Hasmukh
		GROUP BY User_Name,Ih.Ind_Key,Ih.IND_NO,Ind_Date,Ind_Remarks,Ind_CreatedBy,Ind_CreatedDt
	HAVING (ISNULL(SUM(INDD.Indd_Qty),0) - ISNULL(SUM(INDD.Indd_AcceptedQty),0) - ISNULL(SUM(INDD.Indd_shortCloseQty),0)) > 0
	END
	ELSE IF @SP_STATUS = 'UPDATE_SHORT_CLOSE_QTY'
	BEGIN
	UPDATE IndentDetail
	SET	Indd_shortCloseQty = @Indd_shortCloseQty,
			Indd_shortCloseBy = @USER,
			Indd_shortCloseDt = GETDATE()
	WHERE Indd_SrNo = @Indd_SrNo
	AND Indd_IndKey = @Indd_IndKey
	AND Indd_ItmId = @Indd_ItmId
	SELECT @ID = INDD_KEY
	FROM IndentDetail(NOLOCK)
	WHERE Indd_SrNo = @Indd_SrNo
	AND Indd_IndKey = @Indd_IndKey
	AND Indd_ItmId = @Indd_ItmId
	END
	ELSE IF @SP_STATUS = 'UpdateApproval'
	BEGIN
	UPDATE IndentHeader
	SET	Ind_ApproveStatus = @Ind_ApproveStatus,
			Ind_ApproveStatusRemark = @Ind_ApproveStatusRemark
	WHERE Ind_Key = @Ind_Key

	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_PurchaseInvoice]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_PurchaseInvoice]
---------------------------- PURCHASE INVOICE HEADER ----------------------------
@SP_STATUS [VARCHAR](200) = '',
@USER [INT] = 0,
@ID [NUMERIC](18, 0) = 0 OUT,
@Pih_Key [NUMERIC](18, 0) = 0,
@Pih_No [NUMERIC](18, 0) = 0,
@Pih_Date [DATETIME] = NULL,
@Pih_RefNo [NVARCHAR](50) = NULL,
@Pih_VenId [NUMERIC](18, 0) = 0,
@PINV_VEN_NAME [VARCHAR] = '',
@Pih_VenAddId [NUMERIC](18, 0) = 0,
@PINV_VEN_ADD [VARCHAR] = '',
@Pih_GrossValue [NUMERIC](18, 2) = 0,
@Pih_Disc [NUMERIC](18, 2) = 0,
@Pih_DiscAmt [NUMERIC](18, 2) = 0,
@Pih_NetValue [NUMERIC](18, 2) = 0,
@PINV_CMP_ID [BIGINT] = 0,
@Pih_BmId [BIGINT] = 0,
@Pih_YearId [BIGINT] = 0,
@PINV_IDs nvarchar(max) = '',
@PO_IDS nvarchar(max) = '',
@Pih_RefDate datetime = NULL,
@Pih_StartDate datetime = NULL,
@Pih_EndDate datetime = NULL,
---------------------------- PURCHASE INVOICE DETAIL ----------------------------
@Pid_Key [NUMERIC](18, 0) = 0,
@Pid_PihKey [NUMERIC](18, 0) = 0,
@Pid_SrNo [INT] = 0,
@Pid_PiSrNo [INT] = 0,
@Pid_MmId NUMERIC(18,0) = 0,
@Pid_Qty [NUMERIC](18, 3) = 0,
@Pid_FreeQty [NUMERIC](18, 2) = 0,
@Pid_BatchNo [NVARCHAR](50) = '',
@Pid_ExpiryDt date = NULL,
@Pid_MfgDt date = NULL,
@Pid_MRP [NUMERIC](18, 3) = 0,
@Pid_UomId int= 0,
@Pid_Rate	[NUMERIC](18, 3) = 0,

@Pid_Sales_Rate [NUMERIC](18, 2) = 0,
@Pid_Com_Perc	[NUMERIC](5, 2)=0,

@Pid_Disc [NUMERIC](5, 2) = 0,
@Pid_DiscAmount [NUMERIC](18, 3) = 0,
@Pid_Amount [NUMERIC](18, 2) = 0,
@Pid_AmountTotal [NUMERIC](18, 3) = 0,
@DocType int = 0,
@Pid_LmId int = 0,
@Pih_Duedate datetime = NULL,
@Pih_DocType int=0,
@Pid_PoKey NUMERIC(18,0) = 0,
@Pid_DoKey NUMERIC(18,0)=0,
@Pid_MnfName	VARCHAR(5000)=''
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
--'INSERT_PurchaseInvoiceHeader'
	IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT		@Pih_Key = ISNULL(MAX(Pih_Key), 0) + 1
	FROM		PurchaseInvoiceHeader(NOLOCK);
	SELECT		@Pih_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Pih_No,0)))
	FROM		PurchaseInvoiceHeader	(NOLOCK)
	WHERE		PurchaseInvoiceHeader.Pih_Date 
				BETWEEN @FROM_DATE AND @TO_DATE

	INSERT INTO [dbo].[PurchaseInvoiceHeader] (
		[Pih_Key],
		[Pih_No],
		[Pih_Date],
		[Pih_RefNo],
		[Pih_VenId],
		[Pih_VenAddId],
		[Pih_GrossValue],
		[Pih_NetValue],
		[Pih_BmId],
		[Pih_YearId],
		[Pih_CreatedBy],
		[Pih_CreatedDt],
		Pih_Disc,
		Pih_DiscAmt,
		Pih_Duedate,
		Pih_RefDate ,Pih_DocType)
	VALUES(@Pih_Key, @Pih_No, @Pih_Date, @Pih_RefNo, @Pih_VenId, @Pih_VenAddId, @Pih_GrossValue, @Pih_NetValue,
	@Pih_BmId, @Pih_YearId, @USER, GETDATE(), @Pih_Disc, @Pih_DiscAmt, @Pih_Duedate, @Pih_RefDate,@Pih_DocType);
	SELECT @ID = @Pih_Key;
	END;
	ELSE
	IF @SP_STATUS = 'Update'
	BEGIN
	BEGIN
	DECLARE @MSG_OUT_update nvarchar(max)
	EXEC SP_Tbl_Dependency	'PurchaseInvoiceHeader',
									@Pih_Key,
									@MSG_OUT_update OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT_update, 14, 9)
		END
	ELSE
		BEGIN
		UPDATE [dbo].[PurchaseInvoiceHeader]
		SET	--[Pih_No] = @Pih_No,
				[Pih_Date] = @Pih_Date,
				[Pih_RefNo] = @Pih_RefNo,
				[Pih_VenId] = @Pih_VenId,
				[Pih_VenAddId] = @Pih_VenAddId,
				[Pih_GrossValue] = @Pih_GrossValue,
				[Pih_NetValue] = @Pih_NetValue,
				[Pih_BmId] = @Pih_BmId,
				[Pih_YearId] = @Pih_YearId,
				[Pih_UpdatedBy] = @USER,
				[Pih_UpdatedDt] = GETDATE(),
				Pih_Disc = @Pih_Disc,
				Pih_DiscAmt = @Pih_DiscAmt,
				Pih_Duedate = @Pih_Duedate,
				Pih_RefDate = @Pih_RefDate,
				Pih_DocType=@Pih_DocType
		WHERE [Pih_Key] = @Pih_Key;
		SELECT @ID = @Pih_Key;
		UPDATE POITMDET
		SET POITMDET.Pi_PiQty = ISNULL(POITMDET.Pi_PiQty, 0) - ISNULL(POINVDET.Pid_Qty, 0)
		FROM PoItemDetails POITMDET
		LEFT JOIN PurchaseInvoiceDetail POINVDET
		ON POITMDET.Pi_PoKey = POINVDET.Pid_PoKey
		AND POITMDET.Pi_ItemId = POINVDET.Pid_MmId
		--AND POITMDET.Pi_SrNo = POINVDET.Pid_PiSrNo
		WHERE POINVDET.Pid_PoKey > 0
		AND POINVDET.Pid_PihKey = @Pih_Key;
		UPDATE POITMDET
		SET POITMDET.Did_PIQty = ISNULL(POITMDET.Did_PIQty, 0) - ISNULL(POINVDET.Pid_Qty, 0)
		FROM DispatchDetail POITMDET
		LEFT JOIN PurchaseInvoiceDetail POINVDET
		ON POITMDET.Did_DihKey = POINVDET.Pid_PoKey
		AND POITMDET.Did_MmId = POINVDET.Pid_MmId
		--AND POITMDET.Did_SrNo = POINVDET.Pid_PiSrNo
		WHERE POINVDET.Pid_PoKey > 0
		AND POINVDET.Pid_PihKey = @Pih_Key;
		
		DELETE FROM PurchaseInvoiceDetail WHERE Pid_PihKey = @Pih_Key;
		DELETE FROM dbo.StockRegister WHERE Stk_DocKey = @Pih_Key AND Stk_DocType = @DocType;
		DELETE FROM dbo.TaxTransaction	WHERE Tr_DocId=@Pih_Key and  Tr_DocTyp= @DocType

		END
	END
	END;
	ELSE
	IF @SP_STATUS = 'Delete'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'PurchaseInvoiceHeader',
									@Pih_Key,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT, 14, 9)
		END
	ELSE
		BEGIN
			UPDATE pod
			SET pod.Pi_PiQty = ISNULL(pod.Pi_PiQty, 0) - ISNULL(pid.Pid_Qty, 0)
			FROM PoItemDetails pod
			INNER JOIN PurchaseInvoiceDetail pid
			ON pod.Pi_PoKey = pid.Pid_PoKey
			AND pod.Pi_ItemId = pid.Pid_MmId
			--AND POITMDET.Pi_SrNo = POINVDET.Pid_PiSrNo
			WHERE pid.Pid_PoKey > 0
			AND pid.Pid_PihKey = @Pih_Key;
			UPDATE dd
			SET dd.Did_PIQty = ISNULL(dd.Did_PIQty, 0) - ISNULL(pid.Pid_Qty, 0)
			FROM DispatchDetail dd
			INNER JOIN PurchaseInvoiceDetail pid
			ON dd.Did_DihKey = pid.Pid_DoKey
			AND dd.Did_MmId = pid.Pid_MmId
			--AND POITMDET.Pi_SrNo = POINVDET.Pid_PiSrNo
			WHERE pid.Pid_DoKey > 0
			AND pid.Pid_PihKey = @Pih_Key;

			DELETE FROM [dbo].[PurchaseInvoiceHeader]
			WHERE Pih_Key = @Pih_Key;
			DELETE FROM [dbo].[PurchaseInvoiceDetail]
			WHERE Pid_PihKey = @Pih_Key;

			DELETE FROM TaxTransaction 
			WHERE Tr_DocKey=@Pih_Key
			AND Tr_DocTyp=@DocType;---Add Hasmukh

			DELETE FROM dbo.StockRegister
			WHERE Stk_DocKey = @Pih_Key
			AND Stk_DocType = @DocType;
		END
	END
	ELSE
	IF @SP_STATUS = 'InsertDetail'
	BEGIN
	SELECT @Pid_Key = ISNULL(MAX(Pid_Key), 0) + 1
	FROM PurchaseInvoiceDetail(NOLOCK);
	INSERT INTO [dbo].[PurchaseInvoiceDetail] (
		[Pid_Key],
		[Pid_PihKey],
		[Pid_PoKey],
		[Pid_SrNo],
		--[Pid_PiSrNo],
		[Pid_MmId],
		[Pid_Qty],
		[Pid_UomId],
		[Pid_Rate],
		[Pid_Sales_Rate],
		[Pid_Com_Perc],
		[Pid_Amount],
		[Pid_BatchNo],
		[Pid_ExpiryDt],
		[Pid_MfgDt],
		[Pid_MRP],
		[Pid_Disc],
		[Pid_DiscAmount],
		[Pid_AmountTotal],
		[Pid_FreeQty],
		Pid_LmId ,Pid_DoKey,Pid_MnfName)
	VALUES(@Pid_Key, @Pid_PihKey, @Pid_PoKey, 
	@Pid_SrNo, 
	--@Pid_PiSrNo,
	 @Pid_MmId, @Pid_Qty, @Pid_UomId, @Pid_Rate,@Pid_Sales_Rate,@Pid_Com_Perc,
	@Pid_Amount, ISNULL(@Pid_BatchNo,''), @Pid_ExpiryDt, @Pid_MfgDt, @Pid_MRP, @Pid_Disc, @Pid_DiscAmount, @Pid_AmountTotal,
	@Pid_FreeQty, @Pid_LmId,@Pid_DoKey,@Pid_MnfName);
	IF @Pid_PoKey > 0 
		BEGIN
			UPDATE POITMDET
			SET POITMDET.Pi_PiQty = ISNULL(POITMDET.Pi_PiQty, 0) + ISNULL(@Pid_Qty, 0)
			FROM PoItemDetails POITMDET
			WHERE POITMDET.Pi_PoKey = @Pid_PoKey
			--AND POITMDET.Pi_SrNo = @Pid_PiSrNo
			AND POITMDET.Pi_ItemId = @Pid_MmId;
		END;
	IF @Pid_PoKey > 0
		BEGIN
			UPDATE dd
			SET dd.Did_PIQty = ISNULL(dd.Did_PIQty, 0) + ISNULL(@Pid_Qty, 0)
			FROM DispatchDetail dd
			WHERE dd.Did_DihKey = @Pid_DoKey
			--AND dd.Did_SrNo = @Pid_PiSrNo
			AND dd.Did_MmId = @Pid_MmId;
		END;

	iF EXiSTS(SELECT * FROM MedicineBatchManufacture WHERE MBM_MM_ID=@Pid_MmId AND MBM_BATCH_NO=@Pid_BatchNo)
		BEGiN
			UPDATE	MedicineBatchManufacture
			SET		MBM_MANU_NAME=@Pid_MnfName
			WHERE	MBM_MM_ID=@Pid_MmId
					AND MBM_BATCH_NO=@Pid_BatchNo
		END
	ELSE
		BEGiN
			DECLARE @MBM_ID			BIGINT=0
			DECLARE @MBM_MM_CODE	varchar(15)=''
			SELECT	@MBM_ID=ISNULL(MAX(MBM_ID),0)+1
			FROM	MedicineBatchManufacture

			SELECT	@MBM_MM_CODE=Mm_Code
			FROM	MedicineMaster A
			WHERE	A.Mm_ID=@Pid_MmId

			iNSERT iNTO MedicineBatchManufacture( MBM_ID,MBM_MM_ID,MBM_MM_CODE,MBM_BATCH_NO,MBM_MANU_NAME,MBM_CRETED_DATE,MBM_CREATED_BY)
			VALUES ( @MBM_ID,@Pid_MmId,@MBM_MM_CODE,@Pid_BatchNo,@Pid_MnfName,GETDATE(),@USER)
		END

	SELECT @ID = @Pid_Key;
	END;
	ELSE
	IF @SP_STATUS = 'FillGrid'
	BEGIN
		DECLARE		@FormPrefix_fill_grid AS NVARCHAR(MAX) = '';
		SELECT		@FormPrefix_fill_grid = FormPrefix
		FROM		FormDetailTable
		WHERE		Id = 4
		SELECT		A.Pih_Key,
					@FormPrefix_fill_grid + cast(A.Pih_No as nvarchar(max)) as Pih_No,
					A.Pih_RefNo,
					A.Pih_RefDate,
					A.Pih_Date,
					A.Pih_GrossValue,
					A.Pih_NetValue,
					A.Pih_CreatedDt,
					B.Vendor_Name AS VEN_NAME,
					B.Vendor_Code AS VEN_CODE,
					C.VendAdd_Addr1 + C.VendAdd_Add2 + C.VendAdd_Add3 AS ADDRESS,
					D.User_Name AS U_Name,
					sum(ISNULL(Act_PaidAmount,0)) as Act_PaidAmount,
					Pih_PRHStatus---Add Hasmukh
		FROM PurchaseInvoiceHeader(NOLOCK) A
		----Add Start Hasmukh
			 LEFT JOIN (SELECT PIH.Pih_Key,
							   (CASE WHEN SUM(ISNULL(PRD.Prd_Qty,0))>0 THEN 'false' ELSE 'true' END)AS Pih_PRHStatus
						  FROM PurchaseInvoiceHeader PIH
							   LEFT JOIN PurchaseReturnHeader PRH
							ON PRH.Prh_PihKey=PIH.Pih_Key
							   LEFT JOIN PurchaseReturnDetail PRD
							ON PRD.Prd_PrhId=PRH.Prh_Id
							GROUP BY PIH.Pih_Key)AS PurchaseReturnStatus
			ON PurchaseReturnStatus.Pih_Key=A.Pih_Key
		----Add End Hasmukh
		LEFT JOIN VendorMaster(NOLOCK) B
			ON A.Pih_VenId = B.Vendor_ID
		LEFT JOIN VendorAddMaster(NOLOCK) C
			ON A.Pih_VenAddId = C.VendAdd_Id
		LEFT JOIN dbo.UserMaster(NOLOCK) D
			ON A.Pih_CreatedBy = D.User_ID
		left join  AccountTransaction act 
			on Act_DocNo=A.Pih_No and Act_DocKey=A.Pih_key and Act_DocType=4
		Where CAST(Pih_Date AS DATE) BETWEEN @Pih_StartDate AND @Pih_EndDate
		Group by A.Pih_Key,
					@FormPrefix_fill_grid + cast(A.Pih_No as nvarchar(max)) ,
					A.Pih_RefNo,
					A.Pih_RefDate,
					A.Pih_Date,
					A.Pih_GrossValue,
					A.Pih_NetValue,
					A.Pih_CreatedDt,
					B.Vendor_Name ,
					B.Vendor_Code,
					C.VendAdd_Addr1 + C.VendAdd_Add2 + C.VendAdd_Add3 ,
					D.User_Name,
					Pih_PRHStatus---Add Hasmukh
		ORDER BY A.Pih_Key DESC;
	END;
	
	--IF @SP_STATUS = 'GetUomFromMedicine'
	--  BEGIN
	--    SELECT MUom_PurchaseId as Pid_Uom,uom.Uom_Name from MedicineUomMaster muom left join UomMaster uom on muom.MUom_PurchaseId=uom.Uom_ID
	-- where  MUom_Mm_ID=@Pid_MmId
	--  END;
	--ELSE
	--  IF @SP_STATUS = 'GetUomFromMedicineopening'
	--  BEGIN
	--    SELECT MUom_PurchaseId as Sm_UomId,uom.Uom_Name from MedicineUomMaster muom left join UomMaster uom on muom.MUom_PurchaseId=uom.Uom_ID
	-- where  MUom_Mm_ID=@Pid_MmId
	--  END;
	--ELSE
	--IF @SP_STATUS = 'GetUomFromMedicineForIndent'
	--    BEGIN
	--      SELECT MUom_PurchaseId as UOM_ID,uom.Uom_Name from MedicineUomMaster muom left join UomMaster uom on muom.MUom_PurchaseId=uom.Uom_ID
	--	  where  MUom_Mm_ID=@Pid_MmId
	--    END;
	--  ELSE
	--IF @SP_STATUS = 'GetUomFromMedicineForPO'
	--  BEGIN
	--    SELECT MUom_PurchaseId as PI_UOM_ID,uom.Uom_Name from MedicineUomMaster muom left join UomMaster uom on muom.MUom_PurchaseId=uom.Uom_ID
	-- where  MUom_Mm_ID=@Pid_MmId
	--  END;
	--ELSE
	ELSE IF @SP_STATUS = 'FILL_VENDOR_CONTROL'
	BEGIN
		SELECT	A.Vendor_ID AS VEN_ID,
				A.Vendor_Code AS VEN_CODE,
				A.Vendor_Name AS VEN_NAME,
				B.VendAdd_Id AS VAAD_ID,
				B.VendAdd_Addr1 + CASE WHEN ISNULL(B.VendAdd_Add2,'') <> '' THEN ISNULL(', '+ B.VendAdd_Add2, '') ELSE '' END
						+ CASE WHEN ISNULL(B.VendAdd_Add3,'') <> '' THEN ISNULL(', '+ B.VendAdd_Add3, '') ELSE '' END AS VEN_ADDRESS,
				area.Area_StateId StateId,ISNULL(A.Vendor_CreditDays,0) as Vendor_CreditDays,isnull(A.Vendor_CreditLimit,0) as Vendor_CreditLimit,
				A.Vendor_Vt_Id,vt.Vt_Name
		FROM VendorMaster(NOLOCK) A
		inner JOIN VendorAddMaster(NOLOCK) B
		ON A.Vendor_ID = B.VendAdd_VendorId and B.VendAdd_IsActive=1
		LEFT JOIN AreaMaster (NOLOCK) area
		ON B.VendAdd_AreaId = area.Area_ID
		LEFT JOIN StateMaster (NOLOCK) [state]
		ON area.Area_StateId = state.State_ID
		LEFT JOIN VendorTypeMaster as vt
		ON vt.Vt_Id=A.Vendor_Vt_Id
		WHERE A.Vendor_IsActive = 1;
	END;
	ELSE
	IF @SP_STATUS = 'AUTO_INVOICE_NO'
	BEGIN
		DECLARE		@FormPrefix AS NVARCHAR(MAX) = '';
		SELECT		@FormPrefix = FormPrefix
		FROM		FormDetailTable
		WHERE		Id = 4
		SELECT		@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Pih_No,0)))
		FROM		PurchaseInvoiceHeader	(NOLOCK) A
		WHERE		A.Pih_date BETWEEN @FROM_DATE AND @TO_DATE

	END;
	ELSE
	IF @SP_STATUS = 'RETRIVE_PURCHASE_INVOICE'
	BEGIN
	DECLARE		@FormPrefix_ret AS NVARCHAR(MAX) = '';
	SELECT		@FormPrefix_ret = FormPrefix
	FROM		FormDetailTable
	WHERE		Id = 4
	SELECT	A.Pih_Key,
				@FormPrefix_ret + cast( A.Pih_No as nvarchar(max)) as Pih_No,
				A.Pih_RefNo,
				A.Pih_RefDate,
				A.Pih_Date,
				A.Pih_GrossValue,
				A.Pih_NetValue,
				B.Vendor_Name AS VEN_NAME,
				B.Vendor_Code AS VEN_CODE,
				A.Pih_VenId,
				A.Pih_VenAddId,
				ISNULL(B.Vendor_CreditDays,0) as Vendor_CreditDays,
				ISNULL(B.Vendor_CreditLimit,0) as Vendor_CreditLimit,
				C.VendAdd_Addr1 +','+ C.VendAdd_Add2 +','+ C.VendAdd_Add3 AS ADDRESS,----Add Comma Separated In Address--->Add Hasmukh
				D.User_Name AS U_NAME,
				A.Pih_Disc,
				A.Pih_DiscAmt,
				A.Pih_Duedate,
				area.Area_StateId StateId,
				A.Pih_CreatedDt,
				B.Vendor_Vt_Id
	FROM PurchaseInvoiceHeader(NOLOCK) A
	LEFT JOIN VendorMaster(NOLOCK) B
		ON A.Pih_VenId = B.Vendor_ID
	LEFT JOIN VendorAddMaster(NOLOCK) C
		ON A.Pih_VenAddId = C.VendAdd_Id
	LEFT JOIN AreaMaster (NOLOCK) area
		ON C.VendAdd_AreaId = area.Area_ID
	LEFT JOIN StateMaster (NOLOCK) [state]
		ON area.Area_StateId = state.State_ID
	LEFT JOIN dbo.UserMaster(NOLOCK) D
		ON A.Pih_CreatedBy = D.User_ID
	WHERE Pih_Key = @Pih_Key;
	SELECT		A.Pid_Key,
				--A.Pid_PiSrNo,
				pih.Pih_DocType,
				--case when isnull(pih.Pih_DocType,0)=1 then po.Po_No when isnull(pih.Pih_DocType,0)=17 then dh.Dih_No end as Po_No,
				po.Po_No,
				Dih_No,
				A.Pid_DoKey,
				A.Pid_PihKey,
				A.Pid_PoKey,
				A.Pid_SrNo,
				A.Pid_Qty,
				A.Pid_Rate,
				ISNULL(A.Pid_Sales_Rate,0) AS Pid_Sales_Rate,
				A.Pid_MmId,
				B.Mm_Code AS ITM_CODE,
				B.Mm_Name AS ITM_NAME,
				C.Uom_Code,
				C.Uom_Name AS Pid_Uom,
				A.Pid_UomId AS Pid_UomId,
				A.Pid_Amount,
				dh.Dih_Key as Pid_DihKey,
				case when Dih_No>0 then 
				isnull(sum(dd.Did_Qty),0) 
				else 
				isnull(sum(POITMDET.Pi_Qty),0)
				end as Po_Qty,
				--Pi_Qty as Po_Qty,
				dd.Did_SrNo as Pid_DidSrNo,
				--(ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0)) + ISNULL(A.Pid_Qty, 0) AS Po_Qty,
				--(ISNULL(POITMDET.Pi_Qty, 0)),ISNULL(POITMDET.Pi_PiQty, 0),ISNULL(A.Pid_Qty, 0),
				A.Pid_BatchNo,
				A.Pid_ExpiryDt,
				A.Pid_MfgDt,
				A.Pid_MRP,
				A.Pid_Disc,
				A.Pid_DiscAmount,
				A.Pid_AmountTotal,
				A.Pid_FreeQty,
				B.MM_PackSize AS Pid_PackId,
				A.Pid_LmId,B.MM_ManufactureBy,
				B.MM_MarketingBy,
				B.Mm_HsnCode as PoHsnCode,
				ISNULL(sum(prd.Prd_Qty),0) as Pid_ReturnQty,
				ISNULL(sum(prd.Prd_FreeQty),0) as Pid_ReturnFreeQty,
				(CASE WHEN B.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
					,sum(vw.Item_Stock) as  stock,
				ISNULL(Pid_MnfName,'') AS Pid_MnfName
	FROM PurchaseInvoiceDetail(NOLOCK) A
	LEFT JOIN dbo.MedicineMaster(NOLOCK) B
		ON B.Mm_ID = A.Pid_MmId
	LEFT JOIN dbo.UomMaster(NOLOCK) C
		ON C.Uom_ID = A.Pid_UomId
	LEFT JOIN PoItemDetails(NOLOCK) POITMDET
		ON POITMDET.Pi_ItemId = A.Pid_MmId
		AND POITMDET.Pi_PoKey = A.Pid_PoKey
		--AND POITMDET.Pi_SrNo = A.Pid_PiSrNo
	left join PoHeader (nolock) po
		on po.Po_Key=A.Pid_PoKey
	left join PurchaseInvoiceHeader (nolock) pih
		on pih.Pih_Key=A.Pid_PihKey
	left join DispatchHeader (nolock) dh
		on dh.Dih_Key=A.Pid_PoKey
	left join DispatchDetail (nolock) dd
		on dd.Did_DihKey=dh.Dih_Key
	left join PurchaseReturnDetail (NOLOCK) prd 
		on Prd_MmId=A.Pid_MmId and Prd_LmId=A.Pid_LmId and Prd_PidKey=A.Pid_Key
   	left join   vwStock  vw
		on  vw.Item_Id = A.Pid_MmId
	   and  vw.Item_Batchno =  A.Pid_BatchNo
	   and  vw.Item_ExpDate =  A.Pid_ExpiryDt
	WHERE Pid_PihKey = @Pih_Key
	group by  Pid_DoKey,dd.Did_SrNo,dh.Dih_Key,A.Pid_Key,Pi_Qty,pih.Pih_DocType,dh.Dih_No,
				--A.Pid_PiSrNo,
				A.Pid_PihKey,
				A.Pid_PoKey,
				A.Pid_SrNo,
				A.Pid_Qty,
				A.Pid_Rate,
				ISNULL(A.Pid_Sales_Rate,0),
				A.Pid_MmId,
				po.Po_No,
				A.Pid_UomId,
				A.Pid_Amount,
				C.Uom_Code,
				C.Uom_Name,
				B.Mm_Code,
				B.Mm_Name,
				C.Uom_Code,
				C.Uom_Name ,
				A.Pid_UomId,
				A.Pid_Amount,		(ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0)) + ISNULL(A.Pid_Qty, 0) ,
				A.Pid_BatchNo,
				A.Pid_ExpiryDt,
				A.Pid_MfgDt,
				A.Pid_MRP,
				A.Pid_Disc,
				A.Pid_DiscAmount,
				A.Pid_AmountTotal,
				A.Pid_FreeQty,
				B.MM_PackSize,
				A.Pid_LmId,B.MM_ManufactureBy,
				B.MM_MarketingBy,
				B.Mm_HsnCode,
				B.Mm_MaintainExp,ISNULL(Pid_MnfName,'')
	END;
	ELSE
	IF @SP_STATUS = 'GET_ITEM'
	BEGIN
	SELECT		MM.Mm_ID,
				MM.Mm_Code,
				MM.Mm_Name,
				MM.Mm_SaltName,
				MM.Mm_SearchKey,
				MM.Mm_HsnCode,
				MM.Mm_MtmId,
				MM.Mm_MgmId,
				MM.Mm_McmId,
				MM.Mm_SaleRate,
				MM.Mm_PurRate,
				MM.Mm_MktRate,
				MM.Mm_MRP,
				MM.Mm_MaxLevel,
				MM.Mm_ReorderLevel,
				MM.Mm_MinLevel,
				MM.Mm_IsStockable,
				MM.Mm_StkUom,
				MM.Mm_IsInventory,
				MM.Mm_Sales,
				MM.Mm_MaintainQc,
				MM.Mm_FixedAsset,
				MM.Mm_MaintainExp,
				MM.Mm_LeadTime,
				MM.Mm_IsActive,
				MM.Mm_IsSysGen,
				MM.Mm_IsSync,
				MM.Mm_LastSyncDate,
				MM.Mm_BarCode,
				MM.Mm_SapItemId,
				MM.Mm_CposItemId,
				MM.Mm_CreatedBy,
				MM.Mm_CreatedDate,
				MM.Mm_UpdatedBy,
				MM.Mm_UpdatedDate
	FROM MedicineMaster(NOLOCK) MM
	WHERE MM.Mm_IsActive = 1 
	AND ((@Pih_VenId = 1
	AND mm.Mm_MtmId = 1)
	OR (@Pih_VenId != 1)
	AND mm.Mm_MtmId != 1);
	END;
	ELSE
	IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
	SELECT	MM.Mm_ID AS INDD_ITM_ID,
				MM.Mm_Name AS ITM_NAME,
				MM.Mm_Code,
				MM.Mm_LeadTime,
				MM.Mm_ID,
				MM.Mm_StkUom,
				UM.Uom_Code,
				UM.Uom_Name,
				UM.Uom_ID,
				ISNULL(VW.STOCK, 0) AS Stock,
				MM.Mm_PurRate,
				MM.Mm_MRP,
				mm.MM_PackSize,
				
				mtm.Mtm_ID as Po_Manufacture,
				mm.Mm_HsnCode as PoHsnCode,
				mm.MM_MarketingBy,
				mm.MM_ManufactureBy
	FROM MedicineMaster(NOLOCK) MM
	INNER JOIN UomMaster(NOLOCK) UM
		ON MM.MM_PurchaseUom = UM.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VW
		ON MM.Mm_ID = VW.STK_ITEM_ID
	LEFT JOIN MedicineTypeMaster (NOLOCK) mtm
		ON MM.Mm_MtmId =mtm.Mtm_ID
	WHERE MM.Mm_Code = CONVERT(VARCHAR(10),@Pid_MmId)
	AND MM.Mm_IsActive = 1;
	END;
	ELSE
	IF @SP_STATUS = 'PurchaseHeaderForReport'
	BEGIN
	SELECT	CONVERT(date, PH.Pih_Date) AS BillDate,
				PH.Pih_No AS BillNo,
				VM.Vendor_Name AS PartyName,
				ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
				ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
				ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
				PH.Pih_NetValue AS NetAmount,
				BM.Branch_Name,
				Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
				bm.Branch_GstNo
	FROM PurchaseInvoiceHeader (NOLOCK) AS PH
	LEFT JOIN VendorMaster (NOLOCK) AS VM
		ON PH.Pih_VenId = VM.Vendor_ID
	LEFT JOIN BranchMaster (NOLOCK) BM
		ON PH.Pih_BmId = BM.Branch_Id
	END;
	ELSE
	IF @SP_STATUS = 'PurchaseDetailForReport'
	BEGIN
	SELECT	CONVERT(date, PH.Pih_Date) AS BillDate,
				PH.Pih_No AS BillNo,
				VM.Vendor_Name AS PartyName,
				ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
				ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
				ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
				PH.Pih_NetValue AS NetAmount,
				BM.Branch_Name,
				Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
				bm.Branch_GstNo,
				MM.Mm_Name MedicinName,
				UM.Uom_Name AS UOM,
				MM.MM_PackSize AS PackSize,
				PID.Pid_ExpiryDt AS ExpDate,
				PID.Pid_BatchNo AS BatchNo,
				PID.Pid_Rate AS Rate,
				PID.Pid_AmountTotal AS Total,
				PID.Pid_Qty AS Qty
	FROM PurchaseInvoiceHeader (NOLOCK) AS PH
	LEFT JOIN PurchaseInvoiceDetail AS PID
		ON PH.Pih_Key = PID.Pid_PihKey
	LEFT JOIN VendorMaster (NOLOCK) AS VM
		ON PH.Pih_VenId = VM.Vendor_ID
	LEFT JOIN BranchMaster (NOLOCK) BM
		ON PH.Pih_BmId = BM.Branch_Id
	LEFT JOIN MedicineMaster (NOLOCK) MM
		ON PID.Pid_MmId = MM.Mm_ID
	LEFT JOIN UomMaster (NOLOCK) AS UM
		ON PID.Pid_UomId = UM.Uom_ID
	END;
	ELSE
	IF @SP_STATUS = 'PurchaseHeaderForReportWithFilter1'
	BEGIN
	  --   SELECT PurchaseInvoiceHeader.Pih_No AS Sih_No,
   --             CONVERT(DATE,PurchaseInvoiceHeader.Pih_Date)AS  Sih_Date,
		 --       VM.Vendor_Name AS Pm_Fullname ,
   --             Tr_DocKey,
			--	TaxMaster.Tax_Name,
			--	Tr_TxVal, 
			--	PurchaseInvoiceHeader.Pih_GrossValue AS Sih_SubTotal,
			--	SUM(Tr_TxTot) AS TaxAmount,
			--	PurchaseInvoiceHeader.Pih_NetValue AS Sih_Total,
			--	SGST,
			--	CGST,
			--	IGST,
			--	(SGST+CGST+IGST)AS TotalTax
   --        from TaxTransaction
   --             INNER JOIN PurchaseInvoiceHeader 
   --          ON PurchaseInvoiceHeader.Pih_Key=TaxTransaction.Tr_DocKey
	  --          INNER JOIN VendorMaster VM 
	  --       ON VM.Vendor_ID=PurchaseInvoiceHeader.Pih_VenId
			--    INNER JOIN TaxMaster 
			-- ON TaxMaster.Tax_ID=TaxTransaction.Tr_TxId
			--    INNER JOIN (SELECT A.Pid_PihKey
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Pid_PihKey
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM PurchaseInvoiceDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Pid_MmId
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Pid_Key = B.Tr_DdocKey
			--			AND A.Pid_PihKey = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 4
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Pid_Key = C.Tr_DdocKey
			--			AND A.Pid_PihKey = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 4
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Pid_Key = D.Tr_DdocKey
			--			AND A.Pid_PihKey = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 4
			--			AND D.Tr_TxId = 4
			--		) AS A
			--	GROUP BY A.Pid_PihKey)AS BB
			--ON BB.Pid_PihKey=PurchaseInvoiceHeader.Pih_Key
   --       WHERE Tr_TxVal!=0 and  Tr_TxId in(2,3,4) AND Tr_DocTyp=4
		 --      AND  CONVERT(DATE, PurchaseInvoiceHeader.Pih_Date) BETWEEN CONVERT(DATE, @Pih_Date, 105) AND CONVERT(DATE, @Pih_DueDate, 105)
			--	group by PurchaseInvoiceHeader.Pih_No,PurchaseInvoiceHeader.Pih_Date,Vendor_Name,Tr_DocKey,TaxMaster.Tax_Name,Tr_TxVal, PurchaseInvoiceHeader.Pih_GrossValue,
			--	PurchaseInvoiceHeader.Pih_NetValue,SGST,CGST,IGST

			SELECT	'Purchase Invoice' AS Sih_DocType,
					D.Pih_Key AS Sih_Key,
					D.Pih_No AS Sih_No,
					D.Pih_Date AS Sih_Date,
					E.Vendor_Name AS Pm_Fullname,
					B.Pid_Amount AS Sid_SubTotal,
					A.Tr_TxVal,
					A.Tr_TxTot,
					C.Tax_Name,
					D.Pih_GrossValue AS Sih_SubTotal,
					D.Pih_NetValue AS Sih_Total
			FROM	TaxTransaction A
					iNNER JOIN PurchaseInvoiceDetail B
			ON			A.Tr_DdocKey=B.Pid_Key
					AND A.Tr_DocTyp=4
					iNNER JOIN TaxMaster C
			ON			A.Tr_TxId=C.Tax_ID
					iNNER JOIN PurchaseInvoiceHeader D
			ON			B.Pid_PihKey=D.Pih_Key
					LEFT JOIN VendorMaster E
			ON			D.Pih_VenId=E.Vendor_ID
			WHERE	A.Tr_TxId NOT IN(1)
					AND CAST(D.Pih_Date AS DATE) BETWEEN CAST(@Pih_Date AS DATE) AND CAST(@Pih_Duedate AS DATE)
			UNION ALL
			SELECT	'Purchase Return' AS Sih_DocType,
					D.Prh_Id AS Sih_Key,
					D.Prh_No AS Sih_No,
					D.Prh_Date AS Sih_Date,
					E.Vendor_Name AS Pm_Fullname,
					B.Prd_Amount AS Sid_SubTotal,
					A.Tr_TxVal,
					A.Tr_TxTot,
					C.Tax_Name,
					DT.Srh_SubTotal AS Sih_SubTotal,
					D.Prh_TotalAmount AS Sih_Total
			FROM	TaxTransaction A
					iNNER JOIN PurchaseReturnDetail B
			ON			A.Tr_DdocKey=B.Prd_Id
					AND A.Tr_DocTyp=5
					iNNER JOIN TaxMaster C
			ON			A.Tr_TxId=C.Tax_ID
					iNNER JOIN PurchaseReturnHeader D
			ON			B.Prd_PrhId=D.Prh_Id
					INNER JOIN (SELECT	SUM(PRD.Prd_Qty*Prd_Rate)AS Srh_SubTotal,
										PRH.Prh_Id
								FROM	PurchaseReturnHeader PRH
										INNER JOIN PurchaseReturnDetail PRD
								ON		PRD.Prd_PrhId=PRH.Prh_Id
										GROUP BY PRH.Prh_Id
								)AS DT
			ON		DT.Prh_Id=D.Prh_Id
					LEFT JOIN VendorMaster E
			ON			D.Prh_VendorId=E.Vendor_ID
			WHERE	A.Tr_TxId NOT IN(1)
					AND CAST(D.Prh_Date AS DATE) BETWEEN CAST(@Pih_Date AS DATE) AND CAST(@Pih_Duedate AS DATE)

	END
	ELSE
	IF @SP_STATUS = 'GSTR-2'
	BEGIN
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_100000')
			BEGIN
				DROP TABLE ##TEMP_GST_100000
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_200000')
			BEGIN
				DROP TABLE ##TEMP_GST_200000
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_300000')
			BEGIN
				DROP TABLE ##TEMP_GST_300000
			END
		
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_400000')
			BEGIN
				DROP TABLE ##TEMP_GST_400000
			END
			
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_500000')
			BEGIN
				DROP TABLE ##TEMP_GST_500000
			END
			
		SELECT	A.Tr_DocTyp,
				A.Tr_DocKey,
				A.Tr_DdocKey,
				CASE WHEN Tr_TxId=2 THEN Tr_TxVal ELSE 0 END AS CGST_P,
				CASE WHEN Tr_TxId=3 THEN Tr_TxVal ELSE 0 END AS SGST_P,
				CASE WHEN Tr_TxId=4 THEN Tr_TxVal ELSE 0 END AS IGST_P,
				
				CASE WHEN Tr_TxId=2 THEN Tr_TxTot ELSE 0 END AS CGST_V,
				CASE WHEN Tr_TxId=3 THEN Tr_TxTot ELSE 0 END AS SGST_V,
				CASE WHEN Tr_TxId=4 THEN Tr_TxTot ELSE 0 END AS IGST_V
		INTO	##TEMP_GST_100000
		FROM	TaxTransaction A
		WHERE	A.Tr_TxId IN(2,3,4)
				AND A.Tr_DocTyp IN(4,5)
				
		SELECT	Tr_DocTyp,
				Tr_DocKey,
				Tr_DdocKey,
				SUM(CGST_P) AS CGST_P,
				SUM(SGST_P) AS SGST_P,
				SUM(IGST_P) AS IGST_P,
				
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		INTO	##TEMP_GST_200000
		FROM	##TEMP_GST_100000 A
		GROUP BY Tr_DocTyp,Tr_DocKey,Tr_DdocKey
		
		
		---Purchase INvoice
		SELECT	C.Pih_No AS Pih_No,
				C.Pih_Date,
				B.Pid_Amount AS Pid_SubTotal,
				A.*
		iNTO	##TEMP_GST_300000
		FROM	##TEMP_GST_200000 A
				iNNER JOIN PurchaseInvoiceDetail B
		ON			A.Tr_DdocKey=B.Pid_Key
					AND A.Tr_DocKey=B.Pid_PihKey
					AND A.Tr_DocTyp=4
				iNNER JOIN PurchaseInvoiceHeader C
		ON			B.Pid_PihKey=C.Pih_Key
			
		UNION
		---Purchase Return
		SELECT	C.Prh_No,
				C.Prh_Date,
				B.Prd_Amount,
				A.*
		FROM	##TEMP_GST_200000 A
				iNNER JOIN PurchaseReturnDetail B
		ON			A.Tr_DdocKey=B.Prd_ID
					 AND A.Tr_DocKey=B.Prd_PrhId
					 AND A.Tr_DocTyp=5
				iNNER JOIN PurchaseReturnHeader C
		ON			B.Prd_PrhId=C.Prh_Id
		
		
		
		SELECT	Tr_DocTyp,
				Tr_DocKey,
				Pih_No,
				Pih_Date,
				SUM(Pid_SubTotal) AS SubTotal,
				CGST_P,
				SGST_P,
				IGST_P,
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		iNTO	##TEMP_GST_400000
		FROM	##TEMP_GST_300000
		GROUP BY Tr_DocTyp,Tr_DocKey,Pih_No,Pih_Date,CGST_P,SGST_P,IGST_P
		
		SELECT	Tr_DocTyp,	
				Tr_DocKey,
				Pih_No,
				Pih_date,
				SUM(CASE WHEN CGST_P>0 OR IGST_P>0 THEN 0 ELSE SubTotal END) [Taxable_0],
				SUM(CASE WHEN CGST_P=0 THEN CGST_V ELSE 0 END) [CGST_0],
				SUM(CASE WHEN SGST_P=0 THEN SGST_V ELSE 0 END) [SGST_0],
				SUM(CASE WHEN IGST_P=0   THEN IGST_V ELSE 0 END) [IGST_0],
				
				SUM(CASE WHEN CGST_P=2.5 OR IGST_P=5 THEN SubTotal ELSE 0 END) [Taxable_2_5],
				SUM(CASE WHEN CGST_P=2.5 THEN CGST_V ELSE 0 END) [CGST_2_5],
				SUM(CASE WHEN SGST_P=2.5 THEN SGST_V ELSE 0 END) [SGST_2_5],
				SUM(CASE WHEN IGST_P=5   THEN IGST_V ELSE 0 END) [IGST_5],
				
				SUM(CASE WHEN CGST_P=6 OR IGST_P=12 THEN SubTotal ELSE 0 END) [Taxable_6],
				SUM(CASE WHEN CGST_P=6 THEN CGST_V ELSE 0 END) [CGST_6],
				SUM(CASE WHEN SGST_P=6 THEN SGST_V ELSE 0 END) [SGST_6],
				SUM(CASE WHEN IGST_P=12   THEN IGST_V ELSE 0 END) [IGST_12],
				
				SUM(CASE WHEN CGST_P=9 OR IGST_P=18 THEN SubTotal ELSE 0 END) [Taxable_9],
				SUM(CASE WHEN CGST_P=9 THEN CGST_V ELSE 0 END) [CGST_9],
				SUM(CASE WHEN SGST_P=9 THEN SGST_V ELSE 0 END) [SGST_9],
				SUM(CASE WHEN IGST_P=18   THEN IGST_V ELSE 0 END) [IGST_18],
				
				SUM(CASE WHEN CGST_P=14 OR IGST_P=28 THEN SubTotal ELSE 0 END) [Taxable_14],
				SUM(CASE WHEN CGST_P=14 THEN CGST_V ELSE 0 END) [CGST_14],
				SUM(CASE WHEN SGST_P=14 THEN SGST_V ELSE 0 END) [SGST_14],
				SUM(CASE WHEN IGST_P=28   THEN IGST_V ELSE 0 END) [IGST_28],
				
				SUM(SubTotal) AS SubTotal,
				SUM(CGST_V) AS CGST_TOT,
				SUM(SGST_V) AS SGST_TOT,
				SUM(IGST_V) AS IGST_TOT,
				SUM(CGST_V+SGST_V+IGST_V) AS Total_Tax
		iNTO	##TEMP_GST_500000
		FROM	##TEMP_GST_400000
		GROUP BY Tr_DocTyp,Tr_DocKey,Pih_No,Pih_date
		
		SELECT	'Purchase Invoice' AS DocType,
		        B.Pih_No AS InvoiceNo,
		        CONVERT(VARCHAR,B.Pih_Date,105)AS DATE,
		        DateName(MONTH,A.Pih_Date)AS MonthName,
		        Year(A.Pih_Date)AS Year,
		        E.Vendor_Name AS PartyName,
				A.Taxable_0,
				A.CGST_0,
				A.SGST_0,
				A.IGST_0,
				A.Taxable_2_5,
				A.CGST_2_5,
				A.SGST_2_5,
				A.IGST_5,
				A.Taxable_6,
				A.CGST_6,
				A.SGST_6,
				A.IGST_12,
				A.Taxable_9,
				A.CGST_9,
				A.SGST_9,
				A.IGST_18,
				A.Taxable_14,
				A.CGST_14,
				A.SGST_14,
				A.IGST_28,
				A.SubTotal,
				A.CGST_TOT,
				A.SGST_TOT,
				A.IGST_TOT,
				A.Total_Tax,
				0 AS Freight_Amount,
				(B.Pih_NetValue-(A.SubTotal+Total_Tax))AS RT,
				B.Pih_NetValue AS Sih_Total
		FROM	##TEMP_GST_500000 A
				iNNER jOIN PurchaseInvoiceHeader B
		ON			A.Tr_DocKey=B.Pih_Key
				AND A.Tr_DocTyp=4
				LEFT JOIN VendorMaster E
		ON		B.Pih_VenId=E.Vendor_Id
		WHERE	CAST(A.Pih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE) 
		
		UNION
		SELECT	'Purchase Return' AS Prh_DocType,
		        B.Prh_No AS InvoiceNo,
		        CONVERT(VARCHAR,B.Prh_Date,105)AS DATE,
		        DateName(MONTH,B.Prh_Date)AS MonthName,
		        Year(B.Prh_Date)AS Year,
		        EE.Vendor_Name AS PartyName,
				A.Taxable_0,
				A.CGST_0,
				A.SGST_0,
				A.IGST_0,
				A.Taxable_2_5,
				A.CGST_2_5,
				A.SGST_2_5,
				A.IGST_5,
				A.Taxable_6,
				A.CGST_6,
				A.SGST_6,
				A.IGST_12,
				A.Taxable_9,
				A.CGST_9,
				A.SGST_9,
				A.IGST_18,
				A.Taxable_14,
				A.CGST_14,
				A.SGST_14,
				A.IGST_28,
				A.SubTotal,
				A.CGST_TOT,
				A.SGST_TOT,
				A.IGST_TOT,
				A.Total_Tax,
				0 AS Freight_Amount,
				(B.Prh_TotalAmount-(A.SubTotal+Total_Tax))AS RT,
				B.Prh_TotalAmount AS Srh_Total
		FROM	##TEMP_GST_500000 A
				iNNER jOIN PurchaseReturnHeader B
		ON			A.Tr_DocKey=B.Prh_Id
				AND A.Tr_DocTyp=5
				
		        LEFT JOIN VendorMaster EE
		ON      B.Prh_VendorId=EE.Vendor_Id
		WHERE	CAST(A.Pih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE)
	END
	IF @SP_STATUS = 'PurchaseHeaderForReportWithFilter'
	BEGIN
	      IF(@Pid_MmId!=0)
		  BEGIN
	            SELECT DISTINCT  CONVERT(date, PH.Pih_Date) AS BillDate,
	                    PH.Pih_No AS BillNo,
	                    VM.Vendor_Name AS PartyName,
	                    ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
	                    ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
	                    ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
	                    PH.Pih_NetValue AS NetAmount,
	                    BM.Branch_Name,
	                    Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	                    bm.Branch_GstNo,
	                    BB.SGST,
	                    BB.CGST,
	                    BB.IGST
	               FROM PurchaseInvoiceHeader (NOLOCK) AS PH
	              LEFT JOIN VendorMaster (NOLOCK) AS VM
	                 ON PH.Pih_VenId = VM.Vendor_ID
	              LEFT JOIN BranchMaster (NOLOCK) BM
	                 ON PH.Pih_BmId = BM.Branch_Id
				  LEFT JOIN (SELECT
	               	A.Pid_PihKey,
	              	ISNULL(SUM(A.SGST),0) AS SGST,
	               	ISNULL(SUM(A.CGST),0) AS CGST,
	               	ISNULL(SUM(A.IGST),0) AS IGST
	               FROM (SELECT
	               	A.Pid_PihKey,
	               	B.Tr_TxTot AS CGST,
	               	C.Tr_TxTot AS SGST,
	               	D.Tr_TxTot AS IGST
	               FROM PurchaseInvoiceDetail (NOLOCK) AS A
	               LEFT JOIN TaxTransaction (NOLOCK) B
	               	ON A.Pid_Key = B.Tr_DdocKey
	               	AND A.Pid_PihKey = B.Tr_DocKey
	               	AND B.Tr_TxId = 2
	               	AND B.Tr_DocTyp = 4
	               LEFT JOIN TaxTransaction (NOLOCK) C
	               	ON A.Pid_Key = C.Tr_DdocKey
	               	AND A.Pid_PihKey = C.Tr_DocKey
	               	AND C.Tr_DocTyp = 4
	               	AND C.Tr_TxId = 3
	               LEFT JOIN TaxTransaction (NOLOCK) D
	               	ON A.Pid_Key = D.Tr_DdocKey
	               	AND A.Pid_PihKey = D.Tr_DocKey
	               	AND D.Tr_DocTyp = 4
	               	AND D.Tr_TxId = 4) AS A
	               GROUP BY A.Pid_PihKey) AS BB
	               	ON PH.Pih_Key = BB.Pid_PihKey
	              INNER JOIN PurchaseInvoiceDetail (NOLOCK) PID
				     ON PID.Pid_PihKey= PH.Pih_Key
					    
				  INNER JOIN MedicineMaster (NOLOCK) MM
				     ON MM.Mm_ID=PID.Pid_MmId
	                 WHERE CONVERT(date, PH.Pih_Date) BETWEEN  CONVERT(date, @Pih_Date, 105) AND CONVERT(date, @Pih_Duedate, 105) AND MM.Mm_MtmId=@Pid_MmId;
       	     END
			 ELSE
			 BEGIN
			      SELECT DISTINCT  CONVERT(date, PH.Pih_Date) AS BillDate,
	                    PH.Pih_No AS BillNo,
	                    VM.Vendor_Name AS PartyName,
	                    ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
	                    ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
	                    ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
	                    PH.Pih_NetValue AS NetAmount,
	                    BM.Branch_Name,
	                    Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	                    bm.Branch_GstNo,
	                    BB.SGST,
	                    BB.CGST,
	                    BB.IGST
	               FROM PurchaseInvoiceHeader (NOLOCK) AS PH
	              LEFT JOIN VendorMaster (NOLOCK) AS VM
	                 ON PH.Pih_VenId = VM.Vendor_ID
	              LEFT JOIN BranchMaster (NOLOCK) BM
	                 ON PH.Pih_BmId = BM.Branch_Id
				  LEFT JOIN (SELECT
	               	A.Pid_PihKey,
	               	ISNULL(SUM(A.SGST),0) AS SGST,
	               	ISNULL(SUM(A.CGST),0) AS CGST,
	               	ISNULL(SUM(A.IGST),0) AS IGST
	               FROM (SELECT
	               	A.Pid_PihKey,
	               	B.Tr_TxTot AS CGST,
	               	C.Tr_TxTot AS SGST,
	               	D.Tr_TxTot AS IGST
	               FROM PurchaseInvoiceDetail (NOLOCK) AS A
	               LEFT JOIN TaxTransaction (NOLOCK) B
	               	ON A.Pid_Key = B.Tr_DdocKey
	               	AND A.Pid_PihKey = B.Tr_DocKey
	               	AND B.Tr_TxId = 2
	               	AND B.Tr_DocTyp = 4
	               LEFT JOIN TaxTransaction (NOLOCK) C
	               	ON A.Pid_Key = C.Tr_DdocKey
	               	AND A.Pid_PihKey = C.Tr_DocKey
	               	AND C.Tr_DocTyp = 4
	               	AND C.Tr_TxId = 3
	               LEFT JOIN TaxTransaction  (NOLOCK) D
	               	ON A.Pid_Key = D.Tr_DdocKey
	               	AND A.Pid_PihKey = D.Tr_DocKey
	               	AND D.Tr_DocTyp = 4
	               	AND D.Tr_TxId = 4) AS A
	               GROUP BY A.Pid_PihKey) AS BB
	               	ON PH.Pih_Key = BB.Pid_PihKey
	              INNER JOIN PurchaseInvoiceDetail (NOLOCK) PID
				     ON PID.Pid_PihKey= PH.Pih_Key
					    
				  INNER JOIN MedicineMaster (NOLOCK) MM
				     ON MM.Mm_ID=PID.Pid_MmId
	                 WHERE CONVERT(date, PH.Pih_Date) BETWEEN  CONVERT(date, @Pih_Date, 105) AND CONVERT(date, @Pih_Duedate, 105);
       	    
			 END   
	END;
	ELSE IF @SP_STATUS ='Purchase_HSN'
		BEGIN
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_1111')
				BEGIN
					DROP TABLE ##TEMP_GST_1111
				END
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_2222')
				BEGIN
					DROP TABLE ##TEMP_GST_2222
				END
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_3333')
				BEGIN
					DROP TABLE ##TEMP_GST_3333
				END
			
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_4444')
				BEGIN
					DROP TABLE ##TEMP_GST_4444
				END
				
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_5555')
				BEGIN
					DROP TABLE ##TEMP_GST_5555
				END
				
			SELECT	A.Tr_DocTyp,
					A.Tr_DocKey,
					A.Tr_DdocKey,
					CASE WHEN Tr_TxId=2 THEN Tr_TxVal ELSE 0 END AS CGST_P,
					CASE WHEN Tr_TxId=3 THEN Tr_TxVal ELSE 0 END AS SGST_P,
					CASE WHEN Tr_TxId=4 THEN Tr_TxVal ELSE 0 END AS IGST_P,
					
					CASE WHEN Tr_TxId=2 THEN Tr_TxTot ELSE 0 END AS CGST_V,
					CASE WHEN Tr_TxId=3 THEN Tr_TxTot ELSE 0 END AS SGST_V,
					CASE WHEN Tr_TxId=4 THEN Tr_TxTot ELSE 0 END AS IGST_V
			INTO	##TEMP_GST_1111
			FROM	TaxTransaction A
			WHERE	A.Tr_TxId IN(2,3,4)
					AND A.Tr_DocTyp IN(4,5)
					
			SELECT	Tr_DocTyp,
					Tr_DocKey,
					Tr_DdocKey,
					SUM(CGST_P) AS CGST_P,
					SUM(SGST_P) AS SGST_P,
					SUM(IGST_P) AS IGST_P,
					
					SUM(CGST_V) AS CGST_V,
					SUM(SGST_V) AS SGST_V,
					SUM(IGST_V) AS IGST_V
			INTO	##TEMP_GST_2222
			FROM	##TEMP_GST_1111 A
			GROUP BY Tr_DocTyp,Tr_DocKey,Tr_DdocKey
			
			
			---Purchase INvoice
			SELECT	C.Mm_HsnCode,
					B.Pid_Amount,
					A.*
			iNTO	##TEMP_GST_3333
			FROM	##TEMP_GST_2222 A
					iNNER JOIN PurchaseInvoiceDetail B
			ON			A.Tr_DdocKey=B.Pid_Key
						AND A.Tr_DocKey=B.Pid_PihKey
						AND A.Tr_DocTyp=4
					INNER JOIN MedicineMaster C
			ON			C.Mm_Id=B.Pid_MmId
					iNNER JOIN PurchaseInvoiceHeader D
			ON			B.Pid_PihKey=D.Pih_Key
				
			UNION
			---Purchase Return
			SELECT	C.Mm_HsnCode,
					B.Prd_Amount,
					A.*
			FROM	##TEMP_GST_2222 A
					iNNER JOIN PurchaseReturnDetail B
			ON			A.Tr_DdocKey=B.Prd_ID
						 AND A.Tr_DocKey=B.Prd_PrhId
						 AND A.Tr_DocTyp=5
					INNER JOIN MedicineMaster C
			ON			C.Mm_Id=B.Prd_MmId
					iNNER JOIN PurchaseReturnHeader D
			ON			B.Prd_PrhId=D.Prh_Id
			
			
			
			
			SELECT	Mm_HsnCode,
					Tr_DocTyp,
					Tr_DocKey,
					SUM(Pid_Amount) AS SubTotal,
					CGST_P,
					SGST_P,
					IGST_P,
					SUM(CGST_V) AS CGST_V,
					SUM(SGST_V) AS SGST_V,
					SUM(IGST_V) AS IGST_V
			iNTO	##TEMP_GST_4444
			FROM	##TEMP_GST_3333
			GROUP BY Tr_DocTyp,Tr_DocKey,CGST_P,SGST_P,IGST_P,Mm_HsnCode
			
			SELECT	Mm_HsnCode,
					Tr_DocTyp,	
					Tr_DocKey,
					SUM(CASE WHEN CGST_P>0 OR IGST_P>0 THEN 0 ELSE SubTotal END) [Taxable_0],
					SUM(CASE WHEN CGST_P=0 THEN CGST_V ELSE 0 END) [CGST_0],
					SUM(CASE WHEN SGST_P=0 THEN SGST_V ELSE 0 END) [SGST_0],
					SUM(CASE WHEN IGST_P=0   THEN IGST_V ELSE 0 END) [IGST_0],
					
					SUM(CASE WHEN CGST_P=2.5 OR IGST_P=5 THEN SubTotal ELSE 0 END) [Taxable_2_5],
					SUM(CASE WHEN CGST_P=2.5 THEN CGST_V ELSE 0 END) [CGST_2_5],
					SUM(CASE WHEN SGST_P=2.5 THEN SGST_V ELSE 0 END) [SGST_2_5],
					SUM(CASE WHEN IGST_P=5   THEN IGST_V ELSE 0 END) [IGST_5],
					
					SUM(CASE WHEN CGST_P=6 OR IGST_P=12 THEN SubTotal ELSE 0 END) [Taxable_6],
					SUM(CASE WHEN CGST_P=6 THEN CGST_V ELSE 0 END) [CGST_6],
					SUM(CASE WHEN SGST_P=6 THEN SGST_V ELSE 0 END) [SGST_6],
					SUM(CASE WHEN IGST_P=12   THEN IGST_V ELSE 0 END) [IGST_12],
					
					SUM(CASE WHEN CGST_P=9 OR IGST_P=18 THEN SubTotal ELSE 0 END) [Taxable_9],
					SUM(CASE WHEN CGST_P=9 THEN CGST_V ELSE 0 END) [CGST_9],
					SUM(CASE WHEN SGST_P=9 THEN SGST_V ELSE 0 END) [SGST_9],
					SUM(CASE WHEN IGST_P=18   THEN IGST_V ELSE 0 END) [IGST_18],
					
					SUM(CASE WHEN CGST_P=14 OR IGST_P=28 THEN SubTotal ELSE 0 END) [Taxable_14],
					SUM(CASE WHEN CGST_P=14 THEN CGST_V ELSE 0 END) [CGST_14],
					SUM(CASE WHEN SGST_P=14 THEN SGST_V ELSE 0 END) [SGST_14],
					SUM(CASE WHEN IGST_P=28   THEN IGST_V ELSE 0 END) [IGST_28],
					
					SUM(SubTotal) AS SubTotal,
					SUM(CGST_V) AS CGST_TOT,
					SUM(SGST_V) AS SGST_TOT,
					SUM(IGST_V) AS IGST_TOT,
					SUM(CGST_V+SGST_V+IGST_V) AS Total_Tax
			iNTO	##TEMP_GST_5555
			FROM	##TEMP_GST_4444
			GROUP BY Tr_DocTyp,Tr_DocKey,Mm_HsnCode
			SELECT * FROM
			(
			SELECT	'Purchase Invoice' AS DocType,
					A.Mm_HsnCode,
					SUM(A.Taxable_0)AS Taxable_0,
					SUM(A.CGST_0)AS CGST_0,
					SUM(A.SGST_0)AS SGST_0,
					SUM(A.IGST_0)AS IGST_0,
					SUM(A.Taxable_2_5)AS Taxable_2_5,
					SUM(A.CGST_2_5)AS CGST_2_5,
					SUM(A.SGST_2_5)AS SGST_2_5,
					SUM(A.IGST_5)AS IGST_5,
					SUM(A.Taxable_6)AS Taxable_6,
					SUM(A.CGST_6)AS CGST_6,
					SUM(A.SGST_6)AS SGST_6,
					SUM(A.IGST_12)AS IGST_12,
					SUM(A.Taxable_9)AS Taxable_9,
					SUM(A.CGST_9)AS CGST_9,
					SUM(A.SGST_9)AS SGST_9,
					SUM(A.IGST_18)AS IGST_18,
					SUM(A.Taxable_14)AS Taxable_14,
					SUM(A.CGST_14)AS CGST_14,
					SUM(A.SGST_14)AS SGST_14,
					SUM(A.IGST_28)AS IGST_28,
					SUM(A.CGST_TOT)AS CGST_TOT,
					SUM(A.SGST_TOT)AS SGST_TOT,
					SUM(A.IGST_TOT)AS IGST_TOT,
					SUM(A.Total_Tax)AS Total_Tax
					
			FROM	##TEMP_GST_5555 A
					iNNER jOIN PurchaseInvoiceHeader B
			ON			A.Tr_DocKey=B.Pih_Key
					AND A.Tr_DocTyp=4
				
			WHERE	CAST(B.Pih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE) 
					GROUP BY A.Mm_HsnCode
						
			UNION
			SELECT	'Purchase Return' AS Prh_DocType,
					A.Mm_HsnCode,
			        SUM(A.Taxable_0)AS Taxable_0,
					SUM(A.CGST_0)AS CGST_0,
					SUM(A.SGST_0)AS SGST_0,
					SUM(A.IGST_0)AS IGST_0,
					SUM(A.Taxable_2_5)AS Taxable_2_5,
					SUM(A.CGST_2_5)AS CGST_2_5,
					SUM(A.SGST_2_5)AS SGST_2_5,
					SUM(A.IGST_5)AS IGST_5,
					SUM(A.Taxable_6)AS Taxable_6,
					SUM(A.CGST_6)AS CGST_6,
					SUM(A.SGST_6)AS SGST_6,
					SUM(A.IGST_12)AS IGST_12,
					SUM(A.Taxable_9)AS Taxable_9,
					SUM(A.CGST_9)AS CGST_9,
					SUM(A.SGST_9)AS SGST_9,
					SUM(A.IGST_18)AS IGST_18,
					SUM(A.Taxable_14)AS Taxable_14,
					SUM(A.CGST_14)AS CGST_14,
					SUM(A.SGST_14)AS SGST_14,
					SUM(A.IGST_28)AS IGST_28,
					SUM(A.CGST_TOT)AS CGST_TOT,
					SUM(A.SGST_TOT)AS SGST_TOT,
					SUM(A.IGST_TOT)AS IGST_TOT,
					SUM(A.Total_Tax)AS Total_Tax
			FROM	##TEMP_GST_5555 A
					iNNER jOIN PurchaseReturnHeader B
			ON			A.Tr_DocKey=B.Prh_Id
					AND A.Tr_DocTyp=5
					
			       
			WHERE	CAST(B.Prh_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE)
			GROUP BY A.Mm_HsnCode)AS DT 
			ORDER BY  DocType ASC
		END;
	IF @SP_STATUS = 'PurchaseHeaderForReportWithFilter_HSN'
	BEGIN
	     IF(@Pid_MmId!=0)
		 BEGIN
				SELECT	B.Mm_HsnCode AS HSNCode,
						DT1.QTY AS QTY,
						SUM(AA.Pid_Amount) AS SubTotal,
						SUM(Tr_TxTot) AS TaxTotal,
						TX.Tax_Name AS TaxName,
						Tr_TxVal AS TaxValue,
						DT1.TotalAmount
				FROM	PurchaseInvoiceDetail (NOLOCK) AA
						INNER JOIN MedicineMaster (NOLOCK) B
				ON			AA.Pid_MmId = B.Mm_ID
						INNER JOIN (SELECT	SUM(TX.Tr_TxTot)AS TotalAmount,
											SUM(PID.Pid_Qty)AS QTY,
											MM.Mm_HsnCode 
									FROM	PurchaseInvoiceDetail PID
											INNER JOIN TaxTransaction  TX
									ON		PID.Pid_Key = TX.Tr_DdocKey
            								AND PID.Pid_PihKey = TX.Tr_DocKey
            								AND TX.Tr_TxId in (1)
            								AND TX.Tr_DocTyp = 2
											INNER JOIN MedicineMaster MM
									ON		PID.Pid_MmId = MM.Mm_ID 
											GROUP BY MM.Mm_HsnCode)AS DT1
			ON		DT1.Mm_HsnCode=B.Mm_HsnCode
						LEFT JOIN MedicineTypeMaster (NOLOCK) MTM
				ON			MTM.Mtm_ID=B.Mm_MtmId
						LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
				ON			MGM.Mgm_ID=B.Mm_MgmId
						LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
				ON			MCM.Mcm_ID=B.Mm_McmId
						LEFT JOIN PurchaseInvoiceHeader (NOLOCK) AS SH
				ON			SH.Pih_Key = AA.Pid_PihKey
						LEFT JOIN BranchMaster (NOLOCK) BM
				ON			SH.Pih_BmId = BM.Branch_Id
						INNER JOIN TaxTransaction (NOLOCK) BB
				ON			AA.Pid_Key = BB.Tr_DdocKey
            				AND AA.Pid_PihKey = BB.Tr_DocKey
            				AND BB.Tr_TxId in (2,3,4)
            				AND BB.Tr_DocTyp = 4
						INNER JOIN TaxMaster TX
				ON			TX.Tax_ID=BB.Tr_TxId
				WHERE	B.Mm_MtmId=@Pid_MmId 
						AND CAST(SH.Pih_Date AS DATE) BETWEEN CAST(@Pih_Date AS DATE) AND CAST( @Pih_Duedate AS DATE) 
			GROUP BY	B.Mm_HsnCode,
						TX.Tax_Name,
						Tr_TxVal,
						DT1.TotalAmount,
						DT1.QTY
				
		 END
		 ELSE
		 BEGIN
				SELECT	B.Mm_HsnCode AS HSNCode,
						DT1.QTY AS QTY,
						SUM(AA.Pid_Amount) AS SubTotal,
						SUM(Tr_TxTot) AS TaxTotal,
						TX.Tax_Name AS TaxName,
						Tr_TxVal AS TaxValue,
						DT1.TotalAmount
				FROM	PurchaseInvoiceDetail (NOLOCK) AA
						INNER JOIN MedicineMaster (NOLOCK) B
				ON			AA.Pid_MmId = B.Mm_ID
						INNER JOIN (SELECT	SUM(TX.Tr_TxTot)AS TotalAmount,
											SUM(PID.Pid_Qty)AS QTY,
											MM.Mm_HsnCode 
									FROM	PurchaseInvoiceDetail PID
											INNER JOIN TaxTransaction  TX
									ON		PID.Pid_Key = TX.Tr_DdocKey
            								AND PID.Pid_PihKey = TX.Tr_DocKey
            								AND TX.Tr_TxId in (1)
            								AND TX.Tr_DocTyp = 4
											INNER JOIN MedicineMaster MM
									ON		PID.Pid_MmId = MM.Mm_ID 
											GROUP BY MM.Mm_HsnCode)AS DT1
				ON		DT1.Mm_HsnCode=B.Mm_HsnCode
						LEFT JOIN MedicineTypeMaster (NOLOCK) MTM
				ON			MTM.Mtm_ID=B.Mm_MtmId
						LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
				ON			MGM.Mgm_ID=B.Mm_MgmId
						LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
				ON			MCM.Mcm_ID=B.Mm_McmId
						LEFT JOIN PurchaseInvoiceHeader (NOLOCK) AS SH
				ON			SH.Pih_Key = AA.Pid_PihKey
						LEFT JOIN BranchMaster (NOLOCK) BM
				ON			SH.Pih_BmId = BM.Branch_Id
						INNER JOIN TaxTransaction (NOLOCK) BB
				ON			AA.Pid_Key = BB.Tr_DdocKey
            				AND AA.Pid_PihKey = BB.Tr_DocKey
            				AND BB.Tr_TxId in (2,3,4)
            				AND BB.Tr_DocTyp = 4
						INNER JOIN TaxMaster TX
				ON			TX.Tax_ID=BB.Tr_TxId
				WHERE	CAST(SH.Pih_Date AS DATE) BETWEEN CAST(@Pih_Date AS DATE) AND CAST( @Pih_Duedate AS DATE) 
			GROUP BY	B.Mm_HsnCode,
						TX.Tax_Name,
						Tr_TxVal,
						DT1.TotalAmount,
						DT1.QTY
		 END
	END
	ELSE
	IF @SP_STATUS = 'SP_RPT_PurchaseReportAbstract'
	BEgin
	     IF(@Pid_MmId!=0)
		 BEGIN
	          SELECT	PIH.Pih_No AS InvoiceNo,
	          			CONVERT(varchar, PIH.Pih_Date, 105) AS InvoiceDate,
	          			VM.Vendor_Name AS VendorName,
	          			SUM(PRODUCTQTY * PURRATE) AS PURCHASERATE,
	          			SUM(QTY * MRP) AS MRP,
	          			SUM(QTY * SALERATE) AS SALESRATE,
	          			(SUM(QTY * MRP) - SUM(QTY * PURRATE)) AS MRPMARGIN,
	          			(SUM(QTY * SALERATE) - SUM(QTY * PURRATE)) AS SALESMARGIN,
	          			BM.Branch_Name,
	                      Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	                      bm.Branch_GstNo
	          
	          FROM PurchaseInvoiceHeader (NOLOCK) PIH
	          INNER JOIN (SELECT
	          (ISNULL(PID.Pid_Qty, 0) + ISNULL(PID.Pid_FreeQty, 0)) AS QTY,
	          ISNULL(PID.Pid_Qty, 0) AS PRODUCTQTY,
	          PID.Pid_MRP AS MRP,
	          PID.Pid_Rate AS PURRATE,
	          SR.Stk_SalesRate AS SALERATE,
	          PID.Pid_PihKey AS PIDNO,
			  MM.Mm_MtmId 
	          FROM PurchaseInvoiceDetail (NOLOCK) PID
	          INNER JOIN StockRegister   (NOLOCK)  SR
	          ON SR.Stk_MmId = PID.Pid_MmId and sr.Stk_DocType='4'
	          AND SR.Stk_BatchNo = PID.Pid_BatchNo
			  LEFT JOIN MedicineMaster (NOLOCK)  MM
			  ON MM.Mm_ID=PID.Pid_MmId) AS PIDTABLE
	          ON PIDTABLE.PIDNO = PIH.Pih_Key
	          INNER JOIN VendorMaster (NOLOCK)  VM
	          ON VM.Vendor_ID = PIH.Pih_VenId
	          LEFT JOIN BranchMaster (NOLOCK)  BM
	          ON PIH.Pih_BmId = BM.Branch_Id
	          WHERE CONVERT(date, Pih_Date) BETWEEN CONVERT(date, @Pih_Date) AND CONVERT(date, @Pih_Duedate) AND PIDTABLE.Mm_MtmId=@Pid_MmId
	          GROUP BY	PIH.Pih_No,
	          			PIH.Pih_Date,
	          			VM.Vendor_Name,
	          			BM.Branch_Name,
	          			Bm.Branch_Address1,
	          			Bm.Branch_Address2,
	          			Bm.Branch_Address3,
	          			bm.Branch_GstNo
	          ORDER BY Pih_Date ASC
		 END
		 ELSE 
		 BEGIN
		      SELECT	PIH.Pih_No AS InvoiceNo,
	          			CONVERT(varchar, PIH.Pih_Date, 105) AS InvoiceDate,
	          			VM.Vendor_Name AS VendorName,
	          			SUM(PRODUCTQTY * PURRATE) AS PURCHASERATE,
	          			SUM(QTY * MRP) AS MRP,
	          			SUM(QTY * SALERATE) AS SALESRATE,
	          			(SUM(QTY * MRP) - SUM(QTY * PURRATE)) AS MRPMARGIN,
	          			(SUM(QTY * SALERATE) - SUM(QTY * PURRATE)) AS SALESMARGIN,
	          			BM.Branch_Name,
	                      Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
	                      bm.Branch_GstNo
	          
	          FROM PurchaseInvoiceHeader  (NOLOCK) PIH
	          INNER JOIN (SELECT
	          (ISNULL(PID.Pid_Qty, 0) + ISNULL(PID.Pid_FreeQty, 0)) AS QTY,
	          ISNULL(PID.Pid_Qty, 0) AS PRODUCTQTY,
	          PID.Pid_MRP AS MRP,
	          PID.Pid_Rate AS PURRATE,
	          SR.Stk_SalesRate AS SALERATE,
	          PID.Pid_PihKey AS PIDNO,
			  MM.Mm_MtmId 
	          FROM PurchaseInvoiceDetail  (NOLOCK) PID
	          INNER JOIN StockRegister  (NOLOCK) SR
	          ON SR.Stk_MmId = PID.Pid_MmId and sr.Stk_DocType='4'
	          AND SR.Stk_BatchNo = PID.Pid_BatchNo
			  LEFT JOIN MedicineMaster  (NOLOCK) MM
			  ON MM.Mm_ID=PID.Pid_MmId) AS PIDTABLE
	          ON PIDTABLE.PIDNO = PIH.Pih_Key
	          INNER JOIN VendorMaster  (NOLOCK) VM
	          ON VM.Vendor_ID = PIH.Pih_VenId
	          LEFT JOIN BranchMaster  (NOLOCK) BM
	          ON PIH.Pih_BmId = BM.Branch_Id
			  
	          WHERE CONVERT(date, Pih_Date) BETWEEN CONVERT(date, @Pih_Date) AND CONVERT(date, @Pih_Duedate) 
	          GROUP BY	PIH.Pih_No,
	          			PIH.Pih_Date,
	          			VM.Vendor_Name,
	          			BM.Branch_Name,
	          			Bm.Branch_Address1,
	          			Bm.Branch_Address2,
	          			Bm.Branch_Address3,
	          			bm.Branch_GstNo
	          ORDER BY Pih_Date ASC
		 END
	End
	ELSE
	IF @SP_STATUS = 'PurchaseDetailForReportWithFilter'
	BEGIN
	     IF(@Pid_MmId!=0)
		 BEGIN
              SELECT CONVERT(date, PH.Pih_Date) AS BillDate,
                	 PH.Pih_No AS BillNo,
                	 VM.Vendor_Name AS PartyName,
                	 ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
                	 ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
                	 ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
                	 PH.Pih_NetValue AS NetAmount,
                	 BM.Branch_Name,
                	 Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
                	 bm.Branch_GstNo,
					 MM.Mm_HsnCode AS HsnCode,
					 MM.Mm_Code AS DrugCode,
                	 MM.Mm_Name MedicinName,
                	 UM.Uom_Name AS UOM,
                	 MM.MM_PackSize AS PackSize,
                	 PID.Pid_ExpiryDt AS ExpDate,
                	 PID.Pid_BatchNo AS BatchNo,
                	 PID.Pid_Rate AS Rate,
                	 PID.Pid_AmountTotal AS Total,
                	 PID.Pid_Qty AS Qty,
					 MTM.Mtm_TypeName AS DrugType,
					 MGM.Mgm_Name AS DrugGroup,
					 MCM.Mcm_Name AS DrugCategory
            	FROM PurchaseInvoiceHeader (NOLOCK)  AS PH
            	LEFT JOIN PurchaseInvoiceDetail  (NOLOCK) AS PID
            		ON PH.Pih_Key = PID.Pid_PihKey
            	LEFT JOIN VendorMaster  (NOLOCK) AS VM
            		ON PH.Pih_VenId = VM.Vendor_ID
            	LEFT JOIN BranchMaster  (NOLOCK) BM
            		ON PH.Pih_BmId = BM.Branch_Id
            	LEFT JOIN MedicineMaster  (NOLOCK) MM
            		ON PID.Pid_MmId = MM.Mm_ID
            	LEFT JOIN UomMaster  (NOLOCK) AS UM
            		ON PID.Pid_UomId = UM.Uom_ID
			    LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
				   ON MTM.Mtm_ID=MM.Mm_MtmId
				LEFT JOIN MedicineGroupMaster  (NOLOCK) MGM
				   ON MGM.Mgm_ID=MM.Mm_MgmId
				LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
				   ON MCM.Mcm_ID=MM.Mm_McmId
            	--LEFT JOIN PacketSizeMater AS PSM
            	--  ON PSM.Ps_ID = PID.Pid_PackId
            	WHERE CONVERT(date, PH.Pih_Date) BETWEEN CONVERT(date, @Pih_Date, 105) AND CONVERT(date, @Pih_Duedate, 105) AND  MM.Mm_MtmId=@Pid_MmId
		 END
		 ELSE
		 BEGIN
		      SELECT CONVERT(date, PH.Pih_Date) AS BillDate,
                	 PH.Pih_No AS BillNo,
                	 VM.Vendor_Name AS PartyName,
                	 ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
                	 ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
                	 ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
                	 PH.Pih_NetValue AS NetAmount,
                	 BM.Branch_Name,
                	 Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
                	 bm.Branch_GstNo,
					 MM.Mm_Code AS DrugCode,
                	 MM.Mm_Name MedicinName,
                	 UM.Uom_Name AS UOM,
                	 MM.MM_PackSize AS PackSize,
                	 PID.Pid_ExpiryDt AS ExpDate,
                	 PID.Pid_BatchNo AS BatchNo,
                	 PID.Pid_Rate AS Rate,
                	 PID.Pid_AmountTotal AS Total,
                	 PID.Pid_Qty AS Qty,
					 MTM.Mtm_TypeName AS DrugType,
					 MGM.Mgm_Name AS DrugGroup,
					 MCM.Mcm_Name AS DrugCategory
            	FROM PurchaseInvoiceHeader  (NOLOCK) AS PH
            	LEFT JOIN PurchaseInvoiceDetail  (NOLOCK) AS PID
            		ON PH.Pih_Key = PID.Pid_PihKey
            	LEFT JOIN VendorMaster  (NOLOCK) AS VM
            		ON PH.Pih_VenId = VM.Vendor_ID
            	LEFT JOIN BranchMaster  (NOLOCK) BM
            		ON PH.Pih_BmId = BM.Branch_Id
            	LEFT JOIN MedicineMaster  (NOLOCK) MM
            		ON PID.Pid_MmId = MM.Mm_ID
            	LEFT JOIN UomMaster  (NOLOCK) AS UM
            		ON PID.Pid_UomId = UM.Uom_ID
			    LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
				   ON MTM.Mtm_ID=MM.Mm_MtmId
				LEFT JOIN MedicineGroupMaster  (NOLOCK) MGM
				   ON MGM.Mgm_ID=MM.Mm_MgmId
				LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
				   ON MCM.Mcm_ID=MM.Mm_McmId
            	--LEFT JOIN PacketSizeMater AS PSM
            	--  ON PSM.Ps_ID = PID.Pid_PackId
            	WHERE CONVERT(date, PH.Pih_Date) BETWEEN CONVERT(date, @Pih_Date, 105) AND CONVERT(date, @Pih_Duedate, 105) 
		 END
	
	END;
	ELSE
	IF @SP_STATUS = 'GetMedicineDetail'
		BEGIN
		SELECT	*
		FROM	MedicineMaster  (NOLOCK) AS mm
		WHERE		Mm_ID = @Pid_MmId
				AND Mm_IsActive = 1
	END;

	ELSE
	IF @SP_STATUS = 'GetRefNo'
	BEGIN
	SELECT Pih_RefNo
	FROM  [PurchaseInvoiceHeader] (NOLOCK) AS pih
	WHERE pih.Pih_No=@Pih_No and isnull(pih.Pih_RefNo,'')!=''
	END;
	



	ELSE IF  @SP_STATUS ='GET_PURCHASE_NO'
	   BEGIN 
	      SELECT  PIH.Pih_No FROM [PurchaseInvoiceHeader] (NOLOCK) PIH
		   WHERE   PIH.Pih_Key = @Pih_Key
	   END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
		BEGIN
			DECLARE @MSG_OUT1 NVARCHAR(MAX)
			
			EXEC [SP_Tbl_Dependency1] 'PurchaseInvoiceDetail', @Pid_BatchNo,@MSG_OUT1 OUTPUT
			
			IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
				BEGIN
					RAISERROR(@MSG_OUT1,14,9)
				END
		END
		ELSE IF @SP_STATUS = 'CHECK_IS_CONSUMED'
		BEGIN
				declare @CrQty as decimal(18,3);
				declare @DrQty as decimal(18,3);
				declare @TotQty as decimal(18,3);
				declare @CrCnt as decimal(18,3);
				Select @CrQty=SUM(ISNULL(Stk_SalesQty,0)) from StockRegister Where Stk_MmId=@Pid_MmId and Stk_BatchNo=@Pid_BatchNo and Stk_Tran_Typ='C' group by Stk_MmId;
				Select @DrQty=SUM(ISNULL(Stk_SalesQty,0)) from StockRegister Where Stk_MmId=@Pid_MmId and Stk_BatchNo=@Pid_BatchNo and Stk_Tran_Typ='D' group by Stk_MmId;

				Select @CrCnt=count(*) from StockRegister Where Stk_MmId=@Pid_MmId and Stk_BatchNo=@Pid_BatchNo and Stk_Tran_Typ='C' group by Stk_MmId;
				Set @TotQty= ISNULL(ISNULL(@CrQty,0)-ISNULL(@DrQty,0),0);	

				Set @TotQty= ISNULL(ISNULL(@CrQty,0)-ISNULL(@DrQty,0),0);	
				Select ISNULL(@TotQty,0) as CurrentStock,@CrCnt as CrCnt;
		END
		ELSE IF @SP_STATUS = 'CHECK_IS_CONSUMED_ALL'
		BEGIN
				Select count(*) as PreventDelete from (
				Select case when ZZ.Pid_Qty <= Z.StkQty then 1 else 0 end as ST
				from(
				Select X.Stk_MmId,x.Stk_BatchNo,ISNULL((ISNULL(X.CrQty,0)-ISNULL(y.DrQty,0)),0) AS StkQty 
				from 
				(Select Stk_MmId,Stk_BatchNo,SUM(ISNULL(Stk_PurchaseQty,0)) as CrQty  
				from StockRegister as A
				Where A.Stk_Tran_Typ='C' and A.Stk_MmId in (Select Pid_MmId from PurchaseInvoiceDetail Where Pid_PihKey=@Pih_Key)
				and A.Stk_BatchNo in (Select Pid_BatchNo from PurchaseInvoiceDetail Where Pid_PihKey=@Pih_Key)
				Group by Stk_MmId,Stk_BatchNo
				) as X
				LEFT Join (
				Select Stk_MmId,Stk_BatchNo,SUM(ISNULL(Stk_PurchaseQty,0)) as DrQty  
				from StockRegister as A
				Where A.Stk_Tran_Typ='D' and A.Stk_MmId in (Select Pid_MmId from PurchaseInvoiceDetail Where Pid_PihKey=@Pih_Key)
				and A.Stk_BatchNo in (Select Pid_BatchNo from PurchaseInvoiceDetail Where Pid_PihKey=@Pih_Key)
				Group by Stk_MmId,Stk_BatchNo) as Y
				ON X.Stk_MmId=Y.Stk_MmId and X.Stk_BatchNo=Y.Stk_BatchNo
				) as Z
				INNER JOIN(
				Select Pid_MmId,Pid_Qty,Pid_BatchNo 
				from PurchaseInvoiceDetail
				Where Pid_PihKey=@Pih_Key) as ZZ
				ON Z.Stk_MmId=ZZ.Pid_MmId and Z.Stk_BatchNo=ZZ.Pid_BatchNo
				) as ZZZ
				Where ZZZ.ST=0
		END
	ELSE IF @SP_STATUS = 'GetOverDueBills'
		BEGIN
		SELECT CONVERT(date, PH.Pih_Date) AS BillDate,
                	 PH.Pih_No AS BillNo,
                	 VM.Vendor_Name AS PartyName,
                	 ISNULL(PH.Pih_GrossValue, 0.00) AS GrossAmount,
                	 ISNULL(PH.Pih_NetValue, 0.00) - ISNULL(PH.Pih_GrossValue, 0.00) AS TaxAmount,
                	 ISNULL(PH.Pih_DiscAmt, 0.00) AS Discount,
                	 PH.Pih_NetValue AS NetAmount,
                	 BM.Branch_Name,
                	 Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
                	 bm.Branch_GstNo,
					 MM.Mm_HsnCode AS HsnCode,
					 MM.Mm_Code AS DrugCode,
                	 MM.Mm_Name MedicinName,
                	 UM.Uom_Name AS UOM,
                	 MM.MM_PackSize AS PackSize,
                	 PID.Pid_ExpiryDt AS ExpDate,
                	 PID.Pid_BatchNo AS BatchNo,
                	 PID.Pid_Rate AS Rate,
                	 PID.Pid_AmountTotal AS Total,
                	 PID.Pid_Qty AS Qty,
					 MTM.Mtm_TypeName AS DrugType,
					 MGM.Mgm_Name AS DrugGroup,
					 MCM.Mcm_Name AS DrugCategory,
					 ph.Pih_Duedate as DueDate
            	FROM PurchaseInvoiceHeader (NOLOCK)  AS PH
            	LEFT JOIN PurchaseInvoiceDetail  (NOLOCK) AS PID
            		ON PH.Pih_Key = PID.Pid_PihKey
            	LEFT JOIN VendorMaster  (NOLOCK) AS VM
            		ON PH.Pih_VenId = VM.Vendor_ID
            	LEFT JOIN BranchMaster  (NOLOCK) BM
            		ON PH.Pih_BmId = BM.Branch_Id
            	LEFT JOIN MedicineMaster  (NOLOCK) MM
            		ON PID.Pid_MmId = MM.Mm_ID
            	LEFT JOIN UomMaster  (NOLOCK) AS UM
            		ON PID.Pid_UomId = UM.Uom_ID
			    LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
				   ON MTM.Mtm_ID=MM.Mm_MtmId
				LEFT JOIN MedicineGroupMaster  (NOLOCK) MGM
				   ON MGM.Mgm_ID=MM.Mm_MgmId
				LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
				   ON MCM.Mcm_ID=MM.Mm_McmId
            	left join AccountTransaction at 
					on  at.Act_DocNo=PH.Pih_No 
            	where isnull(at.Act_Amount,0)>isnull(at.Act_PaidAmount,0)+isnull(at.Act_AdjustAmount,0) and  
					at.Act_DocType=4 AND at.Act_SrNo=1	 AND CONVERT(date,ph.Pih_DueDate)<CONVERT(date,getdate())
END
	
	ELSE iF @SP_STATUS='GET_TAX_PERC'
		BEGiN
			SELECT	*
			FROM	MedicineWiseTaxMaster A
			WHERE		Mtm_TaxId=4 
					AND A.Mtm_MmId=@Pid_MmId
		END

	ELSE iF @SP_STATUS='GSTR_3_REPORT'
		BEGiN
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_DATA')
				BEGiN
					DROP TABLE ##TEMP_GST_DATA
				END	
			SELECT	'Purchase Invoice' AS Doc_Type,
					C.Mm_Code,
					C.Mm_HsnCode,
					C.Mm_Name,
					A.Sih_No,
					A.Sih_Date,
					A.Sih_Key,
					B.Sid_SubTotal,
					SGST.SGST_PERC,
					SGST.SGST,
					CGST.CGST_PERC,
					CGST.CGST,
					IGST.IGST_PERC,
					IGST.IGST,
					B.Sid_Total,
					ISNULL(SGST.SGST_PERC,0)+ISNULL(CGST.CGST_PERC,0)+ISNULL(IGST.IGST_PERC,0) AS Total_Tax
			iNTO	##TEMP_GST_DATA
			FROM	SalesInvoiceHeader A
					iNNER JOIN SalesInvoiceItemDetail B
			ON			A.Sih_Key=B.Sid_Sih_Key
					iNNER JOIN MedicineMaster C
			ON			B.Sid_Mm_Id=C.MM_ID
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS SGST_PERC,
								X.Tr_TxTot AS SGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=2
								AND X.Tr_TxId=2
					) SGST
			ON		B.Sid_Sih_Key=SGST.Tr_DocKey
					AND B.Sid_Key=SGST.Tr_DdocKey
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS CGST_PERC,
								X.Tr_TxTot AS CGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=2
								AND X.Tr_TxId=3
					) CGST
			ON		B.Sid_Sih_Key=CGST.Tr_DocKey
					AND B.Sid_Key=CGST.Tr_DdocKey
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS IGST_PERC,
								X.Tr_TxTot AS IGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=2
								AND X.Tr_TxId=4
					) IGST
			ON		B.Sid_Sih_Key=IGST.Tr_DocKey
					AND B.Sid_Key=IGST.Tr_DdocKey
			WHERE	A.Sih_Date BETWEEN @Pih_Date AND @Pih_Duedate
			UNION
			SELECT	'Purchase Invoice' AS Doc_Type,
					C.Mm_Code,
					C.Mm_HsnCode,
					C.Mm_Name,
					A.Pih_No,
					A.Pih_Date,
					A.Pih_Key,
					B.Pid_Amount,
					SGST.SGST_PERC,
					SGST.SGST,
					CGST.CGST_PERC,
					CGST.CGST,
					IGST.IGST_PERC,
					IGST.IGST,
					B.Pid_AmountTotal,
					ISNULL(SGST.SGST_PERC,0)+ISNULL(CGST.CGST_PERC,0)+ISNULL(IGST.IGST_PERC,0) AS Total_Tax
			FROM	PurchaseInvoiceHeader A
					iNNER JOIN PurchaseInvoiceDetail B
			ON			A.Pih_Key=B.Pid_PihKey
							iNNER JOIN MedicineMaster C
			ON			B.Pid_MmId=C.MM_ID
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS SGST_PERC,
								X.Tr_TxTot AS SGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=4
								AND X.Tr_TxId=2
					) SGST
			ON		B.Pid_PihKey=SGST.Tr_DocKey
					AND B.Pid_Key=SGST.Tr_DdocKey
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS CGST_PERC,
								X.Tr_TxTot AS CGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=4
								AND X.Tr_TxId=3
					) CGST
			ON			B.Pid_PihKey=CGST.Tr_DocKey
					AND B.Pid_Key=CGST.Tr_DdocKey
					LEFT JOIN 
					(
						SELECT	Tr_DocId,
								X.Tr_DocKey,
								X.Tr_DdocKey,
								X.Tr_TxVal AS IGST_PERC,
								X.Tr_TxTot AS IGST
						FROM	TaxTransaction X
						WHERE	X.Tr_DocTyp=4
								AND X.Tr_TxId=4
					) IGST
			ON			B.Pid_PihKey=IGST.Tr_DocKey
					AND B.Pid_Key=IGST.Tr_DdocKey
			WHERE	A.Pih_Date BETWEEN @Pih_Date AND @Pih_Duedate
			
			SELECT	* 
			FROM	##TEMP_GST_DATA
		END
	ELSE IF @SP_STATUS='GET_BPPI_DETAIL'
		BEGIN
			Select * from VendorMaster as A
			LEFT JOIN VendorAddMaster as B
			ON B.VendAdd_VendorId=A.Vendor_ID
			where A.Vendor_Code='BPPI'
		END
	ELSE iF @SP_STATUS='GSTR-3'
		BEGiN
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_10000')
				BEGIN
					DROP TABLE ##TEMP_GST_10000
				END
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_20000')
				BEGIN
					DROP TABLE ##TEMP_GST_20000
				END
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_30000')
				BEGIN
					DROP TABLE ##TEMP_GST_30000
				END
			
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_40000')
				BEGIN
					DROP TABLE ##TEMP_GST_40000
				END
				
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_50000')
				BEGIN
					DROP TABLE ##TEMP_GST_50000
				END
				
			SELECT	A.Tr_DocTyp,
					A.Tr_DocKey,
					A.Tr_DdocKey,
					CASE WHEN Tr_TxId=2 THEN Tr_TxVal ELSE 0 END AS CGST_P,
					CASE WHEN Tr_TxId=3 THEN Tr_TxVal ELSE 0 END AS SGST_P,
					CASE WHEN Tr_TxId=4 THEN Tr_TxVal ELSE 0 END AS IGST_P,
					
					CASE WHEN Tr_TxId=2 THEN Tr_TxTot ELSE 0 END AS CGST_V,
					CASE WHEN Tr_TxId=3 THEN Tr_TxTot ELSE 0 END AS SGST_V,
					CASE WHEN Tr_TxId=4 THEN Tr_TxTot ELSE 0 END AS IGST_V
			INTO	##TEMP_GST_10000
			FROM	TaxTransaction A
			WHERE	A.Tr_TxId IN(2,3,4)
					AND A.Tr_DocTyp IN(2,3,4,5)
					
			SELECT	Tr_DocTyp,
					Tr_DocKey,
					Tr_DdocKey,
					SUM(CGST_P) AS CGST_P,
					SUM(SGST_P) AS SGST_P,
					SUM(IGST_P) AS IGST_P,
					
					SUM(CGST_V) AS CGST_V,
					SUM(SGST_V) AS SGST_V,
					SUM(IGST_V) AS IGST_V
			INTO	##TEMP_GST_20000
			FROM	##TEMP_GST_10000 A
			GROUP BY Tr_DocTyp,Tr_DocKey,Tr_DdocKey
			
			
			---Sales INvoice
			SELECT	C.Sih_No,
					C.Sih_Date,
					B.Sid_SubTotal,
					A.*
			iNTO	##TEMP_GST_30000
			FROM	##TEMP_GST_20000 A
					iNNER JOIN SalesInvoiceItemDetail B
			ON			A.Tr_DdocKey=B.Sid_Key
						AND A.Tr_DocKey=B.Sid_Sih_Key
						AND A.Tr_DocTyp=2
					iNNER JOIN SalesInvoiceHeader C
			ON			B.Sid_Sih_Key=C.Sih_Key
				
			UNION
			---Sales Return
			SELECT	C.Srh_No,
					C.Srh_Date,
					B.Srd_Amount,
					A.*
			FROM	##TEMP_GST_20000 A
					iNNER JOIN SalesReturnDetail B
			ON			A.Tr_DdocKey=B.Srd_ID
						 AND A.Tr_DocKey=B.Srd_SrhId
						 AND A.Tr_DocTyp=3
					iNNER JOIN SalesReturnHeader C
			ON			B.Srd_SrhId=C.Srh_Id
			UNION
			---Purchase INvoice
			SELECT	C.Pih_No ,
					C.Pih_Date,
					B.Pid_Amount,
					A.*
			
			FROM	##TEMP_GST_20000 A
					iNNER JOIN PurchaseInvoiceDetail B
			ON			A.Tr_DdocKey=B.Pid_Key
						AND A.Tr_DocKey=B.Pid_PihKey
						AND A.Tr_DocTyp=4
					iNNER JOIN PurchaseInvoiceHeader C
			ON			B.Pid_PihKey=C.Pih_Key
				
			UNION
			---Purchase Return
			SELECT	C.Prh_No,
					C.Prh_Date,
					B.Prd_Amount,
					A.*
			FROM	##TEMP_GST_20000 A
					iNNER JOIN PurchaseReturnDetail B
			ON			A.Tr_DdocKey=B.Prd_ID
						 AND A.Tr_DocKey=B.Prd_PrhId
						 AND A.Tr_DocTyp=5
					iNNER JOIN PurchaseReturnHeader C
			ON			B.Prd_PrhId=C.Prh_Id
			SELECT	Tr_DocTyp,
					Tr_DocKey,
					Sih_No,
					Sih_Date,
					SUM(Sid_SubTotal) AS SubTotal,
					CGST_P,
					SGST_P,
					IGST_P,
					SUM(CGST_V) AS CGST_V,
					SUM(SGST_V) AS SGST_V,
					SUM(IGST_V) AS IGST_V
			iNTO	##TEMP_GST_40000
			FROM	##TEMP_GST_30000
			GROUP BY Tr_DocTyp,Tr_DocKey,Sih_No,Sih_Date,CGST_P,SGST_P,IGST_P
			
			SELECT	Tr_DocTyp,	
					Tr_DocKey,
					Sih_No,
					Sih_date,
					SUM(CASE WHEN CGST_P>0 OR IGST_P>0  THEN 0 ELSE SubTotal END) [Taxable_0],
					SUM(CASE WHEN CGST_P=0 THEN CGST_V ELSE 0 END) [CGST_0],
					SUM(CASE WHEN SGST_P=0 THEN SGST_V ELSE 0 END) [SGST_0],
					SUM(CASE WHEN IGST_P=0   THEN IGST_V ELSE 0 END) [IGST_0],
					
					SUM(CASE WHEN CGST_P=2.5 OR IGST_P=5 THEN SubTotal ELSE 0 END) [Taxable_2_5],
					SUM(CASE WHEN CGST_P=2.5 THEN CGST_V ELSE 0 END) [CGST_2_5],
					SUM(CASE WHEN SGST_P=2.5 THEN SGST_V ELSE 0 END) [SGST_2_5],
					SUM(CASE WHEN IGST_P=5   THEN IGST_V ELSE 0 END) [IGST_5],
					
					SUM(CASE WHEN CGST_P=6 OR IGST_P=12 THEN SubTotal ELSE 0 END) [Taxable_6],
					SUM(CASE WHEN CGST_P=6 THEN CGST_V ELSE 0 END) [CGST_6],
					SUM(CASE WHEN SGST_P=6 THEN SGST_V ELSE 0 END) [SGST_6],
					SUM(CASE WHEN IGST_P=12   THEN IGST_V ELSE 0 END) [IGST_12],
					
					SUM(CASE WHEN CGST_P=9 OR IGST_P=18 THEN SubTotal ELSE 0 END) [Taxable_9],
					SUM(CASE WHEN CGST_P=9 THEN CGST_V ELSE 0 END) [CGST_9],
					SUM(CASE WHEN SGST_P=9 THEN SGST_V ELSE 0 END) [SGST_9],
					SUM(CASE WHEN IGST_P=18   THEN IGST_V ELSE 0 END) [IGST_18],
					
					SUM(CASE WHEN CGST_P=14 OR IGST_P=28 THEN SubTotal ELSE 0 END) [Taxable_14],
					SUM(CASE WHEN CGST_P=14 THEN CGST_V ELSE 0 END) [CGST_14],
					SUM(CASE WHEN SGST_P=14 THEN SGST_V ELSE 0 END) [SGST_14],
					SUM(CASE WHEN IGST_P=28   THEN IGST_V ELSE 0 END) [IGST_28],
					
					SUM(SubTotal) AS SubTotal,
					SUM(CGST_V) AS CGST_TOT,
					SUM(SGST_V) AS SGST_TOT,
					SUM(IGST_V) AS IGST_TOT,
					SUM(CGST_V+SGST_V+IGST_V) AS Total_Tax
			iNTO	##TEMP_GST_50000
			FROM	##TEMP_GST_40000
			GROUP BY Tr_DocTyp,Tr_DocKey,Sih_No,Sih_date
			
			SELECT	'Sales Invoice' AS DocType,
			        B.Sih_No AS InvoiceNo,
			        CONVERT(VARCHAR,B.Sih_Date,105)AS DATE,
			        DateName(MONTH,A.Sih_Date)AS MonthName,
			        Year(A.Sih_Date)AS Year,
			        E.Pm_Fullname AS PartyName,
					A.Taxable_0,
					A.CGST_0,
					A.SGST_0,
					A.IGST_0,
					A.Taxable_2_5,
					A.CGST_2_5,
					A.SGST_2_5,
					A.IGST_5,
					A.Taxable_6,
					A.CGST_6,
					A.SGST_6,
					A.IGST_12,
					A.Taxable_9,
					A.CGST_9,
					A.SGST_9,
					A.IGST_18,
					A.Taxable_14,
					A.CGST_14,
					A.SGST_14,
					A.IGST_28,
					A.SubTotal,
					A.CGST_TOT,
					A.SGST_TOT,
					A.IGST_TOT,
					A.Total_Tax,
					ISNULL(B.Sih_Freight_Amount,0)AS Freight_Amount,
					(B.Sih_Total-(A.SubTotal+Total_Tax+ISNULL(B.Sih_Freight_Amount,0)))AS RT,
					B.Sih_Total
			FROM	##TEMP_GST_50000 A
					iNNER jOIN SalesInvoiceHeader B
			ON			A.Tr_DocKey=B.Sih_Key
					AND A.Tr_DocTyp=2
					LEFT JOIN PatientMaster E
			ON		B.Sih_Pm_Id=E.Pm_Id
			WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE) 
			
			UNION
			SELECT	'Sales Return' AS Sih_DocType,
			        B.Srh_No AS InvoiceNo,
			        CONVERT(VARCHAR,A.Sih_DATE,105)AS DATE,
			        DateName(MONTH,A.Sih_DATE)AS MonthName,
			        Year(A.Sih_DATE)AS Year,
			        EE.Pm_Fullname AS PartyName,
					A.Taxable_0,
					A.CGST_0,
					A.SGST_0,
					A.IGST_0,
					A.Taxable_2_5,
					A.CGST_2_5,
					A.SGST_2_5,
					A.IGST_5,
					A.Taxable_6,
					A.CGST_6,
					A.SGST_6,
					A.IGST_12,
					A.Taxable_9,
					A.CGST_9,
					A.SGST_9,
					A.IGST_18,
					A.Taxable_14,
					A.CGST_14,
					A.SGST_14,
					A.IGST_28,
					A.SubTotal,
					A.CGST_TOT,
					A.SGST_TOT,
					A.IGST_TOT,
					A.Total_Tax,
					0 AS Freight_Amount,
					(B.Srh_Total-(A.SubTotal+Total_Tax))AS RT,
					B.Srh_Total
			FROM	##TEMP_GST_50000 A
					iNNER jOIN SalesReturnHeader B
			ON			A.Tr_DocKey=B.Srh_Id
					AND A.Tr_DocTyp=3
					INNER JOIN SalesInvoiceHeader F
			ON      F.Sih_Key=B.Srh_SihKey
			        LEFT JOIN PatientMaster EE
			ON      F.Sih_Pm_Id=EE.Pm_Id
			WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE)
			UNION
			SELECT	'Purchase Invoice' AS DocType,
			        B.Pih_No AS InvoiceNo,
			        CONVERT(VARCHAR,A.Sih_DATE,105)AS DATE,
			        DateName(MONTH,A.Sih_DATE)AS MonthName,
			        Year(A.Sih_DATE)AS Year,
			        E.Vendor_Name AS PartyName,
					A.Taxable_0,
					A.CGST_0,
					A.SGST_0,
					A.IGST_0,
					A.Taxable_2_5,
					A.CGST_2_5,
					A.SGST_2_5,
					A.IGST_5,
					A.Taxable_6,
					A.CGST_6,
					A.SGST_6,
					A.IGST_12,
					A.Taxable_9,
					A.CGST_9,
					A.SGST_9,
					A.IGST_18,
					A.Taxable_14,
					A.CGST_14,
					A.SGST_14,
					A.IGST_28,
					A.SubTotal,
					A.CGST_TOT,
					A.SGST_TOT,
					A.IGST_TOT,
					A.Total_Tax,
					0 AS Freight_Amount,
					(B.Pih_NetValue-(A.SubTotal+Total_Tax))AS RT,
					B.Pih_NetValue AS Sih_Total
			FROM	##TEMP_GST_50000 A
					iNNER jOIN PurchaseInvoiceHeader B
			ON			A.Tr_DocKey=B.Pih_Key
					AND A.Tr_DocTyp=4
					LEFT JOIN VendorMaster E
			ON		B.Pih_VenId=E.Vendor_Id
			WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE) 
			
			UNION
			SELECT	'Purchase Return' AS Prh_DocType,
			        B.Prh_No AS InvoiceNo,
			        CONVERT(VARCHAR,A.Sih_DATE,105)AS DATE,
			        DateName(MONTH,A.Sih_DATE)AS MonthName,
			        Year(A.Sih_DATE)AS Year,
			        EE.Vendor_Name AS PartyName,
					A.Taxable_0,
					A.CGST_0,
					A.SGST_0,
					A.IGST_0,
					A.Taxable_2_5,
					A.CGST_2_5,
					A.SGST_2_5,
					A.IGST_5,
					A.Taxable_6,
					A.CGST_6,
					A.SGST_6,
					A.IGST_12,
					A.Taxable_9,
					A.CGST_9,
					A.SGST_9,
					A.IGST_18,
					A.Taxable_14,
					A.CGST_14,
					A.SGST_14,
					A.IGST_28,
					A.SubTotal,
					A.CGST_TOT,
					A.SGST_TOT,
					A.IGST_TOT,
					A.Total_Tax,
					0 AS Freight_Amount,
					(B.Prh_TotalAmount-(A.SubTotal+Total_Tax))AS RT,
					B.Prh_TotalAmount AS Srh_Total
			FROM	##TEMP_GST_50000 A
					iNNER jOIN PurchaseReturnHeader B
			ON			A.Tr_DocKey=B.Prh_Id
					AND A.Tr_DocTyp=5
					
			        LEFT JOIN VendorMaster EE
			ON      B.Prh_VendorId=EE.Vendor_Id
			WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Pih_DATE AS DATE) AND  CAST(@Pih_DueDATE AS DATE)

		END
END;	



GO
/****** Object:  StoredProcedure [dbo].[SP_PurchaseOrder]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- EXEC [dbo].[SP_PurchaseOrder] @SP_STATUS = 'BIND_PO_ITEM', @PO_KEYS = '1'
-- EXEC [dbo].[SP_PurchaseOrder] @SP_STATUS = 'BIND_PO_ITEM', @Po_VenId = '1', @Po_Search_Text = '004'
CREATE PROCEDURE [dbo].[SP_PurchaseOrder]
-----PO HEADER
@SP_STATUS		varchar(200) = '',
@Po_Key			numeric(18,0) = 0,
@PO_No			numeric(18,0) = 0,
@PO_Date		datetime = NULL,
@PO_RefNo		nvarchar(50) = '',
@PO_RefDate		datetime = NULL,
@PO_RevNo		int = 0,
@PO_RevDate		datetime = NULL,
@PO_Cate		numeric(8,0) = 0,
@PO_Type1		numeric(8,0) = '',
@Po_Type2		numeric(8,0) = '',
@PO_IsCashPurchase bit = 0,
@Po_EnqMode		int = 0,
@Po_QtNo		nvarchar(15) = '',
@Po_IsAmmendment bit = 0,
@Po_VenId		numeric(18,0) = 0,
@Po_VenAddId	numeric(18,0) = 0,
@Po_Cur			numeric(8,0) = 0,
@Po_ExchRate	numeric(18,2) = 0,
@Po_BasicVal	numeric(18,2) = 0,
@Po_Disc		numeric(18,2) = 0,
@Po_Disc_Val	numeric(18,2) = 0,
@Po_TotVal		numeric(18,2) = 0,
@Po_Annexure	varchar(max) = '',
@Po_CoverLetter varchar(max) = '',
@Po_DelDate		datetime = NULL,
@Po_Remarks		varchar(500) = '',
@Po_PaymentTerms nvarchar(max) = '',
@Po_CreditDays int = 0,
@Po_BmId		bigint = 0,
@Po_AuthId		int = 0,
@Po_AuthDate	datetime = NULL,
@Po_YearId		numeric(4,0) = 0,
@USER			int = 0,
@PO_KEYS		nvarchar(max) = '',
@Po_StartDate	datetime = NULL,
@Po_EndDate		datetime = NULL,
-----PO DETAIL
@Pi_Key			numeric(18,0) = 0,
@Pi_PoKey		numeric(18,0) = 0,
@Pi_SrNo		bigint = 0,
@Pi_IndKey		numeric(18,0) = 0,
@Pi_InddKey		numeric(18,0) = 0,
@Pi_IndSrNo		bigint = 0,
@Pi_IndNo		varchar(15) = '',
@Pi_ItemId		numeric(18,0) = 0,
@Pi_ItemName	nvarchar(500) = '',
@Pi_ItemCode	varchar(50) = '',

@Pi_Qty			numeric(14,3) = 0,
@Pi_Rate		numeric(14,2) = 0,
@Pi_Disc		numeric(5,2) = 0,
@Pi_Disc_Val	numeric(18,3) = 0,
@Pi_Uom			numeric(8,0) = 0,
@Pi_Amt			numeric(18,3) = 0,
@Pi_Net_Amt		numeric(18,2) = 0,
@Pi_IcQty		numeric(18,2) = 0,
@Pi_GrnQty		numeric(18,2) = 0,
@Pi_Remarks		varchar(max) = '',
@Pi_ShortCloseQty numeric(18,2) = 0,
@Po_Search_Text nvarchar(max) = NULL,
@Po_ApproveStatus varchar(250) = NULL,
@Po_ApproveStatusRemark nvarchar(500) = NULL,
@ID				bigint = 0 OUT,
@PO_Store_Code	VARCHAR(50)='',
@Po_POS_KEY		numeric(8,0)=0
AS

BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	--=======================BIND FOR PoHeader===========
	IF @SP_STATUS = 'FillPoType1'                    --     'FILL_COMBO_PO_Type1'
	BEGIN
	SELECT	0				AS ID,
			'--Select--'	AS NAME
	UNION
	SELECT	Po_Type1Key		AS ID,
			Po_Name			AS NAME
	FROM	PoValueTypeMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillPoType2'
	BEGIN
	SELECT	0				AS ID,
			'--Select--'	AS NAME
	UNION
	SELECT	Ptm_Type2Key	AS ID,
			Ptm_Name		AS NAME
	FROM	PoTypeMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillInquiryMode'
	BEGIN
	SELECT	0				AS ID,
			'--Select--'	AS NAME
	UNION
	SELECT	Imm_Id			AS ID,
			Imm_Name		AS NAME
	FROM	InquiryModeMaster(NOLOCK);
	END;
	IF @SP_STATUS = 'UpdateApproval'
	BEGIN
	UPDATE	PoHeader
	SET		Po_ApproveStatus = @Po_ApproveStatus,
			Po_ApproveStatusRemark = @Po_ApproveStatusRemark
	WHERE Po_Key = @Po_Key
	END;
	ELSE IF @SP_STATUS = 'FillCurrency'
	BEGIN
	SELECT	0				AS ID,
			'--select--'	AS NAME
	UNION
	SELECT	Cm_id			AS ID,
			Cm_Name			AS NAME
	FROM	CurrencyMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillCategory'
	BEGIN
	SELECT	0				AS ID,
			'--select--'	AS NAME
	UNION
	SELECT	Mcm_ID	AS ID,
			Mcm_Name	AS NAME
	FROM	MedicineCategoryMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillAuthority'
	BEGIN
	SELECT	0				AS ID,
			'--select--'	AS NAME
	UNION
	SELECT	User_ID			AS ID,
			User_Name		AS NAME
	FROM	dbo.UserMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'AutoGeneratePO'
		BEGIN
			DECLARE	@FormPrefix AS nvarchar(max) = '';
			SELECT	@FormPrefix = FormPrefix
			FROM	FormDetailTable
			WHERE	Id = 2
			SELECT	@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Po_No,0)))
			FROM	PoHeader(NOLOCK) A
			WHERE	A.Po_Date BETWEEN @FROM_DATE AND @TO_DATE
		END;
	ELSE IF @SP_STATUS = 'GetManufacture'
	BEGIN
	IF		@Po_VenId = 1
		SELECT		bm.BM_ID	AS PI_MAKE,
					bm.BM_Name	AS Manufacture
		FROM		BrandMater(NOLOCK) bm
		WHERE		bm.BM_ID = 7
	ELSE SELECT		bm.BM_ID	AS PI_MAKE,
					bm.BM_Name	AS Manufacture
		FROM		MedicineBrandMater(NOLOCK) mbm
		LEFT JOIN	BrandMater bm
		ON			mbm.MBM_BmId = bm.BM_ID
		WHERE		MBM_MmId = @Pi_ItemId
		AND			bm.BM_ID <> 7
	END;
	ELSE IF @SP_STATUS = 'GetMarketingBy'
	BEGIN
	SELECT			MBM_MmId,
					MBM_BmId,
					bm.BM_Name	AS Brand
	FROM			MedicineBrandMater(NOLOCK) mbm
	LEFT JOIN		BrandMater(NOLOCK) bm
		ON			mbm.MBM_BmId = bm.BM_ID
	WHERE			mbm.MBM_MmId = @Pi_ItemId
	END
	ELSE IF @SP_STATUS = 'FILL_GRID_PURCHASE'
	BEGIN
	DECLARE			@FormPrefix_fill_dgv AS nvarchar(max) = '';
	SELECT			@FormPrefix_fill_dgv = FormPrefix
	FROM			FormDetailTable(NOLOCK)
	WHERE			Id = 2
		
	SELECT			po.Po_Key,
					@FormPrefix_fill_dgv + CAST(po.Po_No AS nvarchar(max))	AS Po_No,
					vendr.Vendor_Name,
					po.Po_DelDate,
					po.Po_Cur,
					po.Po_ExchRate,
					po.Po_BasicVal,
					po.Po_TotVal,
					po.Po_CreatedDt,
					po.Po_RefNo,
					po.Po_RefDate,
					po.Po_RevNo,
					po.Po_Cate,
					po.Po_Type1,
					po.Po_Type2,
					po.Po_EnqMode,
					po.Po_QtNo,
					po.Po_CreatedBy,
					po.Po_Key,
					vam.VendAdd_Addr1,
					POTYPE.Ptm_Name		AS PO_TYPE_1,
					POVALTYPE.Po_Name	AS PO_TYPE_2,
					CURRMST.Cm_Name,
					ITM.Mcm_Name,
					IMM.Imm_Name,
					Um.[User_Name],
					po.Po_ApproveStatus,
					ISNULL(po.Po_ApproveStatusRemark,'') AS Po_ApproveStatusRemark,
					(CASE WHEN po.Po_VenId=1 THEN (CASE WHEN Po_IsSync='false' THEN 'No' ELSE 'YES' END) ELSE '' END)AS Po_SynchStatus,----Synch Status Of Po--Add Hasmukh
					CASE	WHEN ISNULL(Poh.Poh_ApproveStatus,0)=0 THEN 'UnApproved' 
							WHEN ISNULL(Poh.Poh_ApproveStatus,0)=1 THEN 'Approved'
							WHEN ISNULL(Poh.Poh_ApproveStatus,0)=2 THEN 'Rejected' END AS Poh_ApproveStatus,
					Poh.Poh_SalesOrderNo,
					Poh.Poh_Remarks
	FROM			PoHeader(NOLOCK) po
		LEFT JOIN	CurrencyMaster(NOLOCK) CUR
	ON				CUR.Cm_id = po.Po_Cur
		LEFT JOIN	VendorMaster(NOLOCK) vendr
	ON				po.Po_VenId = vendr.Vendor_ID
		LEFT JOIN	VendorAddMaster(NOLOCK) vam
	ON				po.Po_VenId = vam.VendAdd_VendorId
		AND			po.Po_VenAddId = vam.VendAdd_Id
		LEFT JOIN	PoTypeMaster(NOLOCK) POTYPE
	ON				POTYPE.Ptm_Type2Key = po.Po_Type1
		LEFT JOIN	PoValueTypeMaster(NOLOCK) POVALTYPE
	ON				POVALTYPE.Po_Type1Key = po.Po_Type2
		LEFT JOIN	CurrencyMaster(NOLOCK) CURRMST
	ON				CURRMST.Cm_id = po.Po_Cur
		LEFT JOIN	MedicineCategoryMaster(NOLOCK) ITM
	ON				ITM.Mcm_ID = po.Po_Cate
		LEFT JOIN	InquiryModeMaster(NOLOCK) IMM
	ON				IMM.Imm_Id = po.Po_EnqMode
		LEFT JOIN	UserMaster(NOLOCK) Um
	ON				Um.[User_ID] = po.Po_CreatedBy
		LEFT JOIN	cPOS_PoApprovalHistory as Poh
	ON				Poh.Poh_Po_Key=po.Po_Key
	WHERE CAST(Po_Date AS DATE) BETWEEN @Po_StartDate AND @Po_EndDate and
		Po.Po_ApproveStatus=@Po_ApproveStatus
	ORDER BY		 po.Po_Key DESC;
	END;
	IF @SP_STATUS = 'FILL_GRID_PURCHASE_APPROVAL_SETTING'
	BEGIN
	DECLARE			@FormPrefix_fill_dgv_APV AS nvarchar(max) = '';
	SELECT			@FormPrefix_fill_dgv_APV = FormPrefix
	FROM			FormDetailTable
	WHERE			Id = 2
	SELECT			po.Po_Key,
					@FormPrefix_fill_dgv_APV + CAST(po.Po_No AS nvarchar(max))	AS Po_No,
					vendr.Vendor_Name,
					CAST(po.Po_DelDate AS date)		AS ApprovalDate,
					po.Po_Cur,
					po.Po_ExchRate,
					po.Po_BasicVal,
					po.Po_TotVal,
					po.Po_CreatedDt,
					po.Po_RefNo	AS RefNo,
					po.Po_RefDate	AS RefDate,
					po.Po_RevNo,
					po.Po_Cate,
					po.Po_Type1,
					po.Po_Type2,
					po.Po_EnqMode,
					po.Po_QtNo,
					po.Po_CreatedBy,
					po.Po_Key,
					vam.VendAdd_Addr1,
					POTYPE.Ptm_Name		AS PO_TYPE_1,
					POVALTYPE.Po_Name	AS PO_TYPE_2,
					CURRMST.Cm_Name,
					ITM.Mcm_Name,
					IMM.Imm_Name,
					Um.[User_Name]
	FROM			PoHeader(NOLOCK) po
		LEFT JOIN	CurrencyMaster(NOLOCK) CUR
	ON				CUR.Cm_id = po.Po_Cur
		LEFT JOIN	VendorMaster(NOLOCK) vendr
	ON				po.Po_VenId = vendr.Vendor_ID
		LEFT JOIN	VendorAddMaster(NOLOCK) vam
	ON				po.Po_VenId = vam.VendAdd_VendorId
		AND			po.Po_VenAddId = vam.VendAdd_Id
		LEFT JOIN	PoTypeMaster(NOLOCK) POTYPE
	ON				POTYPE.Ptm_Type2Key = po.Po_Type1
		LEFT JOIN	PoValueTypeMaster(NOLOCK) POVALTYPE
	ON				POVALTYPE.Po_Type1Key = po.Po_Type2
		LEFT JOIN	CurrencyMaster(NOLOCK) CURRMST
	ON				CURRMST.Cm_id = po.Po_Cur
		LEFT JOIN	MedicineCategoryMaster(NOLOCK) ITM
	ON				ITM.Mcm_ID = po.Po_Cate
		LEFT JOIN	InquiryModeMaster(NOLOCK) IMM
	ON				IMM.Imm_Id = po.Po_EnqMode
		LEFT JOIN	UserMaster(NOLOCK) Um
	ON				Um.[User_ID] = po.Po_CreatedBy
	WHERE			ISNULL(Po_ApproveStatus,'') IN ('Pending')
	ORDER BY		po.Po_Key DESC;
	END;
	ELSE IF @SP_STATUS = 'FillVendor'
	BEGIN
		SELECT		Vendor_ID AS VEN_ID,
					Vendor_Code AS VEN_CODE,
					Vendor_Name	AS VEN_NAME,
					vam.VendAdd_Id AS VAAD_ID,
					vam.VendAdd_Addr1 + CASE WHEN ISNULL(vam.VendAdd_Add2,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add2,'') ELSE '' END
					+ CASE WHEN ISNULL(vam.VendAdd_Add3,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add3,'') ELSE '' END AS VEN_ADDRESS,
					Vendor_CreditDays,
					area.Area_StateId as StateId,
					vm.Vendor_Vt_Id,
					vt.Vt_name
		FROM		VendorMaster(NOLOCK) vm
		INNER JOIN	VendorAddMaster(NOLOCK) vam
		ON			vm.Vendor_ID = vam.VendAdd_VendorId
		AND			vam.VendAdd_IsActive = 1
		LEFT JOIN	AreaMaster(NOLOCK) area
		ON			vam.VendAdd_AreaId = area.Area_ID
		LEFT JOIN	StateMaster(NOLOCK) [state]
		ON			area.Area_StateId = state.State_ID
		LEFT JOIN	VendorTypeMaster(NOLOCK)  as vt
		ON			vm.Vendor_Vt_Id=vt.Vt_Id
		WHERE		vm.Vendor_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
		SELECT	@Po_Key = ISNULL(MAX(Po_Key),0) + 1
		FROM	PoHeader(NOLOCK);
		SELECT	@Po_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Po_No,0)))
		FROM	PoHeader(NOLOCK) A
		WHERE	A.Po_Date BETWEEN @FROM_DATE AND @TO_DATE
	
		INSERT INTO PoHeader
		(
			Po_Key,
			Po_No,
			Po_Date,
			Po_RefNo,
			Po_RefDate,
			Po_RevNo,
			Po_RevDate,
			Po_Cate,
			Po_Type1,
			Po_Type2,
			Po_IsCashPurchase,
			Po_EnqMode,
			Po_QtNo,
			Po_VenId,
			Po_VenAddId,
			Po_DelDate,
			Po_Cur,
			Po_ExchRate,
			Po_BasicVal,
			Po_TotVal,
			Po_Remarks,
			Po_Annexure,
			Po_CoverLetter,
			Po_BmId,
			Po_YearId,
			Po_AuthId,
			Po_AuthDate,
			Po_CreatedBy,
			Po_CreatedDt,
			Po_IsAmmendment,
			Po_PaymentTerms,
			[Po_CreditDays],
			Po_Disc,
			Po_Disc_Val,Po_ApproveStatus,Po_ApproveStatusRemark,
			Po_IsSync ----Synch Default Set False Add Hasmukh
		) 
		VALUES
		(	@Po_Key,@PO_No,@PO_Date,@PO_RefNo,@PO_RefDate,@PO_RevNo,@PO_RevDate,@PO_Cate,@PO_Type1,@Po_Type2,
			@PO_IsCashPurchase,@Po_EnqMode,@Po_QtNo,@Po_VenId,@Po_VenAddId,@Po_DelDate,@Po_Cur,@Po_ExchRate,
			@Po_BasicVal,@Po_TotVal,@Po_Remarks,@Po_Annexure,@Po_CoverLetter,@Po_BmId,@Po_YearId,
			@Po_AuthId,@Po_AuthDate,@USER,GETDATE(),@Po_IsAmmendment,@Po_PaymentTerms,@Po_CreditDays,@Po_Disc,
			@Po_Disc_Val,@Po_ApproveStatus,@Po_ApproveStatusRemark,
			'false'
		)
		SELECT @ID = @Po_Key;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'PoHeader',
									@Po_Key,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT,14,9)
		END
	ELSE BEGIN
		UPDATE INDDET
		SET INDDET.Indd_AcceptedQty = INDDET.Indd_AcceptedQty - POITMDET.Pi_Qty
		FROM IndentDetail INDDET
		INNER JOIN PoItemDetails POITMDET
		ON INDDET.Indd_Key = POITMDET.Pi_InddKey
		WHERE POITMDET.Pi_InddKey > 0
		AND POITMDET.Pi_PoKey = @Po_Key;
		DELETE FROM dbo.PoHeader
		WHERE Po_Key = @Po_Key;
		DELETE FROM TaxTransaction WHERE Tr_DocKey = @Po_Key AND Tr_DocTyp = 1;
		DELETE FROM PoItemDetails WHERE Pi_PoKey = @Po_Key;
		END;
	END
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
	DECLARE @MSG_OUT_update nvarchar(max)
	EXEC SP_Tbl_Dependency	'PoHeader',
									@Po_Key,
									@MSG_OUT_update OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT_update,14,9)
		END
	ELSE BEGIN
		UPDATE dbo.PoHeader
		SET		--Po_No = @PO_No,
		Po_Date = @PO_Date,
		Po_RefNo = @PO_RefNo,
		Po_RefDate = @PO_RefDate,
		Po_RevNo = @PO_RevNo,
		Po_RevDate = @PO_RevDate,
		Po_Cate = @PO_Cate,
		Po_Type1 = @PO_Type1,
		Po_Type2 = @Po_Type2,
		Po_IsCashPurchase = @PO_IsCashPurchase,
		Po_EnqMode = @Po_EnqMode,
		Po_QtNo = @Po_QtNo,
		Po_VenId = @Po_VenId,
		Po_VenAddId = @Po_VenAddId,
		Po_DelDate = @Po_DelDate,
		Po_Cur = @Po_Cur,
		Po_ExchRate = @Po_ExchRate,
		Po_BasicVal = @Po_BasicVal,
		Po_TotVal = @Po_TotVal,
		Po_Remarks = @Po_Remarks,
		Po_Annexure = @Po_Annexure,
		Po_CoverLetter = @Po_CoverLetter,
		Po_BmId = @Po_BmId,
		Po_YearId = @Po_YearId,
		Po_AuthId = @Po_AuthId,
		Po_AuthDate = @Po_AuthDate,
		Po_UpdatedBy = @USER,
		Po_UpdatedDt = GETDATE(),
		Po_IsAmmendment = @Po_IsAmmendment,
		Po_PaymentTerms = @Po_PaymentTerms,
		Po_CreditDays = @Po_CreditDays,
		Po_Disc = @Po_Disc,
		Po_Disc_Val = @Po_Disc_Val,
		Po_ApproveStatus=@Po_ApproveStatus
		WHERE Po_Key = @Po_Key;
		UPDATE INDDET
		SET INDDET.Indd_AcceptedQty = INDDET.Indd_AcceptedQty - POITMDET.Pi_Qty
		FROM IndentDetail INDDET
		INNER JOIN PoItemDetails POITMDET
		ON INDDET.Indd_Key = POITMDET.Pi_InddKey
		WHERE POITMDET.Pi_InddKey > 0
		AND POITMDET.Pi_PoKey = @Po_Key;

		DELETE FROM PoItemDetails WHERE Pi_PoKey = @Po_Key;
		DELETE FROM dbo.TaxTransaction	WHERE Tr_DocId=@Po_Key and  Tr_DocTyp= 1

		SELECT @ID = @Po_Key;
		END;
	END
	ELSE IF @SP_STATUS = 'SEARCH_BY_ITEM_NAME'
	BEGIN
	--      DECLARE @query NVARCHAR(MAX) = '';
	--      SET @query = '
	--SELECT  	ITEM_MASTER.ITM_ID, ITEM_MASTER.ITM_NAME, ITEM_MASTER.ITM_CODE,ITEM_MASTER.ITM_NAME, ITEM_MASTER.ITM_LAST_PUR_RATE AS ItemRate, UOM_MASTER.UOM_CODE, 
	--					UOM_MASTER.UOM_ID,0 as INDD_SR_NO, ITEM_MASTER.ITM_ID,0 AS Stock, ITEM_MASTER.ITM_LEAD_TIME,ITEM_MASTER.ITM_MIN_LEVEL,ITEM_MASTER.ITM_MAX_LEVEL
	--		FROM		ITEM_MASTER (nolock)
	--				INNER JOIN UOM_MASTER (nolock) 
	--		ON			ITEM_MASTER.ITM_PURCHASE_UNIT = UOM_MASTER.UOM_ID
	--		WHERE		ITEM_MASTER.ITM_NAME like %' + @Pi_ItemName + '%';
	--print @query
	--      EXEC (@query);
	SELECT	0											AS 'IND_SEL',
				mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				UomMaster.Uom_Name,
				UomMaster.Uom_ID,
				mm.Mm_PurRate							AS ItemRate,
				0											AS INDD_SR_NO,
				mm.Mm_LeadTime,
				UomMaster.Uom_Code,
				SUM(ISNULL(VwDeliChall.STOCK,0))	AS Stock,
				mm.Mm_MinLevel,
				mm.Mm_MaxLevel
	FROM dbo.MedicineMaster mm (NOLOCK)
	INNER JOIN UomMaster(NOLOCK)
		ON mm.Mm_StkUom = UomMaster.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VwDeliChall
		ON mm.Mm_ID = VwDeliChall.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	AND Mm_Code LIKE '%' + ISNULL(@Pi_ItemName,'') + '%'
	OR Mm_Name LIKE '%' + ISNULL(@Pi_ItemName,'') + '%' GROUP BY Mm_ID,Mm_Name,Mm_Code,Uom_Name,Uom_ID,Mm_LeadTime,Uom_Code,Mm_MinLevel,Mm_MaxLevel,mm.Mm_PurRate
	ORDER BY Mm_Name
	END;
	ELSE IF @SP_STATUS = 'BIND_ITEM_INDENT'
	BEGIN
	SELECT		CONVERT(BIT,0) AS IND_SEL,
				INDH.Ind_Key,
				INDH.Ind_No,
				INDD.Indd_ItmId,
				INDD.Indd_ItmCode,
				INDD.Indd_ItmName,
				ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(Indd.Indd_shortCloseQty,0.00)	AS Qty,
				UomMaster.Uom_Name,
				MM.Mm_PurRate																															AS ItemRate,
				INDD.Indd_AcceptedQty																												AS BalQty,
				dbo.UomMaster.Uom_ID																													AS PI_UOM_ID,
				UomMaster.Uom_Name																													AS UOM_CODE,
				INDD.Indd_SrNo,
				MM.Mm_ID,
				INDD.Indd_Key,
				dbo.UomMaster.Uom_Code,
				MM.Mm_MinLevel,
				MM.Mm_MaxLevel,
				MM.Mm_LeadTime,
				ISNULL(Vw.STOCK,0)																													AS Stock,
				MM.MM_MarketingBy,
				MM.MM_ManufactureBy,
				mm.Mm_MaxLevel																															AS PO_MAXLEVEL,
				mm.Mm_MinLevel																															AS PO_MINLEVEL
				,ISNULL(mm.Mm_Primary_Size,'') AS Mm_Primary_Size
				,ISNULL(mm.Mm_Second_Size,'') AS Mm_Second_Size
				,ISNULL(mm.Mm_Tertairy_Size,'') AS Mm_Tertairy_Size
	FROM IndentHeader(NOLOCK) AS INDH
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDH.Ind_Key = INDD.Indd_IndKey
	LEFT JOIN MedicineMaster(NOLOCK) MM
		ON INDD.Indd_ItmId = MM.Mm_ID
	LEFT JOIN dbo.UomMaster(NOLOCK)
		ON MM.MM_PurchaseUom = dbo.UomMaster.Uom_ID
	LEFT JOIN VwTotalStock Vw
		ON Vw.STK_ITEM_ID = INDD.Indd_ItmId
	WHERE (ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(INDD.Indd_shortCloseQty,0.00)) > 0
	AND ((@Po_VenId = 1
	AND mm.Mm_MtmId = 1)
	OR (@Po_VenId != 1)
	AND mm.Mm_MtmId != 1)
	AND INDH.Ind_ApproveStatus = 'Approve'

	ORDER BY Indd_ItmName
	END;
	ELSE IF @SP_STATUS = 'SEARCH_ITEM_INDENT'
	BEGIN
	--    DECLARE @Searchquery NVARCHAR(MAX) = '';
	--    SET @Searchquery
	--        = 'SELECT INDH.IND_KEY, INDH.IND_NO, INDD.INDD_ITM_ID, INDD.INDD_ITM_CODE, INDD.INDD_ITM_NAME, INDD.INDD_QTY - INDD.INDD_ACCEPTED_QTY AS Qty, 
	--             UOM_MASTER.UOM_NAME, ITEM_MASTER.ITM_LAST_PUR_RATE AS ItemRate, INDD.INDD_ACCEPTED_QTY AS BalQty, UOM_MASTER.UOM_ID, 
	--             INDD.INDD_SR_NO, ITEM_MASTER.ITM_ID,INDD.INDD_KEY,UOM_MASTER.UOM_CODE,ITEM_MASTER.ITM_MIN_LEVEL,ITEM_MASTER.ITM_MAX_LEVEL
	--FROM INDENT_HEADER (nolock) AS INDH 
	--	LEFT JOIN INDENT_DETAIL (nolock) AS INDD 
	--ON INDH.IND_KEY = INDD.INDD_IND_KEY 
	--	LEFT JOIN ITEM_MASTER (nolock) 
	--ON INDD.INDD_ITM_ID = ITEM_MASTER.ITM_ID 
	--	LEFT JOIN UOM_MASTER (nolock)
	--ON ITEM_MASTER.ITM_PURCHASE_UNIT = UOM_MASTER.UOM_ID 
	--WHERE (INDD.INDD_QTY - INDD.INDD_ACCEPTED_QTY) > 0 AND INDD.INDD_ITM_NAME ''%' + @Pi_ItemName + '%''';
	--    EXEC (@Searchquery);
	SELECT *
	FROM (SELECT
		INDH.Ind_Key,
		INDH.Ind_No,
		INDD.Indd_ItmId,
		INDD.Indd_ItmCode,
		INDD.Indd_ItmName,
		ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(Indd.Indd_shortCloseQty,0.00) AS Qty,
		UomMaster.Uom_Name,
		MM.Mm_PurRate AS ItemRate,
		INDD.Indd_AcceptedQty AS BalQty,
		dbo.UomMaster.Uom_ID,
		INDD.Indd_SrNo,
		MM.Mm_ID,
		INDD.Indd_Key,
		dbo.UomMaster.Uom_Code,
		MM.Mm_MinLevel,
		MM.Mm_MaxLevel,
		MM.Mm_LeadTime,
		ISNULL(Vw.STOCK,0) AS Stock
	FROM IndentHeader(NOLOCK) AS INDH
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDH.Ind_Key = INDD.Indd_IndKey
	LEFT JOIN MedicineMaster(NOLOCK) MM
		ON INDD.Indd_ItmId = MM.Mm_ID
	LEFT JOIN dbo.UomMaster(NOLOCK)
		ON MM.Mm_StkUom = dbo.UomMaster.Uom_ID
	LEFT JOIN VwTotalStock Vw
		ON Vw.STK_ITEM_ID = INDD.Indd_ItmId
	WHERE (ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(INDD.Indd_shortCloseQty,0.00)) > 0) AS dt
	WHERE Indd_ItmCode LIKE '%' + @Pi_ItemName + '%'
	OR Indd_ItmName LIKE '%' + @Pi_ItemName + '%'
	ORDER BY Indd_ItmName
	END;
	ELSE IF @SP_STATUS = 'BIND_ITEM'
	BEGIN
	DECLARE @VEN_TYPE	INT
	SELECT TOP(1) @VEN_TYPE=ISNULL(VENDOR_VT_ID,0) FROM VendorMaster WHERE Vendor_ID=@Po_VenId
	SELECT		CONVERT(BIT,0)											AS 'IND_SEL',
				mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				--UomMaster.Uom_Name,
				--UomMaster.Uom_ID,
				UomMaster.Uom_Name,
				mm.Mm_PurRate							AS ItemRate,
				0											AS INDD_SR_NO,
				mm.Mm_LeadTime,
				UomMaster.Uom_Name					AS Uom_Code,
				MM_PurchaseUom							AS PI_UOM_ID,
				SUM(ISNULL(VwDeliChall.STOCK,0))	AS Stock,
				mm.Mm_MinLevel,
				mm.Mm_MaxLevel,
				mm.Mm_MRP,
				mm.MM_PackSize							AS Pid_PackId,
				mm.Mm_MtmId								AS Po_Manufacture,
				mm.Mm_HsnCode							AS PoHsnCode,
				mm.MM_ManufactureBy,
				mm.MM_MarketingBy,
				mm.Mm_MaxLevel,
				mm.Mm_MinLevel,
				(CASE WHEN mm.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
				,ISNULL(mm.Mm_Primary_Size,'') AS Mm_Primary_Size
				,ISNULL(mm.Mm_Second_Size,'') AS Mm_Second_Size
				,ISNULL(mm.Mm_Tertairy_Size,'') AS Mm_Tertairy_Size
	FROM dbo.MedicineMaster mm (NOLOCK)
	LEFT JOIN UomMaster(NOLOCK)
		ON mm.MM_PurchaseUom = UomMaster.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VwDeliChall
		ON mm.Mm_ID = VwDeliChall.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	AND ((@VEN_TYPE = 1
	AND mm.Mm_MtmId = 1)
	OR (@VEN_TYPE != 1)
	AND mm.Mm_MtmId != 1) 
	GROUP BY Mm_ID,Mm_Name,Mm_Code,Uom_Name,
	--Uom_ID,
	mm.MM_PurchaseUom,Mm_LeadTime,Uom_Code,Mm_MinLevel,Mm_MaxLevel,mm.Mm_PurRate,Mm_MRP,mm.MM_PackSize,mm.Mm_MtmId,mm.Mm_HsnCode,mm.MM_ManufactureBy,mm.MM_MarketingBy,mm.Mm_MaintainExp,
	ISNULL(mm.Mm_Primary_Size,''),ISNULL(mm.Mm_Second_Size,''),ISNULL(mm.Mm_Tertairy_Size,'')
	ORDER BY Mm_Name
	END;
	--================================
	ELSE IF @SP_STATUS = 'INSERT_PoItemDetails'
	BEGIN
	SELECT @Pi_Key = ISNULL(MAX(Pi_Key),0) + 1
	FROM PoItemDetails(NOLOCK);
	INSERT INTO PoItemDetails(Pi_Key,
	Pi_PoKey,
	Pi_SrNo,
	Pi_IndKey,
	Pi_IndSrNo,

	Pi_Qty,
	Pi_Rate,
	Pi_Disc,
	Pi_Uom,
	Pi_Amt,
	Pi_Remarks,
	Pi_IndNo,
	Pi_InddKey,
	Pi_ItemName,
	Pi_ItemId,
	Pi_Disc_Val,
	Pi_Net_Amt) VALUES
	(@Pi_Key,@Pi_PoKey,@Pi_SrNo,@Pi_IndKey,@Pi_IndSrNo,@Pi_Qty,@Pi_Rate,@Pi_Disc,@Pi_Uom,
	@Pi_Amt,@Pi_Remarks,@Pi_IndNo,@Pi_InddKey,@Pi_ItemName,@Pi_ItemId,@Pi_Disc_Val,@Pi_Net_Amt);
	UPDATE INDD
	SET INDD.Indd_AcceptedQty = INDD.Indd_AcceptedQty + @Pi_Qty
	FROM IndentDetail INDD
	INNER JOIN PoItemDetails PODET
		ON INDD.Indd_Key = @Pi_InddKey;
	SELECT @ID = @Pi_Key;
	END;
	ELSE IF @SP_STATUS = 'RETRIVE_PO'
	BEGIN
	DECLARE @FormPrefix_ret AS nvarchar(max) = '';
	SELECT @FormPrefix_ret = FormPrefix
	FROM FormDetailTable
	WHERE Id = 2
	SELECT	[Po_Key],
				@FormPrefix_ret + CAST([Po_No] AS nvarchar(max))																	AS [Po_No],
				[Po_Date],
				[Po_RefNo],
				[Po_RefDate],
				[Po_RevNo],
				[Po_RevDate],
				[Po_Cate],
				[Po_Type1],
				[Po_Type2],
				[Po_IsCashPurchase],
				[Po_EnqMode],
				[Po_QtNo],
				[Po_IsAmmendment],
				[Po_VenId],
				[Po_VenAddId],
				[Po_DelDate],
				[Po_Cur],
				[Po_ExchRate],
				[Po_BasicVal],
				[Po_TotVal],
				[Po_Annexure],
				[Po_CoverLetter],
				[Po_Remarks],
				[Po_PaymentTerms],
				[Po_CreditDays],
				VM.Vendor_Name,
				VM.Vendor_Code,
				Po_AuthId,
				Po_AuthDate,
				ISNULL(VENADD.VendAdd_Addr1,'') + ISNULL(VENADD.VendAdd_Add2,'') + ISNULL(VENADD.VendAdd_Add3,'')	AS VEN_ADDRESS,
				Po_Disc,
				Po_Disc_Val,
				area.Area_StateId																												StateId
	FROM [dbo].[PoHeader](NOLOCK)
	LEFT JOIN VendorAddMaster VENADD (NOLOCK)
		ON [PoHeader].Po_VenAddId = VENADD.VendAdd_Id
	LEFT JOIN VendorMaster VM (NOLOCK)
		ON [PoHeader].Po_VenId = VM.Vendor_ID
	LEFT JOIN AreaMaster area
		ON VENADD.VendAdd_AreaId = area.Area_ID
	LEFT JOIN StateMaster [state]
		ON area.Area_StateId = state.State_ID
	WHERE [Po_Key] = @Po_Key;
	--====================== BINDING PO DETAIL GRID ==
	SELECT	[Pi_Key],
				[Pi_PoKey],
				[Pi_SrNo],
				[Pi_IndKey],
				[Pi_IndSrNo],
				[Pi_ItemId],

				[Pi_Qty],
				[Pi_Rate],
				[Pi_IndNo],
				[Pi_Disc],
				[Pi_Uom]										AS PI_UOM_ID,
				[Pi_Amt],
				[Pi_Remarks],
				[Pi_ShortCloseQty],
				mm.Mm_Name,
				UM.Uom_Name,
				mm.Mm_Code,
				POITMDET.Pi_InddKey,
				UM.Uom_Code,
				POITMDET.[Pi_ItemName],
				ISNULL(CASE
					WHEN ISNULL(INDD.Indd_Qty,0) > 0 THEN INDD.Indd_Qty
					ELSE INDD.Indd_Qty
				END,
				0
				)												AS PI_INDD_QTY,
				Pi_Disc,
				Pi_Disc_Val,
				Pi_Net_Amt,
				mm.MM_MarketingBy,
				mm.MM_ManufactureBy,
				ISNULL(POITMDET.Pi_PiQty,0)			AS Pi_PiQty,
				ISNULL(POITMDET.Pi_ShortCloseQty,0)	AS Pi_ShortCloseQty,
				mm.Mm_MaxLevel								PO_MAXLEVEL,
				mm.Mm_MinLevel								PO_MINLEVEL

	FROM [dbo].[PoItemDetails](NOLOCK) POITMDET
	LEFT JOIN MedicineMaster(NOLOCK) mm
		ON mm.Mm_ID = POITMDET.Pi_ItemId
	LEFT JOIN UomMaster(NOLOCK) UM
		ON UM.Uom_ID = POITMDET.Pi_Uom

	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDD.Indd_Key = POITMDET.Pi_InddKey
	WHERE Pi_PoKey = @Po_Key;
	END;
	ELSE IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
	SELECT	mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				mm.Mm_LeadTime,
				mm.Mm_StkUom,
				UomMaster.Uom_Code,
				UomMaster.Uom_Name,
				UomMaster.Uom_ID	AS PI_UOM_ID,
				mm.Mm_PurRate,
				mm.MM_ManufactureBy,
				mm.MM_MarketingBy
	FROM dbo.MedicineMaster(NOLOCK) mm
	LEFT JOIN UomMaster(NOLOCK)
		ON mm.MM_PurchaseUom = UomMaster.Uom_ID
	WHERE Mm_ID = @Pi_ItemId
	AND MM.Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'UPDATE_SHORT_CLOSE_QTY'
		BEGIN
			UPDATE	PoItemDetails
			SET			Pi_ShortCloseQty = isnull(Pi_ShortCloseQty,0) + @Pi_ShortCloseQty,
						Pi_ShortCloseBy = @USER,
						Pi_ShortCloseDt = GETDATE()
			WHERE		Pi_SrNo = @Pi_SrNo
					AND Pi_PoKey = @Pi_PoKey
					AND Pi_ItemId = @Pi_ItemId

			SELECT	@ID = ISNULL(Pi_Key,0)
			FROM	PoItemDetails
			WHERE		Pi_SrNo = @Pi_SrNo
					AND Pi_PoKey = @Pi_PoKey
					AND Pi_ItemId = @Pi_ItemId
			iF ISNULL(@ID,0)=0
				BEGiN
					SET @ID=1
				END
		END
	ELSE IF @SP_STATUS = 'GET_PENDING_PURCHASE_ORDER'
	BEGIN
	SELECT	CONVERT(bit,0)																											AS SEL,
				PID.Pi_SrNo																												AS SR_NO,
				PID.Pi_ItemId																											AS ITEM_ID,
				IM.Mm_Code																												AS ITEM_CODE,
				IM.Mm_Name																												AS ITEM_NAME,
				IM.Mm_HsnCode																											AS HSN_CODE,
				POH.Po_VenId																											AS VEN_ID,
				VM.Vendor_Name																											AS VEN_NAME,
				PID.Pi_PoKey																											AS [KEY],
				PID.PI_KEY																												AS MASTER_KEY,
				POH.PO_NO																												AS KEY_NO,
				ISNULL(PID.PI_QTY,0)																									AS QTY,
				PID.PI_UOM																												AS UOM,
				UM.UOM_CODE																												AS UOM_CODE,
				ISNULL(PID.PI_QTY,0) - SUM(ISNULL(InvoiceDetail.Pid_Qty,0)) - ISNULL(PID.Pi_ShortCloseQty,0)	AS PENDING_QTY,
				CONVERT(numeric,0)																									AS SHORT_CLOSE_QTY
	FROM PoHeader(NOLOCK) POH
	LEFT JOIN PoItemDetails(NOLOCK) PID
		ON POH.PO_KEY = PID.Pi_PoKey
	LEFT JOIN UomMaster(NOLOCK) UM
		ON PID.PI_UOM = UM.UOM_ID
	LEFT JOIN MedicineMaster(NOLOCK) IM
		ON PID.Pi_ItemId = IM.Mm_ID
	LEFT JOIN VendorMaster(NOLOCK) VM
		ON VM.Vendor_ID = POH.Po_VenId
	LEFT JOIN PurchaseInvoiceDetail(NOLOCK) InvoiceDetail
		ON POH.Po_Key = InvoiceDetail.Pid_PoKey
		AND PID.Pi_ItemId = InvoiceDetail.Pid_MmId
	WHERE Po_Key = @Po_Key AND POH.Po_ApproveStatus='Approve'---<<<add by hasmukh
	GROUP BY PID.Pi_SrNo,PID.Pi_ItemId,IM.Mm_Code,IM.Mm_Name,IM.Mm_HsnCode,POH.Po_VenId,VM.Vendor_Name,PID.Pi_PoKey,PID.PI_KEY,POH.PO_NO,ISNULL(PID.PI_QTY,0),PID.PI_UOM,UM.UOM_CODE,ISNULL(PID.Pi_ShortCloseQty,0)
	HAVING ISNULL(PID.PI_QTY,0) - SUM(ISNULL(InvoiceDetail.Pid_Qty,0)) - ISNULL(PID.Pi_ShortCloseQty,0) > 0
	END
	ELSE IF @SP_STATUS = 'GetPendingPoNo'
	BEGIN
	SELECT	PID.Pi_PoKey AS Id,
				POH.PO_NO AS [No],
				POH.Po_Date AS [Date],
				VM.Vendor_Name AS VEN_NAME,
				ISNULL(SUM(PID.Pi_Qty),0) - SUM(ISNULL(PID.Pi_PiQty,0)) - ISNULL(SUM(PID.Pi_ShortCloseQty),0)	AS PendingQty,
				poh.Po_Remarks AS Remark,
				[user].User_Name AS CreatedBy,
				poh.Po_CreatedDt AS CreatedDt
	FROM PoHeader(NOLOCK) POH
	LEFT JOIN PoItemDetails(NOLOCK) PID
		ON POH.PO_KEY = PID.Pi_PoKey
	LEFT JOIN VendorMaster(NOLOCK) VM
		ON VM.Vendor_ID = POH.Po_VenId
	--left join PurchaseInvoiceDetail (NOLOCK) InvoiceDetail 
	--on POH.Po_Key=InvoiceDetail.Pid_PoKey and PID.Pi_ItemId=InvoiceDetail.Pid_MmId
	LEFT JOIN UserMaster [user]
		ON poh.Po_CreatedBy = [user].User_ID 
		WHERE POH.Po_ApproveStatus='Approve'---<<<add by hasmukh
		GROUP BY PID.Pi_PoKey,POH.PO_NO,POH.Po_Date,VM.Vendor_Name,poh.Po_Remarks,[user].User_Name,poh.Po_CreatedDt
	HAVING SUM(ISNULL(PID.PI_QTY,0)) - SUM(ISNULL(PID.Pi_PiQty,0)) - SUM(ISNULL(PID.Pi_ShortCloseQty,0)) > 0
	END
	ELSE IF @SP_STATUS = 'GET_ITEM'
	BEGIN
	SELECT *
	FROM dbo.MedicineMaster(NOLOCK)
	WHERE Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'BIND_PO_ITEM'
	BEGIN
	DECLARE @dynaSqlPoItem nvarchar(max) = '';
	SET @dynaSqlPoItem += 'SELECT		CONVERT(BIT, 0) AS SEL,POHEAD.Po_Key,  cast(POHEAD.Po_No as nvarchar(max)) as Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
						isnull(POHEAD.Po_TotVal,0.00) as TotalAmount,vm.Vendor_Name 
						--,IM.MM_ManufactureBy,Im.MM_MarketingBy
		    FROM		PoHeader  (NOLOCK) POHEAD
					INNER JOIN PoItemDetails  (NOLOCK) POITMDET
			ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
					INNER JOIN dbo.MedicineMaster  (NOLOCK) IM
			ON			IM.Mm_ID = POITMDET.Pi_ItemId
					INNER JOIN dbo.UomMaster  (NOLOCK) UOMMST
			ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
					INNER JOIN dbo.VendorMaster  (NOLOCK) vm
			ON			POHEAD.Po_VenId = vm.Vendor_ID
		    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0) - ISNULL(POITMDET.Pi_ShortCloseQty, 0)  > 0 
					AND	POHEAD.Po_VenId = ' + CAST(@Po_VenId AS nvarchar(10));
	IF @PO_KEYS <> ''
		BEGIN
		SET @dynaSqlPoItem += ' OR POHEAD.Po_Key in (' + @PO_KEYS + ')';
		END;
	SET @dynaSqlPoItem += ' GROUP BY POHEAD.Po_TotVal ,POHEAD.Po_No,POHEAD.Po_Date,POHEAD.Po_RefNo,POHEAD.Po_RefDate,POHEAD.Po_VenId,POHEAD.Po_DelDate,vm.Vendor_Name,POHEAD.Po_Key';
	EXEC (@dynaSqlPoItem);
	--print(@dynaSqlPoItem);
	END;
	ELSE IF @SP_STATUS = 'BIND_PO'
	BEGIN
		SELECT	POHEAD.Po_Key AS hcPo_Key,
					CAST(POHEAD.Po_No AS nvarchar(max))	AS hcPo_No,
					Po_Date	AS hcPo_Date,
					Po_RefNo AS hcPo_RefNo,
					Po_RefDate AS hcPo_RefDate,
					Po_DelDate	AS hcPo_DelDate,
					ISNULL(POHEAD.Po_TotVal,0.00) AS hcTotalAmount,
					vm.Vendor_Name AS hcVendor_Name
		--,IM.MM_ManufactureBy,Im.MM_MarketingBy
		FROM PoHeader(NOLOCK) POHEAD
		LEFT JOIN PoItemDetails(NOLOCK) POITMDET
			ON POITMDET.Pi_PoKey = POHEAD.Po_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) IM
			ON IM.Mm_ID = POITMDET.Pi_ItemId
		LEFT JOIN dbo.UomMaster(NOLOCK) UOMMST
			ON UOMMST.Uom_ID = POITMDET.Pi_Uom
		LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			ON POHEAD.Po_VenId = vm.Vendor_ID
		WHERE POHEAD.Po_VenId = @Po_VenId
		AND POHEAD.Po_VenAddId = @Po_VenAddId
		AND POHEAD.Po_ApproveStatus = 'Approve' 
		GROUP BY POHEAD.Po_TotVal,POHEAD.Po_No,POHEAD.Po_Date,POHEAD.Po_RefNo,POHEAD.Po_RefDate,POHEAD.Po_VenId,POHEAD.Po_DelDate,vm.Vendor_Name,POHEAD.Po_Key
		HAVING ISNULL(SUM(POITMDET.Pi_Qty),0) - ISNULL(SUM(POITMDET.Pi_PiQty),0) - ISNULL(SUM(POITMDET.Pi_ShortCloseQty),0) > 0
	END;
	ELSE IF @SP_STATUS = 'BIND_Dispatch'
		BEGIN
			--SELECT	DDetail.Did_CposPoNo,
			--		po.Po_Key	AS hcPo_Key1,
			--		DHeader.Dih_Key	AS hcDo_Key,
			--		CAST(DHeader.Dih_No AS nvarchar(max))	AS hcDo_No,
			--		Dih_Date AS hcDo_Date,
			--		Dih_RefNo AS hcDo_RefNo,
			--		Dih_RefDate AS hcDo_RefDate,
			--		ISNULL(DHeader.Dih_NetValue,0.00) AS hcDoTotalAmount,
			--		vm.Vendor_Name AS hcDoVendor_Name
			--		--,IM.MM_ManufactureBy,Im.MM_MarketingBy
			--FROM	DispatchHeader(NOLOCK) DHeader
			--		LEFT JOIN DispatchDetail(NOLOCK) DDetail
			--ON			DDetail.Did_DihKey = DHeader.Dih_Key
			--		LEFT JOIN PoHeader po
			--ON			po.Po_No = DDetail.Did_CposPoNo
			--		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm
			--ON			mm.Mm_ID = DDetail.Did_MmId
			--		LEFT JOIN dbo.UomMaster(NOLOCK) UOMMST
			--ON			UOMMST.Uom_ID = DDetail.Did_UomId
			--		LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			--ON		DHeader.Dih_VenId = vm.Vendor_ID
			--WHERE	DHeader.Dih_VenId = @po_VenId 
			--GROUP BY	po.Po_Key,DDetail.Did_CposPoNo,DHeader.Dih_NetValue,
			--		DHeader.Dih_No,DHeader.Dih_Key,
			--		DHeader.Dih_Date,
			--		DHeader.Dih_RefNo,
			--		DHeader.Dih_RefDate,
			--		vm.Vendor_Name
			--HAVING	ISNULL(SUM(DDetail.Did_Qty),0) - ISNULL(SUM(DDetail.Did_PIQty),0) > 0
			SELECT	Dheader.Sih_Po_No AS Did_CposPoNo,
					po.Po_Key	AS hcPo_Key1,
					DHeader.Sih_Key	AS hcDo_Key,
					CAST(DHeader.Sih_No AS nvarchar(max))	AS hcDo_No,
					Sih_Date AS hcDo_Date,
					Dheader.Sih_No AS hcDo_RefNo,
					 Dheader.Sih_Date AS hcDo_RefDate,
					ISNULL(DHeader.Sih_Total,0.00) AS hcDoTotalAmount,
					'' AS hcDoVendor_Name
					--,IM.MM_ManufactureBy,Im.MM_MarketingBy
			FROM	cPOS_SalesInvoiceHeader (NOLOCK) DHeader
					LEFT JOIN cPOS_SalesInvoiceItemDetail(NOLOCK) DDetail
			ON			DDetail.Sid_Sih_Key = DHeader.Sih_Key
					LEFT JOIN PoHeader po
			ON			po.Po_No = DHeader.Sih_Po_No
					LEFT JOIN dbo.MedicineMaster(NOLOCK) mm
			ON			mm.Mm_Code=DDetail.Sid_Item_Code
					LEFT JOIN dbo.UomMaster(NOLOCK) UOMMST
			ON			UOMMST.Uom_ID = mm.MM_PurchaseUom
			WHERE	DHeader.Sih_Key 
					NOT IN(SELECT	DISTINCT Sih_Key 
							FROM	cPOS_SalesInvoiceItemDetail	CPOSSID 
									INNER JOIN cPOS_SalesInvoiceHeader	CPOSSIH
							ON		CPOSSIH.Sih_Key=CPOSSID.Sid_Sih_Key
									INNER JOIN PurchaseInvoiceDetail	PID
							ON		PID.Pid_DoKey=CPOSSID.Sid_Key)
			--		LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			--ON		DHeader.Dih_VenId = vm.Vendor_ID
			--WHERE	DHeader.Dih_VenId = @po_VenId 
			GROUP BY	po.Po_Key,DHeader.Sih_Po_No,
						DHeader.Sih_Total,
					DHeader.Sih_No,
					DHeader.Sih_Key,
					DHeader.Sih_Date
			--HAVING	ISNULL(SUM(DDetail.Sid_Qty),0) - ISNULL(SUM(DDetail.Did_PIQty),0) > 0
		END;
	ELSE IF @SP_STATUS = 'BIND_PO_ITEM_SEARCH'
	BEGIN
	DECLARE @dynaSqlPo nvarchar(max) = '';
	--SET @dynaSqlPo += 'Select * from (SELECT		CONVERT(BIT, 0) AS SEL,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
	--				SUM(ISNULL(POITMDET.Pi_Qty, 0)) - SUM(ISNULL(POITMDET.Pi_PiQty, 0)) AS PI_QTY,vm.Vendor_Name,POHEAD.Po_Key,POHEAD.Po_VenId,POHEAD.Po_No
	--    FROM		PoHeader POHEAD
	--			INNER JOIN PoItemDetails POITMDET
	--	ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
	--			INNER JOIN dbo.MedicineMaster IM
	--	ON			IM.Mm_ID = POITMDET.Pi_ItemId
	--			INNER JOIN dbo.UomMaster UOMMST
	--	ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
	--			INNER JOIN dbo.VendorMaster vm
	--	ON			POHEAD.Po_VenId = vm.Vendor_ID
	--    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0) > 0 
	--			AND	POHEAD.Po_VenId = 2 GROUP BY Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_VenId,Po_DelDate,Vendor_Name,Po_Key )dt WHERE dt.Po_No like '%004%' OR dt.Vendor_Name like '%001%' 
	SET @dynaSqlPo += 'Select * from (SELECT		CONVERT(BIT, 0) AS SEL,POHEAD.Po_Key,POHEAD.Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
							SUM(ISNULL(POITMDET.Pi_Qty, 0)) - SUM(ISNULL(POITMDET.Pi_PiQty, 0))- SUM(ISNULL(POITMDET.Pi_ShortCloseQty, 0)) AS PI_QTY,vm.Vendor_Name
			    FROM		PoHeader  (NOLOCK) POHEAD
						INNER JOIN PoItemDetails  (NOLOCK) POITMDET
				ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
						INNER JOIN dbo.MedicineMaster  (NOLOCK) IM
				ON			IM.Mm_ID = POITMDET.Pi_ItemId
						INNER JOIN dbo.UomMaster (NOLOCK)  UOMMST
				ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
						INNER JOIN dbo.VendorMaster  (NOLOCK) vm
				ON			POHEAD.Po_VenId = vm.Vendor_ID
			    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0)- ISNULL(POITMDET.Pi_ShortCloseQty, 0)> 0 
						AND	POHEAD.Po_VenId = ' + CAST(@Po_VenId AS nvarchar(10));
	IF @PO_KEYS <> ''
		BEGIN
		SET @dynaSqlPo += ' OR POHEAD.Po_Key in (' + @PO_KEYS + ')';
		END;
	SET @dynaSqlPo += ' GROUP BY Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_VenId,Po_DelDate,Vendor_Name,Po_Key';
	SET @dynaSqlPo += ' )dt WHERE dt.Po_No like ''%' + ISNULL(@Po_Search_Text,'') + '%'' OR dt.Vendor_Name like ''%' + ISNULL(@Po_Search_Text,'') + '%'''
	PRINT @dynaSqlPo
	EXEC (@dynaSqlPo);
	END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
	BEGIN
	DECLARE @MSG_OUT1 nvarchar(max)

	EXEC [SP_Tbl_Dependency1]	'PoItemDetails',
										@Pi_ItemName,
										@MSG_OUT1 OUTPUT

	IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT1,14,9)
		END
	END
	ELSE IF @SP_STATUS = 'GET_ITEM_BY_PO_KEY'
	BEGIN

	--SELECT	CAST(0 AS bit)		AS SEL,
	--			PID.Pi_Key,
	--			PID.Pi_PoKey		AS Po_Key,
	--			PID.Pi_SrNo,
	--			PID.Pi_ItemId,
	--			PID.Pi_ItemName,
	--			PID.Pi_Uom,
	--			UOM.Uom_Name,
	--			(ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0))	AS Pi_Qty,
	--			PID.Pi_Rate,
	--			Pi_Qty			AS Po_Qty,
	--			PID.Pi_Amt,
	--			MM.Mm_Code,
	--			MM.Mm_MRP,
	--			mm.MM_PackSize	AS Pid_PackId,
	--			MM.Mm_HsnCode		AS PoHsnCode,
	--			MM.MM_ManufactureBy,
	--			MM.MM_MarketingBy,
	--			(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh,
	--			,'' as Is_Available ,
	--			 sum(vws.Item_Stock) as  Item_Stock
	--FROM PoItemDetails(NOLOCK) PID
	--LEFT JOIN PurchaseInvoiceDetail(NOLOCK) POINVDET
	--	ON PID.Pi_PoKey = POINVDET.Pid_PoKey
	--AND		PID.Pi_ItemId = POINVDET.Pid_MmId
	----AND	PID.Pi_SrNo = POINVDET.Pid_PiSrNo
	--LEFT JOIN UomMaster(NOLOCK) UOM
	--	ON PID.Pi_Uom = UOM.Uom_ID
	--LEFT JOIN MedicineMaster(NOLOCK) MM
	--	ON MM.Mm_ID = PID.Pi_ItemId
	--LEFT JOIN  vwStock vws
	--	ON   vws.Item_Id =  PID.Pi_ItemId
	----		left join PoHeader po 
	----on			po.Po_Key=PID.Pi_PoKey
	--WHERE pid.Pi_PoKey = 2
	--AND (ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0)) > 0
	----and po.Po_ApproveStatus='Approve';

	--GROUP BY
	--PID.Pi_Key,
	--PID.Pi_PoKey,		
	--PID.Pi_SrNo,
	--PID.Pi_ItemId,
	--PID.Pi_ItemName,
	--PID.Pi_Uom,
	--UOM.Uom_Name,
	--PID.Pi_Qty,   
	--PID.Pi_PiQty,
	--PID.Pi_ShortCloseQty,
	--PID.Pi_Rate,
	--Pi_Qty	,
	--PID.Pi_Amt,
	--MM.Mm_Code,
	--MM.Mm_MRP,
	--mm.MM_PackSize	,
	--MM.Mm_HsnCode	,
	--MM.MM_ManufactureBy,
	--MM.MM_MarketingBy,
	--MM.Mm_MaintainExp
	
SELECT	CAST(0 AS bit)		AS SEL,
				PID.Pi_Key,
				PID.Pi_PoKey		AS Po_Key,
				PID.Pi_SrNo,
				PID.Pi_ItemId,
				PID.Pi_ItemName,
				PID.Pi_Uom,
				UOM.Uom_Name,
				(ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0))	AS Pi_Qty,
				PID.Pi_Rate,
				Pi_Qty			AS Po_Qty,
				PID.Pi_Amt,
				MM.Mm_Code,
				MM.Mm_MRP,
				mm.MM_PackSize	AS Pid_PackId,
				MM.Mm_HsnCode		AS PoHsnCode,
				MM.MM_ManufactureBy,
				MM.MM_MarketingBy,
				(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh,
				,case when sum(vws.Item_Stock) > 0  THEN 'YES' ELSE 'NO' END  as Is_Available 
				,sum(vws.Item_Stock) as  Item_Stock
	FROM		PoItemDetails(NOLOCK) PID
		LEFT JOIN	PurchaseInvoiceDetail(NOLOCK) POINVDET
	ON		PID.Pi_PoKey = POINVDET.Pid_PoKey
		AND PID.Pi_ItemId = POINVDET.Pid_MmId
	--AND	PID.Pi_SrNo = POINVDET.Pid_PiSrNo
		LEFT JOIN UomMaster(NOLOCK) UOM
	ON		PID.Pi_Uom = UOM.Uom_ID
		LEFT JOIN MedicineMaster(NOLOCK) MM
	ON		MM.Mm_ID = PID.Pi_ItemId
		LEFT JOIN  vwStock vws
	ON		vws.Item_Id =  PID.Pi_ItemId
	--		left join PoHeader po 
	--on			po.Po_Key=PID.Pi_PoKey
	WHERE	pid.Pi_PoKey = @Pi_PoKey
	AND (ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0)) > 0
	--and po.Po_ApproveStatus='Approve';
	group by
			PID.Pi_Key,
			PID.Pi_PoKey,		
			PID.Pi_SrNo,
			PID.Pi_ItemId,
			PID.Pi_ItemName,
			PID.Pi_Uom,
			UOM.Uom_Name,
			PID.Pi_Qty,   
			PID.Pi_PiQty,
			PID.Pi_ShortCloseQty,
			PID.Pi_Rate,
			Pi_Qty	,
			PID.Pi_Amt,
			MM.Mm_Code,
			MM.Mm_MRP,
			mm.MM_PackSize	,
			MM.Mm_HsnCode	,
			MM.MM_ManufactureBy,
			MM.MM_MarketingBy,
			MM.Mm_MaintainExp

	END;
	ELSE IF @SP_STATUS = 'GET_ITEM_BY_DO_KEY'
	BEGIN

		----SELECT	CAST(0 AS bit)	AS SEL,
		----		DD.Sid_Key AS Pi_Key,
		----		DD.Sid_Sih_Key AS Po_Key,
		----		DD.Sid_SrNo AS Pi_SrNo,
		----		MM.Mm_ID AS Pi_ItemId,
		----		MM.Mm_Name AS Pi_ItemName,
		----		UOM.Uom_ID AS Pi_Uom,
		----		UOM.Uom_Name,
		----		(ISNULL(DD.Sid_Qty,0))	AS Pi_Qty,
		----		DD.Sid_Item_Rate Pi_Rate,
		----		Sid_Qty AS Po_Qty,
		----		DD.Sid_Total AS Pi_Amt,
		----		MM.Mm_Code,
		----		DD.Sid_Item_MRP Mm_MRP,
		----		mm.MM_PackSize AS Pid_PackId,
		----		MM.Mm_HsnCode AS PoHsnCode,
		----		MM.MM_ManufactureBy,
		----		MM.MM_MarketingBy,
		----		DD.Sid_Batch_No,
		----		DD.Sid_ExpDate,
		----		DD.Sid_MnfDate,
		----		'' as Is_Available,
		----		(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus,---Add Hasmukh
		----		ISNULL(DD.Sid_Disc,0)AS Sid_Disc, --Add Hasmukh 02-01-2019
		----		ISNULL(DD.Sid_DiscAmount,0)AS Sid_DiscAmount, --Add Hasmukh 02-01-2019
		----		ISNULL(DD.Sid_MnfName,'') AS Sid_MnfName
		----FROM	cPOS_SalesInvoiceItemDetail (NOLOCK) DD
		------		LEFT JOIN PurchaseInvoiceDetail (NOLOCK) POINVDET
		------ON			DD.Did_DihKey = POINVDET.Pid_PoKey
		------		AND	DD.Did_MmId = POINVDET.Pid_MmId
		------		AND	DD.Did_SrNo = POINVDET.Pid_PiSrNo
		----		LEFT JOIN MedicineMaster(NOLOCK) MM
		----ON		MM.Mm_Code = DD.Sid_Item_Code
		----		LEFT JOIN UomMaster(NOLOCK) UOM
		----ON		MM.MM_PurchaseUom = UOM.Uom_ID
		----WHERE		DD.Sid_Sih_Key = @Pi_PoKey
				--AND (ISNULL(DD.Sid_Qty,0) - ISNULL(DD.Did_PIQty,0)) > 0
			SELECT	CAST(0 AS bit)	AS SEL,
					DD.Sid_Sih_Key AS Pi_Key,
					DD.Sid_Sih_Key AS Po_Key,
					--DD.Sid_SrNo AS Pi_SrNo,
					ROW_NUMBER()OVER(ORDER BY MM_Code,DD.Sid_Batch_No) AS Pi_SrNo,
					MM.Mm_ID AS Pi_ItemId,
					MM.Mm_Name AS Pi_ItemName,
					UOM.Uom_ID AS Pi_Uom,
					UOM.Uom_Name,
					SUM((ISNULL(DD.Sid_Qty,0)))	AS Pi_Qty,
					DD.Sid_Item_Rate Pi_Rate,
					SUM(Sid_Qty) AS Po_Qty,
					SUM(DD.Sid_Total) AS Pi_Amt,
					MM.Mm_Code,
					DD.Sid_Item_MRP Mm_MRP,
					mm.MM_PackSize AS Pid_PackId,
					MM.Mm_HsnCode AS PoHsnCode,
					MM.MM_ManufactureBy,
					MM.MM_MarketingBy,
					DD.Sid_Batch_No,
					DD.Sid_ExpDate,
					DD.Sid_MnfDate,
					'' as Is_Available,
					(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus,---Add Hasmukh
					MAX(ISNULL(DD.Sid_Disc,0)) AS Sid_Disc, --Add Hasmukh 02-01-2019
					SUM(ISNULL(DD.Sid_DiscAmount,0))AS Sid_DiscAmount, --Add Hasmukh 02-01-2019
					ISNULL(DD.Sid_MnfName,'') AS Sid_MnfName
			FROM	cPOS_SalesInvoiceItemDetail (NOLOCK) DD
			--		LEFT JOIN PurchaseInvoiceDetail (NOLOCK) POINVDET
			--ON			DD.Did_DihKey = POINVDET.Pid_PoKey
			--		AND	DD.Did_MmId = POINVDET.Pid_MmId
			--		AND	DD.Did_SrNo = POINVDET.Pid_PiSrNo
					LEFT JOIN MedicineMaster(NOLOCK) MM
			ON		MM.Mm_Code = DD.Sid_Item_Code
					LEFT JOIN UomMaster(NOLOCK) UOM
			ON		MM.MM_PurchaseUom = UOM.Uom_ID
			WHERE		DD.Sid_Sih_Key = @Pi_PoKey
			GROUP BY DD.Sid_Sih_Key ,DD.Sid_Sih_Key,MM.Mm_ID,MM.Mm_Name,UOM.Uom_ID,UOM.Uom_Name,DD.Sid_Item_Rate,MM.Mm_Code,
					DD.Sid_Item_MRP,
					mm.MM_PackSize,
					MM.Mm_HsnCode,
					MM.MM_ManufactureBy,
					MM.MM_MarketingBy,
					DD.Sid_Batch_No,
					DD.Sid_ExpDate,
					DD.Sid_MnfDate,MM.Mm_MaintainExp,ISNULL(DD.Sid_MnfName,'')

	END;
	ELSE IF @SP_STATUS = 'SYNCH_UPDATE'---->PO Synch Status Update Add Hasmukh
	BEGIN
	     UPDATE PoHeader
		    SET Po_IsSync='true',
			    Po_LastSyncDate=GETDATE()
		  WHERE Po_Key=@Po_Key
		SELECT @ID=@Po_Key;
	END;
	ELSE IF @SP_STATUS = 'BIND_ITEM_DISTRIBUTOR'
	BEGIN
	--DECLARE @VEN_TYPE	INT
	--SELECT TOP(1) @VEN_TYPE=ISNULL(VENDOR_VT_ID,0) FROM CustomerMaster (nolock) WHERE Vendor_ID=@Po_VenId
	SELECT		CONVERT(BIT,0)											AS 'IND_SEL',
				mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				--UomMaster.Uom_Name,
				--UomMaster.Uom_ID,
				UomMaster.Uom_Name,
				mm.Mm_PurRate							AS ItemRate,
				0											AS INDD_SR_NO,
				mm.Mm_LeadTime,
				UomMaster.Uom_Name					AS Uom_Code,
				MM_PurchaseUom							AS PI_UOM_ID,
				SUM(ISNULL(VwDeliChall.STOCK,0))	AS Stock,
				mm.Mm_MinLevel,
				mm.Mm_MaxLevel,
				mm.Mm_MRP,
				mm.MM_PackSize							AS Pid_PackId,
				mm.Mm_MtmId								AS Po_Manufacture,
				mm.Mm_HsnCode							AS PoHsnCode,
				mm.MM_ManufactureBy,
				mm.MM_MarketingBy,
				mm.Mm_MaxLevel,
				mm.Mm_MinLevel,
				(CASE WHEN mm.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
				,ISNULL(mm.Mm_Primary_Size,'') AS Mm_Primary_Size
				,ISNULL(mm.Mm_Second_Size,'') AS Mm_Second_Size
				,ISNULL(mm.Mm_Tertairy_Size,'') AS Mm_Tertairy_Size
	FROM dbo.MedicineMaster mm (NOLOCK)
	LEFT JOIN UomMaster(NOLOCK)
		ON mm.MM_PurchaseUom = UomMaster.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VwDeliChall
		ON mm.Mm_ID = VwDeliChall.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	--AND (( --@VEN_TYPE = 1  AND 
	-- mm.Mm_MtmId = 1)
	----OR (@VEN_TYPE != 1)
	--AND mm.Mm_MtmId != 1) 
	GROUP BY Mm_ID,Mm_Name,Mm_Code,Uom_Name,
	--Uom_ID,
			mm.MM_PurchaseUom,Mm_LeadTime,Uom_Code,Mm_MinLevel,Mm_MaxLevel,mm.Mm_PurRate,Mm_MRP,mm.MM_PackSize,mm.Mm_MtmId,mm.Mm_HsnCode,mm.MM_ManufactureBy,mm.MM_MarketingBy,mm.Mm_MaintainExp,
			ISNULL(mm.Mm_Primary_Size,''),ISNULL(mm.Mm_Second_Size,''),ISNULL(mm.Mm_Tertairy_Size,'')
	ORDER BY Mm_Name
	END;

	ELSE IF @SP_STATUS='SYNC_STORE_PO_HEADER'
		BEGIN
			IF NOT EXiSTS(SELECT * FROM PoHeader_Store WHERE Po_Key = @Po_Key AND Po_Store_Code = @PO_Store_Code)
				BEGIN
					SELECT		@Po_POS_KEY = ISNULL(MAX(Po_POS_KEY),0) + 1
					FROM		PoHeader_Store (NOLOCK)

					INSERT 
					INTO		PoHeader_Store
								(Po_POS_KEY,Po_Key, Po_No, Po_Date, Po_RefNo, Po_RefDate, Po_RevNo, Po_RevDate, Po_DelDate, Po_BasicVal, Po_Disc, Po_Disc_Val, Po_TotVal, Po_Annexure, 
								Po_CoverLetter, Po_Remarks, Po_PaymentTerms, Po_CreditDays, Po_AuthDate, Po_CreatedDt, Po_Store_Code)
					VALUES		(@Po_POS_KEY,@Po_Key, @Po_No, @Po_Date, @Po_RefNo, @Po_RefDate, @Po_RevNo, @Po_RevDate, @Po_DelDate, @Po_BasicVal, @Po_Disc, @Po_Disc_Val, @Po_TotVal, @Po_Annexure, 
								@Po_CoverLetter, @Po_Remarks, @Po_PaymentTerms, @Po_CreditDays, @Po_AuthDate, GETDATE(), @PO_Store_Code)
				END
			ELSE 
				BEGIN
					SELECT		@Po_POS_KEY = Po_POS_KEY
					FROM		PoHeader_Store (NOLOCK)
					WHERE		Po_Key = @Po_Key
							AND Po_Store_Code=@Po_Store_Code

					UPDATE		PoHeader_Store
					SET			Po_No = @Po_No, Po_Date = @Po_Date, Po_RefNo = @Po_RefNo, Po_RefDate = @Po_RefDate, Po_RevNo = @Po_RevNo, Po_RevDate = @Po_RevDate, Po_DelDate=@Po_DelDate, 
								Po_BasicVal=@Po_BasicVal, Po_Disc=@Po_Disc, Po_Disc_Val=@Po_Disc_Val, Po_TotVal=@Po_TotVal, Po_Annexure=@Po_Annexure, Po_CoverLetter=@Po_CoverLetter, 
								Po_Remarks=@Po_Remarks, Po_PaymentTerms=@Po_PaymentTerms, Po_CreditDays=@Po_CreditDays, Po_AuthDate=@Po_AuthDate
					WHERE		Po_Key=@Po_Key
							AND Po_Store_Code=@Po_Store_Code

					DELETE 
					FROM		PoItemDetails_Store 
					WHERE		PI_Po_POS_KEY = @Po_POS_KEY
				END

				SET				@ID = @Po_POS_KEY
		END

	ELSE iF @SP_STATUS='SYNC_STORE_PO_ITEMS'
		BEGIN
			INSERT iNTO PoItemDetails_Store(Pi_Key, Pi_PoKey, Pi_SrNo, Pi_ItemId, Pi_ItemName, Pi_Qty, Pi_Rate, Pi_Disc, Pi_Disc_Val, Pi_Amt, Pi_Net_Amt, Pi_Remarks,PI_Po_POS_KEY)
			VALUES(@Pi_Key, @Pi_PoKey, @Pi_SrNo, @Pi_ItemId, @Pi_ItemName, @Pi_Qty, @Pi_Rate, @Pi_Disc, @Pi_Disc_Val, @Pi_Amt, @Pi_Net_Amt, @Pi_Remarks,@Po_POS_KEY)
		END
END;
GO
/****** Object:  StoredProcedure [dbo].[Sp_PurchaseReturn]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC Sp_PurchaseReturn @SP_STATUS='BIND_PI',@Prh_VendorId=1
CREATE PROCEDURE [dbo].[Sp_PurchaseReturn]
---------------------- PURCHASE RETURN HEADER --------------------
@SP_STATUS		varchar(200) = '',
@USER			int = 0,
@ID				Decimal = 0 OUT,
@Prh_Id			numeric(18,0) = 0,
@Prh_No			numeric(18,0) = 0,
@Prh_Date		[DATETIME] = NULL,
@Prh_RefNo		[VARCHAR](200) = '',
@Prh_RefDate	[DATETIME] = NULL,
@Prh_PihKey		numeric(18,0) = 0,
@Prh_Remarks	[VARCHAR](1000) = '',
@Prh_BranchId	[INT] = 0,
@Prh_YearId		[INT] = 0,
@Prh_StartDate	datetime = NULL,
@Prh_EndDate	datetime = NULL,
---------------------- PURCHASE RETURN Detail --------------------
@Prd_Id			numeric(18,0) = 0,
@Prd_PrhId		numeric(18,0) = 0,
@Prd_SrNo		int = 0,
@Prd_MmId		numeric(18,0) = 0,
@Prd_BatchNo	nvarchar(50) = 0,
@Prd_UomId		int = 0,
@Prd_Qty		numeric(18,2) = 0,
@Prd_Rate		numeric(18,2) = 0,
@Prd_Amount		numeric(18,2) = 0,
@Prd_Remarks	varchar(1000) = NULL,
@Prd_PidKey		numeric(18,0) = 0,
@Prh_TotalAmount decimal(18,2) = 0,
@Prh_VendorId	numeric(18,0) = 0,
@Prd_LmId		int = 0,
@Prd_FreeQty	decimal(18,3) = 0,
@Prd_PidSrNo	int = 0,
@Prd_PihKey		numeric(18,0) = 0,
@Prh_Vendor_Add_id	bigint=0,
@Prh_Based_On		int=0
AS
DECLARE @FROM_DATE	DATETIME
DECLARE @TO_DATE	DATETIME

SELECT	TOP(1)
		@FROM_DATE=A.Year_FromDate,
		@TO_DATE=A.Year_ToDate
FROM	YearMaster A
WHERE	A.Year_IsDef=1
	IF @SP_STATUS = 'AutoPRNumber'
		BEGIN
			DECLARE @FormPrefix AS nvarchar(max) = '';
			SELECT @FormPrefix = FormPrefix
			FROM FormDetailTable(NOLOCK)
			WHERE Id = 6
			SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Prh_No,0)))
			FROM [PurchaseReturnHeader](NOLOCK)
			WHERE PurchaseReturnHeader.Prh_Date BETWEEN @FROM_DATE AND @TO_DATE
		END;
	ELSE IF @SP_STATUS = 'BIND_ITEM'
		BEGIN
			DECLARE @FormPrefix_BindiTEM AS nvarchar(max) = '';
			SELECT	@FormPrefix_BindiTEM = FormPrefix
			FROM	FormDetailTable(NOLOCK)
			WHERE	Id = 6
			SELECT	CAST(0 AS bit)															AS Chk,
					@FormPrefix_BindiTEM + CAST(pih.Pih_No AS nvarchar(max))	AS Pih_No,
					pih.Pih_keY,
					MM.Mm_Code,
					MM.Mm_Name,
					MM.MM_PackSize															AS Ps_Name,
					Pid_BatchNo,
					uom.Uom_Name,
					(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00))	AS RemainigPurchaseQty,
					(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00))	AS OldStock,
					pid.Pid_Rate,
					pid.Pid_Disc,
					pid.Pid_DiscAmount,
					pid.Pid_Amount,
					MM.MM_PackSize															AS Pid_PackId,
					Pid_UomId,
					Pid_MmId,
					pid.Pid_PihKey,
					pid.Pid_Key,
					pid.Pid_ExpiryDt,
					pid.Pid_MfgDt,
					pih.Pih_VenId
			FROM	dbo.PurchaseInvoiceDetail(NOLOCK) pid
					LEFT JOIN dbo.PurchaseReturnDetail(NOLOCK) prd
			ON			pid.Pid_Key = prd.Prd_PidKey
					AND pid.Pid_MmId = prd.Prd_MmId
					AND pid.Pid_BatchNo = prd.Prd_BatchNo
					AND pid.Pid_UomId = prd.Prd_UomId
					LEFT JOIN dbo.MedicineMaster(NOLOCK) MM
			ON		pid.Pid_MmId = MM.Mm_ID
					LEFT JOIN dbo.UomMaster(NOLOCK) uom
			ON		pid.Pid_UomId = uom.Uom_ID
					LEFT JOIN dbo.PurchaseInvoiceHeader(NOLOCK) pih
			ON		pid.Pid_PihKey = pih.Pih_Key GROUP BY Pid_Qty,Pid_MmId,Pid_BatchNo,Pid_UomId,MM.Mm_Name,uom.Uom_Name,MM.Mm_Code,Pid_PihKey,pid.Pid_Rate,pid.Pid_Disc,pid.Pid_Amount,pid.Pid_Key,pih.Pih_No,Pid_DiscAmount,pid.Pid_ExpiryDt,pid.Pid_MfgDt,pih.Pih_VenId,pih.Pih_keY,MM.MM_PackSize
			HAVING (ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00)) > 0
			ORDER BY Pid_PihKey;
		END;
	ELSE IF @SP_STATUS = 'BIND_ITEM_NEW'
		BEGIN
			SELECT	CAST(0 AS bit) AS Chk,
					pih.Pih_No,
					pih.Pih_keY,
					MM.Mm_Code,
					MM.Mm_Name,
					MM_PackSize																AS Ps_Name,
					Pid_BatchNo,
					uom.Uom_Name,
					ISNULL((CASE WHEN  ISNULL(vwStockWithExp.Purchase_Item_Stock,0)>(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00)) THEN  (ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00)) ELSE ISNULL(vwStockWithExp.Purchase_Item_Stock,0) END),0)AS ReturnAvailableStock,
					(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00))	AS RemainigPurchaseQty,
					(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00))	AS OldStock,
					pid.Pid_Rate,
					pid.Pid_Sales_Rate,
					pid.Pid_MRP,
					pid.Pid_Disc,
					pid.Pid_DiscAmount,
					pid.Pid_Amount,
					MM.MM_PackSize															AS Pid_PackId,
					Pid_UomId,
					Pid_MmId,
					pid.Pid_PihKey,
					pid.Pid_Key,
					pid.Pid_ExpiryDt,
					pid.Pid_MfgDt,
					pih.Pih_VenId,
					vm.Vendor_Name,
					pih.Pih_VenAddId,
					STUFF((SELECT DISTINCT
						',' + VendAdd_Addr1
					FROM VendorAddMaster AS VAM
					WHERE VAM.VendAdd_Id = Pih_VenAddId
					FOR xml PATH ('')),1,1,'')											AS Vendor_Address,
					pid.Pid_LmId															AS prd_LmId,
					--pid.Pid_LmId AS prd_LmId,
					lm.Lm_Name,
					pid.Pid_FreeQty,
					pid.Pid_PihKey															AS Prd_PihKey,
					pid.Pid_SrNo															AS Prd_PidSrNo,
					ISNULL(vwStockWithExp.Purchase_Item_Stock,0)							AS Purchase_Item_Stock,
					pih.Pih_RefNo AS Prd_PihRefNo--Add Hasmukh For Account Remark
			FROM	dbo.PurchaseInvoiceDetail(NOLOCK) pid
					LEFT JOIN dbo.PurchaseReturnDetail(NOLOCK) prd
			ON			pid.Pid_PihKey = prd.Prd_PihKey
					AND pid.Pid_SrNo = prd.Prd_PidSrNo
					AND pid.Pid_MmId = prd.Prd_MmId
					AND pid.Pid_BatchNo = prd.Prd_BatchNo
					LEFT JOIN vwStockWithExp(NOLOCK)
			ON			pid.Pid_MmId = vwStockWithExp.Item_Id
					AND pid.Pid_BatchNo = vwStockWithExp.Item_Batchno
					LEFT JOIN dbo.MedicineMaster(NOLOCK) MM
			ON		pid.Pid_MmId = MM.Mm_ID
					LEFT JOIN dbo.UomMaster(NOLOCK) uom
			ON		pid.Pid_UomId = uom.Uom_ID
					LEFT JOIN dbo.PurchaseInvoiceHeader(NOLOCK) pih
			ON		pid.Pid_PihKey = pih.Pih_Key
					LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			ON		vm.Vendor_ID = pih.Pih_VenId
					LEFT JOIN dbo.LocationMaster(NOLOCK) lm
			ON		pid.Pid_LmId = lm.Lm_Id
			WHERE	pih.Pih_VenId = @Prh_VendorId AND pih.Pih_Key=@Prd_PihKey---Add Pi Key Filter
			--AND DATEDIFF(DAY,GETDATE(),ISNULL(Pid_ExpiryDt,GETDATE())) >= (CASE
			--	WHEN ISNULL(Pid_ExpiryDt,'') != '' THEN (SELECT TOP 1
			--	ISNULL(PrExpDays,0)
			--	FROM ConfigurationMaster)
			--	ELSE 0
			--END)
			AND Purchase_Item_Stock > 0 
			GROUP BY pid.Pid_SrNo,Pid_Qty,Pid_MmId,Pid_BatchNo,Pid_UomId,MM.Mm_Name,MM.MM_PackSize,uom.Uom_Name,MM.Mm_Code,Pid_PihKey,pid.Pid_Rate,pid.Pid_Sales_Rate,pid.Pid_MRP,pid.Pid_Disc,pid.Pid_Amount,pid.Pid_Key,pih.Pih_No,Pid_DiscAmount,pid.Pid_ExpiryDt,pid.Pid_MfgDt,pih.Pih_VenId,pih.Pih_keY,vm.Vendor_Name,pih.Pih_VenAddId,pid.Pid_LmId,lm.Lm_Name,pid.Pid_FreeQty,vwStockWithExp.Purchase_Item_Stock,pih.Pih_RefNo
			HAVING (CASE WHEN  ISNULL(vwStockWithExp.Purchase_Item_Stock,0)>(ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00)) THEN  (ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00)) ELSE ISNULL(vwStockWithExp.Purchase_Item_Stock,0) END) > 0
			ORDER BY Pid_PihKey;

		END;
	ELSE IF @SP_STATUS = 'BIND_PI'
	BEGIN
	     
		  SELECT	pih.Pih_Key AS hcPi_Key,
	            		CAST(pih.Pih_No AS nvarchar(max))	AS hcPi_No,
	            		pih.Pih_Date	AS hcPi_Date,
	            		Pih_RefNo AS hcPi_RefNo,
	            		Pih_RefDate AS hcPi_RefDate,
	            		ISNULL(pih.Pih_NetValue,0.00) AS hcTotalAmount,
	            		vm.Vendor_Name AS hcVendor_Name,
	            		pih.Pih_VenId AS hcVenId,
	            		pih.Pih_VenAddId AS hcBranchId,
		    			0 AS Pid_Qty,
		    			0 AS Prd_Qty,
		    			ISNULL(vam.VendAdd_Addr1,'')+','+ISNULL(vam.VendAdd_Add2,'')+','+ISNULL(vam.VendAdd_Add3,'')AS hcVendAddress
						
	            	--,IM.MM_ManufactureBy,Im.MM_MarketingBy
	            FROM  dbo.PurchaseInvoiceHeader(NOLOCK) pih
				      
	            LEFT JOIN dbo.VendorMaster(NOLOCK) vm
	            	ON vm.Vendor_ID = pih.Pih_VenId
		    	LEFT JOIN dbo.VendorAddMaster VAM
		    	    ON VAM.VendAdd_Id=pih.Pih_VenAddId
			   WHERE pih.Pih_VenId=@Prh_VendorId
		    	GROUP BY pih.Pih_Key,
	            		 pih.Pih_No,
	            		 pih.Pih_Date,
	            		 Pih_RefNo,
	            		 Pih_RefDate,
	            		ISNULL(pih.Pih_NetValue,0.00),
	            		vm.Vendor_Name,
	            		pih.Pih_VenId,
	            		pih.Pih_VenAddId,
		    			VendAdd_Addr1,
		    			VendAdd_Add2,
		    			VendAdd_Add3  
	END;
	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT @Prh_Id = ISNULL(MAX(Prh_Id),0) + 1
			FROM PurchaseReturnHeader(NOLOCK);
			SELECT @Prh_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Prh_No,0)))
			FROM [PurchaseReturnHeader](NOLOCK)
			WHERE	PurchaseReturnHeader.Prh_Date BETWEEN @FROM_DATE AND @TO_DATE
			INSERT INTO [dbo].[PurchaseReturnHeader](
					[Prh_Id],
					[Prh_No],
					[Prh_Date],
					[Prh_RefNo],
					[Prh_RefDate],
					[Prh_PihKey],
					[Prh_Remarks],
					[Prh_BranchId],
					[Prh_YearId],
					Prh_CreatedBy,
					Prh_CreatedDate,
					Prh_TotalAmount,
					Prh_VendorId,
					Prh_Vendor_Add_id,
					Prh_Based_On) 
			VALUES	(@Prh_Id,@Prh_No,@Prh_Date,@Prh_RefNo,@Prh_RefDate,@Prh_PihKey,@Prh_Remarks,@Prh_BranchId,@Prh_YearId,@USER,GETDATE(),@Prh_TotalAmount,@Prh_VendorId,@Prh_Vendor_Add_id,@Prh_Based_On);
			SELECT @ID = @Prh_Id;
		END;
	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			DECLARE @MSG_OUT_update nvarchar(max)
			EXEC SP_Tbl_Dependency	'[PurchaseReturnHeader]',@Prh_Id,@MSG_OUT_update OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT_update,14,9)
				END
			ELSE 
				BEGIN
					UPDATE	[dbo].[PurchaseReturnHeader]
					SET		--[Prh_No] = @Prh_No,
							[Prh_Date] = @Prh_Date,
							[Prh_RefNo] = @Prh_RefNo,
							[Prh_RefDate] = @Prh_RefDate,
							[Prh_PihKey] = @Prh_PihKey,
							[Prh_Remarks] = @Prh_Remarks,
							[Prh_BranchId] = @Prh_BranchId,
							[Prh_YearId] = @Prh_YearId,
							[Prh_UpdatedBy] = @USER,
							[Prh_UpdatedDate] = GETDATE(),
							Prh_TotalAmount = @Prh_TotalAmount,
							Prh_VendorId = @Prh_VendorId
					WHERE	[Prh_Id] = @Prh_Id;

					DELETE FROM PurchaseReturnDetail WHERE Prd_PrhId = @Prh_Id;
					DELETE FROM dbo.StockRegister	WHERE Stk_DocKey = @Prh_Id AND Stk_DocType = @Prh_RefNo;
					DELETE FROM dbo.TaxTransaction	WHERE Tr_DocId=@Prh_Id and  Tr_DocTyp= @Prh_RefNo

					SELECT @ID = @Prh_Id;
				END;
		END
	ELSE IF @SP_STATUS = 'InsertDetail'
		BEGIN
			SELECT	@Prd_Id = ISNULL(MAX(Prd_Id),0) + 1
			FROM	PurchaseReturnDetail(NOLOCK);
			INSERT INTO [dbo].[PurchaseReturnDetail]([Prd_Id],
					[Prd_PrhId],
					[Prd_SrNo],
					[Prd_MmId],
					[Prd_BatchNo],
					[Prd_UomId],
					[Prd_Qty],
					[Prd_Rate],
					[Prd_Amount],
					[Prd_Remarks],
					Prd_PidKey,
					Prd_LmId,Prd_FreeQty,Prd_PidSrNo,Prd_PihKey) 
			VALUES	(@Prd_Id,@Prd_PrhId,@Prd_SrNo,@Prd_MmId,ISNULL(@Prd_BatchNo,''),@Prd_UomId,@Prd_Qty,@Prd_Rate,
					@Prd_Amount,@Prd_Remarks,@Prd_PidKey,@Prd_LmId,@Prd_FreeQty,@Prd_PidSrNo,@Prd_PihKey);
			SELECT	@ID = @Prd_Id;

			--IF @Prd_PrhId > 0
			--	BEGIN
			--	UPDATE PurchaseInvoiceDetail
			--	SET Pid_ReturnQty = ISNULL(Pid_ReturnQty, 0) + ISNULL(@Prd_Qty, 0)
			--	WHERE Pid_PihKey = @Prd_PrhId
			--	AND Pid_Key = @Prd_PidKey
			--	AND Pid_MmId = @Prd_MmId;
			--END;
		END;
	ELSE IF @SP_STATUS = 'FillGridPurchaseReturnList'
		BEGIN
			DECLARE @FormPrefix_Fill_grid AS nvarchar(max) = '';
			SELECT @FormPrefix_Fill_grid = FormPrefix
			FROM FormDetailTable(NOLOCK)
			WHERE Id = 6
			SELECT	PRH.Prh_Id,
						@FormPrefix_Fill_grid + CAST(PRH.Prh_No AS nvarchar(max))	AS Prh_No_New,
						PRH.Prh_No AS Prh_No,
						PRH.Prh_Date,
						PRH.Prh_RefNo,
						PRH.Prh_RefDate,
						PRH.Prh_Remarks,
						UM.User_Name,
						prh.Prh_CreatedDate,
						VM.Vendor_Name,
						PRH.Prh_TotalAmount,
						SUM(ISNULL(Act_PaidAmount,0)) AS Act_PaidAmount,
						Prh_PihKey,
						pih.Pih_No,
						act.Act_Key
			FROM PurchaseReturnHeader(NOLOCK) PRH
			LEFT JOIN UserMaster(NOLOCK) UM
				ON PRH.Prh_CreatedBy = UM.User_ID
			LEFT JOIN VendorMaster(NOLOCK) VM
				ON VM.Vendor_ID = PRH.Prh_VendorId
			LEFT JOIN AccountTransaction act
				ON Act_DocNo = PRH.Prh_No
				AND Act_DocKey = PRH.Prh_Id
				AND Act_DocType = 5
			--LEFT JOIN AccountTransaction act
			--	ON Act_Remarks = @FormPrefix_Fill_grid + CAST(PRH.Prh_No AS nvarchar(max))
			--	AND Act_DocType IN (8,10)---Add  Hasmukh
			LEFT JOIN PurchaseInvoiceHeader pih
				ON pih.Pih_Key = Prh_PihKey 
			Where CAST(Prh_Date AS DATE) BETWEEN @Prh_StartDate AND @Prh_EndDate
			GROUP BY PRH.Prh_Id,CAST(PRH.Prh_No AS nvarchar(max)),PRH.Prh_Date,PRH.Prh_RefNo,PRH.Prh_RefDate,PRH.Prh_Remarks,UM.User_Name,prh.Prh_CreatedDate,VM.Vendor_Name,PRH.Prh_TotalAmount,PRH.Prh_No,Prh_PihKey,Pih_No,act.Act_Key
			ORDER BY PRH.Prh_Id DESC
		END
	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'PurchaseReturnHeader',@Prh_Id,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE BEGIN
				DELETE FROM PurchaseReturnHeader
				WHERE [Prh_Id] = @Prh_Id;

				DELETE FROM PurchaseReturnDetail
				WHERE Prd_PrhId = @Prh_Id;

				DELETE FROM TaxTransaction
				WHERE Tr_DocKey=@Prh_Id
				AND Tr_DocTyp=5;---Add Hasmukh

				DELETE FROM StockRegister
				WHERE Stk_DocKey = @Prh_Id
				AND Stk_DocType = 5;

				END
		END
	ELSE IF @SP_STATUS = 'GetRemarks'
		BEGIN
			SELECT DISTINCT (Prh_Remarks) AS Prh_Remarks
			FROM PurchaseReturnHeader(NOLOCK)
			END
	ELSE IF @SP_STATUS = 'FillVendor'
	BEGIN
			--SELECT	0 AS Vendor_ID,'--Select One--' AS Vendor_Name
			--UNION
			--SELECT	vm.Vendor_ID,vm.Vendor_Name
			--FROM VendorMaster(NOLOCK) vm
			--WHERE ISNULL(vm.Vendor_Name,'') <> ''
			--AND vm.Vendor_IsActive = 1

			SELECT	Vendor_ID AS VEN_ID,
					Vendor_Code AS VEN_CODE,
					Vendor_Name	AS VEN_NAME,
					vam.VendAdd_Id AS VAAD_ID,
					vam.VendAdd_Addr1 + CASE WHEN ISNULL(vam.VendAdd_Add2,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add2,'') ELSE '' END
					+ CASE WHEN ISNULL(vam.VendAdd_Add3,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add3,'') ELSE '' END AS VEN_ADDRESS,
					Vendor_CreditDays,
					area.Area_StateId as StateId,
					vm.Vendor_Vt_Id,
					vt.Vt_name,
					vm.Vendor_Ledger_id
		FROM		VendorMaster(NOLOCK) vm
		INNER JOIN	VendorAddMaster(NOLOCK) vam
		ON			vm.Vendor_ID = vam.VendAdd_VendorId
		AND			vam.VendAdd_IsActive = 1
		LEFT JOIN	AreaMaster(NOLOCK) area
		ON			vam.VendAdd_AreaId = area.Area_ID
		LEFT JOIN	StateMaster(NOLOCK) [state]
		ON			area.Area_StateId = state.State_ID
		LEFT JOIN	VendorTypeMaster(NOLOCK)  as vt
		ON			vm.Vendor_Vt_Id=vt.Vt_Id
		WHERE		vm.Vendor_IsActive = 1 and ISNULL(vm.Vendor_Name,'') <> '';
	END
	ELSE IF @SP_STATUS = 'GetPurchaseInvoiceDetail'
		BEGIN
			SELECT	pih.*,
					lm.Lm_Id
			FROM	PurchaseInvoiceHeader(NOLOCK) pih
					LEFT JOIN LedgerMaster(NOLOCK) lm
			ON		pih.Pih_VenId = lm.Lm_PVId
			WHERE	Pih_Key = @Prd_PihKey
		END
	ELSE IF @SP_STATUS = 'Retirve'
		BEGIN

			--DECLARE		@FormPrefix_ret AS NVARCHAR(MAX) = '';
			--SELECT		@FormPrefix_ret = FormPrefix
			--FROM		FormDetailTable
			--WHERE		Id = 6
			--SELECT		PRH.Prh_Id,
			--			@FormPrefix_ret + cast(PRH.Prh_No as nvarchar(max)) as Prh_No,
			--			PRH.Prh_Date,
			--			PRH.Prh_RefNo,
			--			PRH.Prh_RefDate,
			--			PRH.Prh_Remarks,
			--			UM.User_Name,
			--			prh.Prh_CreatedDate,
			--			PRH.Prh_VendorId AS VendorId,
			--			prh.Prh_TotalAmount
			--FROM PurchaseReturnHeader(NOLOCK) PRH
			--LEFT JOIN UserMaster(NOLOCK) UM
			--	ON PRH.Prh_CreatedBy = UM.User_ID
			--WHERE [Prh_Id] = @Prh_Id;
			DECLARE @FormPrefix_ret AS nvarchar(max) = '';
			SELECT	@FormPrefix_ret = FormPrefix
			FROM	FormDetailTable
			WHERE	Id = 6
			SELECT	PRH.Prh_Id,
					@FormPrefix_ret + CAST(PRH.Prh_No AS nvarchar(max))	AS Prh_No,
					PRH.Prh_Date,
					PRH.Prh_RefNo,
					PRH.Prh_RefDate,
					PRH.Prh_Remarks,
					UM.User_Name,
					prh.Prh_CreatedDate,
					PRH.Prh_VendorId AS VendorId,
					VM.Vendor_Code,
					prh.Prh_TotalAmount,
					(CASE WHEN ISNULL(PRH.Prh_Based_On,0) in(0,1)
							THEN	VAM.VendAdd_Addr1 + ' ' + VAM.VendAdd_Add2 + ' ' + VAM.VendAdd_Add3
							ELSE	VAM1.VendAdd_Addr1 + ' ' + VAM1.VendAdd_Add2 + ' ' + VAM1.VendAdd_Add3
					END)AS Vendor_Address,
						VM.Vendor_Name,
					(CASE WHEN ISNULL(PRH.Prh_Based_On,0) in(0,1)
							THEN pih.Pih_VenAddId
							ELSE Prh_Vendor_Add_id
					END)AS Pih_VenAddId,
					(CASE WHEN ISNULL(PRH.Prh_Based_On,0) in(0,1)
							THEN	CT.City_StateId
							ELSE	CT1.City_StateId
					END)AS StateId,
					ISNULL(PRH.Prh_Based_On,1)AS Prh_Based_On,
					pih.Pih_No,Prh_PihKey--Add Hasmukh																		AS Prh_VenAddId
			FROM	PurchaseReturnHeader(NOLOCK) PRH
					LEFT JOIN UserMaster(NOLOCK) UM
			ON		PRH.Prh_CreatedBy = UM.User_ID
					LEFT JOIN PurchaseInvoiceHeader(NOLOCK) pih
			ON		PRH.Prh_PihKey = pih.Pih_Key
					LEFT JOIN VendorMaster(NOLOCK) VM
			ON		VM.Vendor_ID = PRH.Prh_VendorId
					LEFT JOIN VendorAddMaster(NOLOCK) VAM
			ON		VAM.VendAdd_Id = pih.Pih_VenAddId
					LEFT JOIN VendorAddMaster(NOLOCK) VAM1
			ON		VAM1.VendAdd_Id = PRH.Prh_Vendor_Add_id
			LEFT JOIN CityMaster(NOLOCK) CT
			ON		CT.City_ID = VAM.VendAdd_CityId
			LEFT JOIN CityMaster(NOLOCK) CT1
			ON		CT1.City_ID = VAM1.VendAdd_CityId
			WHERE	[Prh_Id] = @Prh_Id;
			SELECT	PRD.Prd_Id,
					PRD.Prd_PrhId,
					PRD.Prd_SrNo,
					PRD.Prd_MmId,
					mm.Mm_Code	AS Prd_MmCode,
					MM.Mm_Name	AS Prd_MmName,
					MM.MM_PackSize	AS Prd_PackName,
					PRD.Prd_BatchNo,
					UM.Uom_Name	AS Prd_Uom,
					PRD.Prd_Qty,
					PRD.Prd_Rate,
					PRD.Prd_Amount,
					PRD.Prd_Remarks,
					PRD.Prd_UomId,
					prd.Prd_LmId AS prd_LmId,
					ISNULL(Prd_Qty,0.00) + (ISNULL(Pid_Qty,0.00)) - SUM(ISNULL(prd.Prd_Qty,0.00))	AS Prd_StockQty,
					pid.Pid_Key,
					pid.Pid_ExpiryDt,
					pid.Pid_MfgDt,
					lm.Lm_Name,
					Prd_FreeQty,
					ISNULL(SUM(prd.Prd_Qty),0)	AS Pid_ReturnQty,
					pid.Pid_PihKey	AS Prd_PihKey
			FROM	PurchaseReturnDetail(NOLOCK) PRD
					LEFT JOIN dbo.PurchaseInvoiceDetail(NOLOCK) pid
			ON		pid.Pid_PihKey = prd.Prd_PihKey
					AND pid.Pid_SrNo = prd.Prd_PidSrNo
					AND pid.Pid_MmId = prd.Prd_MmId
					AND pid.Pid_BatchNo = PRD.Prd_BatchNo
					LEFT JOIN PurchaseReturnHeader(NOLOCK) prh
			ON		prh.Prh_Id = PRD.Prd_PrhId
					LEFT JOIN UomMaster(NOLOCK) UM
			ON		UM.Uom_ID = PRD.Prd_UomId
					LEFT JOIN MedicineMaster(NOLOCK) MM
			ON		MM.Mm_ID = PRD.Prd_MmId
					LEFT JOIN LocationMaster(NOLOCK) lm
			ON		prd.prd_LmId = lm.Lm_Id
			WHERE	Prd_PrhId = @Prh_Id 
			GROUP BY	PRD.Prd_Id,PRD.Prd_PrhId,PRD.Prd_SrNo,PRD.Prd_MmId,mm.Mm_Code,MM.Mm_Name,MM.MM_PackSize,PRD.Prd_BatchNo,UM.Uom_Name,PRD.Prd_Qty,PRD.Prd_Rate,PRD.Prd_Amount,PRD.Prd_Remarks,PRD.Prd_UomId,pid.Pid_Key,pid.Pid_ExpiryDt,pid.Pid_MfgDt,Pid_Qty,prd.Prd_LmId,lm.Lm_Name,Prd_FreeQty,pid.Pid_PihKey
		END
	ELSE IF @SP_STATUS = 'GetLedgerId'
		BEGIN
			SELECT	Lm_Id
			FROM	LedgerMaster(NOLOCK)
			WHERE	Lm_PVId = @Prh_VendorId AND Lm_GroupId=30;

		END;
	ELSE IF @SP_STATUS = 'GET_PR_NO'
		BEGIN
			SELECT	prh.Prh_No
			FROM	PurchaseReturnHeader(nolock) prh
			WHERE	Prh.Prh_Id = @Prh_Id
		END
	ELSE IF @SP_STATUS = 'GetInvoiceDetail'
		BEGIN
			SELECT	*
			FROM	PurchaseReturnHeader(nolock) prh
			WHERE	prh.Prh_Id = @Prh_Id;
		END
	ELSE IF @SP_STATUS = 'SYNCH_UPDATE'---->PR Synch Status Update Add Hasmukh
		BEGIN
			UPDATE	PurchaseReturnHeader
			SET		Prh_IsSync='true',
					Prh_LastSyncDate=GETDATE()
			WHERE	Prh_Id=@Prh_Id
			SELECT	@ID=@Prh_Id;
		END
	
	ELSE iF @SP_STATUS='GET_BASED_ON_DOC'
		BEGiN
			SELECT	1 AS VAL,'Purchase Invoice' AS DIS
			UNION
			SELECT	2 AS VAL,'Opening Stock' AS DIS
		END

	ELSE iF @SP_STATUS='FILL_VENDOR_CONTROL'
		BEGiN
			SELECT	A.Vendor_ID AS VEN_ID,
					A.Vendor_Code AS VEN_CODE,
					A.Vendor_Name AS VEN_NAME,
					B.VendAdd_Id AS VAAD_ID,
					B.VendAdd_Addr1 + CASE WHEN ISNULL(B.VendAdd_Add2,'') <> '' THEN ISNULL(', '+ B.VendAdd_Add2, '') ELSE '' END
							+ CASE WHEN ISNULL(B.VendAdd_Add3,'') <> '' THEN ISNULL(', '+ B.VendAdd_Add3, '') ELSE '' END AS VEN_ADDRESS,
					area.Area_StateId StateId,ISNULL(A.Vendor_CreditDays,0) as Vendor_CreditDays,isnull(A.Vendor_CreditLimit,0) as Vendor_CreditLimit,
					A.Vendor_Vt_Id,vt.Vt_Name
			FROM	VendorMaster(NOLOCK) A
					inner JOIN VendorAddMaster(NOLOCK) B
			ON		A.Vendor_ID = B.VendAdd_VendorId and B.VendAdd_IsActive=1
					LEFT JOIN AreaMaster (NOLOCK) area
			ON		B.VendAdd_AreaId = area.Area_ID
					LEFT JOIN StateMaster (NOLOCK) [state]
			ON		area.Area_StateId = state.State_ID
					LEFT JOIN VendorTypeMaster as vt
			ON		vt.Vt_Id=A.Vendor_Vt_Id
			WHERE	A.Vendor_IsActive = 1;
		END
	ELSE iF @SP_STATUS='Purchase_Return_Header_Report'
		BEGiN
			 SELECT		A.Prh_No,
						CONVERT(VARCHAR,A.Prh_Date,105)AS Prh_Date,
						B.Vendor_Name,
						A.Prh_Remarks,
						A.Prh_TotalAmount		
			FROM		PurchaseReturnHeader A
						INNER JOIN  VendorMaster B
			ON			A.Prh_VendorId = B.Vendor_ID
						LEFT JOIN VendorAddMaster C
			ON			A.Prh_BranchId = C.VendAdd_Id 
			WHERE		A.Prh_Date BETWEEN CAST(@Prh_Date AS DATE) 
						AND CAST(@Prh_EndDate AS DATE)
		END
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_PICKNOTE]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_REPORT_PICKNOTE]
(
   @TypeId  INT=NULL,
   @FromDate DATETime=NULL,
   @ToDate DATETime=NULL,
   @TopRecord INT=NULL,
   @AccountId INT=NULL
)
AS
SELECT	ROW_NUMBER() OVER (ORDER BY sod.Pi_Key ASC)AS SrNo,
		so.Po_No AS salesorder,
		CONVERT(date,so.Po_Date) AS soDate,
		so.Po_RevNo AS RevNo,
		so.Po_RefNo,
		so.Po_RefDate,
		sod.Pi_Disc,
		sod.Pi_Disc_Val,
		PM.StoreCode  ,
		PM.Pm_Fullname  AS STORENAME,
		PM.Contact_PersonName AS CUSTOMER,
		PM.Pm_Address AS ADDRESS,
		--VM.Vendor_Name AS VendorName,
		
		--ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')AS VendorAddress,
		--VAM.VendAdd_GstNo AS GstNo,
		so.Po_BasicVal AS BasicValue,
		so.Po_TotVal AS TotalValue,
		--(CASE
		--	WHEN (SELECT
		--	COUNT(*)
		--	FROM PurchaseInvoiceDetail PID
		--	WHERE PID.Pid_PoKey =so.Po_key)
		--	> 0 THEN 'Done'
		--	ELSE 'Pending'
		--END)AS InvoiceStatus,
		MM.Mm_HsnCode AS HsnCode,
		MM.Mm_Code AS Code,
		MM.Mm_Name AS Name,
		UOMM.Uom_Name AS UomName,
		sod.Pi_Qty AS Quantity,
		sod.Pi_Rate AS Rate,
		sod.Pi_Amt AS Amount,
		sod.Pi_Net_Amt AS NetAmount,
		MTM.Mtm_TypeName AS DrugType,
		MGM.Mgm_Name AS DrugGroup,
		MCM.Mcm_Name AS DrugCategory,
		BB.SGST,
	    BB.CGST,
	    BB.IGST,
		so.Po_Remarks AS Remarks,
		so.Po_PaymentTerms AS PaymentTerms,
		so.Po_CreditDays AS CreditDays,
		--Convert(varchar,POH.Po_DelDate,105) AS DeliveryDate,
		SM.Store_Name,
		SM.Store_Address1,
		SM.Store_GstNo,
		SM.Store_Email  																																
   FROM SO_DETAIL (nolock) sod
	    INNER JOIN SO_HEADER (nolock) so
		LEFT JOIN StoreMaster SM
		ON SM.Store_Id=1 
	 ON so.Po_Key = sod.Pi_PoKey
	    left  join  PatientMaster (nolock) pm
	 ON  PM.Pm_Id = SO.Po_VenId 
	    INNER JOIN MedicineMaster(NOLOCK) MM
	 ON MM.Mm_ID = sod.Pi_ItemId
	    LEFT JOIN UomMaster(NOLOCK) UOMM
	 ON UOMM.Uom_ID = sod.Pi_Uom
	 --   LEFT JOIN VendorMaster(NOLOCK) VM
	 --ON so.Po_VenId = VM.Vendor_ID
	 --   LEFT JOIN VendorAddMaster(NOLOCK) VAM
	 --ON so.Po_VenAddId = VAM.VendAdd_Id
	    LEFT JOIN BranchMaster(NOLOCK) BM
	 ON so.Po_BmId = BM.Branch_Id
	    LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
	 ON MTM.Mtm_ID = MM.Mm_MtmId
	    LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
	 ON MGM.Mgm_ID = MM.Mm_MgmId
	    LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
	 ON MCM.Mcm_ID = MM.Mm_McmId
        LEFT JOIN (SELECT
	                      A.Pi_Key,
	                   	     ISNULL(SUM(A.SGST),0) AS SGST,
	                      ISNULL(SUM(A.CGST),0) AS CGST,
	                      ISNULL(SUM(A.IGST),0) AS IGST
	                FROM  (SELECT A.Pi_Key,
	                	          B.Tr_TxTot AS CGST,
	                	          C.Tr_TxTot AS SGST,
	                	          D.Tr_TxTot AS IGST
						     FROM PoItemDetails (NOLOCK) AS A
	                              LEFT JOIN TaxTransaction (NOLOCK) B
	                	       ON A.Pi_Key = B.Tr_DdocKey
	                	          AND A.Pi_PoKey = B.Tr_DocKey
	                	          AND B.Tr_TxId = 2
	                	          AND B.Tr_DocTyp = 1
	                              LEFT JOIN TaxTransaction (NOLOCK) C
	                	       ON A.Pi_Key = C.Tr_DdocKey
	                	          AND A.Pi_PoKey = C.Tr_DocKey
	                	          AND C.Tr_DocTyp = 1
	                	          AND C.Tr_TxId = 3
	                              LEFT JOIN TaxTransaction (NOLOCK) D
	                	       ON A.Pi_Key = D.Tr_DdocKey
	                	          AND A.Pi_PoKey = D.Tr_DocKey
	                	          AND D.Tr_DocTyp = 1
	                	          AND D.Tr_TxId = 4) AS A
	                              GROUP BY A.Pi_Key) AS BB
	                 ON sod.Pi_Key = BB.Pi_Key
     WHERE soD.Pi_PoKey=@TypeId 
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_PurchaseInvoice]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_REPORT_PurchaseInvoice]    
(    
   @TypeId  INT=NULL,    
   @FromDate DATETime=NULL,    
   @ToDate DATETime=NULL,    
   @TopRecord INT=NULL,    
   @AccountId INT=NULL    
)    
AS    
SELECT ROW_NUMBER() OVER (ORDER BY PID.Pid_Key ASC)AS SrNo,    
  PIH.Pih_No AS PihNo,    
  CONVERT(varchar,PIH.Pih_Date,105) AS PIhDate,    
  PIH.Pih_RefNo AS BillNo,    
  CONVERT(varchar,PIH.Pih_RefDate,105) AS BillDate,    
  VM.Vendor_Name AS VendorName,    
  ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')AS VendorAddress,    
  VAM.VendAdd_GstNo AS GstNo,    
  PIH.Pih_GrossValue AS GrossValue, 
  PIH.Pih_DiscAmt AS Discount,   
  PIH.Pih_NetValue AS TotalValue,    
  MM.Mm_HsnCode AS HsnCode,    
  MM.Mm_Code AS Code,    
  MM.Mm_Name AS Name,    
  UOMM.Uom_Name AS UomName,    
  PID.Pid_BatchNo AS BatchNo,    
  PID.Pid_MfgDt AS Mnf,    
  (CASE WHEN PID.Pid_ExpiryDt IS NULL THEN '' ELSE RIGHT(CONVERT(VARCHAR(10),PID.Pid_ExpiryDt, 105) , 7) END) AS Expiry,    
  PID.Pid_Qty AS Quantity,    
  PID.Pid_Rate AS Rate,    
  BB.SGST,    
     BB.CGST,    
     BB.IGST,    
  PID.Pid_Amount AS NetAmount,    
  (BB.SGST + BB.CGST +BB.IGST)AS TaxAmount,    
  PID.Pid_DiscAmount AS Discount,    
  PID.Pid_AmountTotal AS Amount,    
  MTM.Mtm_TypeName AS DrugType,    
  MGM.Mgm_Name AS DrugGroup,    
  MCM.Mcm_Name AS DrugCategory,    
  SM.Store_Name,    
  SM.Store_Address1,    
  SM.Store_GstNo,    
  SM.Store_Email,    
  POH.Po_No                                    
   FROM PurchaseInvoiceDetail(NOLOCK) PID    
     INNER JOIN PurchaseInvoiceHeader(NOLOCK) PIH    
  LEFT JOIN StoreMaster SM    
  ON SM.Store_Id=1     
  ON PIH.Pih_Key = PID.Pid_PihKey    
     LEFT JOIN PoHeader POH    
    ON  POH.Po_Key=PId.Pid_PoKey      
     INNER JOIN MedicineMaster(NOLOCK) MM    
  ON MM.Mm_ID = PID.Pid_MmId    
     LEFT JOIN UomMaster(NOLOCK) UOMM    
  ON UOMM.Uom_ID = PID.Pid_UomId    
     LEFT JOIN VendorMaster(NOLOCK) VM    
  ON PIH.Pih_VenId = VM.Vendor_ID    
     LEFT JOIN VendorAddMaster(NOLOCK) VAM    
  ON PIH.Pih_VenAddId = VAM.VendAdd_Id    
     LEFT JOIN BranchMaster(NOLOCK) BM    
  ON PIH.Pih_BmId = BM.Branch_Id    
     LEFT JOIN MedicineTypeMaster(NOLOCK) MTM    
  ON MTM.Mtm_ID = MM.Mm_MtmId    
     LEFT JOIN MedicineGroupMaster(NOLOCK) MGM    
  ON MGM.Mgm_ID = MM.Mm_MgmId    
     LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM    
  ON MCM.Mcm_ID = MM.Mm_McmId    
        LEFT JOIN (SELECT    
                       A.Pid_Key,    
                          ISNULL(SUM(A.SGST),0) AS SGST,    
                       ISNULL(SUM(A.CGST),0) AS CGST,    
                       ISNULL(SUM(A.IGST),0) AS IGST    
                 FROM  (SELECT A.Pid_Key,    
                            B.Tr_TxTot AS CGST,    
                            C.Tr_TxTot AS SGST,    
                            D.Tr_TxTot AS IGST    
           FROM PurchaseInvoiceDetail (NOLOCK) AS A    
                               LEFT JOIN TaxTransaction (NOLOCK) B    
                         ON A.Pid_Key = B.Tr_DdocKey    
                            AND A.Pid_PihKey = B.Tr_DocKey    
                            AND B.Tr_TxId = 2    
                            AND B.Tr_DocTyp = 4    
                               LEFT JOIN TaxTransaction (NOLOCK) C    
                         ON A.Pid_Key = C.Tr_DdocKey    
                            AND A.Pid_PihKey = C.Tr_DocKey    
                            AND C.Tr_DocTyp = 4    
                            AND C.Tr_TxId = 3    
                               LEFT JOIN TaxTransaction (NOLOCK) D    
                         ON A.Pid_Key = D.Tr_DdocKey    
                            AND A.Pid_PihKey = D.Tr_DocKey    
                            AND D.Tr_DocTyp = 4    
                            AND D.Tr_TxId = 4) AS A    
                               GROUP BY A.Pid_Key) AS BB    
                  ON PID.Pid_Key = BB.Pid_Key    
           
     WHERE PID.Pid_PihKey=@TypeId 
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_PurchaseOrderBill]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_REPORT_PurchaseOrderBill]
(
   @TypeId  INT=NULL,
   @FromDate DATETime=NULL,
   @ToDate DATETime=NULL,
   @TopRecord INT=NULL,
   @AccountId INT=NULL
)
AS
SELECT	ROW_NUMBER() OVER (ORDER BY PID.Pi_Key ASC)AS SrNo,
		POH.Po_No AS PoNo,
		CONVERT(varchar,POH.Po_Date,105) AS PoDate,
		POH.Po_RevNo AS RevNo,
		VM.Vendor_Name AS VendorName,
		ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')AS VendorAddress,
		VAM.VendAdd_GstNo AS GstNo,
		POH.Po_BasicVal AS BasicValue,
		POH.Po_TotVal AS TotalValue,
		(CASE
			WHEN (SELECT
			COUNT(*)
			FROM PurchaseInvoiceDetail PID
			WHERE PID.Pid_PoKey = POH.Po_key)
			> 0 THEN 'Done'
			ELSE 'Pending'
		END)AS InvoiceStatus,
		MM.Mm_HsnCode AS HsnCode,
		MM.Mm_Code AS Code,
		MM.Mm_Name AS Name,
		UOMM.Uom_Name AS UomName,
		PID.Pi_Qty AS Quantity,
		PID.Pi_Rate AS Rate,
		PID.Pi_Amt AS Amount,
		PID.Pi_Net_Amt AS NetAmount,
		MTM.Mtm_TypeName AS DrugType,
		MGM.Mgm_Name AS DrugGroup,
		MCM.Mcm_Name AS DrugCategory,
		BB.SGST,
	    BB.CGST,
	    BB.IGST,
		POH.Po_Remarks AS Remarks,
		POH.Po_PaymentTerms AS PaymentTerms,
		POH.Po_CreditDays AS CreditDays,
		Convert(varchar,POH.Po_DelDate,105) AS DeliveryDate,
		SM.Store_Name,
		SM.Store_Address1,
		SM.Store_GstNo,
		SM.Store_Email  																																
   FROM PoItemDetails(NOLOCK) PID
	    INNER JOIN PoHeader(NOLOCK) POH
		LEFT JOIN StoreMaster SM
		ON SM.Store_Id=1 
	 ON POH.Po_Key = PID.Pi_PoKey
	    INNER JOIN MedicineMaster(NOLOCK) MM
	 ON MM.Mm_ID = PID.Pi_ItemId
	    LEFT JOIN UomMaster(NOLOCK) UOMM
	 ON UOMM.Uom_ID = PID.Pi_Uom
	    LEFT JOIN VendorMaster(NOLOCK) VM
	 ON POH.Po_VenId = VM.Vendor_ID
	    LEFT JOIN VendorAddMaster(NOLOCK) VAM
	 ON POH.Po_VenAddId = VAM.VendAdd_Id
	    LEFT JOIN BranchMaster(NOLOCK) BM
	 ON POH.Po_BmId = BM.Branch_Id
	    LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
	 ON MTM.Mtm_ID = MM.Mm_MtmId
	    LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
	 ON MGM.Mgm_ID = MM.Mm_MgmId
	    LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
	 ON MCM.Mcm_ID = MM.Mm_McmId
        LEFT JOIN (SELECT
	                      A.Pi_Key,
	                   	     ISNULL(SUM(A.SGST),0) AS SGST,
	                      ISNULL(SUM(A.CGST),0) AS CGST,
	                      ISNULL(SUM(A.IGST),0) AS IGST
	                FROM  (SELECT A.Pi_Key,
	                	          B.Tr_TxTot AS CGST,
	                	          C.Tr_TxTot AS SGST,
	                	          D.Tr_TxTot AS IGST
						     FROM PoItemDetails (NOLOCK) AS A
	                              LEFT JOIN TaxTransaction (NOLOCK) B
	                	       ON A.Pi_Key = B.Tr_DdocKey
	                	          AND A.Pi_PoKey = B.Tr_DocKey
	                	          AND B.Tr_TxId = 2
	                	          AND B.Tr_DocTyp = 1
	                              LEFT JOIN TaxTransaction (NOLOCK) C
	                	       ON A.Pi_Key = C.Tr_DdocKey
	                	          AND A.Pi_PoKey = C.Tr_DocKey
	                	          AND C.Tr_DocTyp = 1
	                	          AND C.Tr_TxId = 3
	                              LEFT JOIN TaxTransaction (NOLOCK) D
	                	       ON A.Pi_Key = D.Tr_DdocKey
	                	          AND A.Pi_PoKey = D.Tr_DocKey
	                	          AND D.Tr_DocTyp = 1
	                	          AND D.Tr_TxId = 4) AS A
	                              GROUP BY A.Pi_Key) AS BB
	                 ON PID.Pi_Key = BB.Pi_Key
	      
     WHERE PID.Pi_PoKey=@TypeId 
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_PurchaseReturn]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[SP_REPORT_PurchaseReturn]
(
   @TypeId  INT=NULL,    
   @FromDate DATETime=NULL,    
   @ToDate DATETime=NULL,    
   @TopRecord INT=NULL,    
   @AccountId INT=NULL    
)
AS  
SELECT ROW_NUMBER() OVER (ORDER BY PRD.Prd_Id ASC)AS SrNo,    
  PRH.Prh_No AS PihNo,    
  CONVERT(varchar,PRH.Prh_Date,105) AS PIhDate,    
  PIH.Pih_RefNo AS BillNo,    
  CONVERT(varchar,PIH.Pih_RefDate,105) AS BillDate,    
  (CASE WHEN	VM.Vendor_Code like '%LS%' 
		THEN	VM.Vendor_Code+' & '+VM.Vendor_Name
		ELSE	VM.Vendor_Name
  END) AS VendorName,    
  ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')AS VendorAddress,    
  VAM.VendAdd_GstNo AS GstNo,    
  0 AS GrossValue,    
  PRH.Prh_TotalAmount AS TotalValue,    
  MM.Mm_HsnCode AS HsnCode,    
  MM.Mm_Code AS Code,    
  MM.Mm_Name AS Name,    
  UOMM.Uom_Name AS UomName,    
  PRD.Prd_BatchNo AS BatchNo,    
  PID.Pid_MfgDt AS Mnf,    
  (CASE WHEN PID.Pid_ExpiryDt IS NULL THEN '' ELSE RIGHT(CONVERT(VARCHAR(10),PID.Pid_ExpiryDt, 105) , 7) END) AS Expiry,    
  PRD.Prd_Qty AS Quantity,    
  PRD.Prd_Rate AS Rate,    
  BB.SGST,    
     BB.CGST,    
     BB.IGST,    
  0 AS NetAmount,    
  (BB.SGST + BB.CGST +BB.IGST)AS TaxAmount,    
  0 AS Discount,    
  PRD.Prd_Amount AS Amount,    
  MTM.Mtm_TypeName AS DrugType,    
  MGM.Mgm_Name AS DrugGroup,    
  MCM.Mcm_Name AS DrugCategory,    
  SM.Store_Code+' & '+ SM.Store_Name AS Store_Name,    
  SM.Store_Address1,    
  SM.Store_GstNo,    
  SM.Store_Email,    
  0 AS Po_No                                    
   FROM PurchaseReturnDetail(NOLOCK) PRD
        INNER JOIN PurchaseReturnHeader(NOLOCK) PRH
     ON PRH.Prh_Id=PRD.Prd_PrhId
        LEFT JOIN PurchaseInvoiceDetail(NOLOCK) PID 
     ON PID.Pid_SrNo=PRD.Prd_PidSrNo
        AND PID.Pid_PihKey=PRD.Prd_PihKey  
        LEFT JOIN PurchaseInvoiceHeader(NOLOCK) PIH
     ON PIH.Pih_Key=PID.Pid_PihKey     
        LEFT JOIN StoreMaster SM    
     ON SM.Store_Id=1    
        INNER JOIN MedicineMaster(NOLOCK) MM    
     ON MM.Mm_ID = PRD.Prd_MmId    
        LEFT JOIN UomMaster(NOLOCK) UOMM    
     ON UOMM.Uom_ID = PID.Pid_UomId    
        LEFT JOIN VendorMaster(NOLOCK) VM    
     ON PIH.Pih_VenId = VM.Vendor_ID    
        LEFT JOIN VendorAddMaster(NOLOCK) VAM    
     ON PIH.Pih_VenAddId = VAM.VendAdd_Id    
          
        LEFT JOIN MedicineTypeMaster(NOLOCK) MTM    
     ON MTM.Mtm_ID = MM.Mm_MtmId    
        LEFT JOIN MedicineGroupMaster(NOLOCK) MGM    
     ON MGM.Mgm_ID = MM.Mm_MgmId    
        LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM    
     ON MCM.Mcm_ID = MM.Mm_McmId    
        LEFT JOIN (SELECT A.Prd_Id,    
                          ISNULL(SUM(A.SGST),0) AS SGST,    
                          ISNULL(SUM(A.CGST),0) AS CGST,    
                          ISNULL(SUM(A.IGST),0) AS IGST    
                     FROM (SELECT A.Prd_Id,    
                                  B.Tr_TxTot AS CGST,    
                                  C.Tr_TxTot AS SGST,    
                                  D.Tr_TxTot AS IGST    
                             FROM PurchaseReturnDetail (NOLOCK) AS A    
                                  LEFT JOIN TaxTransaction (NOLOCK) B    
                               ON A.Prd_Id = B.Tr_DdocKey    
                            AND A.Prd_PrhId = B.Tr_DocKey    
                            AND B.Tr_TxId = 2    
                            AND B.Tr_DocTyp = 5    
                               LEFT JOIN TaxTransaction (NOLOCK) C    
                         ON A.Prd_Id = C.Tr_DdocKey    
                            AND A.Prd_PrhId = C.Tr_DocKey    
                            AND C.Tr_DocTyp = 5    
                            AND C.Tr_TxId = 3    
                               LEFT JOIN TaxTransaction (NOLOCK) D    
                         ON A.Prd_Id = D.Tr_DdocKey    
                            AND A.Prd_PrhId = D.Tr_DocKey    
                            AND D.Tr_DocTyp = 5    
                            AND D.Tr_TxId = 4) AS A    
                               GROUP BY A.Prd_Id) AS BB    
                  ON PRD.Prd_Id = BB.Prd_Id    
           
     WHERE Prd.Prd_PrhId=@TypeId 
GO
/****** Object:  StoredProcedure [dbo].[SP_RESOLVE_BATCH_CONFLICT]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--489	Resolve Batch Conflict	frmResolveConflictBatch	46	Y	NULL	3	E	Expired Medicine Stock.png	NULL	NULL	NULL	NULL	NULL	NULL	True	True

CREATE PROC [dbo].[SP_RESOLVE_BATCH_CONFLICT]
@SP_STATUS	VARCHAR(199)='',
@Stk_MmId	numeric(18,0),
@Stk_BatchNo	VARCHAR(199)='',
@Stk_MnfDate	DATETIME,
@Stk_ExpDate	DATETIME

AS
BEGiN
	iF @SP_STATUS='GET_CONFLICT_LIST'
		BEGiN
			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_DATA1' AND type='U')
				BEGiN
					DROP TABLE ##TEMP_DATA1
				END

			iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_DATA2' AND type='U')
				BEGiN
					DROP TABLE ##TEMP_DATA2
				END
			SELECT	DISTINCT
					A.Stk_MmId,
					A.Stk_BatchNo,
					A.Stk_MnfDate,
					A.Stk_ExpDate
					--COUNT(B.Mm_Code) AS CNT
			iNTO	##TEMP_DATA1 
			FROM	StockRegister A


			SELECT	Stk_MmId,
					Stk_BatchNo,
					COUNT(Stk_BatchNo) AS CNT
			iNTO	##TEMP_DATA2
			FROM	##TEMP_DATA1 A
		
			GROUP BY Stk_MmId,Stk_BatchNo
			HAVING COUNT(Stk_BatchNo)>1
			--ORDER BY Stk_MmId,Stk_BatchNo


			SELECT	CONVERT(BIT,0) AS CHK,
					Stk_MmId,
					B.Mm_Code,
					B.Mm_Name,
					Stk_BatchNo,
					A.Stk_MnfDate,
					A.Stk_ExpDate
			FROM	##TEMP_DATA1 A
					iNNER JOIN MedicineMaster B
			ON			A.Stk_MmId=B.Mm_ID
			WHERE	CONVERT(VARCHAR(10),A.Stk_MmId)+A.Stk_BatchNo IN(SELECT CONVERT(VARCHAR(10),X.Stk_MmId)+X.Stk_BatchNo FROM ##TEMP_DATA2 X)
		END

	ELSE iF @SP_STATUS='UPDATE_BATCH_DATE'
		BEGiN
			UPDATE	StockRegister 
			SET		Stk_ExpDate=@Stk_ExpDate,
					Stk_MnfDate=@Stk_MnfDate 
			WHERE		Stk_MmId=@Stk_MmId 
					AND Stk_BatchNo=@Stk_BatchNo

			UPDATE	SalesInvoiceItemDetail 
			SET		Sid_ExpDate=@Stk_ExpDate,Sid_MnfDate=@Stk_MnfDate 
			WHERE		Sid_Mm_Id=@Stk_MmId 
					AND Sid_BatchNo=@Stk_BatchNo

			UPDATE	PurchaseInvoiceDetail 
			SET		Pid_ExpiryDt=@Stk_ExpDate,Pid_MfgDt=@Stk_MnfDate 
			WHERE		Pid_MmId=@Stk_MmId 
					AND Pid_BatchNo=@Stk_BatchNo
		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_BAL_SHEET]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[SP_RPT_BAL_SHEET]
@AS_ON_DATE DATETIME='2018-12-31'
AS
BEGIN
		--DECLARE @AS_ON_DATE DATETIME='2018-12-31'

		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_BAL_GROUP')
			BEGiN
				DROP TABLE ##TEMP_BAL_GROUP
			END

			
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_BAL_LEDGER_1')
			BEGiN
				DROP TABLE ##TEMP_BAL_LEDGER_1
			END

		;WITH CTE
		AS(
			SELECT	Lgm_Id,
					Lgm_Name,
					Lgm_Description,
					0 AS LVL,
					CONVERT(VARCHAR(MAX),Lgm_Name) AS L_GROUP,
					A.Lgm_Id AS L_TYPE,
					A.Lgm_ParentId
			FROM	LedgerGroupMaster A
			WHERE	A.Lgm_ParentId=3
			UNiON ALL
			SELECT	A.Lgm_Id,
					A.Lgm_Name,
					A.Lgm_Description,
					LVL=LVL+1,
					CONVERT(VARCHAR(MAX),L_GROUP+' --> '+A.Lgm_Name) AS L_GROUP,
					B.L_TYPE,
					A.Lgm_ParentId
			FROM	LedgerGroupMaster A
					iNNER JOIN CTE B
			ON			A.Lgm_ParentId=B.Lgm_Id
		)
		SELECT	*
		iNTO	##TEMP_BAL_GROUP
		FROM	CTE

		SELECT	CASE WHEN A.L_TYPE IN (8) THEN 'L' ELSE 'R' END AS  G_TYPE,
				A.Lgm_Id AS Child_Group_Id,
				A.Lgm_Name AS Child_Group_Name,
				B.Lm_Name,
				SUM(CASE WHEN C.Act_DrCr='DR' THEN C.Act_Amount ELSE 0 END) DEBIT,
				SUM(CASE WHEN C.Act_DrCr='CR' THEN C.Act_Amount ELSE 0 END) CREDIT
				--SUM (	CASE	WHEN C.Act_DrCr='DR' 
				--				THEN C.Act_Amount +
				--						--CASE WHEN B.Lm_OpeningDrCr='DR' AND CAST(B.Lm_OpeningDate AS DATE)<@AS_ON_DATE THEN ISNULL(B.Lm_OpeningBalance,0) ELSE 0 END
				--						CASE WHEN B.Lm_OpeningDrCr='DR' THEN ISNULL(B.Lm_OpeningBalance,0) ELSE 0 END
				--		ELSE	0 END-

				--		CASE	WHEN C.Act_DrCr='CR' 
				--				THEN C.Act_Amount +
				--						--CASE WHEN B.Lm_OpeningDrCr='CR' AND CAST(B.Lm_OpeningDate AS DATE)<@AS_ON_DATE THEN ISNULL(B.Lm_OpeningBalance,0) ELSE 0 END
				--						CASE WHEN B.Lm_OpeningDrCr='CR' THEN ISNULL(B.Lm_OpeningBalance,0) ELSE 0 END
				--		ELSE	0 END
				--	) AS Amount
		iNTO	##TEMP_BAL_LEDGER_1
		FROM	##TEMP_BAL_GROUP A
				LEFT JOIN  LedgerMaster B
		ON			A.Lgm_Id=B.Lm_GroupId
				LEFT JOIN   AccountTransaction C
		ON			B.Lm_Id=C.Act_LedgerId
		WHERE	--D.Lgm_ParentId IN(3)
				--AND 
				CAST(C.Act_Date AS DATE)<@AS_ON_DATE
		GROUP BY A.L_TYPE,A.Lgm_Id,A.Lgm_Name,B.Lm_Name
		UNION ALL
		SELECT	CASE WHEN A.L_TYPE IN (8) THEN 'L' ELSE 'R' END AS  G_TYPE,
				A.Lgm_Id AS Child_Group_Id,
				A.Lgm_Name AS Child_Group_Name,
				B.Lm_Name,
				CASE WHEN B.Lm_OpeningDrCr='DR' THEN B.Lm_OpeningBalance ELSE 0 END AS DEBIT,
				CASE WHEN B.Lm_OpeningDrCr='CR' THEN B.Lm_OpeningBalance ELSE 0 END AS CREDIT
		FROM	##TEMP_BAL_GROUP A
				LEFT JOIN  LedgerMaster B
		ON			A.Lgm_Id=B.Lm_GroupId
		--ORDER BY A.L_TYPE
		SELECT	G_TYPE,
				Child_Group_Id,
				Child_Group_Name,
				Lm_Name,
				SUM(DEBIT) AS DEBIT,
				SUM(CREDIT) AS CREDIT,
				SUM(ISNULL(DEBIT,0))-SUM(ISNULL(CREDIT,0)) AS Amount
		FROM	##TEMP_BAL_LEDGER_1
		GROUP BY G_TYPE,Child_Group_Id,Child_Group_Name,Lm_Name
		ORDER BY G_TYPE





		--SELECT	CASE WHEN D.Lgm_Id IN (8) THEN 'L' ELSE 'R' END AS  G_TYPE,
		--		D.Lgm_Id AS Main_Group_id,
		--		D.Lgm_Name AS Main_Group_Name,
		--		A.Lgm_Id AS Child_Group_Id,
		--		A.Lgm_Name AS Child_Group_Name,
		--		B.Lm_Name,
		--		SUM (	CASE WHEN C.Act_DrCr='DR' THEN C.Act_Amount ELSE 0 END-
		--				CASE WHEN C.Act_DrCr='CR' THEN C.Act_Amount ELSE 0 END
		--			) AS Amount
		--FROM	LedgerGroupMaster A
		--		LEFT JOIN  LedgerMaster B
		--ON			A.Lgm_Id=B.Lm_GroupId
		--		LEFT JOIN   AccountTransaction C
		--ON			B.Lm_Id=C.Act_LedgerId
		--		iNNER JOIN LedgerGroupMaster D
		--ON			A.Lgm_ParentId=D.Lgm_Id
		--WHERE	--D.Lgm_ParentId IN(3)
		--		--AND 
		--		CAST(C.Act_Date AS DATE)<@AS_ON_DATE
		--GROUP BY D.Lgm_Id,D.Lgm_Name,A.Lgm_Id,A.Lgm_Name,B.Lm_Name
		--ORDER BY Main_Group_Name
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_BatchWiseStockRegister]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Hasmukh
-- Create date: 05-03-2018
-- Description:	Batch Wise Stock List
-- =============================================
CREATE PROCEDURE [dbo].[SP_RPT_BatchWiseStockRegister]
AS
BEGIN
	SELECT	VWSB.Mm_Code		AS DrugCode,
				MGM.Mgm_Name		AS GroupName,
				MCM.Mcm_Name		AS CategoryName,
				VWSB.Mm_Name		AS DrugName,
				VWSB.Uom_Name		AS UOMName,
				VWSB.Stk_BatchNo	AS BatchNo,
				VWSB.Stk_ExpDate	AS ExpiryDate,
				VWSB.QTY				AS Quantity,
				VWSB.STK_RATE		AS Rate,
				VWSB.Stk_Mrp		AS MRP
	FROM vwStockBatchWise(NOLOCK) VWSB
	INNER JOIN MedicineMaster(NOLOCK) MM
	ON MM.Mm_ID = VWSB.Stk_MmId
	INNER JOIN MedicineCategoryMaster(NOLOCK) MCM
	ON MCM.Mcm_ID = MM.Mm_McmId
	INNER JOIN MedicineGroupMaster(NOLOCK) MGM
	ON MGM.Mgm_ID = MM.Mm_MgmId
	WHERE ISNULL(QTY,0) > 0
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_CashTransactionDetailsReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Hasmukh
-- Create date: 03-04-2018
-- Description:	
-- =============================================
--Exec [SP_RPT_CashTransactionDetailsReport] @FromDate='2018-03-16',@ToDate='2018-04-17',@TypeId=9,@AccountId=37
CREATE PROCEDURE [dbo].[SP_RPT_CashTransactionDetailsReport] @FromDate date = NULL,
@ToDate date = NULL,
@TypeId int = NULL,
@AccountId int = 0,
@TopRecord int = NULL
AS
BEGIN
	IF EXISTS (SELECT TOP 1
	*
	FROM BranchMaster)
	BEGIN
	SELECT	B.Lm_Name,
				CONVERT(varchar,A.Act_Date,105)																										AS Date,
				A.Act_VoucherNo																															AS VoucherNo,
				(CASE
					WHEN A.Act_DocNo = 0 THEN ''
					ELSE 'Bill No :' + CAST(A.Act_DocNo AS varchar(30))
				END)																																			AS BillNo,
				(CASE
					WHEN ATR.Acr_BookId = 3 THEN D.Pm_Fullname
					ELSE B.Lm_Name
				END)																																			AS Name,
				A.Act_DrCr																																	AS DRCR,
				A.Act_Amount																																AS Amount,
				CASE
					WHEN A.Act_DrCr = 'Cr' THEN A.Act_Amount
					ELSE 0
				END																																			Credit,
				CASE
					WHEN A.Act_DrCr = 'Dr' THEN A.Act_Amount
					ELSE 0
				END																																			Debit,
				BM.Branch_Name,
				(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,''))	AS Branch_Address,
				BM.Branch_GstNo,
				A.Act_ChequeNo,
				CONVERT(varchar,A.Act_ChequeDate,105)																								AS Act_ChequeDate,
				A.Act_BankName
	FROM AccountTransaction(NOLOCK) A
	LEFT JOIN BranchMaster(NOLOCK) BM
		ON Bm.Branch_Id = 1
	LEFT JOIN LedgerMaster(NOLOCK) B
		ON A.Act_LedgerId = B.Lm_Id
	LEFT JOIN SalesInvoiceHeader(NOLOCK) C
		ON A.Act_DocKey = C.Sih_Key
	LEFT JOIN SalesReturnHeader(NOLOCK) SR
		ON A.Act_DocKey = SR.Srh_No
	LEFT JOIN PatientMaster(NOLOCK) D
		ON C.Sih_Pm_Id = D.Pm_Id
		OR C.Sih_Pm_Id = SR.Srh_CustId
	LEFT JOIN PurchaseInvoiceHeader(NOLOCK) PIH
		ON PIH.Pih_Key = A.Act_DocKey
	LEFT JOIN VendorMaster(NOLOCK) VM
		ON VM.Vendor_ID = PIH.Pih_VenId
	LEFT JOIN AccountTransactionRef ATR
		ON ATR.Acr_ActKey = A.Act_Key
	WHERE Act_DocType IN (@TypeId)
	AND CONVERT(date,A.Act_Date) BETWEEN CONVERT(date,@FromDate) AND CONVERT(date,@ToDate)
	AND A.Act_DrCr IN (CASE
		WHEN @TypeId IN (10,8) THEN 'Cr'
		ELSE 'Dr'
	END)
	AND B.Lm_Id = @AccountId
	ORDER BY CONVERT(DATE,A.Act_Date,105),A.Act_VoucherNo
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_CashTransactionSummaryReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- Author:  Hasmukh  
-- Create date: 03-04-2018  
-- Description: Get All Date List From Date To To Date  
--Get First And Last Date Of Month According To Filter  
--Get Cash Transaction List From Date To Date  
-- =============================================  
--Exec SP_RPT_CashTransactionSummaryReport @FromDate='2018-03-04',@ToDate='2018-03-04',@TypeId=9  
CREATE PROCEDURE [dbo].[SP_RPT_CashTransactionSummaryReport] @FromDate date = NULL,
@ToDate date = NULL,
@TypeId int = NULL,
@AccountId int = 0,
@TopRecord int = NULL
AS
BEGIN
	DECLARE @i int
	DECLARE @count int
	DECLARE @DATEYEARMONTH TABLE (
	Id int IDENTITY (1,1),
	Months int,
	Years int
	)
	DECLARE @DateList TABLE (
	Dates date
	)
	DECLARE @FirstDate date
	DECLARE @LastDate date
	DECLARE @Months int
	DECLARE @Years int
	DECLARE @MonthsName varchar(50)
	DECLARE @CurrentDate datetime
	SET @CurrentDate = @FromDate
	WHILE @CurrentDate <= @ToDate
	BEGIN
	INSERT INTO @DateList(Dates) VALUES
	(@CurrentDate)
	SET @CurrentDate = DATEADD(D,1,@CurrentDate)
	END
	INSERT INTO @DATEYEARMONTH(Months,Years)
	SELECT DISTINCT	MONTH(Dates)	AS Months,
							YEAR(Dates)		AS Years
	FROM @DateList
	DECLARE @FormatDate TABLE (
	Months int,
	MonthsName varchar(50),
	Years int,
	FirstDate date,
	LastDate date
	)
	SET @count = (SELECT
	COUNT(*)
	FROM @DATEYEARMONTH);
	IF (@count > 0)
	BEGIN
	SET @i = 1;
	WHILE (@i <= @count)
	BEGIN
		SELECT	@Months = Months,
					@Years = Years
		FROM @DATEYEARMONTH
		WHERE Id = @i;
		SET @FirstDate = (SELECT TOP 1
		Dates
		FROM @DateList
		WHERE MONTH(Dates) = @Months
		AND YEAR(Dates) = @Years
		ORDER BY Dates ASC);
		SET @LastDate = (SELECT TOP 1
		Dates
		FROM @DateList
		WHERE MONTH(Dates) = @Months
		AND YEAR(Dates) = @Years
		ORDER BY Dates DESC);
		SET @MonthsName = (SELECT TOP 1
		DATENAME(MONTH,Dates)
		FROM @DateList
		WHERE MONTH(Dates) = @Months
		AND YEAR(Dates) = @Years
		ORDER BY Dates ASC);
		INSERT INTO @FormatDate(Months,MonthsName,Years,FirstDate,LastDate)
		SELECT	@Months,
					@MonthsName,
					@Years,
					@FirstDate,
					@LastDate
		SET @i = @i + 1;
	END
	END
	SELECT	DATESTABLE.Months,
				DATESTABLE.YEARS,
				DATESTABLE.MonthsName																													AS MONTHSName,
				((CAST(DAY(DATESTABLE.FirstDate) AS varchar(2))) + '-' + (CAST(DAY(DATESTABLE.LastDate) AS varchar(2))))		AS DateS,
				ISNULL((CASE
					WHEN @TypeId IN (8,10) THEN SUM(Debit)
					ELSE SUM(Credit)
				END),0)																																		AS Amount,
				BM.Branch_Name,
				(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,''))	AS Branch_Address,
				BM.Branch_GstNo
	FROM @FormatDate DATESTABLE
	LEFT JOIN BranchMaster BM
	ON Bm.Branch_Id = 1
	LEFT JOIN (SELECT
	B.Lm_Name,
	A.Act_Date,
	MONTH(A.Act_Date) AS MONTHS,
	YEAR(A.Act_Date) AS YEARS,
	A.Act_VoucherNo,
	A.Act_DocNo AS BILL_NO,
	D.Pm_Fullname,
	A.Act_DrCr,
	A.Act_Amount,
	CASE
		WHEN A.Act_DrCr = 'Cr' THEN A.Act_Amount
		ELSE 0
	END Credit,
	CASE
		WHEN A.Act_DrCr = 'Dr' THEN A.Act_Amount
		ELSE 0
	END Debit
	FROM AccountTransaction A
	INNER JOIN LedgerMaster B
	ON A.Act_LedgerId = B.Lm_Id
	LEFT JOIN SalesInvoiceHeader C
	ON A.Act_DocKey = C.Sih_Key
	LEFT JOIN PatientMaster D
	ON C.Sih_Pm_Id = D.Pm_Id
	WHERE Act_DocType IN (@TypeId)
	AND B.Lm_Id = @AccountId
	AND CONVERT(date,A.Act_Date,105) BETWEEN CONVERT(date,@FromDate,105) AND CONVERT(date,@ToDate,105)) DT
	ON DATESTABLE.Months = DT.MONTHS
	AND DATESTABLE.Years = DT.YEARS GROUP BY DATESTABLE.Years,DATESTABLE.Months,DATESTABLE.MonthsName,DATESTABLE.FirstDate,DATESTABLE.LastDate,BM.Branch_Name,BM.Branch_Address1,BM.Branch_Address2,BM.Branch_Address3,BM.Branch_GstNo
	ORDER BY DATESTABLE.Years,DATESTABLE.Months


END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_DoctorWiseSalesReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Hasmukh
-- Create date: 18-03-2018
-- Description:	
-- =============================================
CREATE PROCEDURE [dbo].[SP_RPT_DoctorWiseSalesReport] 
@FROMDATE datetime,
@TODATE datetime
AS
BEGIN
	SELECT	DM.Dm_Name	AS DoctorName,
			MM.Mm_Code	AS DrugCode,
			MM.Mm_Name	AS DrugName,
			UOMM.Uom_Name			AS UOM,
			SUM(SIID.Sid_SalesQty)	AS	QTY,
			SUM(SIID.Sid_SubTotal)	AS	SubTotal,
			SUM(SIID.Sid_Total)		AS	Total
	FROM	SalesInvoiceHeader(NOLOCK) SIH
			INNER JOIN	SalesInvoiceItemDetail(NOLOCK) SIID
	ON		SIID.Sid_Sih_Key = SIH.Sih_Key
			INNER JOIN UomMaster(NOLOCK) UOMM
	ON		UOMM.Uom_ID = SIID.Sid_SalesUomId
			INNER JOIN MedicineMaster(NOLOCK) MM
	ON		MM.Mm_ID = SIID.Sid_Mm_Id
			INNER JOIN DoctorMaster(NOLOCK) DM
	ON		DM.Dm_Id = SIH.Sih_Dm_Id
	WHERE	CAST(SIH.Sih_Date AS DATE) BETWEEN CAST(@FROMDATE AS DATE) AND CAST(@TODATE AS DATE) 
			GROUP BY DM.Dm_Name,
					MM.Mm_Code,
					MM.Mm_Name,
					UOMM.Uom_Name
			ORDER BY DM.Dm_Name ASC
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_FAST_MOVING_ITEM]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[SP_RPT_FAST_MOVING_ITEM] @FROMDATE datetime = NULL,
@TODATE datetime = NULL,
@TYPEID int = NULL,
@TopRecord int = NULL,
@AccountId int = NULL
AS
BEGIN
	IF (@TYPEID != 0)
	BEGIN
	IF (@TopRecord > 0)
		BEGIN
		SELECT TOP (@TopRecord) *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name
		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id

		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0

		WHERE MTM.Mtm_ID = @TYPEID) AS DT
		WHERE SALES_QTY > 0
		ORDER BY SALES_QTY DESC
		END
	ELSE BEGIN
		SELECT *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name
		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0

			INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0
		WHERE MTM.Mtm_ID = @TYPEID) AS DT
		WHERE SALES_QTY > 0
		ORDER BY SALES_QTY DESC
		END
	END
	ELSE BEGIN
	IF (@TopRecord > 0)
		BEGIN
		SELECT TOP (@TopRecord) *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name
		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0

		) AS DT
		WHERE SALES_QTY > 0
		ORDER BY SALES_QTY DESC
		END
	ELSE BEGIN
		SELECT *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name
		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0

		) AS DT
		WHERE SALES_QTY > 0
		ORDER BY SALES_QTY DESC
		END
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_LocationWiseStock]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================  
-- Author:  Hasmukh  
-- Create date: 24-03-2018  
-- Description:   
-- =============================================  
--Exec SP_RPT_LocationWiseStock @MedicineTypeId=0,@LocationId=0

CREATE PROCEDURE [dbo].[SP_RPT_LocationWiseStock] @MedicineTypeId int,
@LocationId int
AS
BEGIN
	DECLARE @SQL varchar(max)
	SET @SQL = 'SELECT MTM.Mtm_TypeName AS DRUGTYPE,  
                      MGM.Mgm_Name AS DRUGGROUP,  
                      MCM.Mcm_Name AS DRUGCATEGORY,  
                      MM.Mm_Code AS DRUGCODE,  
                      MM.Mm_Name AS DRUGNAME,  
                      LM.Lm_Name AS LOCATIONNAME,  
                      STOCK.BATCHNO,  
                      STOCK.PURCHASEUNITWISEQTY,  
                      STOCK.PURCHASERATE,  
                      STOCK.SALESUNITWISEQTY,  
                      STOCK.SALESRATE,  
            STOCK.PURCHASEUOM,  
            STOCK.SALESUOM  
       FROM LocationMaster  (NOLOCK) LM  
            LEFT JOIN (SELECT *   
                         FROM (SELECT (SUM(CASE WHEN SR.Stk_Tran_Typ=''C'' THEN SR.Stk_PurchaseQty ELSE 0 END)-  
                                   SUM(CASE WHEN SR.Stk_Tran_Typ=''D'' THEN SR.Stk_PurchaseQty ELSE 0 END))AS PURCHASEUNITWISEQTY,  
                                    PUOM.Uom_Name AS PURCHASEUOM,  
                                    SR.Stk_PurchaseRate AS PURCHASERATE,  
                                   (SUM(CASE WHEN SR.Stk_Tran_Typ=''C'' THEN SR.Stk_SalesQty ELSE 0 END)-  
                                   SUM(CASE WHEN SR.Stk_Tran_Typ=''D'' THEN SR.Stk_SalesQty ELSE 0 END))AS SALESUNITWISEQTY,  
                                    SUOM.Uom_Name AS SALESUOM,  
                                    SR.Stk_SalesRate AS SALESRATE,  
                                    SR.Stk_LmId,  
                                    SR.Stk_MmId,  
                                    SR.Stk_BatchNo AS BATCHNO  
                               FROM StockRegister  (NOLOCK) SR  
                                    INNER JOIN UomMaster (NOLOCK)  PUOM   
                                 ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                                    INNER JOIN UomMaster  (NOLOCK) SUOM   
                                 ON SUOM.Uom_ID=SR.Stk_PurchaseUom  
                                    GROUP BY SR.Stk_MmId,SR.Stk_BatchNo,SR.Stk_LmId,PUOM.Uom_Name,SUOM.Uom_Name,SR.Stk_PurchaseRate,SR.Stk_SalesRate)AS DT  
                                    WHERE DT.PURCHASEUNITWISEQTY>0)AS STOCK  
      ON LM.Lm_Id=STOCK.Stk_LmId  
         LEFT JOIN MedicineMaster MM   
      ON MM.Mm_ID=STOCK.Stk_MmId  
         LEFT JOIN MedicineTypeMaster MTM  
      ON MTM.Mtm_ID=MM.Mm_MtmId  
         LEFT JOIN MedicineCategoryMaster MCM  
      ON MCM.Mcm_ID=MM.Mm_McmId  
         LEFT JOIN MedicineGroupMaster MGM  
      ON MGM.Mgm_ID=MM.Mm_McmId ';
	IF (@MedicineTypeId > 0
	OR @LocationId > 0)
	BEGIN
	SET @SQL = @SQL + 'WHERE ';
	IF (@MedicineTypeId > 0)
		BEGIN
		SET @SQL = @SQL + 'MM.Mm_MtmId=' + @MedicineTypeId;
		IF (@LocationId > 0)
		BEGIN
			SET @SQL = @SQL + 'AND LM.Lm_Id=' + @LocationId;
		END
		END
	ELSE BEGIN
		SET @SQL = @SQL + 'LM.Lm_Id=' + @LocationId;
		END
	END
	EXEC (@SQL);
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_NON_MOVING_ITEM]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--Exec SP_RPT_NON_MOVING_ITEM @FROMDATE='2017-10-15',@TODATE='2018-04-13',@TYPEID=0  
CREATE PROC [dbo].[SP_RPT_NON_MOVING_ITEM] @FROMDATE datetime = NULL,
@TODATE datetime = NULL,
@TYPEID int = NULL,
@TopRecord int = NULL,
@AccountId int = NULL
AS
BEGIN
	IF (@TYPEID != 0)
	BEGIN
	IF (@TopRecord > 0)
		BEGIN
		SELECT TOP (@TopRecord) *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name,
		(CASE
			WHEN (SELECT TOP 1
			Stk_date
			FROM StockRegister(NOLOCK)
			WHERE StockRegister.Stk_MmId = A.Mm_ID
			AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105))
			IS NULL THEN ''
			ELSE CONVERT(varchar,(SELECT TOP 1
			Stk_date
			FROM StockRegister(NOLOCK)
			WHERE StockRegister.Stk_MmId = A.Mm_ID
			AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)),105)
		END) AS Stk_date
		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0

		WHERE MTM.Mtm_ID = @TYPEID) AS DT
		WHERE SALES_QTY = 0
		ORDER BY Stk_date ASC
		END
	ELSE BEGIN
		SELECT *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name,
		(CASE
			WHEN (SELECT TOP 1
			Stk_date
			FROM StockRegister(NOLOCK)
			WHERE StockRegister.Stk_MmId = A.Mm_ID
			AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105))
			IS NULL THEN ''
			ELSE CONVERT(varchar,(SELECT TOP 1
			Stk_date
			FROM StockRegister(NOLOCK)
			WHERE StockRegister.Stk_MmId = A.Mm_ID
			AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)),105)
		END) AS Stk_date

		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0


		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0

		WHERE MTM.Mtm_ID = @TYPEID) AS DT
		WHERE SALES_QTY = 0
		ORDER BY Stk_date ASC
		END
	END
	ELSE BEGIN
	IF (@TopRecord > 0)
		BEGIN
		SELECT TOP (@TopRecord) *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name,
		(SELECT TOP 1
			Stk_date
		FROM StockRegister
		WHERE StockRegister.Stk_MmId = A.Mm_ID
		AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105))
		AS Stk_date

		FROM MedicineMaster A (NOLOCK)
		LEFT JOIN UOMMaster UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0
		) AS DT
		WHERE SALES_QTY = 0
		ORDER BY Stk_date ASC
		END
	ELSE BEGIN
		SELECT *
		FROM (SELECT
		A.Mm_ID,
		A.Mm_HsnCode AS HSNCode,
		A.Mm_Code AS DrugCode,
		A.Mm_Name AS DrugName,
		MTM.Mtm_TypeName AS DrugType,
		MCM.Mcm_Name AS DrugCategory,
		MGM.Mgm_Name AS DrugGroup,
		ISNULL(B.SALES_QTY,0) AS SALES_QTY,
		ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,
		BM.Branch_Name,
		(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,
		BM.Branch_GstNo,
		UOMM.Uom_Name,
		(SELECT TOP 1
			Stk_date
		FROM StockRegister
		WHERE StockRegister.Stk_MmId = A.Mm_ID
		AND CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105))
		AS Stk_date

		FROM MedicineMaster(NOLOCK) A
		LEFT JOIN UOMMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = A.Mm_StkUom
		LEFT JOIN BranchMaster(NOLOCK) BM
		ON Branch_Id = 1
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = A.Mm_MtmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = A.Mm_McmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = A.Mm_MgmId
		LEFT JOIN (SELECT
		ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,
		SUM(X.Sid_SalesQty) AS SALES_QTY
		FROM SalesInvoiceItemDetail(NOLOCK) X
		INNER JOIN SalesInvoiceHeader(NOLOCK) Y
		ON X.Sid_Sih_Key = Y.Sih_Key
		AND CONVERT(date,Y.Sih_Date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		GROUP BY ISNULL(X.Sid_Mm_Id,0)) B
		ON A.Mm_ID = B.Sid_Mm_Id
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'C'
		GROUP BY Stk_MmId) C
		ON A.Mm_ID = C.Stk_MmId
		AND C.Stock > 0
		
		INNER JOIN (SELECT
		Stk_MmId,
		ISNULL(SUM(stk_SalesQty),0) AS Stock
		FROM StockRegister(NOLOCK)
		WHERE CONVERT(date,Stk_date,105) BETWEEN CONVERT(date,@FROMDATE,105) AND CONVERT(date,@TODATE,105)
		AND Stk_Tran_Typ = 'D'
		GROUP BY Stk_MmId) D
		ON A.Mm_ID = D.Stk_MmId
		AND D.Stock > 0
		) AS DT
		WHERE SALES_QTY = 0
		ORDER BY Stk_date ASC
		END
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_ProductWiseSalesReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		HASMUKH
-- Create date: 17-03-2018
-- Description:	Product Wise Sales List
-- =============================================
CREATE PROCEDURE [dbo].[SP_RPT_ProductWiseSalesReport] 
	@FROMDATE	datetime=null	,
	@TODATE		datetime=null	,
	@Mm_ID		NUMERIC(18,0)=0
AS
BEGIN
	SELECT	SIH.Sih_No	AS	InvoiceNo,
			CONVERT(varchar,SIH.Sih_Date,105)	AS DATE,
			PM.Pm_FullName	AS	PatientName,
			MM.Mm_Code	AS	DrugCode,
			MM.Mm_Name	AS	DrugName,
			UOMM.Uom_Name	AS	UOMName,
			SIID.Sid_BatchNo	AS	BatchNo,
			SIID.Sid_SalesQty	AS	QTY,
			SIID.Sid_SalesRate	AS	Rate,
			SIID.Sid_SubTotal	AS	SubTotal,
			SIID.Sid_Total	AS	Total
	FROM	SalesInvoiceHeader(NOLOCK) SIH
			INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID
	ON		SIID.Sid_Sih_Key = SIH.Sih_Key
			INNER JOIN UomMaster(NOLOCK) UOMM
	ON		UOMM.Uom_ID = SIID.Sid_SalesUomId
			INNER JOIN MedicineMaster(NOLOCK) MM
	ON		MM.Mm_ID = SIID.Sid_Mm_Id
			INNER JOIN PatientMaster(NOLOCK) PM
	ON		PM.Pm_Id = SIH.Sih_Pm_Id
	WHERE	CONVERT(date,SIH.Sih_Date) BETWEEN CONVERT(date,@FROMDATE) AND CONVERT(date,@TODATE)
			AND SIID.Sid_Mm_Id=case when @Mm_ID > 0 then @Mm_ID else SIID.Sid_Mm_Id end
			ORDER BY MM.Mm_Name ASC
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_PurchaseOrderReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Author:		Hasmukh	
-- Create date: 03-03-2018
-- Description:	Purchase Order With Item Report Filter By From Date To TO Date
-- =============================================
CREATE PROCEDURE [dbo].[SP_RPT_PurchaseOrderReport] @FromDate datetime = NULL,
@ToDate datetime = NULL,
@TypeId int = NULL,
@TopRecord int = 0,
@AccountId int = 0
AS
BEGIN
	IF (@TypeId != 0)
	BEGIN
	SELECT	ROW_NUMBER() OVER (ORDER BY Pi_Key ASC)																							AS SrNo,
				BM.Branch_Name,
				ISNULL(Bm.Branch_Address1,'') + ' ' + ISNULL(Bm.Branch_Address2,'') + ' ' + ISNULL(Bm.Branch_Address3,'')	AS Branch_Address,
				bm.Branch_GstNo,
				POH.Po_No																																	AS PoNo,
				CONVERT(varchar,POH.Po_Date,105)																										AS PoDate,
				POH.Po_RevNo																																AS RevNo,
				VM.Vendor_Name																																AS VendorName,
				ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')			AS VendorAddress,
				VAM.VendAdd_GstNo																															AS GstNo,
				POH.Po_BasicVal																															AS BasicValue,
				POH.Po_TotVal																																AS TotalValue,
				(CASE
					WHEN (SELECT
					COUNT(*)
					FROM PurchaseInvoiceDetail PID
					WHERE PID.Pid_PoKey = POH.Po_key)
					> 0 THEN 'Done'
					ELSE 'Pending'
				END)																																			AS InvoiceStatus,
				MM.Mm_HsnCode																																AS HsnCode,
				MM.Mm_Code																																	AS Code,
				MM.Mm_Name																																	AS Name,
				UOMM.Uom_Name																																AS UomName,
				PID.Pi_Qty																																	AS Quantity,
				PID.Pi_Rate																																	AS Rate,
				PID.Pi_Amt																																	AS Amount,
				PID.Pi_Net_Amt																																AS NetAmount,
				MTM.Mtm_TypeName																															AS DrugType,
				MGM.Mgm_Name																																AS DrugGroup,
				MCM.Mcm_Name																																AS DrugCategory
	FROM PoItemDetails(NOLOCK) PID
	INNER JOIN PoHeader(NOLOCK) POH
		ON POH.Po_Key = PID.Pi_PoKey
	INNER JOIN MedicineMaster(NOLOCK) MM
		ON MM.Mm_ID = PID.Pi_ItemId
	LEFT JOIN UomMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = PID.Pi_Uom
	LEFT JOIN VendorMaster(NOLOCK) VM
		ON POH.Po_VenId = VM.Vendor_ID
	LEFT JOIN VendorAddMaster(NOLOCK) VAM
		ON POH.Po_VenAddId = VAM.VendAdd_Id
	LEFT JOIN BranchMaster(NOLOCK) BM
		ON POH.Po_BmId = BM.Branch_Id
	LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = MM.Mm_MtmId
	LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = MM.Mm_MgmId
	LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = MM.Mm_McmId
	WHERE CONVERT(date,POH.Po_Date) BETWEEN CONVERT(date,@FromDate) AND CONVERT(date,@ToDate)
	AND MM.Mm_MtmId = @TypeId
	END
	ELSE BEGIN
	SELECT	ROW_NUMBER() OVER (ORDER BY Pi_Key ASC)																							AS SrNo,
				BM.Branch_Name,
				ISNULL(Bm.Branch_Address1,'') + ' ' + ISNULL(Bm.Branch_Address2,'') + ' ' + ISNULL(Bm.Branch_Address3,'')	AS Branch_Address,
				bm.Branch_GstNo,
				POH.Po_No																																	AS PoNo,
				CONVERT(varchar,POH.Po_Date,105)																										AS PoDate,
				POH.Po_RevNo																																AS RevNo,
				VM.Vendor_Name																																AS VendorName,
				ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')			AS VendorAddress,
				VAM.VendAdd_GstNo																															AS GstNo,
				POH.Po_BasicVal																															AS BasicValue,
				POH.Po_TotVal																																AS TotalValue,
				(CASE
					WHEN (SELECT
					COUNT(*)
					FROM PurchaseInvoiceDetail(NOLOCK) PID
					WHERE PID.Pid_PoKey = POH.Po_key)
					> 0 THEN 'Done'
					ELSE 'Pending'
				END)																																			AS InvoiceStatus,
				MM.Mm_HsnCode																																AS HsnCode,
				MM.Mm_Code																																	AS Code,
				MM.Mm_Name																																	AS Name,
				UOMM.Uom_Name																																AS UomName,
				PID.Pi_Qty																																	AS Quantity,
				PID.Pi_Rate																																	AS Rate,
				PID.Pi_Amt																																	AS Amount,
				PID.Pi_Net_Amt																																AS NetAmount,
				MTM.Mtm_TypeName																															AS DrugType,
				MGM.Mgm_Name																																AS DrugGroup,
				MCM.Mcm_Name																																AS DrugCategory
	FROM PoItemDetails(NOLOCK) PID
	INNER JOIN PoHeader(NOLOCK) POH
		ON POH.Po_Key = PID.Pi_PoKey
	INNER JOIN MedicineMaster(NOLOCK) MM
		ON MM.Mm_ID = PID.Pi_ItemId
	LEFT JOIN UomMaster(NOLOCK) UOMM
		ON UOMM.Uom_ID = PID.Pi_Uom
	LEFT JOIN VendorMaster(NOLOCK) VM
		ON POH.Po_VenId = VM.Vendor_ID
	LEFT JOIN VendorAddMaster(NOLOCK) VAM
		ON POH.Po_VenAddId = VAM.VendAdd_Id
	LEFT JOIN BranchMaster(NOLOCK) BM
		ON POH.Po_BmId = BM.Branch_Id
	LEFT JOIN MedicineTypeMaster(NOLOCK) MTM
		ON MTM.Mtm_ID = MM.Mm_MtmId
	LEFT JOIN MedicineGroupMaster(NOLOCK) MGM
		ON MGM.Mgm_ID = MM.Mm_MgmId
	LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM
		ON MCM.Mcm_ID = MM.Mm_McmId
	WHERE CONVERT(date,POH.Po_Date) BETWEEN CONVERT(date,@FromDate) AND CONVERT(date,@ToDate)
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_PurchaseReportAbstract]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		HASMUKH
-- Create date: 17-03-2018
-- Description:	Sales Margin Get Sales Rate From Medicine Master Then Compare with purchase rate
--              MRP Margin Get From Purchase Invoice Items Then Compare With Purchase Rate 
-- =============================================
CREATE PROCEDURE [dbo].[SP_RPT_PurchaseReportAbstract] @Pih_Date datetime,
@Pih_Duedate datetime
AS
BEGIN
	SELECT	PIH.Pih_No												AS InvoiceNo,
				CONVERT(varchar,PIH.Pih_Date,105)				AS InvoiceDate,
				VM.Vendor_Name											AS VendorName,
				SUM(PRODUCTQTY * PURRATE)							AS PURCHASERATE,
				SUM(QTY * MRP)											AS MRP,
				SUM(QTY * SALERATE)									AS SALESRATE,
				(SUM(QTY * MRP) - SUM(QTY * PURRATE))			AS MRPMARGIN,
				(SUM(QTY * SALERATE) - SUM(QTY * PURRATE))	AS SALESMARGIN
	FROM PurchaseInvoiceHeader PIH
	INNER JOIN (SELECT
	(ISNULL(PID.Pid_Qty,0) + ISNULL(PID.Pid_FreeQty,0)) AS QTY,
	ISNULL(PID.Pid_Qty,0) AS PRODUCTQTY,
	PID.Pid_MRP AS MRP,
	PID.Pid_Rate AS PURRATE,
	SR.Stk_SalesRate AS SALERATE,
	PID.Pid_PihKey AS PIDNO
	FROM PurchaseInvoiceDetail PID
	INNER JOIN StockRegister SR
	ON SR.Stk_MmId = PID.Pid_MmId
	AND SR.Stk_BatchNo = PID.Pid_BatchNo) AS PIDTABLE
	ON PIDTABLE.PIDNO = PIH.Pih_Key
	INNER JOIN VendorMaster VM
	ON VM.Vendor_ID = PIH.Pih_VenId
	WHERE CONVERT(date,Pih_Date) BETWEEN CONVERT(date,@Pih_Date) AND CONVERT(date,@Pih_Duedate) GROUP BY PIH.Pih_No,PIH.Pih_Date,VM.Vendor_Name
	ORDER BY Pih_Date ASC
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_PurchaseReportSummary]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================    
-- Author:  Hasmukh    
-- Create date: 17-03-2018    
-- Description: Date Wise Total Purchase Product Qty(Purchase Item) And Total Amount (Purchase Header)    
-- =============================================    
CREATE PROCEDURE [dbo].[SP_RPT_PurchaseReportSummary] @FROMDATE datetime,
@TODATE datetime
AS
BEGIN
	SELECT	CONVERT(varchar,SR.Stk_Date,105)					AS DATE,
				COUNT(SR.Stk_DocNo)									AS INVOICECOUNT,
				SUM(SR.Stk_PurchaseQty)								AS QTY,
				SUM(SR.Stk_PurchaseQty * Stk_PurchaseRate)	AS TOTALAMOUNT
	FROM StockRegister SR
	WHERE CONVERT(date,Stk_Date) BETWEEN CONVERT(date,@FROMDATE) AND CONVERT(date,@TODATE)
	AND SR.Stk_Tran_Typ = 'C'
	AND Stk_DocType = '4' GROUP BY SR.Stk_Date
	ORDER BY SR.Stk_Date ASC

END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_PurchaseReturnReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- Author:  Hasmukh  
-- Create date: 04-03-2018  
-- Description: Purchase Return Report Between From Date To To Date  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_RPT_PurchaseReturnReport] @FromDate datetime = NULL,
@ToDate datetime = NULL,
@TypeId int = NULL,
@TopRecord int=NULL,
@AccountId int=null
AS
BEGIN
     IF(@TypeId!=0)
	 BEGIN
	      SELECT	ROW_NUMBER() OVER (ORDER BY PRD.Prd_Id ASC) AS SrNo,
	      			BM.Branch_Name,
	      			ISNULL(Bm.Branch_Address1, '') + ' ' + ISNULL(Bm.Branch_Address2, '') + ' ' + ISNULL(Bm.Branch_Address3, '') AS Branch_Address,
	      			bm.Branch_GstNo,
	      			PRH.Prh_No AS PrhNo,
	      			CONVERT(varchar, PRH.Prh_Date, 105) AS PrhDate,
	      			VM.Vendor_Name AS VendorName,
	      			ISNULL(VAM.VendAdd_Addr1, '') + ',' + ISNULL(VAM.VendAdd_Add2, '') + ',' + ISNULL(VAM.VendAdd_Add3, '') AS VendorAddress,
	      			VAM.VendAdd_GstNo AS GstNo,
	      			PRH.Prh_TotalAmount AS TotalAmount,
	      			PRH.Prh_Remarks AS Remarks,
	      			MM.Mm_HsnCode AS HsnCode,
	      			MM.Mm_Code AS Code,
	      			MM.Mm_Name AS Name,
	      			UOMM.Uom_Name AS UomName,
	      			PRD.Prd_BatchNo AS BatchNo,
	      			PRD.Prd_Qty AS Quantity,
	      			PRD.Prd_Rate AS Rate,
	      			(PRD.Prd_Amount+PRTax.TaxAmount) AS Amount,
	      			PRD.Prd_Remarks AS PRemarks,
	      			MTM.Mtm_TypeName AS DrugType,
	            	MGM.Mgm_Name AS DrugGroup,
	                MCM.Mcm_Name AS DrugCategory
	      FROM PurchaseReturnDetail PRD
	      INNER JOIN PurchaseReturnHeader PRH
	      ON PRH.Prh_Id = PRD.Prd_PrhId
	      LEFT JOIN MedicineMaster MM
	      ON MM.Mm_ID = PRD.Prd_MmId
	      LEFT JOIN UomMaster UOMM
	      ON UOMM.Uom_ID = PRD.Prd_UomId
	      LEFT JOIN VendorMaster VM
	      ON PRH.Prh_VendorId = VM.Vendor_ID
	      LEFT JOIN VendorAddMaster VAM
	      ON PRH.Prh_BranchId = VAM.VendAdd_Id
	      LEFT JOIN BranchMaster BM
	      ON PRH.Prh_BranchId = BM.Branch_Id
	      LEFT JOIN MedicineTypeMaster MTM
	      ON MTM.Mtm_ID=MM.Mm_MtmId
	      LEFT JOIN MedicineGroupMaster MGM
	      ON MGM.Mgm_ID=MM.Mm_MgmId
	      LEFT JOIN MedicineCategoryMaster MCM
	      ON MCM.Mcm_ID=MM.Mm_McmId
		  LEFT JOIN   (SELECT
	                         A.Prd_PrhId,
							 A.Prd_Id,
	                         (ISNULL(SUM(B.Tr_TxTot),0)+ISNULL(SUM(C.Tr_TxTot),0)+ISNULL(SUM(D.Tr_TxTot),0))AS TaxAmount 
	                    FROM PurchaseReturnDetail  A
	                    LEFT JOIN TaxTransaction B
	                    	ON A.Prd_Id = B.Tr_DdocKey
	                    	AND A.Prd_PrhId = B.Tr_DocKey
	                    	AND B.Tr_TxId = 2
	                    	AND B.Tr_DocTyp = 5
	                    LEFT JOIN TaxTransaction C
	                    	ON A.Prd_Id = C.Tr_DdocKey
	                    	AND A.Prd_PrhId = C.Tr_DocKey
	                    	AND C.Tr_DocTyp = 5
	                    	AND C.Tr_TxId = 3
	                    LEFT JOIN TaxTransaction D
	                    	ON A.Prd_Id = D.Tr_DdocKey
	                    	AND A.Prd_PrhId = D.Tr_DocKey
	                    	AND D.Tr_DocTyp = 5
	                    	AND D.Tr_TxId = 4 GROUP BY A.Prd_PrhId,A.Prd_Id )AS PRTax
	     ON PRTax.Prd_Id=PRD.Prd_Id AND PRTax.Prd_PrhId=PRD.Prd_PrhId
	      WHERE CONVERT(date, PRH.Prh_Date) BETWEEN CONVERT(date, @FromDate) AND CONVERT(date, @ToDate)
	      AND mm.Mm_MtmId = @TypeId
      END
	  ELSE
	  BEGIN
	       SELECT	ROW_NUMBER() OVER (ORDER BY PRD.Prd_Id ASC) AS SrNo,
	      			BM.Branch_Name,
	      			ISNULL(Bm.Branch_Address1, '') + ' ' + ISNULL(Bm.Branch_Address2, '') + ' ' + ISNULL(Bm.Branch_Address3, '') AS Branch_Address,
	      			bm.Branch_GstNo,
	      			PRH.Prh_No AS PrhNo,
	      			CONVERT(varchar, PRH.Prh_Date, 105) AS PrhDate,
	      			VM.Vendor_Name AS VendorName,
	      			ISNULL(VAM.VendAdd_Addr1, '') + ',' + ISNULL(VAM.VendAdd_Add2, '') + ',' + ISNULL(VAM.VendAdd_Add3, '') AS VendorAddress,
	      			VAM.VendAdd_GstNo AS GstNo,
	      			PRH.Prh_TotalAmount AS TotalAmount,
	      			PRH.Prh_Remarks AS Remarks,
	      			MM.Mm_HsnCode AS HsnCode,
	      			MM.Mm_Code AS Code,
	      			MM.Mm_Name AS Name,
	      			UOMM.Uom_Name AS UomName,
	      			PRD.Prd_BatchNo AS BatchNo,
	      			PRD.Prd_Qty AS Quantity,
	      			PRD.Prd_Rate AS Rate,
	      			(PRD.Prd_Amount+PRTax.TaxAmount) AS Amount,
	      			PRD.Prd_Remarks AS PRemarks,
	      			MTM.Mtm_TypeName AS DrugType,
	                MGM.Mgm_Name AS DrugGroup,
	                MCM.Mcm_Name AS DrugCategory
	      FROM PurchaseReturnDetail PRD
	      INNER JOIN PurchaseReturnHeader PRH
	      ON PRH.Prh_Id = PRD.Prd_PrhId
	      LEFT JOIN MedicineMaster MM
	      ON MM.Mm_ID = PRD.Prd_MmId
	      LEFT JOIN UomMaster UOMM
	      ON UOMM.Uom_ID = PRD.Prd_UomId
	      LEFT JOIN VendorMaster VM
	      ON PRH.Prh_VendorId = VM.Vendor_ID
	      LEFT JOIN VendorAddMaster VAM
	      ON PRH.Prh_BranchId = VAM.VendAdd_Id
	      LEFT JOIN BranchMaster BM
	      ON PRH.Prh_BranchId = BM.Branch_Id
	      LEFT JOIN MedicineTypeMaster MTM
	      ON MTM.Mtm_ID=MM.Mm_MtmId
	      LEFT JOIN MedicineGroupMaster MGM
	      ON MGM.Mgm_ID=MM.Mm_MgmId
	      LEFT JOIN MedicineCategoryMaster MCM
	      ON MCM.Mcm_ID=MM.Mm_McmId
		  LEFT JOIN   (SELECT
	                         A.Prd_PrhId,
							 A.Prd_Id,
	                         (ISNULL(SUM(B.Tr_TxTot),0)+ISNULL(SUM(C.Tr_TxTot),0)+ISNULL(SUM(D.Tr_TxTot),0))AS TaxAmount 
	                    FROM PurchaseReturnDetail  A
	                    LEFT JOIN TaxTransaction B
	                    	ON A.Prd_Id = B.Tr_DdocKey
	                    	AND A.Prd_PrhId = B.Tr_DocKey
	                    	AND B.Tr_TxId = 2
	                    	AND B.Tr_DocTyp = 5
	                    LEFT JOIN TaxTransaction C
	                    	ON A.Prd_Id = C.Tr_DdocKey
	                    	AND A.Prd_PrhId = C.Tr_DocKey
	                    	AND C.Tr_DocTyp = 5
	                    	AND C.Tr_TxId = 3
	                    LEFT JOIN TaxTransaction D
	                    	ON A.Prd_Id = D.Tr_DdocKey
	                    	AND A.Prd_PrhId = D.Tr_DocKey
	                    	AND D.Tr_DocTyp = 5
	                    	AND D.Tr_TxId = 4 GROUP BY A.Prd_PrhId,A.Prd_Id )AS PRTax
	     ON PRTax.Prd_Id=PRD.Prd_Id AND PRTax.Prd_PrhId=PRD.Prd_PrhId
	      WHERE CONVERT(date, PRH.Prh_Date) BETWEEN CONVERT(date, @FromDate) AND CONVERT(date, @ToDate)
	  END
END

GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_SalesAndStockPivotTable]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
      
      
      
      
-- =============================================      
-- Author:  Hasmukh      
-- Create date: 19-03-2018      
-- Description:       
---Stk_Doc_Type=6 FOR Opening Stock      
---Stk_Doc_Type=2 FOR Sales Invoice      
---Stk_Doc_Type=3 FOR Sales Return      
---Stk_Doc_Type=4 FOR Purchase Invoice      
---Stk_Doc_Type=5 FOR Purchase Return      
-- =============================================      
CREATE PROCEDURE [dbo].[SP_RPT_SalesAndStockPivotTable]      
AS      
BEGIN      
  SELECT MM.Mm_Code AS DRUGCODE,        
       MM.Mm_Name AS DRUGNAME,       
       ISNULL(STOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS  PURCHASEUNIT,       
       MM.MM_PackSize AS PACKSIZE,     
       ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                 FROM StockRegister     
                WHERE CONVERT(DATE,StockRegister.Stk_Date)<CONVERT(DATE,CAST(YEAR1 AS VARCHAR(4))+'-'+CAST(MONTHNO AS VARCHAR(2))+'-01') AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                      GROUP BY StockRegister.Stk_MmId),0)AS OPENINGSTOCK,    
       ISNULL(SUM(STOCK.OPENINGSTOCKQTY),0)AS ADDOPENINGSTOCKQTY,      
       ISNULL(SUM(STOCK.SALESQTY),0)AS SALESQTY,      
       ISNULL(SUM(STOCK.SALESRETURNQTY),0)AS SALESRETURNQTY,        
       ISNULL(SUM(STOCK.PURCHASEQTY),0)AS PURCHASEQTY,      
       ISNULL(SUM(STOCK.PURCHASERETURNQTY),0)AS PURCHASERETURNQTY,      
       ISNULL(SUM(STOCK.ADJUSTQTY),0)AS ADJUSTQTY,    
      ISNULL((SELECT (SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_PurchaseQty ELSE 0 END)-SUM(CASE WHEN Stk_Tran_Typ='D' THEN Stk_PurchaseQty ELSE 0 END))    
                FROM StockRegister     
               WHERE MONTH(StockRegister.Stk_Date)<=MONTHNO AND YEAR(StockRegister.Stk_Date)<=YEAR1  AND StockRegister.Stk_MmId=STOCK.Stk_MmId     
                     GROUP BY StockRegister.Stk_MmId),0)AS CLOSINGSTOCK,    
       STOCK.MONTH1,    
       STOCK.YEAR1    
  FROM MedicineMaster MM    
       INNER JOIN (SELECT SR.Stk_MmId,    
                          SR.Stk_Date,    
                          (CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,        
                          (CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,      
                          (CASE WHEN SR.Stk_DocType=6 AND SR.Stk_Tran_Typ='C'  THEN SR.Stk_PurchaseQty ELSE 0 END)AS OPENINGSTOCKQTY,      
                          (CASE WHEN SR.Stk_DocType=2 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESQTY,       
                          (CASE WHEN SR.Stk_DocType=3 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS SALESRETURNQTY,       
                          (CASE WHEN SR.Stk_DocType in(4,6) AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASEQTY,      
                          (CASE WHEN SR.Stk_DocType=5 AND SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PURCHASERETURNQTY,          
                           (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE (CASE WHEN SR.Stk_DocType=14 AND SR.Stk_Tran_Typ='D' THEN -SR.Stk_PurchaseQty ELSE 0 END) END)AS ADJUSTQTY,          
                           PUOM.Uom_Name AS PURCHASEUNIT,    
                           DATENAME(MONTH,SR.Stk_Date)AS MONTH1,       
                           YEAR(SR.Stk_Date)AS YEAR1,    
                           MONTH(SR.Stk_Date)AS MONTHNO     
                      FROM StockRegister SR      
                           INNER JOIN UomMaster PUOM        
                        ON PUOM.Uom_ID=SR.Stk_PurchaseUom)AS STOCK    
   ON STOCK.Stk_MmId=MM.Mm_ID     
      LEFT JOIN UomMaster PPUOM         
  ON  PPUOM.Uom_ID=MM.MM_PurchaseUom     
      GROUP BY MM.Mm_Code,MM.Mm_Name,STOCK.Stk_MmId,STOCK.PURCHASEUNIT,MM.MM_PackSize,MONTHNO,PPUOM.Uom_Name,YEAR1,MONTH1    
      ORDER BY MM.Mm_Name ASC        
END      
    
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_SalesReturn]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================  
-- Author:  Hasmukh  
-- Create date: 05-03-2018  
-- Description: Sales Return List Between From Date To ToDate  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_RPT_SalesReturn] @FromDate datetime = NULL,
@ToDate datetime = NULL,
@TypeId int = NULL,
@TopRecord int=NULL,
@AccountId int=NULL
AS
BEGIN
     IF(@TypeId!=0)
	 BEGIN
	    SELECT  SRH.Srh_No AS SRNo,
	      		CONVERT(varchar, SRH.Srh_Date, 105) AS SDate,
	      		SRH.Srh_SihKey AS SINo,
	      		PM.Pm_FullName AS PatientName,
	      		SRH.Srh_Total AS TotalAmount,
	      		SRH.Srh_Remarks AS Remarks,
	      		MM.Mm_HsnCode AS HsnCode,
	      		MM.Mm_Code AS Code,
	      		MM.Mm_Name AS Name,
	      		UOMM.Uom_Name AS UomName,
	      		SRD.Srd_BatchNo AS BatchNo,
	      		SIID.Sid_ExpDate AS ExpiryDate,
	      		SRD.Srd_Qty AS Quantity,
	      		SRD.Srd_Rate AS Rate,
	      		(SRD.Srd_Amount+SRTax.TaxAmount) AS Amount,
	      		SRD.Srd_Remarks AS SRemarks,
				BM.Branch_Name,
				ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
				BM.Branch_GstNo,
				MTM.Mtm_TypeName AS DrugType,
				MGM.Mgm_Name AS DrugGroup,
				MCM.Mcm_Name AS DrugCategory
	      FROM SalesReturnDetail SRD
	      INNER JOIN SalesReturnHeader SRH
	      ON SRH.Srh_Id = SRD.Srd_SrhId
		  LEFT JOIN BranchMaster BM
		  ON BM.Branch_Id=SRH.Srh_BranchId
	      INNER JOIN MedicineMaster MM
	      ON MM.Mm_ID = SRD.Srd_MmId
		  LEFT JOIN MedicineTypeMaster MTM
		  ON MTM.Mtm_ID=MM.Mm_MtmId
		  LEFT JOIN MedicineGroupMaster MGM
		  ON MGM.Mgm_ID=MM.Mm_MgmId
		  LEFT JOIN MedicineCategoryMaster MCM
		  ON MCM.Mcm_ID=MM.Mm_McmId
	      INNER JOIN UomMaster UOMM
	      ON UOMM.Uom_ID = SRD.Srd_UomId
	      INNER JOIN SalesInvoiceItemDetail SIID
	      ON SIID.Sid_Key = SRD.Srd_SidKey
	      INNER JOIN SalesInvoiceHeader SIH
	      ON SIH.Sih_Key = SIID.Sid_Sih_Key
	      INNER JOIN PatientMaster PM
	      ON PM.Pm_Id = SIH.Sih_Pm_Id
		  LEFT JOIN   (SELECT
	                         A.Srd_SrhId,
							 A.Srd_Id,
	                         (ISNULL(SUM(B.Tr_TxTot),0)+ISNULL(SUM(C.Tr_TxTot),0)+ISNULL(SUM(D.Tr_TxTot),0))AS TaxAmount 
	                    FROM SalesReturnDetail  A
	                    LEFT JOIN TaxTransaction B
	                    	ON A.Srd_Id = B.Tr_DdocKey
	                    	AND A.Srd_SrhId = B.Tr_DocKey
	                    	AND B.Tr_TxId = 2
	                    	AND B.Tr_DocTyp = 3
	                    LEFT JOIN TaxTransaction C
	                    	ON A.Srd_Id = C.Tr_DdocKey
	                    	AND A.Srd_SrhId = C.Tr_DocKey
	                    	AND C.Tr_DocTyp = 3
	                    	AND C.Tr_TxId = 3
	                    LEFT JOIN TaxTransaction D
	                    	ON A.Srd_Id = D.Tr_DdocKey
	                    	AND A.Srd_SrhId = D.Tr_DocKey
	                    	AND D.Tr_DocTyp = 3
	                    	AND D.Tr_TxId = 4 GROUP BY A.Srd_SrhId,A.Srd_Id )AS SRTax
		ON SRTax.Srd_Id=SRD.Srd_Id AND SRTax.Srd_SrhId=SRD.Srd_SrhId
	      WHERE CONVERT(date, SRH.Srh_Date) BETWEEN CONVERT(date, @FromDate) AND CONVERT(date, @ToDate)
	      AND mm.Mm_MtmId = @TypeId
	 END
	 ELSE
	 BEGIN
	      SELECT  SRH.Srh_No AS SRNo,
	      		CONVERT(varchar, SRH.Srh_Date, 105) AS SDate,
	      		SRH.Srh_SihKey AS SINo,
	      		PM.Pm_FullName AS PatientName,
	      		SRH.Srh_Total AS TotalAmount,
	      		SRH.Srh_Remarks AS Remarks,
	      		MM.Mm_HsnCode AS HsnCode,
	      		MM.Mm_Code AS Code,
	      		MM.Mm_Name AS Name,
	      		UOMM.Uom_Name AS UomName,
	      		SRD.Srd_BatchNo AS BatchNo,
	      		SIID.Sid_ExpDate AS ExpiryDate,
	      		SRD.Srd_Qty AS Quantity,
	      		SRD.Srd_Rate AS Rate,
	      		(SRD.Srd_Amount+SRTax.TaxAmount) AS Amount,
	      		SRD.Srd_Remarks AS SRemarks,
				BM.Branch_Name,
				ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
				BM.Branch_GstNo,
				MTM.Mtm_TypeName AS DrugType,
				MGM.Mgm_Name AS DrugGroup,
				MCM.Mcm_Name AS DrugCategory
	      FROM SalesReturnDetail SRD
	      INNER JOIN SalesReturnHeader SRH
	      ON SRH.Srh_Id = SRD.Srd_SrhId
	      INNER JOIN MedicineMaster MM
	      ON MM.Mm_ID = SRD.Srd_MmId
		  LEFT JOIN MedicineTypeMaster MTM
		  ON MTM.Mtm_ID=MM.Mm_MtmId
		  LEFT JOIN MedicineGroupMaster MGM
		  ON MGM.Mgm_ID=MM.Mm_MgmId
		  LEFT JOIN MedicineCategoryMaster MCM
		  ON MCM.Mcm_ID=MM.Mm_McmId
	      INNER JOIN UomMaster UOMM
	      ON UOMM.Uom_ID = SRD.Srd_UomId
	      LEFT JOIN BranchMaster BM
	      ON SRH.Srh_BranchId = BM.Branch_Id
	      INNER JOIN SalesInvoiceItemDetail SIID
	      ON SIID.Sid_Key = SRD.Srd_SidKey
	      INNER JOIN SalesInvoiceHeader SIH
	      ON SIH.Sih_Key = SIID.Sid_Sih_Key
	      INNER JOIN PatientMaster PM
	      ON PM.Pm_Id = SIH.Sih_Pm_Id
		  LEFT JOIN   (SELECT
	                         A.Srd_SrhId,
							 A.Srd_Id,
	                         (ISNULL(SUM(B.Tr_TxTot),0)+ISNULL(SUM(C.Tr_TxTot),0)+ISNULL(SUM(D.Tr_TxTot),0))AS TaxAmount 
	                    FROM SalesReturnDetail  A
	                    LEFT JOIN TaxTransaction B
	                    	ON A.Srd_Id = B.Tr_DdocKey
	                    	AND A.Srd_SrhId = B.Tr_DocKey
	                    	AND B.Tr_TxId = 2
	                    	AND B.Tr_DocTyp = 3
	                    LEFT JOIN TaxTransaction C
	                    	ON A.Srd_Id = C.Tr_DdocKey
	                    	AND A.Srd_SrhId = C.Tr_DocKey
	                    	AND C.Tr_DocTyp = 3
	                    	AND C.Tr_TxId = 3
	                    LEFT JOIN TaxTransaction D
	                    	ON A.Srd_Id = D.Tr_DdocKey
	                    	AND A.Srd_SrhId = D.Tr_DocKey
	                    	AND D.Tr_DocTyp = 3
	                    	AND D.Tr_TxId = 4 GROUP BY A.Srd_SrhId,A.Srd_Id )AS SRTax
		ON SRTax.Srd_Id=SRD.Srd_Id AND SRTax.Srd_SrhId=SRD.Srd_SrhId
	      WHERE CONVERT(date, SRH.Srh_Date) BETWEEN CONVERT(date, @FromDate) AND CONVERT(date, @ToDate)
	      
	 END
END

GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_SLOW_MOVING_ITEM]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--Exec SP_RPT_NON_MOVING_ITEM @FROMDATE='2017-10-15',@TODATE='2018-04-13',@TYPEID=0  
CREATE PROC [dbo].[SP_RPT_SLOW_MOVING_ITEM]  
@FROMDATE		DATETIME=NULL,  
@TODATE			DATETIME=NULL,  
@TYPEID			int=NULL,  
@TopRecord		int=null,
@AccountId		int=NULL  
AS  
BEGiN  
    IF(@TYPEID!=0)  
 BEGIN  
      IF(@TopRecord>0)  
   BEGIN  
               SELECT Top (@TopRecord) *  FROM(  
               SELECT		A.Mm_ID,  
							A.Mm_HsnCode AS HSNCode,  
							A.Mm_Code AS DrugCode,  
							A.Mm_Name AS DrugName,  
							MTM.Mtm_TypeName AS DrugType,  
							MCM.Mcm_Name AS DrugCategory,  
							MGM.Mgm_Name AS DrugGroup,  
							ISNULL(B.SALES_QTY,0) AS SALES_QTY,  
							ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,  
							BM.Branch_Name,  
							(ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,''))AS Branch_Address,  
							BM.Branch_GstNo,  
							UOMM.Uom_Name  
               FROM			MedicineMaster A  
                       LEFT JOIN UOMMaster UOMM  
                ON			 UOMM.Uom_ID=A.Mm_StkUom  
                       LEFT JOIN BranchMaster BM ON Branch_Id=1  
                       LEFT JOIN MedicineTypeMaster MTM  
                ON			 MTM.Mtm_ID=A.Mm_MtmId  
                       LEFT JOIN MedicineCategoryMaster MCM  
                ON			 MCM.Mcm_ID=A.Mm_McmId  
                       LEFT JOIN MedicineGroupMaster MGM  
                ON			 MGM.Mgm_ID=A.Mm_MgmId  
                 LEFT JOIN( SELECT ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,  
							SUM(X.Sid_SalesQty) AS SALES_QTY  
                    FROM	 SalesInvoiceItemDetail X  
                      iNNER JOIN SalesInvoiceHeader Y  
                    ON		X.Sid_Sih_Key=Y.Sih_Key  
                      AND Convert(date,Y.Sih_Date,105) BETWEEN Convert(date,@FROMDATE,105) AND Convert(date,@TODATE,105)  
                    GROUP BY ISNULL(X.Sid_Mm_Id,0)  
                   ) B  
               ON			A.Mm_ID=B.Sid_Mm_Id  
                 INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM	StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='C'  
                    group by Stk_MmId) C  
               ON			A.Mm_ID=C.Stk_MmId AND C.Stock>0
			    INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM	StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='D'  
                    group by Stk_MmId) D  
               ON			A.Mm_ID=D.Stk_MmId AND D.Stock>0  
               WHERE		MTM.Mtm_ID=@TYPEID )AS DT  
               WHERE		SALES_QTY>0   
               ORDER BY		SALES_QTY ASC  
   END  
   ELSE  
   BEGIN  
         SELECT  *  FROM(  
               SELECT	A.Mm_ID,  
						A.Mm_HsnCode AS HSNCode,  
						A.Mm_Code AS DrugCode,  
						A.Mm_Name AS DrugName,  
						MTM.Mtm_TypeName AS DrugType,  
						MCM.Mcm_Name AS DrugCategory,  
						MGM.Mgm_Name AS DrugGroup,  
						ISNULL(B.SALES_QTY,0) AS SALES_QTY,  
						ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,  
						BM.Branch_Name,  
						(ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,''))AS Branch_Address,  
						BM.Branch_GstNo,  
						UOMM.Uom_Name  
               FROM		MedicineMaster A  
                     LEFT JOIN UOMMaster UOMM  
                ON		UOMM.Uom_ID=A.Mm_StkUom  
                     LEFT JOIN BranchMaster BM ON Branch_Id=1  
                     LEFT JOIN MedicineTypeMaster MTM  
                ON		MTM.Mtm_ID=A.Mm_MtmId  
                     LEFT JOIN MedicineCategoryMaster MCM  
                ON		MCM.Mcm_ID=A.Mm_McmId  
                     LEFT JOIN MedicineGroupMaster MGM  
                ON		MGM.Mgm_ID=A.Mm_MgmId  
					 LEFT JOIN( SELECT ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,  
						SUM(X.Sid_SalesQty) AS SALES_QTY  
                FROM SalesInvoiceItemDetail X  
                      iNNER JOIN SalesInvoiceHeader Y  
                ON   X.Sid_Sih_Key=Y.Sih_Key  
                      AND Convert(date,Y.Sih_Date,105) BETWEEN Convert(date,@FROMDATE,105) AND Convert(date,@TODATE,105)  
                GROUP BY ISNULL(X.Sid_Mm_Id,0)  
                   ) B  
				ON		 A.Mm_ID=B.Sid_Mm_Id  
					INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='C'  
                    group by Stk_MmId) C  
               ON   A.Mm_ID=C.Stk_MmId AND C.Stock>0
			   
			   INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='D'  
                    group by Stk_MmId) D  
               ON   A.Mm_ID=D.Stk_MmId AND D.Stock>0 
			     
               WHERE  MTM.Mtm_ID=@TYPEID )AS DT  
               WHERE  SALES_QTY>0   
                      ORDER BY SALES_QTY ASC  
   END  
 END  
 ELSE  
 BEGIN  
 IF(@TopRecord>0)  
   BEGIN  
               SELECT Top (@TopRecord) *  FROM(  
               SELECT	A.Mm_ID,  
						 A.Mm_HsnCode AS HSNCode,  
						A.Mm_Code AS DrugCode,  
						A.Mm_Name AS DrugName,  
						MTM.Mtm_TypeName AS DrugType,  
						MCM.Mcm_Name AS DrugCategory,  
						MGM.Mgm_Name AS DrugGroup,  
						ISNULL(B.SALES_QTY,0) AS SALES_QTY,  
						ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,  
						BM.Branch_Name,  
						(ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,''))AS Branch_Address,  
						BM.Branch_GstNo,  
						UOMM.Uom_Name  
               FROM		MedicineMaster A  
                     LEFT JOIN UOMMaster UOMM  
                ON		UOMM.Uom_ID=A.Mm_StkUom  
                     LEFT JOIN BranchMaster BM ON Branch_Id=1  
                     LEFT JOIN MedicineTypeMaster MTM  
                ON     MTM.Mtm_ID=A.Mm_MtmId  
                     LEFT JOIN MedicineCategoryMaster MCM  
                ON     MCM.Mcm_ID=A.Mm_McmId  
                     LEFT JOIN MedicineGroupMaster MGM  
                ON     MGM.Mgm_ID=A.Mm_MgmId  
					 LEFT JOIN( SELECT ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,  
					   SUM(X.Sid_SalesQty) AS SALES_QTY  
               FROM		SalesInvoiceItemDetail X  
                     iNNER JOIN SalesInvoiceHeader Y  
                ON		X.Sid_Sih_Key=Y.Sih_Key  
                     AND Convert(date,Y.Sih_Date,105) BETWEEN Convert(date,@FROMDATE,105) AND Convert(date,@TODATE,105)  
               GROUP BY ISNULL(X.Sid_Mm_Id,0)  
                   ) B  
               ON	 A.Mm_ID=B.Sid_Mm_Id  
					INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='C'  
                    group by Stk_MmId) C  
               ON   A.Mm_ID=C.Stk_MmId AND C.Stock>0 
			   INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='D'  
                    group by Stk_MmId) D 
               ON   A.Mm_ID=D.Stk_MmId AND D.Stock>0  
                )AS DT  
               WHERE  SALES_QTY>0   
                      ORDER BY SALES_QTY ASC  
   END  
   ELSE  
   BEGIN  
         SELECT  *  FROM(  
               SELECT	A.Mm_ID,  
						A.Mm_HsnCode AS HSNCode,  
						 A.Mm_Code AS DrugCode,  
						 A.Mm_Name AS DrugName,  
						 MTM.Mtm_TypeName AS DrugType,  
						 MCM.Mcm_Name AS DrugCategory,  
						 MGM.Mgm_Name AS DrugGroup,  
						 ISNULL(B.SALES_QTY,0) AS SALES_QTY,  
						 ISNULL(C.STOCK,0)-ISNULL(D.STOCK,0) AS CUR_STOCK,  
						 BM.Branch_Name,  
						 (ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,''))AS Branch_Address,  
						 BM.Branch_GstNo,  
						 UOMM.Uom_Name  
               FROM MedicineMaster A  
                       LEFT JOIN UOMMaster UOMM  
                ON     UOMM.Uom_ID=A.Mm_StkUom  
                       LEFT JOIN BranchMaster BM ON Branch_Id=1  
                       LEFT JOIN MedicineTypeMaster MTM  
                ON     MTM.Mtm_ID=A.Mm_MtmId  
                       LEFT JOIN MedicineCategoryMaster MCM  
                ON     MCM.Mcm_ID=A.Mm_McmId  
                       LEFT JOIN MedicineGroupMaster MGM  
                ON     MGM.Mgm_ID=A.Mm_MgmId  
                 LEFT JOIN( SELECT ISNULL(X.Sid_Mm_Id,0) AS Sid_Mm_Id,  
                      SUM(X.Sid_SalesQty) AS SALES_QTY  
                    FROM SalesInvoiceItemDetail X  
                      iNNER JOIN SalesInvoiceHeader Y  
                    ON   X.Sid_Sih_Key=Y.Sih_Key  
                      AND Convert(date,Y.Sih_Date,105) BETWEEN Convert(date,@FROMDATE,105) AND Convert(date,@TODATE,105)  
                    GROUP BY ISNULL(X.Sid_Mm_Id,0)  
                   ) B  
               ON   A.Mm_ID=B.Sid_Mm_Id  
                 INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='C'  
                    group by Stk_MmId) C  
               ON   A.Mm_ID=C.Stk_MmId AND C.Stock>0 

			     INNER JOIN (SELECT Stk_MmId,  
                                    ISNULL(sum(stk_SalesQty),0)AS Stock   
                    FROM   StockRegister   
                    WHERE  Convert(date,Stk_date,105) BETWEEN Convert(date,@FROMDATE,105) AND  Convert(date,@TODATE,105)   
                           AND Stk_Tran_Typ='D'  
                    group by Stk_MmId) D  
               ON   A.Mm_ID=D.Stk_MmId AND D.Stock>0   
               )AS DT  
               WHERE  SALES_QTY>0   
                      ORDER BY SALES_QTY ASC  
   END  
 END  
END
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_StockAndSalesReport]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
      
-- =============================================      
-- Author:  HASMUKH      
-- Create date: 19-03-2018      
-- Description:       
--      
-- =============================================      
CREATE PROCEDURE [dbo].[SP_RPT_StockAndSalesReport]    
@FROMDATE        DATETIME,    
@TODATE          DATETIME        
AS      
BEGIN      
  SELECT ISNULL(MTM.Mtm_TypeName,'') AS DRUGTYPENAME,        
            ISNULL(MCM.Mcm_Name,'') AS DRUGCATEGORY,        
            ISNULL(MGM.Mgm_Name,'') AS DRUGGROUP,        
            MM.Mm_Code AS DRUGCODE,        
            MM.Mm_Name AS DRUGNAME,       
            ISNULL(STOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS  PURCHASEUNIT,       
            MM.MM_PackSize AS PACKSIZE,      
            ISNULL(STOCK.PUSALESQTY,0) AS SALESQTY,      
            ISNULL(STOCK.SALESRATE,0)AS SALESRATE,      
            ISNULL(STOCK.SALEVALUE,0)AS SALEVALUE,      
            ISNULL(STOCK.PUPURCHASEQTY,0)AS PURCHASEQTY,      
            ISNULL(STOCK.PURCHASERATE,0)AS PURCHASERATE,      
            ISNULL(STOCK.PURCHASEVALUE,0)AS PURCHASEVALUE,      
            ISNULL(STOCK.OPENINGSTOCKQTY,0)AS OPENINGSTOCKQTY,      
            ISNULL(STOCK.OPENINGSTOCKVALUE,0)AS OPENINGSTOCKVALUE,      
            ISNULL((STOCK.PUPURCHASEQTY-STOCK.PUSALESQTY),0)AS CURRENTSTOCK,      
            ISNULL((STOCK.PUPURCHASEQTY-STOCK.PUSALESQTY)*STOCK.SALESRATE,0)AS CURRENTSTOCKVALUE,  
            ISNULL(MM.Mm_MRP,0)AS MRP,  
            ISNULL((STOCK.PUSALESQTY*MM.Mm_MRP),0)AS MRPVALUES,      
            ISNULL((CASE WHEN(SELECT TOP 1 Stk_DATE FROM StockRegister WHERE Stk_MmId=MM.Mm_ID AND Stk_Tran_Typ='C' ORDER BY Stk_Date DESC)=NULL THEN '' ELSE      
             CONVERT(VARCHAR,(SELECT TOP 1 Stk_DATE FROM StockRegister WHERE Stk_MmId=MM.Mm_ID AND Stk_Tran_Typ='C' ORDER BY Stk_Date DESC),105)END),'')AS LASTSTOCKRECEIVEDATE,      
            ISNULL((CASE WHEN (SELECT TOP 1 Stk_PurchaseQty FROM StockRegister WHERE Stk_MmId=MM.Mm_ID AND Stk_Tran_Typ='C' ORDER BY Stk_Date  DESC)=NULL THEN       
             0 ELSE (SELECT TOP 1 Stk_PurchaseQty FROM StockRegister WHERE Stk_MmId=MM.Mm_ID AND Stk_Tran_Typ='C' ORDER BY Stk_Date  DESC)END),0)AS LASTSTOCKRECEIVEQTY      
     FROM   MedicineMaster MM        
            LEFT JOIN MedicineTypeMaster MTM        
       ON   MTM.Mtm_ID=MM.Mm_MtmId        
            LEFT JOIN MedicineCategoryMaster MCM         
       ON   MCM.Mcm_ID=MM.Mm_McmId        
            LEFT JOIN MedicineGroupMaster MGM        
       ON   MGM.Mgm_ID=MM.Mm_MgmId        
            LEFT JOIN(SELECT SR.Stk_MmId,          
                             SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,      
                             SR.Stk_SalesRate AS SALESRATE,      
                             SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN (SR.Stk_PurchaseQty*SR.Stk_SalesRate) ELSE 0 END)AS SALEVALUE,      
                             SUM(CASE WHEN (SR.Stk_Tran_Typ='C' AND SR.Stk_DocType=6) THEN SR.Stk_PurchaseQty ELSE 0 END)AS OPENINGSTOCKQTY,      
                             SUM(CASE WHEN (SR.Stk_Tran_Typ='C' AND SR.Stk_DocType=6) THEN (SR.Stk_PurchaseQty*SR.Stk_PurchaseRate) ELSE 0 END)AS OPENINGSTOCKVALUE,      
                             SUM(CASE WHEN (SR.Stk_Tran_Typ='C' ) THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,      
                             SR.Stk_PurchaseRate AS PURCHASERATE,      
                             SUM(CASE WHEN (SR.Stk_Tran_Typ='C' ) THEN (SR.Stk_PurchaseQty*SR.Stk_PurchaseRate) ELSE 0 END)AS PURCHASEVALUE,      
                             PUOM.Uom_Name AS PURCHASEUNIT        
                        FROM StockRegister SR        
                             INNER JOIN UomMaster PUOM        
                          ON PUOM.Uom_ID=SR.Stk_PurchaseUom     
                       WHERE CONVERT(DATE,SR.Stk_Date) BETWEEN CONVERT(DATE,@FROMDATE) AND CONVERT(DATE,@TODATE)      
                             GROUP BY SR.Stk_MmId,PUOM.Uom_Name,SR.Stk_SalesRate,SR.Stk_PurchaseRate)AS STOCK        
       ON  STOCK.Stk_MmId=MM.Mm_ID      
           LEFT JOIN UomMaster PPUOM         
       ON  PPUOM.Uom_ID=MM.MM_PurchaseUom            
           ORDER BY MM.Mm_Name,MTM.Mtm_TypeName,MCM.Mcm_Name,MGM.Mgm_Name ASC      
END   
  
  
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_StockComparisionWithStockLevel]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
-- =============================================  
-- Author:  Hasmukh  
-- Create date: 18-03-2018  
-- Description: Stock Report With Min,Max And Re-Order Comparision Of Drug  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_RPT_StockComparisionWithStockLevel]   
AS  
BEGIN  
     SELECT ISNULL(MTM.Mtm_TypeName,'') AS DRUGTYPENAME,  
            ISNULL(MCM.Mcm_Name,'') AS DRUGCATEGORY,  
            ISNULL(MGM.Mgm_Name,'') AS DRUGGROUP,  
            MM.Mm_Code AS DRUGCODE,  
            MM.Mm_Name AS DRUGNAME,  
            ISNULL((STOCK.SUPURCHASEQTY-STOCK.SUSALESQTY),0)AS SALEUNITWISEQTY,  
            ISNULL(STOCK.SALESUNIT,SSUOM.Uom_Name)AS  SALESUNIT,  
            ISNULL((STOCK.PUPURCHASEQTY-STOCK.PUSALESQTY),0)AS PURCHASEUNITWISEQTY,  
            ISNULL(STOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS  PURCHASEUNIT,  
            MM.MM_PackSize AS PACKSIZE,  
            MM.Mm_MaxLevel AS MAXLEVEL,  
            MM.Mm_ReorderLevel AS REORDERLEVEL,  
            MM.Mm_MinLevel AS MINLEVEL  
     FROM   MedicineMaster MM  
            LEFT JOIN MedicineTypeMaster MTM  
       ON   MTM.Mtm_ID=MM.Mm_MtmId  
            LEFT JOIN MedicineCategoryMaster MCM   
       ON   MCM.Mcm_ID=MM.Mm_McmId  
            LEFT JOIN MedicineGroupMaster MGM  
       ON   MGM.Mgm_ID=MM.Mm_MgmId  
            LEFT JOIN(SELECT SR.Stk_MmId,  
                             SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,  
                             SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,  
                             SUOM.Uom_Name AS SALESUNIT,  
                             SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,  
                             SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,  
                             PUOM.Uom_Name AS PURCHASEUNIT  
                        FROM StockRegister SR   
                             INNER JOIN UomMaster SUOM   
                          ON SUOM.Uom_ID=SR.Stk_SalesUom  
                             INNER JOIN UomMaster PUOM  
                          ON PUOM.Uom_ID=SR.Stk_PurchaseUom  
                             GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS STOCK  
       ON  STOCK.Stk_MmId=MM.Mm_ID  
           LEFT JOIN UomMaster SSUOM   
       ON  SSUOM.Uom_ID=MM.Mm_StkUom  
           LEFT JOIN UomMaster PPUOM   
       ON  PPUOM.Uom_ID=MM.MM_PurchaseUom      
           ORDER BY MM.Mm_Name,MTM.Mtm_TypeName,MCM.Mcm_Name,MGM.Mgm_Name ASC  
END  
GO
/****** Object:  StoredProcedure [dbo].[SP_RPT_StockLedgerReportProductwiseANDDatewise]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
  
-- =============================================  
-- Author:  HASMUKH  
-- Create date: 20-03-2018  
-- Description: Opening Stock, In Between Transaction, Closing Stock  
-- =============================================  
CREATE PROCEDURE [dbo].[SP_RPT_StockLedgerReportProductwiseANDDatewise]  
@FROMDATE        DATETIME,  
@TODATE          DATETIME  
AS  
BEGIN  
  SELECT * FROM   
(SELECT 1 AS ID,  
       MM.Mm_Code AS DrugCode,  
       MM.Mm_Name AS DrugName,  
       ISNULL(OPENINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
       ISNULL(OPENINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
       CONVERT(varchar,@FROMDATE,105) AS DATE,  
       ('Opening Stock')AS Description,  
       '' AS SUPPLIERNAME,  
       '' AS BATCHNO,  
       ISNULL((OPENINGSTOCK.SUPURCHASEQTY-OPENINGSTOCK.SUSALESQTY),0)AS SALEIN,  
       0 AS SALESOUT,  
       ISNULL((OPENINGSTOCK.PUPURCHASEQTY-OPENINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
       0 AS PURCHASEOUT,  
       1 AS TAGORDER  
  FROM MedicineMaster MM   
   LEFT JOIN (SELECT SR.Stk_MmId,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
               SUOM.Uom_Name AS SALESUNIT,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
               PUOM.Uom_Name AS PURCHASEUNIT    
          FROM StockRegister SR     
               INNER JOIN UomMaster SUOM     
            ON SUOM.Uom_ID=SR.Stk_SalesUom    
               INNER JOIN UomMaster PUOM    
            ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
         WHERE CONVERT(DATE,Stk_Date)<CONVERT(DATE,@FROMDATE)   
               GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS OPENINGSTOCK  
     ON MM.Mm_ID=OPENINGSTOCK.Stk_MmId  
        INNER JOIN UomMaster SSUOM     
     ON SSUOM.Uom_ID=MM.MM_StkUom    
        INNER JOIN UomMaster PPUOM    
     ON PPUOM.Uom_ID=MM.MM_PurchaseUom  
        
UNION ALL  
  
SELECT SR.Stk_Id AS ID,  
       MM.Mm_Code AS DrugCode,  
       MM.Mm_Name AS DrugName,  
       SUOM.Uom_Name AS SALESUNIT,  
       PUOM.Uom_Name AS PURCHASEUNIT,  
       CONVERT(VARCHAR,SR.Stk_Date,105) AS DATE,  
      (CAST((CASE WHEN SR.Stk_DocType='6' THEN 'Add Opening Stock' ELSE   
            (CASE WHEN   
                       SR.Stk_DocType='2'  
                  THEN   
                      'Sales Invoice'   
                  ELSE   
                  (CASE WHEN   
                            SR.Stk_DocType='3'  
                        THEN   
                            'Sales Return'  
                        ELSE  
                        (CASE WHEN   
                                  Stk_DocType='4'  
                              THEN   
                                   'Purchase Invoice'  
                              ELSE   
                              (CASE WHEN   
                                        Stk_DocType='5'  
                                    THEN   
                                        'Purchase Return'  
                                    ELSE (CASE WHEN   
                                                   Stk_DocType='13'  
                                               THEN   
                                                   'Stock Adjustment'  
                                          END)  
                               END)  
                         END)  
                    END)  
                END)  
           END)AS VARCHAR(50))+''+  
           CAST((CASE WHEN SR.Stk_DocType='6' Then '' ELSE   
            (CASE WHEN   
                       SR.Stk_DocType='2'  
                  THEN   
                      ',Bill No :'+CAST(SIH.Sih_No AS VARCHAR(20))  
                  ELSE   
                  (CASE WHEN   
                            SR.Stk_DocType='3'  
                        THEN   
     ',Bill No :'+CAST(SRH.Srh_No AS VARCHAR(20))  
                        ELSE  
                        (CASE WHEN   
                                  Stk_DocType='4'  
                              THEN   
                                    ',Bill No :'+CAST(Pih_No AS VARCHAR(20))  
                              ELSE   
                              (CASE WHEN   
                                        Stk_DocType='5'  
                                    THEN   
                                         ',Bill No :'+CAST(Prh_No AS VARCHAR(20))  
                                     ELSE (CASE WHEN   
                                                   Stk_DocType='13'  
                                               THEN   
                                                    ''  
                                          END)  
                               END)  
                         END)  
                    END)  
                END)  
           END)AS VARCHAR(200)))AS Description,  
              
       ((CASE WHEN SR.Stk_DocType='6'   
                  THEN ''   
                  ELSE   
                 (CASE WHEN   
                           SR.Stk_DocType='2'  
                       THEN   
                            SIPM.Pm_FullName  
                       ELSE   
                           (CASE WHEN   
                                     SR.Stk_DocType='3'  
                                  THEN   
                                      SRPM.Pm_FullName  
                                  ELSE  
                                  (CASE WHEN   
                                            Stk_DocType='4'  
                                        THEN   
                                            PIVM.Vendor_Name  
                                        ELSE   
                                        (CASE WHEN   
                                                  Stk_DocType='5'  
                                              THEN   
                                                  PRVM.Vendor_Name  
                                          END)  
                                     END)  
                             END)  
                     END)  
                END)) AS SUPPLIERNAME,  
        SR.Stk_BatchNo AS BATCHNO,  
       (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_SalesQty  ELSE 0 END)AS SALEIN,  
        (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_SalesQty  ELSE 0 END) AS SALESOUT,  
       (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_PurchaseQty  ELSE 0 END)AS PURCHASIN,  
       (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_PurchaseQty  ELSE 0 END) AS PURCHASEOUT,  
       2 AS TAGORDER   
  FROM StockRegister SR   
       INNER JOIN MedicineMaster MM  
    ON MM.Mm_ID=SR.Stk_MmId  
       INNER JOIN UomMaster SUOM     
    ON SUOM.Uom_ID=SR.Stk_SalesUom    
       INNER JOIN UomMaster PUOM    
    ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
         
       LEFT JOIN PurchaseInvoiceDetail PID   
    ON PID.Pid_MmId=SR.Stk_MmId AND PID.Pid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PID.Pid_PihKey  
       LEFT JOIN PurchaseInvoiceHeader PIH   
    ON PIH.Pih_Key=PID.Pid_PihKey  
       LEFT JOIN VendorMaster PIVM   
    ON PIVM.Vendor_ID=PIH.Pih_VenId  
     
       LEFT JOIN PurchaseReturnDetail PRD   
    ON PRD.Prd_MmId=SR.Stk_MmId AND PRD.Prd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PRD.Prd_PrhId  
       LEFT JOIN PurchaseReturnHeader PRH   
    ON PRH.Prh_Id=PRD.Prd_PrhId  
       LEFT JOIN VendorMaster PRVM   
    ON PRVM.Vendor_ID=PRH.Prh_VendorId  
      
       LEFT JOIN SalesInvoiceItemDetail SIID   
    ON SIID.Sid_Mm_Id=SR.Stk_MmId AND SIID.Sid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SIID.Sid_Sih_Key  
       LEFT JOIN SalesInvoiceHeader SIH  
    ON SIH.Sih_key=SIID.Sid_Sih_Key  
       LEFT JOIN PatientMaster SIPM   
    ON SIPM.Pm_Id=SIH.Sih_Pm_Id  
      
      
       LEFT JOIN SalesReturnDetail SRD  
    ON SRD.Srd_MmId=SR.Stk_MmId AND SRD.Srd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SRD.Srd_SrhId  
       LEFT JOIN SalesReturnHeader SRH  
    ON SRH.Srh_Id=SRD.Srd_SrhId  
       LEFT JOIN PatientMaster SRPM   
    ON SRPM.Pm_Id=SRH.Srh_CustId  
 WHERE CONVERT(DATE,SR.Stk_Date) BETWEEN CONVERT(DATE,@FROMDATE) AND CONVERT(DATE,@TODATE)  
UNION ALL    
    SELECT 3 AS ID,   
       MM.Mm_Code AS DrugCode,  
       MM.Mm_Name AS DrugName,  
       ISNULL(CLOSINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
       ISNULL(CLOSINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
       CONVERT(varchar,@TODATE,105) AS DATE,  
       ('Closing Stock')AS Description,  
       '' AS SUPPLIERNAME,  
       '' AS BATCHNO,  
       ISNULL((CLOSINGSTOCK.SUPURCHASEQTY-CLOSINGSTOCK.SUSALESQTY),0)AS SALEIN,  
       0 AS SALESOUT,  
       ISNULL((CLOSINGSTOCK.PUPURCHASEQTY-CLOSINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
       0 AS PURCHASEOUT,  
       3 AS TAGORDER  
  FROM  MedicineMaster MM 
        LEFT JOIN
        (SELECT SR.Stk_MmId,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
               SUOM.Uom_Name AS SALESUNIT,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
               SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
               PUOM.Uom_Name AS PURCHASEUNIT    
          FROM StockRegister SR     
               INNER JOIN UomMaster SUOM     
            ON SUOM.Uom_ID=SR.Stk_SalesUom    
               INNER JOIN UomMaster PUOM    
            ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
         WHERE CONVERT(DATE,Stk_Date)<= CONVERT(DATE,@TODATE)    
               GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS CLOSINGSTOCK  
        
     ON MM.Mm_ID=CLOSINGSTOCK.Stk_MmId  
        INNER JOIN UomMaster SSUOM     
     ON SSUOM.Uom_ID=MM.MM_StkUom    
        INNER JOIN UomMaster PPUOM    
     ON PPUOM.Uom_ID=MM.MM_PurchaseUom)AS DT ORDER BY DrugCode,TAGORDER,DATE,ID ASC  
END  
GO
/****** Object:  StoredProcedure [dbo].[SP_SALES_CHALLAN]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
-- [dbo].[SP_SALES_CHALLAN] @SP_STATUS = 'GET_STOCK_WISE_ITEM', @Scd_Mm_Id = 115,@Scd_SalesQty = 10
CREATE PROCEDURE   [dbo].[SP_SALES_CHALLAN]

@SP_STATUS			NVARCHAR(MAX) = '',
@USER				INT  = 0,
@ID					NUMERIC(18,0) = 0  OUT,
@Sc_Key				NUMERIC(18,0) = 0,
@Sc_No				NUMERIC(18,0) =0,
@Sc_Date			[datetime] =NULL,
@Sc_Invtype			[int] =   0,
@Sc_Account			[varchar](50) = '',
@Sc_Pm_Id			NUMERIC(18,0) = 0,
@Sc_Dm_Id			NUMERIC(18,0) = 0,
@Sc_GstType			[int]  = 0,
@Sc_RateType		[int]  = 0,
@Sc_SubTotal		[numeric](18, 3)  =0 ,
@Sc_Total			[numeric](18, 3)  =0,
@Sc_YearId			[bigint] =0,
@Sc_Disc			[numeric](5, 2) = 0,
@Sc_DiscAmount		[numeric](18, 3)= 0,
@Sc_Status			[varchar](15) ='',
@Sc_BranchId		[int] =0,
@Sc_CardPay			[decimal](18, 2) =0,
@Sc_CashPay			[decimal](18, 2) =0,
@Sc_TotalPay		[decimal](18, 3) =0,
@Sc_IsCreditBill	[bit] =0,
@Sc_AccId			[int]  =0 ,
@Sc_BookId			[int] =0,
@Sc_DueDate			[date] = NULL,
@Sc_IsOriginal		[bit] = 0,
@Sc_CardRemarks		[varchar](50) = '',
@Sc_Remark			[varchar](1000) = '',
@Sc_CusRefNo		[varchar](100) ='',
@Sc_IsSync			[bit] =0,
@Sc_LastSyncDate	[datetime] = NULL,
@Sc_Po_Key			NUMERIC(18,0)  =0,
@Sc_LR_NO			[varchar](500)  = '',
@Sc_Lr_Date			[datetime] =NULL,
@Sc_TrasporterName	[nvarchar](max) ='',
@Sc_No_Of_Cases		[int]  =0,
@Sc_Freight_Amount	[numeric](12, 2) =0,

@Scd_Key			NUMERIC(18,0)  = 0,
@Scd_Sch_Key		NUMERIC(18,0)  =0,
@Scd_SrNo			[int] = 0,
@Scd_Mm_Id			NUMERIC(18,0) = 0,
@Scd_MRP			[numeric](12, 2) = 0,
@Scd_BatchNo		[nvarchar](max)  = '',
@Scd_ExpDate		[date] = null,
@Scd_SalesQty		[numeric](12, 3) = '',
@Scd_SalesUomId		[int] = 0,
@Scd_SalesRate		 float = 0,
@Scd_SubTotal		[numeric](12, 2) = 0,
@Scd_Total			[numeric](12, 2) = 0,
@Scd_MnfDate		[date] =  NULL,
@Scd_Disc			[numeric](5, 2)  =0,
@Scd_DiscAmount		[numeric](18, 2)  =0 ,
@Scd_PurchaseQty	[numeric](12, 3) =0,
@Scd_PurchaseUomId	[int] =0,
@Scd_PurchaseRate	[numeric](12, 2) =0,
@Scd_LmId			[int]  = 0,
@Scd_Po_Key			NUMERIC(18,0)  = 0,
@Scd_Po_SrNo		[int]  = 0,
@Sc_StartDate       Date   = null,
@Sc_EndDate			date  = null
	
AS
BEGIN
DECLARE @FROM_DATE	DATETIME
DECLARE @TO_DATE	DATETIME

SELECT	TOP(1)
		@FROM_DATE=A.Year_FromDate,
		@TO_DATE=A.Year_ToDate
FROM	YearMaster A
WHERE	A.Year_IsDef=1

	IF  @SP_STATUS  =  'Insert'
		BEGIN
			SELECT		@Sc_Key = ISNULL(MAX(Sc_Key),0) + 1
			FROM		[SalesChallanHeader](NOLOCK);
			SELECT		@Sc_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sc_No,0)))
			FROM		[SalesChallanHeader](NOLOCK) A
			WHERE		A.Sc_Date BETWEEN @FROM_DATE AND @TO_DATE
		  
			INSERT 
			INTO		[dbo].[SalesChallanHeader]
						([Sc_Key]  ,[Sc_No],[Sc_Date],[Sc_Invtype],[Sc_Account],[Sc_Pm_Id],[Sc_Dm_Id],[Sc_GstType],[Sc_RateType],[Sc_SubTotal],[Sc_Total],[Sc_CreatedBy],[Sc_CreatedDate]
						,[Sc_YearId],[Sc_Disc],[Sc_DiscAmount],[Sc_Status],[Sc_BranchId],[Sc_CardPay],[Sc_CashPay],[Sc_TotalPay],[Sc_IsCreditBill],[Sc_AccId],[Sc_BookId],[Sc_DueDate],[Sc_IsOriginal]
						,[Sc_CardRemarks] ,[Sc_Remark],[Sc_CusRefNo],[Sc_IsSync],[Sc_LastSyncDate],[Sc_Po_Key],[Sc_LR_NO],[Sc_Lr_Date],[Sc_TrasporterName],[Sc_No_Of_Cases],[Sc_Freight_Amount])
			VALUES
						(@Sc_Key  ,@Sc_No ,@Sc_Date ,@Sc_Invtype ,@Sc_Account ,@Sc_Pm_Id ,@Sc_Dm_Id ,@Sc_GstType ,@Sc_RateType ,@Sc_SubTotal ,@Sc_Total ,@USER,GETDATE()
						,@Sc_YearId ,@Sc_Disc  ,@Sc_DiscAmount ,@Sc_Status ,@Sc_BranchId ,@Sc_CardPay ,@Sc_CashPay,@Sc_TotalPay,@Sc_IsCreditBill ,@Sc_AccId,@Sc_BookId ,@Sc_DueDate ,@Sc_IsOriginal 
						,@Sc_CardRemarks  ,@Sc_Remark ,@Sc_CusRefNo ,@Sc_IsSync ,@Sc_LastSyncDate ,@Sc_Po_Key ,@Sc_LR_NO ,@Sc_Lr_Date ,@Sc_TrasporterName ,@Sc_No_Of_Cases ,@Sc_Freight_Amount)
 
			SELECT		@ID = @Sc_Key;
		END

	ELSE IF  @SP_STATUS = 'Update'
		BEGIN
			UPDATE		SalesChallanHeader
		    SET			Sc_Date = @Sc_Date, Sc_Invtype = @Sc_Invtype, Sc_Account = @Sc_Account, Sc_Pm_Id = @Sc_Pm_Id, Sc_Dm_Id = @Sc_Dm_Id, Sc_GstType = @Sc_GstType,
						Sc_RateType = @Sc_RateType, Sc_SubTotal = @Sc_SubTotal, Sc_Total = @Sc_Total, Sc_YearId=@Sc_YearId	
					,Sc_Disc=@Sc_Disc
					,Sc_DiscAmount=@Sc_DiscAmount
					,Sc_Status=@Sc_Status			
					,Sc_BranchId=@Sc_BranchId		
					,Sc_CardPay=@Sc_CardPay			
					,Sc_CashPay=@Sc_CashPay			
					,Sc_TotalPay=@Sc_TotalPay		
					,Sc_IsCreditBill=@Sc_IsCreditBill	
					,Sc_AccId=@Sc_AccId			
					,Sc_BookId=@Sc_BookId			
					,Sc_DueDate=@Sc_DueDate			
					,Sc_IsOriginal=@Sc_IsOriginal		
					,Sc_CardRemarks=@Sc_CardRemarks		
					,Sc_Remark=@Sc_Remark			
					,Sc_CusRefNo=@Sc_CusRefNo		
					,Sc_IsSync=@Sc_IsSync			
					,Sc_LastSyncDate=@Sc_LastSyncDate	
					--,Sc_Po_Key=@Sc_Po_Key			
					,Sc_LR_NO=@Sc_LR_NO			
					,Sc_Lr_Date	=@Sc_Lr_Date			
					,Sc_TrasporterName=@Sc_TrasporterName	
					,Sc_No_Of_Cases=@Sc_No_Of_Cases		
					,Sc_Freight_Amount=@Sc_Freight_Amount	
		   WHERE	Sc_Key =@Sc_Key

		   UPDATE	so
		   SET		--so.Pi_PiQty =  isnull(scid.Scd_SalesQty,0) - isnull(so.Pi_PiQty,0) 
					SO.Pi_Scd_SalesQty=ISNULL(Pi_Scd_SalesQty,0)-ISNULL(scid.QTY,0)
		   FROM		SO_DETAIL   so
		  			LEFT  JOIN (SELECT	Scd_Sch_Key,
										Scd_Po_Key,
										Scd_Mm_Id,
										SUM(Scd_SalesQty) AS QTY 
								FROM	SalesChallenItemDetails
								WHERE	Scd_Sch_Key=@Sc_Key
								GROUP BY Scd_Sch_Key,Scd_Po_Key,Scd_Mm_Id
								)    scid
		   ON			so.Pi_PoKey = scid.Scd_Po_Key
					AND SO.Pi_ItemId=scid.Scd_Mm_Id
		   WHERE		scid.Scd_Sch_Key =@sc_key

		   DELETE    
		   FROM		SalesChallenItemDetails
		   WHERE    Scd_Sch_Key =  @Sc_Key 


		   SELECT   @ID = @Sc_Key;
	END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			UPDATE		so
			SET			so.Pi_PiQty = ISNULL(scid.Scd_SalesQty,0) - ISNULL(so.Pi_PiQty,0) 
			FROM		SO_DETAIL so
			  		LEFT JOIN SalesChallenItemDetails scid
			ON			so.Pi_PoKey = so.Pi_PoKey
			WHERE		scid.Scd_Po_Key > 0
					AND	scid.Scd_Sch_Key =@sc_key

			DELETE  
			FROM		SalesChallanHeader
			WHERE		Sc_Key = @Sc_Key

			DELETE    
			FROM		SalesChallenItemDetails
			WHERE		Scd_Sch_Key = @Sc_Key 
		END


	ELSE IF @SP_STATUS =  'INSERT_SalesChallenItemDetails'
		BEGIN

			iF EXiSTS(	SELECT	* 
						FROM	SO_DETAIL A 
						WHERE		A.Pi_PoKey=@Scd_Po_Key 
								AND A.Pi_SrNo=@Scd_Po_SrNo 
								AND @Scd_SalesQty>(ISNULL(A.Pi_Qty,0)-(ISNULL(A.Pi_Scd_SalesQty,0)+ISNULL(A.Pi_Sid_Qty,0)))
					)
				BEGiN
					RAISERROR('Qty Grater then Order Qty',14,9)
				END
			ELSE
				BEGiN
					SELECT		@Scd_Key = ISNULL(MAX(Scd_Key),0) + 1
					FROM		[SalesChallenItemDetails](NOLOCK);

					INSERT 
					INTO		[dbo].[SalesChallenItemDetails]
								([Scd_Key] ,[Scd_Sch_Key],[Scd_SrNo],[Scd_Mm_Id],[Scd_MRP],[Scd_BatchNo],[Scd_ExpDate],[Scd_SalesQty],[Scd_SalesUomId],
								[Scd_SalesRate],[Scd_SubTotal],[Scd_Total],[Scd_MnfDate],[Scd_Disc],[Scd_DiscAmount],[Scd_PurchaseQty],[Scd_PurchaseUomId],
								[Scd_PurchaseRate],[Scd_LmId],[Scd_Po_Key],Scd_Po_SrNo)
					VALUES
								(@Scd_Key,@Scd_Sch_Key,@Scd_SrNo,@Scd_Mm_Id,@Scd_MRP,@Scd_BatchNo,@Scd_ExpDate,@Scd_SalesQty,@Scd_SalesUomId,
								@Scd_SalesRate,@Scd_SubTotal,@Scd_Total,@Scd_MnfDate,@Scd_Disc,@Scd_DiscAmount,@Scd_PurchaseQty,@Scd_PurchaseUomId,
								@Scd_PurchaseRate,@Scd_LmId ,@Scd_Po_Key,@Scd_Po_SrNo)
			
					UPDATE	SO_DETAIL
					SET		Pi_Scd_SalesQty=ISNULL(Pi_Scd_SalesQty,0)+@Scd_SalesQty
					WHERE		Pi_PoKey=@Scd_Po_Key
							AND Pi_ItemId=@Scd_Mm_Id

					--UPDATE		SO
					--SET			SO.PI_PIQTY =  ISNULL(SO.PI_PIQTY,0)  + @Scd_SalesQty
					--FROM		SO_DETAIL SO
					--			INNER JOIN [SalesChallenItemDetails] SCID
					--ON			SO.PI_POKEY = @Scd_Po_Key
					--WHERE		SCID.SCD_PO_KEY  = @Scd_Sch_Key
				END		

			SELECT		@ID = @Scd_Key;
		END

	ELSE IF @SP_STATUS = 'AutoInvoiceNo'
		BEGIN
			DECLARE		@FormPrefix AS nvarchar(max) = '';
			SELECT		@FormPrefix = FormPrefix
			FROM		FormDetailTable
			WHERE		Id = 17
			SELECT		@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sc_No,0)))
			FROM		SalesChallanHeader(NOLOCK) A
			WHERE		A.Sc_Date BETWEEN @FROM_DATE AND @TO_DATE
		END

	ELSE IF @SP_STATUS = 'BIND_COMBO_FROM'
		BEGIN
			SELECT		19 AS ID, 'Sales Order' AS NAME
			UNION
			SELECT		20 AS ID, 'Sales Challan' AS NAME
		END

	ELSE IF @SP_STATUS = 'Retrive'
		BEGIN
			DECLARE		@FormPrefix_RET AS NVARCHAR(max) = '';
			SELECT		@FormPrefix_RET = FormPrefix
			FROM		FormDetailTable(NOLOCK)
			WHERE		Id = 17

			DECLARE		@FormPrefix_SO AS NVARCHAR(max) = '';
			SELECT		@FormPrefix_SO = FormPrefix
			FROM		FormDetailTable(NOLOCK)
			WHERE		Id = 1

			SELECT		[Sc_Key]  ,   @FormPrefix_RET + CAST ([Sc_No]   AS  nvarchar(MAX))  AS Sc_No ,[Sc_Date],[Sc_Invtype],[Sc_Account],[Sc_Pm_Id],[Sc_Dm_Id],
						[Sc_GstType],[Sc_RateType],[Sc_SubTotal],[Sc_Total],[Sc_CreatedBy],[Sc_CreatedDate],[Sc_YearId],[Sc_Disc],[Sc_DiscAmount],[Sc_Status],
						[Sc_BranchId],[Sc_CardPay],[Sc_CashPay],[Sc_TotalPay],[Sc_IsCreditBill],[Sc_AccId],[Sc_BookId],[Sc_DueDate],[Sc_IsOriginal],
						[Sc_CardRemarks] ,[Sc_Remark],[Sc_CusRefNo],[Sc_IsSync],[Sc_LastSyncDate],[Sc_Po_Key],
						[Sc_LR_NO],[Sc_Lr_Date],[Sc_TrasporterName],[Sc_No_Of_Cases],[Sc_Freight_Amount],
						pm.Pm_Mob,
						PM.Pm_Address,
						PM.Pm_EmailId,
						PM.StoreCode,  
						PM.Pm_Fullname AS  Storename
			FROM		SalesChallanHeader (NOLOCK)  SIH
					LEFT JOIN PatientMaster (NOLOCK) PM
			ON			PM.Pm_Id = SIH.Sc_Pm_Id 
			WHERE       Sc_Key =@Sc_Key

			SELECT      [Scd_Key] ,[Scd_Sch_Key],[Scd_SrNo],scid.[Scd_Mm_Id],[Scd_MRP],scid.[Scd_BatchNo],[Scd_ExpDate],[Scd_SalesQty],[Scd_SalesUomId],[Scd_SalesRate],
						[Scd_SubTotal],[Scd_Total],[Scd_MnfDate],[Scd_Disc],[Scd_DiscAmount],[Scd_PurchaseQty],[Scd_PurchaseUomId],[Scd_PurchaseRate],[Scd_LmId],
						[Scd_Po_Key] ,mm.Mm_Code AS Scd_Mm_Code, mm.Mm_Name AS Scd_Mm_Name ,mm.MM_PackSize  as  Scd_Packsize,
						 @FormPrefix_SO +  CAST(soh.Po_No  AS  nvarchar(MAX))  AS  So_No , sod.Pi_Qty as PiQty ,
						SOH.Po_Key as  Scd_Pi_PoKey ,sod.Pi_SrNo as Scd_Po_SrNo,
						ISNULL(SOD.Pi_Qty,0)-ISNULL(SOD.Pi_Scd_SalesQty,0)+ISNULL(scid.Scd_SalesQty,0)  Pi_BalQty,
						ISNULL(C.Allocated_Challan_Qty,0) AS PI_CH_ALLOCATED_QTY,
						scid.Scd_LmId AS Sid_LmId,
						D.Lm_Name AS Scd_LmName,mm.MM_SalesRatio,
						mm.MM_PurchaseRatio,
						E.Item_Stock as Scd_Stock_Qty,
						E.Item_Stock as Scd_Purchase_Stock_Qty
			FROM		SalesChallenItemDetails (NOLOCK) scid
						LEFT JOIN MedicineMaster (NOLOCK) mm
			ON			mm.Mm_ID = scid.Scd_Mm_Id
						LEFT JOIN UomMaster (NOLOCK)  uom
			ON			uom.Uom_ID =   scid.Scd_SalesUomId
						LEFT JOIN  SO_HEADER   (nolock)   SOH
			ON			SOH.Po_Key   = scid.Scd_Po_Key
						LEFT  JOIN   SO_DETAIL  (nolock) sod
			ON			sod.Pi_PoKey =   SOH.Po_Key
						AND    sod.Pi_SrNo  =  scid.Scd_Po_SrNo
						LEFT JOIN vwChallanAllocated C
			ON				scid.Scd_Mm_Id=C.Scd_Mm_Id	
						AND scid.Scd_BatchNo=C.Scd_BatchNo
						LEFT JOIN LocationMaster D
			ON				scid.Scd_LmId=D.Lm_Id
						LEFT JOIN vwStock E
			ON				scid.Scd_Mm_Id=E.Item_Id
						AND scid.Scd_BatchNo=E.Item_Batchno
			WHERE		Scd_Sch_Key =  @Sc_Key 
		END

	ELSE IF @SP_STATUS = 'FillGrid'
		BEGIN
			DECLARE		@FormPrefix_FILLGRID AS NVARCHAR(max) = '';
			SELECT		@FormPrefix_FILLGRID = FormPrefix
			FROM		FormDetailTable(NOLOCK)
			WHERE		Id = 17

			SELECT		[Sc_Key]  ,   @FormPrefix_FILLGRID + CAST ([Sc_No]   AS  nvarchar(MAX))  AS Sc_No ,[Sc_Date],[Sc_Invtype],[Sc_Account],[Sc_Pm_Id],[Sc_Dm_Id],
						[Sc_GstType],[Sc_RateType],[Sc_SubTotal],[Sc_Total],[Sc_CreatedBy],[Sc_CreatedDate],[Sc_YearId],[Sc_Disc],[Sc_DiscAmount],[Sc_Status],
						[Sc_BranchId],[Sc_CardPay],[Sc_CashPay],[Sc_TotalPay],[Sc_IsCreditBill],[Sc_AccId],[Sc_BookId],[Sc_DueDate],[Sc_IsOriginal],
						[Sc_CardRemarks] ,[Sc_Remark],[Sc_CusRefNo],[Sc_IsSync],[Sc_LastSyncDate],[Sc_Po_Key],
						[Sc_LR_NO],[Sc_Lr_Date],[Sc_TrasporterName],[Sc_No_Of_Cases],[Sc_Freight_Amount],
						ISNULL(SIH.Sc_Total, 0) - ISNULL(SIH.Sc_SubTotal, 0) AS TaxAmount, UM.User_Name  AS SC_USER, PM.Pm_Fullname   
			FROM		SalesChallanHeader (NOLOCK)  SIH
			       LEFT JOIN   UserMaster   (NOLOCK)  UM
			ON          UM.User_ID = SIH.Sc_CreatedBy 
			       LEFT JOIN   PatientMaster  (NOLOCK) PM
			ON          SIH.Sc_Pm_Id = PM.Pm_Id
		 	WHERE		Sc_YearId = @Sc_YearId
					AND CAST(Sc_Date AS DATE) BETWEEN  convert(date,@Sc_StartDate) AND convert(date,@Sc_EndDate)
		END

	ELSE IF @SP_STATUS = 'GET_STOCK_WISE_ITEM'
		BEGIN
			--DECLARE @Scd_Mm_Id INT=507
			--DECLARE @Scd_SalesQty INT=40
			
			IF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_CHALLAN_QTY')
				BEGiN
					DROP TABLE ##TEMP_CHALLAN_QTY
				END
			CREATE TABLE ##TEMP_CHALLAN_QTY(
				Item_Id			BIGINT,
				Item_Batchno	NVARCHAR(500), 
				Item_Stock		NUMERIC(18,2),
				Item_Rate		NUMERIC(18,2),
				Item_ExpDate	DATE,
				Item_MnfDate	DATE,
				Item_MRP		NUMERIC(18,2),
				CummQty			NUMERIC(18,2)
			)
		
			DECLARE @batchNo			NVARCHAR(500)
			DECLARE @CUR_STOCK			NUMERIC(18,2)=0
			DECLARE @AssignQty			NUMERIC(18,2)=0
			DEClARE @Used_Qty_Of_Batch	NUMERIC(18,2)=0

			DECLARE @Item_Id			BIGINT
			DEClARE @Item_Rate			NUMERIC(18,2)=0
			DEClARE @Item_ExpDate		DATE
			DEClARE @Item_MnfDate		DATE
			DEClARE @Item_MRP			NUMERIC(18,2)=0

			--------------Getting Selected Item Batch---------------
			DECLARE CUS CURSOR FOR 
			SELECT	Item_Id,Item_Batchno,Item_Stock,Item_Rate,Item_MRP,Stk_ExpDate,Item_MnfDate FROM vwStock WHERE	Item_Id=@Scd_Mm_Id ORDER BY Item_ExpDate DESC
			OPEN CUS 
			FETCH NEXT FROM CUS iNTO @Item_Id,@batchNo,@CUR_STOCK,@Item_Rate,@Item_MRP,@Item_ExpDate,@Item_MnfDate
			WHILE @@FETCH_STATUS <> -1
				BEGIN
					iF @CUR_STOCK > (@Scd_SalesQty - @AssignQty)
						BEGIN
							SEt @Used_Qty_Of_Batch = (@Scd_SalesQty - @AssignQty)
							SET @AssignQty = @AssignQty + (@Scd_SalesQty - @AssignQty)
						END
					ELSE
						BEGIN
							SET @Used_Qty_Of_Batch=@CUR_STOCK
							SET @AssignQty=@AssignQty+@CUR_STOCK
						END
					iNSERT iNTO ##TEMP_CHALLAN_QTY(Item_Id,Item_Batchno,Item_Stock,Item_Rate,Item_ExpDate,Item_MnfDate,Item_MRP,CummQty)
					SELECT @Item_Id,@batchNo,@CUR_STOCK,@Item_Rate,@Item_ExpDate,@Item_MnfDate,@Item_MRP,@Used_Qty_Of_Batch

					--SELECT @Item_Id,@batchNo,@CUR_STOCK,@AssignQty AS AssignQty,@Used_Qty_Of_Batch AS UsedBatchQty
					FETCH NEXT FROM CUS iNTO @Item_Id,@batchNo,@CUR_STOCK,@Item_Rate,@Item_MRP,@Item_ExpDate,@Item_MnfDate
				END
				CLOSE CUS
				DEALLOCATE CUS
			---------------------------------------------
			SELECT	A.*,
					ISNULL(B.Allocated_Challan_Qty,0) AS PI_CH_ALLOCATED_QTY,
					C.Lm_Name,
					C.Stk_LmId,
					D.MM_SalesRatio,
					D.MM_PurchaseRatio
			FROM	##TEMP_CHALLAN_QTY A
					LEFT JOIN vwChallanAllocated B
			ON			A.Item_Id=B.Scd_Mm_Id
					AND A.Item_Batchno=B.Scd_BatchNo
					LEFT JOIN vwStock C
			ON			A.Item_Id=C.Item_Id
					AND A.Item_Batchno=C.Item_Batchno
					iNNER JOIN MedicineMaster D
			ON			A.Item_Id=D.Mm_ID
			WHERE		ISNULL(CummQty,0)>0

			--SELECT		* FROM(SELECT *,ISNULL(LAG(CummQty) OVER (ORDER BY Item_Id),0) AS preval FROM (
			--SELECT		Item_Id,Item_Batchno, Item_Stock,Item_Rate,Item_ExpDate,Item_MnfDate,Item_MRP, @Scd_SalesQty - SUM(Item_Stock) OVER (ORDER BY Item_Id,Item_BatchNo) AS CummQty
			--FROM		[vwStock] (NOLOCK) 
			--WHERE		Item_Id = @Scd_Mm_Id)T)T1
			--WHERE		ABS(CummQty) - ABS(ISNULL(preval,0)) <> Item_Stock


			--SELECT		*,ISNULL(LAG(CummQty) OVER (ORDER BY Item_Id),0) AS preval from (
			--SELECT		Item_Id,Item_Batchno, Item_Stock, @Scd_SalesQty - SUM(Item_Stock) OVER (ORDER BY Item_Id) AS CummQty
			--FROM		[vwStock] (NOLOCK) 
			--WHERE		Item_Id = @Scd_Mm_Id)T

			----SELECT		*
			--			--,LAG(CummQty) OVER (ORDER BY Item_Id) as preval 
			--			--from (
			--SELECT		Item_Id,Item_Batchno, Item_Stock,Stk_ExpDate,Item_Rate,Item_MRP,Stk_MnfDate, @Scd_SalesQty - SUM(Item_Stock) OVER (ORDER BY Item_Id) AS CummQty
			--FROM		[vwStock] (NOLOCK) 
			--WHERE		Item_Id = @Scd_Mm_Id --)T

		END
	ELSE iF @SP_STATUS='GET_BATCH_DETAILS_SELECTION'
		BEGiN
			SELECT	DISTINCT
					A.Item_Batchno,
					A.Item_Batchno+' - ' +CONVERT(VARCHAR(250),A.Item_Stock)  AS Batch_NO_With_Qty
			FROM	vwStock A
			WHERE	A.Item_Id=@Scd_Mm_Id
		END
	ELSE IF @SP_STATUS = 'GetItemDetailOriginal'
		BEGIN
			SELECT		ROW_NUMBER () OVER (ORDER BY Scd.Scd_Key ASC) AS SR_NO, Scd.Scd_Key, Scd.Scd_Sch_Key, Scd.Scd_SrNo, Scd.Scd_Mm_Id
				,mm.Mm_HsnCode AS Scd_HsnCode
				,sch.Sc_No
				,--Scd.Scd_PackId,
				Scd.Scd_MRP
				,Scd.Scd_BatchNo
				,
				(CASE WHEN ISNULL(Scd.Scd_ExpDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,Scd.Scd_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,Scd.Scd_ExpDate)),2)
				END)AS Scd_ExpDate
				,Scd.Scd_SalesQty AS Scd_Qty
				,Scd.Scd_SalesRate AS Scd_Rate
				,Scd.Scd_SubTotal
				,Scd.Scd_Total
				,(CASE WHEN ISNULL(Scd.Scd_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,Scd.Scd_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,Scd.Scd_MnfDate)),2) 
				END)AS Scd_MnfDate
				,Scd.Scd_Disc
				,Scd.Scd_DiscAmount
				,mm.Mm_Code as Mm_Code
				,mm.Mm_Name AS MedicineName
				,um.Uom_Name
				,pm.Pm_Fullname AS Sih_PatientName
				,pm.Pm_Mob AS Sih_PatientMob
				,(CASE WHEN ISNULL(sch.Sc_Date,'')=''
					THEN ''
					ELSE CONVERT(VARCHAR,sch.Sc_Date, 105) 
				END)AS Sc_Date
				,sch.Sc_DiscAmount
				,sch.Sc_SubTotal
				,sch.Sc_Total
				,0.00 AS OtherBrandRate
				,BM.Branch_Name
				,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
				,BM.Branch_Logo AS BranchLogo
				,BM.Branch_GstNo AS BranchGSTNO
				,CM.City_Name AS BranchCity
				,mm.MM_PackSize AS Scd_PackSize
				,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
				,convert(decimal(18,2),isnull(TAX.SGST,0)) as SGST
				,convert(decimal(18,2),isnull(TAX.CGST,0)) as CGST
				,convert(decimal(18,2),isnull(TAX.IGST,0)) as IGST
				,convert(decimal(18,2),isnull(TAX.SGSTPer,0)) as SGSTPer
				,convert(decimal(18,2),isnull(TAX.CGSTPer,0)) as CGSTPer
				,convert(decimal(18,2),isnull(TAX.IGSTPer,0)) as IGSTPer
				,
					pm.Drug_Lic as DrugLic,
					pm.Gst_no as  GstNo,
					pm.StoreCode as  Store_Code 
					, pm.Contact_PersonName as  ContactPerson,
					0  as  CopyOrder,
					STORECM.City_Name  AS StoreCity,
					dbo.TowordsWithPaisa(isnull(sch.Sc_Total,0),'') as AmtInWords,
					pm.Pm_Address,
					pm.Pm_Mob ,
					pm.Pm_PanNo,
					SM.Store_MobNo 

		
			FROM dbo.SalesChallenItemDetails(NOLOCK) scd
			LEFT JOIN TaxTransaction(NOLOCK) STAX ON scd.Scd_Key = STAX.Tr_DdocKey
				AND scd.Scd_Sch_Key = STAX.Tr_DocKey
				AND STAX.Tr_TxId = 2
				AND STAX.Tr_DocTyp = 20
			LEFT JOIN TaxTransaction(NOLOCK) CTAX ON scd.Scd_Key = CTAX.Tr_DdocKey
				AND scd.Scd_Sch_Key = CTAX.Tr_DocKey
				AND CTAX.Tr_DocTyp = 20
				AND CTAX.Tr_TxId = 3
			LEFT JOIN TaxTransaction(NOLOCK) ITAX ON scd.Scd_Key = ITAX.Tr_DdocKey
				AND scd.Scd_Sch_Key = ITAX.Tr_DocKey
				AND ITAX.Tr_DocTyp = 20
				AND ITAX.Tr_TxId = 4
			LEFT JOIN dbo.SalesChallanHeader(NOLOCK) sch ON scd.Scd_Sch_Key = sch.Sc_Key
			LEFT JOIN (
				SELECT SCD1.Scd_Key
					,SUM(SSTAX.Tr_TxTot) AS SGST,SSTAX.Tr_TxVal as SGSTPer
					,SUM(CCTAX.Tr_TxTot) AS CGST,CCTAX.Tr_TxVal as CGSTPer
					,SUM(IITAX.Tr_TxTot) AS IGST,IITAX.Tr_TxVal as IGSTPer
				FROM dbo.SalesChallenItemDetails(NOLOCK) SCD1
						INNER JOIN SalesChallanHeader SCH1
					ON SCH1.Sc_Key=SCD1.Scd_Sch_Key
				LEFT JOIN TaxTransaction(NOLOCK) SSTAX ON SCD1.Scd_Key = SSTAX.Tr_DdocKey
				AND SCD1.Scd_Sch_Key = SSTAX.Tr_DocKey
				AND SSTAX.Tr_TxId = 2
				AND SSTAX.Tr_DocTyp = 20
			LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SCD1.Scd_Key = CCTAX.Tr_DdocKey
				AND SCD1.Scd_Sch_Key = CCTAX.Tr_DocKey
				AND CCTAX.Tr_DocTyp = 20
				AND CCTAX.Tr_TxId = 3
			LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SCD1.Scd_Key = IITAX.Tr_DdocKey
				AND SCD1.Scd_Sch_Key = IITAX.Tr_DocKey
				AND IITAX.Tr_DocTyp = 20
				AND IITAX.Tr_TxId = 4
				GROUP BY SCD1.Scd_Key,SSTAX.Tr_TxVal,CCTAX.Tr_TxVal,IITAX.Tr_TxVal
				) AS TAX 
			ON SCD.Scd_Key = TAX.Scd_Key
			LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON scd.Scd_Mm_Id = mm.Mm_ID
			LEFT JOIN dbo.UomMaster (NOLOCK) as um on mm.Mm_StkUom=um.Uom_ID
			LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON sch.Sc_Pm_Id = pm.Pm_Id
			LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON sch.Sc_BranchId = BM.Branch_Id
			LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
			LEFT JOIN StoreMaster (NOLOCK) SM  on  sm.Store_Id =   pm.StoreId
			LEFT  JOIN  CityMaster (NOLOCK) STORECM   ON   STORECM.City_ID =  SM.Store_CityId 
			WHERE scd.Scd_Sch_Key =@Sc_Key;
		END
	
END



GO
/****** Object:  StoredProcedure [dbo].[SP_SalesInvoice]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec SP_SalesInvoice @SP_STATUS='SalesDetailForReportWithFilter'
CREATE PROCEDURE [dbo].[SP_SalesInvoice] 
	@SP_STATUS VARCHAR(200) = ''
	,@Sih_Key NUMERIC(18,0) = 0
	,@Sih_No NUMERIC(18, 0) = 0
	,@Sih_Date DATETIME = NULL
	,@Sih_Invtype INT = 0
	,@Sih_Account VARCHAR(50) = ''
	,@Sih_Pm_Id NUMERIC(18,0) = 0
	,@Sih_Dm_Id NUMERIC(18,0) = 0
	,@Sih_GstType INT = 0
	,@Sih_RateType INT = 0
	,@Sih_SubTotal NUMERIC(18, 2) = 0
	,@Sih_Total NUMERIC(18, 2) = 0
	,@Sih_CreatedBy INT = 0
	,@Sih_YearId INT = 0
	,@Sih_BranchId INT = 0
	,@Sih_Disc NUMERIC(5, 2) = 0
	,@Sih_DiscAmount NUMERIC(18, 2) = 0
	,@Sih_CusRefNo VARCHAR(100) = NULL
	,
	@Sih_Po_Key  NUMERIC(18,0)  = 0,
	------------------------------
	@Sid_Key NUMERIC(18,0) = 0
	,@Sid_Sih_Key NUMERIC(18,0) = 0
	,@Sid_SrNo INT = 0
	,@Sid_Mm_Id NUMERIC(18,0) = 0
	,@Sid_MRP NUMERIC(12, 2) = 0
	,@Sid_BatchNo NVARCHAR(max) = ''
	,@Sid_ExpDate DATE = NULL
	,@Sid_SalesQty NUMERIC(12, 3) = 0
	,@Sid_SalesRate NUMERIC(12, 4) = 0
	,@Sid_SalesUomId INT = 0
	,@Sid_PurchaseQty NUMERIC(12, 3) = 0
	,@Sid_PurchaseRate NUMERIC(12, 2) = 0
	,@Sid_PurchaseUomId INT = 0
	,@Sid_SubTotal NUMERIC(12, 2) = 0
	,@Sid_Total NUMERIC(12, 2) = 0
	,@Sid_MnfDate DATE = NULL
	,@Sid_Disc NUMERIC(5, 2) = 0
	,@Sid_DiscAmount NUMERIC(18, 2) = 0
	,@DocType INT = 0
	,@Sih_CardPay NUMERIC(18, 2) = 0
	,@Sih_CashPay NUMERIC(18, 2) = 0
	,@Sih_TotalPay NUMERIC(18, 2) = 0
	,@Sih_IsCreditBill BIT = 0
	,@Sih_AccId INT = 0
	,@Sih_BookID INT = 0
	,@Sih_DueDate DATE = NULL
	,@Sih_IsOriginal BIT = 0
	,@Sid_LmId INT = 0
	,@Sih_CardRemarks VARCHAR(50) = NULL
	,@Sih_Remark VARCHAR(1000) = NULL
	,@DefaultNoGap NVARCHAR(10) = ''
	,@DefaultNoDigits INT = 0
	,@DefaultValue NVARCHAR(10) = ''
	,@ID NUMERIC(18,0) = 0 OUTPUT
	,@DirectPrint  bit=0
	,@IsActive	bit=0
	,@Reportid     INT = 0
	,@Sih_StartDate datetime = NULL
	,@Sih_EndDate datetime = NULL
	,@Sid_Po_Key    NUMERIC(18,0)  =  0,
	@Sih_LR_NO [int] = 0,
	@Sih_Lr_Date [datetime]=  NULL,
	@Sih_TrasporterName [nvarchar](max)  = '',
	@Sih_No_Of_Cases [int] = 0,
   @Sih_Freight_Amount	NUMERIC(12,2)=0,
   @Tr_DocKey NUMERIC(18,0) = 0,
   @Tr_TxId int = 0,
   @Tr_DocType int = 0,
   @Sih_Type int=0
AS
DECLARE @Count INT
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME
	DECLARE @LAST_KEY	BIGINT

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1

	SELECT	TOP(1)	
			@LAST_KEY=ISNULL(DOC_KEY,0)
	FROM	YEAR_END_LAST_DOCUMNT_KEY
	WHERE	DOC_TYPE='SINV'

	IF @SP_STATUS = 'BIND_ITEM'
	BEGIN
		if @DirectPrint=0
		begin ------for sales invoice 
			if @Sih_Remark <>''
			begin
					Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0 and Item_Code = @Sih_Remark
					union all 
					Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0
					and Item_Code like @Sih_Remark+'%' and  Item_Code <> @Sih_Remark
					union all
					SELECT *,vwStock.Item_Stock AS OldStock
					FROM dbo.vwStock(NOLOCK)
					WHERE Item_Stock > 0
					--and(Item_Name like '%' + @Sih_Remark +'%' or Item_Batchno like @Sih_Remark+'%')
					and(Item_Name like @Sih_Remark +'%' or Item_Batchno like @Sih_Remark+'%')
					and Item_Code not like @Sih_Remark+'%' 
					and Item_Code <> @Sih_Remark 
			end
			else
			begin
					SELECT	*,vwStock.Item_Stock AS OldStock
					FROM dbo.vwStock(NOLOCK)
					WHERE Item_Stock > 0
					ORDER BY Stk_ExpDate;

					--SELECT	*,vwStock.Item_Stock AS OldStock,StockRegister.Stk_BatchNo,StockRegister.Stk_MmId 
					--FROM dbo.vwStock(NOLOCK)
					--inner join StockRegister 
					--on dbo.vwStock.Item_Id=StockRegister.Stk_MmId and dbo.vwStock.Item_Batchno=StockRegister.Stk_BatchNo
					--WHERE Item_Stock > 0
					--ORDER BY vwStock.Stk_ExpDate;


					

			end
		end
		else-------for Opening stock items only in Purchase return
		begin
		
			IF(@Reportid=0)
			BEGIN
					SELECT	*,vwStock.Item_Stock AS OldStock
					FROM dbo.vwStock(NOLOCK)
					inner join StockRegister 
					on dbo.vwStock.Item_Id=StockRegister.Stk_MmId and dbo.vwStock.Item_Batchno=StockRegister.Stk_BatchNo and StockRegister.Stk_DocType=6
					
					ORDER BY dbo.vwStock.Stk_ExpDate;
			END
			ELSE
			BEGIN
					DECLARE @VendorTypeId INT
					SET @VendorTypeId=(SELECT Vendor_Vt_Id FROM VendorMaster WHERE Vendor_ID=@Reportid);
					IF(@VendorTypeId=1)
					BEGIN
						SELECT	*,vwStockWithExp.Item_Stock AS OldStock
						FROM dbo.vwStockWithExp(NOLOCK)
						inner join StockRegister 
						on dbo.vwStockWithExp.Item_Id=StockRegister.Stk_MmId and dbo.vwStockWithExp.Item_Batchno=StockRegister.Stk_BatchNo and StockRegister.Stk_DocType=6
						INNER JOIN MedicineMaster MM
						ON MM.Mm_ID=StockRegister.Stk_MmId
						WHERE 
						dbo.vwStockWithExp.Item_Stock > 0   
						AND MM.Mm_MtmId=1 
						ORDER BY dbo.vwStockWithExp.Stk_ExpDate;
					END
					ELSE
					BEGIN
						SELECT	*,vwStockWithExp.Item_Stock AS OldStock
						FROM dbo.vwStockWithExp(NOLOCK)
						inner join StockRegister 
						on dbo.vwStockWithExp.Item_Id=StockRegister.Stk_MmId and dbo.vwStockWithExp.Item_Batchno=StockRegister.Stk_BatchNo and StockRegister.Stk_DocType=6
						INNER JOIN MedicineMaster MM
						ON MM.Mm_ID=StockRegister.Stk_MmId
						WHERE dbo.vwStockWithExp.Item_Stock > 0   AND MM.Mm_MtmId=2 
						ORDER BY dbo.vwStockWithExp.Stk_ExpDate;
					END
					
					
			END
		end
	END;
	ELSE IF @SP_STATUS = 'AutoInvoiceNo'
	BEGIN

		DECLARE	@FormPrefix AS NVARCHAR(max) = '';
		SELECT	@FormPrefix = FormPrefix
		FROM	FormDetailTable(NOLOCK)
		WHERE	Id = 3
		SELECT	@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sih_No, 0)))
		FROM	SalesInvoiceHeader(NOLOCK)A
		WHERE	A.Sih_Date BETWEEN @FROM_DATE AND @TO_DATE
				AND A.Sih_Key>ISNULL(@LAST_KEY,0)
	END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
	BEGIN
		DECLARE @MSG_OUT1 NVARCHAR(max)
		EXEC [SP_Tbl_Dependency1] 'SalesInvoiceItemDetail'
			,@Sid_BatchNo
			,@MSG_OUT1 OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
		BEGIN
			RAISERROR (
					@MSG_OUT1
					,14
					,9
					)
		END
	END
	ELSE IF @SP_STATUS = 'CheckAmountPaidOrNot'
	BEGIN
		SELECT *
		FROM AccountTransaction
		WHERE Act_DocType = 2
			AND Act_DocKey = @Sih_Key
	END
	ELSE IF @SP_STATUS = 'FillInvoiceType'
	BEGIN
		SELECT Sim_Id
			,Sim_Name
		FROM SalesInvoiceTypeMaster(NOLOCK)
		WHERE Sim_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'GetAllInvoiceNo'
	BEGIN
		SELECT Sih_No
			,Sih_Key
		FROM SalesInvoiceHeader(NOLOCK)
	END;
	ELSE IF @SP_STATUS = 'UpdatePrintFlag'
	BEGIN
		UPDATE SalesInvoiceHeader
		SET Sih_IsOriginal = 1
		WHERE Sih_Key = @Sid_Sih_Key
	END
	ELSE IF @SP_STATUS = 'FillGstType'
	BEGIN
		SELECT Gtm_Id
			,Gtm_Name
		FROM dbo.GSTTypeMaster(NOLOCK)
		WHERE Gtm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'FillBindInvoiceRateType'
	BEGIN
		SELECT Irm_Id
			,Irm_Name
		FROM dbo.InvoiceRateTypeMaster(NOLOCK)
		WHERE Irm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
		SELECT	@Sih_Key = ISNULL(MAX(Sih_Key), 0) + 1
		FROM	SalesInvoiceHeader(NOLOCK);
		SELECT	@Sih_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sih_No, 0)))
		FROM	SalesInvoiceHeader(NOLOCK) A
		WHERE		A.Sih_Date BETWEEN @FROM_DATE AND @TO_DATE 
				AND A.Sih_Key>ISNULL(@LAST_KEY,0)

		INSERT dbo.SalesInvoiceHeader (
			Sih_Key
			,Sih_No
			,Sih_Date
			,Sih_Invtype
			,Sih_Account
			,Sih_Pm_Id
			,Sih_Dm_Id
			,Sih_GstType
			,Sih_RateType
			,Sih_SubTotal
			,Sih_Total
			,Sih_CreatedBy
			,Sih_CreatedDate
			,Sih_YearId
			,Sih_BranchId
			,Sih_Disc
			,Sih_DiscAmount
			,Sih_CardPay
			,Sih_CashPay
			,Sih_TotalPay
			,Sih_IsCreditBill
			,Sih_AccId
			,Sih_BookID
			,Sih_DueDate
			,Sih_CardRemarks
			,Sih_IsOriginal
			,Sih_Remark
			,Sih_CusRefNo
			,Sih_IsSync---Synch Status false on Add-Add Hasmukh
			)
		VALUES (
			@Sih_Key
			,-- Sih_Key - bigint
			@Sih_No
			,-- Sih_No - varchar(20)
			@Sih_Date
			,-- Sih_Date - datetime
			@Sih_Invtype
			,-- Sih_Invtype - int
			''
			,-- Sih_Account - varchar(50)
			@Sih_Pm_Id
			,-- Sih_Pm_Id - bigint
			@Sih_Dm_Id
			,-- Sih_Dm_Id - bigint
			@Sih_GstType
			,-- Sih_GstType - int
			@Sih_RateType
			,-- Sih_RateType - int
			@Sih_SubTotal
			,-- Sih_SubTotal - numeric(18, 2)
			@Sih_Total
			,-- Sih_Total - numeric(18, 2)
			@Sih_CreatedBy
			,-- Sih_CreatedBy - int
			GETDATE()
			,@Sih_YearId
			,@Sih_BranchId
			,-- Sih_CreatedDate - datetime
			@Sih_Disc
			,@Sih_DiscAmount
			,@Sih_CardPay
			,@Sih_CashPay
			,@Sih_TotalPay
			,@Sih_IsCreditBill
			,@Sih_AccId
			,@Sih_BookID
			,@Sih_DueDate
			,@Sih_CardRemarks
			,@Sih_IsOriginal
			,@Sih_Remark
			,@Sih_CusRefNo
			,'false'
			);
		SELECT @ID = @Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'CheckEntryForSalesReturn'
		BEGIN
			DECLARE @MSG_OUT_CHECK NVARCHAR(max)
			EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
				,@Sih_Key
				,@MSG_OUT_CHECK OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_CHECK)) <> '')
			BEGIN
				RAISERROR (
						@MSG_OUT_CHECK
						,14
						,9
						)
			END
			ELSE
			BEGIN
				SELECT @ID = @Sih_Key;
			END;
		END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
		DECLARE @MSG_OUT_UPDATE NVARCHAR(max)
		EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
			,@Sih_Key
			,@MSG_OUT_UPDATE OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT_UPDATE)) <> '')
			BEGIN
				RAISERROR (
						@MSG_OUT_UPDATE
						,14
						,9
						)
			END
		ELSE
			UPDATE [dbo].[SalesInvoiceHeader]
			SET Sih_Date = @Sih_Date
				,Sih_Invtype = @Sih_Invtype
				,Sih_Account = @Sih_Account
				,Sih_Pm_Id = @Sih_Pm_Id
				,Sih_Dm_Id = @Sih_Dm_Id
				,Sih_GstType = @Sih_GstType
				,Sih_RateType = @Sih_RateType
				,Sih_SubTotal = @Sih_SubTotal
				,Sih_Total = @Sih_Total
				,Sih_UpdatedBy = @Sih_CreatedBy
				,Sih_UpdatedOn = GETDATE()
				,Sih_Disc = @Sih_Disc
				,Sih_DiscAmount = @Sih_DiscAmount
				,Sih_YearId = @Sih_YearId
				,Sih_BranchId = @Sih_BranchId
				,Sih_CardPay = @Sih_CardPay
				,Sih_CashPay = @Sih_CashPay
				,Sih_TotalPay = @Sih_TotalPay
				,Sih_IsCreditBill = @Sih_IsCreditBill
				,Sih_AccId = @Sih_AccId
				,Sih_BookID = @Sih_BookID
				,Sih_DueDate = @Sih_DueDate
				,Sih_CardRemarks = @Sih_CardRemarks
				,Sih_Remark = @Sih_Remark
				,Sih_CusRefNo = @Sih_CusRefNo
				,Sih_IsSync='false'---Synch Status false on update-Add Hasmukh
			WHERE Sih_Key = @Sih_Key;

		DELETE FROM dbo.SalesInvoiceItemDetail WHERE Sid_Sih_Key = @Sih_Key;
		DELETE FROM dbo.StockRegister WHERE Stk_DocKey = @Sih_Key AND Stk_DocType = @DocType;
		DELETE FROM dbo.TaxTransaction	WHERE Tr_DocId=@Sih_Key and  Tr_DocTyp= @DocType

		SELECT @ID = @Sih_Key;
	END
	ELSE IF @SP_STATUS = 'Delete_SalesInvoiceHeader'
	BEGIN
		DECLARE @MSG_OUT NVARCHAR(max)
		EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
			,@Sih_Key
			,@MSG_OUT OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
			RAISERROR (
					@MSG_OUT
					,14
					,9
					)
		END
		ELSE
		BEGIN
			DELETE
			FROM dbo.SalesInvoiceHeader
			WHERE Sih_Key = @Sih_Key;
			SELECT @ID = @Sih_Key;
		END
	END
	ELSE IF @SP_STATUS = 'Insert_SalesInvoiceItemDetail'
		BEGIN
			iF EXiSTS(
						SELECT	Stk_MmId,
								ISNULL(Stk_BatchNo,'') AS Stk_BatchNo,
								SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_SalesQty ELSE 0 END-
									CASE WHEN Stk_Tran_Typ='D' THEN Stk_SalesQty ELSE 0 END) AS BAL
						FROM	StockRegister A
						WHERE	A.Stk_MmId=@Sid_Mm_Id AND ISNULL(Stk_BatchNo,'')=@Sid_BatchNo
						GROUP BY Stk_MmId,ISNULL(Stk_BatchNo,'')
						HAVING		@Sid_SalesQty>SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_SalesQty ELSE 0 END-
									CASE WHEN Stk_Tran_Typ='D' THEN Stk_SalesQty ELSE 0 END)
						)
				BEGiN
					DECLARE		@Negative VARCHAR(MAX)='Stock going on nagative: SP Validation'
					SET			@Negative=@Negative+','+(SELECT			TOP	1 
																		'Drug Code :'+ ISNULL(B.Mm_Code,'')+ ' & Batch No'+ + ISNULL(Stk_BatchNo,'') AS Neg
															FROM		StockRegister A
																		INNER JOIN MedicineMaster B
															ON			B.Mm_ID=A.Stk_MmId
															WHERE		A.Stk_MmId=@Sid_Mm_Id AND ISNULL(Stk_BatchNo,'')=@Sid_BatchNo
															GROUP BY	Stk_MmId,ISNULL(Stk_BatchNo,''),B.Mm_Code
															HAVING		@Sid_SalesQty>SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_SalesQty ELSE 0 END-
																		CASE WHEN Stk_Tran_Typ='D' THEN Stk_SalesQty ELSE 0 END))

					RAISERROR(@Negative,14,9)
				END
			ELSE	
				BEGiN
					SELECT	@Sid_Key = ISNULL(MAX(Sid_Key), 0) + 1
					FROM	SalesInvoiceItemDetail(NOLOCK);
					INSERT dbo.SalesInvoiceItemDetail (
											Sid_Key
											,Sid_Sih_Key
											,Sid_SrNo
											,Sid_Mm_Id
											,Sid_MRP
											,Sid_BatchNo
											,Sid_ExpDate
											,Sid_SalesQty
											,Sid_SalesRate
											,Sid_SubTotal
											,Sid_Total
											,Sid_MnfDate
											,Sid_Disc
											,Sid_DiscAmount
											,Sid_SalesUomId
											,Sid_PurchaseQty
											,Sid_PurchaseUomId
											,Sid_PurchaseRate
											,Sid_LmId
								)
							VALUES (
								@Sid_Key
								,-- Sid_Key - bigint
								@Sid_Sih_Key
								,-- Sid_Sih_Key - bigint
								@Sid_SrNo
								,-- Sid_SrNo - int
								@Sid_Mm_Id
								,-- Sid_Mm_Id - bigint
								@Sid_MRP
								,-- Sid_MRP - numeric(12, 2)
								ISNULL(@Sid_BatchNo,'')
								,-- Sid_BatchNo - nvarchar(50)
								@Sid_ExpDate
								,-- Sid_ExpDate - date
								@Sid_SalesQty
								,-- Sid_Qty - numeric(12, 3)
								@Sid_SalesRate
								,-- Sid_Rate - numeric(12, 2)
								@Sid_SubTotal
								,-- Sid_SubTotal - numeric(12, 2)
								@Sid_Total
								,@Sid_MnfDate
								,-- Sid_Total - numeric(12, 2)
								@Sid_Disc
								,@Sid_DiscAmount
								,@Sid_SalesUomId
								,@Sid_PurchaseQty
								,@Sid_PurchaseUomId
								,@Sid_PurchaseRate
								,@Sid_LmId
								);
					SELECT @ID = @Sid_Key;
				END
		END;
	ELSE IF @SP_STATUS = 'Delete_SalesInvoiceItemDetail'
	BEGIN
		DELETE
		FROM dbo.SalesInvoiceItemDetail
		WHERE Sid_Sih_Key = @Sid_Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'FillGrid'
	BEGIN
		DECLARE @FormPrefix_Fill_Grid AS NVARCHAR(max) = '';
		SELECT @FormPrefix_Fill_Grid = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 3
		SELECT si.Sih_Key
			,@FormPrefix_Fill_Grid + CAST(si.Sih_No AS NVARCHAR(max)) AS Sih_No
			,si.Sih_Date
			,si.Sih_Invtype
			,si.Sih_Account
			,si.Sih_Pm_Id
			,si.Sih_Dm_Id
			,si.Sih_GstType
			,si.Sih_RateType
			,si.Sih_SubTotal
			,si.Sih_Total
			,si.Sih_CreatedBy
			,si.Sih_CreatedDate
			,si.Sih_UpdatedBy
			,si.Sih_UpdatedOn
			,si.Sih_YearId
			,si.Sih_Disc
			,si.Sih_DiscAmount
			,dm.Dm_Name
			,pm.Pm_Fullname
			,Sih_user.User_Name AS Sih_user
			,ISNULL(si.Sih_Total, 0) - ISNULL(si.Sih_SubTotal, 0) AS TaxAmount
			,SUM(ISNULL(Act_PaidAmount, 0)) AS Act_PaidAmount
			,si.Sih_IsCreditBill
			,Sih_CusRefNo
			,Sih_SRStatus---Add Hasmukh
			,(CASE WHEN Sih_IsSync='false' THEN 'NO' ELSE 'YES' END)AS Sih_SynchStatus---Synch Status Display In List--Add Hasmukh
		FROM SalesInvoiceHeader(NOLOCK) si
		---Start Add Hasmukh
		     LEFT JOIN (SELECT Sih_Key,
		                  (CASE WHEN SUM(ISNULL(SRD.Srd_Qty,0))>0 THEN 'false' ELSE 'true' END)AS Sih_SRStatus
		             FROM SalesInvoiceHeader si1
					      LEFT JOIN SalesReturnHeader SRH ON SRH.Srh_SihKey=si1.Sih_Key
						  LEFT JOIN SalesReturnDetail SRD ON SRD.Srd_SrhId=SRH.Srh_Id
						  GROUP BY si1.Sih_Key)AS SalesReturnStatus
		ON SalesReturnStatus.Sih_Key=si.Sih_Key
		---End Add Hasmukh
		LEFT JOIN dbo.DoctorMaster dm ON si.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.PatientMaster pm ON si.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.UserMaster(NOLOCK) Sih_user ON si.Sih_CreatedBy = Sih_user.User_ID
		LEFT JOIN AccountTransaction act ON Act_DocNo = si.Sih_No
			AND Act_DocKey = si.Sih_Key
			AND Act_DocType = 2
		WHERE Sih_YearId = @Sih_YearId
	and CAST(Sih_Date AS DATE) BETWEEN  convert(date,@Sih_StartDate) and convert(date,@Sih_EndDate)
		GROUP BY si.Sih_Key
			,si.Sih_No
			,si.Sih_Date
			,si.Sih_Invtype
			,si.Sih_Account
			,si.Sih_Pm_Id
			,si.Sih_Dm_Id
			,si.Sih_GstType
			,si.Sih_RateType
			,si.Sih_SubTotal
			,si.Sih_Total
			,si.Sih_CreatedBy
			,si.Sih_CreatedDate
			,si.Sih_UpdatedBy
			,si.Sih_UpdatedOn
			,si.Sih_YearId
			,si.Sih_Disc
			,si.Sih_DiscAmount
			,dm.Dm_Name
			,pm.Pm_Fullname
			,Sih_user.User_Name
			,Sih_IsCreditBill
			,Sih_CusRefNo
			,Sih_SRStatus---Add Hasmukh
			,Sih_IsSync---Add Hasmukh
		ORDER BY si.Sih_Key DESC;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	BEGIN
		DECLARE @MSG_OUT2 NVARCHAR(max)
		EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
			,@Sih_Key
			,@MSG_OUT2 OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT2)) <> '')
		BEGIN
			RAISERROR (
					@MSG_OUT2
					,14
					,9
					)
		END
		ELSE
		BEGIN
			DELETE
			FROM [dbo].SalesInvoiceHeader
			WHERE Sih_Key = @Sih_Key;
			DELETE
			FROM [dbo].SalesInvoiceItemDetail
			WHERE Sid_Sih_Key = @Sih_Key;

			DELETE FROM TaxTransaction 
			WHERE Tr_DocKey=@Sih_Key
			AND Tr_DocTyp=@DocType;---Add Hasmukh

			DELETE
			FROM [dbo].StockRegister
			WHERE Stk_DocKey = @Sih_Key
				AND Stk_DocType = @DocType;
		END;
	END;
	ELSE IF @SP_STATUS = 'SP_RPT_DoctorWiseSalesReport'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			SELECT DM.Dm_Name AS DoctorName
				,MM.Mm_Code AS DrugCode
				,MM.Mm_Name AS DrugName
				,MM.Mm_HsnCode AS HsnCode
				,UOMM.Uom_Name AS UOM
				,SUM(SIID.Sid_PurchaseQty) AS QTY
				,SUM(SIID.Sid_SubTotal) AS SubTotal
				,SUM(SIID.Sid_Total) AS Total
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM SalesInvoiceHeader(NOLOCK) SIH
			INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
			INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
			INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			INNER JOIN DoctorMaster(NOLOCK) DM ON DM.Dm_Id = SIH.Sih_Dm_Id
			WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
					AND CONVERT(DATE, @Sih_DueDate)
				AND MM.Mm_MtmId = @Sid_Mm_Id
			GROUP BY DM.Dm_Name
				,MM.Mm_Code
				,MM.Mm_Name
				,UOMM.Uom_Name
				,MTM.Mtm_TypeName
				,MGM.Mgm_Name
				,MCM.Mcm_Name
				,BM.Branch_Name
				,BM.Branch_Address1
				,BM.Branch_Address2
				,BM.Branch_Address3
				,BM.Branch_GstNo
				,MM.Mm_HsnCode
			ORDER BY DM.Dm_Name ASC
		END
		ELSE
		BEGIN
			SELECT DM.Dm_Name AS DoctorName
				,MM.Mm_Code AS DrugCode
				,MM.Mm_Name AS DrugName
				,MM.Mm_HsnCode AS HsnCode
				,UOMM.Uom_Name AS UOM
				,SUM(SIID.Sid_PurchaseQty) AS QTY
				,SUM(SIID.Sid_SubTotal) AS SubTotal
				,SUM(SIID.Sid_Total) AS Total
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM SalesInvoiceHeader(NOLOCK) SIH
			INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
			INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
			INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			INNER JOIN DoctorMaster DM ON DM.Dm_Id = SIH.Sih_Dm_Id
			WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
					AND CONVERT(DATE, @Sih_DueDate)
			GROUP BY DM.Dm_Name
				,MM.Mm_Code
				,MM.Mm_Name
				,UOMM.Uom_Name
				,MTM.Mtm_TypeName
				,MGM.Mgm_Name
				,MCM.Mcm_Name
				,BM.Branch_Name
				,BM.Branch_Address1
				,BM.Branch_Address2
				,BM.Branch_Address3
				,BM.Branch_GstNo
				,MM.Mm_HsnCode
			ORDER BY DM.Dm_Name ASC
		END
	END
	ELSE IF @SP_STATUS = 'SP_RPT_ProductWiseSalesReport'
	BEGIN
		--IF (@Sid_Mm_Id != 0)
		--BEGIN
			SELECT SIH.Sih_No AS InvoiceNo
				,CONVERT(VARCHAR, SIH.Sih_Date, 105) AS DATE
				,PM.Pm_FullName AS PatientName
				,MM.Mm_Code AS DrugCode
				,MM.Mm_Name AS DrugName
				,UOMM.Uom_Name AS UOMName
				,SIID.Sid_BatchNo AS BatchNo
				,SIID.Sid_SalesQty AS QTY
				,SIID.Sid_SalesRate AS Rate
				,SIID.Sid_SubTotal AS SubTotal
				,SIID.Sid_Total AS Total
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
				,MM.Mm_HsnCode AS HsnCode
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
				,SIID.Sid_MRP
				,DM.Dm_Name as Doctor
			FROM SalesInvoiceHeader(NOLOCK) SIH
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
			LEFT JOIN DoctorMaster as DM ON SIH.Sih_Dm_Id=DM.Dm_Id
			INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
			INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
			INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			INNER JOIN PatientMaster(NOLOCK) PM ON PM.Pm_Id = SIH.Sih_Pm_Id
			WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date) AND CONVERT(DATE, @Sih_DueDate)
				AND MM.Mm_MtmId = case when @Sid_Mm_Id > 0 then @Sid_Mm_Id else MM.Mm_MtmId end
				AND MM.Mm_ID = case when @Sid_Sih_Key > 0 then @Sid_Sih_Key else MM.Mm_ID end
			ORDER BY MM.Mm_Name ASC
		--END
		--ELSE
		--BEGIN
		--	SELECT SIH.Sih_No AS InvoiceNo
		--		,CONVERT(VARCHAR, SIH.Sih_Date, 105) AS DATE
		--		,PM.Pm_FullName AS PatientName
		--		,MM.Mm_Code AS DrugCode
		--		,MM.Mm_Name AS DrugName
		--		,UOMM.Uom_Name AS UOMName
		--		,SIID.Sid_BatchNo AS BatchNo
		--		,SIID.Sid_SalesQty AS QTY
		--		,SIID.Sid_SalesRate AS Rate
		--		,SIID.Sid_SubTotal AS SubTotal
		--		,SIID.Sid_Total AS Total
		--		,MTM.Mtm_TypeName AS DrugType
		--		,MGM.Mgm_Name AS DrugGroup
		--		,MCM.Mcm_Name AS DrugCategory
		--		,MM.Mm_HsnCode AS HsnCode
		--		,BM.Branch_Name
		--		,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
		--		,BM.Branch_GstNo
		--	FROM SalesInvoiceHeader(NOLOCK) SIH
		--	LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
		--	INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
		--	INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
		--	INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
		--	LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
		--	LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
		--	LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
		--	INNER JOIN PatientMaster(NOLOCK) PM ON PM.Pm_Id = SIH.Sih_Pm_Id
		--	WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
		--			AND CONVERT(DATE, @Sih_DueDate)
		--	ORDER BY MM.Mm_Name ASC
		--END
	END
	ELSE IF @SP_STATUS = 'Retrive'
	BEGIN
		DECLARE @FormPrefixRet AS NVARCHAR(max) = '';
		SELECT @FormPrefixRet = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 3
		SELECT Sih_Key
			,@FormPrefixRet + CAST(Sih_No AS NVARCHAR(max)) AS Sih_No
			,Sih_Date
			,Sih_Invtype
			,Sih_Account
			,Sih_Pm_Id
			,Sih_Dm_Id
			,Sih_GstType
			,Sih_RateType
			,Sih_SubTotal
			,Sih_Total
			,Sih_CreatedBy
			,Sih_CreatedDate
			,Sih_UpdatedBy
			,Sih_UpdatedOn
			,Sih_YearId
			,Sih_Disc
			,Sih_DiscAmount
			,Sih_Status
			,Sih_BranchId
			,Sih_CardPay
			,Sih_CashPay
			,Sih_TotalPay
			,Sih_IsCreditBill
			,Sih_AccId
			,Sih_BookId
			,Sih_DueDate
			,Sih_IsOriginal
			,Sih_CardRemarks
			,Sih_Remark
			,pm.Pm_Mob
			,pm.Pm_EmailId
			,Sih_CusRefNo
		FROM dbo.SalesInvoiceHeader(NOLOCK) sih
		LEFT JOIN PatientMaster(NOLOCK) pm ON sih.Sih_Pm_Id = pm.Pm_Id
		WHERE Sih_Key = @Sih_Key;
		SELECT Sid_Key
			,Sid_Sih_Key
			,Sid_SrNo
			,Sid_Mm_Id
			,Sid_MRP
			,Sid_BatchNo
			,Sid_ExpDate
			,Sid_SalesQty
			,Sid_SalesUomId
			--,Sid_MRP AS Sid_SalesRate----Change Hasmukh
			,Sid_SalesRate----Change Hasmukh
			,Sid_SubTotal
			,Sid_Total
			,Sid_MnfDate
			,Sid_Disc
			,Sid_DiscAmount
			,Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--sid.Sid_SalesQty AS Sid_Stock_Qty,
			--sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			vwStock.Item_Stock + sid.Sid_SalesQty AS Sid_Stock_Qty
			,vwStock.Purchase_Item_Stock + sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty
			,mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name AS Sid_LmName
			,ISNULL(SUM(srd.Srd_Qty), 0) Sid_ReturnQty
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Sid_Mm_Id
			AND vwStock.Item_Batchno = sid.Sid_BatchNo
			AND vwStock.Stk_LmId = Sid_LmId
		LEFT JOIN dbo.LocationMaster(NOLOCK) lm ON sid.Sid_LmId = lm.Lm_Id
		LEFT JOIN SalesReturnDetail(NOLOCK) srd ON srd.Sid_SihKey = sid.Sid_Sih_Key
			AND Srd_SidSrNo = sid.Sid_SrNo
			AND Srd_MmId = sid.Sid_Mm_Id
		WHERE Sid_Sih_Key = @Sih_Key
		GROUP BY Sid_Key
			,Sid_Sih_Key
			,Sid_SrNo
			,Sid_Mm_Id
			,Sid_MRP
			,Sid_BatchNo
			,Sid_ExpDate
			,Sid_SalesQty
			,Sid_SalesUomId
			,Sid_SalesRate
			,Sid_SubTotal
			,Sid_Total
			,Sid_MnfDate
			,Sid_Disc
			,Sid_DiscAmount
			,Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code
			,mm.Mm_Name
			,mm.Mm_StkUom
			,mm.MM_PackSize
			,vwStock.Item_Stock + sid.Sid_SalesQty
			,vwStock.Purchase_Item_Stock + sid.Sid_PurchaseQty
			,mm.MM_PackSize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name
		SELECT 0 AS Sid_Key
			,0 AS Sid_Sih_Key
			,0 AS Sid_SrNo
			,Sid_Mm_Id
			,vwStock.Item_MRP AS Sid_MRP
			,vwStock.Item_Batchno AS Sid_BatchNo
			,vwStock.Item_ExpDate AS Sid_ExpDate
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then Sid_SalesQty else 0.00 end as Sid_SalesQty,
			Sid_SalesQty
			,Sid_SalesUomId
			,vwStock.Item_Rate AS Sid_SalesRate
			,CASE 
				WHEN ISNULL(vwStock.Purchase_Item_Stock, 0) - ISNULL(Sid_PurchaseQty, 0) >= ISNULL(Sid_PurchaseQty, 0)
					THEN Sid_SubTotal
				ELSE 0
				END AS Sid_SubTotal
			,CASE 
				WHEN ISNULL(vwStock.Purchase_Item_Stock, 0) - ISNULL(Sid_PurchaseQty, 0) >= ISNULL(Sid_PurchaseQty, 0)
					THEN Sid_Total
				ELSE 0
				END AS Sid_Total
			,vwStock.Item_MnfDate AS Sid_MnfDate
			,0 AS Sid_Disc
			,0 AS Sid_DiscAmount
			,
			--case when isnull(vwStock.Purchase_Item_Stock,0)-ISNULL(Sid_PurchaseQty,0)>=ISNULL(Sid_PurchaseQty,0) then ISNULL(Sid_PurchaseQty,0) else 0 end as Sid_PurchaseQty,
			ISNULL(Sid_PurchaseQty, 0) AS Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then vwStock.Item_Stock  else vwStock.Item_Stock end as Sid_Stock_Qty,
			vwStock.Item_Stock AS Sid_Stock_Qty
			,
			--vwStock.Item_Stock+sid.Sid_SalesQty AS Sid_Stock_Qty,
			--case when vwStock.Purchase_Item_Stock-Sid_PurchaseQty>=Sid_PurchaseQty then vwStock.Purchase_Item_Stock  else vwStock.Purchase_Item_Stock end as Sid_Purchase_Stock_Qty,
			vwStock.Purchase_Item_Stock AS Sid_Purchase_Stock_Qty
			,
			--vwStock.Purchase_Item_Stock+sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name AS Sid_LmName
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Sid_Mm_Id
			AND vwStock.Item_Batchno = sid.Sid_BatchNo
			AND vwStock.Stk_LmId = Sid_LmId
		LEFT JOIN dbo.LocationMaster lm ON sid.Sid_LmId = lm.Lm_Id
		WHERE Sid_Sih_Key = @Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'BindMedcn'
	BEGIN
		SELECT *
		FROM MedicineMaster(NOLOCK) MM
		WHERE MM.Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
		SELECT MM.Mm_ID
			,MM.Mm_Name
			,MM.Mm_Code
			,MM.Mm_LeadTime
			,MM.Mm_StkUom
			,UM.Uom_Code
			,UM.Uom_Name
			,UM.Uom_ID
			,MM.Mm_MRP
			,ISNULL(VW.STOCK, 0) AS Stock
		FROM MedicineMaster(NOLOCK) MM
		INNER JOIN UomMaster(NOLOCK) UM ON MM.Mm_StkUom = UM.Uom_ID
		LEFT JOIN VwTotalStock(NOLOCK) VW ON MM.Mm_ID = VW.STK_ITEM_ID
		WHERE MM.Mm_ID = @Sid_Mm_Id;
	END;
	ELSE IF @SP_STATUS = 'GetBatchwiseDetail'
	BEGIN
		SELECT CAST(0 AS BIT) AS Chk
			,
			--Stk_PackId,
			Ps_Code
			,Item_Batchno
			,Item_Stock
			,Item_Rate
		FROM vwStock(NOLOCK)
		WHERE Item_Id = @Sid_Mm_Id
			AND Item_Stock > 0;
	END;
	ELSE
	--IF @SP_STATUS = 'GetMedcnBatchwiseDetail'
	--  BEGIN
	--    DECLARE @dynaSql nvarchar(max);
	--    SET @dynaSql
	--    = 'SELECT * FROM vwStock WHERE Item_Id = ' + CAST(@Sid_Mm_Id AS nvarchar(10)) + ' AND Item_Batchno IN ('
	--    + @Sid_BatchNo + ')';
	--    EXEC (@dynaSql);
	--  END;
	--ELSE
	IF @SP_STATUS = 'GetMedcnBatchwiseDetail'
	BEGIN
		SELECT *
		FROM vwStock(NOLOCK)
		WHERE Item_Id = @Sid_Mm_Id
			AND ISNULL(Item_Batchno,'') = @Sid_BatchNo
			AND Stk_LmId = @Sid_LmId
	END;
	ELSE IF @SP_STATUS = 'GetSerachDetail'
	BEGIN
		SELECT Item_Id
			,Item_Code
			,Item_Name
			,Item_Batchno
			,Item_Stock
			,Item_Rate
			,Item_ExpDate
			,Item_Uom
		FROM dbo.vwStock(NOLOCK)
		WHERE Item_Stock > 0;
	END;
	ELSE IF @SP_STATUS = 'GetItemDetailOriginal'
	BEGIN
		SELECT sid.Sid_Key
			,sid.Sid_Sih_Key
			,sid.Sid_SrNo
			,sid.Sid_Mm_Id
			,mm.Mm_HsnCode AS sid_HsnCode
			,sh.Sih_No
			,--sid.Sid_PackId,
			sid.Sid_MRP
			,ISNULL(sid.Sid_BatchNo,'')AS Sid_BatchNo
			,(CASE WHEN ISNULL(sid.Sid_ExpDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_ExpDate)),2) 
			END)AS Sid_ExpDate
			,sid.Sid_SalesQty AS Sid_Qty
			,sid.Sid_SalesRate AS Sid_Rate
			,sid.Sid_SubTotal
			,sid.Sid_Total
			,(CASE WHEN ISNULL(sid.Sid_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_MnfDate)),2)  
			END)AS Sid_MnfDate
			,sid.Sid_Disc
			,sid.Sid_DiscAmount
			,mm.Mm_Name AS MedicineName
			,pm.Pm_Fullname AS Sih_PatientName
			,pm.Pm_Mob AS Sih_PatientMob
			,dm.Dm_Name AS Sih_DoctorName
			,(CASE WHEN ISNULL(sh.Sih_Date,'')=''
					THEN ''
					ELSE CONVERT(VARCHAR,sh.Sih_Date,105)
			END)AS Sih_Date
			,sh.Sih_DiscAmount
			,sh.Sih_SubTotal
			,sh.Sih_Total
			,ISNULL(sh.Sih_IsOriginal, 0) AS Sih_IsOriginal
			,
			--CASE
			--	WHEN isnull(sh.Sih_IsOriginal,0) = 0 THEN 'ORIGINAL'
			--	ELSE 'DUPLICATE'
			--END AS Print_Status,
			'ORIGINAL' AS Print_Status
			,0.00 AS OtherBrandRate
			,BM.Branch_Name
			,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
			,BM.Branch_Logo AS BranchLogo
			,BM.Branch_GstNo AS BranchGSTNO
			,CM.City_Name AS BranchCity
			,mm.MM_PackSize AS sid_PackSize
			,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
			,TAX.SGST
			,TAX.CGST
			,TAX.IGST
			,CASE 
				WHEN sh.Sih_BookId = 3
					THEN 'GST Invoice'
				ELSE 'Bill of Supply'
				END BillType
				
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN TaxTransaction(NOLOCK) STAX ON sid.Sid_Key = STAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = STAX.Tr_DocKey
			AND STAX.Tr_TxId = 2
			AND STAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CTAX ON sid.Sid_Key = CTAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = CTAX.Tr_DocKey
			AND CTAX.Tr_DocTyp = 2
			AND CTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) ITAX ON sid.Sid_Key = ITAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = ITAX.Tr_DocKey
			AND ITAX.Tr_DocTyp = 2
			AND ITAX.Tr_TxId = 4
		LEFT JOIN dbo.SalesInvoiceHeader(NOLOCK) sh ON sid.Sid_Sih_Key = sh.Sih_Key
		LEFT JOIN (
			SELECT SIH.Sih_Key
				,SUM(SSTAX.Tr_TxTot) AS SGST
				,SUM(CCTAX.Tr_TxTot) AS CGST
				,SUM(IITAX.Tr_TxTot) AS IGST
			FROM dbo.SalesInvoiceItemDetail(NOLOCK) SID1
			     INNER JOIN SalesInvoiceHeader SIH
			  ON SIH.Sih_Key=SID1.Sid_Sih_Key
			LEFT JOIN TaxTransaction(NOLOCK) SSTAX ON SID1.Sid_Key = SSTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = SSTAX.Tr_DocKey
			AND SSTAX.Tr_TxId = 2
			AND SSTAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SID1.Sid_Key = CCTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = CCTAX.Tr_DocKey
			AND CCTAX.Tr_DocTyp = 2
			AND CCTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SID1.Sid_Key = IITAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = IITAX.Tr_DocKey
			AND IITAX.Tr_DocTyp = 2
			AND IITAX.Tr_TxId = 4
			GROUP BY SIH.Sih_Key
			) AS TAX ON sh.Sih_Key = TAX.Sih_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON sh.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON sh.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON sh.Sih_BranchId = BM.Branch_Id
		LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
		WHERE sid.Sid_Sih_Key = @Sid_Sih_Key;


		SELECT		CASE WHEN Tr_TxType = 'A' THEN 'IGST'
							 WHEN Tr_TxType = 'S' THEN 'SGST'
							 WHEN Tr_TxType = 'C' THEN 'CGST' END AS Tax_Type,
						Tr_TxVal AS Tax_Perc, SUM(Tr_TxTot) AS Tax_Total
			FROM		TaxTransaction (NOLOCK)
			WHERE		Tr_DocTyp = 2
					AND Tr_DocKey = @Sid_Sih_Key
			GROUP BY	CASE WHEN Tr_TxType = 'A' THEN 'IGST'
							 WHEN Tr_TxType = 'S' THEN 'SGST'
							 WHEN Tr_TxType = 'C' THEN 'CGST' END, Tr_TxVal
			HAVING		Tr_TxVal > 0
			ORDER BY	Tr_TxVal 

	END;
	ELSE IF @SP_STATUS = 'GetItemDetailDuplicate'
	BEGIN
		SELECT sid.Sid_Key
			,sid.Sid_Sih_Key
			,sid.Sid_SrNo
			,sid.Sid_Mm_Id
			,mm.Mm_HsnCode AS sid_HsnCode
			,sh.Sih_No
			,--sid.Sid_PackId,
			sid.Sid_MRP
			,sid.Sid_BatchNo
			,(CASE WHEN ISNULL(sid.Sid_ExpDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_ExpDate)),2) 
			END)AS Sid_ExpDate
			,sid.Sid_SalesQty AS Sid_Qty
			,sid.Sid_SalesRate AS Sid_Rate
			,sid.Sid_SubTotal
			,sid.Sid_Total
				,(CASE WHEN ISNULL(sid.Sid_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_MnfDate)),2) 
			END)AS Sid_MnfDate
			,sid.Sid_Disc
			,sid.Sid_DiscAmount
			,mm.Mm_Name AS MedicineName
			,pm.Pm_Fullname AS Sih_PatientName
			,pm.Pm_Mob AS Sih_PatientMob
			,dm.Dm_Name AS Sih_DoctorName
			,(CASE WHEN ISNULL(sh.Sih_Date,'')=''
					THEN ''
					ELSE CONVERT(VARCHAR,sh.Sih_Date,105)
			END)AS Sih_Date
			,sh.Sih_DiscAmount
			,sh.Sih_SubTotal
			,sh.Sih_Total
			,ISNULL(sh.Sih_IsOriginal, 0) AS Sih_IsOriginal
			,'DUPLICATE' AS Print_Status
			,0.00 AS OtherBrandRate
			,BM.Branch_Name
			,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
			,BM.Branch_Logo AS BranchLogo
			,BM.Branch_GstNo AS BranchGSTNO
			,CM.City_Name AS BranchCity
			,mm.MM_PackSize AS sid_PackSize
			,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
			,TAX.SGST
			,TAX.CGST
			,TAX.IGST
			,CASE 
				WHEN sh.Sih_BookId = 3
					THEN 'GST Invoice'
				ELSE 'Bill of Supply'
				END BillType
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN TaxTransaction(NOLOCK) STAX ON sid.Sid_Key = STAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = STAX.Tr_DocKey
			AND STAX.Tr_TxId = 2
			AND STAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CTAX ON sid.Sid_Key = CTAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = CTAX.Tr_DocKey
			AND CTAX.Tr_DocTyp = 2
			AND CTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) ITAX ON sid.Sid_Key = ITAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = ITAX.Tr_DocKey
			AND ITAX.Tr_DocTyp = 2
			AND ITAX.Tr_TxId = 4
		LEFT JOIN dbo.SalesInvoiceHeader(NOLOCK) sh ON sid.Sid_Sih_Key = sh.Sih_Key
		LEFT JOIN (
			SELECT SIH.Sih_Key
				,SUM(SSTAX.Tr_TxTot) AS SGST
				,SUM(CCTAX.Tr_TxTot) AS CGST
				,SUM(IITAX.Tr_TxTot) AS IGST
			FROM dbo.SalesInvoiceItemDetail(NOLOCK) SID1
			     INNER JOIN SalesInvoiceHeader SIH
			  ON SIH.Sih_Key=SID1.Sid_Sih_Key
			LEFT JOIN TaxTransaction(NOLOCK) SSTAX ON SID1.Sid_Key = SSTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = SSTAX.Tr_DocKey
			AND SSTAX.Tr_TxId = 2
			AND SSTAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SID1.Sid_Key = CCTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = CCTAX.Tr_DocKey
			AND CCTAX.Tr_DocTyp = 2
			AND CCTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SID1.Sid_Key = IITAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = IITAX.Tr_DocKey
			AND IITAX.Tr_DocTyp = 2
			AND IITAX.Tr_TxId = 4
			GROUP BY SIH.Sih_Key
			) AS TAX ON sh.Sih_Key = TAX.Sih_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON sh.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON sh.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON sh.Sih_BranchId = BM.Branch_Id
		LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
		WHERE sid.Sid_Sih_Key = @Sid_Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'GetPreviousNumber'
	BEGIN
		IF @Sih_Key > 0
			SELECT MAX(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK)
			WHERE Sih_Key < @Sih_Key;
		ELSE
			SELECT MAX(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'GetNextNumber'
	BEGIN
		IF @Sih_Key > 0
			SELECT MIN(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK)
			WHERE Sih_Key > @Sih_Key;
		ELSE
			SELECT MIN(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'GetLedgerId'
	BEGIN
		--SELECT Lm_Id
		--FROM LedgerMaster (NOLOCK) 
		--WHERE Lm_PVId = @Sih_Pm_Id;
		SELECT Pm_Ledger_Id AS Lm_Id
		FROM PatientMaster
		WHERE Pm_Id = @Sih_Pm_Id;
	END;
	ELSE IF @SP_STATUS = 'GetLedgerIdFromVendor'
	BEGIN
		--SELECT Lm_Id
		--FROM LedgerMaster (NOLOCK) 
		--WHERE Lm_PVId = @Sih_Pm_Id;
		SELECT Vendor_Ledger_id Lm_Id
		FROM VendorMaster
		WHERE Vendor_ID = @Sih_Pm_Id;
	END;
	ELSE IF @SP_STATUS = 'FillCashAccount'
	BEGIN
		SELECT Lm_Id
			,Lm_Name
		FROM LedgerMaster(NOLOCK)
		WHERE Lm_Id = 11;
	END;
	ELSE IF @SP_STATUS = 'GetPatientDetail'
	BEGIN
		SELECT DISTINCT (Pm_Mob) AS MobileNo
		FROM PatientMaster(NOLOCK)
		WHERE Pm_IsActive = 1
			AND ISNULL(Pm_Mob, '0') <> '0'
	END;
	ELSE IF @SP_STATUS = 'GetPatient'
	BEGIN
		SELECT *
		FROM PatientMaster
		WHERE Pm_Mob = @Sih_CardRemarks
			AND Pm_IsActive = 1
			AND ISNULL(Pm_Mob, '0') <> '0'
	END;
	ELSE IF @SP_STATUS = 'GetPatientMobile'
	BEGIN
		SELECT Pm_Mob AS MobileNo
			,Pm_EmailId
		FROM PatientMaster(NOLOCK)
		WHERE Pm_IsActive = 1
			AND Pm_Id = @Sih_Pm_Id
	END;
	ELSE IF @SP_STATUS = 'SalesHeaderForReport'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
	END;
	ELSE IF @SP_STATUS = 'SalesDetailForReport'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_SalesQty AS Qty
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_SalesUomId = UM.Uom_ID
		--LEFT JOIN PacketSizeMater AS PSM
		--  ON PSM.Ps_ID = SD.Sid_PackId
		--LEFT JOIN MedicinePacketSizeMaster AS PSM
		--ON PSM.Mps_Id=SD.Sid_PackId and PSM.Mps_MmId=SD.Sid_Mm_Id
		LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
	END;
	ELSE IF @SP_STATUS = 'SalesHeaderForReportWithFilter1'
	BEGIN
	  --   SELECT SalesInvoiceHeader.Sih_No,
   --             CONVERT(DATE,SalesInvoiceHeader.Sih_Date)AS  Sih_Date,
		 --       PatientMaster.Pm_Fullname ,
   --             Tr_DocKey,
			--	TaxMaster.Tax_Name,
			--	Tr_TxVal, 
			--	SalesInvoiceHeader.Sih_SubTotal,
			--	SUM(Tr_TxTot) AS TaxAmount,
			--	SalesInvoiceHeader.Sih_Total,
			--	SGST,
			--	CGST,
			--	IGST,
			--	(SGST+CGST+IGST)AS TotalTax
   --        from TaxTransaction
   --             INNER JOIN SalesInvoiceHeader 
   --          ON SalesInvoiceHeader.Sih_Key=TaxTransaction.Tr_DocKey
	  --          INNER JOIN PatientMaster 
	  --       ON PatientMaster.Pm_Id=SalesInvoiceHeader.Sih_Pm_Id
			--    INNER JOIN TaxMaster 
			-- ON TaxMaster.Tax_ID=TaxTransaction.Tr_TxId
			--    INNER JOIN (SELECT A.Sid_Sih_Key
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Sid_Sih_Key
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM SalesInvoiceItemDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Sid_Mm_Id
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Sid_Key = B.Tr_DdocKey
			--			AND A.Sid_Sih_Key = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 2
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Sid_Key = C.Tr_DdocKey
			--			AND A.Sid_Sih_Key = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 2
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Sid_Key = D.Tr_DdocKey
			--			AND A.Sid_Sih_Key = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 2
			--			AND D.Tr_TxId = 4
			--		) AS A
			--	GROUP BY A.Sid_Sih_Key)AS BB
			--ON BB.Sid_Sih_Key=SalesInvoiceHeader.Sih_Key
   --       WHERE Tr_TxVal!=0 and  Tr_TxId in(2,3,4) AND Tr_DocTyp=2
		 --       AND  CONVERT(DATE, SalesInvoiceHeader.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105) AND CONVERT(DATE, @Sih_DueDate, 105)
			--	group by SalesInvoiceHeader.Sih_No,SalesInvoiceHeader.Sih_Date,Pm_Fullname,Tr_DocKey,TaxMaster.Tax_Name,Tr_TxVal, SalesInvoiceHeader.Sih_SubTotal,
			--	SalesInvoiceHeader.Sih_Total,SGST,CGST,IGST
			SELECT	'Sales Invoice' AS Sih_DocType,
					D.Sih_Key,
					D.Sih_No,
					D.Sih_Date,
					E.Pm_Fullname,
					B.Sid_SubTotal,
					A.Tr_TxVal,
					A.Tr_TxTot,
					C.Tax_Name,
					D.Sih_SubTotal,
					D.Sih_Total
			FROM	TaxTransaction A
					iNNER JOIN SalesInvoiceItemDetail B
			ON			A.Tr_DdocKey=B.Sid_Key
					AND A.Tr_DocTyp=2
					iNNER JOIN TaxMaster C
			ON			A.Tr_TxId=C.Tax_ID
					iNNER JOIN SalesInvoiceHeader D
			ON			B.Sid_Sih_Key=D.Sih_Key
					LEFT JOIN PatientMaster E
			ON			D.Sih_Pm_Id=E.Pm_Id
			WHERE	A.Tr_TxId NOT IN(1)
					AND CAST(D.Sih_Date AS DATE) BETWEEN @Sih_Date AND @Sih_DueDate
			UNION ALL
			SELECT	'Sales Return' AS Sih_DocType,
					D.Srh_Id AS Sih_Key,
					D.Srh_No AS Sih_No,
					D.Srh_Date AS Sih_Date,
					E.Pm_Fullname,
					B.Srd_Amount AS Srd_SubTotal,
					A.Tr_TxVal,
					A.Tr_TxTot,
					C.Tax_Name,
					DT.Srh_SubTotal,
					D.Srh_Total
			FROM	TaxTransaction A
					iNNER JOIN SalesReturnDetail B
			ON			A.Tr_DdocKey=B.Srd_Id
					AND A.Tr_DocTyp=3
					iNNER JOIN TaxMaster C
			ON			A.Tr_TxId=C.Tax_ID
					iNNER JOIN SalesReturnHeader D
			ON			B.Srd_SrhId=D.Srh_Id
					INNER JOIN (SELECT	SUM(SRD.Srd_Qty*SRD.Srd_Rate)AS Srh_SubTotal,
										SRH.Srh_Id 
								FROM	SalesReturnHeader SRH
										INNER JOIN SalesReturnDetail SRD
								ON		SRD.Srd_SrhId=SRH.Srh_Id
										GROUP BY SRH.Srh_Id
								)AS DT
			ON		DT.Srh_Id=D.Srh_Id
					INNER JOIN SalesInvoiceHeader F
			ON			F.Sih_Key=D.Srh_SihKey
					LEFT JOIN PatientMaster E
			ON			F.Sih_Pm_Id=E.Pm_Id
			WHERE	A.Tr_TxId NOT IN(1)
					AND CAST(D.Srh_Date AS DATE) BETWEEN @Sih_Date AND @Sih_DueDate

	END
	ELSE IF @SP_STATUS = 'GSTR1'
	BEGIN
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_1')
			BEGIN
				DROP TABLE ##TEMP_GST_1
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_2')
			BEGIN
				DROP TABLE ##TEMP_GST_2
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_3')
			BEGIN
				DROP TABLE ##TEMP_GST_3
			END
		
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_4')
			BEGIN
				DROP TABLE ##TEMP_GST_4
			END
			
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_5')
			BEGIN
				DROP TABLE ##TEMP_GST_5
			END
			
		SELECT	A.Tr_DocTyp,
				A.Tr_DocKey,
				A.Tr_DdocKey,
				CASE WHEN Tr_TxId=2 THEN Tr_TxVal ELSE 0 END AS CGST_P,
				CASE WHEN Tr_TxId=3 THEN Tr_TxVal ELSE 0 END AS SGST_P,
				CASE WHEN Tr_TxId=4 THEN Tr_TxVal ELSE 0 END AS IGST_P,
				
				CASE WHEN Tr_TxId=2 THEN Tr_TxTot ELSE 0 END AS CGST_V,
				CASE WHEN Tr_TxId=3 THEN Tr_TxTot ELSE 0 END AS SGST_V,
				CASE WHEN Tr_TxId=4 THEN Tr_TxTot ELSE 0 END AS IGST_V
		INTO	##TEMP_GST_1
		FROM	TaxTransaction A
		WHERE	A.Tr_TxId IN(2,3,4)
				AND A.Tr_DocTyp IN(2,3)
				
		SELECT	Tr_DocTyp,
				Tr_DocKey,
				Tr_DdocKey,
				SUM(CGST_P) AS CGST_P,
				SUM(SGST_P) AS SGST_P,
				SUM(IGST_P) AS IGST_P,
				
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		INTO	##TEMP_GST_2
		FROM	##TEMP_GST_1 A
		GROUP BY Tr_DocTyp,Tr_DocKey,Tr_DdocKey
		
		
		---Sales INvoice
		SELECT	C.Sih_No,
				C.Sih_Date,
				B.Sid_SubTotal,
				A.*
		iNTO	##TEMP_GST_3
		FROM	##TEMP_GST_2 A
				iNNER JOIN SalesInvoiceItemDetail B
		ON			A.Tr_DdocKey=B.Sid_Key
					AND A.Tr_DocKey=B.Sid_Sih_Key
					AND A.Tr_DocTyp=2
				iNNER JOIN SalesInvoiceHeader C
		ON			B.Sid_Sih_Key=C.Sih_Key
			
		UNION
		---Sales Return
		SELECT	C.Srh_No,
				C.Srh_Date,
				B.Srd_Amount,
				A.*
		FROM	##TEMP_GST_2 A
				iNNER JOIN SalesReturnDetail B
		ON			A.Tr_DdocKey=B.Srd_ID
					 AND A.Tr_DocKey=B.Srd_SrhId
					 AND A.Tr_DocTyp=3
				iNNER JOIN SalesReturnHeader C
		ON			B.Srd_SrhId=C.Srh_Id
		
		
		
		SELECT	Tr_DocTyp,
				Tr_DocKey,
				Sih_No,
				Sih_Date,
				SUM(Sid_SubTotal) AS SubTotal,
				CGST_P,
				SGST_P,
				IGST_P,
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		iNTO	##TEMP_GST_4
		FROM	##TEMP_GST_3
		GROUP BY Tr_DocTyp,Tr_DocKey,Sih_No,Sih_Date,CGST_P,SGST_P,IGST_P
		
		SELECT	Tr_DocTyp,	
				Tr_DocKey,
				Sih_No,
				Sih_date,
				SUM(CASE WHEN CGST_P>0 OR IGST_P>0  THEN 0 ELSE SubTotal END) [Taxable_0],
				SUM(CASE WHEN CGST_P=0 THEN CGST_V ELSE 0 END) [CGST_0],
				SUM(CASE WHEN SGST_P=0 THEN SGST_V ELSE 0 END) [SGST_0],
				SUM(CASE WHEN IGST_P=0   THEN IGST_V ELSE 0 END) [IGST_0],
				
				SUM(CASE WHEN CGST_P=2.5 OR IGST_P=5  THEN SubTotal ELSE 0 END) [Taxable_2_5],
				SUM(CASE WHEN CGST_P=2.5 THEN CGST_V ELSE 0 END) [CGST_2_5],
				SUM(CASE WHEN SGST_P=2.5 THEN SGST_V ELSE 0 END) [SGST_2_5],
				SUM(CASE WHEN IGST_P=5   THEN IGST_V ELSE 0 END) [IGST_5],
				
				SUM(CASE WHEN CGST_P=6 OR IGST_P=12 THEN SubTotal ELSE 0 END) [Taxable_6],
				SUM(CASE WHEN CGST_P=6 THEN CGST_V ELSE 0 END) [CGST_6],
				SUM(CASE WHEN SGST_P=6 THEN SGST_V ELSE 0 END) [SGST_6],
				SUM(CASE WHEN IGST_P=12   THEN IGST_V ELSE 0 END) [IGST_12],
				
				SUM(CASE WHEN CGST_P=9 OR IGST_P=18 THEN SubTotal ELSE 0 END) [Taxable_9],
				SUM(CASE WHEN CGST_P=9 THEN CGST_V ELSE 0 END) [CGST_9],
				SUM(CASE WHEN SGST_P=9 THEN SGST_V ELSE 0 END) [SGST_9],
				SUM(CASE WHEN IGST_P=18   THEN IGST_V ELSE 0 END) [IGST_18],
				
				SUM(CASE WHEN CGST_P=14 OR IGST_P=28 THEN SubTotal ELSE 0 END) [Taxable_14],
				SUM(CASE WHEN CGST_P=14 THEN CGST_V ELSE 0 END) [CGST_14],
				SUM(CASE WHEN SGST_P=14 THEN SGST_V ELSE 0 END) [SGST_14],
				SUM(CASE WHEN IGST_P=28   THEN IGST_V ELSE 0 END) [IGST_28],
				
				SUM(SubTotal) AS SubTotal,
				SUM(CGST_V) AS CGST_TOT,
				SUM(SGST_V) AS SGST_TOT,
				SUM(IGST_V) AS IGST_TOT,
				SUM(CGST_V+SGST_V+IGST_V) AS Total_Tax
		iNTO	##TEMP_GST_5
		FROM	##TEMP_GST_4
		GROUP BY Tr_DocTyp,Tr_DocKey,Sih_No,Sih_date
		
		SELECT	'Sales Invoice' AS DocType,
		        B.Sih_No AS InvoiceNo,
		        CONVERT(VARCHAR,B.Sih_Date,105)AS DATE,
		        DateName(MONTH,A.Sih_Date)AS MonthName,
		        Year(A.Sih_Date)AS Year,
		        E.Pm_Fullname AS PartyName,
				A.Taxable_0,
				A.CGST_0,
				A.SGST_0,
				A.IGST_0,
				A.Taxable_2_5,
				A.CGST_2_5,
				A.SGST_2_5,
				A.IGST_5,
				A.Taxable_6,
				A.CGST_6,
				A.SGST_6,
				A.IGST_12,
				A.Taxable_9,
				A.CGST_9,
				A.SGST_9,
				A.IGST_18,
				A.Taxable_14,
				A.CGST_14,
				A.SGST_14,
				A.IGST_28,
				A.SubTotal,
				A.CGST_TOT,
				A.SGST_TOT,
				A.IGST_TOT,
				A.Total_Tax,
				ISNULL(B.Sih_Freight_Amount,0)AS Freight_Amount,
				(B.Sih_Total-(A.SubTotal+Total_Tax+ISNULL(B.Sih_Freight_Amount,0)))AS RT,
				B.Sih_Total
		FROM	##TEMP_GST_5 A
				iNNER jOIN SalesInvoiceHeader B
		ON			A.Tr_DocKey=B.Sih_Key
				AND A.Tr_DocTyp=2
				LEFT JOIN PatientMaster E
		ON		B.Sih_Pm_Id=E.Pm_Id
		WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Sih_DATE AS DATE) AND  CAST(@Sih_DueDATE AS DATE) 
		
		UNION
		SELECT	'Sales Return' AS Sih_DocType,
		        B.Srh_No AS InvoiceNo,
		        CONVERT(VARCHAR,B.Srh_Date,105)AS DATE,
		        DateName(MONTH,B.Srh_Date)AS MonthName,
		        Year(B.Srh_Date)AS Year,
		        EE.Pm_Fullname AS PartyName,
				A.Taxable_0,
				A.CGST_0,
				A.SGST_0,
				A.IGST_0,
				A.Taxable_2_5,
				A.CGST_2_5,
				A.SGST_2_5,
				A.IGST_5,
				A.Taxable_6,
				A.CGST_6,
				A.SGST_6,
				A.IGST_12,
				A.Taxable_9,
				A.CGST_9,
				A.SGST_9,
				A.IGST_18,
				A.Taxable_14,
				A.CGST_14,
				A.SGST_14,
				A.IGST_28,
				A.SubTotal,
				A.CGST_TOT,
				A.SGST_TOT,
				A.IGST_TOT,
				A.Total_Tax,
				0 AS Freight_Amount,
				(B.Srh_Total-(A.SubTotal+Total_Tax))AS RT,
				B.Srh_Total
		FROM	##TEMP_GST_5 A
				iNNER jOIN SalesReturnHeader B
		ON			A.Tr_DocKey=B.Srh_Id
				AND A.Tr_DocTyp=3
				INNER JOIN SalesInvoiceHeader F
		ON      F.Sih_Key=B.Srh_SihKey
		        LEFT JOIN PatientMaster EE
		ON      F.Sih_Pm_Id=EE.Pm_Id
		WHERE	CAST(A.Sih_DATE AS DATE) BETWEEN CAST(@Sih_DATE AS DATE) AND  CAST(@Sih_DueDATE AS DATE)
	END
	ELSE IF @SP_STATUS = 'SalesHeaderForReportWithFilter'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			--SELECT DISTINCT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
				
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,
			--	--ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
			--	ISNULL(BB.SGST, 0.00) + ISNULL(BB.CGST, 0.00) + ISNULL(BB.IGST, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,ISNULL(BB.SGST, 0) AS SGST
			--	,ISNULL(BB.CGST, 0) AS CGST
			--	,ISNULL(BB.IGST, 0) AS IGST
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			--LEFT JOIN (
			--	SELECT A.Sid_Sih_Key
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Sid_Sih_Key
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM SalesInvoiceItemDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Sid_Mm_Id
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Sid_Key = B.Tr_DdocKey
			--			AND A.Sid_Sih_Key = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 2
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Sid_Key = C.Tr_DdocKey
			--			AND A.Sid_Sih_Key = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 2
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Sid_Key = D.Tr_DdocKey
			--			AND A.Sid_Sih_Key = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 2
			--			AND D.Tr_TxId = 4
			--		INNER JOIN SalesInvoiceHeader SH1
			--		ON	SH1.Sih_Key=A.Sid_Sih_Key
			--		WHERE CONVERT(DATE, SH1.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--		) AS A
			--	GROUP BY A.Sid_Sih_Key
			--	) AS BB ON SH.Sih_Key = BB.Sid_Sih_Key
			--INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SH.Sih_Key
			--INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--	AND MM.Mm_MtmId = @Sid_Mm_Id
        SELECT	SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date) AS BillDate,
        		SIH.Sih_No AS BillNo,
        		PM.Pm_Fullname AS PartyName,
        		ISNULL(SIH.Sih_SubTotal, 0.00) AS GrossAmount,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) + SUM(ISNULL(TXC.Tr_TxTot, 0)) + SUM(ISNULL(TXI.Tr_TxTot, 0)) AS TaxAmount,
        		ISNULL(SIH.Sih_DiscAmount, 0.00) AS Discount,
        		SIH.Sih_Total AS NetAmount,
        		BM.Branch_Name,
        		Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
        		bm.Branch_GstNo,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) AS SGST,
        		SUM(ISNULL(TXC.Tr_TxTot, 0)) AS CGST,
        		SUM(ISNULL(TXI.Tr_TxTot, 0)) AS IGST
        FROM	SalesInvoiceHeader SIH
        		LEFT JOIN PatientMaster(NOLOCK) AS PM 
        	ON	SIH.Sih_Pm_Id = PM.Pm_Id
        		LEFT JOIN BranchMaster(NOLOCK) BM 
        	ON	SIH.Sih_BranchId = BM.Branch_Id
        		INNER JOIN SalesInvoiceItemDetail SID
        	ON	SID.Sid_Sih_Key=SIH.Sih_Key
        	    INNER JOIN MedicineMaster(NOLOCK) MM 
        	ON	MM.Mm_ID = SID.Sid_Mm_Id
        		LEFT JOIN TaxTransaction TXS
        	ON	TXS.Tr_DdocKey=SID.Sid_Key
        		AND TXS.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXS.Tr_DocTyp=2
        		AND TXS.Tr_TxId=2
        		LEFT JOIN TaxTransaction TXC
        	ON	TXC.Tr_DdocKey=SID.Sid_Key
        		AND TXC.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXC.Tr_DocTyp=2
        		AND TXC.Tr_TxId=3
        		LEFT JOIN TaxTransaction TXI
        	ON	TXI.Tr_DdocKey=SID.Sid_Key
        		AND TXI.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXI.Tr_DocTyp=2
        		AND TXI.Tr_TxId=4
        WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
        					AND CONVERT(DATE, @Sih_DueDate, 105)
        				AND MM.Mm_MtmId = @Sid_Mm_Id
        		GROUP BY
        		SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date),
        		SIH.Sih_No ,
        		PM.Pm_Fullname,
        		SIH.Sih_SubTotal,
        		SIH.Sih_DiscAmount,
        		SIH.Sih_Total,
        		BM.Branch_Name,
        		Bm.Branch_Address1,
        		Bm.Branch_Address2,
        		Bm.Branch_Address3,
        		bm.Branch_GstNo
        			
		END
		ELSE
		BEGIN
			--SELECT DISTINCT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
				
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,
			--	--ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
			--	ISNULL(BB.SGST, 0.00) + ISNULL(BB.CGST, 0.00) + ISNULL(BB.IGST, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,ISNULL(BB.SGST, 0) AS SGST
			--	,ISNULL(BB.CGST, 0) AS CGST
			--	,ISNULL(BB.IGST, 0) AS IGST
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			--LEFT JOIN (
			--	SELECT A.Sid_Sih_Key
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Sid_Sih_Key
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM SalesInvoiceItemDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Sid_Mm_Id
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Sid_Key = B.Tr_DdocKey
			--			AND A.Sid_Sih_Key = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 2
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Sid_Key = C.Tr_DdocKey
			--			AND A.Sid_Sih_Key = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 2
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Sid_Key = D.Tr_DdocKey
			--			AND A.Sid_Sih_Key = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 2
			--			AND D.Tr_TxId = 4
			--		INNER JOIN SalesInvoiceHeader SH1
			--		ON	SH1.Sih_Key=A.Sid_Sih_Key
			--		WHERE CONVERT(DATE, SH1.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--		) AS A
			--	GROUP BY A.Sid_Sih_Key
			--	) AS BB ON SH.Sih_Key = BB.Sid_Sih_Key
			--INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SH.Sih_Key
			--INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
        SELECT	SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date) AS BillDate,
        		SIH.Sih_No AS BillNo,
        		PM.Pm_Fullname AS PartyName,
        		ISNULL(SIH.Sih_SubTotal, 0.00) AS GrossAmount,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) + SUM(ISNULL(TXC.Tr_TxTot, 0)) + SUM(ISNULL(TXI.Tr_TxTot, 0)) AS TaxAmount,
        		ISNULL(SIH.Sih_DiscAmount, 0.00) AS Discount,
        		SIH.Sih_Total AS NetAmount,
        		BM.Branch_Name,
        		Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
        		bm.Branch_GstNo,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) AS SGST,
        		SUM(ISNULL(TXC.Tr_TxTot, 0)) AS CGST,
        		SUM(ISNULL(TXI.Tr_TxTot, 0)) AS IGST
        FROM	SalesInvoiceHeader SIH
        		LEFT JOIN PatientMaster(NOLOCK) AS PM 
        	ON	SIH.Sih_Pm_Id = PM.Pm_Id
        		LEFT JOIN BranchMaster(NOLOCK) BM 
        	ON	SIH.Sih_BranchId = BM.Branch_Id
        		INNER JOIN SalesInvoiceItemDetail SID
        	ON	SID.Sid_Sih_Key=SIH.Sih_Key
        	    INNER JOIN MedicineMaster(NOLOCK) MM 
        	ON	MM.Mm_ID = SID.Sid_Mm_Id
        		LEFT JOIN TaxTransaction TXS
        	ON	TXS.Tr_DdocKey=SID.Sid_Key
        		AND TXS.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXS.Tr_DocTyp=2
        		AND TXS.Tr_TxId=2
        		LEFT JOIN TaxTransaction TXC
        	ON	TXC.Tr_DdocKey=SID.Sid_Key
        		AND TXC.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXC.Tr_DocTyp=2
        		AND TXC.Tr_TxId=3
        		LEFT JOIN TaxTransaction TXI
        	ON	TXI.Tr_DdocKey=SID.Sid_Key
        		AND TXI.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXI.Tr_DocTyp=2
        		AND TXI.Tr_TxId=4
        WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
        					AND CONVERT(DATE, @Sih_DueDate, 105)
        				
        		GROUP BY
        		SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date),
        		SIH.Sih_No ,
        		PM.Pm_Fullname,
        		SIH.Sih_SubTotal,
        		SIH.Sih_DiscAmount,
        		SIH.Sih_Total,
        		BM.Branch_Name,
        		Bm.Branch_Address1,
        		Bm.Branch_Address2,
        		Bm.Branch_Address3,
        		bm.Branch_GstNo
        			
		END
	END;
	ELSE IF @SP_STATUS = 'Sales_HSN'
	BEGIN
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_111')
			BEGIN
				DROP TABLE ##TEMP_GST_111
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_222')
			BEGIN
				DROP TABLE ##TEMP_GST_222
			END
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_333')
			BEGIN
				DROP TABLE ##TEMP_GST_333
			END
		
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_444')
			BEGIN
				DROP TABLE ##TEMP_GST_444
			END
			
		iF EXiSTS(SELECT * FROM tempdb.sys.tables WHERE name='##TEMP_GST_555')
			BEGIN
				DROP TABLE ##TEMP_GST_555
			END
			
		SELECT	A.Tr_DocTyp,
				A.Tr_DocKey,
				A.Tr_DdocKey,
				CASE WHEN Tr_TxId=2 THEN Tr_TxVal ELSE 0 END AS CGST_P,
				CASE WHEN Tr_TxId=3 THEN Tr_TxVal ELSE 0 END AS SGST_P,
				CASE WHEN Tr_TxId=4 THEN Tr_TxVal ELSE 0 END AS IGST_P,
				
				CASE WHEN Tr_TxId=2 THEN Tr_TxTot ELSE 0 END AS CGST_V,
				CASE WHEN Tr_TxId=3 THEN Tr_TxTot ELSE 0 END AS SGST_V,
				CASE WHEN Tr_TxId=4 THEN Tr_TxTot ELSE 0 END AS IGST_V
		INTO	##TEMP_GST_111
		FROM	TaxTransaction A
		WHERE	A.Tr_TxId IN(2,3,4)
				AND A.Tr_DocTyp IN(2,3)
				
		SELECT	Tr_DocTyp,
				Tr_DocKey,
				Tr_DdocKey,
				SUM(CGST_P) AS CGST_P,
				SUM(SGST_P) AS SGST_P,
				SUM(IGST_P) AS IGST_P,
				
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		INTO	##TEMP_GST_222
		FROM	##TEMP_GST_111 A
		GROUP BY Tr_DocTyp,Tr_DocKey,Tr_DdocKey
		
		
		---Sales INvoice
		SELECT	C.Mm_HsnCode,
				B.Sid_SubTotal,
				A.*
		iNTO	##TEMP_GST_333
		FROM	##TEMP_GST_222 A
				iNNER JOIN SalesInvoiceItemDetail B
		ON			A.Tr_DdocKey=B.Sid_Key
					AND A.Tr_DocKey=B.Sid_Sih_Key
					AND A.Tr_DocTyp=2
				INNER JOIN MedicineMaster C
		ON			C.Mm_Id=B.Sid_Mm_Id
				INNER JOIN UomMaster D
		ON			D.Uom_ID=B.Sid_SalesUomId
				iNNER JOIN SalesInvoiceHeader E
		ON			B.Sid_Sih_Key=E.Sih_Key
			
		UNION
		---Sales Return
		SELECT	C.Mm_HsnCode,
				B.Srd_Amount,
				A.*
		FROM	##TEMP_GST_222 A
				iNNER JOIN SalesReturnDetail B
		ON			A.Tr_DdocKey=B.Srd_ID
					 AND A.Tr_DocKey=B.Srd_SrhId
					 AND A.Tr_DocTyp=3
				INNER JOIN MedicineMaster C
		ON			C.Mm_Id=B.Srd_MmId
				INNER JOIN UomMaster D
		ON			D.Uom_ID=B.Srd_UomId
				iNNER JOIN SalesReturnHeader E
		ON			B.Srd_SrhId=E.Srh_Id
		
		
		
		SELECT	Mm_HsnCode,
				Tr_DocTyp,
				Tr_DocKey,
				
				SUM(Sid_SubTotal) AS SubTotal,
				CGST_P,
				SGST_P,
				IGST_P,
				SUM(CGST_V) AS CGST_V,
				SUM(SGST_V) AS SGST_V,
				SUM(IGST_V) AS IGST_V
		iNTO	##TEMP_GST_444
		FROM	##TEMP_GST_333
		GROUP BY Tr_DocTyp,Tr_DocKey,CGST_P,SGST_P,IGST_P,Mm_HsnCode
		
		SELECT	Mm_HsnCode,
				Tr_DocTyp,	
				Tr_DocKey,
		
				SUM(CASE WHEN CGST_P>0 OR IGST_P>0 THEN 0 ELSE SubTotal END) [Taxable_0],
				SUM(CASE WHEN CGST_P=0 THEN CGST_V ELSE 0 END) [CGST_0],
				SUM(CASE WHEN SGST_P=0 THEN SGST_V ELSE 0 END) [SGST_0],
				SUM(CASE WHEN IGST_P=0   THEN IGST_V ELSE 0 END) [IGST_0],
				
				SUM(CASE WHEN CGST_P=2.5 OR IGST_P=5 THEN SubTotal ELSE 0 END) [Taxable_2_5],
				SUM(CASE WHEN CGST_P=2.5 THEN CGST_V ELSE 0 END) [CGST_2_5],
				SUM(CASE WHEN SGST_P=2.5 THEN SGST_V ELSE 0 END) [SGST_2_5],
				SUM(CASE WHEN IGST_P=5   THEN IGST_V ELSE 0 END) [IGST_5],
				
				SUM(CASE WHEN CGST_P=6 OR IGST_P=12 THEN SubTotal ELSE 0 END) [Taxable_6],
				SUM(CASE WHEN CGST_P=6 THEN CGST_V ELSE 0 END) [CGST_6],
				SUM(CASE WHEN SGST_P=6 THEN SGST_V ELSE 0 END) [SGST_6],
				SUM(CASE WHEN IGST_P=12   THEN IGST_V ELSE 0 END) [IGST_12],
				
				SUM(CASE WHEN CGST_P=9 OR IGST_P=18 THEN SubTotal ELSE 0 END) [Taxable_9],
				SUM(CASE WHEN CGST_P=9 THEN CGST_V ELSE 0 END) [CGST_9],
				SUM(CASE WHEN SGST_P=9 THEN SGST_V ELSE 0 END) [SGST_9],
				SUM(CASE WHEN IGST_P=18   THEN IGST_V ELSE 0 END) [IGST_18],
				
				SUM(CASE WHEN CGST_P=14 OR IGST_P=28 THEN SubTotal ELSE 0 END) [Taxable_14],
				SUM(CASE WHEN CGST_P=14 THEN CGST_V ELSE 0 END) [CGST_14],
				SUM(CASE WHEN SGST_P=14 THEN SGST_V ELSE 0 END) [SGST_14],
				SUM(CASE WHEN IGST_P=28   THEN IGST_V ELSE 0 END) [IGST_28],
				
				SUM(SubTotal) AS SubTotal,
				SUM(CGST_V) AS CGST_TOT,
				SUM(SGST_V) AS SGST_TOT,
				SUM(IGST_V) AS IGST_TOT,
				SUM(CGST_V+SGST_V+IGST_V) AS Total_Tax
		iNTO	##TEMP_GST_555
		FROM	##TEMP_GST_444
		GROUP BY Tr_DocTyp,Tr_DocKey,Mm_HsnCode
		
		SELECT * FROM (
		SELECT	'Sales Invoice' AS DocType,
				A.Mm_HsnCode,
				SUM(A.Taxable_0)AS Taxable_0,
				SUM(A.CGST_0)AS CGST_0,
				SUM(A.SGST_0)AS SGST_0,
				SUM(A.IGST_0)AS IGST_0,
				SUM(A.Taxable_2_5)AS Taxable_2_5,
				SUM(A.CGST_2_5)AS CGST_2_5,
				SUM(A.SGST_2_5)AS SGST_2_5,
				SUM(A.IGST_5)AS IGST_5,
				SUM(A.Taxable_6)AS Taxable_6,
				SUM(A.CGST_6)AS CGST_6,
				SUM(A.SGST_6)AS SGST_6,
				SUM(A.IGST_12)AS IGST_12,
				SUM(A.Taxable_9)AS Taxable_9,
				SUM(A.CGST_9)AS CGST_9,
				SUM(A.SGST_9)AS SGST_9,
				SUM(A.IGST_18)AS IGST_18,
				SUM(A.Taxable_14)AS Taxable_14,
				SUM(A.CGST_14)AS CGST_14,
				SUM(A.SGST_14)AS SGST_14,
				SUM(A.IGST_28)AS IGST_28,
				SUM(A.CGST_TOT)AS CGST_TOT,
				SUM(A.SGST_TOT)AS SGST_TOT,
				SUM(A.IGST_TOT)AS IGST_TOT,
				SUM(A.Total_Tax)AS Total_Tax
		FROM	##TEMP_GST_555 A
				iNNER jOIN SalesInvoiceHeader B
		ON			A.Tr_DocKey=B.Sih_Key
				AND A.Tr_DocTyp=2
				
		WHERE	CAST(B.Sih_DATE AS DATE) BETWEEN CAST(@Sih_DATE AS DATE) AND  CAST(@Sih_DueDATE AS DATE) 
				GROUP BY A.Mm_HsnCode
				
		UNION
		SELECT	'Sales Return' AS Sih_DocType,
		        A.Mm_HsnCode,
				SUM(A.Taxable_0)AS Taxable_0,
				SUM(A.CGST_0)AS CGST_0,
				SUM(A.SGST_0)AS SGST_0,
				SUM(A.IGST_0)AS IGST_0,
				SUM(A.Taxable_2_5)AS Taxable_2_5,
				SUM(A.CGST_2_5)AS CGST_2_5,
				SUM(A.SGST_2_5)AS SGST_2_5,
				SUM(A.IGST_5)AS IGST_5,
				SUM(A.Taxable_6)AS Taxable_6,
				SUM(A.CGST_6)AS CGST_6,
				SUM(A.SGST_6)AS SGST_6,
				SUM(A.IGST_12)AS IGST_12,
				SUM(A.Taxable_9)AS Taxable_9,
				SUM(A.CGST_9)AS CGST_9,
				SUM(A.SGST_9)AS SGST_9,
				SUM(A.IGST_18)AS IGST_18,
				SUM(A.Taxable_14)AS Taxable_14,
				SUM(A.CGST_14)AS CGST_14,
				SUM(A.SGST_14)AS SGST_14,
				SUM(A.IGST_28)AS IGST_28,
				SUM(A.CGST_TOT)AS CGST_TOT,
				SUM(A.SGST_TOT)AS SGST_TOT,
				SUM(A.IGST_TOT)AS IGST_TOT,
				SUM(A.Total_Tax)AS Total_Tax
		FROM	##TEMP_GST_555 A
				iNNER jOIN SalesReturnHeader B
		ON			A.Tr_DocKey=B.Srh_Id
				AND A.Tr_DocTyp=3
		        
		WHERE	CAST(B.Srh_DATE AS DATE) BETWEEN CAST(@Sih_DATE AS DATE) AND  CAST(@Sih_DueDATE AS DATE)
				GROUP BY A.Mm_HsnCode)AS DT
		ORDER BY DocType ASC 
	END
	ELSE IF @SP_STATUS = 'SalesHeaderForReportWithFilter_HSN'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
	     SELECT		B.Mm_HsnCode AS HSNCode,
	        		DT1.QTY AS QTY,
	        		SUM(AA.Sid_SubTotal) AS SubTotal,
	        		SUM(Tr_TxTot) AS TaxTotal,
	        		TX.Tax_Name AS TaxName,
	        		Tr_TxVal AS TaxValue,
					DT1.TotalAmount
	        FROM	SalesInvoiceItemDetail (NOLOCK) AA
					
                    INNER JOIN MedicineMaster (NOLOCK) B
	        ON			AA.Sid_Mm_Id = B.Mm_ID
					INNER JOIN (SELECT	SUM(TX.Tr_TxTot)AS TotalAmount,
										SUM(SID.Sid_SalesQty)AS QTY, 
										MM.Mm_HsnCode 
								FROM	SalesInvoiceItemDetail SID
										INNER JOIN TaxTransaction  TX
								ON		SID.Sid_Key = TX.Tr_DdocKey
            							AND SID.Sid_Sih_Key = TX.Tr_DocKey
            							AND TX.Tr_TxId in (1)
            							AND TX.Tr_DocTyp = 2
										INNER JOIN MedicineMaster MM
								ON		SID.Sid_Mm_Id = MM.Mm_ID 
										GROUP BY MM.Mm_HsnCode)AS DT1
			ON		DT1.Mm_HsnCode=B.Mm_HsnCode
                    LEFT JOIN MedicineTypeMaster (NOLOCK) MTM
            ON			MTM.Mtm_ID=B.Mm_MtmId
                    LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
            ON			MGM.Mgm_ID=B.Mm_MgmId
                    LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
            ON			MCM.Mcm_ID=B.Mm_McmId
                    LEFT JOIN SalesInvoiceHeader (NOLOCK) AS SH
            ON			SH.Sih_Key = AA.Sid_Sih_Key
	        		INNER JOIN TaxTransaction (NOLOCK) BB
            ON			AA.Sid_Key = BB.Tr_DdocKey
                    	AND AA.Sid_Sih_Key = BB.Tr_DocKey
                    	AND BB.Tr_TxId in (2,3,4)
                    	AND BB.Tr_DocTyp = 2
	        		INNER JOIN TaxMaster TX
	        ON			TX.Tax_ID=BB.Tr_TxId
	        WHERE	B.Mm_MtmId = @Sid_Mm_Id AND CAST(SH.Sih_Date AS DATE) BETWEEN  CAST(@Sih_Date AS DATE)
	        				AND CAST( @Sih_DueDate AS DATE)
	        		GROUP BY	B.Mm_HsnCode,
	        					TX.Tax_Name,
	        					Tr_TxVal,
								DT1.TotalAmount,
								DT1.QTY
	        		
	        		
		END
		ELSE
		BEGIN
			 SELECT	B.Mm_HsnCode AS HSNCode,
	        		DT1.QTY AS QTY,
	        		SUM(AA.Sid_SubTotal) AS SubTotal,
	        		SUM(Tr_TxTot) AS TaxTotal,
	        		TX.Tax_Name AS TaxName,
	        		Tr_TxVal AS TaxValue,
					DT1.TotalAmount
	        FROM	SalesInvoiceItemDetail (NOLOCK) AA
					
                    INNER JOIN MedicineMaster (NOLOCK) B
	        ON			AA.Sid_Mm_Id = B.Mm_ID
			        INNER JOIN (SELECT	SUM(TX.Tr_TxTot)AS TotalAmount,
										MM.Mm_HsnCode,
										SUM(SID.Sid_SalesQty)AS QTY 
								FROM	SalesInvoiceItemDetail SID
										INNER JOIN TaxTransaction  TX
								ON		SID.Sid_Key = TX.Tr_DdocKey
            							AND SID.Sid_Sih_Key = TX.Tr_DocKey
            							AND TX.Tr_TxId in (1)
            							AND TX.Tr_DocTyp = 2
										INNER JOIN MedicineMaster MM
								ON		SID.Sid_Mm_Id = MM.Mm_ID 
										GROUP BY MM.Mm_HsnCode)AS DT1
			ON		DT1.Mm_HsnCode=B.Mm_HsnCode
                    LEFT JOIN MedicineTypeMaster (NOLOCK) MTM
            ON			MTM.Mtm_ID=B.Mm_MtmId
                    LEFT JOIN MedicineGroupMaster (NOLOCK) MGM
            ON			MGM.Mgm_ID=B.Mm_MgmId
                    LEFT JOIN MedicineCategoryMaster (NOLOCK) MCM
            ON			MCM.Mcm_ID=B.Mm_McmId
                    LEFT JOIN SalesInvoiceHeader (NOLOCK) AS SH
            ON			SH.Sih_Key = AA.Sid_Sih_Key
	        		INNER JOIN TaxTransaction (NOLOCK) BB
            ON			AA.Sid_Key = BB.Tr_DdocKey
                    	AND AA.Sid_Sih_Key = BB.Tr_DocKey
                    	AND BB.Tr_TxId in (2,3,4)
                    	AND BB.Tr_DocTyp = 2
	        		INNER JOIN TaxMaster TX
	        ON			TX.Tax_ID=BB.Tr_TxId
	        WHERE	 CAST(SH.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
	        				AND CAST(@Sih_DueDate AS DATE)
	        		GROUP BY	B.Mm_HsnCode,
	        					TX.Tax_Name,
	        					Tr_TxVal,
								DT1.TotalAmount,
								DT1.QTY
		END
	END
	ELSE IF @SP_STATUS = 'SalesDetailForReportWithFilter'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
            SELECT	Sh.Sih_Key,
            		CONVERT(DATE, SH.Sih_Date) AS BillDate,
            		SH.Sih_No AS BillNo,
            		PM.Pm_Fullname AS PartyName,
            		ISNULL(ITotalTax.CGST,0.00) AS CGST,
            		ISNULL(ITotalTax.SGST,0.00) AS SGST,
            		ISNULL(ITotalTax.IGST,0.00) AS IGST,
            		ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount,
            		ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
            		ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount,
            		SH.Sih_Total AS NetAmount,
            		BM.Branch_Name,
            		bm.Branch_GstNo,
            		MM.Mm_Name MedicinName,
            		UM.Uom_Name AS UOM,
            		'' AS PackSize,
            		SD.Sid_ExpDate AS ExpDate,
            		SD.Sid_BatchNo AS BatchNo,
            		ISNULL(ATXC.Tr_TxTot,0.00) AS ItemCGST,
            		ISNULL(ATXS.Tr_TxTot,0.00) AS ItemSGST,
            		ISNULL(ATXI.Tr_TxTot,0.00) AS ItemIGST,
            		SD.Sid_SalesRate AS Rate,
            		SD.Sid_Total AS Total,
            		SD.Sid_PurchaseQty AS Qty,
            		MTM.Mtm_TypeName AS DrugType,
            		MGM.Mgm_Name AS DrugGroup,
            		MCM.Mcm_Name AS DrugCategory,
            		MM.Mm_Code AS DrugCode,
            		MM.Mm_HsnCode AS HsnCode,
					DT1.TotalAmount
            FROM	SalesInvoiceHeader(NOLOCK) AS SH
					LEFT JOIN (SELECT SUM(Sih_Total) AS TotalAmount,1 AS ID
								 FROM SalesInvoiceHeader SIH3
								 	  INNER JOIN SalesInvoiceItemDetail SID3
								 ON		SID3.Sid_Sih_Key=SIH3.Sih_Key
								WHERE	CAST(SIH3.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
										AND CAST(@Sih_DueDate AS DATE)
								)AS DT1
			ON		ID=1
            		LEFT JOIN PatientMaster(NOLOCK) AS PM 
            ON		SH.Sih_Pm_Id = PM.Pm_Id
            		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD 
            ON		SH.Sih_Key = SD.Sid_Sih_Key
            		LEFT JOIN (SELECT	SID1.Sid_Sih_Key,
            							SUM(ISNULL(TXS.Tr_TxTot,0)) AS SGST,
            							SUM(ISNULL(TXC.Tr_TxTot,0)) AS CGST,
            							SUM(ISNULL(TXI.Tr_TxTot,0)) AS IGST
            					FROM	SalesInvoiceHeader(NOLOCK) SIH1
            							INNER JOIN SalesInvoiceItemDetail SID1
            					ON		SID1.Sid_Sih_Key=SIH1.Sih_Key
            							LEFT JOIN TaxTransaction(NOLOCK) TXS
            					ON		TXS.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXS.Tr_DdocKey=SID1.Sid_Key
            							AND TXS.Tr_TxId=2
            							AND TXS.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXC
            					ON		TXC.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXC.Tr_DdocKey=SID1.Sid_Key
            							AND TXC.Tr_TxId=3
            							AND TXC.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXI
            					ON		TXI.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXI.Tr_DdocKey=SID1.Sid_Key
            							AND TXI.Tr_TxId=4
            							AND TXI.Tr_DocTyp=2
            					GROUP BY Sid_Sih_Key )AS ITotalTax
            ON		ITotalTax.Sid_Sih_Key=SH.Sih_Key
            		LEFT JOIN TaxTransaction(NOLOCK) ATXS
            ON		ATXS.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXS.Tr_DdocKey=SD.Sid_Key
            		AND ATXS.Tr_TxId=2
            		AND ATXS.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXC
            ON		ATXC.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXC.Tr_DdocKey=SD.Sid_Key
            		AND ATXC.Tr_TxId=3
            		AND ATXC.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXI
            ON		ATXI.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXI.Tr_DdocKey=SD.Sid_Key
            		AND ATXI.Tr_TxId=4
            		AND ATXI.Tr_DocTyp=2
            		LEFT JOIN MedicineMaster(NOLOCK) AS MM 
            ON		SD.Sid_Mm_Id = MM.Mm_ID
            		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM 
            ON		MTM.Mtm_ID = MM.Mm_MtmId
            		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM 
            ON		MGM.Mgm_ID = MM.Mm_MgmId
            		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM 
            ON		MCM.Mcm_ID = MM.Mm_McmId
            		LEFT JOIN UomMaster(NOLOCK) AS UM 
            ON		SD.Sid_PurchaseUomId = UM.Uom_ID
            		LEFT JOIN BranchMaster BM 
            ON		SH.Sih_BranchId = BM.Branch_Id
		WHERE		CAST(SH.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
					AND CAST(@Sih_DueDate AS DATE)
					AND MM.Mm_MtmId = @Sid_Mm_Id
					ORDER BY SH.Sih_Key ASC
		
			--SELECT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
			--	,ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,2,2),0.00) AS CGST,
			--	ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,3,2),0.00) AS SGST,
			--	ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,4,2),0.00) AS IGST
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,MM.Mm_Name MedicinName
			--	,UM.Uom_Name AS UOM
			--	,'' AS PackSize
			--	,SD.Sid_ExpDate AS ExpDate
			--	,SD.Sid_BatchNo AS BatchNo
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,2,2,SD.Sid_Key),0.00) AS ItemCGST
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,3,2,SD.Sid_Key),0.00) AS ItemSGST
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,4,2,SD.Sid_Key),0.00) AS ItemIGST
			--	,SD.Sid_SalesRate AS Rate
			--	,SD.Sid_Total AS Total
			--	,SD.Sid_PurchaseQty AS Qty
			--	,MTM.Mtm_TypeName AS DrugType
			--	,MGM.Mgm_Name AS DrugGroup
			--	,MCM.Mcm_Name AS DrugCategory
			--	,MM.Mm_Code AS DrugCode
			--	,MM.Mm_HsnCode AS HsnCode
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
			--LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
			--LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			--LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			--LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			--LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
			----LEFT JOIN PacketSizeMater AS PSM
			----  ON PSM.Ps_ID = SD.Sid_PackId
			----LEFT JOIN  MedicinePacketSizeMaster   AS PSM
			----on  psm.Mps_Id=sd.Sid_PackId
			--LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--	AND MM.Mm_MtmId = @Sid_Mm_Id
		END
		ELSE
		BEGIN
			--SELECT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
			--	,ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,2,2),0.00) AS CGST,
			--	ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,3,2),0.00) AS SGST,
			--	ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,4,2),0.00) AS IGST
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,MM.Mm_Name MedicinName
			--	,UM.Uom_Name AS UOM
			--	,'' AS PackSize
			--	,SD.Sid_ExpDate AS ExpDate
			--	,SD.Sid_BatchNo AS BatchNo
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,2,2,SD.Sid_Key),0.00) AS ItemCGST
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,3,2,SD.Sid_Key),0.00) AS ItemSGST
			--	,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,4,2,SD.Sid_Key),0.00) AS ItemIGST
			--	,SD.Sid_SalesRate AS Rate
			--	,SD.Sid_Total AS Total
			--	,SD.Sid_PurchaseQty AS Qty
			--	,MTM.Mtm_TypeName AS DrugType
			--	,MGM.Mgm_Name AS DrugGroup
			--	,MCM.Mcm_Name AS DrugCategory
			--	,MM.Mm_Code AS DrugCode
			--	,MM.Mm_HsnCode AS HsnCode
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
			--LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
			--LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			--LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			--LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			--LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
			----LEFT JOIN PacketSizeMater AS PSM
			----  ON PSM.Ps_ID = SD.Sid_PackId
			----LEFT JOIN  MedicinePacketSizeMaster   AS PSM
			----on  psm.Mps_Id=sd.Sid_PackId
			--LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			 SELECT	Sh.Sih_Key,
            		CONVERT(DATE, SH.Sih_Date) AS BillDate,
            		SH.Sih_No AS BillNo,
            		PM.Pm_Fullname AS PartyName,
            		ISNULL(ITotalTax.CGST,0.00) AS CGST,
            		ISNULL(ITotalTax.SGST,0.00) AS SGST,
            		ISNULL(ITotalTax.IGST,0.00) AS IGST,
            		ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount,
            		ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
            		ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount,
            		SH.Sih_Total AS NetAmount,
            		BM.Branch_Name,
            		bm.Branch_GstNo,
            		MM.Mm_Name MedicinName,
            		UM.Uom_Name AS UOM,
            		'' AS PackSize,
            		SD.Sid_ExpDate AS ExpDate,
            		SD.Sid_BatchNo AS BatchNo,
            		ISNULL(ATXC.Tr_TxTot,0.00) AS ItemCGST,
            		ISNULL(ATXS.Tr_TxTot,0.00) AS ItemSGST,
            		ISNULL(ATXI.Tr_TxTot,0.00) AS ItemIGST,
            		SD.Sid_SalesRate AS Rate,
            		SD.Sid_Total AS Total,
            		SD.Sid_PurchaseQty AS Qty,
            		MTM.Mtm_TypeName AS DrugType,
            		MGM.Mgm_Name AS DrugGroup,
            		MCM.Mcm_Name AS DrugCategory,
            		MM.Mm_Code AS DrugCode,
            		MM.Mm_HsnCode AS HsnCode,
					DT1.TotalAmount
            FROM	SalesInvoiceHeader(NOLOCK) AS SH
					LEFT JOIN (SELECT SUM(Sih_Total) AS TotalAmount,1 AS ID
								 FROM SalesInvoiceHeader SIH3
								 	  INNER JOIN SalesInvoiceItemDetail SID3
								 ON		SID3.Sid_Sih_Key=SIH3.Sih_Key
								WHERE	CAST(SIH3.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
										AND CAST(@Sih_DueDate AS DATE)
								)AS DT1
			ON		ID=1
            		LEFT JOIN PatientMaster(NOLOCK) AS PM 
            ON		SH.Sih_Pm_Id = PM.Pm_Id
            		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD 
            ON		SH.Sih_Key = SD.Sid_Sih_Key
            		LEFT JOIN (SELECT	SID1.Sid_Sih_Key,
            							SUM(ISNULL(TXS.Tr_TxTot,0)) AS SGST,
            							SUM(ISNULL(TXC.Tr_TxTot,0)) AS CGST,
            							SUM(ISNULL(TXI.Tr_TxTot,0)) AS IGST
            					FROM	SalesInvoiceHeader(NOLOCK) SIH1
            							INNER JOIN SalesInvoiceItemDetail SID1
            					ON		SID1.Sid_Sih_Key=SIH1.Sih_Key
            							LEFT JOIN TaxTransaction(NOLOCK) TXS
            					ON		TXS.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXS.Tr_DdocKey=SID1.Sid_Key
            							AND TXS.Tr_TxId=2
            							AND TXS.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXC
            					ON		TXC.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXC.Tr_DdocKey=SID1.Sid_Key
            							AND TXC.Tr_TxId=3
            							AND TXC.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXI
            					ON		TXI.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXI.Tr_DdocKey=SID1.Sid_Key
            							AND TXI.Tr_TxId=4
            							AND TXI.Tr_DocTyp=2
            					GROUP BY Sid_Sih_Key )AS ITotalTax
            ON		ITotalTax.Sid_Sih_Key=SH.Sih_Key
            		LEFT JOIN TaxTransaction(NOLOCK) ATXS
            ON		ATXS.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXS.Tr_DdocKey=SD.Sid_Key
            		AND ATXS.Tr_TxId=2
            		AND ATXS.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXC
            ON		ATXC.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXC.Tr_DdocKey=SD.Sid_Key
            		AND ATXC.Tr_TxId=3
            		AND ATXC.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXI
            ON		ATXI.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXI.Tr_DdocKey=SD.Sid_Key
            		AND ATXI.Tr_TxId=4
            		AND ATXI.Tr_DocTyp=2
            		LEFT JOIN MedicineMaster(NOLOCK) AS MM 
            ON		SD.Sid_Mm_Id = MM.Mm_ID
            		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM 
            ON		MTM.Mtm_ID = MM.Mm_MtmId
            		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM 
            ON		MGM.Mgm_ID = MM.Mm_MgmId
            		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM 
            ON		MCM.Mcm_ID = MM.Mm_McmId
            		LEFT JOIN UomMaster(NOLOCK) AS UM 
            ON		SD.Sid_PurchaseUomId = UM.Uom_ID
            		LEFT JOIN BranchMaster BM 
            ON		SH.Sih_BranchId = BM.Branch_Id
		WHERE		CAST(SH.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
					AND CAST(@Sih_DueDate AS DATE)
					ORDER BY SH.Sih_Key ASC
		END
	END;
	ELSE IF @SP_STATUS = 'DashboardNotification'
	BEGIN
		SELECT (
				SELECT CONVERT(INT, ISNULL(SUM(Sih_Total), 0))
				FROM SalesInvoiceHeader(NOLOCK) SH
				WHERE CONVERT(DATE, SH.Sih_Date, 105) = CONVERT(DATE, GETDATE())
				) AS DAYSALES
			,(
				SELECT CONVERT(INT, ISNULL(SUM(Sih_Total), 0))
				FROM SalesInvoiceHeader(NOLOCK) SH
				WHERE MONTH(CONVERT(DATE, SH.Sih_Date, 105)) = MONTH(CONVERT(DATE, GETDATE()))
				) AS MonthSALES
			,(
				SELECT COUNT(*)
				FROM (
					SELECT mm.Mm_Code
						,ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock
					FROM dbo.MedicineMaster(NOLOCK) mm
					LEFT JOIN dbo.vwStock(NOLOCK) ON mm.Mm_ID = dbo.vwStock.Item_Id
					WHERE Mm_IsActive = 1
					GROUP BY mm.Mm_Code
					) AS OutStock
				WHERE Stock = 0
				) AS OutStockCount
			,(
				SELECT COUNT(*)
				FROM vwStockBatchWise(NOLOCK)
				WHERE (
						CONVERT(DATE, Stk_ExpDate) <= CONVERT(DATE, DATEADD(MONTH, 6, GETDATE()))
						AND CONVERT(DATE, Stk_ExpDate) >= CONVERT(DATE, GETDATE())
						)
					AND ISNULL(QTY, 0) > 0
				) AS NearByExpiry
	END;

	ELSE IF @SP_STATUS = 'GET_TAX_VALUE'
		BEGIN
			(SELECT STUFF((SELECT ', ' + CAST(ISNULL(SUM(Tr_TxTot),0) AS NVARCHAR(MAX)) + ' ( ' + CAST(Tr_TxVal AS NVARCHAR(MAX)) + ' ) ' FROM TaxTransaction (NOLOCk) t2
			WHERE t1.Tr_DocTyp = t2.Tr_DocTyp AND t1.Tr_DocKey = t2.Tr_DocKey AND t1.Tr_TxId = t2.tr_TxId
			GROUP BY t2.Tr_TxVal
			FOR XML PATH ('')), 1, 1, '')  AS Taxation FROM TaxTransaction (NOLOCK) t1 WHERE T1.Tr_DocKey = @Tr_DocKey
			AND t1.Tr_TxId = @Tr_TxId AND t1.Tr_DocTyp = @Tr_DocType GROUP BY t1.Tr_DocTyp,T1.Tr_DocKey,t1.Tr_TxId)
		END

	ELSE IF @SP_STATUS = 'MonthlySalesNotification'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,2,2),0.00) AS CGST,
			ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,3,2),0.00) AS SGST,
			ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,4,2),0.00) AS IGST,
			--,(SELECT CAST(ISNULL(SUM(Tr_TxTot),0) AS NVARCHAR(MAX)) + '(' + CAST(Tr_TxVal AS NVARCHAR(MAX)) + ')'	FROM TaxTransaction (NOLOCK) TT WHERE TT.Tr_DocKey = SH.Sih_Key AND Tr_TxId = 3 GROUP BY Tr_TxVal) AS GrandSGST
			--,(SELECT CAST(ISNULL(SUM(Tr_TxTot),0) AS NVARCHAR(MAX)) + '(' + CAST(Tr_TxVal AS NVARCHAR(MAX)) + ')'	FROM TaxTransaction (NOLOCK) TT WHERE TT.Tr_DocKey = SH.Sih_Key AND Tr_TxId = 4 GROUP BY Tr_TxVal) AS GrandIGST
			ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,2,2,SD.Sid_Key),0.00) AS ItemCGST
			,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,3,2,SD.Sid_Key),0.00) AS ItemSGST
			,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,4,2,SD.Sid_Key),0.00) AS ItemIGST
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_SalesQty AS Qty
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_SalesUomId = UM.Uom_ID
		--LEFT JOIN PacketSizeMater AS PSM
		--  ON PSM.Ps_ID = SD.Sid_PackId
		--LEFT JOIN  MedicinePacketSizeMaster   AS PSM
		--on  psm.Mps_Id=sd.Sid_PackId
		LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
		WHERE MONTH(CONVERT(DATE, SH.Sih_Date, 105)) = MONTH(GETDATE())
	END;
	ELSE IF @SP_STATUS = 'SP_RPT_StockAndSalesReport'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			SELECT ISNULL(MTM.Mtm_TypeName, '') AS DRUGTYPENAME
				,ISNULL(MCM.Mcm_Name, '') AS DRUGCATEGORY
				,ISNULL(MGM.Mgm_Name, '') AS DRUGGROUP
				,MM.Mm_Code AS DRUGCODE
				,MM.Mm_Name AS DRUGNAME
				,MM.Mm_HsnCode AS HSNCODE
				,ISNULL(STOCK.PURCHASEUNIT, PPUOM.Uom_Name) AS PURCHASEUNIT
				,MM.MM_PackSize AS PACKSIZE
				,ISNULL((
						SELECT (
								SUM(CASE 
										WHEN Stk_Tran_Typ = 'C'
											THEN Stk_PurchaseQty
										ELSE 0
										END) - SUM(CASE 
										WHEN Stk_Tran_Typ = 'D'
											THEN Stk_PurchaseQty
										ELSE 0
										END)
								)
						FROM StockRegister
						WHERE CONVERT(DATE, StockRegister.Stk_Date, 105) < CONVERT(DATE, @Sih_Date)
							AND StockRegister.Stk_MmId = STOCK.Stk_MmId
						GROUP BY StockRegister.Stk_MmId
						), 0) AS OPENINGSTOCK
				,ISNULL(STOCK.PUSALESQTY, 0) AS SALESQTY
				,ISNULL(STOCK.PUPURCHASEQTY, 0) AS PURCHASEQTY
				,ISNULL((OPENINGSTOCK.PPUPURCHASEQTY - OPENINGSTOCK.PPUSALESQTY), 0) AS CURRENTSTOCK
				,ISNULL(MM.Mm_MRP, 0) AS MRP
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_DATE
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN ''
							ELSE CONVERT(VARCHAR, (
										SELECT TOP 1 Stk_DATE
										FROM StockRegister
										WHERE Stk_MmId = MM.Mm_ID
											AND Stk_Tran_Typ = 'C'
											AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
												AND CONVERT(DATE, @Sih_DueDate)
										ORDER BY Stk_Date DESC
										), 105)
							END
						), '') AS LASTSTOCKRECEIVEDATE
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN 0
							ELSE (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									)
							END
						), 0) AS LASTSTOCKRECEIVEQTY
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM MedicineMaster(NOLOCK) MM
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = 1
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS STOCK ON STOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) <= CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS OPENINGSTOCK ON OPENINGSTOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN UomMaster(NOLOCK) PPUOM ON PPUOM.Uom_ID = MM.MM_PurchaseUom
			WHERE MM.Mm_MtmId = @Sid_Mm_Id
			ORDER BY MM.Mm_Name
				,MTM.Mtm_TypeName
				,MCM.Mcm_Name
				,MGM.Mgm_Name ASC
		END
		ELSE
		BEGIN
			SELECT ISNULL(MTM.Mtm_TypeName, '') AS DRUGTYPENAME
				,ISNULL(MCM.Mcm_Name, '') AS DRUGCATEGORY
				,ISNULL(MGM.Mgm_Name, '') AS DRUGGROUP
				,MM.Mm_Code AS DRUGCODE
				,MM.Mm_Name AS DRUGNAME
				,MM.Mm_HsnCode AS HSNCODE
				,ISNULL(STOCK.PURCHASEUNIT, PPUOM.Uom_Name) AS PURCHASEUNIT
				,MM.MM_PackSize AS PACKSIZE
				,ISNULL((
						SELECT (
								SUM(CASE 
										WHEN Stk_Tran_Typ = 'C'
											THEN Stk_PurchaseQty
										ELSE 0
										END) - SUM(CASE 
										WHEN Stk_Tran_Typ = 'D'
											THEN Stk_PurchaseQty
										ELSE 0
										END)
								)
						FROM StockRegister
						WHERE CONVERT(DATE, StockRegister.Stk_Date, 105) < CONVERT(DATE, @Sih_Date)
							AND StockRegister.Stk_MmId = STOCK.Stk_MmId
						GROUP BY StockRegister.Stk_MmId
						), 0) AS OPENINGSTOCK
				,ISNULL(STOCK.PUSALESQTY, 0) AS SALESQTY
				,ISNULL(STOCK.PUPURCHASEQTY, 0) AS PURCHASEQTY
				,ISNULL((OPENINGSTOCK.PPUPURCHASEQTY - OPENINGSTOCK.PPUSALESQTY), 0) AS CURRENTSTOCK
				,ISNULL(MM.Mm_MRP, 0) AS MRP
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_DATE
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN ''
							ELSE CONVERT(VARCHAR, (
										SELECT TOP 1 Stk_DATE
										FROM StockRegister
										WHERE Stk_MmId = MM.Mm_ID
											AND Stk_Tran_Typ = 'C'
											AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
												AND CONVERT(DATE, @Sih_DueDate)
										ORDER BY Stk_Date DESC
										), 105)
							END
						), '') AS LASTSTOCKRECEIVEDATE
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN 0
							ELSE (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									)
							END
						), 0) AS LASTSTOCKRECEIVEQTY
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM MedicineMaster(NOLOCK) MM
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = 1
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS STOCK ON STOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) <= CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS OPENINGSTOCK ON OPENINGSTOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN UomMaster(NOLOCK) PPUOM ON PPUOM.Uom_ID = MM.MM_PurchaseUom
			ORDER BY MM.Mm_Name
				,MTM.Mtm_TypeName
				,MCM.Mcm_Name
				,MGM.Mgm_Name ASC
		END
	END;
	ELSE IF @SP_STATUS = 'GET_SI_NO'
	BEGIN
		SELECT SIH.Sih_No
		FROM SalesInvoiceHeader(NOLOCK) SIH
		WHERE SIH.Sih_Key = @Sih_Key
	END
	ELSE IF @SP_STATUS = 'GetStoreInfo'
	BEGIN
		SELECT TOP 1 Store_Name AS Branch_Name
			,Store_Address1 AS Branch_Address
			,Store_GstNo AS Branch_GstNo
			,Store_DrugLice AS Branch_DrugLice
			,Store_MobNo AS Branch_MobNo
			,Store_Email AS Branch_Email
			,C.City_Name AS Store_City
			
		FROM StoreMaster S
		INNER JOIN CityMaster C ON C.City_ID = Store_CityId
	END
	ELSE IF @SP_STATUS = 'GetOverDueBills'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_PurchaseQty AS Qty
			,MTM.Mtm_TypeName AS DrugType
			,MGM.Mgm_Name AS DrugGroup
			,MCM.Mcm_Name AS DrugCategory
			,MM.Mm_Code AS DrugCode
			,MM.Mm_HsnCode AS HsnCode
			,sh.Sih_DueDate AS DueDate
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
		LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
		LEFT JOIN AccountTransaction at ON at.Act_DocNo = SH.Sih_No
		WHERE ISNULL(at.Act_Amount, 0) > ISNULL(at.Act_PaidAmount, 0) + ISNULL(at.Act_AdjustAmount, 0)
			AND at.Act_DocType = 2
			AND at.Act_SrNo = 1
			AND CONVERT(DATE, sh.Sih_DueDate) < CONVERT(DATE, GETDATE())
	END
	ELSE IF @SP_STATUS = 'SYNCH_UPDATE'-----Update Synch Status ---Add Hasmukh
	BEGIN
	     UPDATE SalesInvoiceHeader
		 SET	Sih_IsSync='true',	
			    Sih_LastSyncDate=GETDATE()
		  WHERE	Sih_Key=@Sih_Key
		  SELECT @ID=@Sih_Key;
	END
	ELSE IF @SP_STATUS = 'Get_Report_Format'
	BEGIN
		Select * from ReportsConfig
		WHERe IsActive=1 and DocType=@DocType
	END
	ELSE IF @SP_STATUS = 'Bind_Combo_ReportsConfig'
	BEGIN
		SELECT	0 AS ID,  '--Select--' AS NAME
		UNION
		Select  id as  ID , ReportSize  AS NAME
		from	ReportsConfig (nolock)
	END
	ELSE  IF @SP_STATUS = 'Update_ReportConfig'
		BEGIN
			UPDATE	ReportsConfig  
			SET		IsActive=0

			UPDATE	ReportsConfig  
			SET		DirectPrint=@DirectPrint,
					IsActive=@IsActive
			WHERE	id= @Reportid
		END
	ELSE  IF @SP_STATUS = 'MedicineScheduleList'
		BEGIN
			SELECT		Distinct(ISNULL(MM.Mm_Schedule,''))AS Mm_Schedule
			FROM		MedicineMaster MM
		END
	ELSE  IF @SP_STATUS = 'H1DrugReport'
		BEGIN
			SELECT		A.Sih_No,
						CONVERT(VARCHAR,A.Sih_Date,105)AS Sih_Date,
						D.Pm_Fullname AS PartyName,
						E.Dm_Name AS DoctorName,
						C.Mm_Code,
						C.Mm_Name,
						F.Uom_Name,
						B.Sid_SalesQty,
						B.Sid_BatchNo,
						(CASE WHEN B.Sid_MnfDate IS NULL THEN '' ELSE CONVERT(VARCHAR,B.Sid_MnfDate,105) END)AS Sid_MnfDate,
						(CASE WHEN B.Sid_ExpDate IS NULL THEN '' ELSE CONVERT(VARCHAR,B.Sid_ExpDate,105) END)AS Sid_ExpDate
			FROM		SalesInvoiceHeader A
						INNER JOIN SalesInvoiceItemDetail B
			ON			B.Sid_Sih_Key=A.Sih_Key
						INNER JOIN MedicineMaster C
			ON			C.Mm_ID=B.Sid_Mm_Id
						INNER JOIN PatientMaster D
			ON			D.Pm_Id=A.Sih_Pm_Id
						LEFT JOIN DoctorMaster E
			ON			E.Dm_Id=A.Sih_Dm_Id
						INNER JOIN UomMaster F
			ON			F.Uom_ID=B.Sid_SalesUomId
			WHERE		C.Mm_Schedule=@Sih_Remark
						AND Sih_Date BETWEEN CAST(@Sih_Date AS DATE) AND CAST(@Sih_DueDate AS DATE)
		END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_SalesInvoice_cPOS]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 21.April.2018
-- Description:	For Sync Dispatch Detail
-- =============================================
CREATE PROCEDURE  [dbo].[SP_SalesInvoice_cPOS]
@SP_STATUS				varchar(200)		= '',
@Sih_Key				NUMERIC(18,0)		= 0,					
@Sih_Store_Code			varchar(50)			= '',			
@Sih_No					decimal(18, 0)		= 0,				
@Sih_Date				datetime			= NULL,				
@Sih_Sales_Order_No		decimal(18, 0)		= 0,	
@Sih_Po_No				decimal(18, 0)		= 0,				
@Sih_SubTotal			numeric(18, 3)		= 0,	
@Sih_Total				numeric(18, 3)		= 0,			
@Sih_LastUpdated		datetime			= NULL,	
@Sih_Disc_Per			numeric(5, 2)		= 0,			
@Sih_DiscAmount			numeric(18, 3)		= 0,			
@Sih_DueDate			date				= NULL,	
@Sih_Sgst_Amt			numeric(18, 3)		= 0,			
@Sih_Cgst_Amt			numeric(18, 3)		= 0,			
@Sih_Igst_Amt			numeric(18, 3)		= 0,			
@Sih_Total_Tax			numeric(18, 3)		= 0,			
@Sih_Docket_No			varchar(50)			= '',				
@Sih_Transporter_Name	varchar(100)		= '',	
@Sih_Lr_No				varchar(50)			= '',					
@Sih_Lr_Date			datetime			= NULL,		
@ID						NUMERIC(18,0)		= 0 OUT,	
@Sid_Key				NUMERIC(18,0)			= 0,
@Sid_Sih_Key			NUMERIC(18,0)			= 0,
@Sid_SrNo				[int]				= 0,
@Sid_Item_Code			[varchar](200)		= NULL,
@Sid_Item_MRP			[numeric](12, 2)	= 0,
@Sid_ExpDate			[date]				= NULL,
@Sid_Qty				[numeric](12, 3)	= 0,
@Sid_Item_Rate			[numeric](12, 2)	= 0,
@Sid_SubTotal			[numeric](12, 2)	= 0,
@Sid_Total				[numeric](12, 2)	= 0,
@Sid_MnfDate			[date]				= NULL,
@Sid_Disc				[numeric](5, 2)		= 0,
@Sid_DiscAmount			[numeric](18, 2)	= 0,
@Sid_Free_Qty			[numeric](12, 3)	= 0,
@Sid_UomId				[int]				= 0,
@Sid_Sgst_Per			[numeric](5, 2)		= 0,
@Sid_Cgst_Per			[numeric](5, 2)		= 0,
@Sid_Igst_Per			[numeric](5, 2)		= 0,
@Sid_Batch_No			[nvarchar](max)		= NULL,
@Sid_LastUpdated		[datetime]			= NULL
AS
BEGIN
	IF @SP_STATUS='SYNC_HEADER'
		BEGIN
			IF NOT EXISTS(SELECT * FROM cPOS_SalesInvoiceHeader WHERE Sih_No = @Sih_No)
				BEGIN
					--DECLARE @MSG	VARCHAR(500)=''
				
					--SELECT @Sih_Key = Sih_Key FROM cPOS_SalesInvoiceHeader WHERE Sih_No = @Sih_No
					--IF (ISNULL(@Sih_Key,0) = 0)
					--	BEGIN
							--SET @MSG='iNSERT ' +CONVERT(VARCHAR(10),@Sih_Key)
							--RAISERROR(@MSG,14,9)
							INSERT 
							INTO	cPOS_SalesInvoiceHeader
							(
								Sih_Key,Sih_Store_Code,Sih_No,Sih_Date,Sih_Sales_Order_No,Sih_Po_No,				
								Sih_SubTotal,Sih_Total,Sih_LastUpdated,Sih_Disc_Per,
								Sih_DiscAmount,Sih_DueDate,Sih_Sgst_Amt,Sih_Cgst_Amt,Sih_Igst_Amt,
								Sih_Total_Tax,Sih_Docket_No,Sih_Transporter_Name,Sih_Lr_No,Sih_Lr_Date			
							)
							VALUES
							(
								@Sih_Key,@Sih_Store_Code,@Sih_No,@Sih_Date,@Sih_Sales_Order_No,		
								@Sih_Po_No,@Sih_SubTotal,@Sih_Total,@Sih_LastUpdated,@Sih_Disc_Per,			
								@Sih_DiscAmount,@Sih_DueDate,@Sih_Sgst_Amt,@Sih_Cgst_Amt,@Sih_Igst_Amt,			
								@Sih_Total_Tax,@Sih_Docket_No,@Sih_Transporter_Name,@Sih_Lr_No,@Sih_Lr_Date
							)

							DELETE		cPOS_SalesInvoiceItemDetail
							FROM		cPOS_SalesInvoiceItemDetail A
									inNER jOIN cPOS_SalesInvoiceHeader B
							ON			A.Sid_Sih_Key=B.Sih_Key
							WHERE	B.Sih_No = @Sih_No

							--SET @ID = ABS(@Sih_Key)
						--END
					--ELSE
					--	BEGIN
					--		SET @MSG='UPDATE ' +CONVERT(VARCHAR(10),@Sih_Key)
					--		RAISERROR(@MSG,14,9)
					--		DELETE 
					--		FROM	cPOS_SalesInvoiceItemDetail 
					--		WHERE	Sid_Sih_Key = @Sih_Key
								
					--		UPDATE	cPOS_SalesInvoiceHeader
					--		SET		Sih_Store_Code=@Sih_Store_Code,Sih_Date=@Sih_Date,Sih_Sales_Order_No=@Sih_Sales_Order_No,Sih_Po_No=Sih_Po_No,Sih_SubTotal=@Sih_SubTotal,
					--				Sih_Total=@Sih_Total,Sih_LastUpdated=Sih_LastUpdated,Sih_Disc_Per=@Sih_Disc_Per,Sih_DiscAmount=@Sih_DiscAmount,Sih_DueDate=@Sih_DueDate,
					--				Sih_Sgst_Amt=@Sih_Sgst_Amt,Sih_Cgst_Amt=@Sih_Cgst_Amt,Sih_Igst_Amt=@Sih_Igst_Amt,Sih_Total_Tax=@Sih_Total_Tax,Sih_Docket_No=@Sih_Docket_No,
					--				Sih_Transporter_Name=@Sih_Transporter_Name,Sih_Lr_No=@Sih_Lr_No,Sih_Lr_Date=@Sih_Lr_Date			
					--		WHERE	Sih_Key=@Sih_Key
					--		SET @ID = @Sih_Key
					--	END
				END
			ELSE
				BEGIN
					UPDATE	cPOS_SalesInvoiceHeader
					SET		Sih_Store_Code=@Sih_Store_Code,Sih_Date=@Sih_Date,Sih_Sales_Order_No=@Sih_Sales_Order_No,Sih_Po_No=Sih_Po_No,Sih_SubTotal=@Sih_SubTotal,
							Sih_Total=@Sih_Total,Sih_LastUpdated=Sih_LastUpdated,Sih_Disc_Per=@Sih_Disc_Per,Sih_DiscAmount=@Sih_DiscAmount,Sih_DueDate=@Sih_DueDate,
							Sih_Sgst_Amt=@Sih_Sgst_Amt,Sih_Cgst_Amt=@Sih_Cgst_Amt,Sih_Igst_Amt=@Sih_Igst_Amt,Sih_Total_Tax=@Sih_Total_Tax,Sih_Docket_No=@Sih_Docket_No,
							Sih_Transporter_Name=@Sih_Transporter_Name,Sih_Lr_No=@Sih_Lr_No,Sih_Lr_Date=@Sih_Lr_Date			
					WHERE	Sih_Key=@Sih_Key
				END

			SET @ID = ABS(@Sih_Key)
		END

	ELSE IF @SP_STATUS = 'SYNC_DETAIL'
		BEGIN
			--IF NOT EXISTS (SELECT * FROM cPOS_SalesInvoiceItemDetail WHERE Sid_Sih_Key = @Sid_Sih_Key AND [Sid_LastUpdated] = @Sid_LastUpdated)
			--	BEGIN
						SELECT @Sid_Key = Sid_Key FROM cPOS_SalesInvoiceItemDetail WHERE Sid_Key=@Sid_Key
						IF (ISNULL(@Sid_Key,0) = 0)
							BEGIN
								INSERT 
								INTO		[dbo].[cPOS_SalesInvoiceItemDetail]
											([Sid_Key],[Sid_Sih_Key],[Sid_SrNo],[Sid_Item_Code],[Sid_Item_MRP],[Sid_ExpDate],[Sid_Qty],[Sid_Item_Rate],[Sid_SubTotal],[Sid_Total],
											[Sid_MnfDate],[Sid_Disc],[Sid_DiscAmount],[Sid_Free_Qty],[Sid_UomId],[Sid_Sgst_Per],[Sid_Cgst_Per],[Sid_Igst_Per],[Sid_Batch_No],[Sid_LastUpdated])
								VALUES
											(@Sid_Key,@Sid_Sih_Key,@Sid_SrNo,@Sid_Item_Code,@Sid_Item_MRP,@Sid_ExpDate,@Sid_Qty,@Sid_Item_Rate,@Sid_SubTotal,@Sid_Total,
											@Sid_MnfDate,@Sid_Disc,@Sid_DiscAmount,@Sid_Free_Qty,@Sid_UomId,@Sid_Sgst_Per,@Sid_Cgst_Per,@Sid_Igst_Per,@Sid_Batch_No,@Sid_LastUpdated)
							END
						ELSE 
							BEGIN
								UPDATE		[dbo].[cPOS_SalesInvoiceItemDetail]
								SET			[Sid_Sih_Key] = @Sid_Sih_Key,[Sid_SrNo] = @Sid_SrNo,[Sid_Item_Code] = @Sid_Item_Code,[Sid_Item_MRP] = @Sid_Item_MRP,
											[Sid_ExpDate] = @Sid_ExpDate,[Sid_Qty] = @Sid_Qty,[Sid_Item_Rate] = @Sid_Item_Rate,[Sid_SubTotal] = @Sid_SubTotal,[Sid_Total] = @Sid_Total, 
											[Sid_MnfDate] = @Sid_MnfDate,[Sid_Disc] = @Sid_Disc,[Sid_DiscAmount] = @Sid_DiscAmount,[Sid_Free_Qty] = @Sid_Free_Qty,[Sid_UomId] = @Sid_UomId,
											[Sid_Sgst_Per] = @Sid_Sgst_Per,[Sid_Cgst_Per] = @Sid_Cgst_Per,[Sid_Igst_Per] = @Sid_Igst_Per,[Sid_Batch_No] = @Sid_Batch_No, 
											[Sid_LastUpdated] = @Sid_LastUpdated
								WHERE		[Sid_Key] = @Sid_Key
							END
				--END
		END

	ELSE IF @SP_STATUS = 'SYNC_PO_STATUS'
		BEGIN
			if NOT EXISTS(Select * from cPOS_PoApprovalHistory Where Poh_Po_Key=@Sih_Key)
			BEGIN
				INSERT INTO cPOS_PoApprovalHistory
				(
					Poh_Id,
					Poh_Po_Key,
					Poh_Po_No,
					Poh_ApproveStatus,
					Poh_SalesOrderNo,
					Poh_Remarks,
					Poh_UpdatedBy,
					Poh_UpdatedDt
				)
				VALUES
				(
					(Select ISNULL(MAX(Poh_Id),0) + 1 from cPOS_PoApprovalHistory),
					@Sih_Key,
					@Sih_Transporter_Name,
					@Sih_Store_Code,
					@Sih_Docket_No,
					@Sih_Lr_No, 	
					-1,
					GETDATE()
				)
			END	
		END
END

GO
/****** Object:  StoredProcedure [dbo].[SP_SalesInvoiceDetail_cPOS]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 21.April.2018
-- Description:	For Sync Dispatch Detail
-- =============================================
CREATE PROCEDURE [dbo].[SP_SalesInvoiceDetail_cPOS]
@SP_STATUS				varchar(200)	='',
@Sid_Key				NUMERIC(18,0)	=null,						
@Sid_Sih_Key			NUMERIC(18,0)	=null,				
@Sid_SrNo				int				=null,					
@Sid_Item_Code			varchar(200)	=null,			
@Sid_Item_MRP			numeric(12, 2)	=null,			
@Sid_ExpDate			date			=null,					
@Sid_Qty				numeric(12, 3)	=null,				
@Sid_Item_Rate			numeric(12, 2)	=null,			
@Sid_SubTotal			numeric(12, 2)	=null,				
@Sid_Total				numeric(12, 2)	=null,				
@Sid_MnfDate			date			=null,					
@Sid_Disc				numeric(5, 2)	=null,				
@Sid_DiscAmount			numeric(18, 2)	=null,			
@Sid_Free_Qty			numeric(12, 3)	=null,			
@Sid_UomId				int				=null,		
@Sid_Sgst_Per			numeric(5, 2)	=null,		
@Sid_Cgst_Per			numeric(5, 2)	=null,		
@Sid_Igst_Per			numeric(5, 2)	=null,		
@Sid_Batch_No			nvarchar(MAX)	=null,		
@Sid_LastUpdated		datetime		=null,
@Sid_MnfName			VARCHAR(5000)	=''
AS
BEGIN
	if @SP_STATUS='SYNC_DETAIL'
		begin
			iF NOT EXiSTS(SELECT * FROM cPOS_SalesInvoiceItemDetail WHERE Sid_Key=@Sid_Key)
				BEGiN
					Insert into cPOS_SalesInvoiceItemDetail
					(
						Sid_Key,Sid_Sih_Key,Sid_SrNo,Sid_Item_Code,Sid_Item_MRP,	
						Sid_ExpDate,Sid_Qty,Sid_Item_Rate,Sid_SubTotal,Sid_Total,		
						Sid_MnfDate,Sid_Disc,Sid_DiscAmount,Sid_Free_Qty,Sid_UomId,		
						Sid_Sgst_Per,Sid_Cgst_Per,Sid_Igst_Per,Sid_Batch_No,Sid_LastUpdated,Sid_MnfName
					)
					VALues
					(
						@Sid_Key,@Sid_Sih_Key,@Sid_SrNo,@Sid_Item_Code,@Sid_Item_MRP,
						@Sid_ExpDate,@Sid_Qty,@Sid_Item_Rate,@Sid_SubTotal,@Sid_Total,		
						@Sid_MnfDate,@Sid_Disc,@Sid_DiscAmount,@Sid_Free_Qty,@Sid_UomId,		
						@Sid_Sgst_Per,@Sid_Cgst_Per,@Sid_Igst_Per,@Sid_Batch_No,@Sid_LastUpdated,@Sid_MnfName
					)
				END
			ELSE
				BEGiN
					UPDATE		[dbo].[cPOS_SalesInvoiceItemDetail]
					SET			[Sid_Sih_Key] = @Sid_Sih_Key,[Sid_SrNo] = @Sid_SrNo,[Sid_Item_Code] = @Sid_Item_Code,[Sid_Item_MRP] = @Sid_Item_MRP,
								[Sid_ExpDate] = @Sid_ExpDate,[Sid_Qty] = @Sid_Qty,[Sid_Item_Rate] = @Sid_Item_Rate,[Sid_SubTotal] = @Sid_SubTotal,[Sid_Total] = @Sid_Total, 
								[Sid_MnfDate] = @Sid_MnfDate,[Sid_Disc] = @Sid_Disc,[Sid_DiscAmount] = @Sid_DiscAmount,[Sid_Free_Qty] = @Sid_Free_Qty,[Sid_UomId] = @Sid_UomId,
								[Sid_Sgst_Per] = @Sid_Sgst_Per,[Sid_Cgst_Per] = @Sid_Cgst_Per,[Sid_Igst_Per] = @Sid_Igst_Per,[Sid_Batch_No] = @Sid_Batch_No, 
								[Sid_LastUpdated] = @Sid_LastUpdated,
								Sid_MnfName=@Sid_MnfName
					WHERE		[Sid_Key] = @Sid_Key
				END
		end
END

GO
/****** Object:  StoredProcedure [dbo].[SP_SalesInvoiceDistributer]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec SP_SalesInvoiceDistributer  @SP_STATUS='GetItemDetailOriginal',@Sid_Sih_Key=6,@Sih_Remark='O'
CREATE PROCEDURE [dbo].[SP_SalesInvoiceDistributer] 
	@SP_STATUS		VARCHAR(200) = ''
	,@Sih_Key		NUMERIC(18,0) = 0
	,@Sih_No		NUMERIC(18, 0) = 0
	,@Sih_Date		DATETIME = NULL
	,@Sih_Invtype	INT = 0
	,@Sih_Account	VARCHAR(50) = ''
	,@Sih_Pm_Id		NUMERIC(18,0) = 0
	,@Sih_Dm_Id		NUMERIC(18,0) = 0
	,@Sih_GstType	INT = 0
	,@Sih_RateType	INT = 0
	,@Sih_SubTotal	NUMERIC(18, 2) = 0
	,@Sih_Total		NUMERIC(18, 2) = 0
	,@Sih_CreatedBy INT = 0
	,@Sih_YearId	INT = 0
	,@Sih_BranchId	INT = 0
	,@Sih_Disc		NUMERIC(5, 2) = 0
	,@Sih_DiscAmount NUMERIC(18, 2) = 0
	,@Sih_CusRefNo	VARCHAR(100) = NULL,
	 @Sih_Po_Key	NUMERIC(18,0)  = 0,
	 @Sih_Type		int = 0,
 	------------------------------	
	@Sid_Key		NUMERIC(18,0) = 0
	,@Sid_Sih_Key	NUMERIC(18,0) = 0
	,@Sid_SrNo		INT = 0
	,@Sid_Mm_Id		NUMERIC(18,0) = 0
	,@Sid_MRP		NUMERIC(12, 2) = 0
	,@Sid_BatchNo	NVARCHAR(max) = ''
	,@Sid_ExpDate	DATE = NULL
	,@Sid_SalesQty	NUMERIC(12, 3) = 0
	,@Sid_SalesRate NUMERIC(12, 2) = 0
	,@Sid_SalesUomId INT = 0
	,@Sid_PurchaseQty NUMERIC(12, 3) = 0
	,@Sid_PurchaseRate NUMERIC(12, 2) = 0
	,@Sid_PurchaseUomId INT = 0
	,@Sid_SubTotal	NUMERIC(12, 2) = 0
	,@Sid_Total		NUMERIC(12, 2) = 0
	,@Sid_MnfDate	DATE = NULL
	,@Sid_Disc		NUMERIC(5, 2) = 0
	,@Sid_DiscAmount NUMERIC(18, 2) = 0
	,@DocType		INT = 0
	,@Sih_CardPay	NUMERIC(18, 2) = 0
	,@Sih_CashPay	NUMERIC(18, 2) = 0
	,@Sih_TotalPay	NUMERIC(18, 2) = 0
	,@Sih_IsCreditBill BIT = 0
	,@Sih_AccId		INT = 0
	,@Sih_BookID	INT = 0
	,@Sih_DueDate	DATE = NULL
	,@Sih_IsOriginal BIT = 0
	,@Sid_LmId		INT = 0
	,@Sih_CardRemarks VARCHAR(50) = NULL
	,@Sih_Remark	VARCHAR(1000) = NULL
	,@DefaultNoGap	NVARCHAR(10) = ''
	,@DefaultNoDigits INT = 0
	,@DefaultValue	NVARCHAR(10) = ''
	,@ID			NUMERIC(18,0) = 0 OUTPUT
	,@DirectPrint	bit=0
	,@IsActive		bit=0
	,@Reportid		INT = 0
	,@Sih_StartDate  date = null
	,@Sih_EndDate   date = null ,
	@Sid_Po_Key		NUMERIC(18,0)  =  0,
	@Sih_LR_NO		VARCHAR(500) = '',
	@Sih_Lr_Date	DATETIME=  NULL,
	@Sih_TrasporterName VARCHAR(max)  = '',
	@Sih_No_Of_Cases	INT = 0,
	@Sih_Freight_Amount	NUMERIC(12,2)=0
AS

SET ANSI_WARNINGS OFF;

DECLARE @Count INT
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	IF @SP_STATUS = 'BIND_ITEM'
	BEGIN
		if @Sih_Remark <>''
			begin
				Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0 and Item_Code = @Sih_Remark
				union all 
				Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0
				and Item_Code like @Sih_Remark+'%' and  Item_Code <> @Sih_Remark
				union all
				SELECT *,vwStock.Item_Stock AS OldStock
				FROM dbo.vwStock(NOLOCK)
				WHERE Item_Stock > 0
				--and(Item_Name like '%' + @Sih_Remark +'%' or Item_Batchno like @Sih_Remark+'%')
				and(Item_Name like @Sih_Remark +'%' or Item_Batchno like @Sih_Remark+'%')
				and Item_Code not like @Sih_Remark+'%' 
				and Item_Code <> @Sih_Remark 
			end
		else
			begin
				SELECT	*
						,vwStock.Item_Stock AS OldStock
				FROM dbo.vwStock(NOLOCK)
				WHERE Item_Stock > 0
				ORDER BY Stk_ExpDate;
			end
	END;

	ELSE IF @SP_STATUS = 'BIND_COMBO_FROM'
		BEGIN
			SELECT		19 AS ID, 'Sales Order' AS NAME
			UNION
			SELECT		20 AS ID, 'Sales Challan' AS NAME
		END

	ELSE IF @SP_STATUS = 'AutoInvoiceNo'
	BEGIN
		DECLARE @FormPrefix AS NVARCHAR(max) = '';
		SELECT @FormPrefix = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 3
		SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sih_No, 0)))
		FROM SalesInvoiceHeader(NOLOCK)
		WHERE SalesInvoiceHeader.Sih_Date BETWEEN @FROM_DATE AND @TO_DATE
	END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
	BEGIN
		DECLARE @MSG_OUT1 NVARCHAR(max)
		EXEC [SP_Tbl_Dependency1] 'SalesInvoiceItemDetail'
			,@Sid_BatchNo
			,@MSG_OUT1 OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
		BEGIN
			RAISERROR (
					@MSG_OUT1
					,14
					,9
					)
		END
	END

	ELSE IF @SP_STATUS = 'CheckAmountPaidOrNot'
	BEGIN
		SELECT *
		FROM AccountTransaction (NOLOCK)
		WHERE Act_DocType = 2
			AND Act_DocKey = @Sih_Key
	END
	ELSE IF @SP_STATUS = 'FillInvoiceType'
	BEGIN
		SELECT Sim_Id
			,Sim_Name
		FROM SalesInvoiceTypeMaster(NOLOCK)
		WHERE Sim_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'GetAllInvoiceNo'
	BEGIN
		SELECT Sih_No
			,Sih_Key
		FROM SalesInvoiceHeader(NOLOCK)
	END;
	ELSE IF @SP_STATUS = 'UpdatePrintFlag'
	BEGIN
		UPDATE SalesInvoiceHeader
		SET Sih_IsOriginal = 1
		WHERE Sih_Key = @Sid_Sih_Key
	END
	ELSE IF @SP_STATUS = 'FillGstType'
	BEGIN
		SELECT Gtm_Id
			,Gtm_Name
		FROM dbo.GSTTypeMaster(NOLOCK)
		WHERE Gtm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'FillBindInvoiceRateType'
	BEGIN
		SELECT Irm_Id
			,Irm_Name
		FROM dbo.InvoiceRateTypeMaster(NOLOCK)
		WHERE Irm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'FillVendor'
	BEGIN
		--SELECT	Vendor_ID AS VEN_ID,
		--		Vendor_Code AS VEN_CODE,
		--		Vendor_Name	AS VEN_NAME,
		--		vam.VendAdd_Id AS VAAD_ID,
		--		vam.VendAdd_Addr1 + CASE WHEN ISNULL(vam.VendAdd_Add2,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add2,'') ELSE '' END
		--		+ CASE WHEN ISNULL(vam.VendAdd_Add3,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add3,'') ELSE '' END AS VEN_ADDRESS,
		--		Vendor_CreditDays,
		--		area.Area_StateId as StateId,
		--		vm.Vendor_Vt_Id,
		--		vt.Vt_name
		--FROM VendorMaster(NOLOCK) vm
		--INNER JOIN VendorAddMaster(NOLOCK) vam
		--ON vm.Vendor_ID = vam.VendAdd_VendorId
		--AND vam.VendAdd_IsActive = 1
		--LEFT JOIN AreaMaster(NOLOCK) area
		--ON vam.VendAdd_AreaId = area.Area_ID
		--LEFT JOIN StateMaster(NOLOCK) [state]
		--ON area.Area_StateId = state.State_ID
		--LEFT JOIN VendorTypeMaster(NOLOCK)  as vt
		--ON vm.Vendor_Vt_Id=vt.Vt_Id
		--WHERE vm.Vendor_IsActive = 1;
			Select Pm_Id as VEN_ID, 
				StoreCode AS VEN_CODE,
				case when ISNULL(CM.StoreCode,'') <>'' then CM.Pm_Fullname +'('+ CM.StoreCode +')' else CM.Pm_Fullname end AS VEN_NAME,
				--Pm_Fullname	AS VEN_NAME,
				0 AS VAAD_ID,
				Pm_Address AS VEN_ADDRESS,
				0 as Vendor_CreditDays,
				StateId   as StateId,
				0 as Vendor_Vt_Id,
				'' as Vt_name,
				Contact_PersonName
		from patientMaster (NOLOCK) CM
		WHERE Pm_IsActive = 1;
	END;
	
	ELSE IF @SP_STATUS = 'FillSalesOrder'
		BEGIN
			DECLARE		@FormPrefix_Sofill  NVARCHAR(max) 
			
			SELECT		@FormPrefix_Sofill = FormPrefix  
			FROM		FormDetailTable (NOLOCK)
			WHERE		Id = 1

			SELECT		DISTINCT Po_Key, @FormPrefix_Sofill + CAST(Po_No as  NVARCHAR(max)) AS Po_No, Po_Date, Po_RefNo, Po_RefDate, Po_RevNo, Po_RevDate, Po_Cate,Po_Type1,Po_Type2,Po_IsCashPurchase,Po_EnqMode,Po_QtNo,Po_IsAmmendment,
						Po_VenId,Po_VenAddId,Po_DelDate,Po_Cur,Po_ExchRate,Po_BasicVal,Po_Disc,Po_Disc_Val,Po_TotVal,Po_Annexure,Po_CoverLetter,Po_Remarks,Po_PaymentTerms,
						Po_CreditDays,Po_BmId,Po_YearId,Po_AuthId,Po_AuthDate,Po_ApproveStatus,Po_ApproveStatusRemark,Po_IsSync,Po_LastSyncDate
			FROM		SO_HEADER (NOLOCK) so
						LEFT JOIN SO_DETAIL (NOLOCK) sod
			ON			so.Po_Key =  sod.Pi_PoKey
			WHERE		--ISNULL(sod.Pi_Qty,0) - ISNULL(sod.Pi_PiQty,0) > 0 
							--Po_Key NOT IN ( select Scd_Po_Key  from   SalesChallenItemDetails(nolock))
							--Po_Key IN(SELECT Pi_PoKey FROM SO_DETAIL WHERE ISNULL(Pi_Qty,0)- ISNULL(Pi_Scd_SalesQty,0)>0)
							ISNULL(Pi_Qty,0)- ISNULL(Pi_Scd_SalesQty,0)>0
						AND	Po_VenId = @Sih_Pm_Id
		END;

	ELSE IF @SP_STATUS = 'FillSalesChallan'
		BEGIN
			DECLARE		@FormPrefix_SCfill AS NVARCHAR(10) = NULL
			
			SELECT		@FormPrefix_SCfill  = FormPrefix  
			FROM		FormDetailTable (NOLOCK)
			WHERE		Id = 17

			SELECT		Sc_Key AS Po_Key, @FormPrefix_SCfill + CAST(Sc_No AS NVARCHAR(MAX)) AS Po_No, Sc_Date AS Po_Date, Sc_Total as Po_TotVal
			FROM		SalesChallanHeader (NOLOCK) SCH
			--WHERE		Sc_Key NOT IN (SELECT * FROM SalesInvoiceHeader)
		END

	ELSE IF @SP_STATUS = 'Insert'
	BEGIN

		SELECT @Sih_Key = ISNULL(MAX(Sih_Key), 0) + 1
		FROM SalesInvoiceHeader(NOLOCK);
		SELECT @Sih_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Sih_No, 0)))
		FROM  SalesInvoiceHeader(NOLOCK)
		WHERE	SalesInvoiceHeader.Sih_Date BETWEEN @FROM_DATE AND @TO_DATE
		INSERT dbo.SalesInvoiceHeader (
			Sih_Key
			,Sih_No
			,Sih_Date
			,Sih_Invtype
			,Sih_Account
			,Sih_Pm_Id
			,Sih_Dm_Id
			,Sih_GstType
			,Sih_RateType
			,Sih_SubTotal
			,Sih_Total
			,Sih_CreatedBy
			,Sih_CreatedDate
			,Sih_YearId
			,Sih_BranchId
			,Sih_Disc
			,Sih_DiscAmount
			,Sih_CardPay
			,Sih_CashPay
			,Sih_TotalPay
			,Sih_IsCreditBill
			,Sih_AccId
			,Sih_BookID
			,Sih_DueDate
			,Sih_CardRemarks
			,Sih_IsOriginal
			,Sih_Remark
			,Sih_CusRefNo
			,Sih_IsSync---Synch Status false on Add-Add Hasmukh
			,Sih_Po_Key  -- add by yogini need  to identify   for save   order  id
			,Sih_LR_NO
			,Sih_Lr_Date
			,Sih_TrasporterName
			,Sih_No_Of_Cases
			,Sih_Freight_Amount
			,Sih_Type
			)
		VALUES (
			@Sih_Key
			,-- Sih_Key - bigint
			@Sih_No
			,-- Sih_No - varchar(20)
			@Sih_Date
			,-- Sih_Date - datetime
			@Sih_Invtype
			,-- Sih_Invtype - int
			''
			,-- Sih_Account - varchar(50)
			@Sih_Pm_Id
			,-- Sih_Pm_Id - bigint
			@Sih_Dm_Id
			,-- Sih_Dm_Id - bigint
			@Sih_GstType
			,-- Sih_GstType - int
			@Sih_RateType
			,-- Sih_RateType - int
			@Sih_SubTotal
			,-- Sih_SubTotal - numeric(18, 2)
			@Sih_Total
			,-- Sih_Total - numeric(18, 2)
			@Sih_CreatedBy
			,-- Sih_CreatedBy - int
			GETDATE()
			,@Sih_YearId
			,@Sih_BranchId
			,-- Sih_CreatedDate - datetime
			@Sih_Disc
			,@Sih_DiscAmount
			,@Sih_CardPay
			,@Sih_CashPay
			,@Sih_TotalPay
			,@Sih_IsCreditBill
			,@Sih_AccId
			,@Sih_BookID
			,@Sih_DueDate
			,@Sih_CardRemarks
			,@Sih_IsOriginal
			,@Sih_Remark
			,@Sih_CusRefNo
			,'false'
			,@Sih_Po_Key
			,@Sih_LR_NO
			,@Sih_Lr_Date
			,@Sih_TrasporterName
			,@Sih_No_Of_Cases
			,@Sih_Freight_Amount
			,@Sih_Type
			);
		SELECT @ID = @Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'CheckEntryForSalesReturn'
		BEGIN
			DECLARE @MSG_OUT_CHECK NVARCHAR(max)
			EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
				,@Sih_Key
				,@MSG_OUT_CHECK OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT_CHECK)) <> '')
			BEGIN
				RAISERROR (
						@MSG_OUT_CHECK
						,14
						,9
						)
			END
			ELSE
			BEGIN
				SELECT @ID = @Sih_Key;
			END;
		END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
		DECLARE @MSG_OUT_UPDATE NVARCHAR(max)
		EXEC SP_Tbl_Dependency 'SalesInvoiceHeader',@Sih_Key,@MSG_OUT_UPDATE OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT_UPDATE)) <> '')
			BEGIN
				RAISERROR (@MSG_OUT_UPDATE,14,9)
			END
		ELSE
			UPDATE	[dbo].[SalesInvoiceHeader]
			SET		Sih_Date = @Sih_Date
					,Sih_Invtype = @Sih_Invtype
					,Sih_Account = @Sih_Account
					,Sih_Pm_Id = @Sih_Pm_Id
					,Sih_Dm_Id = @Sih_Dm_Id
					,Sih_GstType = @Sih_GstType
					,Sih_RateType = @Sih_RateType
					,Sih_SubTotal = @Sih_SubTotal
					,Sih_Total = @Sih_Total
					,Sih_UpdatedBy = @Sih_CreatedBy
					,Sih_UpdatedOn = GETDATE()
					,Sih_Disc = @Sih_Disc
					,Sih_DiscAmount = @Sih_DiscAmount
					,Sih_YearId = @Sih_YearId
					,Sih_BranchId = @Sih_BranchId
					,Sih_CardPay = @Sih_CardPay
					,Sih_CashPay = @Sih_CashPay
					,Sih_TotalPay = @Sih_TotalPay
					,Sih_IsCreditBill = @Sih_IsCreditBill
					,Sih_AccId = @Sih_AccId
					,Sih_BookID = @Sih_BookID
					,Sih_DueDate = @Sih_DueDate
					,Sih_CardRemarks = @Sih_CardRemarks
					,Sih_Remark = @Sih_Remark
					,Sih_CusRefNo = @Sih_CusRefNo
					,Sih_IsSync='false'---Synch Status false on update-Add Hasmukh
					,Sih_LR_NO =@Sih_LR_NO
					,Sih_Lr_Date =@Sih_Lr_Date
					,Sih_TrasporterName =@Sih_TrasporterName
					,Sih_No_Of_Cases =@Sih_No_Of_Cases
					,Sih_Freight_Amount =@Sih_Freight_Amount
					,Sih_Po_Key=@Sih_Po_Key
					,Sih_Type = @Sih_Type
			WHERE	Sih_Key = @Sih_Key;


			--UPDATE		 sod
			--SET			 Pi_PiQty =  isnull(sod.Pi_PiQty,0)  - (isnull(sod.Pi_Qty,0))
			--from		 SO_DETAIL sod
			--		left join   SalesInvoiceHeader   sih
			--on			 sod.Pi_PoKey  = sih.Sih_Po_Key
			--		left  join   SalesInvoiceItemDetail  sid
			--on			  sih.Sih_key =  sid.Sid_Sih_Key
			--WHERE		 sod.Pi_Qty >0  and  
			--			Pi_ItemId = @Sid_Mm_Id
			--			  AND Pi_PoKey =@Sid_Po_Key

			--UPDATE INDDET
			--SET INDDET.Indd_AcceptedQty = INDDET.Indd_AcceptedQty - POITMDET.Pi_Qty
			--FROM IndentDetail INDDET
			--INNER JOIN PoItemDetails POITMDET
			--ON INDDET.Indd_Key = POITMDET.Pi_InddKey
			--WHERE POITMDET.Pi_InddKey > 0
			--AND POITMDET.Pi_PoKey = @Po_Key;

			UPDATE	sod
			SET		Pi_PiQty =  isnull(sod.Pi_PiQty,0)  - isnull(sid.Sid_SalesQty,0)
			FROM	SO_DETAIL sod
					LEFT  JOIN   SalesInvoiceItemDetail  sid
			ON			sod.Pi_PoKey = sid.Sid_Po_Key
					AND sod.Pi_ItemId  = sid.Sid_Mm_Id
			WHERE	--	 sod.Pi_PoKey > 0
					sid.Sid_Sih_Key = @Sih_Key;

			DELETE FROM dbo.SalesInvoiceItemDetail WHERE Sid_Sih_Key = @Sih_Key;
			DELETE FROM dbo.StockRegister WHERE Stk_DocKey = @Sih_Key AND Stk_DocType = @DocType;
			DELETE FROM dbo.TaxTransaction Where Tr_DocId= @Sih_Key AND Tr_DocTyp= @DocType;

			SELECT @ID = @Sih_Key;
		END
	ELSE IF @SP_STATUS = 'Delete_SalesInvoiceHeader'
		BEGIN
			DECLARE @MSG_OUT NVARCHAR(max)
			EXEC SP_Tbl_Dependency 'SalesInvoiceHeader',@Sih_Key,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT,14,9)
				END
			ELSE
				BEGIN
					DELETE
					FROM	dbo.SalesInvoiceHeader
					WHERE	Sih_Key = @Sih_Key;
					SELECT	@ID = @Sih_Key;
				END
		END
	ELSE IF @SP_STATUS = 'Insert_SalesInvoiceItemDetail'
		BEGIN
			iF EXiSTS(
						SELECT	Stk_MmId,
								ISNULL(Stk_BatchNo,'') AS Stk_BatchNo,
								SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_SalesQty ELSE 0 END-
									CASE WHEN Stk_Tran_Typ='D' THEN Stk_SalesQty ELSE 0 END) AS BAL
						FROM	StockRegister A
						WHERE	A.Stk_MmId=@Sid_Mm_Id AND Stk_BatchNo=@Sid_BatchNo
						GROUP BY Stk_MmId,ISNULL(Stk_BatchNo,'')
						HAVING		@Sid_SalesQty>SUM(CASE WHEN Stk_Tran_Typ='C' THEN Stk_SalesQty ELSE 0 END-
									CASE WHEN Stk_Tran_Typ='D' THEN Stk_SalesQty ELSE 0 END)
						)
				BEGiN
					
					DECLARE		@Negative VARCHAR(MAX)='Stock going on nagative: SP Validation'
					SET			@Negative=@Negative+','+(SELECT		TOP	1 
																	'Drug Code :'+ ISNULL(B.Mm_Code,'')+ ' & Batch No'+ + ISNULL(Stk_BatchNo,'') AS Neg
														FROM		StockRegister A
																	INNER JOIN MedicineMaster B
														ON			B.Mm_ID=A.Stk_MmId
														WHERE		A.Stk_MmId=@Sid_Mm_Id AND ISNULL(Stk_BatchNo,'')=@Sid_BatchNo
														GROUP BY	Stk_MmId,ISNULL(Stk_BatchNo,''),B.Mm_Code
														HAVING		@Sid_SalesQty>SUM(CASE WHEN Stk_Tran_Typ='C' 
																							THEN Stk_SalesQty 
																							ELSE 0 
																					  END-
																					  CASE WHEN Stk_Tran_Typ='D' 
																							THEN Stk_SalesQty 
																							ELSE 0 
																					   END)
														  )
					RAISERROR(@Negative,14,9)
				END
			ELSE	
				BEGiN
					SELECT @Sid_Key = ISNULL(MAX(Sid_Key), 0) + 1
					FROM SalesInvoiceItemDetail(NOLOCK);
					INSERT	dbo.SalesInvoiceItemDetail (
							Sid_Key
							,Sid_Sih_Key
							,Sid_SrNo
							,Sid_Mm_Id
							,Sid_MRP
							,Sid_BatchNo
							,Sid_ExpDate
							,Sid_SalesQty
							,Sid_SalesRate
							,Sid_SubTotal
							,Sid_Total
							,Sid_MnfDate
							,Sid_Disc
							,Sid_DiscAmount
							,Sid_SalesUomId
							,Sid_PurchaseQty
							,Sid_PurchaseUomId
							,Sid_PurchaseRate
							,Sid_LmId
							,Sid_Po_Key
						)
				VALUES (
							@Sid_Key
							,-- Sid_Key - bigint
							@Sid_Sih_Key
							,-- Sid_Sih_Key - bigint
							@Sid_SrNo
							,-- Sid_SrNo - int
							@Sid_Mm_Id
							,-- Sid_Mm_Id - bigint
							@Sid_MRP
							,-- Sid_MRP - numeric(12, 2)
							@Sid_BatchNo
							,-- Sid_BatchNo - nvarchar(50)
							@Sid_ExpDate
							,-- Sid_ExpDate - date
							@Sid_SalesQty
							,-- Sid_Qty - numeric(12, 3)
							@Sid_SalesRate
							,-- Sid_Rate - numeric(12, 2)
							@Sid_SubTotal
							,-- Sid_SubTotal - numeric(12, 2)
							@Sid_Total
							,@Sid_MnfDate
							,-- Sid_Total - numeric(12, 2)
							@Sid_Disc
							,@Sid_DiscAmount
							,@Sid_SalesUomId
							,@Sid_PurchaseQty
							,@Sid_PurchaseUomId
							,@Sid_PurchaseRate
							,@Sid_LmId
							,@Sid_Po_Key
					);
					UPDATE		 sod
					SET			 Pi_PiQty =  sod.Pi_PiQty + @Sid_SalesQty
					FROM		 SO_DETAIL sod
							INNER  JOIN   SalesInvoiceItemDetail  sid
					ON			 sod.Pi_PoKey	= @Sid_Po_Key
							AND  sod.Pi_ItemId  = @Sid_Mm_Id

					SELECT @ID = @Sid_Key;
				END

		END;
	ELSE IF @SP_STATUS = 'Delete_SalesInvoiceItemDetail'
		BEGIN

			DELETE
			FROM dbo.SalesInvoiceItemDetail
			WHERE Sid_Sih_Key = @Sid_Sih_Key;
		END;
	ELSE IF @SP_STATUS = 'FillGrid'
		BEGIN
			DECLARE @FormPrefix_Fill_Grid AS NVARCHAR(max) = '';
			SELECT @FormPrefix_Fill_Grid = FormPrefix
			FROM FormDetailTable(NOLOCK)
			WHERE Id = 3
			SELECT si.Sih_Key
				,@FormPrefix_Fill_Grid + CAST(si.Sih_No AS NVARCHAR(max)) AS Sih_No
				,si.Sih_Date
				,si.Sih_Invtype
				,si.Sih_Account
				,si.Sih_Pm_Id
				,si.Sih_Dm_Id
				,si.Sih_GstType
				,si.Sih_RateType
				,si.Sih_SubTotal
				,si.Sih_Total
				,si.Sih_CreatedBy
				,si.Sih_CreatedDate
				,si.Sih_UpdatedBy
				,si.Sih_UpdatedOn
				,si.Sih_YearId
				,si.Sih_Disc
				,si.Sih_DiscAmount
				,dm.Dm_Name
				,pm.Pm_Fullname
				,Sih_user.User_Name AS Sih_user
				,ISNULL(si.Sih_Total, 0) - ISNULL(si.Sih_SubTotal, 0) AS TaxAmount
				,SUM(ISNULL(Act_PaidAmount, 0)) AS Act_PaidAmount
				,si.Sih_IsCreditBill
				,Sih_CusRefNo
				,Sih_SRStatus---Add Hasmukh
				,si.Sih_Po_Key --  add by yogini
				,(CASE WHEN Sih_IsSync='false' THEN 'NO' ELSE 'YES' END)AS Sih_SynchStatus---Synch Status Display In List--Add Hasmukh
				,Sih_LR_NO
				,Sih_Lr_Date
				,Sih_TrasporterName
				,Sih_No_Of_Cases
				,Sih_Freight_Amount,
				pm.Contact_PersonName 
			FROM SalesInvoiceHeader(NOLOCK) si
			---Start Add Hasmukh
				 LEFT JOIN (SELECT Sih_Key,
							  (CASE WHEN SUM(ISNULL(SRD.Srd_Qty,0))>0 THEN 'false' ELSE 'true' END)AS Sih_SRStatus
						 FROM SalesInvoiceHeader (NOLOCK) si1
							  LEFT JOIN SalesReturnHeader (NOLOCK) SRH ON SRH.Srh_SihKey=si1.Sih_Key
							  LEFT JOIN SalesReturnDetail (NOLOCK) SRD ON SRD.Srd_SrhId=SRH.Srh_Id
							  GROUP BY si1.Sih_Key)AS SalesReturnStatus
			ON SalesReturnStatus.Sih_Key=si.Sih_Key
			---End Add Hasmukh
			LEFT JOIN dbo.DoctorMaster (NOLOCK) dm ON si.Sih_Dm_Id = dm.Dm_Id
			LEFT JOIN dbo.PatientMaster (NOLOCK) pm ON si.Sih_Pm_Id = pm.Pm_Id
			LEFT JOIN dbo.UserMaster(NOLOCK) Sih_user ON si.Sih_CreatedBy = Sih_user.User_ID
			LEFT JOIN AccountTransaction (NOLOCK) act ON Act_DocNo = si.Sih_No
				AND Act_DocKey = si.Sih_Key
				AND Act_DocType = 2
			WHERE --Sih_YearId = @Sih_YearId AND
					 si.Sih_Date BETWEEN @Sih_StartDate AND @Sih_EndDate
			GROUP BY si.Sih_Key
				,si.Sih_No
				,si.Sih_Date
				,si.Sih_Invtype
				,si.Sih_Account
				,si.Sih_Pm_Id
				,si.Sih_Dm_Id
				,si.Sih_GstType
				,si.Sih_RateType
				,si.Sih_SubTotal
				,si.Sih_Total
				,si.Sih_CreatedBy
				,si.Sih_CreatedDate
				,si.Sih_UpdatedBy
				,si.Sih_UpdatedOn
				,si.Sih_YearId
				,si.Sih_Disc
				,si.Sih_DiscAmount
				,dm.Dm_Name
				,pm.Pm_Fullname
				,Sih_user.User_Name
				,Sih_IsCreditBill
				,Sih_CusRefNo
				,Sih_SRStatus---Add Hasmukh
				,Sih_IsSync---Add Hasmukh
				,Sih_Po_Key -- yogini  add
				,Sih_LR_NO
				,Sih_Lr_Date
				,Sih_TrasporterName
				,Sih_No_Of_Cases
				,Sih_Freight_Amount,
				Contact_PersonName 
			ORDER BY si.Sih_Key DESC;
		END;
	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT2 NVARCHAR(max)
			EXEC SP_Tbl_Dependency 'SalesInvoiceHeader' ,@Sih_Key,@MSG_OUT2 OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT2)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT2,14,9)
				END
			ELSE
				BEGIN

					--UPDATE		 sod
					--SET			 Pi_PiQty =  isnull(sod.Pi_PiQty,0)  - (isnull(sod.Pi_Qty,0))
					--from		 SO_DETAIL sod
					--		left join   SalesInvoiceHeader   sih
					--on			 sod.Pi_PoKey  = sih.Sih_Po_Key
					--		left  join   SalesInvoiceItemDetail  sid
					--on			  sih.Sih_key =  sid.Sid_Sih_Key
					--WHERE		  Pi_ItemId = @Sid_Mm_Id
					--			  AND Pi_PoKey =@Sid_Po_Key
			
					--UPDATE		 sod
					--SET			 Pi_PiQty =  isnull(sod.Pi_PiQty,0)  - isnull(sid.Sid_SalesQty,0)
					--FROM		 SO_DETAIL sod
					--		LEFT  JOIN   SalesInvoiceItemDetail  sid
					--ON			   sod.Pi_PoKey = sid.Sid_Po_Key
					--		AND  sod.Pi_ItemId  = sid.Sid_Mm_Id
					--WHERE		-- sod.Pi_PoKey > 0
					--		 Pi_PoKey =@Sid_Po_Key

					UPDATE		 sod
					SET			 Pi_PiQty =  isnull(sod.Pi_PiQty,0)  - isnull(sid.Sid_SalesQty,0)
					FROM		 SO_DETAIL sod
							LEFT  JOIN   SalesInvoiceItemDetail  sid
					ON			   sod.Pi_PoKey = sid.Sid_Po_Key
							AND  sod.Pi_ItemId  = sid.Sid_Mm_Id
					WHERE	--	 sod.Pi_PoKey > 0
							sid.Sid_Sih_Key = @Sih_Key;


					DELETE
					FROM		[dbo].SalesInvoiceHeader
					WHERE		Sih_Key = @Sih_Key;

					DELETE
					FROM		[dbo].SalesInvoiceItemDetail
					WHERE		Sid_Sih_Key = @Sih_Key;

					DELETE 
					FROM		TaxTransaction
					where		Tr_DocTyp = @DocType
							AND	Tr_DocKey = @Sih_Key;---Add Hasmukh

					DELETE
					FROM [dbo].StockRegister
					WHERE Stk_DocKey = @Sih_Key
						AND Stk_DocType = @DocType;
				END;
		END;
	ELSE IF @SP_STATUS = 'SP_RPT_DoctorWiseSalesReport'
	BEGIN
		IF (@Sid_Mm_Id != 0)
			BEGIN
				SELECT	DM.Dm_Name AS DoctorName
						,MM.Mm_Code AS DrugCode
						,MM.Mm_Name AS DrugName
						,MM.Mm_HsnCode AS HsnCode
						,UOMM.Uom_Name AS UOM
						,SUM(SIID.Sid_PurchaseQty) AS QTY
						,SUM(SIID.Sid_SubTotal) AS SubTotal
						,SUM(SIID.Sid_Total) AS Total
						,MTM.Mtm_TypeName AS DrugType
						,MGM.Mgm_Name AS DrugGroup
						,MCM.Mcm_Name AS DrugCategory
						,BM.Branch_Name
						,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
						,BM.Branch_GstNo
				FROM	SalesInvoiceHeader(NOLOCK) SIH
						INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
						LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
						INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
						INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
						LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
						LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
						LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
						INNER JOIN DoctorMaster(NOLOCK) DM ON DM.Dm_Id = SIH.Sih_Dm_Id
				WHERE	CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
						AND MM.Mm_MtmId = @Sid_Mm_Id
				GROUP BY DM.Dm_Name
						,MM.Mm_Code
						,MM.Mm_Name
						,UOMM.Uom_Name
						,MTM.Mtm_TypeName
						,MGM.Mgm_Name
						,MCM.Mcm_Name
						,BM.Branch_Name
						,BM.Branch_Address1
						,BM.Branch_Address2
						,BM.Branch_Address3
						,BM.Branch_GstNo
						,MM.Mm_HsnCode
				ORDER BY DM.Dm_Name ASC
			END
		ELSE
			BEGIN
				SELECT	DM.Dm_Name AS DoctorName
						,MM.Mm_Code AS DrugCode
						,MM.Mm_Name AS DrugName
						,MM.Mm_HsnCode AS HsnCode
						,UOMM.Uom_Name AS UOM
						,SUM(SIID.Sid_PurchaseQty) AS QTY
						,SUM(SIID.Sid_SubTotal) AS SubTotal
						,SUM(SIID.Sid_Total) AS Total
						,MTM.Mtm_TypeName AS DrugType
						,MGM.Mgm_Name AS DrugGroup
						,MCM.Mcm_Name AS DrugCategory
						,BM.Branch_Name
						,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
						,BM.Branch_GstNo
				FROM	SalesInvoiceHeader(NOLOCK) SIH
						INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
						LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
						INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
						INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
						LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
						LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
						LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
						INNER JOIN DoctorMaster DM ON DM.Dm_Id = SIH.Sih_Dm_Id
				WHERE		CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
				GROUP BY DM.Dm_Name
					,MM.Mm_Code
					,MM.Mm_Name
					,UOMM.Uom_Name
					,MTM.Mtm_TypeName
					,MGM.Mgm_Name
					,MCM.Mcm_Name
					,BM.Branch_Name
					,BM.Branch_Address1
					,BM.Branch_Address2
					,BM.Branch_Address3
					,BM.Branch_GstNo
					,MM.Mm_HsnCode
				ORDER BY DM.Dm_Name ASC
			END
	END
	ELSE IF @SP_STATUS = 'SP_RPT_ProductWiseSalesReport'
		BEGIN
			--IF (@Sid_Mm_Id != 0)
			--BEGIN
				SELECT SIH.Sih_No AS InvoiceNo
					,CONVERT(VARCHAR, SIH.Sih_Date, 105) AS DATE
					,PM.Pm_FullName AS PatientName
					,MM.Mm_Code AS DrugCode
					,MM.Mm_Name AS DrugName
					,UOMM.Uom_Name AS UOMName
					,SIID.Sid_BatchNo AS BatchNo
					,SIID.Sid_SalesQty AS QTY
					,SIID.Sid_SalesRate AS Rate
					,SIID.Sid_SubTotal AS SubTotal
					,SIID.Sid_Total AS Total
					,MTM.Mtm_TypeName AS DrugType
					,MGM.Mgm_Name AS DrugGroup
					,MCM.Mcm_Name AS DrugCategory
					,MM.Mm_HsnCode AS HsnCode
					,BM.Branch_Name
					,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
					,BM.Branch_GstNo
					,SIID.Sid_MRP
				FROM SalesInvoiceHeader(NOLOCK) SIH
				LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
				INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
				INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
				INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
				LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
				LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
				LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
				INNER JOIN PatientMaster(NOLOCK) PM ON PM.Pm_Id = SIH.Sih_Pm_Id
				WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date) AND CONVERT(DATE, @Sih_DueDate)
					AND MM.Mm_MtmId = case when @Sid_Mm_Id > 0 then @Sid_Mm_Id else MM.Mm_MtmId end
					AND MM.Mm_ID = case when @Sid_Sih_Key > 0 then @Sid_Sih_Key else MM.Mm_ID end
				ORDER BY MM.Mm_Name ASC
			--END
			--ELSE
			--BEGIN
			--	SELECT SIH.Sih_No AS InvoiceNo
			--		,CONVERT(VARCHAR, SIH.Sih_Date, 105) AS DATE
			--		,PM.Pm_FullName AS PatientName
			--		,MM.Mm_Code AS DrugCode
			--		,MM.Mm_Name AS DrugName
			--		,UOMM.Uom_Name AS UOMName
			--		,SIID.Sid_BatchNo AS BatchNo
			--		,SIID.Sid_SalesQty AS QTY
			--		,SIID.Sid_SalesRate AS Rate
			--		,SIID.Sid_SubTotal AS SubTotal
			--		,SIID.Sid_Total AS Total
			--		,MTM.Mtm_TypeName AS DrugType
			--		,MGM.Mgm_Name AS DrugGroup
			--		,MCM.Mcm_Name AS DrugCategory
			--		,MM.Mm_HsnCode AS HsnCode
			--		,BM.Branch_Name
			--		,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
			--		,BM.Branch_GstNo
			--	FROM SalesInvoiceHeader(NOLOCK) SIH
			--	LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = SIH.Sih_BranchId
			--	INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SIH.Sih_Key
			--	INNER JOIN UomMaster(NOLOCK) UOMM ON UOMM.Uom_ID = SIID.Sid_SalesUomId
			--	INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			--	LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			--	LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			--	LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			--	INNER JOIN PatientMaster(NOLOCK) PM ON PM.Pm_Id = SIH.Sih_Pm_Id
			--	WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date)
			--			AND CONVERT(DATE, @Sih_DueDate)
			--	ORDER BY MM.Mm_Name ASC
			--END
		END
	ELSE IF @SP_STATUS = 'Retrive'
	BEGIN

	   	DECLARE @FormPrefix_Soret  NVARCHAR(max) 
		SELECT  @FormPrefix_Soret  = FormPrefix  
		FROM	 FormDetailTable (NOLOCK)
		WHERE	Id= 1
	    
		DECLARE @FormPrefixRet AS NVARCHAR(max) = '';
		SELECT @FormPrefixRet = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 3
		SELECT Sih_Key
			,@FormPrefixRet + CAST(Sih_No AS NVARCHAR(max)) AS Sih_No,Sih_Date,Sih_Invtype,Sih_Account,Sih_Pm_Id,Sih_Dm_Id,Sih_GstType
			,Sih_RateType,Sih_SubTotal,Sih_Total,Sih_CreatedBy,Sih_CreatedDate,Sih_UpdatedBy,Sih_UpdatedOn,Sih_YearId,Sih_Disc,Sih_DiscAmount,Sih_Status
			,Sih_BranchId,Sih_CardPay,Sih_CashPay,Sih_TotalPay,Sih_IsCreditBill,Sih_AccId,Sih_BookId,Sih_DueDate,Sih_IsOriginal,Sih_CardRemarks
			,Sih_Remark,pm.Pm_Mob,pm.Pm_EmailId,Sih_CusRefNo, pm.StoreCode,pm.Pm_Fullname  as storename,pm.Pm_Address,Sih_LR_NO,Sih_Lr_Date
			,Sih_TrasporterName,Sih_No_Of_Cases,Sih_Freight_Amount,Sih_Type
			--,SH.Po_Key
			--,SH.Po_No
		FROM dbo.SalesInvoiceHeader(NOLOCK) sih
		LEFT JOIN PatientMaster(NOLOCK) pm 
		ON		sih.Sih_Pm_Id = pm.Pm_Id
		--LEFT JOIN   SO_HEADER (NOLOCK) SH
		--ON  sih.Sih_Po_Key = SH.Po_Key
		WHERE Sih_Key = @Sih_Key;
		SELECT   distinct  Sid_Key,Sid_Sih_Key,Sid_SrNo,Sid_Mm_Id,Sid_MRP,Sid_BatchNo,Sid_ExpDate,Sid_SalesQty
			,Sid_SalesUomId
			--,Sid_MRP AS Sid_SalesRate----Change Hasmukh
			,Sid_SalesRate----Change Hasmukh
			,Sid_SubTotal
			,Sid_Total
			,Sid_MnfDate
			,Sid_Disc
			,Sid_DiscAmount
			,Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--sid.Sid_SalesQty AS Sid_Stock_Qty,
			--sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			vwStock.Item_Stock + sid.Sid_SalesQty AS Sid_Stock_Qty
			,vwStock.Purchase_Item_Stock + sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty
			,vwStock.Lm_Name  as  Sid_LmName
			,mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			--,lm.Lm_Name AS Sid_LmName 
			,ISNULL(SUM(srd.Srd_Qty), 0) Sid_ReturnQty,
			sid.Sid_Po_Key  as Sid_Pi_PoKey,
			--(sod.Pi_Qty - sod.Pi_PiQty) + sid.Sid_SalesQty AS PiQty,
			(sod.Pi_Qty - sod.Pi_PiQty) AS PiQty,
		   @FormPrefix_Soret +	 cast (Soh.Po_No  as  nvarchar(max)) as  So_No 
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Sid_Mm_Id
			AND vwStock.Item_Batchno = sid.Sid_BatchNo
			AND vwStock.Stk_LmId = Sid_LmId
		LEFT JOIN dbo.LocationMaster(NOLOCK) lm ON sid.Sid_LmId = lm.Lm_Id
		LEFT JOIN SalesReturnDetail(NOLOCK) srd ON srd.Sid_SihKey = sid.Sid_Sih_Key
			AND Srd_SidSrNo = sid.Sid_SrNo
			AND Srd_MmId = sid.Sid_Mm_Id
		LEFT JOIN   SO_DETAIL (NOLOCK)  SOD
	        ON   SOD.Pi_PoKey = SID.Sid_Po_Key
			and  sid.Sid_Mm_Id =sod.Pi_ItemId
	   left join   SO_HEADER (Nolock) Soh
	      on  soh.Po_Key=  SOD .Pi_PoKey
	  
		WHERE Sid_Sih_Key = @Sih_Key
		GROUP BY Sid_Key
			,Sid_Sih_Key
			,Sid_SrNo
			,Sid_Mm_Id
			,Sid_MRP
			,Sid_BatchNo
			,Sid_ExpDate
			,Sid_SalesQty
			,Sid_SalesUomId
			,Sid_SalesRate
			,Sid_SubTotal
			,Sid_Total
			,Sid_MnfDate
			,Sid_Disc
			,Sid_DiscAmount
			,Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code
			,mm.Mm_Name
			,mm.Mm_StkUom
			,mm.MM_PackSize
			,vwStock.Item_Stock + sid.Sid_SalesQty
			,vwStock.Purchase_Item_Stock + sid.Sid_PurchaseQty
			,mm.MM_PackSize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name
			,sid.Sid_Po_Key
			,sod.Pi_Qty 
			 ,sod.Pi_PiQty
			 , sid.Sid_SalesQty 
			 ,Po_No,
			 vwStock.Lm_Name 

		SELECT 0 AS Sid_Key
			,0 AS Sid_Sih_Key
			,0 AS Sid_SrNo
			,Sid_Mm_Id
			,vwStock.Item_MRP AS Sid_MRP
			,vwStock.Item_Batchno AS Sid_BatchNo
			,vwStock.Item_ExpDate AS Sid_ExpDate
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then Sid_SalesQty else 0.00 end as Sid_SalesQty,
			Sid_SalesQty
			,Sid_SalesUomId
			,vwStock.Item_Rate AS Sid_SalesRate
			,CASE 
				WHEN ISNULL(vwStock.Purchase_Item_Stock, 0) - ISNULL(Sid_PurchaseQty, 0) >= ISNULL(Sid_PurchaseQty, 0)
					THEN Sid_SubTotal
				ELSE 0
				END AS Sid_SubTotal
			,CASE 
				WHEN ISNULL(vwStock.Purchase_Item_Stock, 0) - ISNULL(Sid_PurchaseQty, 0) >= ISNULL(Sid_PurchaseQty, 0)
					THEN Sid_Total
				ELSE 0
				END AS Sid_Total
			,vwStock.Item_MnfDate AS Sid_MnfDate
			,0 AS Sid_Disc
			,0 AS Sid_DiscAmount
			,
			--case when isnull(vwStock.Purchase_Item_Stock,0)-ISNULL(Sid_PurchaseQty,0)>=ISNULL(Sid_PurchaseQty,0) then ISNULL(Sid_PurchaseQty,0) else 0 end as Sid_PurchaseQty,
			ISNULL(Sid_PurchaseQty, 0) AS Sid_PurchaseQty
			,Sid_PurchaseUomId
			,Sid_PurchaseRate
			,Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then vwStock.Item_Stock  else vwStock.Item_Stock end as Sid_Stock_Qty,
			vwStock.Item_Stock AS Sid_Stock_Qty
			,
			--vwStock.Item_Stock+sid.Sid_SalesQty AS Sid_Stock_Qty,
			--case when vwStock.Purchase_Item_Stock-Sid_PurchaseQty>=Sid_PurchaseQty then vwStock.Purchase_Item_Stock  else vwStock.Purchase_Item_Stock end as Sid_Purchase_Stock_Qty,
			vwStock.Purchase_Item_Stock AS Sid_Purchase_Stock_Qty
			,
			--vwStock.Purchase_Item_Stock+sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name AS Sid_LmName
			
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster (NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Sid_Mm_Id
			AND vwStock.Item_Batchno = sid.Sid_BatchNo
			AND vwStock.Stk_LmId = Sid_LmId
		LEFT JOIN dbo.LocationMaster lm ON sid.Sid_LmId = lm.Lm_Id
		WHERE Sid_Sih_Key = @Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'BindMedcn'
	BEGIN
		SELECT *
		FROM MedicineMaster(NOLOCK) MM
		WHERE MM.Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
		SELECT MM.Mm_ID
			,MM.Mm_Name
			,MM.Mm_Code
			,MM.Mm_LeadTime
			,MM.Mm_StkUom
			,UM.Uom_Code
			,UM.Uom_Name
			,UM.Uom_ID
			,MM.Mm_MRP
			,ISNULL(VW.STOCK, 0) AS Stock
		FROM MedicineMaster(NOLOCK) MM
		INNER JOIN UomMaster(NOLOCK) UM ON MM.Mm_StkUom = UM.Uom_ID
		LEFT JOIN VwTotalStock(NOLOCK) VW ON MM.Mm_ID = VW.STK_ITEM_ID
		WHERE MM.Mm_ID = @Sid_Mm_Id;
	END;
	ELSE IF @SP_STATUS = 'GetBatchwiseDetail'
	BEGIN
		SELECT CAST(0 AS BIT) AS Chk
			,
			--Stk_PackId,
			Ps_Code
			,Item_Batchno
			,Item_Stock
			,Item_Rate
		FROM vwStock(NOLOCK)
		WHERE Item_Id = @Sid_Mm_Id
			AND Item_Stock > 0;
	END;
	ELSE
	--IF @SP_STATUS = 'GetMedcnBatchwiseDetail'
	--  BEGIN
	--    DECLARE @dynaSql nvarchar(max);
	--    SET @dynaSql
	--    = 'SELECT * FROM vwStock WHERE Item_Id = ' + CAST(@Sid_Mm_Id AS nvarchar(10)) + ' AND Item_Batchno IN ('
	--    + @Sid_BatchNo + ')';
	--    EXEC (@dynaSql);
	--  END;
	--ELSE
	IF @SP_STATUS = 'GetMedcnBatchwiseDetail'
	BEGIN
		SELECT *
		FROM vwStock
		WHERE Item_Id = @Sid_Mm_Id
			AND Item_Batchno = @Sid_BatchNo
			AND Stk_LmId = @Sid_LmId
	END;

	ELSE IF @SP_STATUS = 'GetSerachDetail'
		BEGIN
			SELECT		Item_Id,Item_Code,Item_Name,Item_Batchno,Item_Stock,Item_Rate,Item_ExpDate,Item_Uom
			FROM		dbo.vwStock
			WHERE		Item_Stock > 0;
		END;

	ELSE IF @SP_STATUS = 'GetItemDetailOriginal'
		BEGIN
			
			IF EXISTS (SELECT * FROM tempdb.sys.tables  WHERE name='##TEMP_INV_PRINT_DATA')
				BEGIN
					DROP TABLE ##TEMP_INV_PRINT_DATA
				END
			
			SELECT		ROW_NUMBER () OVER (ORDER BY SID.Sid_Key ASC) AS SR_NO, sid.Sid_Key, sid.Sid_Sih_Key, sid.Sid_SrNo, sid.Sid_Mm_Id
				,mm.Mm_HsnCode AS sid_HsnCode
				,sh.Sih_No
				,--sid.Sid_PackId,
				sid.Sid_MRP
				,sid.Sid_BatchNo
				,(CASE WHEN ISNULL(sid.Sid_ExpDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_ExpDate)),2) 
			END)AS Sid_ExpDate
				,sid.Sid_SalesQty AS Sid_Qty
				,sid.Sid_SalesRate AS Sid_Rate
				,sid.Sid_SubTotal
				,sid.Sid_Total
				,(CASE WHEN ISNULL(sid.Sid_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,sid.Sid_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,sid.Sid_MnfDate)),2)  
			END)AS Sid_MnfDate
				,sid.Sid_Disc
				,sid.Sid_DiscAmount
				,mm.Mm_Code as Mm_Code
				,mm.Mm_Name AS MedicineName
				,um.Uom_Name
				,pm.Pm_Fullname AS Sih_PatientName
				,pm.Pm_Mob AS Sih_PatientMob
				,dm.Dm_Name AS Sih_DoctorName
				,sh.Sih_Date
				,sh.Sih_DiscAmount
				,sh.Sih_SubTotal
				,sh.Sih_Total
				,ISNULL(sh.Sih_IsOriginal, 0) AS Sih_IsOriginal,
				
				--CASE
				--	WHEN isnull(sh.Sih_IsOriginal,0) = 0 THEN 'ORIGINAL'
				--	ELSE 'DUPLICATE'
				--END AS Print_Status,
				'ORIGINAL' AS Print_Status
				,0.00 AS OtherBrandRate
				,BM.Branch_Name
				,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
				,BM.Branch_Logo AS BranchLogo
				,BM.Branch_GstNo AS BranchGSTNO
				,CM.City_Name AS BranchCity
				,mm.MM_PackSize AS sid_PackSize
				,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
				,convert(decimal(18,2),isnull(TAX.SGST,0)) as SGST
				,convert(decimal(18,2),isnull(TAX.CGST,0)) as CGST
				,convert(decimal(18,2),isnull(TAX.IGST,0)) as IGST
				,convert(decimal(18,2),isnull(TAX.SGSTPer,0)) as SGSTPer
				,convert(decimal(18,2),isnull(TAX.CGSTPer,0)) as CGSTPer
				,convert(decimal(18,2),isnull(TAX.IGSTPer,0)) as IGSTPer
				,CASE 
					WHEN sh.Sih_BookId = 3
						THEN 'GST Invoice'
					ELSE 'Bill of Supply'
					END BillType,
					pm.Drug_Lic as DrugLic,
					pm.Gst_no as  GstNo,
					pm.StoreCode as  Store_Code 
					, pm.Contact_PersonName as  ContactPerson
					,sh.Sih_LR_NO
					,sh.Sih_Lr_Date
					,sh.Sih_TrasporterName
					,sh.Sih_No_Of_Cases
					,sh.Sih_Freight_Amount
					,CONVERT(VARCHAR(MAX),'Copy') AS CopyType,
					0  as  CopyOrder,
					STORECM.City_Name  AS StoreCity,
					dbo.TowordsWithPaisa(isnull(sh.Sih_Total,0),'') as AmtInWords,
					pm.Pm_Address,
					pm.Pm_Mob ,
					pm.Pm_PanNo,
					SM.Store_MobNo ,
					BatchMnf.MBM_MANU_NAME

			iNTO	##TEMP_INV_PRINT_DATA		
			FROM	dbo.SalesInvoiceItemDetail(NOLOCK) sid
					LEFT JOIN TaxTransaction(NOLOCK) STAX 
			ON			sid.Sid_Key = STAX.Tr_DdocKey
					AND sid.Sid_Sih_Key = STAX.Tr_DocKey
					AND STAX.Tr_TxId = 2
					AND STAX.Tr_DocTyp = 2
					LEFT JOIN TaxTransaction(NOLOCK) CTAX 
			ON			sid.Sid_Key = CTAX.Tr_DdocKey
						AND sid.Sid_Sih_Key = CTAX.Tr_DocKey
					AND CTAX.Tr_DocTyp = 2
					AND CTAX.Tr_TxId = 3
					LEFT JOIN TaxTransaction(NOLOCK) ITAX 
			ON			sid.Sid_Key = ITAX.Tr_DdocKey
					AND sid.Sid_Sih_Key = ITAX.Tr_DocKey
					AND ITAX.Tr_DocTyp = 2
					AND ITAX.Tr_TxId = 4
					LEFT JOIN dbo.SalesInvoiceHeader(NOLOCK) sh 
			ON			sid.Sid_Sih_Key = sh.Sih_Key
					LEFT JOIN (
								SELECT	SID1.Sid_Key
										,SUM(SSTAX.Tr_TxTot) AS SGST,SSTAX.Tr_TxVal as SGSTPer
										,SUM(CCTAX.Tr_TxTot) AS CGST,CCTAX.Tr_TxVal as CGSTPer
										,SUM(IITAX.Tr_TxTot) AS IGST,IITAX.Tr_TxVal as IGSTPer
								FROM	dbo.SalesInvoiceItemDetail(NOLOCK) SID1
										INNER JOIN SalesInvoiceHeader SIH
								ON		SIH.Sih_Key=SID1.Sid_Sih_Key
										LEFT JOIN TaxTransaction(NOLOCK) SSTAX 
								ON		SID1.Sid_Key = SSTAX.Tr_DdocKey
										AND SID1.Sid_Sih_Key = SSTAX.Tr_DocKey
										AND SSTAX.Tr_TxId = 2
										AND SSTAX.Tr_DocTyp = 2
										LEFT JOIN TaxTransaction(NOLOCK) CCTAX 
								ON			SID1.Sid_Key = CCTAX.Tr_DdocKey
										AND SID1.Sid_Sih_Key = CCTAX.Tr_DocKey
										AND CCTAX.Tr_DocTyp = 2
										AND CCTAX.Tr_TxId = 3
										LEFT JOIN TaxTransaction(NOLOCK) IITAX 
								ON		SID1.Sid_Key = IITAX.Tr_DdocKey
										AND SID1.Sid_Sih_Key = IITAX.Tr_DocKey
										AND IITAX.Tr_DocTyp = 2
										AND IITAX.Tr_TxId = 4
								where		sid1.Sid_Sih_Key = @Sid_Sih_Key
								GROUP BY	SID1.Sid_Key,SSTAX.Tr_TxVal,CCTAX.Tr_TxVal,IITAX.Tr_TxVal
					) AS TAX 
			ON			SID.Sid_Key = TAX.Sid_Key
					LEFT JOIN dbo.MedicineMaster(NOLOCK) mm 
			ON			sid.Sid_Mm_Id = mm.Mm_ID
					LEFT JOIN dbo.UomMaster (NOLOCK) as um 
			on			mm.Mm_StkUom=um.Uom_ID
					LEFT JOIN dbo.PatientMaster(NOLOCK) pm 
			ON			sh.Sih_Pm_Id = pm.Pm_Id
					LEFT JOIN dbo.DoctorMaster(NOLOCK) dm 
			ON			sh.Sih_Dm_Id = dm.Dm_Id
					LEFT JOIN dbo.BranchMaster(NOLOCK) BM 
			ON			sh.Sih_BranchId = BM.Branch_Id
					LEFT JOIN dbo.CityMaster(NOLOCK) CM 
			ON			BM.Branch_CityId = CM.City_ID
					LEFT JOIN StoreMaster (NOLOCK) SM  
			on			sm.Store_Id =   pm.StoreId
					LEFT  JOIN  CityMaster (NOLOCK) STORECM   
			ON			STORECM.City_ID =  SM.Store_CityId 
					LEFT JOIN MedicineBatchManufacture as BatchMnf
			ON			sid.Sid_Mm_Id=BatchMnf.MBM_MM_ID
					AND sid.Sid_BatchNo=BatchMnf.MBM_BATCH_NO
			WHERE	sid.Sid_Sih_Key = @Sid_Sih_Key;
			--WHERE sid.Sid_Sih_Key = 941;
						
			--SELECT		IGSTPer AS IGST,SUM(IGST) AS IGSTSUM,SGSTPer AS SGST,SUM(SGST) AS SGSTSUM,CGSTPer AS CGST,SUM(CGST) AS CGSTSUM 
			--INTO		#TEMP_TAX_SUMMATION
			--FROM		##TEMP_INV_PRINT_DATA 
			--GROUP BY	IGSTPer,SGSTPer,CGSTPer

			

			IF CHARINDEX('O',@Sih_Remark) > 0   
				BEGIN  
					INSERT	
					INTO		##TEMP_INV_PRINT_DATA
					SELECT		SR_NO,Sid_Key, Sid_Sih_Key, Sid_SrNo, Sid_Mm_Id, sid_HsnCode, Sih_No, Sid_MRP, Sid_BatchNo, Sid_ExpDate, Sid_Qty, Sid_Rate, Sid_SubTotal, Sid_Total, 
								Sid_MnfDate, Sid_Disc, Sid_DiscAmount, Mm_Code, MedicineName, Uom_Name, Sih_PatientName, Sih_PatientMob, Sih_DoctorName, Sih_Date, Sih_DiscAmount, 
								Sih_SubTotal, Sih_Total, Sih_IsOriginal, Print_Status, OtherBrandRate, Branch_Name, BranchAddress, BranchLogo, BranchGSTNO, BranchCity, sid_PackSize, TAX, 
								SGST, CGST, IGST, SGSTPer, CGSTPer, IGSTPer, BillType, DrugLic, GstNo, Store_Code, ContactPerson, Sih_LR_NO, Sih_Lr_Date, Sih_TrasporterName, 
								Sih_No_Of_Cases, Sih_Freight_Amount,'Original Copy' CopyType,2 CopyOrder, StoreCity,AmtInWords,Pm_Address,Pm_Mob ,Pm_PanNo,Store_MobNo,MBM_MANU_NAME
					FROM		##TEMP_INV_PRINT_DATA A
					WHERE		A.CopyType='Copy' 
					ORDER BY	SR_NO ASC
				END  

			IF CHARINDEX('T',@Sih_Remark) > 0   
				BEGIN 
					INSERT	INTO ##TEMP_INV_PRINT_DATA
					SELECT	SR_NO,Sid_Key, Sid_Sih_Key, Sid_SrNo, Sid_Mm_Id, sid_HsnCode, Sih_No, Sid_MRP, Sid_BatchNo, Sid_ExpDate, Sid_Qty, Sid_Rate, Sid_SubTotal, Sid_Total, 
							Sid_MnfDate, Sid_Disc, Sid_DiscAmount, Mm_Code, MedicineName, Uom_Name, Sih_PatientName, Sih_PatientMob, Sih_DoctorName, Sih_Date, Sih_DiscAmount, 
							Sih_SubTotal, Sih_Total, Sih_IsOriginal, Print_Status, OtherBrandRate, Branch_Name, BranchAddress, BranchLogo, BranchGSTNO, BranchCity, sid_PackSize, TAX, 
							SGST, CGST, IGST, SGSTPer, CGSTPer, IGSTPer, BillType, DrugLic, GstNo, Store_Code, ContactPerson, Sih_LR_NO, Sih_Lr_Date, Sih_TrasporterName, 
							Sih_No_Of_Cases, Sih_Freight_Amount,'Transporter Copy' CopyType,2 CopyOrder, StoreCity,AmtInWords,Pm_Address,Pm_Mob ,Pm_PanNo,Store_MobNo ,MBM_MANU_NAME
					FROM	##TEMP_INV_PRINT_DATA A
					WHERE	A.CopyType='Copy' ORDER BY SR_NO ASC
				END

			IF CHARINDEX('D',@Sih_Remark) > 0   
				BEGIN 
					INSERT	INTO ##TEMP_INV_PRINT_DATA
					SELECT	SR_NO,Sid_Key, Sid_Sih_Key, Sid_SrNo, Sid_Mm_Id, sid_HsnCode, Sih_No, Sid_MRP, Sid_BatchNo, Sid_ExpDate, Sid_Qty, Sid_Rate, Sid_SubTotal, Sid_Total, 
							Sid_MnfDate, Sid_Disc, Sid_DiscAmount, Mm_Code, MedicineName, Uom_Name, Sih_PatientName, Sih_PatientMob, Sih_DoctorName, Sih_Date, Sih_DiscAmount, 
							Sih_SubTotal, Sih_Total, Sih_IsOriginal, Print_Status, OtherBrandRate, Branch_Name, BranchAddress, BranchLogo, BranchGSTNO, BranchCity, sid_PackSize, TAX, 
							SGST, CGST, IGST, SGSTPer, CGSTPer, IGSTPer, BillType, DrugLic, GstNo, Store_Code, ContactPerson, Sih_LR_NO, Sih_Lr_Date, Sih_TrasporterName, 
							Sih_No_Of_Cases, Sih_Freight_Amount,'Duplicate Copy' CopyType,3 CopyOrder,StoreCity, AmtInWords,Pm_Address,	Pm_Mob ,Pm_PanNo,Store_MobNo ,MBM_MANU_NAME
					FROM	##TEMP_INV_PRINT_DATA A
					WHERE	A.CopyType='Copy' ORDER BY SR_NO ASC
				END

			IF CHARINDEX('E',@Sih_Remark) > 0   
				BEGIN 
					INSERT	INTO ##TEMP_INV_PRINT_DATA
					SELECT	SR_NO,Sid_Key, Sid_Sih_Key, Sid_SrNo, Sid_Mm_Id, sid_HsnCode, Sih_No, Sid_MRP, Sid_BatchNo, Sid_ExpDate, Sid_Qty, Sid_Rate, Sid_SubTotal, Sid_Total, 
							Sid_MnfDate, Sid_Disc, Sid_DiscAmount, Mm_Code, MedicineName, Uom_Name, Sih_PatientName, Sih_PatientMob, Sih_DoctorName, Sih_Date, Sih_DiscAmount, 
							Sih_SubTotal, Sih_Total, Sih_IsOriginal, Print_Status, OtherBrandRate, Branch_Name, BranchAddress, BranchLogo, BranchGSTNO, BranchCity, sid_PackSize, TAX, 
							SGST, CGST, IGST, SGSTPer, CGSTPer, IGSTPer, BillType, DrugLic, GstNo, Store_Code, ContactPerson, Sih_LR_NO, Sih_Lr_Date, Sih_TrasporterName, 
							Sih_No_Of_Cases, Sih_Freight_Amount,'Extra Copy' CopyType,4 CopyOrder,StoreCity,AmtInWords,Pm_Address,Pm_Mob ,Pm_PanNo,Store_MobNo ,MBM_MANU_NAME
					FROM	##TEMP_INV_PRINT_DATA A
					WHERE	A.CopyType='Copy' ORDER BY SR_NO ASC
				END
			
			DELETE 
			FROM		##TEMP_INV_PRINT_DATA 
			WHERE		CopyType = 'Copy'

			SELECT		* 
			FROM		##TEMP_INV_PRINT_DATA 
			ORDER BY	SR_NO ASC

			SELECT		SUM(SID.Sid_SubTotal) AS Sid_SubTotal,
						--CASE WHEN TX.Tr_TxType = 'A' THEN 'IGST'
						--	 WHEN TX.Tr_TxType = 'S' THEN 'SGST'
						--	 WHEN TX.Tr_TxType = 'C' THEN 'CGST' END AS Tax_Type,
						C.Tax_Name AS Tax_Type,
						ISNULL(Tr_TxVal,0) AS Tax_Perc, 
						SUM(Tr_TxTot) AS Tax_Total,
						SIH.Sih_SubTotal
			FROM		TaxTransaction (NOLOCK) TX
						INNER JOIN SalesInvoiceItemDetail SID
			ON				SID.Sid_Key=TX.Tr_DdocKey
						AND SID.Sid_Sih_Key=TX.Tr_DocKey
						AND TX.Tr_DocTyp=2
						iNNER JOIN TaxMaster C
			ON				Tx.Tr_TxId=C.Tax_ID
						INNER JOIN SalesInvoiceHeader SIH
			ON			SIH.Sih_Key=SID.Sid_Sih_Key
			WHERE			Tr_DocTyp = 2
						
						AND Tr_DocKey = @Sid_Sih_Key
						AND Tr_TxId NOT IN(1)

			GROUP BY	
						--CASE WHEN Tr_TxType = 'A' THEN 'IGST'
						--	 WHEN Tr_TxType = 'S' THEN 'SGST'
						--	 WHEN Tr_TxType = 'C' THEN 'CGST' END, 
						ISNULL(Tr_TxVal,0),C.Tax_Name,SIH.Sih_SubTotal
			--HAVING		Tr_TxVal > 0
			ORDER BY	Tax_Perc 

			--SELECT		*
			--FROM		#TEMP_TAX_SUMMATION
		END;

	ELSE IF @SP_STATUS = 'GetItemDetailDuplicate'
	BEGIN
		SELECT sid.Sid_Key
			,sid.Sid_Sih_Key
			,sid.Sid_SrNo
			,sid.Sid_Mm_Id
			,mm.Mm_HsnCode AS sid_HsnCode
			,sh.Sih_No
			,--sid.Sid_PackId,
			sid.Sid_MRP
			,sid.Sid_BatchNo
			,sid.Sid_ExpDate
			,sid.Sid_SalesQty AS Sid_Qty
			,sid.Sid_SalesRate AS Sid_Rate
			,sid.Sid_SubTotal
			,sid.Sid_Total
			,sid.Sid_MnfDate
			,sid.Sid_Disc
			,sid.Sid_DiscAmount
			,mm.Mm_Name AS MedicineName
			,pm.Pm_Fullname AS Sih_PatientName
			,pm.Pm_Mob AS Sih_PatientMob
			,dm.Dm_Name AS Sih_DoctorName
			,sh.Sih_Date
			,sh.Sih_DiscAmount
			,sh.Sih_SubTotal
			,sh.Sih_Total
			,ISNULL(sh.Sih_IsOriginal, 0) AS Sih_IsOriginal
			,'DUPLICATE' AS Print_Status
			,0.00 AS OtherBrandRate
			,BM.Branch_Name
			,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
			,BM.Branch_Logo AS BranchLogo
			,BM.Branch_GstNo AS BranchGSTNO
			,CM.City_Name AS BranchCity
			,mm.MM_PackSize AS sid_PackSize
			,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
			,TAX.SGST
			,TAX.CGST
			,TAX.IGST
			,CASE 
				WHEN sh.Sih_BookId = 3
					THEN 'GST Invoice'
				ELSE 'Bill of Supply'
				END BillType,
				pm.Drug_Lic as DrugLic,
				pm.Gst_no as  GstNo,
				pm.StoreCode as  Store_Code ,
				PM.Contact_PersonName AS ContactPerson,
				PM.Pm_Address
		FROM dbo.SalesInvoiceItemDetail(NOLOCK) sid
		LEFT JOIN TaxTransaction(NOLOCK) STAX ON sid.Sid_Key = STAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = STAX.Tr_DocKey
			AND STAX.Tr_TxId = 2
			AND STAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CTAX ON sid.Sid_Key = CTAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = CTAX.Tr_DocKey
			AND CTAX.Tr_DocTyp = 2
			AND CTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) ITAX ON sid.Sid_Key = ITAX.Tr_DdocKey
			AND sid.Sid_Sih_Key = ITAX.Tr_DocKey
			AND ITAX.Tr_DocTyp = 2
			AND ITAX.Tr_TxId = 4
		LEFT JOIN dbo.SalesInvoiceHeader(NOLOCK) sh ON sid.Sid_Sih_Key = sh.Sih_Key
		LEFT JOIN (
			SELECT SIH.Sih_Key
				,SUM(SSTAX.Tr_TxTot) AS SGST
				,SUM(CCTAX.Tr_TxTot) AS CGST
				,SUM(IITAX.Tr_TxTot) AS IGST
			FROM dbo.SalesInvoiceItemDetail(NOLOCK) SID1
			     INNER JOIN SalesInvoiceHeader SIH
			  ON SIH.Sih_Key=SID1.Sid_Sih_Key
			LEFT JOIN TaxTransaction(NOLOCK) SSTAX ON SID1.Sid_Key = SSTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = SSTAX.Tr_DocKey
			AND SSTAX.Tr_TxId = 2
			AND SSTAX.Tr_DocTyp = 2
		LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SID1.Sid_Key = CCTAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = CCTAX.Tr_DocKey
			AND CCTAX.Tr_DocTyp = 2
			AND CCTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SID1.Sid_Key = IITAX.Tr_DdocKey
			AND SID1.Sid_Sih_Key = IITAX.Tr_DocKey
			AND IITAX.Tr_DocTyp = 2
			AND IITAX.Tr_TxId = 4
			GROUP BY SIH.Sih_Key
			) AS TAX ON sh.Sih_Key = TAX.Sih_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON sh.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON sh.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON sh.Sih_BranchId = BM.Branch_Id
		LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
		WHERE sid.Sid_Sih_Key = @Sid_Sih_Key;
	END;
	ELSE IF @SP_STATUS = 'GetPreviousNumber'
	BEGIN
		IF @Sih_Key > 0
			SELECT MAX(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK)
			WHERE Sih_Key < @Sih_Key;
		ELSE
			SELECT MAX(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'GetNextNumber'
	BEGIN
		IF @Sih_Key > 0
			SELECT MIN(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK)
			WHERE Sih_Key > @Sih_Key;
		ELSE
			SELECT MIN(Sih_Key) AS Sih_Key
			FROM dbo.SalesInvoiceHeader(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'GetLedgerId'
	BEGIN
		--SELECT Lm_Id
		--FROM LedgerMaster (NOLOCK) 
		--WHERE Lm_PVId = @Sih_Pm_Id;
		SELECT Pm_Ledger_Id AS Lm_Id
		FROM PatientMaster
		WHERE Pm_Id = @Sih_Pm_Id;
	END;
	ELSE IF @SP_STATUS = 'GetLedgerIdFromVendor'
	BEGIN
		--SELECT Lm_Id
		--FROM LedgerMaster (NOLOCK) 
		--WHERE Lm_PVId = @Sih_Pm_Id;
		SELECT Vendor_Ledger_id Lm_Id
		FROM VendorMaster (NOLOCK)
		WHERE Vendor_ID = @Sih_Pm_Id;
	END;
	ELSE IF @SP_STATUS = 'FillCashAccount'
	BEGIN
		SELECT Lm_Id
			,Lm_Name
		FROM LedgerMaster(NOLOCK)
		WHERE Lm_Id = 11;
	END;
	ELSE IF @SP_STATUS = 'GetPatientDetail'
	BEGIN
		SELECT DISTINCT (Pm_Mob) AS MobileNo
		FROM PatientMaster(NOLOCK)
		WHERE Pm_IsActive = 1
			AND ISNULL(Pm_Mob, '0') <> '0'
	END;
	ELSE IF @SP_STATUS = 'GetPatient'
	BEGIN
		SELECT *
		FROM PatientMaster (NOLOCK)
		WHERE Pm_Mob = @Sih_CardRemarks
			AND Pm_IsActive = 1
			AND ISNULL(Pm_Mob, '0') <> '0'
	END;
	ELSE IF @SP_STATUS = 'GetPatientMobile'
	BEGIN
		SELECT Pm_Mob AS MobileNo
			,Pm_EmailId
		FROM PatientMaster(NOLOCK)
		WHERE Pm_IsActive = 1
			AND Pm_Id = @Sih_Pm_Id
	END;
	ELSE IF @SP_STATUS = 'SalesHeaderForReport'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
	END;
	ELSE IF @SP_STATUS = 'SalesDetailForReport'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_SalesQty AS Qty
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_SalesUomId = UM.Uom_ID
		--LEFT JOIN PacketSizeMater AS PSM
		--  ON PSM.Ps_ID = SD.Sid_PackId
		--LEFT JOIN MedicinePacketSizeMaster AS PSM
		--ON PSM.Mps_Id=SD.Sid_PackId and PSM.Mps_MmId=SD.Sid_Mm_Id
		LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
	END;
	ELSE IF @SP_STATUS = 'SalesHeaderForReportWithFilter'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			--SELECT DISTINCT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
				
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,
			--	--ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
			--	ISNULL(BB.SGST, 0.00) + ISNULL(BB.CGST, 0.00) + ISNULL(BB.IGST, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,ISNULL(BB.SGST, 0) AS SGST
			--	,ISNULL(BB.CGST, 0) AS CGST
			--	,ISNULL(BB.IGST, 0) AS IGST
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			--LEFT JOIN (
			--	SELECT A.Sid_Sih_Key
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Sid_Sih_Key
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM SalesInvoiceItemDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Sid_Mm_Id
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Sid_Key = B.Tr_DdocKey
			--			AND A.Sid_Sih_Key = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 2
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Sid_Key = C.Tr_DdocKey
			--			AND A.Sid_Sih_Key = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 2
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Sid_Key = D.Tr_DdocKey
			--			AND A.Sid_Sih_Key = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 2
			--			AND D.Tr_TxId = 4
			--		INNER JOIN SalesInvoiceHeader SH1
			--		ON	SH1.Sih_Key=A.Sid_Sih_Key
			--		WHERE CONVERT(DATE, SH1.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--		) AS A
			--	GROUP BY A.Sid_Sih_Key
			--	) AS BB ON SH.Sih_Key = BB.Sid_Sih_Key
			--INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SH.Sih_Key
			--INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--	AND MM.Mm_MtmId = @Sid_Mm_Id
        SELECT	SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date) AS BillDate,
        		SIH.Sih_No AS BillNo,
        		PM.Pm_Fullname AS PartyName,
        		ISNULL(SIH.Sih_SubTotal, 0.00) AS GrossAmount,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) + SUM(ISNULL(TXC.Tr_TxTot, 0)) + SUM(ISNULL(TXI.Tr_TxTot, 0)) AS TaxAmount,
        		ISNULL(SIH.Sih_DiscAmount, 0.00) AS Discount,
        		SIH.Sih_Total AS NetAmount,
        		BM.Branch_Name,
        		Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
        		bm.Branch_GstNo,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) AS SGST,
        		SUM(ISNULL(TXC.Tr_TxTot, 0)) AS CGST,
        		SUM(ISNULL(TXI.Tr_TxTot, 0)) AS IGST,
				pm.StoreCode as  Store_Code
        FROM	SalesInvoiceHeader SIH
        		LEFT JOIN PatientMaster(NOLOCK) AS PM 
        	ON	SIH.Sih_Pm_Id = PM.Pm_Id
        		LEFT JOIN BranchMaster(NOLOCK) BM 
        	ON	SIH.Sih_BranchId = BM.Branch_Id
        		INNER JOIN SalesInvoiceItemDetail SID
        	ON	SID.Sid_Sih_Key=SIH.Sih_Key
        	    INNER JOIN MedicineMaster(NOLOCK) MM 
        	ON	MM.Mm_ID = SID.Sid_Mm_Id
        		LEFT JOIN TaxTransaction TXS
        	ON	TXS.Tr_DdocKey=SID.Sid_Key
        		AND TXS.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXS.Tr_DocTyp=2
        		AND TXS.Tr_TxId=2
        		LEFT JOIN TaxTransaction TXC
        	ON	TXC.Tr_DdocKey=SID.Sid_Key
        		AND TXC.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXC.Tr_DocTyp=2
        		AND TXC.Tr_TxId=3
        		LEFT JOIN TaxTransaction TXI
        	ON	TXI.Tr_DdocKey=SID.Sid_Key
        		AND TXI.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXI.Tr_DocTyp=2
        		AND TXI.Tr_TxId=4
        WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
        					AND CONVERT(DATE, @Sih_DueDate, 105)
        				AND MM.Mm_MtmId = @Sid_Mm_Id
        		GROUP BY
        		SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date),
        		SIH.Sih_No ,
        		PM.Pm_Fullname,
        		SIH.Sih_SubTotal,
        		SIH.Sih_DiscAmount,
        		SIH.Sih_Total,
        		BM.Branch_Name,
        		Bm.Branch_Address1,
        		Bm.Branch_Address2,
        		Bm.Branch_Address3,
        		bm.Branch_GstNo,
				pm.StoreCode
        			
		END
		ELSE
		BEGIN
			--SELECT DISTINCT Sh.Sih_Key
			--	,CONVERT(DATE, SH.Sih_Date) AS BillDate
			--	,SH.Sih_No AS BillNo
			--	,PM.Pm_Fullname AS PartyName
				
			--	,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			--	,
			--	--ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
			--	ISNULL(BB.SGST, 0.00) + ISNULL(BB.CGST, 0.00) + ISNULL(BB.IGST, 0.00) AS TaxAmount
			--	,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			--	,SH.Sih_Total AS NetAmount
			--	,BM.Branch_Name
			--	,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			--	,bm.Branch_GstNo
			--	,ISNULL(BB.SGST, 0) AS SGST
			--	,ISNULL(BB.CGST, 0) AS CGST
			--	,ISNULL(BB.IGST, 0) AS IGST
			--FROM SalesInvoiceHeader(NOLOCK) AS SH
			--LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			--LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			--LEFT JOIN (
			--	SELECT A.Sid_Sih_Key
			--		,ISNULL(SUM(A.SGST), 0) AS SGST
			--		,ISNULL(SUM(A.CGST), 0) AS CGST
			--		,ISNULL(SUM(A.IGST), 0) AS IGST
			--	FROM (
			--		SELECT A.Sid_Sih_Key
			--			,B.Tr_TxTot AS CGST
			--			,C.Tr_TxTot AS SGST
			--			,D.Tr_TxTot AS IGST
			--		FROM SalesInvoiceItemDetail(NOLOCK) A
			--		INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = A.Sid_Mm_Id
			--		LEFT JOIN TaxTransaction(NOLOCK) B ON A.Sid_Key = B.Tr_DdocKey
			--			AND A.Sid_Sih_Key = B.Tr_DocKey
			--			AND B.Tr_TxId = 2
			--			AND B.Tr_DocTyp = 2
			--		LEFT JOIN TaxTransaction(NOLOCK) C ON A.Sid_Key = C.Tr_DdocKey
			--			AND A.Sid_Sih_Key = C.Tr_DocKey
			--			AND C.Tr_DocTyp = 2
			--			AND C.Tr_TxId = 3
			--		LEFT JOIN TaxTransaction(NOLOCK) D ON A.Sid_Key = D.Tr_DdocKey
			--			AND A.Sid_Sih_Key = D.Tr_DocKey
			--			AND D.Tr_DocTyp = 2
			--			AND D.Tr_TxId = 4
			--		INNER JOIN SalesInvoiceHeader SH1
			--		ON	SH1.Sih_Key=A.Sid_Sih_Key
			--		WHERE CONVERT(DATE, SH1.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
			--		) AS A
			--	GROUP BY A.Sid_Sih_Key
			--	) AS BB ON SH.Sih_Key = BB.Sid_Sih_Key
			--INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SH.Sih_Key
			--INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			--WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105)
        SELECT	SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date) AS BillDate,
        		SIH.Sih_No AS BillNo,
        		PM.Pm_Fullname AS PartyName,
        		ISNULL(SIH.Sih_SubTotal, 0.00) AS GrossAmount,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) + SUM(ISNULL(TXC.Tr_TxTot, 0)) + SUM(ISNULL(TXI.Tr_TxTot, 0)) AS TaxAmount,
        		ISNULL(SIH.Sih_DiscAmount, 0.00) AS Discount,
        		SIH.Sih_Total AS NetAmount,
        		BM.Branch_Name,
        		Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
        		bm.Branch_GstNo,
        		SUM(ISNULL(TXS.Tr_TxTot, 0)) AS SGST,
        		SUM(ISNULL(TXC.Tr_TxTot, 0)) AS CGST,
        		SUM(ISNULL(TXI.Tr_TxTot, 0)) AS IGST,
				pm.StoreCode as  Store_Code
        FROM	SalesInvoiceHeader SIH
        		LEFT JOIN PatientMaster(NOLOCK) AS PM 
        	ON	SIH.Sih_Pm_Id = PM.Pm_Id
        		LEFT JOIN BranchMaster(NOLOCK) BM 
        	ON	SIH.Sih_BranchId = BM.Branch_Id
        		INNER JOIN SalesInvoiceItemDetail SID
        	ON	SID.Sid_Sih_Key=SIH.Sih_Key
        	    INNER JOIN MedicineMaster(NOLOCK) MM 
        	ON	MM.Mm_ID = SID.Sid_Mm_Id
        		LEFT JOIN TaxTransaction TXS
        	ON	TXS.Tr_DdocKey=SID.Sid_Key
        		AND TXS.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXS.Tr_DocTyp=2
        		AND TXS.Tr_TxId=2
        		LEFT JOIN TaxTransaction TXC
        	ON	TXC.Tr_DdocKey=SID.Sid_Key
        		AND TXC.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXC.Tr_DocTyp=2
        		AND TXC.Tr_TxId=3
        		LEFT JOIN TaxTransaction TXI
        	ON	TXI.Tr_DdocKey=SID.Sid_Key
        		AND TXI.Tr_DocKey=SID.Sid_Sih_Key
        		AND TXI.Tr_DocTyp=2
        		AND TXI.Tr_TxId=4
        WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
        					AND CONVERT(DATE, @Sih_DueDate, 105)
        				
        		GROUP BY
        		SIH.Sih_Key,
        		CONVERT(DATE, SIH.Sih_Date),
        		SIH.Sih_No ,
        		PM.Pm_Fullname,
        		SIH.Sih_SubTotal,
        		SIH.Sih_DiscAmount,
        		SIH.Sih_Total,
        		BM.Branch_Name,
        		Bm.Branch_Address1,
        		Bm.Branch_Address2,
        		Bm.Branch_Address3,
        		bm.Branch_GstNo,
				pm.StoreCode
        			
		END
	END;
	ELSE IF @SP_STATUS = 'SalesHeaderForReportWithFilter_HSN'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			SELECT B.Mm_Code
				,B.Mm_Name
				,B.Mm_HsnCode
				,SUM(AA.Sid_SalesQty) AS QTY
				,BM.Branch_Name
				,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
				,bm.Branch_GstNo
				,SUM(ISNULL(BB.Tr_TxTot, 0)) AS CGST
				,SUM(ISNULL(CC.Tr_TxTot, 0)) AS SGST
				,SUM(ISNULL(D.Tr_TxTot, 0)) AS IGST
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
			FROM SalesInvoiceItemDetail(NOLOCK) AA
			INNER JOIN MedicineMaster(NOLOCK) B ON AA.Sid_Mm_Id = B.Mm_ID
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = B.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = B.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = B.Mm_McmId
			LEFT JOIN SalesInvoiceHeader(NOLOCK) AS SH ON SH.Sih_Key = AA.Sid_Sih_Key
			LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			LEFT JOIN TaxTransaction(NOLOCK) BB ON AA.Sid_Key = BB.Tr_DdocKey
				AND AA.Sid_Sih_Key = BB.Tr_DocKey
				AND BB.Tr_TxId = 2
				AND BB.Tr_DocTyp = 2
			LEFT JOIN TaxTransaction(NOLOCK) CC ON AA.Sid_Key = CC.Tr_DdocKey
				AND AA.Sid_Sih_Key = CC.Tr_DocKey
				AND CC.Tr_DocTyp = 2
				AND CC.Tr_TxId = 3
			LEFT JOIN TaxTransaction(NOLOCK) D ON AA.Sid_Key = D.Tr_DdocKey
				AND AA.Sid_Sih_Key = D.Tr_DocKey
				AND D.Tr_DocTyp = 2
				AND D.Tr_TxId = 4
			WHERE B.Mm_MtmId = @Sid_Mm_Id
			GROUP BY B.Mm_Code
				,B.Mm_Name
				,B.Mm_HsnCode
				,MTM.Mtm_TypeName
				,MGM.Mgm_Name
				,MCM.Mcm_Name
				,BM.Branch_Name
				,Bm.Branch_Address1
				,Bm.Branch_Address2
				,Bm.Branch_Address3
				,bm.Branch_GstNo
				,SH.Sih_Date
			HAVING CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					AND CONVERT(DATE, @Sih_DueDate, 105)
		END
		ELSE
		BEGIN
			SELECT B.Mm_Code
				,B.Mm_Name
				,B.Mm_HsnCode
				,SUM(AA.Sid_SalesQty) AS QTY
				,BM.Branch_Name
				,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
				,bm.Branch_GstNo
				,SUM(ISNULL(BB.Tr_TxTot, 0)) AS CGST
				,SUM(ISNULL(CC.Tr_TxTot, 0)) AS SGST
				,SUM(ISNULL(D.Tr_TxTot, 0)) AS IGST
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
			FROM SalesInvoiceItemDetail(NOLOCK) AA
			INNER JOIN MedicineMaster(NOLOCK) B ON AA.Sid_Mm_Id = B.Mm_ID
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = B.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = B.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = B.Mm_McmId
			LEFT JOIN SalesInvoiceHeader(NOLOCK) AS SH ON SH.Sih_Key = AA.Sid_Sih_Key
			LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			LEFT JOIN TaxTransaction(NOLOCK) BB ON AA.Sid_Key = BB.Tr_DdocKey
				AND AA.Sid_Sih_Key = BB.Tr_DocKey
				AND BB.Tr_TxId = 2
				AND BB.Tr_DocTyp = 2
			LEFT JOIN TaxTransaction(NOLOCK) CC ON AA.Sid_Key = CC.Tr_DdocKey
				AND AA.Sid_Sih_Key = CC.Tr_DocKey
				AND CC.Tr_DocTyp = 2
				AND CC.Tr_TxId = 3
			LEFT JOIN TaxTransaction(NOLOCK) D ON AA.Sid_Key = D.Tr_DdocKey
				AND AA.Sid_Sih_Key = D.Tr_DocKey
				AND D.Tr_DocTyp = 2
				AND D.Tr_TxId = 4
			GROUP BY B.Mm_Code
				,B.Mm_Name
				,B.Mm_HsnCode
				,MTM.Mtm_TypeName
				,MGM.Mgm_Name
				,MCM.Mcm_Name
				,BM.Branch_Name
				,Bm.Branch_Address1
				,Bm.Branch_Address2
				,Bm.Branch_Address3
				,bm.Branch_GstNo
				,SH.Sih_Date
			HAVING CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					AND CONVERT(DATE, @Sih_DueDate, 105)
		END
	END
	ELSE IF @SP_STATUS = 'SalesDetailForReportWithFilter'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			SELECT Sh.Sih_Key
				,CONVERT(DATE, SH.Sih_Date) AS BillDate
				,SH.Sih_No AS BillNo
				,PM.Pm_Fullname AS PartyName
				,ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,2,2),0.00) AS CGST,
				ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,3,2),0.00) AS SGST,
				ISNULL([dbo].funcGetTaxSum(SH.Sih_Key,4,2),0.00) AS IGST
				,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,2,2,SD.Sid_Key),0.00) AS ItemCGST
				,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,3,2,SD.Sid_Key),0.00) AS ItemSGST
				,ISNULL([dbo].funcItemWiseTax (SH.Sih_Key,4,2,SD.Sid_Key),0.00) AS ItemIGST
				,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
				,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
				,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
				,SH.Sih_Total AS NetAmount
				,BM.Branch_Name
				,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
				,bm.Branch_GstNo
				,MM.Mm_Name MedicinName
				,UM.Uom_Name AS UOM
				,'' AS PackSize
				,SD.Sid_ExpDate AS ExpDate
				,SD.Sid_BatchNo AS BatchNo
				,SD.Sid_SalesRate AS Rate
				,SD.Sid_Total AS Total
				,SD.Sid_PurchaseQty AS Qty
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
				,MM.Mm_Code AS DrugCode
				,MM.Mm_HsnCode AS HsnCode
			FROM SalesInvoiceHeader(NOLOCK) AS SH
			LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
			LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
			--LEFT JOIN PacketSizeMater AS PSM
			--  ON PSM.Ps_ID = SD.Sid_PackId
			--LEFT JOIN  MedicinePacketSizeMaster   AS PSM
			--on  psm.Mps_Id=sd.Sid_PackId
			LEFT JOIN BranchMaster BM ON SH.Sih_BranchId = BM.Branch_Id
			WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					AND CONVERT(DATE, @Sih_DueDate, 105)
				AND MM.Mm_MtmId = @Sid_Mm_Id
		END
		ELSE
		BEGIN
			SELECT Sh.Sih_Key
				,CONVERT(DATE, SH.Sih_Date) AS BillDate
				,SH.Sih_No AS BillNo
				,PM.Pm_Fullname AS PartyName
				,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
				,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
				,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
				,SH.Sih_Total AS NetAmount
				,BM.Branch_Name
				,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
				,bm.Branch_GstNo
				,MM.Mm_Name MedicinName
				,UM.Uom_Name AS UOM
				,'' AS PackSize
				,SD.Sid_ExpDate AS ExpDate
				,SD.Sid_BatchNo AS BatchNo
				,SD.Sid_SalesRate AS Rate
				,SD.Sid_Total AS Total
				,SD.Sid_PurchaseQty AS Qty
				,MTM.Mtm_TypeName AS DrugType
				,MGM.Mgm_Name AS DrugGroup
				,MCM.Mcm_Name AS DrugCategory
				,MM.Mm_Code AS DrugCode
				,MM.Mm_HsnCode AS HsnCode
			FROM SalesInvoiceHeader(NOLOCK) AS SH
			LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
			LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
			LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
			--LEFT JOIN PacketSizeMater AS PSM
			--  ON PSM.Ps_ID = SD.Sid_PackId
			--LEFT JOIN  MedicinePacketSizeMaster   AS PSM
			--on  psm.Mps_Id=sd.Sid_PackId
			LEFT JOIN BranchMaster (NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
			WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					AND CONVERT(DATE, @Sih_DueDate, 105)
		END
	END;



	ELSE IF @SP_STATUS = 'Dpos_SalesDetailForReportWithFilter'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			 SELECT	Sh.Sih_Key,
            		CONVERT(DATE, SH.Sih_Date) AS BillDate,
            		SH.Sih_No AS BillNo,
            		PM.Pm_Fullname AS PartyName,
            		ISNULL(ITotalTax.CGST,0.00) AS CGST,
            		ISNULL(ITotalTax.SGST,0.00) AS SGST,
            		ISNULL(ITotalTax.IGST,0.00) AS IGST,
            		ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount,
            		ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
            		ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount,
            		SH.Sih_Total AS NetAmount,
            		BM.Branch_Name,
            		bm.Branch_GstNo,
            		MM.Mm_Name MedicinName,
            		UM.Uom_Name AS UOM,
            		'' AS PackSize,
            		SD.Sid_ExpDate AS ExpDate,
            		SD.Sid_BatchNo AS BatchNo,
            		ISNULL(ATXC.Tr_TxTot,0.00) AS ItemCGST,
            		ISNULL(ATXS.Tr_TxTot,0.00) AS ItemSGST,
            		ISNULL(ATXI.Tr_TxTot,0.00) AS ItemIGST,
            		SD.Sid_SalesRate AS Rate,
            		SD.Sid_Total AS Total,
            		SD.Sid_PurchaseQty AS Qty,
            		MTM.Mtm_TypeName AS DrugType,
            		MGM.Mgm_Name AS DrugGroup,
            		MCM.Mcm_Name AS DrugCategory,
            		MM.Mm_Code AS DrugCode,
            		MM.Mm_HsnCode AS HsnCode
            FROM	SalesInvoiceHeader(NOLOCK) AS SH
            		LEFT JOIN PatientMaster(NOLOCK) AS PM 
            ON		SH.Sih_Pm_Id = PM.Pm_Id
            		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD 
            ON		SH.Sih_Key = SD.Sid_Sih_Key
            		LEFT JOIN (SELECT	SID1.Sid_Sih_Key,
            							SUM(ISNULL(TXS.Tr_TxTot,0)) AS SGST,
            							SUM(ISNULL(TXC.Tr_TxTot,0)) AS CGST,
            							SUM(ISNULL(TXI.Tr_TxTot,0)) AS IGST
            					FROM	SalesInvoiceHeader(NOLOCK) SIH1
            							INNER JOIN SalesInvoiceItemDetail SID1
            					ON		SID1.Sid_Sih_Key=SIH1.Sih_Key
            							LEFT JOIN TaxTransaction(NOLOCK) TXS
            					ON		TXS.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXS.Tr_DdocKey=SID1.Sid_Key
            							AND TXS.Tr_TxId=2
            							AND TXS.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXC
            					ON		TXC.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXC.Tr_DdocKey=SID1.Sid_Key
            							AND TXC.Tr_TxId=3
            							AND TXC.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXI
            					ON		TXI.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXI.Tr_DdocKey=SID1.Sid_Key
            							AND TXI.Tr_TxId=4
            							AND TXI.Tr_DocTyp=2
            					GROUP BY Sid_Sih_Key )AS ITotalTax
            ON		ITotalTax.Sid_Sih_Key=SH.Sih_Key
            		LEFT JOIN TaxTransaction(NOLOCK) ATXS
            ON		ATXS.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXS.Tr_DdocKey=SD.Sid_Key
            		AND ATXS.Tr_TxId=2
            		AND ATXS.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXC
            ON		ATXC.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXC.Tr_DdocKey=SD.Sid_Key
            		AND ATXC.Tr_TxId=3
            		AND ATXC.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXI
            ON		ATXI.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXI.Tr_DdocKey=SD.Sid_Key
            		AND ATXI.Tr_TxId=4
            		AND ATXI.Tr_DocTyp=2
            		LEFT JOIN MedicineMaster(NOLOCK) AS MM 
            ON		SD.Sid_Mm_Id = MM.Mm_ID
            		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM 
            ON		MTM.Mtm_ID = MM.Mm_MtmId
            		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM 
            ON		MGM.Mgm_ID = MM.Mm_MgmId
            		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM 
            ON		MCM.Mcm_ID = MM.Mm_McmId
            		LEFT JOIN UomMaster(NOLOCK) AS UM 
            ON		SD.Sid_PurchaseUomId = UM.Uom_ID
            		LEFT JOIN BranchMaster BM 
            ON		SH.Sih_BranchId = BM.Branch_Id
		WHERE		CAST(SH.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
					AND CAST(@Sih_DueDate AS DATE)
					AND MM.Mm_MtmId = @Sid_Mm_Id
					ORDER BY SH.Sih_Key ASC
		
		END
		ELSE
		BEGIN
			 SELECT	Sh.Sih_Key,
            		CONVERT(DATE, SH.Sih_Date) AS BillDate,
            		SH.Sih_No AS BillNo,
            		PM.Pm_Fullname AS PartyName,
            		ISNULL(ITotalTax.CGST,0.00) AS CGST,
            		ISNULL(ITotalTax.SGST,0.00) AS SGST,
            		ISNULL(ITotalTax.IGST,0.00) AS IGST,
            		ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount,
            		ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
            		ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount,
            		SH.Sih_Total AS NetAmount,
            		BM.Branch_Name,
            		bm.Branch_GstNo,
            		MM.Mm_Name MedicinName,
            		UM.Uom_Name AS UOM,
            		'' AS PackSize,
            		SD.Sid_ExpDate AS ExpDate,
            		SD.Sid_BatchNo AS BatchNo,
            		ISNULL(ATXC.Tr_TxTot,0.00) AS ItemCGST,
            		ISNULL(ATXS.Tr_TxTot,0.00) AS ItemSGST,
            		ISNULL(ATXI.Tr_TxTot,0.00) AS ItemIGST,
            		SD.Sid_SalesRate AS Rate,
            		SD.Sid_Total AS Total,
            		SD.Sid_PurchaseQty AS Qty,
            		MTM.Mtm_TypeName AS DrugType,
            		MGM.Mgm_Name AS DrugGroup,
            		MCM.Mcm_Name AS DrugCategory,
            		MM.Mm_Code AS DrugCode,
            		MM.Mm_HsnCode AS HsnCode
            FROM	SalesInvoiceHeader(NOLOCK) AS SH
            		LEFT JOIN PatientMaster(NOLOCK) AS PM 
            ON		SH.Sih_Pm_Id = PM.Pm_Id
            		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD 
            ON		SH.Sih_Key = SD.Sid_Sih_Key
            		LEFT JOIN (SELECT	SID1.Sid_Sih_Key,
            							SUM(ISNULL(TXS.Tr_TxTot,0)) AS SGST,
            							SUM(ISNULL(TXC.Tr_TxTot,0)) AS CGST,
            							SUM(ISNULL(TXI.Tr_TxTot,0)) AS IGST
            					FROM	SalesInvoiceHeader(NOLOCK) SIH1
            							INNER JOIN SalesInvoiceItemDetail SID1
            					ON		SID1.Sid_Sih_Key=SIH1.Sih_Key
            							LEFT JOIN TaxTransaction(NOLOCK) TXS
            					ON		TXS.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXS.Tr_DdocKey=SID1.Sid_Key
            							AND TXS.Tr_TxId=2
            							AND TXS.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXC
            					ON		TXC.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXC.Tr_DdocKey=SID1.Sid_Key
            							AND TXC.Tr_TxId=3
            							AND TXC.Tr_DocTyp=2
            							LEFT JOIN TaxTransaction(NOLOCK) TXI
            					ON		TXI.Tr_DocKey=SID1.Sid_Sih_Key
            							AND TXI.Tr_DdocKey=SID1.Sid_Key
            							AND TXI.Tr_TxId=4
            							AND TXI.Tr_DocTyp=2
            					GROUP BY Sid_Sih_Key )AS ITotalTax
            ON		ITotalTax.Sid_Sih_Key=SH.Sih_Key
            		LEFT JOIN TaxTransaction(NOLOCK) ATXS
            ON		ATXS.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXS.Tr_DdocKey=SD.Sid_Key
            		AND ATXS.Tr_TxId=2
            		AND ATXS.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXC
            ON		ATXC.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXC.Tr_DdocKey=SD.Sid_Key
            		AND ATXC.Tr_TxId=3
            		AND ATXC.Tr_DocTyp=2
            		LEFT JOIN TaxTransaction(NOLOCK) ATXI
            ON		ATXI.Tr_DocKey=SD.Sid_Sih_Key
            		AND ATXI.Tr_DdocKey=SD.Sid_Key
            		AND ATXI.Tr_TxId=4
            		AND ATXI.Tr_DocTyp=2
            		LEFT JOIN MedicineMaster(NOLOCK) AS MM 
            ON		SD.Sid_Mm_Id = MM.Mm_ID
            		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM 
            ON		MTM.Mtm_ID = MM.Mm_MtmId
            		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM 
            ON		MGM.Mgm_ID = MM.Mm_MgmId
            		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM 
            ON		MCM.Mcm_ID = MM.Mm_McmId
            		LEFT JOIN UomMaster(NOLOCK) AS UM 
            ON		SD.Sid_PurchaseUomId = UM.Uom_ID
            		LEFT JOIN BranchMaster BM 
            ON		SH.Sih_BranchId = BM.Branch_Id
		WHERE		CAST(SH.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
					AND CAST(@Sih_DueDate AS DATE)
					ORDER BY SH.Sih_Key ASC
		END
	END;

	ELSE IF @SP_STATUS = 'DashboardNotification'
	BEGIN
		SELECT (
				SELECT CONVERT(INT, ISNULL(SUM(Sih_Total), 0))
				FROM SalesInvoiceHeader(NOLOCK) SH
				WHERE CONVERT(DATE, SH.Sih_Date, 105) = CONVERT(DATE, GETDATE())
				) AS DAYSALES
			,(
				SELECT CONVERT(INT, ISNULL(SUM(Sih_Total), 0))
				FROM SalesInvoiceHeader(NOLOCK) SH
				WHERE MONTH(CONVERT(DATE, SH.Sih_Date, 105)) = MONTH(CONVERT(DATE, GETDATE()))
				) AS MonthSALES
			,(
				SELECT COUNT(*)
				FROM (
					SELECT mm.Mm_Code
						,ISNULL(SUM(dbo.vwStock.Item_Stock), 0) AS Stock
					FROM dbo.MedicineMaster(NOLOCK) mm
					LEFT JOIN dbo.vwStock(NOLOCK) ON mm.Mm_ID = dbo.vwStock.Item_Id
					WHERE Mm_IsActive = 1
					GROUP BY mm.Mm_Code
					) AS OutStock
				WHERE Stock = 0
				) AS OutStockCount
			,(
				SELECT COUNT(*)
				FROM vwStockBatchWise(NOLOCK)
				WHERE (
						CONVERT(DATE, Stk_ExpDate) <= CONVERT(DATE, DATEADD(MONTH, 6, GETDATE()))
						AND CONVERT(DATE, Stk_ExpDate) >= CONVERT(DATE, GETDATE())
						)
					AND ISNULL(QTY, 0) > 0
				) AS NearByExpiry
	END;
	ELSE IF @SP_STATUS = 'MonthlySalesNotification'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_SalesQty AS Qty
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_SalesUomId = UM.Uom_ID
		--LEFT JOIN PacketSizeMater AS PSM
		--  ON PSM.Ps_ID = SD.Sid_PackId
		--LEFT JOIN  MedicinePacketSizeMaster   AS PSM
		--on  psm.Mps_Id=sd.Sid_PackId
		LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
		WHERE MONTH(CONVERT(DATE, SH.Sih_Date, 105)) = MONTH(GETDATE())
	END;
	ELSE IF @SP_STATUS = 'SP_RPT_StockAndSalesReport'
	BEGIN
		IF (@Sid_Mm_Id != 0)
		BEGIN
			SELECT ISNULL(MTM.Mtm_TypeName, '') AS DRUGTYPENAME
				,ISNULL(MCM.Mcm_Name, '') AS DRUGCATEGORY
				,ISNULL(MGM.Mgm_Name, '') AS DRUGGROUP
				,MM.Mm_Code AS DRUGCODE
				,MM.Mm_Name AS DRUGNAME
				,MM.Mm_HsnCode AS HSNCODE
				,ISNULL(STOCK.PURCHASEUNIT, PPUOM.Uom_Name) AS PURCHASEUNIT
				,MM.MM_PackSize AS PACKSIZE
				,ISNULL((
						SELECT (
								SUM(CASE 
										WHEN Stk_Tran_Typ = 'C'
											THEN Stk_PurchaseQty
										ELSE 0
										END) - SUM(CASE 
										WHEN Stk_Tran_Typ = 'D'
											THEN Stk_PurchaseQty
										ELSE 0
										END)
								)
						FROM StockRegister (NOLOCK)
						WHERE CONVERT(DATE, StockRegister.Stk_Date, 105) < CONVERT(DATE, @Sih_Date)
							AND StockRegister.Stk_MmId = STOCK.Stk_MmId
						GROUP BY StockRegister.Stk_MmId
						), 0) AS OPENINGSTOCK
				,ISNULL(STOCK.PUSALESQTY, 0) AS SALESQTY
				,ISNULL(STOCK.PUPURCHASEQTY, 0) AS PURCHASEQTY
				,ISNULL((OPENINGSTOCK.PPUPURCHASEQTY - OPENINGSTOCK.PPUSALESQTY), 0) AS CURRENTSTOCK
				,ISNULL(MM.Mm_MRP, 0) AS MRP
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_DATE
									FROM StockRegister (NOLOCK)
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN ''
							ELSE CONVERT(VARCHAR, (
										SELECT TOP 1 Stk_DATE
										FROM StockRegister (NOLOCK)
										WHERE Stk_MmId = MM.Mm_ID
											AND Stk_Tran_Typ = 'C'
											AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
												AND CONVERT(DATE, @Sih_DueDate)
										ORDER BY Stk_Date DESC
										), 105)
							END
						), '') AS LASTSTOCKRECEIVEDATE
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister (NOLOCK)
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN 0
							ELSE (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister (NOLOCK)
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									)
							END
						), 0) AS LASTSTOCKRECEIVEQTY
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM MedicineMaster(NOLOCK) MM
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = 1
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS STOCK ON STOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) <= CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS OPENINGSTOCK ON OPENINGSTOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN UomMaster(NOLOCK) PPUOM ON PPUOM.Uom_ID = MM.MM_PurchaseUom
			WHERE MM.Mm_MtmId = @Sid_Mm_Id
			ORDER BY MM.Mm_Name
				,MTM.Mtm_TypeName
				,MCM.Mcm_Name
				,MGM.Mgm_Name ASC
		END
		ELSE
		BEGIN
			SELECT ISNULL(MTM.Mtm_TypeName, '') AS DRUGTYPENAME
				,ISNULL(MCM.Mcm_Name, '') AS DRUGCATEGORY
				,ISNULL(MGM.Mgm_Name, '') AS DRUGGROUP
				,MM.Mm_Code AS DRUGCODE
				,MM.Mm_Name AS DRUGNAME
				,MM.Mm_HsnCode AS HSNCODE
				,ISNULL(STOCK.PURCHASEUNIT, PPUOM.Uom_Name) AS PURCHASEUNIT
				,MM.MM_PackSize AS PACKSIZE
				,ISNULL((
						SELECT (
								SUM(CASE 
										WHEN Stk_Tran_Typ = 'C'
											THEN Stk_PurchaseQty
										ELSE 0
										END) - SUM(CASE 
										WHEN Stk_Tran_Typ = 'D'
											THEN Stk_PurchaseQty
										ELSE 0
										END)
								)
						FROM StockRegister (NOLOCK)
						WHERE CONVERT(DATE, StockRegister.Stk_Date, 105) < CONVERT(DATE, @Sih_Date)
							AND StockRegister.Stk_MmId = STOCK.Stk_MmId
						GROUP BY StockRegister.Stk_MmId
						), 0) AS OPENINGSTOCK
				,ISNULL(STOCK.PUSALESQTY, 0) AS SALESQTY
				,ISNULL(STOCK.PUPURCHASEQTY, 0) AS PURCHASEQTY
				,ISNULL((OPENINGSTOCK.PPUPURCHASEQTY - OPENINGSTOCK.PPUSALESQTY), 0) AS CURRENTSTOCK
				,ISNULL(MM.Mm_MRP, 0) AS MRP
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_DATE
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN ''
							ELSE CONVERT(VARCHAR, (
										SELECT TOP 1 Stk_DATE
										FROM StockRegister
										WHERE Stk_MmId = MM.Mm_ID
											AND Stk_Tran_Typ = 'C'
											AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
												AND CONVERT(DATE, @Sih_DueDate)
										ORDER BY Stk_Date DESC
										), 105)
							END
						), '') AS LASTSTOCKRECEIVEDATE
				,ISNULL((
						CASE 
							WHEN (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									) = NULL
								THEN 0
							ELSE (
									SELECT TOP 1 Stk_PurchaseQty
									FROM StockRegister
									WHERE Stk_MmId = MM.Mm_ID
										AND Stk_Tran_Typ = 'C'
										AND CONVERT(DATE, Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
											AND CONVERT(DATE, @Sih_DueDate)
									ORDER BY Stk_Date DESC
									)
							END
						), 0) AS LASTSTOCKRECEIVEQTY
				,BM.Branch_Name
				,ISNULL(BM.Branch_Address1, '') + ' ' + ISNULL(BM.Branch_Address2, '') + ' ' + ISNULL(BM.Branch_Address3, '') AS Branch_Address
				,BM.Branch_GstNo
			FROM MedicineMaster(NOLOCK) MM
			LEFT JOIN BranchMaster(NOLOCK) BM ON BM.Branch_Id = 1
			LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
			LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
			LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) BETWEEN CONVERT(DATE, @Sih_Date)
						AND CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS STOCK ON STOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN (
				SELECT SR.Stk_MmId
					,SUM(CASE 
							WHEN SR.Stk_Tran_Typ = 'D'
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUSALESQTY
					,SUM(CASE 
							WHEN (SR.Stk_Tran_Typ = 'C')
								THEN SR.Stk_PurchaseQty
							ELSE 0
							END) AS PPUPURCHASEQTY
					,PUOM.Uom_Name AS PURCHASEUNIT
				FROM StockRegister(NOLOCK) SR
				INNER JOIN UomMaster(NOLOCK) PUOM ON PUOM.Uom_ID = SR.Stk_PurchaseUom
				WHERE CONVERT(DATE, SR.Stk_Date) <= CONVERT(DATE, @Sih_DueDate)
				GROUP BY SR.Stk_MmId
					,PUOM.Uom_Name
				) AS OPENINGSTOCK ON OPENINGSTOCK.Stk_MmId = MM.Mm_ID
			LEFT JOIN UomMaster(NOLOCK) PPUOM ON PPUOM.Uom_ID = MM.MM_PurchaseUom
			ORDER BY MM.Mm_Name
				,MTM.Mtm_TypeName
				,MCM.Mcm_Name
				,MGM.Mgm_Name ASC
		END
	END;
	ELSE IF @SP_STATUS = 'GET_SI_NO'
	BEGIN
		SELECT SIH.Sih_No
		FROM SalesInvoiceHeader(NOLOCK) SIH
		WHERE SIH.Sih_Key = @Sih_Key
	END
	ELSE IF @SP_STATUS = 'GetStoreInfo'
	BEGIN
		SELECT TOP 1 Store_Name AS Branch_Name
			,Store_Address1 AS Branch_Address
			,Store_GstNo AS Branch_GstNo
			,Store_DrugLice AS Branch_DrugLice
			,Store_MobNo AS Branch_MobNo
			,Store_Email AS Branch_Email
			,C.City_Name AS Store_City,
			S.Store_PhNo  as   Phoneno1 ,
			S.Store_PhNo1 as  Phoneno2
		FROM StoreMaster (NOLOCK) S
		INNER JOIN CityMaster  (NOLOCK) C ON C.City_ID = Store_CityId
	END
	ELSE IF @SP_STATUS = 'GetOverDueBills'
	BEGIN
		SELECT Sh.Sih_Key
			,CONVERT(DATE, SH.Sih_Date) AS BillDate
			,SH.Sih_No AS BillNo
			,PM.Pm_Fullname AS PartyName
			,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
			,ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount
			,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
			,SH.Sih_Total AS NetAmount
			,BM.Branch_Name
			,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
			,bm.Branch_GstNo
			,MM.Mm_Name MedicinName
			,UM.Uom_Name AS UOM
			,'' AS PackSize
			,SD.Sid_ExpDate AS ExpDate
			,SD.Sid_BatchNo AS BatchNo
			,SD.Sid_SalesRate AS Rate
			,SD.Sid_Total AS Total
			,SD.Sid_PurchaseQty AS Qty
			,MTM.Mtm_TypeName AS DrugType
			,MGM.Mgm_Name AS DrugGroup
			,MCM.Mcm_Name AS DrugCategory
			,MM.Mm_Code AS DrugCode
			,MM.Mm_HsnCode AS HsnCode
			,sh.Sih_DueDate AS DueDate
		FROM SalesInvoiceHeader(NOLOCK) AS SH
		LEFT JOIN PatientMaster(NOLOCK) AS PM ON SH.Sih_Pm_Id = PM.Pm_Id
		LEFT JOIN SalesInvoiceItemDetail(NOLOCK) AS SD ON SH.Sih_Key = SD.Sid_Sih_Key
		LEFT JOIN MedicineMaster(NOLOCK) AS MM ON SD.Sid_Mm_Id = MM.Mm_ID
		LEFT JOIN MedicineTypeMaster(NOLOCK) MTM ON MTM.Mtm_ID = MM.Mm_MtmId
		LEFT JOIN MedicineGroupMaster(NOLOCK) MGM ON MGM.Mgm_ID = MM.Mm_MgmId
		LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM ON MCM.Mcm_ID = MM.Mm_McmId
		LEFT JOIN UomMaster(NOLOCK) AS UM ON SD.Sid_PurchaseUomId = UM.Uom_ID
		LEFT JOIN BranchMaster (NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
		LEFT JOIN AccountTransaction  (NOLOCK) at ON at.Act_DocNo = SH.Sih_No
		WHERE ISNULL(at.Act_Amount, 0) > ISNULL(at.Act_PaidAmount, 0) + ISNULL(at.Act_AdjustAmount, 0)
			AND at.Act_DocType = 2
			AND at.Act_SrNo = 1
			AND CONVERT(DATE, sh.Sih_DueDate) < CONVERT(DATE, GETDATE())
	END
	ELSE IF @SP_STATUS = 'SYNCH_UPDATE'-----Update Synch Status ---Add Hasmukh
	BEGIN
	     UPDATE SalesInvoiceHeader
		    SET Sih_IsSync='true',	
			    Sih_LastSyncDate=GETDATE()
		  WHERE @Sih_Key=@Sih_Key
		  SELECT @ID=@Sih_Key;
	END
	ELSE IF @SP_STATUS = 'Get_Report_Format'
	BEGIN
		Select * from ReportsConfig (NOLOCK)
		WHERe IsActive=1 and DocType=@DocType
	END
	ELSE IF @SP_STATUS = 'Bind_Combo_ReportsConfig'
	BEGIN
		SELECT	0 AS ID,  '--Select--' AS NAME
		UNION
		Select  id as  ID , ReportSize  AS NAME
		from	ReportsConfig (nolock)
	END
	ELSE  IF @SP_STATUS = 'Update_ReportConfig'
		BEGIN
			UPDATE	ReportsConfig  
			SET		IsActive=0

			UPDATE	ReportsConfig  
			SET		DirectPrint=@DirectPrint,
					IsActive=@IsActive
			WHERE	id= @Reportid
		END

	ELSE  IF  @SP_STATUS =   'FILL_SO_ITEMDETAIL'
		BEGIN
				declare	@FormPrefix_So  nvarchar(max) 
				select  @FormPrefix_So  = FormPrefix  
				from	FormDetailTable (nolock)
				where	Id= 1

				SELECT	sod.Pi_PoKey,  
						@FormPrefix_So + cast(so.Po_No as nvarchar(max)) as Po_No,
						mm.Mm_Code,
						mm.MM_PackSize,
						mm.Mm_HsnCode,
						mm.Mm_MRP,
						mm.Mm_MktRate,
						sod.Pi_ItemId,
						sod.Pi_ItemName,--sod.Pi_Qty,
						--ISNULL(sod.Pi_Qty,0) - (ISNULL(SOD.Pi_Scd_SalesQty,0)+ISNULL(SOD.Pi_Sid_Qty,0)) AS Pi_Qty,
						ISNULL(sod.Pi_Qty,0) AS Pi_Qty,
						sod.Pi_Rate,
						um.Uom_Name, 
						sod.Pi_Uom,
						sod.Pi_SrNo,
						ISNULL(sod.Pi_Qty,0) - (ISNULL(SOD.Pi_Scd_SalesQty,0)+ISNULL(SOD.Pi_Sid_Qty,0)) AS Pi_BalQty
						--VW.MM_PurchaseRatio, VW.MM_SalesRatio,  VW.Item_Stock
				FROM	SO_HEADER (NOLOCK) so
						LEFT JOIN   SO_DETAIL (NOLOCK) sod
				ON			so.Po_Key = sod.Pi_PoKey
						LEFT JOIN MedicineMaster (NOLOCK) mm
				ON			mm.Mm_ID =   sod.Pi_ItemId
						LEFT  JOIN  UomMaster  (NOLOCK) um
				ON			um.Uom_ID =   sod.Pi_Uom
				--    LEFT   JOIN  vwStock (NOLOCK) VW
				--ON       VW.Item_Id   = sod.Pi_ItemId
				WHERE 		so.Po_Key =@Sih_Key   
						--AND ISNULL(sod.Pi_Qty,0) - ISNULL(SOD.Pi_PiQty,0) > 0
						AND ISNULL(sod.Pi_Qty,0) - (ISNULL(SOD.Pi_Scd_SalesQty,0)+ISNULL(SOD.Pi_Sid_Qty,0)) > 0
						AND	so.Po_VenId= @Sih_Pm_Id
		END

	ELSE IF  @SP_STATUS = 'CHECK_BATCH_NO_AVAL'
		BEGIN
	   		SELECT  COUNT(*) as countof 
			FROM	dbo.vwStock(NOLOCK)
			WHERE  
					vwStock.Item_Batchno = cast(@Sid_BatchNo as  nvarchar(max)) and  vwStock.Item_Id =  @Sid_Mm_Id and
					Item_Stock > 0
		END 

	ELSE  IF  @SP_STATUS = 'GET_MFG_EXP_DATE_WITH_BATCHNO'
	BEGIN
		SELECT	vwStock.Item_Batchno, 
				vwStock.Stk_ExpDate,  vwStock.Item_MnfDate,vwStock.Item_Stock AS OldStock, vwStock.Stk_LmId ,Lm_Name as  Location , Item_Stock,  MM_PurchaseRatio,  MM_SalesRatio
				,Item_MRP AS  MM_MRP,vwStock.Item_Rate
		FROM	dbo.vwStock(NOLOCK)
		WHERE 
				vwStock.Item_Batchno = cast(@Sid_BatchNo as  nvarchar(max)) and  vwStock.Item_Id =  @Sid_Mm_Id and
				Item_Stock > 0
	END
	ELSE  IF  @SP_STATUS = 'Report_SalesBill_Profit'
	BEGIN
		SELECT	C.Sih_No,
          		C.Sih_Date,
          		F.Pm_FullName,
          		SUM(A.Sid_SalesQty)AS Qty,
          		C.Sih_SubTotal,
          		C.Sih_Total,
          		SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0))) AS ProfitAmount,
          		(SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0)))*100/SUM(A.Sid_SalesRate*A.Sid_PurchaseQty)) AS ProfitPer
         FROM		SalesInvoiceItemDetail A
          		LEFT JOIN( SELECT	SR.Stk_BatchNo,
                  					SR.Stk_MmId,
                  					MAX(SR.Stk_PurchaseRate)AS PurchaseRate,
                  					MAX(SR.Stk_Mrp)AS Mrp
                  			FROM	StockRegister SR
                  			WHERE	SR.Stk_Tran_Typ='C'
                  					GROUP	BY	SR.Stk_BatchNo,
                  								SR.Stk_MmId	
          				)B
          ON			A.Sid_Mm_Id=B.Stk_MmId
          		AND A.Sid_BatchNo=B.Stk_BatchNo
          		iNNER JOIN SalesInvoiceHeader C
          ON			A.Sid_Sih_Key=C.Sih_Key
          		iNNER jOIN MedicineMaster D
          ON			A.Sid_Mm_Id=D.Mm_ID
          		iNNER jOIN UomMaster E
          ON			E.Uom_ID=A.Sid_SalesUomId
          		iNNER jOIN PatientMaster F
          ON		F.Pm_Id=C.Sih_Pm_Id
		  WHERE CAST(C.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE) AND CAST(@Sih_DueDate AS DATE) 
          		GROUP BY	C.Sih_No,
          					C.Sih_Date,
          					F.Pm_FullName,
          					C.Sih_SubTotal,
          					C.Sih_Total
      					

   --     SELECT SIH.Sih_No AS BillNo,
   --            SIH.Sih_Date AS BillDate,
   --     	   PM.Pm_Fullname AS PartyName,
   --     	   SIH.Sih_Total AS TotalAmount,
   --     	   Profit
   --       FROM SalesInvoiceHeader SIH
   --            INNER JOIN (SELECT SUM(SID1.Sid_PurchaseQty*(SID1.Sid_SalesRate-SID1.Sid_PurchaseRate))AS Profit,
   --     	                      SIH1.Sih_key
   --     	                 FROM SalesInvoiceHeader  (NOLOCK)SIH1
   --     					      INNER JOIN SalesInvoiceItemDetail (NOLOCK) SID1
   --     					   ON SID1.Sid_Sih_Key=SIH1.Sih_Key 
   --     					      GROUP BY SIH1.Sih_key)AS DT
   --     	ON DT.Sih_key=SIH.Sih_key
   --     	   INNER JOIN PatientMaster  (NOLOCK) PM
   --         ON PM.Pm_Id=SIH.Sih_Pm_Id
		 --WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
			--		AND CONVERT(DATE, @Sih_DueDate, 105) 
   --     	   ORDER BY SIH.Sih_Key
	END
	ELSE  IF  @SP_STATUS = 'Report_Product_Profit'
	BEGIN
          SELECT	D.Mm_Code,
     				D.Mm_Name,
     				E.Uom_Name,
     				SUM(A.Sid_SalesQty)AS Qty,
     				SUM(A.Sid_PurchaseQty*A.Sid_SalesRate)AS SubTotal,
     				SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0))) AS ProfitAmount,
     				(SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0)))*100/SUM(A.Sid_SalesRate*A.Sid_PurchaseQty)) AS ProfitPer
            FROM	SalesInvoiceItemDetail A
            		LEFT JOIN( SELECT	SR.Stk_BatchNo,
                    					SR.Stk_MmId,
                    					MAX(SR.Stk_PurchaseRate)AS PurchaseRate,
                    					MAX(SR.Stk_Mrp)AS Mrp
                    			FROM	StockRegister SR
                    			WHERE	SR.Stk_Tran_Typ='C'
                    					GROUP	BY	SR.Stk_BatchNo,
                    								SR.Stk_MmId	
            				)B
            ON			A.Sid_Mm_Id=B.Stk_MmId
            		AND A.Sid_BatchNo=B.Stk_BatchNo
            		iNNER JOIN SalesInvoiceHeader C
            ON			A.Sid_Sih_Key=C.Sih_Key
            		iNNER jOIN MedicineMaster D
            ON			A.Sid_Mm_Id=D.Mm_ID
            		iNNER jOIN UomMaster E
            ON			E.Uom_ID=A.Sid_SalesUomId
		 WHERE		CAST(C.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
						AND CAST(@Sih_DueDate AS DATE) 
            GROUP BY	D.Mm_Code,
            			D.Mm_Name,
            			E.Uom_Name

	END
	ELSE  IF  @SP_STATUS = 'Report_PartyWise_Profit'
	BEGIN
             SELECT	F.Pm_FullName,
        		COUNT(distinct C.Sih_Key)AS Count1,
        		SUM(ISNULL(A.Sid_PurchaseQty,0)*ISNULL(A.Sid_SalesRate,0))AS SubTotal,
        		SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0))) AS ProfitAmount,
        		(SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0)))*100/SUM(A.Sid_SalesRate*A.Sid_PurchaseQty)) AS ProfitPer
        FROM	SalesInvoiceItemDetail A
        		LEFT JOIN( SELECT	SR.Stk_BatchNo,
                					SR.Stk_MmId,
                					MAX(SR.Stk_PurchaseRate)AS PurchaseRate,
                					MAX(SR.Stk_Mrp)AS Mrp
                			FROM	StockRegister SR
                			WHERE	SR.Stk_Tran_Typ='C'
                					GROUP	BY	SR.Stk_BatchNo,
                								SR.Stk_MmId	
        				)B
        ON			A.Sid_Mm_Id=B.Stk_MmId
        		AND A.Sid_BatchNo=B.Stk_BatchNo
        		iNNER JOIN SalesInvoiceHeader C
        ON			A.Sid_Sih_Key=C.Sih_Key
        		iNNER jOIN MedicineMaster D
        ON			A.Sid_Mm_Id=D.Mm_ID
        		iNNER jOIN UomMaster E
        ON			E.Uom_ID=A.Sid_SalesUomId
        		iNNER jOIN PatientMaster F
        ON		F.Pm_Id=C.Sih_Pm_Id
		WHERE	CAST(C.Sih_Date AS DATE) BETWEEN CAST(@Sih_Date AS DATE)
					AND CAST(@Sih_DueDate AS DATE)
		GROUP BY	F.Pm_FullName
					

     -- SELECT DT1.PartyName,
     --        SUM(DT1.TotalAmount)AS TotalAmount,
     --  	     SUM(DT1.Profit)AS Profit
     --   FROM
     --        (SELECT SIH.Sih_No AS BillNo,
     --                SIH.Sih_Date AS BillDate,
     --  	          PM.Pm_Fullname AS PartyName,
     --  	          SIH.Sih_Total AS TotalAmount,
     --  	          Profit
     --           FROM SalesInvoiceHeader (NOLOCK) SIH
     --                INNER JOIN (SELECT SUM(SID1.Sid_PurchaseQty*(SID1.Sid_SalesRate-STKRate.Sid_PurchaseRate))AS Profit,
     --                                 SIH1.Sih_key
     --                            FROM SalesInvoiceHeader  (NOLOCK)SIH1
     --           				      INNER JOIN SalesInvoiceItemDetail  (NOLOCK)SID1
     --           				   ON SID1.Sid_Sih_Key=SIH1.Sih_Key 
					--					INNER JOIN (SELECT (SELECT TOP 1 Stk_PurchaseRate FROM StockRegister (NOLOCK) WHERE Stk_BatchNo=SID2.Sid_BatchNo AND Stk_MmId=SID2.Sid_Mm_Id AND Stk_Tran_Typ='C' ORDER BY Stk_ID DESC)AS Sid_PurchaseRate,Sid_Mm_Id,Sid_BatchNo FROM SalesInvoiceItemDetail (NOLOCK) SID2)AS STKRate
					--				ON	STKRate.Sid_BatchNo=SID1.Sid_BatchNo
					--					AND STKRate.Sid_Mm_Id=SID1.Sid_Mm_Id
     --           				      GROUP BY SIH1.Sih_key)AS DT
     --           ON DT.Sih_key=SIH.Sih_key
     --              INNER JOIN PatientMaster (NOLOCK) PM
     --           ON PM.Pm_Id=SIH.Sih_Pm_Id
		   --  WHERE CONVERT(DATE, SIH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					--AND CONVERT(DATE, @Sih_DueDate, 105))AS DT1 
     --  		   GROUP BY DT1.PartyName
	END
	ELSE  IF  @SP_STATUS = 'Report_Bill_Product_Profit'
		BEGIN
		   SELECT	D.Mm_Code,
     					D.Mm_Name,
     					E.Uom_Name,
     					SUM(A.Sid_SalesQty)AS Qty,
     					SUM(A.Sid_PurchaseQty*A.Sid_SalesRate)AS SubTotal,
     					SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0))) AS ProfitAmount,
     					(SUM(A.Sid_PurchaseQty*(ISNULL(A.Sid_SalesRate,0)-ISNULL(B.PurchaseRate,0)))*100/SUM(A.Sid_SalesRate*A.Sid_PurchaseQty)) AS ProfitPer
				FROM	SalesInvoiceItemDetail A
            			LEFT JOIN( SELECT	SR.Stk_BatchNo,
                    						SR.Stk_MmId,
                    						MAX(SR.Stk_PurchaseRate)AS PurchaseRate,
                    						MAX(SR.Stk_Mrp)AS Mrp
                    				FROM	StockRegister SR
                    				WHERE	SR.Stk_Tran_Typ='C'
                    						GROUP	BY	SR.Stk_BatchNo,
                    									SR.Stk_MmId	
            					)B
				ON			A.Sid_Mm_Id=B.Stk_MmId
            			AND A.Sid_BatchNo=B.Stk_BatchNo
            			iNNER JOIN SalesInvoiceHeader C
				ON			A.Sid_Sih_Key=C.Sih_Key
            			iNNER jOIN MedicineMaster D
				ON			A.Sid_Mm_Id=D.Mm_ID
            			iNNER jOIN UomMaster E
				ON			E.Uom_ID=A.Sid_SalesUomId
			 WHERE			Sih_Key=@Sih_Key
				GROUP BY	D.Mm_Code,
            				D.Mm_Name,
            				E.Uom_Name
			 
		END
	ELSE  IF  @SP_STATUS =   'FILL_CHALLAN_ITEM'
	    BEGIN
			SELECT	Scd_Key,Scd_Sch_Key  as Pi_PoKey ,Scd_SrNo,Scd_Mm_Id  as Pi_ItemId ,
					Scd_SalesUomId as Pi_Uom,
					Scd_PurchaseUomId,Scd_LmId,
					mm.Mm_Code, 
					mm.Mm_Name as Pi_ItemName, 
					mm.MM_PackSize,
					mm.Mm_HsnCode,
					mm.Mm_MktRate, 
					um.Uom_Name, 
					Scd_SalesQty as  Pi_Qty ,
					Scd_SalesRate as  Pi_Rate, 
					Scd_MRP as  Mm_MRP,
					Scd_BatchNo ,
					Scd_ExpDate,  
					Scd_MnfDate,
					mm.MM_PurchaseRatio,
					mm.MM_SalesRatio,
					ISNULL(stock.Item_Stock,0) As Item_Stock
			from	SalesChallanHeader   (NOLOCK)   CHLHEADER
					LEFT JOIN  SalesChallenItemDetails  (NOLOCK) CHLDEATAIL
			ON			CHLHEADER. Sc_Key=   CHLDEATAIL.Scd_Sch_Key
					LEFT JOIN MedicineMaster (NOLOCK) mm
			ON			mm.Mm_ID =   CHLDEATAIL.Scd_Mm_Id
					LEFT JOIN  UomMaster  (NOLOCK) um
			ON			um.Uom_ID =   CHLDEATAIL.Scd_SalesUomId
					LEFT JOIN vwStock stock
			ON			CHLDEATAIL.Scd_Mm_Id=stock.Item_Id
					AND CHLDEATAIL.Scd_BatchNo=stock.Item_Batchno
			WHERE		CHLDEATAIL.Scd_Sch_Key =@Sih_Key    --AND  ISNULL(sod.Pi_Qty,0) - ISNULL(SOD.Pi_PiQty,0) > 0
					and	CHLHEADER.Sc_Pm_Id= @Sih_Pm_Id
	  END
	 ELSE  IF  @SP_STATUS =   'PartyWiseSalesReport'
	    BEGIN
			SELECT 
					DISTINCT Sh.Sih_Key
					,CONVERT(DATE, SH.Sih_Date) AS BillDate
					,SH.Sih_No AS BillNo
					,PM.Pm_Fullname AS PartyName
					,pm.StoreCode as Store_Code
					,ISNULL(SH.Sih_SubTotal, 0.00) AS GrossAmount
					
				--ISNULL(SH.Sih_Total, 0.00) - ISNULL(SH.Sih_SubTotal, 0.00) AS TaxAmount,
					,ISNULL(BB.SGST, 0.00) + ISNULL(BB.CGST, 0.00) + ISNULL(BB.IGST, 0.00) AS TaxAmount
					,ISNULL(SH.Sih_DiscAmount, 0.00) AS Discount
					,SH.Sih_Total AS NetAmount
					,BM.Branch_Name
					,Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address
					,bm.Branch_GstNo
					,ISNULL(BB.SGST, 0) AS SGST
					,ISNULL(BB.CGST, 0) AS CGST
					,ISNULL(BB.IGST, 0) AS IGST
			FROM	SalesInvoiceHeader(NOLOCK) AS SH
					LEFT JOIN PatientMaster(NOLOCK) AS PM 
			ON			SH.Sih_Pm_Id = PM.Pm_Id
					LEFT JOIN BranchMaster(NOLOCK) BM ON SH.Sih_BranchId = BM.Branch_Id
					LEFT JOIN (	SELECT	A.Sid_Sih_Key
										,ISNULL(SUM(A.SGST), 0) AS SGST
										,ISNULL(SUM(A.CGST), 0) AS CGST
										,ISNULL(SUM(A.IGST), 0) AS IGST
								FROM (	SELECT	A.Sid_Sih_Key
												,B.Tr_TxTot AS CGST
												,C.Tr_TxTot AS SGST
												,D.Tr_TxTot AS IGST
										FROM	SalesInvoiceItemDetail(NOLOCK) A
												INNER JOIN MedicineMaster(NOLOCK) MM 
										ON			MM.Mm_ID = A.Sid_Mm_Id
												LEFT JOIN TaxTransaction(NOLOCK) B 
										ON			A.Sid_Key = B.Tr_DdocKey
												AND A.Sid_Sih_Key = B.Tr_DocKey
												AND B.Tr_TxId = 2
												AND B.Tr_DocTyp = 2
												LEFT JOIN TaxTransaction(NOLOCK) C 
										ON			A.Sid_Key = C.Tr_DdocKey
												AND A.Sid_Sih_Key = C.Tr_DocKey
												AND C.Tr_DocTyp = 2
												AND C.Tr_TxId = 3
												LEFT JOIN TaxTransaction(NOLOCK) D 
										ON			A.Sid_Key = D.Tr_DdocKey
												AND A.Sid_Sih_Key = D.Tr_DocKey
												AND D.Tr_DocTyp = 2
												AND D.Tr_TxId = 4
									) AS A
					GROUP BY A.Sid_Sih_Key
				) AS BB ON SH.Sih_Key = BB.Sid_Sih_Key
			INNER JOIN SalesInvoiceItemDetail(NOLOCK) SIID ON SIID.Sid_Sih_Key = SH.Sih_Key
			INNER JOIN MedicineMaster(NOLOCK) MM ON MM.Mm_ID = SIID.Sid_Mm_Id
			WHERE CONVERT(DATE, SH.Sih_Date) BETWEEN CONVERT(DATE, @Sih_Date, 105)
					AND CONVERT(DATE, @Sih_DueDate, 105) AND StoreCode=@Sih_Remark;
		END

END;


GO
/****** Object:  StoredProcedure [dbo].[SP_SalesOrder]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_SalesOrder]
-----PO HEADER
@SP_STATUS varchar(200) = '',
@Po_Key numeric(18,0) = 0,
@PO_No numeric(18,0) = 0,
@PO_Date datetime = NULL,
@PO_RefNo nvarchar(50) = '',
@PO_RefDate datetime = NULL,
@PO_RevNo int = 0,
@PO_RevDate datetime = NULL,
@PO_Cate numeric(8,0) = 0,
@PO_Type1 varchar(50) = '',
@Po_Type2 varchar(50) = '',
@PO_IsCashPurchase bit = 0,
@Po_EnqMode int = 0,
@Po_QtNo nvarchar(15) = '',
@Po_IsAmmendment bit = 0,
@Po_VenId numeric(18,0) = 0,
@Po_VenAddId numeric(18,0) = 0,
@Po_Cur numeric(8,0) = 0,
@Po_ExchRate numeric(18,2) = 0,
@Po_BasicVal numeric(18,2) = 0,
@Po_Disc numeric(18,2) = 0,
@Po_Disc_Val numeric(18,2) = 0,
@Po_TotVal numeric(18,2) = 0,
@Po_Annexure varchar(max) = '',
@Po_CoverLetter varchar(max) = '',
@Po_DelDate datetime = NULL,
@Po_Remarks varchar(500) = '',
@Po_PaymentTerms nvarchar(max) = '',
@Po_CreditDays int = 0,
@Po_BmId bigint = 0,
@Po_AuthId int = 0,
@Po_AuthDate datetime = NULL,
@Po_YearId numeric(4,0) = 0,
@USER int = 0,
@PO_KEYS nvarchar(max) = '',
@DocType int=0,
-----PO DETAIL
@Pi_Key numeric(18,0) = 0,
@Pi_PoKey numeric(18,0) = 0,
@Pi_SrNo bigint = 0,
@Pi_IndKey numeric(18,0) = 0,
@Pi_InddKey numeric(18,0) = 0,
@Pi_IndSrNo bigint = 0,
@Pi_IndNo varchar(15) = '',
@Pi_ItemId numeric(18,0) = 0,
@Pi_ItemName nvarchar(500) = '',
@Pi_ItemCode varchar(50) = '',
@Po_POS_KEY numeric(18,0) = 0,

@Pi_Qty numeric(14,3) = 0,
@Pi_Rate numeric(14,2) = 0,
@Pi_Disc numeric(5,2) = 0,
@Pi_Disc_Val numeric(18,3) = 0,
@Pi_Uom numeric(8,0) = 0,
@Pi_Amt numeric(18,3) = 0,
@Pi_Net_Amt numeric(18,2) = 0,
@Pi_IcQty numeric(18,2) = 0,
@Pi_GrnQty numeric(18,2) = 0,
@Pi_Remarks varchar(max) = '',
@Pi_ShortCloseQty numeric(18,2) = 0,
@Po_Search_Text nvarchar(max) = NULL,
@Po_ApproveStatus varchar(250) = NULL,
@Po_ApproveStatusRemark nvarchar(500) = NULL,
@ID numeric(18,0) = 0 OUT
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	--=======================BIND FOR SO_HEADER===========
	IF @SP_STATUS = 'FillPoType1'                    --     'FILL_COMBO_PO_Type1'
	BEGIN
	SELECT	0 AS ID,'--Select--' AS NAME
	UNION
	SELECT	Po_Type1Key	AS ID, Po_Name		AS NAME
	FROM	PoValueTypeMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillPoType2'
	BEGIN
	SELECT	0 AS ID,'--Select--' AS NAME
	UNION
	SELECT	Ptm_Type2Key AS ID,
			Ptm_Name AS NAME
	FROM	PoTypeMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillGstType'
	BEGIN
	SELECT	Gtm_Id ,Gtm_Name
	FROM	dbo.GSTTypeMaster(NOLOCK)
	WHERE	Gtm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'FillInquiryMode'
	BEGIN
	SELECT	0 AS ID,'--Select--'	AS NAME
	UNION
	SELECT	Imm_Id	AS ID,Imm_Name	AS NAME
	FROM	InquiryModeMaster(NOLOCK);
	END;
	IF @SP_STATUS = 'UpdateApproval'
	BEGIN
	UPDATE	SO_HEADER
	SET		Po_ApproveStatus = @Po_ApproveStatus,
			Po_ApproveStatusRemark = @Po_ApproveStatusRemark
	WHERE	Po_Key = @Po_Key
	END;
	ELSE IF @SP_STATUS = 'FillCurrency'
	BEGIN
	SELECT	0					AS ID,
				'--select--'	AS NAME
	UNION
	SELECT	Cm_id		AS ID,
				Cm_Name	AS NAME
	FROM CurrencyMaster(NOLOCK);
	END;

	ELSE IF @SP_STATUS = 'BIND_HC_PURC_ORDER'
		BEGIN
			SELECT		Po_POS_KEY, Po_Store_Code, Po_No, Po_Date, Po_TotVal, Po_CreditDays, Po_PaymentTerms, Po_Remarks
			FROM		PoHeader_Store (NOLOCK) A
					INNER JOIN PatientMaster (NOLOCK) B
			ON			A.Po_Store_Code = B.StoreCode
			WHERE		ISNULL(Po_POS_KEY,0) > 0
					AND	Po_POS_KEY NOT IN (SELECT ISNULL(Po_POS_KEY,0) FROM SO_HEADER (NOLOCK))
					AND B.Pm_Id = @Po_VenId
		END

	ELSE IF @SP_STATUS = 'GET_PURC_STORE_DET'
		BEGIN
			--SELECT		* 
			--FROM		PoHeader_Store (NOLOCK)
			--WHERE		Po_POS_KEY = @Po_POS_KEY

			SELECT		Pi_Key, Pi_PoKey, Pi_SrNo ,Pi_ItemId ,Pi_ItemName ,Pi_Qty ,Pi_Rate ,Pi_Disc ,Pi_Disc_Val ,Pi_Amt ,Pi_Net_Amt ,Pi_Remarks ,PI_SO_QTY ,PI_Po_POS_KEY, MM.Mm_Code,
						MM.MM_PurchaseUom, UM.Uom_Code, MM.MM_ManufactureBy, MM.MM_MarketingBy, MM.Mm_MaxLevel, MM.Mm_MinLevel, POHS.Po_No
			FROM		PoItemDetails_Store (NOLOCK) POS
					LEFT JOIN PoHeader_Store (NOLOCK) POHS
			ON			POS.PI_Po_POS_KEY = POHS.Po_POS_KEY
					INNER JOIN MedicineMaster (NOLOCK) MM
			ON			POS.Pi_ItemId = MM.Mm_ID
					INNER JOIN UomMaster (NOLOCK) UM
			ON			UM.Uom_ID = MM.MM_PurchaseUom
			WHERE		PI_Po_POS_KEY = @Po_POS_KEY
		END

	ELSE IF @SP_STATUS = 'FillCategory'
	BEGIN
	SELECT	0					AS ID,
				'--select--'	AS NAME
	UNION
	SELECT	Mcm_ID	AS ID,
				Mcm_Name	AS NAME
	FROM MedicineCategoryMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'FillAuthority'
	BEGIN
	SELECT	0					AS ID,
				'--select--'	AS NAME
	UNION
	SELECT	User_ID		AS ID,
				User_Name	AS NAME
	FROM dbo.UserMaster(NOLOCK);
	END;
	ELSE IF @SP_STATUS = 'AutoGeneratePO'
	BEGIN
	DECLARE @FormPrefix AS nvarchar(max) = '';
	SELECT @FormPrefix = FormPrefix
	FROM FormDetailTable
	WHERE Id = 1
	SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Po_No,0)))
	FROM SO_HEADER(NOLOCK)
	WHERE	SO_HEADER.Po_Date BETWEEN @FROM_DATE AND @TO_DATE
	END;
	ELSE IF @SP_STATUS = 'GetManufacture'
	BEGIN
	IF @Po_VenId = 1
		SELECT	bm.BM_ID		AS PI_MAKE,
					bm.BM_Name	AS Manufacture
		FROM BrandMater(NOLOCK) bm
		WHERE bm.BM_ID = 7
	ELSE SELECT	bm.BM_ID		AS PI_MAKE,
					bm.BM_Name	AS Manufacture
		FROM MedicineBrandMater(NOLOCK) mbm
		LEFT JOIN BrandMater (NOLOCK)  bm
		ON mbm.MBM_BmId = bm.BM_ID
		WHERE MBM_MmId = @Pi_ItemId
		AND bm.BM_ID <> 7
	END;
	ELSE IF @SP_STATUS = 'GetMarketingBy'
	BEGIN
	SELECT	MBM_MmId,
				MBM_BmId,
				bm.BM_Name	AS Brand
	FROM MedicineBrandMater(NOLOCK) mbm
	LEFT JOIN BrandMater(NOLOCK) bm
		ON mbm.MBM_BmId = bm.BM_ID
	WHERE mbm.MBM_MmId = @Pi_ItemId
	END
	ELSE IF @SP_STATUS = 'FILL_GRID_PURCHASE'
	BEGIN
	DECLARE @FormPrefix_fill_dgv AS nvarchar(max) = '';
	SELECT @FormPrefix_fill_dgv = FormPrefix
	FROM FormDetailTable(NOLOCK)
	WHERE Id = 1
	SELECT	po.Po_Key,
				@FormPrefix_fill_dgv + CAST(po.Po_No AS nvarchar(max))	AS Po_No,
				--vendr.Vendor_Name,
				CM.Pm_Fullname  AS  Vendor_Name,
				po.Po_DelDate,
				po.Po_Cur,
				po.Po_ExchRate,
				po.Po_BasicVal,
				po.Po_TotVal,
				po.Po_CreatedDt,
				po.Po_RefNo,
				po.Po_RefDate,
				po.Po_RevNo,
				po.Po_Cate,
				po.Po_Type1,
				po.Po_Type2,
				po.Po_EnqMode,
				po.Po_QtNo,
				po.Po_CreatedBy,
				po.Po_Key,
				CM.Pm_Address AS  VendAdd_Addr1,
				--vam.VendAdd_Addr1,
				POTYPE.Ptm_Name														AS PO_TYPE_1,
				POVALTYPE.Po_Name														AS PO_TYPE_2,
				CURRMST.Cm_Name,
				ITM.Mcm_Name,
				IMM.Imm_Name,
				Um.[User_Name],
				po.Po_ApproveStatus,
				ISNULL(po.Po_ApproveStatusRemark,'') AS Po_ApproveStatusRemark,
				(CASE WHEN po.Po_VenId=1 THEN (CASE WHEN Po_IsSync='false' THEN 'No' ELSE 'YES' END) ELSE '' END)AS Po_SynchStatus,----Synch Status Of Po--Add Hasmukh
				CASE	WHEN ISNULL(Poh.Poh_ApproveStatus,0)=0 THEN 'UnApproved' 
						WHEN ISNULL(Poh.Poh_ApproveStatus,0)=1 THEN 'Approved'
						WHEN ISNULL(Poh.Poh_ApproveStatus,0)=2 THEN 'Rejected' END AS Poh_ApproveStatus,
				Poh.Poh_SalesOrderNo,
				Poh.Poh_Remarks
	FROM SO_HEADER(NOLOCK) po
	LEFT JOIN CurrencyMaster(NOLOCK) CUR
		ON CUR.Cm_id = po.Po_Cur
	--LEFT JOIN VendorMaster(NOLOCK) vendr
	--	ON po.Po_VenId = vendr.Vendor_ID
	--LEFT JOIN VendorAddMaster(NOLOCK) vam
	--	ON po.Po_VenId = vam.VendAdd_VendorId
	--	AND po.Po_VenAddId = vam.VendAdd_Id
	LEFT JOIN PoTypeMaster(NOLOCK) POTYPE
		ON POTYPE.Ptm_Type2Key = po.Po_Type1
	LEFT JOIN PoValueTypeMaster(NOLOCK) POVALTYPE
		ON POVALTYPE.Po_Type1Key = po.Po_Type2
	LEFT JOIN CurrencyMaster(NOLOCK) CURRMST
		ON CURRMST.Cm_id = po.Po_Cur
	LEFT JOIN MedicineCategoryMaster(NOLOCK) ITM
		ON ITM.Mcm_ID = po.Po_Cate
	LEFT JOIN InquiryModeMaster(NOLOCK) IMM
		ON IMM.Imm_Id = po.Po_EnqMode
	LEFT JOIN UserMaster(NOLOCK) Um
		ON Um.[User_ID] = po.Po_CreatedBy
	LEFT JOIN cPOS_PoApprovalHistory (NOLOCK)  as Poh
		ON Poh.Poh_Po_Key=po.Po_Key
	LEFT   JOIN   PatientMaster  (NOLOCK) CM
        ON  PO.Po_VenId  =  CM.Pm_Id
	ORDER BY po.Po_Key DESC;
	END;
	ELSE IF @SP_STATUS = 'FillVendor'
	BEGIN
		--SELECT	Vendor_ID AS VEN_ID,
		--		Vendor_Code AS VEN_CODE,
		--		Vendor_Name	AS VEN_NAME,
		--		vam.VendAdd_Id AS VAAD_ID,
		--		vam.VendAdd_Addr1 + CASE WHEN ISNULL(vam.VendAdd_Add2,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add2,'') ELSE '' END
		--		+ CASE WHEN ISNULL(vam.VendAdd_Add3,'') <> '' THEN ISNULL(', ' + vam.VendAdd_Add3,'') ELSE '' END AS VEN_ADDRESS,
		--		Vendor_CreditDays,
		--		area.Area_StateId as StateId,
		--		vm.Vendor_Vt_Id,
		--		vt.Vt_name
		--FROM VendorMaster(NOLOCK) vm
		--INNER JOIN VendorAddMaster(NOLOCK) vam
		--ON vm.Vendor_ID = vam.VendAdd_VendorId
		--AND vam.VendAdd_IsActive = 1
		--LEFT JOIN AreaMaster(NOLOCK) area
		--ON vam.VendAdd_AreaId = area.Area_ID
		--LEFT JOIN StateMaster(NOLOCK) [state]
		--ON area.Area_StateId = state.State_ID
		--LEFT JOIN VendorTypeMaster(NOLOCK)  as vt
		--ON vm.Vendor_Vt_Id=vt.Vt_Id
		--WHERE vm.Vendor_IsActive = 1;


			Select Pm_Id as VEN_ID, 
				StoreCode AS VEN_CODE,
				Pm_Fullname	AS VEN_NAME,
				0 AS VAAD_ID,
				Pm_Address AS VEN_ADDRESS,
				0 as Vendor_CreditDays,
				StateId   as StateId,
				0 as Vendor_Vt_Id,
				'' as Vt_name,
				cm.Contact_PersonName
		from patientMaster (NOLOCK) CM
		WHERE Pm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Po_Key = ISNULL(MAX(Po_Key),0) + 1
	FROM SO_HEADER(NOLOCK);
	SELECT @Po_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Po_No,0)))
	FROM SO_HEADER(NOLOCK)
	WHERE	SO_HEADER.Po_Date BETWEEN @FROM_DATE AND @TO_DATE
	INSERT INTO SO_HEADER(Po_Key,
	Po_No,
	Po_Date,
	Po_RefNo,
	Po_RefDate,
	Po_RevNo,
	Po_RevDate,
	Po_Cate,
	Po_Type1,
	Po_Type2,
	Po_IsCashPurchase,
	Po_EnqMode,
	Po_QtNo,
	Po_VenId,
	Po_VenAddId,
	Po_DelDate,
	Po_Cur,
	Po_ExchRate,
	Po_BasicVal,
	Po_TotVal,
	Po_Remarks,
	Po_Annexure,
	Po_CoverLetter,
	Po_BmId,
	Po_YearId,
	Po_AuthId,
	Po_AuthDate,
	Po_CreatedBy,
	Po_CreatedDt,
	Po_IsAmmendment,
	Po_PaymentTerms,
	[Po_CreditDays],
	Po_Disc,
	Po_Disc_Val ,Po_ApproveStatus,Po_ApproveStatusRemark,
	Po_IsSync,Po_POS_KEY ----Synch Default Set False Add Hasmukh
	) VALUES
	(@Po_Key,@PO_No,@PO_Date,@PO_RefNo,@PO_RefDate,@PO_RevNo,@PO_RevDate,@PO_Cate,@PO_Type1,@Po_Type2,
	@PO_IsCashPurchase,@Po_EnqMode,@Po_QtNo,@Po_VenId,@Po_VenAddId,@Po_DelDate,@Po_Cur,@Po_ExchRate,
	@Po_BasicVal,@Po_TotVal,@Po_Remarks,@Po_Annexure,@Po_CoverLetter,@Po_BmId,@Po_YearId,
	@Po_AuthId,@Po_AuthDate,@USER,GETDATE(),@Po_IsAmmendment,@Po_PaymentTerms,@Po_CreditDays,@Po_Disc,
	@Po_Disc_Val,0,0,
	'false',@Po_POS_KEY);
	SELECT @ID = @Po_Key;
	END;
	ELSE IF @SP_STATUS = 'Delete'
	BEGIN
	--DECLARE @MSG_OUT nvarchar(max)
	--EXEC SP_Tbl_Dependency	'SO_HEADER',
	--								@Po_Key,
	--								@MSG_OUT OUTPUT
	--IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
	--	BEGIN
	--	RAISERROR (@MSG_OUT,14,9)
	--	END
	--ELSE BEGIN
		UPDATE INDDET
		SET INDDET.Indd_AcceptedQty = INDDET.Indd_AcceptedQty - POITMDET.Pi_Qty
		FROM IndentDetail INDDET
		INNER JOIN SO_DETAIL POITMDET
		ON INDDET.Indd_Key = POITMDET.Pi_InddKey
		WHERE POITMDET.Pi_InddKey > 0
		AND POITMDET.Pi_PoKey = @Po_Key;
		DELETE FROM dbo.SO_HEADER
		WHERE Po_Key = @Po_Key;
		DELETE FROM TaxTransaction
		WHERE Tr_DocKey = @Po_Key
		AND Tr_DocTyp = 1;
		DELETE FROM SO_DETAIL
		WHERE Pi_PoKey = @Po_Key;
		--END;
	END
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
	--DECLARE @MSG_OUT_update nvarchar(max)
	--EXEC SP_Tbl_Dependency	'PoHeader',
	--								@Po_Key,
	--								@MSG_OUT_update OUTPUT
	--IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')
	--	BEGIN
	--	RAISERROR (@MSG_OUT_update,14,9)
	--	END
	--ELSE BEGIN
		UPDATE dbo.SO_HEADER
		SET		--Po_No = @PO_No,
		Po_Date = @PO_Date,
		Po_RefNo = @PO_RefNo,
		Po_RefDate = @PO_RefDate,
		Po_RevNo = @PO_RevNo,
		Po_RevDate = @PO_RevDate,
		Po_Cate = @PO_Cate,
		Po_Type1 = @PO_Type1,
		Po_Type2 = @Po_Type2,
		Po_IsCashPurchase = @PO_IsCashPurchase,
		Po_EnqMode = @Po_EnqMode,
		Po_QtNo = @Po_QtNo,
		Po_VenId = @Po_VenId,
		Po_VenAddId = @Po_VenAddId,
		Po_DelDate = @Po_DelDate,
		Po_Cur = @Po_Cur,
		Po_ExchRate = @Po_ExchRate,
		Po_BasicVal = @Po_BasicVal,
		Po_TotVal = @Po_TotVal,
		Po_Remarks = @Po_Remarks,
		Po_Annexure = @Po_Annexure,
		Po_CoverLetter = @Po_CoverLetter,
		Po_BmId = @Po_BmId,
		Po_YearId = @Po_YearId,
		Po_AuthId = @Po_AuthId,
		Po_AuthDate = @Po_AuthDate,
		Po_UpdatedBy = @USER,
		Po_UpdatedDt = GETDATE(),
		Po_IsAmmendment = @Po_IsAmmendment,
		Po_PaymentTerms = @Po_PaymentTerms,
		Po_CreditDays = @Po_CreditDays,
		Po_Disc = @Po_Disc,
		Po_Disc_Val = @Po_Disc_Val,
		Po_POS_KEY = @Po_POS_KEY
		WHERE Po_Key = @Po_Key;
		UPDATE INDDET
		SET INDDET.Indd_AcceptedQty = INDDET.Indd_AcceptedQty - POITMDET.Pi_Qty
		FROM IndentDetail INDDET
		INNER JOIN SO_DETAIL POITMDET
		ON INDDET.Indd_Key = POITMDET.Pi_InddKey
		WHERE POITMDET.Pi_InddKey > 0
		AND POITMDET.Pi_PoKey = @Po_Key;
		DELETE FROM SO_DETAIL	WHERE Pi_PoKey = @Po_Key;
		DELETE FROM TaxTransaction WHERE Tr_DocTyp=@DocType AND TR_DocId=@Po_Key
		SELECT @ID = @Po_Key;
		--END;
	END
	ELSE IF @SP_STATUS = 'SEARCH_BY_ITEM_NAME'
	BEGIN
	--      DECLARE @query NVARCHAR(MAX) = '';
	--      SET @query = '
	--SELECT  	ITEM_MASTER.ITM_ID, ITEM_MASTER.ITM_NAME, ITEM_MASTER.ITM_CODE,ITEM_MASTER.ITM_NAME, ITEM_MASTER.ITM_LAST_PUR_RATE AS ItemRate, UOM_MASTER.UOM_CODE, 
	--					UOM_MASTER.UOM_ID,0 as INDD_SR_NO, ITEM_MASTER.ITM_ID,0 AS Stock, ITEM_MASTER.ITM_LEAD_TIME,ITEM_MASTER.ITM_MIN_LEVEL,ITEM_MASTER.ITM_MAX_LEVEL
	--		FROM		ITEM_MASTER (nolock)
	--				INNER JOIN UOM_MASTER (nolock) 
	--		ON			ITEM_MASTER.ITM_PURCHASE_UNIT = UOM_MASTER.UOM_ID
	--		WHERE		ITEM_MASTER.ITM_NAME like %' + @Pi_ItemName + '%';
	--print @query
	--      EXEC (@query);
	SELECT	0											AS 'IND_SEL',
				mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				UomMaster.Uom_Name,
				UomMaster.Uom_ID,
				mm.Mm_PurRate							AS ItemRate,
				0											AS INDD_SR_NO,
				mm.Mm_LeadTime,
				UomMaster.Uom_Code,
				SUM(ISNULL(VwDeliChall.STOCK,0))	AS Stock,
				mm.Mm_MinLevel,
				mm.Mm_MaxLevel
	FROM dbo.MedicineMaster mm (NOLOCK)
	INNER JOIN UomMaster(NOLOCK)
		ON mm.Mm_StkUom = UomMaster.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VwDeliChall
		ON mm.Mm_ID = VwDeliChall.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	AND Mm_Code LIKE '%' + ISNULL(@Pi_ItemName,'') + '%'
	OR Mm_Name LIKE '%' + ISNULL(@Pi_ItemName,'') + '%' GROUP BY Mm_ID,Mm_Name,Mm_Code,Uom_Name,Uom_ID,Mm_LeadTime,Uom_Code,Mm_MinLevel,Mm_MaxLevel,mm.Mm_PurRate
	ORDER BY Mm_Name
	END;
	ELSE IF @SP_STATUS = 'BIND_ITEM_INDENT'
	BEGIN
	SELECT	INDH.Ind_Key,
				INDH.Ind_No,
				INDD.Indd_ItmId,
				INDD.Indd_ItmCode,
				INDD.Indd_ItmName,
				ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(Indd.Indd_shortCloseQty,0.00)	AS Qty,
				UomMaster.Uom_Name,
				MM.Mm_PurRate																															AS ItemRate,
				INDD.Indd_AcceptedQty																												AS BalQty,
				dbo.UomMaster.Uom_ID																													AS PI_UOM_ID,
				UomMaster.Uom_Name																													AS UOM_CODE,
				INDD.Indd_SrNo,
				MM.Mm_ID,
				INDD.Indd_Key,
				dbo.UomMaster.Uom_Code,
				MM.Mm_MinLevel,
				MM.Mm_MaxLevel,
				MM.Mm_LeadTime,
				ISNULL(Vw.STOCK,0)																													AS Stock,
				MM.MM_MarketingBy,
				MM.MM_ManufactureBy,
				mm.Mm_MaxLevel																															AS PO_MAXLEVEL,
				mm.Mm_MinLevel																															AS PO_MINLEVEL
	FROM IndentHeader(NOLOCK) AS INDH
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDH.Ind_Key = INDD.Indd_IndKey
	LEFT JOIN MedicineMaster(NOLOCK) MM
		ON INDD.Indd_ItmId = MM.Mm_ID
	LEFT JOIN dbo.UomMaster(NOLOCK)
		ON MM.MM_PurchaseUom = dbo.UomMaster.Uom_ID
	LEFT JOIN VwTotalStock Vw
		ON Vw.STK_ITEM_ID = INDD.Indd_ItmId
	WHERE (ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(INDD.Indd_shortCloseQty,0.00)) > 0
	AND ((@Po_VenId = 1
	AND mm.Mm_MtmId = 1)
	OR (@Po_VenId != 1)
	AND mm.Mm_MtmId != 1)
	AND INDH.Ind_ApproveStatus = 'Approve'

	ORDER BY Indd_ItmName
	END;
	ELSE IF @SP_STATUS = 'SEARCH_ITEM_INDENT'
	BEGIN
	--    DECLARE @Searchquery NVARCHAR(MAX) = '';
	--    SET @Searchquery
	--        = 'SELECT INDH.IND_KEY, INDH.IND_NO, INDD.INDD_ITM_ID, INDD.INDD_ITM_CODE, INDD.INDD_ITM_NAME, INDD.INDD_QTY - INDD.INDD_ACCEPTED_QTY AS Qty, 
	--             UOM_MASTER.UOM_NAME, ITEM_MASTER.ITM_LAST_PUR_RATE AS ItemRate, INDD.INDD_ACCEPTED_QTY AS BalQty, UOM_MASTER.UOM_ID, 
	--             INDD.INDD_SR_NO, ITEM_MASTER.ITM_ID,INDD.INDD_KEY,UOM_MASTER.UOM_CODE,ITEM_MASTER.ITM_MIN_LEVEL,ITEM_MASTER.ITM_MAX_LEVEL
	--FROM INDENT_HEADER (nolock) AS INDH 
	--	LEFT JOIN INDENT_DETAIL (nolock) AS INDD 
	--ON INDH.IND_KEY = INDD.INDD_IND_KEY 
	--	LEFT JOIN ITEM_MASTER (nolock) 
	--ON INDD.INDD_ITM_ID = ITEM_MASTER.ITM_ID 
	--	LEFT JOIN UOM_MASTER (nolock)
	--ON ITEM_MASTER.ITM_PURCHASE_UNIT = UOM_MASTER.UOM_ID 
	--WHERE (INDD.INDD_QTY - INDD.INDD_ACCEPTED_QTY) > 0 AND INDD.INDD_ITM_NAME ''%' + @Pi_ItemName + '%''';
	--    EXEC (@Searchquery);
	SELECT *
	FROM (SELECT
		INDH.Ind_Key,
		INDH.Ind_No,
		INDD.Indd_ItmId,
		INDD.Indd_ItmCode,
		INDD.Indd_ItmName,
		ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(Indd.Indd_shortCloseQty,0.00) AS Qty,
		UomMaster.Uom_Name,
		MM.Mm_PurRate AS ItemRate,
		INDD.Indd_AcceptedQty AS BalQty,
		dbo.UomMaster.Uom_ID,
		INDD.Indd_SrNo,
		MM.Mm_ID,
		INDD.Indd_Key,
		dbo.UomMaster.Uom_Code,
		MM.Mm_MinLevel,
		MM.Mm_MaxLevel,
		MM.Mm_LeadTime,
		ISNULL(Vw.STOCK,0) AS Stock
	FROM IndentHeader(NOLOCK) AS INDH
	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDH.Ind_Key = INDD.Indd_IndKey
	LEFT JOIN MedicineMaster(NOLOCK) MM
		ON INDD.Indd_ItmId = MM.Mm_ID
	LEFT JOIN dbo.UomMaster(NOLOCK)
		ON MM.Mm_StkUom = dbo.UomMaster.Uom_ID
	LEFT JOIN VwTotalStock Vw
		ON Vw.STK_ITEM_ID = INDD.Indd_ItmId
	WHERE (ISNULL(INDD.Indd_Qty,0.00) - ISNULL(INDD.Indd_AcceptedQty,0.00) - ISNULL(INDD.Indd_shortCloseQty,0.00)) > 0) AS dt
	WHERE Indd_ItmCode LIKE '%' + @Pi_ItemName + '%'
	OR Indd_ItmName LIKE '%' + @Pi_ItemName + '%'
	ORDER BY Indd_ItmName
	END;
	ELSE IF @SP_STATUS = 'BIND_ITEM'
	BEGIN
	DECLARE @VEN_TYPE	INT
	SELECT TOP(1) @VEN_TYPE=ISNULL(VENDOR_VT_ID,0) FROM VendorMaster(NOLOCK)  WHERE Vendor_ID=@Po_VenId
	SELECT	0											AS 'IND_SEL',
				mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				--UomMaster.Uom_Name,
				--UomMaster.Uom_ID,
				UomMaster.Uom_Name,
				mm.Mm_PurRate							AS ItemRate,
				0											AS INDD_SR_NO,
				mm.Mm_LeadTime,
				UomMaster.Uom_Name					AS Uom_Code,
				MM_PurchaseUom							AS PI_UOM_ID,
				SUM(ISNULL(VwDeliChall.STOCK,0))	AS Stock,
				mm.Mm_MinLevel,
				mm.Mm_MaxLevel,
				mm.Mm_MRP,
				mm.MM_PackSize							AS Pid_PackId,
				mm.Mm_MtmId								AS Po_Manufacture,
				mm.Mm_HsnCode							AS PoHsnCode,
				mm.MM_ManufactureBy,
				mm.MM_MarketingBy,
				mm.Mm_MaxLevel,
				mm.Mm_MinLevel,
				(CASE WHEN mm.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
	FROM dbo.MedicineMaster mm (NOLOCK)
	LEFT JOIN UomMaster(NOLOCK)
		ON mm.MM_PurchaseUom = UomMaster.Uom_ID
	LEFT JOIN VwTotalStock(NOLOCK) VwDeliChall
		ON mm.Mm_ID = VwDeliChall.STK_ITEM_ID
	WHERE MM.Mm_IsActive = 1
	AND ((@VEN_TYPE = 1
	AND mm.Mm_MtmId = 1)
	OR (@VEN_TYPE != 1)
	AND mm.Mm_MtmId != 1) GROUP BY Mm_ID,Mm_Name,Mm_Code,Uom_Name,
	--Uom_ID,
	mm.MM_PurchaseUom,Mm_LeadTime,Uom_Code,Mm_MinLevel,Mm_MaxLevel,mm.Mm_PurRate,Mm_MRP,mm.MM_PackSize,mm.Mm_MtmId,mm.Mm_HsnCode,mm.MM_ManufactureBy,mm.MM_MarketingBy,mm.Mm_MaintainExp
	ORDER BY Mm_Name
	END;
	--================================
	ELSE IF @SP_STATUS = 'INSERT_PoItemDetails'
	BEGIN
	SELECT @Pi_Key = ISNULL(MAX(Pi_Key),0) + 1
	FROM SO_DETAIL(NOLOCK);
	INSERT INTO SO_DETAIL(Pi_Key,
	Pi_PoKey,
	Pi_SrNo,
	Pi_IndKey,
	Pi_IndSrNo,

	Pi_Qty,
	Pi_Rate,
	Pi_Disc,
	Pi_Uom,
	Pi_Amt,
	Pi_Remarks,
	Pi_IndNo,
	Pi_InddKey,
	Pi_ItemName,
	Pi_ItemId,
	Pi_Disc_Val,
	Pi_Net_Amt) VALUES
	(@Pi_Key,@Pi_PoKey,@Pi_SrNo,@Pi_IndKey,@Pi_IndSrNo,@Pi_Qty,@Pi_Rate,@Pi_Disc,@Pi_Uom,
	@Pi_Amt,@Pi_Remarks,@Pi_IndNo,@Pi_InddKey,@Pi_ItemName,@Pi_ItemId,@Pi_Disc_Val,@Pi_Net_Amt);
	--UPDATE INDD
	--SET INDD.Indd_AcceptedQty = INDD.Indd_AcceptedQty + @Pi_Qty
	--FROM SO_DETAIL INDD
	--INNER JOIN SO_DETAIL PODET
	--	ON INDD.Indd_Key = @Pi_InddKey;
	SELECT @ID = @Pi_Key;
	END;
	ELSE IF @SP_STATUS = 'RETRIVE_PO'
	BEGIN
	
	DECLARE @FormPrefix_ret AS nvarchar(max) = '';
	SELECT @FormPrefix_ret = FormPrefix
	FROM FormDetailTable (NOLOCK) 
	WHERE Id = 1
	SELECT	PO.[Po_Key],
				@FormPrefix_ret + CAST(PO.[Po_No] AS nvarchar(max)) AS [Po_No],
				PO.[Po_Date],
				PO.[Po_RefNo],
				PO.[Po_RefDate],
				PO.[Po_RevNo],
				PO.[Po_RevDate],
				[Po_Cate],
				[Po_Type1],
				[Po_Type2],
				[Po_IsCashPurchase],
				[Po_EnqMode],
				[Po_QtNo],
				[Po_IsAmmendment],
				[Po_VenId],
				[Po_VenAddId],
				PO.[Po_DelDate],
				[Po_Cur],
				[Po_ExchRate],
				PO.[Po_BasicVal],
				PO.[Po_TotVal],
				PO.[Po_Annexure],
				PO.[Po_CoverLetter],
				PO.[Po_Remarks],
				PO.[Po_PaymentTerms],
				PO.[Po_CreditDays],
				--VM.Vendor_Name,
				--VM.Vendor_Code,

				--CM.Cust_Name  AS Vendor_Name,
				--cm.Cust_No as Vendor_Code ,
				pm.Pm_Address  as  VEN_ADDRESS,
				pm.Pm_Fullname  as Vendor_Name,
				pm.StoreCode  as  Vendor_Code,
				pm.StateId ,
				Po_AuthId,
				PO.Po_AuthDate,
				--cm.Address   as  VEN_ADDRESS, 
				--ISNULL(VENADD.VendAdd_Addr1,'') + ISNULL(VENADD.VendAdd_Add2,'') + ISNULL(VENADD.VendAdd_Add3,'')	AS VEN_ADDRESS,
				PO.Po_Disc,
				PO.Po_Disc_Val, Store.Po_Store_Code, PO.Po_POS_KEY
				--CM.State as StateId
				--area.Area_StateId	AS	StateId
	FROM [dbo].[SO_HEADER](NOLOCK) PO
	--LEFT JOIN VendorAddMaster VENADD (NOLOCK)
	--	ON [PoHeader].Po_VenAddId = VENADD.VendAdd_Id
	--LEFT JOIN VendorMaster VM (NOLOCK)
	--	ON [PoHeader].Po_VenId = VM.Vendor_ID
	 -- LEFT JOIN  CustomerMaster   (NOLOCK) CM
		--ON   PO.Po_VenId= CM.Cust_Id     

	  left join   PatientMaster (nolock) pm
	on   pm.Pm_Id= po.Po_VenId
		LEFT JOIN PoHeader_Store (NOLOCK) Store
	ON	 Store.Po_POS_KEY = PO.Po_POS_KEY
	--LEFT JOIN AreaMaster (nolock) area
	--	ON VENADD.VendAdd_AreaId = area.Area_ID
	--LEFT JOIN StateMaster [state]
	--	ON area.Area_StateId = state.State_ID




	WHERE PO.[Po_Key] = @Po_Key;
	--====================== BINDING PO DETAIL GRID ==
	SELECT	[Pi_Key],
				[Pi_PoKey],
				[Pi_SrNo],
				[Pi_IndKey],
				[Pi_IndSrNo],
				[Pi_ItemId],

				[Pi_Qty],
				[Pi_Rate],
				[Pi_IndNo],
				[Pi_Disc],
				[Pi_Uom]										AS PI_UOM_ID,
				[Pi_Amt],
				[Pi_Remarks],
				[Pi_ShortCloseQty],
				mm.Mm_Name,
				UM.Uom_Name,
				mm.Mm_Code,
				POITMDET.Pi_InddKey,
				UM.Uom_Code,
				POITMDET.[Pi_ItemName],
				ISNULL(CASE
					WHEN ISNULL(INDD.Indd_Qty,0) > 0 THEN INDD.Indd_Qty
					ELSE INDD.Indd_Qty
				END,
				0
				)												AS PI_INDD_QTY,
				Pi_Disc,
				Pi_Disc_Val,
				Pi_Net_Amt,
				mm.MM_MarketingBy,
				mm.MM_ManufactureBy,
				ISNULL(POITMDET.Pi_PiQty,0)			AS Pi_PiQty,
				ISNULL(POITMDET.Pi_ShortCloseQty,0)	AS Pi_ShortCloseQty,
				mm.Mm_MaxLevel								PO_MAXLEVEL,
				mm.Mm_MinLevel								PO_MINLEVEL

	FROM [dbo].SO_DETAIL(NOLOCK) POITMDET
	LEFT JOIN MedicineMaster(NOLOCK) mm
		ON mm.Mm_ID = POITMDET.Pi_ItemId
	LEFT JOIN UomMaster(NOLOCK) UM
		ON UM.Uom_ID = POITMDET.Pi_Uom

	LEFT JOIN IndentDetail(NOLOCK) INDD
		ON INDD.Indd_Key = POITMDET.Pi_InddKey
	WHERE Pi_PoKey = @Po_Key;
	END;
	ELSE IF @SP_STATUS = 'BIND_VIA_ITEMCODE'
	BEGIN
	SELECT	mm.Mm_ID,
				mm.Mm_Name,
				mm.Mm_Code,
				mm.Mm_LeadTime,
				mm.Mm_StkUom,
				UomMaster.Uom_Code,
				UomMaster.Uom_Name,
				UomMaster.Uom_ID	AS PI_UOM_ID,
				mm.Mm_PurRate,
				mm.MM_ManufactureBy,
				mm.MM_MarketingBy
	FROM dbo.MedicineMaster(NOLOCK) mm
	LEFT JOIN UomMaster(NOLOCK)
		ON mm.MM_PurchaseUom = UomMaster.Uom_ID
	WHERE Mm_ID = @Pi_ItemId
	AND MM.Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'UPDATE_SHORT_CLOSE_QTY'
	BEGIN
	UPDATE SO_DETAIL
	SET	Pi_ShortCloseQty = Pi_ShortCloseQty + @Pi_ShortCloseQty,
			Pi_ShortCloseBy = @USER,
			Pi_ShortCloseDt = GETDATE()
	WHERE Pi_SrNo = @Pi_SrNo
	AND Pi_PoKey = @Pi_PoKey
	AND Pi_ItemId = @Pi_ItemId
	SELECT @ID = Pi_Key
	FROM SO_DETAIL
	WHERE Pi_SrNo = @Pi_SrNo
	AND Pi_PoKey = @Pi_PoKey
	AND Pi_ItemId = @Pi_ItemId
	END
	
	
	ELSE IF @SP_STATUS = 'GET_ITEM'
	BEGIN
	SELECT *
	FROM dbo.MedicineMaster(NOLOCK)
	WHERE Mm_IsActive = 1;
	END;
	ELSE IF @SP_STATUS = 'BIND_PO_ITEM'
	BEGIN
	DECLARE @dynaSqlPoItem nvarchar(max) = '';
	SET @dynaSqlPoItem += 'SELECT		CONVERT(BIT, 0) AS SEL,POHEAD.Po_Key,  cast(POHEAD.Po_No as nvarchar(max)) as Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
						isnull(POHEAD.Po_TotVal,0.00) as TotalAmount,vm.Vendor_Name 
						--,IM.MM_ManufactureBy,Im.MM_MarketingBy
		    FROM		SO_HEADER  (NOLOCK) POHEAD
					INNER JOIN SO_DETAIL  (NOLOCK) POITMDET
			ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
					INNER JOIN dbo.MedicineMaster  (NOLOCK) IM
			ON			IM.Mm_ID = POITMDET.Pi_ItemId
					INNER JOIN dbo.UomMaster  (NOLOCK) UOMMST
			ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
					INNER JOIN dbo.VendorMaster  (NOLOCK) vm
			ON			POHEAD.Po_VenId = vm.Vendor_ID
		    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0) - ISNULL(POITMDET.Pi_ShortCloseQty, 0)  > 0 
					AND	POHEAD.Po_VenId = ' + CAST(@Po_VenId AS nvarchar(10));
	IF @PO_KEYS <> ''
		BEGIN
		SET @dynaSqlPoItem += ' OR POHEAD.Po_Key in (' + @PO_KEYS + ')';
		END;
	SET @dynaSqlPoItem += ' GROUP BY POHEAD.Po_TotVal ,POHEAD.Po_No,POHEAD.Po_Date,POHEAD.Po_RefNo,POHEAD.Po_RefDate,POHEAD.Po_VenId,POHEAD.Po_DelDate,vm.Vendor_Name,POHEAD.Po_Key';
	EXEC (@dynaSqlPoItem);
	--print(@dynaSqlPoItem);
	END;
	
	ELSE IF @SP_STATUS = 'BIND_Dispatch'
		BEGIN
			--SELECT	DDetail.Did_CposPoNo,
			--		po.Po_Key	AS hcPo_Key1,
			--		DHeader.Dih_Key	AS hcDo_Key,
			--		CAST(DHeader.Dih_No AS nvarchar(max))	AS hcDo_No,
			--		Dih_Date AS hcDo_Date,
			--		Dih_RefNo AS hcDo_RefNo,
			--		Dih_RefDate AS hcDo_RefDate,
			--		ISNULL(DHeader.Dih_NetValue,0.00) AS hcDoTotalAmount,
			--		vm.Vendor_Name AS hcDoVendor_Name
			--		--,IM.MM_ManufactureBy,Im.MM_MarketingBy
			--FROM	DispatchHeader(NOLOCK) DHeader
			--		LEFT JOIN DispatchDetail(NOLOCK) DDetail
			--ON			DDetail.Did_DihKey = DHeader.Dih_Key
			--		LEFT JOIN PoHeader po
			--ON			po.Po_No = DDetail.Did_CposPoNo
			--		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm
			--ON			mm.Mm_ID = DDetail.Did_MmId
			--		LEFT JOIN dbo.UomMaster(NOLOCK) UOMMST
			--ON			UOMMST.Uom_ID = DDetail.Did_UomId
			--		LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			--ON		DHeader.Dih_VenId = vm.Vendor_ID
			--WHERE	DHeader.Dih_VenId = @po_VenId 
			--GROUP BY	po.Po_Key,DDetail.Did_CposPoNo,DHeader.Dih_NetValue,
			--		DHeader.Dih_No,DHeader.Dih_Key,
			--		DHeader.Dih_Date,
			--		DHeader.Dih_RefNo,
			--		DHeader.Dih_RefDate,
			--		vm.Vendor_Name
			--HAVING	ISNULL(SUM(DDetail.Did_Qty),0) - ISNULL(SUM(DDetail.Did_PIQty),0) > 0
			SELECT	Dheader.Sih_Po_No AS Did_CposPoNo,
					po.Po_Key	AS hcPo_Key1,
					DHeader.Sih_Key	AS hcDo_Key,
					CAST(DHeader.Sih_No AS nvarchar(max))	AS hcDo_No,
					Sih_Date AS hcDo_Date,
					Dheader.Sih_No AS hcDo_RefNo,
					 Dheader.Sih_Date AS hcDo_RefDate,
					ISNULL(DHeader.Sih_Total,0.00) AS hcDoTotalAmount,
					'' AS hcDoVendor_Name
					--,IM.MM_ManufactureBy,Im.MM_MarketingBy
			FROM	cPOS_SalesInvoiceHeader (NOLOCK) DHeader
					LEFT JOIN cPOS_SalesInvoiceItemDetail(NOLOCK) DDetail
			ON			DDetail.Sid_Sih_Key = DHeader.Sih_Key
					LEFT JOIN SO_HEADER (NOLOCK)  po
			ON			po.Po_No = DHeader.Sih_Po_No
					LEFT JOIN dbo.MedicineMaster(NOLOCK) mm
			ON			mm.Mm_Code=DDetail.Sid_Item_Code
					LEFT JOIN dbo.UomMaster(NOLOCK) UOMMST
			ON			UOMMST.Uom_ID = mm.MM_PurchaseUom
			--		LEFT JOIN dbo.VendorMaster(NOLOCK) vm
			--ON		DHeader.Dih_VenId = vm.Vendor_ID
			--WHERE	DHeader.Dih_VenId = @po_VenId 
			GROUP BY	po.Po_Key,DHeader.Sih_Po_No,
						DHeader.Sih_Total,
					DHeader.Sih_No,
					DHeader.Sih_Key,
					DHeader.Sih_Date
			--HAVING	ISNULL(SUM(DDetail.Sid_Qty),0) - ISNULL(SUM(DDetail.Did_PIQty),0) > 0
		END;
	ELSE IF @SP_STATUS = 'BIND_PO_ITEM_SEARCH'
	BEGIN
	DECLARE @dynaSqlPo nvarchar(max) = '';
	--SET @dynaSqlPo += 'Select * from (SELECT		CONVERT(BIT, 0) AS SEL,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
	--				SUM(ISNULL(POITMDET.Pi_Qty, 0)) - SUM(ISNULL(POITMDET.Pi_PiQty, 0)) AS PI_QTY,vm.Vendor_Name,POHEAD.Po_Key,POHEAD.Po_VenId,POHEAD.Po_No
	--    FROM		PoHeader POHEAD
	--			INNER JOIN PoItemDetails POITMDET
	--	ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
	--			INNER JOIN dbo.MedicineMaster IM
	--	ON			IM.Mm_ID = POITMDET.Pi_ItemId
	--			INNER JOIN dbo.UomMaster UOMMST
	--	ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
	--			INNER JOIN dbo.VendorMaster vm
	--	ON			POHEAD.Po_VenId = vm.Vendor_ID
	--    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0) > 0 
	--			AND	POHEAD.Po_VenId = 2 GROUP BY Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_VenId,Po_DelDate,Vendor_Name,Po_Key )dt WHERE dt.Po_No like '%004%' OR dt.Vendor_Name like '%001%' 
	SET @dynaSqlPo += 'Select * from (SELECT		CONVERT(BIT, 0) AS SEL,POHEAD.Po_Key,POHEAD.Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_DelDate,
							SUM(ISNULL(POITMDET.Pi_Qty, 0)) - SUM(ISNULL(POITMDET.Pi_PiQty, 0))- SUM(ISNULL(POITMDET.Pi_ShortCloseQty, 0)) AS PI_QTY,vm.Vendor_Name
			    FROM		SO_HEADER  (NOLOCK) POHEAD
						INNER JOIN SO_DETAIL  (NOLOCK) POITMDET
				ON			POITMDET.Pi_PoKey = POHEAD.Po_Key
						INNER JOIN dbo.MedicineMaster  (NOLOCK) IM
				ON			IM.Mm_ID = POITMDET.Pi_ItemId
						INNER JOIN dbo.UomMaster (NOLOCK)  UOMMST
				ON			UOMMST.Uom_ID = POITMDET.Pi_Uom
						INNER JOIN dbo.VendorMaster  (NOLOCK) vm
				ON			POHEAD.Po_VenId = vm.Vendor_ID
			    WHERE		ISNULL(POITMDET.Pi_Qty, 0) - ISNULL(POITMDET.Pi_PiQty, 0)- ISNULL(POITMDET.Pi_ShortCloseQty, 0)> 0 
						AND	POHEAD.Po_VenId = ' + CAST(@Po_VenId AS nvarchar(10));
	IF @PO_KEYS <> ''
		BEGIN
		SET @dynaSqlPo += ' OR POHEAD.Po_Key in (' + @PO_KEYS + ')';
		END;
	SET @dynaSqlPo += ' GROUP BY Po_No,Po_Date,Po_RefNo,Po_RefDate,Po_VenId,Po_DelDate,Vendor_Name,Po_Key';
	SET @dynaSqlPo += ' )dt WHERE dt.Po_No like ''%' + ISNULL(@Po_Search_Text,'') + '%'' OR dt.Vendor_Name like ''%' + ISNULL(@Po_Search_Text,'') + '%'''
	PRINT @dynaSqlPo
	EXEC (@dynaSqlPo);
	END
	ELSE IF @SP_STATUS = 'CHECK_DEPENDENCY_EXIST'
	BEGIN
	DECLARE @MSG_OUT1 nvarchar(max)

	EXEC [SP_Tbl_Dependency1]	'SO_DETAIL',
										@Pi_ItemName,
										@MSG_OUT1 OUTPUT

	IF (RTRIM(LTRIM(@MSG_OUT1)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT1,14,9)
		END
	END
	ELSE IF @SP_STATUS = 'GET_ITEM_BY_PO_KEY'
	BEGIN

	SELECT	CAST(0 AS bit)	AS SEL,
				PID.Pi_Key,
				PID.Pi_PoKey AS Po_Key,
				PID.Pi_SrNo,
				PID.Pi_ItemId,
				PID.Pi_ItemName,
				PID.Pi_Uom,
				UOM.Uom_Name,
				(ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0))	AS Pi_Qty,
				PID.Pi_Rate,
				Pi_Qty		AS Po_Qty,
				PID.Pi_Amt,
				MM.Mm_Code,
				MM.Mm_MRP,
				mm.MM_PackSize	AS Pid_PackId,
				MM.Mm_HsnCode			AS PoHsnCode,
				MM.MM_ManufactureBy,
				MM.MM_MarketingBy,
				(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
	FROM SO_DETAIL(NOLOCK) PID
	LEFT JOIN PurchaseInvoiceDetail(NOLOCK) POINVDET
		ON PID.Pi_PoKey = POINVDET.Pid_PoKey
		AND PID.Pi_ItemId = POINVDET.Pid_MmId
	--AND	PID.Pi_SrNo = POINVDET.Pid_PiSrNo
	LEFT JOIN UomMaster(NOLOCK) UOM
		ON PID.Pi_Uom = UOM.Uom_ID
	LEFT JOIN MedicineMaster(NOLOCK) MM
		ON MM.Mm_ID = PID.Pi_ItemId
	--		left join PoHeader po 
	--on			po.Po_Key=PID.Pi_PoKey
	WHERE pid.Pi_PoKey = @Pi_PoKey
	AND (ISNULL(PID.Pi_Qty,0) - ISNULL(PID.Pi_PiQty,0) - ISNULL(PID.Pi_ShortCloseQty,0)) > 0
	--and po.Po_ApproveStatus='Approve';

	END;
	ELSE IF @SP_STATUS = 'GET_ITEM_BY_DO_KEY'
	BEGIN

		SELECT	CAST(0 AS bit)	AS SEL,
					DD.Sid_Key AS Pi_Key,
					DD.Sid_Sih_Key AS Po_Key,
					DD.Sid_SrNo AS Pi_SrNo,
					MM.Mm_ID AS Pi_ItemId,
					MM.Mm_Name AS Pi_ItemName,
					UOM.Uom_ID AS Pi_Uom,
					UOM.Uom_Name,
					(ISNULL(DD.Sid_Qty,0))	AS Pi_Qty,
					DD.Sid_Item_Rate Pi_Rate,
					Sid_Qty AS Po_Qty,
					DD.Sid_Total AS Pi_Amt,
					MM.Mm_Code,
					DD.Sid_Item_MRP Mm_MRP,
					mm.MM_PackSize AS Pid_PackId,
					MM.Mm_HsnCode AS PoHsnCode,
					MM.MM_ManufactureBy,
					MM.MM_MarketingBy,
					DD.Sid_Batch_No,
					DD.Sid_ExpDate,
					DD.Sid_MnfDate,
					(CASE WHEN MM.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus---Add Hasmukh
		FROM	cPOS_SalesInvoiceItemDetail (NOLOCK) DD
		--		LEFT JOIN PurchaseInvoiceDetail (NOLOCK) POINVDET
		--ON			DD.Did_DihKey = POINVDET.Pid_PoKey
		--		AND	DD.Did_MmId = POINVDET.Pid_MmId
		--		AND	DD.Did_SrNo = POINVDET.Pid_PiSrNo
				LEFT JOIN MedicineMaster(NOLOCK) MM
		ON		MM.Mm_Code = DD.Sid_Item_Code
				LEFT JOIN UomMaster(NOLOCK) UOM
		ON		MM.MM_PurchaseUom = UOM.Uom_ID
		WHERE		DD.Sid_Sih_Key = @Pi_PoKey
				--AND (ISNULL(DD.Sid_Qty,0) - ISNULL(DD.Did_PIQty,0)) > 0

	END;
	ELSE IF @SP_STATUS = 'SYNCH_UPDATE'---->PO Synch Status Update Add Hasmukh
	BEGIN
	     UPDATE SO_HEADER
		    SET Po_IsSync='true',
			    Po_LastSyncDate=GETDATE()
		  WHERE Po_Key=@Po_Key
		SELECT @ID=@Po_Key;
	END;

	--ELSE  IF  @SP_STATUS = 'REPORT_PICK_NOTE'
	--BEGIN
	--      SELECT *  FROM  


	--END
	ELSE IF @SP_STATUS = 'GET_SO_SHORTQTY'
	BEGIN
		SELECT		ROW_NUMBER() OVER(ORDER BY A.Pi_Key ASC)AS SrNo,
					B.Po_No,
					Convert(varchar,B.Po_Date,105)AS Po_Date,
					C.Pm_Fullname,
					C.StoreCode,
					A.Pi_SrNo,
					F.Mm_Code,
					F.Mm_Name,
					G.Uom_Name,
					(SUM(ISNULL(A.Pi_Qty,0))-SUM(ISNULL(E.Scd_SalesQty,0)))AS Qty
		FROM		SO_DETAIL A
					INNER JOIN SO_HEADER B
		ON			A.Pi_PoKey=B.Po_Key
					INNER JOIN PatientMaster C
		ON			C.Pm_Id=B.Po_VenId
					LEFT JOIN  SalesChallenItemDetails E
		ON			E.Scd_Po_Key=A.Pi_PoKey
					AND E.Scd_Mm_Id=A.Pi_ItemId
					INNER JOIN MedicineMaster F
		ON			F.Mm_ID=A.Pi_ItemId
					INNER JOIN UomMaster G
		ON			G.Uom_ID=F.Mm_StkUom
		WHERE		B.Po_Date BETWEEN CAST(@PO_Date AS DATE) AND CAST(@Po_DelDate AS DATE)
		GROUP BY	B.Po_No,
					B.Po_Date,
					C.Pm_Fullname,
					A.Pi_SrNo,
					F.Mm_Code,
					F.Mm_Name,
					G.Uom_Name,
					A.Pi_Key,
					C.StoreCode
	END
	ELSE IF @SP_STATUS = 'GET_Pending_PO'
	BEGIN
		IF(@Po_Remarks='Pending')
			BEGIN
				SELECT		A.Po_No,
							CONVERT(VARCHAR,A.Po_Date,105)AS Po_Date ,
							A.Po_Store_Code,
							D.Pm_Fullname,
							DT.NoOfItem,
							E.Po_No AS So_No,
							(CASE WHEN E.Po_Date IS NULL 
									THEN '' 
									ELSE CONVERT(VARCHAR,E.Po_Date,105) 
							END)AS So_Date 
				FROM		PoHeader_Store A
							INNER JOIN (SELECT		B.Po_Key,
													COUNT(C.Pi_ItemId)AS NoOfItem
										FROM		PoHeader_Store B
													INNER JOIN PoItemDetails_Store C
										ON			C.Pi_PoKey=B.Po_Key
										GROUP BY	B.Po_Key
										)AS DT
				ON			DT.Po_Key=A.Po_Key
							INNER JOIN PatientMaster D
				ON			D.StoreCode=A.Po_Store_Code
							LEFT JOIN SO_HEADER E
				ON			E.Po_POS_KEY=A.Po_Key
				WHERE		E.Po_Key IS NULL
				ORDER BY	E.Po_Key DESC
			END
		ELSE IF(@Po_Remarks='Done')
			BEGIN
				SELECT		A.Po_No,
							CONVERT(VARCHAR,A.Po_Date,105)AS Po_Date ,
							A.Po_Store_Code,
							D.Pm_Fullname,
							DT.NoOfItem,
							E.Po_No AS So_No,
							(CASE WHEN E.Po_Date IS NULL 
									THEN '' 
									ELSE CONVERT(VARCHAR,E.Po_Date,105) 
							END)AS So_Date 
				FROM		PoHeader_Store A
							INNER JOIN (SELECT		B.Po_Key,
													COUNT(C.Pi_ItemId)AS NoOfItem
										FROM		PoHeader_Store B
													INNER JOIN PoItemDetails_Store C
										ON			C.Pi_PoKey=B.Po_Key
										GROUP BY	B.Po_Key
										)AS DT
				ON			DT.Po_Key=A.Po_Key
							INNER JOIN PatientMaster D
				ON			D.StoreCode=A.Po_Store_Code
							LEFT JOIN SO_HEADER E
				ON			E.Po_POS_KEY=A.Po_Key
				WHERE		E.Po_Key IS NOT NULL
				ORDER BY	E.Po_Key DESC
			END
		ELSE IF(@Po_Remarks='All')
			BEGIN
				SELECT		A.Po_No,
							CONVERT(VARCHAR,A.Po_Date,105)AS Po_Date ,
							A.Po_Store_Code,
							D.Pm_Fullname,
							DT.NoOfItem,
							E.Po_No AS So_No,
							(CASE WHEN E.Po_Date IS NULL 
									THEN '' 
									ELSE CONVERT(VARCHAR,E.Po_Date,105) 
							END)AS So_Date 
				FROM		PoHeader_Store A
							INNER JOIN (SELECT		B.Po_Key,
													COUNT(C.Pi_ItemId)AS NoOfItem
										FROM		PoHeader_Store B
													INNER JOIN PoItemDetails_Store C
										ON			C.Pi_PoKey=B.Po_Key
										GROUP BY	B.Po_Key
										)AS DT
				ON			DT.Po_Key=A.Po_Key
							INNER JOIN PatientMaster D
				ON			D.StoreCode=A.Po_Store_Code
							LEFT JOIN SO_HEADER E
				ON			E.Po_POS_KEY=A.Po_Key
				ORDER BY	E.Po_Key DESC
			END
	END
END;



GO
/****** Object:  StoredProcedure [dbo].[Sp_SalesReturn]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- EXEC [dbo].[Sp_SalesReturn] @SP_STATUS = 'GetItemDetailOriginal',@Srd_SrhId = 5
CREATE PROCEDURE [dbo].[Sp_SalesReturn]  
---------------------- Sales RETURN HEADER --------------------  
@SP_STATUS		varchar(200) = '',  
@USER			int = 0,  
@ID				int = 0 OUT,  
@Srh_Id			numeric(18,0) = 0,  
@Srh_No			numeric( 18 ,0) = 0,  
@Srh_Date		[DATETIME] = NULL,  
@Srh_RefNo		[VARCHAR](200) = '',  
@Srh_RefDate	[DATETIME] = NULL,  
@Srh_SihKey		numeric(18,0) = 0,  
@Srh_Remarks	[VARCHAR](1000) = '',  
@Srh_BranchId	[INT] = 0,  
@Srh_YearId		[INT] = 0,  
@Srh_Total		decimal(18, 2) = 0,  
@Srh_StartDate	datetime = NULL,  
@Srh_EndDate	datetime = NULL,  
---------------------- Sales RETURN HEADER --------------------  
@Srd_Id			numeric(18,0) = 0,  
@Srd_SrhId		numeric(18,0) = 0,  
@Srd_SrNo		int = 0,  
@Srd_MmId		numeric(18,0) = 0,  
@Srd_PackId		int = '',  
@Srd_BatchNo	nvarchar(50) = 0,  
@Srd_UomId		int = 0,  
@Srd_Qty		numeric(18, 2) = 0,  
@Srd_Rate		numeric(18, 2) = 0,  
@Srd_Amount		numeric(18, 2) = 0,  
@Srd_Remarks	varchar(1000) = NULL,  
@Srd_SidKey		numeric(18,0) = 0,  
@Srh_CustId		int = 0,  
@Srd_LmId		int = 0,  
@Srd_SidSrNo	int=0,  
@Sid_SihKey		numeric(18,0)=0  
  
AS 
DECLARE @FROM_DATE	DATETIME
DECLARE @TO_DATE	DATETIME

SELECT	TOP(1)
		@FROM_DATE=A.Year_FromDate,
		@TO_DATE=A.Year_ToDate
FROM	YearMaster A
WHERE	A.Year_IsDef=1
 
 IF @SP_STATUS = 'AutoPRNumber'  
 BEGIN  
	DECLARE		@FormPrefix		AS NVARCHAR(MAX) = '';  
	SELECT		@FormPrefix = FormPrefix  
	FROM		FormDetailTable (NOLOCK)   
	WHERE		Id = 5  
	SELECT		@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Srh_No,0)))  
	FROM		SalesReturnHeader (NOLOCK)  
	WHERE		SalesReturnHeader.Srh_Date BETWEEN @FROM_DATE AND @TO_DATE
 END;  

 ELSE IF @SP_STATUS = 'BIND_ITEM'  
 BEGIN  
	SELECT		CAST(0 AS bit) AS Chk,  
				sih.Sih_No,  
				MM.Mm_Code,  
				MM.Mm_Name,  
				MM.MM_PackSize AS Ps_Name,  
				Sid_BatchNo,  
				uom.Uom_Name,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS RemainigSalesQty,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS OldStock,  
				sid.Sid_SalesRate,  
				sid.Sid_Disc,  
				sid.Sid_DiscAmount,  
				sid.Sid_Total,  
				Sid_SalesUomId,  
				Sid_Mm_Id,  
				sid.Sid_Sih_Key,  
				sid.Sid_Key,  
				sid.Sid_ExpDate,  
				sid.Sid_MnfDate,  
				sih.Sih_Pm_Id AS Sih_CustId  
	FROM		dbo.SalesInvoiceItemDetail  (NOLOCK) sid  
				LEFT JOIN dbo.SalesReturnDetail  (NOLOCK) srd  
	ON			sid.Sid_Key = srd.Srd_SidKey  
				AND sid.Sid_Mm_Id = srd.Srd_MmId  
				AND sid.Sid_BatchNo = srd.Srd_BatchNo  
				AND sid.Sid_SalesUomId = srd.Srd_UomId  
				LEFT JOIN dbo.MedicineMaster  (NOLOCK) MM  
	ON			sid.Sid_Mm_Id = MM.Mm_ID  
				--LEFT JOIN dbo.PacketSizeMater pack  
				--ON sid.Sid_PackId = pack.Ps_ID  
				LEFT JOIN dbo.UomMaster (NOLOCK)  uom  
	ON			sid.Sid_SalesUomId = uom.Uom_ID  
				LEFT JOIN dbo.SalesInvoiceHeader  (NOLOCK) sih  
	ON			sid.Sid_Sih_Key = sih.Sih_Key  
	GROUP BY	Sid_SalesQty,
				MM.MM_PackSize,
				Sid_Mm_Id,
				Sid_BatchNo,
				Sid_SalesUomId,
				MM.Mm_Name,
				uom.Uom_Name,
				MM.Mm_Code,
				Sid_Sih_Key,  
				sid.Sid_SalesRate, 
				sid.Sid_Disc, 
				sid.Sid_Total,
				sid.Sid_Key,
				sih.Sih_No,
				Sid_DiscAmount, 
				sid.Sid_ExpDate, 
				sid.Sid_MnfDate,
				sih.Sih_Pm_Id  
	 HAVING		(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) > 0  
	 ORDER BY	Sid_Sih_Key;  
 END;  

 ELSE  IF @SP_STATUS = 'BIND_ITEM_NEW'  
 BEGIN  
	 SELECT		CAST(0 AS bit) AS Chk,  
				cast(sih.Sih_No as nvarchar(max)) as Sih_No ,  
				MM.Mm_Code,  
				MM.Mm_Name,  
				MM.MM_PackSize AS Ps_Name,  
				Sid_BatchNo,  
				uom.Uom_Name,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS RemainigSalesQty,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS OldStock,  
				ISNULL(sid.Sid_SalesRate,0.00) as Sid_SalesRate_Original,---------------UnComment by Vishal   
				ISNULL(sid.Sid_SalesRate, 0.00) / (mm.MM_SalesRatio / mm.MM_PurchaseRatio) AS Sid_SalesRate,  
				ISNULL(sid.Sid_Disc, 0.00) AS Sid_Disc,  
				ISNULL(sid.Sid_DiscAmount, 0.00) AS Sid_DiscAmount,  
				ISNULL(sid.Sid_Total, 0.00) AS Sid_Total,  
				Sid_SalesUomId,  
				sid.Sid_PurchaseQty,  
				sid.Sid_PurchaseRate,  
				sid.Sid_PurchaseUomId,  
				Sid_Mm_Id,  
				sid.Sid_Sih_Key,  
				sid.Sid_Key,  
				sid.Sid_ExpDate,  
				sid.Sid_MnfDate,  
				@Srh_CustId AS Sih_CustId,  
				case when ISNULL(pm.StoreCode,'') <>'' then pm.Pm_Fullname +'('+ pm.StoreCode +')' else pm.Pm_Fullname end AS PatientName,  
				--pm.Pm_Fullname AS PatientName,  
				pm.Pm_Mob AS PatientMobile,  
				sid.Sid_LmId,  
				sih.Sih_Date,  
				ISNULL(sid.Sid_MRP, 0.00) / (mm.MM_SalesRatio / mm.MM_PurchaseRatio)  AS Sid_MRP,  
				sid.Sid_MRP AS Sid_MRP_Original,
				--Sid_SrNo ,Sid_Sih_Key AS Srd_SrhId,Srd_SrNo  
				--Sid_Sih_Key,  
				Sid_SrNo ,  
				--Srd_SrhId,  
				--Srd_SrNo,  
				sih.Sih_IsCreditBill  
	FROM		dbo.SalesInvoiceItemDetail  (NOLOCK) sid  
				LEFT JOIN dbo.SalesReturnDetail  (NOLOCK) srd  
	ON			sid.Sid_Sih_Key = srd.Sid_SihKey  
				AND	sid.Sid_Mm_Id = srd.Srd_MmId  
				AND	sid.Sid_SrNo = srd.Srd_SidSrNo  
				LEFT JOIN dbo.MedicineMaster  (NOLOCK) MM  
	ON			sid.Sid_Mm_Id = MM.Mm_ID  
				LEFT JOIN dbo.UomMaster  (NOLOCK) uom  
	ON			sid.Sid_SalesUomId = uom.Uom_ID  
				LEFT JOIN dbo.SalesInvoiceHeader  (NOLOCK) sih  
	ON			sid.Sid_Sih_Key = sih.Sih_Key  
				LEFT JOIN dbo.PatientMaster  (NOLOCK) pm  
	ON			pm.Pm_Id = sih.Sih_Pm_Id  
	WHERE		Sih_Key=@Srh_SihKey AND----add Hasmukh  
				CASE WHEN sih.Sih_IsCreditBill = 0 
						THEN sih.Sih_AccId  
						ELSE sih.Sih_Pm_Id    --  put  on commnet by  yogini 15/11/2018
				END =CASE WHEN	sih.Sih_IsCreditBill = 1 
							THEN (SELECT	TOP 1 Lm_PVId 
									FROM	LedgerMaster  
									WHERE Lm_Id = @Srh_CustId)  
							ELSE	@Srh_CustId  
					END 
				and DATEDIFF(DAY, GETDATE(),ISNULL(Sid_ExpDate,getdate()) )>= ( case when isnull(Sid_ExpDate,'')!='' then  (select top 1 ISNULL(SrExpDays,0) from ConfigurationMaster) else 0 end )  
	GROUP BY	Sid_SalesQty,  MM_PurchaseRatio,MM_SalesRatio,  Sid_Mm_Id,  Sid_BatchNo,  Sid_SalesUomId, mm.MM_PackSize,MM.Mm_Name,  uom.Uom_Name,  MM.Mm_Code,  
				Sid_Sih_Key,   sid.Sid_SalesRate,  sid.Sid_Disc,  sid.Sid_Total,  sid.Sid_Key,  sih.Sih_No,Sid_DiscAmount,  sid.Sid_ExpDate,sid.Sid_MnfDate,sih.Sih_Pm_Id
				,Sih_IsCreditBill,   Sih_AccId,  pm.Pm_Fullname,  pm.StoreCode,  pm.Pm_Mob,  sid.Sid_PurchaseQty,  sid.Sid_PurchaseRate,  sid.Sid_PurchaseUomId,  Sid_LmId,  
				sih.Sih_Date,   sid.Sid_MRP,sid.Sid_SrNo  
				--Srd_SrhId,srd.Srd_SrNo  
	HAVING		(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) > 0  
	ORDER BY	sid.Sid_Sih_Key;  
 END;  

 ELSE  IF @SP_STATUS = 'BIND_SI'  
 BEGIN  
	SELECT		cast(sih.Sih_No as nvarchar(max)) as Sih_No ,  
				sih.Sih_Key,  
				@Srh_CustId AS Sih_CustId,  
				sih.Sih_Date,  
				sih.Sih_Total,  
				sih.Sih_IsCreditBill,  
				case when ISNULL(pm.StoreCode,'') <>'' then pm.Pm_Fullname +'('+ pm.StoreCode +')' else pm.Pm_Fullname end AS Pm_Fullname,  
				--Pm.Pm_Fullname,  
				Pm.Pm_Mob  
	FROM		dbo.SalesInvoiceHeader (NOLOCK) sih  
				INNER JOIN (SELECT		Sih_Key,  
										(SUM(ISNULL(sid1.Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)))AS PendingQty  
							FROM		dbo.SalesInvoiceHeader (NOLOCK) sih1  
										INNER JOIN dbo.SalesInvoiceItemDetail  (NOLOCK) sid1  
								ON		sih1.Sih_Key=sid1.Sid_Sih_Key  
										LEFT JOIN dbo.SalesReturnDetail  (NOLOCK) srd  
								ON		sid1.Sid_Sih_Key = srd.Sid_SihKey  
										AND sid1.Sid_Mm_Id = srd.Srd_MmId  
										AND sid1.Sid_SrNo = srd.Srd_SidSrNo  
										LEFT JOIN dbo.MedicineMaster  (NOLOCK) MM  
								ON		sid1.Sid_Mm_Id = MM.Mm_ID  
										LEFT JOIN dbo.UomMaster  (NOLOCK) uom  
								ON		sid1.Sid_SalesUomId = uom.Uom_ID  
							WHERE		(CASE WHEN sih1.Sih_IsCreditBill = 0 
												THEN sih1.Sih_AccId  
												ELSE	sih1.Sih_Pm_Id 
										END) =CASE  WHEN	sih1.Sih_IsCreditBill = 1 
													THEN (SELECT TOP 1 Lm_PVId FROM	LedgerMaster WHERE	 Lm_Id = @Srh_CustId) 
													ELSE	@Srh_CustId  
										END   
										AND  DATEDIFF(DAY, GETDATE(),ISNULL(Sid_ExpDate,getdate()) )>= ( case when isnull(Sid_ExpDate,'')!='' then  (select top 1 ISNULL(SrExpDays,0) from ConfigurationMaster) else 0 end )  
							GROUP BY	sih1.Sih_Key)AS SIPending  
   
		ON			SIPending.Sih_Key=sih.Sih_Key  
					LEFT JOIN dbo.PatientMaster  (NOLOCK) pm  
		ON			pm.Pm_Id = sih.Sih_Pm_Id  
		WHERE		PendingQty>0  
		GROUP BY	sih.Sih_No,  sih.Sih_Key,  sih.Sih_Date,  sih.Sih_Total,  sih.Sih_IsCreditBill,  Pm.Pm_Fullname,  pm.StoreCode,  Pm.Pm_Mob  
		ORDER BY	sih.Sih_Key;  
 END;  

 ELSE IF @SP_STATUS = 'SearchReturnDetail'  
 BEGIN  
	SELECT		CAST(0 AS bit) AS Chk,  
				sih.Sih_No,  
				MM.Mm_Code,  
				MM.Mm_Name,  
				MM.MM_PackSize AS Ps_Name,  
				Sid_BatchNo,  
				uom.Uom_Name,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS RemainigSalesQty,  
				(ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) AS OldStock,  
				ISNULL(sid.Sid_SalesRate, 0.00) AS Sid_SalesRate_Original, 
				ISNULL(sid.Sid_SalesRate, 0.00) / (mm.MM_SalesRatio / mm.MM_PurchaseRatio)  AS Sid_SalesRate, 
				ISNULL(sid.Sid_Disc, 0.00) AS Sid_Disc,  
				ISNULL(sid.Sid_DiscAmount, 0.00) AS Sid_DiscAmount,  
				ISNULL(sid.Sid_Total, 0.00) AS Sid_Total,  
				Sid_SalesUomId,  
				sid.Sid_PurchaseQty,  
				sid.Sid_PurchaseRate,  
				sid.Sid_PurchaseUomId,  
				Sid_Mm_Id,  
				sid.Sid_Sih_Key,  
				sid.Sid_Key,  
				sid.Sid_ExpDate,  
				sid.Sid_MnfDate,  
				@Srh_CustId AS Sih_CustId,  
				pm.Pm_Fullname AS PatientName,  
				pm.Pm_Mob AS PatientMobile,  
				sid.Sid_LmId,  
				sih.Sih_Date,
				 ISNULL(sid.Sid_MRP, 0.00) / (mm.MM_SalesRatio / mm.MM_PurchaseRatio)  AS Sid_MRP,  
				 sid.Sid_MRP AS Sid_MRP_Original  
	FROM	dbo.SalesInvoiceItemDetail  (NOLOCK) sid  
		LEFT JOIN dbo.SalesReturnDetail  (NOLOCK) srd  
	ON		sid.Sid_Key = srd.Srd_SidKey  
		AND sid.Sid_Mm_Id = srd.Srd_MmId  
		AND sid.Sid_BatchNo = srd.Srd_BatchNo  
		AND sid.Sid_SalesUomId = srd.Srd_UomId  
		LEFT JOIN dbo.MedicineMaster  (NOLOCK) MM  
	ON		sid.Sid_Mm_Id = MM.Mm_ID  
		LEFT JOIN dbo.UomMaster  (NOLOCK) uom  
	ON		sid.Sid_SalesUomId = uom.Uom_ID  
		LEFT JOIN dbo.SalesInvoiceHeader  (NOLOCK) sih  
	ON		sid.Sid_Sih_Key = sih.Sih_Key  
		LEFT JOIN dbo.PatientMaster  (NOLOCK) pm  
	ON		pm.Pm_Id = sih.Sih_Pm_Id  
	WHERE	Sih_Key=@Srh_SihKey AND---Add Hasmukh  
	CASE  
	WHEN	sih.Sih_IsCreditBill = 0 THEN sih.Sih_AccId  
	ELSE	sih.Sih_Pm_Id  
	END =  
	CASE  
	WHEN	sih.Sih_IsCreditBill = 1 THEN (SELECT TOP 1  
			 Lm_PVId  
	FROM	LedgerMaster  
	WHERE	Lm_Id = @Srh_CustId)  
	ELSE		@Srh_CustId  
	END  
	AND		Sih_Date BETWEEN @Srh_Date AND @Srh_RefDate  
	GROUP BY Sid_SalesQty,  Sid_Mm_Id,  Sid_BatchNo,  Sid_SalesUomId,  mm.MM_PackSize,  MM.Mm_Name,  uom.Uom_Name,  MM.Mm_Code,  Sid_Sih_Key,  sid.Sid_SalesRate,  
			sid.Sid_Disc,  sid.Sid_Total,  sid.Sid_Key,  sih.Sih_No,  Sid_DiscAmount,  sid.Sid_ExpDate,  sid.Sid_MnfDate,  sih.Sih_Pm_Id,  Sih_IsCreditBill,  Sih_AccId,  
			pm.Pm_Fullname,  pm.Pm_Mob,  sid.Sid_PurchaseQty, sid.Sid_PurchaseRate,  sid.Sid_PurchaseUomId,  Sid_LmId,  sih.Sih_Date,
			MM.MM_SalesRatio,MM.MM_PurchaseRatio,Sid_Mrp  
	HAVING (ISNULL(Sid_SalesQty, 0.00)) - SUM(ISNULL(srd.Srd_Qty, 0.00)) > 0  
	ORDER BY Sid_Sih_Key;  
END;  

 ELSE  
 IF @SP_STATUS = 'Retirve_Sales_Return'  
 BEGIN  
	DECLARE	 @FormPrefix_ret AS NVARCHAR(MAX) = '';  
	SELECT	 @FormPrefix_ret = FormPrefix  
	FROM	 FormDetailTable (NOLOCK)   
	WHERE	 Id = 5  
	SELECT	 Srh_Id,  
			 @FormPrefix_ret + cast(Srh_No as nvarchar(max))  as Srh_No,Srh_Date,Srh_RefNo,Srh_RefDate,Srh_SihKey,Srh_Remarks,Srh_Total,Srh_CustId,  
			 SIH.Sih_No ,LM.Lm_Name AS PM_NAME 
	 FROM	 SalesReturnHeader(NOLOCK) SR  
	      INNER JOIN SalesInvoiceHeader(NOLOCK) SIH  
	 ON		 SIH.Sih_Key=SR.Srh_SihKey  
	      LEFT JOIN  LedgerMaster (NOLOCK) LM
	  ON      LM.Lm_Id =  SR.Srh_CustId
	 WHERE	 Srh_Id = @Srh_Id 
	  
     SELECT	  SRD.Srd_Id,  SRD.Srd_SrhId,  SRD.Srd_SrNo,  SRD.Srd_MmId,  SRD.Srd_BatchNo,  SRD.Srd_UomId,  SRD.Srd_Qty,  SRD.Srd_Rate,  
			  sid.Sid_SalesRate as Sid_SalesRate_Original,----Add By Vishal   
				SRD.Srd_Amount,  SRD.Srd_Remarks,  SRD.Srd_SidKey,  MM.Mm_Code,  Mm_Name,  UOM.Uom_Code,  mm.MM_PackSize AS Ps_Name,  
			  vwTotalStk.STOCK AS Srd_StockQty,  Sid_PurchaseQty,  Sid_PurchaseUomId,  Sid_PurchaseRate,  SRd.Srd_LmId, 
			  ISNULL(sid.Sid_MRP, 0.00) / (mm.MM_SalesRatio / mm.MM_PurchaseRatio) AS Srd_MRP,
			  ISNULL(sid.Sid_MRP, 0.00)  AS Sid_MRP_Original,  
			  sid.Sid_MnfDate,  sid.Sid_ExpDate,  sid.Sid_PurchaseQty,  sid.Sid_PurchaseRate,  sid.Sid_PurchaseUomId,  sid.Sid_SrNo as Srd_SidSrNo,  
			  sid.Sid_Sih_Key  as  Sid_Sih_Key  
	 FROM		SalesReturnDetail(NOLOCK) SRD  
	 	  LEFT JOIN MedicineMaster(NOLOCK) MM  
	 ON	  	SRD.Srd_MmId = MM.Mm_ID  
	 	  LEFT JOIN UomMaster(NOLOCK) UOM  
	 ON	  	SRD.Srd_UomId = UOM.Uom_ID  
	 	  LEFT JOIN SalesInvoiceItemDetail(NOLOCK) sid  
	 ON	  	sid.Sid_Key = SRD.Srd_SidKey  
	 	  LEFT JOIN VwTotalStock(NOLOCK) vwTotalStk  
	 ON	  	vwTotalStk.STK_ITEM_ID = SRD.Srd_MmId  
	 WHERE	Srd_SrhId = @Srh_Id  
 END  
 ELSE  
 IF @SP_STATUS = 'Delete'  
 BEGIN  
	DECLARE @MSG_OUT nvarchar(max)  
	EXEC	SP_Tbl_Dependency '[SalesReturnHeader]',  
	        @Srh_Id,  
	        @MSG_OUT OUTPUT  
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')  
	 BEGIN  
	 RAISERROR (@MSG_OUT, 14, 9)  
	 END  
	ELSE  
	 BEGIN  

	 DELETE FROM [dbo].[SalesReturnHeader]  
	 WHERE		Srh_Id = @Srh_Id  
	 DELETE FROM SalesReturnDetail  
	 WHERE		Srd_SrhId = @Srh_Id  

	 DELETE		FROM StockRegister  
	 WHERE		Stk_DocKey = @Srh_Id  
			AND		Stk_DocType = 3  
	 END  
 END  
 ELSE  
 IF @SP_STATUS = 'Fill_Grid_Sales_Return'  
 BEGIN  
	DECLARE  @FormPrefix_fill_grid AS NVARCHAR(MAX) = '';  
	SELECT	 @FormPrefix_fill_grid = FormPrefix  
	FROM	 FormDetailTable (NOLOCK)   
	WHERE	 Id = 5  
	SELECT	SRH.[Srh_Id],  
			  @FormPrefix_fill_grid +  cast(SRH.[Srh_No]  as nvarchar(max))  AS Srh_No,  
			 SRH.[Srh_Date],  
			 SRH.[Srh_RefNo],  
			 SRH.[Srh_RefDate],  
			 SRH.[Srh_SihKey],  
			 SRH.[Srh_Remarks],  
			 SRH.[Srh_Total],  
			 SRH.[Srh_CreatedBy],  
			 SRH.[Srh_CreatedDate],  
			 UM.User_Name AS Srh_User,  
			 lm.Lm_Name AS Pm_Fullname,  
			 Srh_Total AS Amount,sum(ISNULL(Act_PaidAmount,0)) as Act_PaidAmount,  
			 sih.Sih_No,act.Act_Key  
	 FROM	[dbo].[SalesReturnHeader](NOLOCK) SRH  
		LEFT JOIN UserMaster(NOLOCK) UM  
	ON		UM.User_ID = SRH.Srh_CreatedBy  
		LEFT JOIN LedgerMaster(NOLOCK) lm  
	ON	    lm.Lm_Id = SRH.Srh_CustId  
		left join AccountTransaction act   
	on		Act_DocNo=SRH.Srh_No and Act_DocKey=SRH.Srh_Id and Act_DocType=3  
		left join SalesInvoiceHeader sih  
	 on		sih.Sih_Key=SRH.Srh_SihKey  
	WHERE	Srh_BranchId = @Srh_BranchId  
	AND		Srh_YearId = @Srh_YearId  
	and convert(date,Srh_Date) BETWEEN  convert(date,@Srh_StartDate) and convert(date,@Srh_EndDate)  
	group by Srh_Id,  
			cast(SRH.[Srh_No]  as nvarchar(max)) ,  
			SRH.[Srh_Date],  
			SRH.[Srh_RefNo],  
			SRH.[Srh_RefDate],  
			SRH.[Srh_SihKey],  
			SRH.[Srh_Remarks],  
			SRH.[Srh_Total],  
			SRH.[Srh_CreatedBy],  
			SRH.[Srh_CreatedDate],  
			UM.User_Name,  
			lm.Lm_Name ,  
			Srh_Total ,  
			sih.Sih_No,act.Act_Key  
	ORDER BY SRH.[Srh_Id] DESC  
 END  
 IF @SP_STATUS = 'Insert'  
 BEGIN  
	SELECT	@Srh_Id = ISNULL(MAX(Srh_Id), 0) + 1  
	FROM	SalesReturnHeader(NOLOCK);  
	SELECT  @Srh_No =  [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Srh_No,0)))  
	FROM	SalesReturnHeader (NOLOCK)  
	WHERE	SalesReturnHeader.Srh_Date BETWEEN @FROM_DATE AND @TO_DATE
	  
	INSERT INTO [dbo].[SalesReturnHeader] (  
			[Srh_Id],[Srh_No],[Srh_Date],[Srh_RefNo],[Srh_RefDate],[Srh_SihKey],[Srh_Remarks],[Srh_BranchId],[Srh_YearId],Srh_CreatedBy,Srh_CreatedDate,Srh_Total,Srh_CustId )  
	VALUES	(@Srh_Id, @Srh_No, @Srh_Date, @Srh_RefNo, @Srh_RefDate, @Srh_SihKey, @Srh_Remarks, @Srh_BranchId, @Srh_YearId, @USER, GETDATE(), @Srh_Total, @Srh_CustId);  
	SELECT	@ID = @Srh_Id;  
 END;  
 ELSE  
 IF @SP_STATUS = 'FillClient'  
 BEGIN  
	--select    0 as  Pm_Id,'--Select One---' as Name  union  
	--select   pm.Pm_Id, pm.Pm_Fullname as Name from SalesInvoiceHeader srh   
	--left join PatientMaster pm on srh.Sih_Pm_Id=pm.Pm_Id  
	--Where  ISNULL(pm.Pm_Fullname,'') <> ''  

	SELECT 0 AS Pm_Id,  '--Select One---' AS Name  
	UNION  
	SELECT	A.Lm_Id AS Pm_Id,  
	case when ISNULL(B.StoreCode,'') <> '' then B.Pm_Fullname +'('+ B.StoreCode +')' else case when ISNULL(B.Pm_Fullname,'') <> '' then B.Pm_Fullname else A.Lm_Name end end AS Name  
	FROM	LedgerMaster (NOLOCK) as A  
	LEFT JOIN PatientMaster as B  
	ON		A.Lm_Id=B.Pm_Ledger_Id  
	WHERE	Lm_GroupId = 46  

 END  
 ELSE  
 IF @SP_STATUS = 'GetSalesInvoiceDetail'  
 BEGIN  
	SELECT	sih.*, lm.Lm_Id  
	FROM	SalesInvoiceHeader  (NOLOCK) sih  
			LEFT JOIN LedgerMaster  (NOLOCK) lm  
	ON		sih.Sih_Pm_Id = lm.Lm_PVId  
	WHERE	Sih_Key = @Srd_SrhId  
 END

 ELSE  IF   @SP_STATUS  =  'help_ClientDetails'
 BEGIN
 --   SELECT	A.Lm_Id AS Pm_Id,  
	--		case when ISNULL(B.StoreCode,'') <> '' then B.Pm_Fullname +'('+ B.StoreCode +')' else case when ISNULL(B.Pm_Fullname,'') <> '' then B.Pm_Fullname else A.Lm_Name end end AS PatientName
	--		,B.Pm_Mob as mobile, B.Pm_EmailId as  Email,  B.Pm_Address as Address
	--FROM	LedgerMaster (NOLOCK) as A  
	--		LEFT JOIN PatientMaster as B  
	--ON --A.Lm_Id=B.Pm_Ledger_Id     and
	--		A.Lm_PVId  = B. Pm_Id 
	--WHERE Lm_GroupId = 46  


	SELECT			A.Lm_Id AS Pm_Id,  
					ISNULL(B.StoreCode,'') as StoreCode,
	CASE WHEN		ISNULL(B.StoreCode,'') <> '' then B.Pm_Fullname +'('+ B.StoreCode +')' else case when ISNULL(B.Pm_Fullname,'') <> '' then B.Pm_Fullname else A.Lm_Name end end AS PatientName
					,B.Pm_Mob as mobile, B.Pm_EmailId as  Email,  B.Pm_Address as Address,B.Contact_PersonName,
					B.Pm_Ledger_Id   
	FROM			LedgerMaster (NOLOCK) as A  
				LEFT JOIN PatientMaster as B  
	ON				A.Lm_Id=B.Pm_Ledger_Id        
					--A.Lm_PVId  = B. Pm_Id 
	WHERE			Lm_GroupId = 46
 END
   
 ELSE 
 IF @SP_STATUS = 'Update'  
 BEGIN  
	DECLARE	@MSG_OUT_update nvarchar(max)  
	EXEC	SP_Tbl_Dependency 'SalesReturnHeader',  
	        @Srh_Id,  
	        @MSG_OUT_update OUTPUT  
	IF (RTRIM(LTRIM(@MSG_OUT_update)) <> '')  
		BEGIN  
			RAISERROR (@MSG_OUT_update, 14, 9)  
		END  
	ELSE  
	 BEGIN  
		UPDATE [dbo].[SalesReturnHeader]  
		SET --[Srh_No] = @Srh_No,  
			[Srh_Date] = @Srh_Date,  
			[Srh_RefNo] = @Srh_RefNo,  
			[Srh_RefDate] = @Srh_RefDate,  
			[Srh_SihKey] = @Srh_SihKey,  
			[Srh_Remarks] = @Srh_Remarks,  
			[Srh_BranchId] = @Srh_BranchId,  
			[Srh_YearId] = @Srh_YearId,  
			[Srh_UpdatedBy] = @USER,  
			[Srh_UpdatedDate] = GETDATE(),  
			Srh_Total = @Srh_Total,  
			Srh_CustId = @Srh_CustId  
		WHERE [Srh_Id] = @Srh_Id;  

		DELETE FROM SalesReturnDetail  WHERE Srd_SrhId = @Srh_Id;  
		DELETE FROM dbo.StockRegister  WHERE Stk_DocKey = @Srh_Id  AND Stk_DocType = @Srh_RefNo;  
		DELETE FROM dbo.TaxTransaction	WHERE Tr_DocId=@Srh_Id  and  Tr_DocTyp= @Srh_RefNo;

		SELECT @ID = @Srh_Id;  
	END;  
 END  
 ELSE  
 IF @SP_STATUS = 'GetLedgerId'  
 BEGIN  
	SELECT Lm_Id  
	FROM   LedgerMaster  
	WHERE  Lm_PVId = @Srh_CustId;  
 END;  
 ELSE  
 IF @SP_STATUS = 'InsertDetail'  
 BEGIN  
	SELECT	@Srd_Id = ISNULL(MAX(Srd_Id), 0) + 1  
	FROM	SalesReturnDetail  (NOLOCK) ;  
	INSERT INTO [dbo].[SalesReturnDetail] (  
			[Srd_Id],[Srd_SrhId],[Srd_SrNo],[Srd_MmId],[Srd_BatchNo],[Srd_UomId],[Srd_Qty],[Srd_Rate],[Srd_Amount],[Srd_Remarks],Srd_SidKey,Srd_LmId,Srd_SidSrNo,Sid_SihKey)  
	VALUES	(@Srd_Id, @Srd_SrhId, @Srd_SrNo, @Srd_MmId, ISNULL(@Srd_BatchNo,''), @Srd_UomId, @Srd_Qty, @Srd_Rate, @Srd_Amount, @Srd_Remarks, @Srd_SidKey, @Srd_LmId,@Srd_SidSrNo,@Sid_SihKey);  
	SELECT	@ID=@Srd_Id  
 END;  
 ELSE IF @SP_STATUS ='GET_SR_NO'  
 BEGIN  
    SELECT	srh.Srh_No  FROM SalesReturnHeader (nolock) srh  
    WHERE	srh.[Srh_Id] = @Srh_Id;  
 END  
 ELSE IF @SP_STATUS ='GetInvoiceDetail'  
 BEGIN  
    SELECT	* FROM SalesReturnHeader (nolock) srh  
    WHERE	srh.[Srh_Id] = @Srh_Id;  
 END  
 ELSE IF @SP_STATUS ='CheckEntryFromWhich'  
 BEGIN  
    SELECT * FROM AccountTransactionRef (nolock)   
    WHERE	 Acr_ActKey = @Srh_Id;  
 END
 ELSE IF @SP_STATUS = 'SYNCH_UPDATE'-----Update Synch Status ---Add Hasmukh  
 BEGIN  
      UPDATE SalesReturnHeader  
      SET	Srh_IsSync='true',   
			Srh_LastSyncDate=GETDATE()  
    WHERE	@Srh_Id=@Srh_Id 
    SELECT	@ID=@Srh_Id;  
 END 
 ELSE IF @SP_STATUS = 'GetItemDetailOriginal'
	BEGIN
		--SELECT sid.Srd_ID
		--	,sid.Srd_SrhId
		--	,sid.Srd_SrNo
		--	,sid.Srd_MmId
		--	,mm.Mm_HsnCode AS sid_HsnCode
		--	,sh.Srh_No
		--	--,sid.Sid_PackId,
		--	--sid.SRd_MRP
		--	,sid.Srd_BatchNo
		--	--,sid.SRd_ExpDate
		--	,sid.Srd_Qty AS Sid_Qty
		--	,sid.Srd_Rate AS Sid_Rate
		--	--,sid.Sid_SubTotal
		--	,sid.Srd_Amount
		--	--,sid.Sid_MnfDate
		--	--,sid.SRd_Disc
		--	--,sid.Sid_DiscAmount
		--	,mm.Mm_Name AS MedicineName
		--	,pm.Pm_Fullname AS Sih_PatientName
		--	,pm.Pm_Mob AS Sih_PatientMob
		--	,dm.Dm_Name AS Sih_DoctorName
		--	,sh.Srh_Date
		--	--,sh.SRh_DiscAmount
		--	--,sh.Sih_SubTotal
		--	,sh.Srh_Total
		--	--,ISNULL(sh.Sih_IsOriginal, 0) AS Sih_IsOriginal
		--	--,
		--	--'ORIGINAL' AS Print_Status
		--	,0.00 AS OtherBrandRate
		--	,BM.Branch_Name
		--	,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
		--	,BM.Branch_Logo AS BranchLogo
		--	,BM.Branch_GstNo AS BranchGSTNO
		--	,CM.City_Name AS BranchCity
		--	,mm.MM_PackSize AS sid_PackSize
		--	,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
		--	,TAX.SGST
		--	,TAX.CGST
		--	,TAX.IGST
		--	,CASE WHEN sIh.Sih_BookId = 3 THEN 'GST Invoice' ELSE 'Bill of Supply' END BillType
		--FROM dbo.SalesReturnDetail(NOLOCK) sid
		--LEFT JOIN TaxTransaction(NOLOCK) STAX ON sid.Srd_Id = STAX.Tr_DdocKey
		--	AND sid.Srd_Srhid = STAX.Tr_DocKey
		--	AND STAX.Tr_TxId = 2
		--	AND STAX.Tr_DocTyp = 3
		--LEFT JOIN TaxTransaction(NOLOCK) CTAX ON sid.Srd_Id = CTAX.Tr_DdocKey
		--	AND sid.Srd_Srhid = CTAX.Tr_DocKey
		--	AND CTAX.Tr_DocTyp = 2
		--	AND CTAX.Tr_TxId = 3
		--LEFT JOIN TaxTransaction(NOLOCK) ITAX ON sid.Srd_Id = ITAX.Tr_DdocKey
		--	AND sid.Srd_Srhid = ITAX.Tr_DocKey
		--	AND ITAX.Tr_DocTyp = 2
		--	AND ITAX.Tr_TxId = 3
		--LEFT JOIN dbo.SalesReturnHeader(NOLOCK) sh ON sid.Srd_SrhId = sh.Srh_id
		--LEFT JOIN (
		--SELECT SIH.Srh_Id
		--		,SUM(SSTAX.Tr_TxTot) AS SGST
		--		,SUM(CCTAX.Tr_TxTot) AS CGST
		--		,SUM(IITAX.Tr_TxTot) AS IGST
		--FROM dbo.SalesReturnDetail(NOLOCK) SID1
		--INNER JOIN SalesReturnHeader SIH
		--ON SIH.Srh_Id=SID1.Srd_Srhid
		--LEFT JOIN TaxTransaction(NOLOCK) SSTAX 
		--ON SID1.Srd_Id = SSTAX.Tr_DdocKey
		--	AND SID1.Srd_SrhId = SSTAX.Tr_DocKey
		--	AND SSTAX.Tr_TxId = 2
		--	AND SSTAX.Tr_DocTyp = 3
		--LEFT JOIN TaxTransaction(NOLOCK) CCTAX 
		--ON SID1.Srd_Id = CCTAX.Tr_DdocKey
		--	AND SID1.Srd_Srhid = CCTAX.Tr_DocKey
		--	AND CCTAX.Tr_DocTyp = 3
		--	AND CCTAX.Tr_TxId = 3
		--LEFT JOIN TaxTransaction(NOLOCK) IITAX 
		--ON SID1.Srd_Id = IITAX.Tr_DdocKey
		--	AND SID1.Srd_Srhid = IITAX.Tr_DocKey
		--	AND IITAX.Tr_DocTyp = 3
		--	AND IITAX.Tr_TxId = 4
		--GROUP BY SIH.Srh_Id
		--	) AS TAX ON sh.Srh_Id = TAX.Srh_Id
		--LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Srd_MmId = mm.Mm_ID
		--LEFT JOIN dbo.SalesInvoiceHeader as sih ON sih.sih_KEy=sh.Srh_SihKey 
		--LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON sih.Sih_Pm_Id = pm.Pm_Id
		--LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON sih.Sih_Dm_Id = dm.Dm_Id
		--LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON sih.Sih_BranchId = BM.Branch_Id
		--LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID

		SELECT		SRD.Srd_Id AS Sid_Key ,SRD.Srd_SrhId  AS Sid_Sih_Key ,SRD.Srd_SrNo AS Sid_SrNo ,SRD.Srd_MmId AS Sid_Mm_Id,
					mm.Mm_HsnCode AS sid_HsnCode ,SRH.Srh_No AS Sih_No ,Sid_SalesRate AS Sid_MRP ,SID.Sid_BatchNo
           ,(CASE WHEN ISNULL(SID.Sid_ExpDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,SID.Sid_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,SID.Sid_ExpDate)),2) 
			END)AS Sid_ExpDate
           ,SRD.Srd_Qty AS Sid_Qty
           ,SID.Sid_SalesRate AS Sid_Rate
		   ,Sih_Total AS Tax_SrhAmt
           ,SRD.Srd_Amount AS Sid_SubTotal
           ,SRD.Srd_Amount AS Sid_Total
           ,(CASE WHEN ISNULL(SID.Sid_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,SID.Sid_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,SID.Sid_MnfDate)),2) 
			END)AS Sid_MnfDate
           ,0 AS Sid_Disc
           ,0 AS Sid_DiscAmount
           ,mm.Mm_Name AS MedicineName
           ,pm.Pm_Fullname AS Sih_PatientName
           ,pm.Pm_Mob AS Sih_PatientMob
           ,dm.Dm_Name AS Sih_DoctorName
           ,SRH.Srh_Date AS Sih_Date
           ,0 Sih_DiscAmount
           ,0 Sih_SubTotal
           ,SRH.Srh_Total AS Sih_Total
           ,0 AS Sih_IsOriginal
           ,'ORIGINAL' AS Print_Status
           ,0.00 AS OtherBrandRate
                        ,BM.Branch_Name
                        ,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
                        ,BM.Branch_Logo AS BranchLogo
                        ,BM.Branch_GstNo AS BranchGSTNO
                        ,CM.City_Name AS BranchCity
                        ,mm.MM_PackSize AS sid_PackSize
						,TTX.TXTOT AS TAX
						--,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
                        ,TAX.SGST
                        ,TAX.CGST
                        ,TAX.IGST
						,ROUND((SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 2 AND Tr_DocKey = @Srd_SrhId AND Tr_DDocKey = SRD.Srd_Id AND Tr_DocTyp = 3),2) AS ItmCGST
						,ROUND((SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 3 AND Tr_DocKey = @Srd_SrhId AND Tr_DDocKey = SRD.Srd_Id AND Tr_DocTyp = 3),2) AS ItmSGST
						,ROUND((SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 4 AND Tr_DocKey = @Srd_SrhId AND Tr_DDocKey = SRD.Srd_Id AND Tr_DocTyp = 3),2) AS ItmIGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 2 AND Tr_DocId = @Srd_SrhId) AS ItmCGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 3 AND Tr_DocId = @Srd_SrhId) AS ItmSGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 4 AND Tr_DocId = @Srd_SrhId) AS ItmIGST
                        ,CASE 
                                WHEN SIH.Sih_BookId = 3
                                        THEN 'GST Invoice'
                                ELSE 'Bill of Supply'
                                END BillType
                                
		FROM SalesReturnDetail SRD
		INNER JOIN SalesInvoiceItemDetail SID
		ON SID.Sid_Key=SRD.Srd_SidKey
		LEFT JOIN TaxTransaction(NOLOCK) STAX ON SID.Sid_Key = STAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = STAX.Tr_DocKey
			AND STAX.Tr_TxId = 2
			AND STAX.Tr_DocTyp = 3
		LEFT JOIN TaxTransaction(NOLOCK) CTAX ON SID.Sid_Key = CTAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = CTAX.Tr_DocKey
			AND CTAX.Tr_DocTyp = 3
			AND CTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) ITAX ON SID.Sid_Key = ITAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = ITAX.Tr_DocKey
			AND ITAX.Tr_DocTyp = 3
			AND ITAX.Tr_TxId = 4
		LEFT JOIN SalesReturnHeader(NOLOCK) SRH ON SRH.Srh_Id = SRD.Srd_SrhId
		LEFT JOIN (SELECT SRH1.Srh_Id,SRD1.Srd_Id
				   ,ISNULL(SUM(SSTAX.Tr_TxTot),0) AS SGST
				   ,ISNULL(SUM(CCTAX.Tr_TxTot),0) AS CGST
				   ,ISNULL(SUM(IITAX.Tr_TxTot),0) AS IGST
				   FROM 
				   SalesReturnDetail(NOLOCK) SRD1
				   INNER JOIN SalesReturnHeader SRH1
				   ON SRH1.Srh_Id=SRD1.Srd_SrhId
				   LEFT JOIN 
				   TaxTransaction(NOLOCK) SSTAX ON SRD1.Srd_Id = SSTAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = SSTAX.Tr_DocKey
				   AND SSTAX.Tr_TxId = 2
				   AND SSTAX.Tr_DocTyp = 3
				   LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SRD1.Srd_Id = CCTAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = CCTAX.Tr_DocKey
				   AND CCTAX.Tr_DocTyp = 3
				   AND CCTAX.Tr_TxId = 3
				   LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SRD1.Srd_Id = IITAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = IITAX.Tr_DocKey
				   AND IITAX.Tr_DocTyp = 3
				   AND IITAX.Tr_TxId = 4
				   GROUP BY SRH1.Srh_Id,SRD1.Srd_Id
				   ) AS TAX ON SRH.Srh_Id = TAX.Srh_Id AND TAX.Srd_Id = SRD.Srd_Id
		LEFT JOIN (select Tr_DocId,Tr_DocTyp,Tr_DocKey,Tr_DdocKey,SUM(Tr_TxTot) AS TXTOT FROM TaxTransaction WHERE Tr_DocTyp = 3 AND Tr_TxId > 1
GROUP BY Tr_DocId,Tr_DocTyp,Tr_DocKey,Tr_DdocKey) AS TTX ON TTX.Tr_DocKey = SRD.Srd_SrhId AND TTX.Tr_DdocKey = SRD.Srd_Id
		LEFT JOIN SalesInvoiceHeader(NOLOCK) SIH ON  SIH.Sih_Key=SID.Sid_Sih_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON SIH.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON SIH.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON SIH.Sih_BranchId = BM.Branch_Id
		LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
		WHERE SRD.Srd_SrhId = @Srd_SrhId;

		SELECT		CASE WHEN Tr_TxType = 'I' THEN 'IGST'
					WHEN Tr_TxType = 'S' THEN 'SGST'
					WHEN Tr_TxType = 'C' THEN 'CGST' END AS Tax_Type,
					Tr_TxVal AS Tax_Perc, ROUND(SUM(Tr_TxTot),2) AS Tax_Total,
					(SELECT SUM(Tr_TxTot) FROM TaxTransaction WHERE Tr_TxType = 'A' AND Tr_DocTyp = 3 AND Tr_DocKey = @Srd_SrhId) AS Tax_SrhAmt
		FROM		TaxTransaction (NOLOCK)
		WHERE		Tr_DocTyp = 3
				AND Tr_DocKey = @Srd_SrhId
		GROUP BY	CASE WHEN Tr_TxType = 'I' THEN 'IGST'
						 WHEN Tr_TxType = 'S' THEN 'SGST'
						 WHEN Tr_TxType = 'C' THEN 'CGST' END, Tr_TxVal
		HAVING		Tr_TxVal > 0
		ORDER BY	Tr_TxVal 
	END; 
	 ELSE IF @SP_STATUS = 'GetItemDetailOriginalPOS'
	BEGIN
		SELECT	SRD.Srd_Id AS Sid_Key ,
				SRD.Srd_SrhId  AS Sid_Sih_Key ,
				SRD.Srd_SrNo AS Sid_SrNo ,
				SRD.Srd_MmId AS Sid_Mm_Id,
				mm.Mm_HsnCode AS sid_HsnCode ,
				SRH.Srh_No AS Sih_No ,
				Sid_MRP AS Sid_MRP ,
				SID.Sid_BatchNo
				,(CASE WHEN ISNULL(SID.Sid_ExpDate,'')=''
					THEN ''
					ELSE  convert(varchar,datepart(mm,SID.Sid_ExpDate))+'/'+RIGHT(convert(varchar,datepart(year,SID.Sid_ExpDate)),2)  
			END)AS Sid_ExpDate
				,SRD.Srd_Qty AS Sid_Qty
				,SID.Sid_MRP AS Sid_Rate
				,Sih_Total AS Tax_SrhAmt
				,Srd_Amount AS Sid_SubTotal
           ,0 AS Sid_Total
           ,(CASE WHEN ISNULL(SID.Sid_MnfDate,'')=''
					THEN ''
					ELSE convert(varchar,datepart(mm,SID.Sid_MnfDate))+'/'+RIGHT(convert(varchar,datepart(year,SID.Sid_MnfDate)),2)
			END)AS Sid_MnfDate
           ,0 AS Sid_Disc
           ,0 AS Sid_DiscAmount
           ,mm.Mm_Name AS MedicineName
           ,pm.Pm_Fullname AS Sih_PatientName
           ,pm.Pm_Mob AS Sih_PatientMob
           ,dm.Dm_Name AS Sih_DoctorName
           ,SRH.Srh_Date AS Sih_Date
           ,0 Sih_DiscAmount
           ,0 Sih_SubTotal
           ,SRH.Srh_Total AS Sih_Total
           ,0 AS Sih_IsOriginal
           ,'ORIGINAL' AS Print_Status
           ,0.00 AS OtherBrandRate
                        ,BM.Branch_Name
                        ,BM.Branch_Address1 + ' ' + BM.Branch_Address2 + ' ' + BM.Branch_Address3 AS BranchAddress
                        ,BM.Branch_Logo AS BranchLogo
                        ,BM.Branch_GstNo AS BranchGSTNO
                        ,CM.City_Name AS BranchCity
                        ,mm.MM_PackSize AS sid_PackSize
						,TTX.TXTOT AS TAX
						--,(ISNULL(STAX.Tr_TxTot, 0) + ISNULL(CTAX.Tr_TxTot, 0) + ISNULL(ITAX.Tr_TxTot, 0)) AS TAX
                        ,TAX.SGST
                        ,TAX.CGST
                        ,TAX.IGST
						,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 2 AND Tr_DocKey = @Srd_SrhId AND Tr_DocTyp = 3) AS ItmCGST
						,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 3 AND Tr_DocKey = @Srd_SrhId AND Tr_DocTyp = 3) AS ItmSGST
						,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 4 AND Tr_DocKey = @Srd_SrhId AND Tr_DocTyp = 3) AS ItmIGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 2 AND Tr_DocId = @Srd_SrhId) AS ItmCGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 3 AND Tr_DocId = @Srd_SrhId) AS ItmSGST
						--,(SELECT SUM(Tr_TxTot) FROM TaxTransaction (NOLOCK) WHERE Tr_TxId = 4 AND Tr_DocId = @Srd_SrhId) AS ItmIGST
                        ,CASE 
                                WHEN SIH.Sih_BookId = 3
                                        THEN 'GST Invoice'
                                ELSE 'Bill of Supply'
                                END BillType
                                
		FROM SalesReturnDetail SRD
		INNER JOIN SalesInvoiceItemDetail SID
		ON SID.Sid_Key=SRD.Srd_SidKey
		LEFT JOIN TaxTransaction(NOLOCK) STAX ON SID.Sid_Key = STAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = STAX.Tr_DocKey
			AND STAX.Tr_TxId = 2
			AND STAX.Tr_DocTyp = 3
		LEFT JOIN TaxTransaction(NOLOCK) CTAX ON SID.Sid_Key = CTAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = CTAX.Tr_DocKey
			AND CTAX.Tr_DocTyp = 3
			AND CTAX.Tr_TxId = 3
		LEFT JOIN TaxTransaction(NOLOCK) ITAX ON SID.Sid_Key = ITAX.Tr_DdocKey
			AND SID.Sid_Sih_Key = ITAX.Tr_DocKey
			AND ITAX.Tr_DocTyp = 3
			AND ITAX.Tr_TxId = 4
		LEFT JOIN SalesReturnHeader(NOLOCK) SRH ON SRH.Srh_Id = SRD.Srd_SrhId
		LEFT JOIN (SELECT SRH1.Srh_Id,SRD1.Srd_Id
				   ,ISNULL(SUM(SSTAX.Tr_TxTot),0) AS SGST
				   ,ISNULL(SUM(CCTAX.Tr_TxTot),0) AS CGST
				   ,ISNULL(SUM(IITAX.Tr_TxTot),0) AS IGST
				   FROM 
				   SalesReturnDetail(NOLOCK) SRD1
				   INNER JOIN SalesReturnHeader SRH1
				   ON SRH1.Srh_Id=SRD1.Srd_SrhId
				   LEFT JOIN 
				   TaxTransaction(NOLOCK) SSTAX ON SRD1.Srd_Id = SSTAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = SSTAX.Tr_DocKey
				   AND SSTAX.Tr_TxId = 2
				   AND SSTAX.Tr_DocTyp = 3
				   LEFT JOIN TaxTransaction(NOLOCK) CCTAX ON SRD1.Srd_Id = CCTAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = CCTAX.Tr_DocKey
				   AND CCTAX.Tr_DocTyp = 3
				   AND CCTAX.Tr_TxId = 3
				   LEFT JOIN TaxTransaction(NOLOCK) IITAX ON SRD1.Srd_Id = IITAX.Tr_DdocKey
				   AND SRD1.Srd_SrhId = IITAX.Tr_DocKey
				   AND IITAX.Tr_DocTyp = 3
				   AND IITAX.Tr_TxId = 4
				   GROUP BY SRH1.Srh_Id,SRD1.Srd_Id
				   ) AS TAX ON SRH.Srh_Id = TAX.Srh_Id AND TAX.Srd_Id = SRD.Srd_Id
		LEFT JOIN (select Tr_DocId,Tr_DocTyp,Tr_DocKey,Tr_DdocKey,SUM(Tr_TxTot) AS TXTOT FROM TaxTransaction WHERE Tr_DocTyp = 3 AND Tr_TxId > 1
GROUP BY Tr_DocId,Tr_DocTyp,Tr_DocKey,Tr_DdocKey) AS TTX ON TTX.Tr_DocKey = SRD.Srd_SrhId AND TTX.Tr_DdocKey = SRD.Srd_Id
		LEFT JOIN SalesInvoiceHeader(NOLOCK) SIH ON  SIH.Sih_Key=SID.Sid_Sih_Key
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Sid_Mm_Id = mm.Mm_ID
		LEFT JOIN dbo.PatientMaster(NOLOCK) pm ON SIH.Sih_Pm_Id = pm.Pm_Id
		LEFT JOIN dbo.DoctorMaster(NOLOCK) dm ON SIH.Sih_Dm_Id = dm.Dm_Id
		LEFT JOIN dbo.BranchMaster(NOLOCK) BM ON SIH.Sih_BranchId = BM.Branch_Id
		LEFT JOIN dbo.CityMaster(NOLOCK) CM ON BM.Branch_CityId = CM.City_ID
		WHERE SRD.Srd_SrhId = @Srd_SrhId;

		SELECT		CASE WHEN Tr_TxType = 'A' THEN 'IGST'
					WHEN Tr_TxType = 'S' THEN 'SGST'
					WHEN Tr_TxType = 'C' THEN 'CGST' END AS Tax_Type,
					Tr_TxVal AS Tax_Perc, SUM(Tr_TxTot) AS Tax_Total,
					(SELECT SUM(Tr_TxTot) FROM TaxTransaction WHERE Tr_TxType = 'A' AND Tr_DocTyp = 3 AND Tr_DocKey = @Srd_SrhId) AS Tax_SrhAmt
		FROM		TaxTransaction (NOLOCK)
		WHERE		Tr_DocTyp = 3
				AND Tr_DocKey = @Srd_SrhId
		GROUP BY	CASE WHEN Tr_TxType = 'A' THEN 'IGST'
						 WHEN Tr_TxType = 'S' THEN 'SGST'
						 WHEN Tr_TxType = 'C' THEN 'CGST' END, Tr_TxVal
		HAVING		Tr_TxVal > 0
		ORDER BY	Tr_TxVal 
	END; 
 ELSE IF @SP_STATUS = 'SalesReturnHeaderReport'
	BEGIN
		SELECT		SRH.Srh_No,
					SRH.Srh_Date,
					pm.Pm_Fullname,
					SUM(SRD.Srd_Amount)AS SubTotal,
					SUM(TaxAmount)AS TaxAmount,
					SRH.Srh_Total
		FROM		SalesReturnHeader SRH
					INNER JOIN SalesReturnDetail SRD
		ON			SRD.Srd_SrhId=SRH.Srh_Id
					INNER JOIN(SELECT		A.Srd_SrhId,
											A.Srd_Id,
											A.Srd_Amount,
											(ISNULL(SUM(B.Tr_TxTot),0)+ISNULL(SUM(C.Tr_TxTot),0)+ISNULL(SUM(D.Tr_TxTot),0))AS TaxAmount 
								FROM		SalesReturnDetail  A
											LEFT JOIN TaxTransaction B
	                    		ON			A.Srd_Id = B.Tr_DdocKey
	                    					AND A.Srd_SrhId = B.Tr_DocKey
	                    					AND B.Tr_TxId = 2
	                    					AND B.Tr_DocTyp = 3
											LEFT JOIN TaxTransaction C
	                    		ON			A.Srd_Id = C.Tr_DdocKey
	                    					AND A.Srd_SrhId = C.Tr_DocKey
	                    					AND C.Tr_DocTyp = 3
	                    					AND C.Tr_TxId = 3
											LEFT JOIN TaxTransaction D
	                    		ON			A.Srd_Id = D.Tr_DdocKey
	                    					AND A.Srd_SrhId = D.Tr_DocKey
	                    					AND D.Tr_DocTyp = 3
	                    					AND D.Tr_TxId = 4 
											GROUP BY A.Srd_SrhId,
													 A.Srd_Id,
													 A.Srd_Amount )AS SRTax
		  ON		SRTax.Srd_Id=SRD.Srd_Id
					INNER JOIN SalesInvoiceHeader SIH
		  ON		SIH.Sih_Key = SRH.Srh_SihKey
					INNER JOIN PatientMaster PM
	      ON		PM.Pm_Id = SIH.Sih_Pm_Id
		  WHERE		Srh_Date BETWEEN CAST(@Srh_StartDate AS DATE) AND CAST(@Srh_EndDate AS DATE)
		  GROUP BY	SRH.Srh_No,
					SRH.Srh_Date,
					pm.Pm_Fullname,
					SRH.Srh_Total
					
	END
GO
/****** Object:  StoredProcedure [dbo].[SP_StockIn]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 28-2-2019
-- Description:	For Stock in.
-- =============================================
CREATE PROCEDURE [dbo].[SP_StockIn] 
@sp_status		varchar(200)	='',
@Stih_Key		bigint			=0,
@Stih_No		numeric(18, 0)	=0,
@Stih_Date		datetime		=NULL,
@Stih_Stot_Key	bigint			=0,
@Stih_YearId	int				=0,
@User			int				=0,
@Stih_Status	varchar(100)	='',
@Stih_Remarks	varchar(5000)	='',


@Stid_Key			bigint			=0,
@Stid_Stih_Key		bigint			=0,
@Stid_MmId			numeric(18, 0)	=0,
@Stid_BatchNo		varchar(500)	='',
@Stid_MnfDate		date			=NULL,
@Stid_ExpDate		date			=NULL,
@Stid_SalesQty		numeric(18, 2)	=0,
@Stid_SalesRate		numeric(18, 2)	=0,
@Stid_SalesUom		int				=0,
@Stid_Mrp			numeric(18, 2)	=0,
@Stid_PurchaseQty	numeric(18, 2)	=0,
@Stid_PurchaseUom	int				=0,
@Stid_PurchaseRate	numeric(18, 2)	=0,
@Stid_LmId			int				=0,
@ID				int = 0 OUT
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	if @sp_status='insert_header'
	begin
		
		SELECT @Stih_Key = ISNULL(MAX(Stih_Key), 0) + 1 FROM StockInHeader(NOLOCK);
		SELECT @Stih_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stih_No, 0))) FROM StockInHeader(NOLOCK)
		WHERE	StockInHeader.Stih_Date BETWEEN @FROM_DATE AND @TO_DATE
		insert into StockInHeader
		(		
				Stih_Key,Stih_No,Stih_Date,
				Stih_Stot_Key,Stih_YearId,Stih_CreatedBy,
				Stih_CreatedOn,Stih_Status,Stih_Remarks
		)
		values
		(
				@Stih_Key,@Stih_No,@Stih_Date,
				@Stih_Stot_Key,@Stih_YearId,@User,
				GETDATE(),'Pending',@Stih_Remarks
		)
		SELECT @ID = @Stih_Key;
	end
	else if @sp_status='mark_temp_done'
	begin
		update StockOutHeader_Temp
		Set tStoh_Status='Done'
		where tStoh_Key=@Stih_Stot_Key;
		Set @ID=1;
		SELECT @ID; 
	end
	else if @sp_status='insert_detail'
	begin
		SELECT @Stid_Key = ISNULL(MAX(Stid_Key), 0) + 1 FROM StockInDetail(NOLOCK);
		insert into StockInDetail
		(		
			Stid_Key,
			Stid_Stih_Key,
			Stid_MmId,
			Stid_BatchNo,
			Stid_MnfDate,
			Stid_ExpDate,
			Stid_SalesQty,
			Stid_SalesRate,
			Stid_SalesUom,
			Stid_Mrp,
			Stid_PurchaseQty,
			Stid_PurchaseUom,
			Stid_PurchaseRate,
			Stid_LmId
		)
		values
		(
			@Stid_Key,
			@Stid_Stih_Key,
			@Stid_MmId,
			@Stid_BatchNo,
			@Stid_MnfDate,
			@Stid_ExpDate,
			@Stid_SalesQty,
			@Stid_SalesRate,
			@Stid_SalesUom,
			@Stid_Mrp,
			@Stid_PurchaseQty,
			@Stid_PurchaseUom,
			@Stid_PurchaseRate,
			@Stid_LmId
		)
		SELECT @ID = @Stid_Key;
	end
	else if @sp_status='FillGrid'
	begin
		select A.*,B.User_Name as createdby
		from StockInHeader as A
		LEFT Join UserMaster as B
		ON A.Stih_CreatedBy=B.User_ID
	end
	else if @sp_status='retrive_data'
	begin
		DECLARE	 @FormPrefix_ret AS NVARCHAR(MAX) = '';  
		SELECT	 @FormPrefix_ret = FormPrefix  
		FROM	 FormDetailTable (NOLOCK)   
		WHERE	 Id = 19  

		select *,@FormPrefix_ret + cast(Stih_No as nvarchar(max)) as Srh_No1, StockOutHeader_Temp.tStoh_cStoh_From
		from StockInHeader
		left join StockOutHeader_Temp
		on StockInHeader.Stih_Stot_Key=StockOutHeader_Temp.tStoh_Key
		Where Stih_Key=@Stih_Key
	end

	ELSE IF @SP_STATUS = 'AutogenerateNo'
	BEGIN
		DECLARE @FormPrefix AS NVARCHAR(max) = '';
		SELECT @FormPrefix = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 19
		SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stih_No, 0)))
		FROM StockInHeader(NOLOCK)
		WHERE	StockInHeader.Stih_Date BETWEEN @FROM_DATE AND @TO_DATE
	END
	else if @sp_status='Get_StockOut_list_Temp'
	begin
		Select tStoh_Key,tStoh_cStoh_Key,tStoh_cStoh_From,tStoh_Date 
		from StockOutHeader_Temp
		where tStoh_Status='Pending'
		group by tStoh_Key,tStoh_cStoh_Key,tStoh_cStoh_From,tStoh_Date
	end
	else if @sp_status='Get_StockOut_Item_Temp'
	begin
		Select row_number() over(partition by tStod_Key order by tStod_Key) as SrNo,A.*,B.Mm_Name,C.Uom_Name AS SUom,D.Uom_Name AS PUom
		from StockOutDetail_Temp as A
		Left join MedicineMaster as B
		On A.tStod_MmId=b.Mm_ID
		left join UomMaster as C
		On C.Uom_ID=A.tStod_SalesUom
		left join UomMaster as D
		On D.Uom_ID=A.tStod_PurchaseUom
		Where tStod_tStoh_Key=@Stih_Stot_Key
	end

	--else if @sp_status='fill_StockOutTemp_Help'
	--begin
	--	Select * from StockOutHeader_Temp
	--	Where tStoh_Status='Pending'
	--end
	--else if @sp_status='get_StockOut_Temp_data'
	--begin
	--	Select * from StockOutHeader_Temp
	--	Where tStoh_Status='Pending'

	--	Select * from StockOutDetail_Temp
	--	Where	tStod_tStoh_Key IN (Select tStoh_Key from StockOutHeader_Temp Where tStoh_Status='Pending')

	--end
END

GO
/****** Object:  StoredProcedure [dbo].[SP_StockOut]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 23-2-2019
-- Description:	For Stock out.
-- =============================================
CREATE PROCEDURE [dbo].[SP_StockOut]
@sp_status		varchar(200)	='',
@Stoh_Key		bigint			=0,
@Stoh_No		numeric(18, 0)	=0,
@Stoh_Date		datetime		=NULL,
@Stoh_To		nvarchar(50)	='',	
@Stoh_YearId	int				=0,
@User			int				=0,
@Stoh_Status	varchar(100)	='',
@Stoh_Remarks	varchar(5000)	='',

@Stod_Key			bigint			=0,
@Stod_Stoh_Key		bigint			=0,
@Stod_MmId			numeric(18, 0)	=0,
@Stod_BatchNo		varchar(500)	='',
@Stod_MnfDate		date			=NULL,
@Stod_ExpDate		date			=NULL,
@Stod_SalesQty		numeric(18, 2)	=0,
@Stod_SalesRate		numeric(18, 2)	=0,
@Stod_SalesUom		int				=0,
@Stod_Mrp			numeric(18, 2)	=0,
@Stod_PurchaseQty	numeric(18, 2)	=0,
@Stod_PurchaseUom	int				=0,
@Stod_PurchaseRate	numeric(18, 2)	=0,
@Stoh_LmId			int				=0,
@ID				int = 0 OUT

AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1
	IF @sp_status='Insert_Header'
	BEGIN
		SELECT @Stoh_Key = ISNULL(MAX(Stoh_Key), 0) + 1 FROM StockOutHeader(NOLOCK);
		SELECT @Stoh_No = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stoh_No, 0)))
		FROM StockOutHeader(NOLOCK)
		WHERE	StockOutHeader.Stoh_Date BETWEEN @FROM_DATE AND @TO_DATE
		insert into StockOutHeader
		(
			Stoh_Key,		
			Stoh_No,		
			Stoh_Date,		
			Stoh_To,	
			Stoh_YearId,		
			Stoh_CreatedBy,	
			Stoh_CreatedOn,	
			Stoh_Status,
			Stoh_Remarks
		)
		values
		(
			@Stoh_Key,		
			@Stoh_No,		
			@Stoh_Date,		
			@Stoh_To,		
			@Stoh_YearId,		
			@User,	
			getdate(),	
			@Stoh_Status,
			@Stoh_Remarks	
		);
		SELECT @ID = @Stoh_Key;
	END	
	IF @sp_status='Insert_Detail'
	BEGIN
		SELECT	@Stod_Key = ISNULL(MAX(Stod_Key), 0) + 1 FROM	StockOutDetail(NOLOCK);
		insert into StockOutDetail
		(
			Stod_Key,			
			Stod_Stoh_Key,		
			Stod_MmId,			
			Stod_BatchNo,		
			Stod_MnfDate,		
			Stod_ExpDate,		
			Stod_SalesQty,		
			Stod_SalesRate,		
			Stod_SalesUom,		
			Stod_Mrp,			
			Stod_PurchaseQty,	
			Stod_PurchaseUom,	
			Stod_PurchaseRate,
			Stoh_LmId	
		)
		values
		(
			@Stod_Key,			
			@Stod_Stoh_Key,		
			@Stod_MmId,			
			@Stod_BatchNo,		
			@Stod_MnfDate,		
			@Stod_ExpDate,		
			@Stod_SalesQty,		
			@Stod_SalesRate,		
			@Stod_SalesUom,		
			@Stod_Mrp,			
			@Stod_PurchaseQty,	
			@Stod_PurchaseUom,	
			@Stod_PurchaseRate,		
			@Stoh_LmId	
		);
		SELECT @ID = @Stod_Key;
	END	
	ELSE IF @SP_STATUS = 'AutoStockOutNo'
	BEGIN
		DECLARE @FormPrefix AS NVARCHAR(max) = '';
		SELECT @FormPrefix = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 18
		SELECT @FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stoh_No, 0)))
		FROM StockOutHeader(NOLOCK)
		WHERE	StockOutHeader.Stoh_Date BETWEEN @FROM_DATE AND @TO_DATE
	END
	ELSE IF @SP_STATUS = 'GetMedcnBatchwiseDetail'
	BEGIN
		SELECT *
		FROM vwStock(NOLOCK)
		WHERE Item_Id = @Stod_MmId
			AND Item_Batchno = @Stod_BatchNo
			AND Stk_LmId = @Stoh_LmId
	END;
	IF @SP_STATUS = 'BIND_ITEM'
	BEGIN

			if @Stoh_Remarks <>''
			begin
					Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0 and Item_Code = @Stoh_Remarks
					union all 
					Select *,vwStock.Item_Stock AS OldStock from vwStock WHERE Item_Stock > 0
					and Item_Code like @Stoh_Remarks+'%' and  Item_Code <> @Stoh_Remarks
					union all
					SELECT *,vwStock.Item_Stock AS OldStock
					FROM dbo.vwStock(NOLOCK)
					WHERE Item_Stock > 0
					--and(Item_Name like '%' + @Sih_Remark +'%' or Item_Batchno like @Sih_Remark+'%')
					and(Item_Name like @Stoh_Remarks +'%' or Item_Batchno like @Stoh_Remarks+'%')
					and Item_Code not like @Stoh_Remarks+'%' 
					and Item_Code <> @Stoh_Remarks 
			end
			else
			begin
					SELECT	*,vwStock.Item_Stock AS OldStock
					FROM dbo.vwStock(NOLOCK)
					WHERE Item_Stock > 0
					ORDER BY Stk_ExpDate;
			end
	end
	ELSE IF @SP_STATUS = 'BindMedcn'
	BEGIN
		SELECT *
		FROM MedicineMaster(NOLOCK) MM
		WHERE MM.Mm_IsActive = 1;
	END;
	else if @sp_status='FillGrid'
	begin
		select soh.*,um.User_Name createdby from StockOutHeader as soh
		left join UserMaster as um
		on soh.Stoh_CreatedBy =um.User_ID
		where soh.Stoh_YearId=@Stoh_YearId --and soh.Stoh_Status='Pending'
	end
	else if @sp_status='delete'
	begin
		DELETE FROM [dbo].StockOutHeader WHERE Stoh_Key = @Stoh_Key;
		DELETE FROM [dbo].StockOutDetail WHERE Stod_Stoh_Key = @Stoh_Key;
		DELETE FROM [dbo].StockRegister WHERE Stk_DocKey = @Stoh_Key AND Stk_DocType = 21;
	end
		ELSE IF @SP_STATUS = 'Retrive'
	BEGIN
		DECLARE @FormPrefixRet AS NVARCHAR(max) = '';
		SELECT @FormPrefixRet = FormPrefix
		FROM FormDetailTable(NOLOCK)
		WHERE Id = 18
		SELECT Stoh_Key
			,@FormPrefixRet + CAST(Stoh_No AS NVARCHAR(max)) AS Stoh_No
			,Stoh_To
			,Stoh_Date
			,Stoh_Remarks

		FROM dbo.StockOutHeader(NOLOCK) sih
		WHERE Stoh_Key = @Stoh_Key;
		
		SELECT sid.Stod_Key as  Sid_Key
			,sid.Stod_Stoh_Key as  Sid_Sih_Key
			--,Sid_SrNo
			,sid.Stod_MmId as  Sid_Mm_Id
			,sid.Stod_Mrp as  Sid_MRP
			,sid.Stod_BatchNo as Sid_BatchNo
			,sid.Stod_ExpDate as Sid_ExpDate
			,sid.Stod_SalesQty as Sid_SalesQty
			,sid.Stod_SalesUom as Sid_SalesUomId
			--,Sid_MRP AS Sid_SalesRate----Change Hasmukh
			,sid.Stod_SalesRate as  Sid_SalesRate----Change Hasmukh
			,sid.Stod_MnfDate as Sid_MnfDate
			,sid.Stod_PurchaseQty as  Sid_PurchaseQty
			,sid.Stod_PurchaseUom as Sid_PurchaseUomId
			,sid.Stod_PurchaseRate as Sid_PurchaseRate
			,sid.Stoh_LmId as Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--sid.Sid_SalesQty AS Sid_Stock_Qty,
			--sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			vwStock.Item_Stock + sid.Stod_SalesQty AS Sid_Stock_Qty
			,vwStock.Purchase_Item_Stock + sid.Stod_PurchaseQty AS Sid_Purchase_Stock_Qty
			,mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name AS Sid_LmName
		FROM dbo.stockoutDetail (NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster(NOLOCK) mm ON sid.Stod_MmId = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Stod_MmId
			AND vwStock.Item_Batchno = sid.Stod_BatchNo
			AND vwStock.Stk_LmId = sid.Stoh_LmId
		LEFT JOIN dbo.LocationMaster(NOLOCK) lm ON sid.Stoh_LmId= lm.Lm_Id
		WHERE Stod_Stoh_Key = @Stoh_Key
		GROUP BY Stod_Key
			,Stod_Stoh_Key
			,Stod_MmId
			,Stod_Mrp
			,Stod_BatchNo
			,Stod_ExpDate
			,Stod_SalesQty
			,Stod_SalesUom
			,Stod_SalesRate
			,Stod_MnfDate
			,Stod_PurchaseQty
			,Stod_PurchaseUom
			,Stod_PurchaseRate
			,Stoh_LmId
			,mm.Mm_Code
			,mm.Mm_Name
			,mm.Mm_StkUom
			,mm.MM_PackSize
			,vwStock.Item_Stock + sid.Stod_SalesQty
			,vwStock.Purchase_Item_Stock + sid.Stod_PurchaseQty
			,mm.MM_PackSize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name

		SELECT 0 AS Sid_Key
			,0 AS Sid_Sih_Key
			,0 AS Sid_SrNo
			,Stod_MmId as Sid_Mm_Id
			,vwStock.Item_MRP AS Sid_MRP
			,vwStock.Item_Batchno AS Sid_BatchNo
			,vwStock.Item_ExpDate AS Sid_ExpDate
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then Sid_SalesQty else 0.00 end as Sid_SalesQty,
			Stod_SalesQty as Sid_SalesQty
			,Stod_SalesUom as Sid_SalesUomId
			,vwStock.Item_Rate AS Sid_SalesRate
			,vwStock.Item_MnfDate AS Sid_MnfDate
			,0 AS Sid_Disc
			,0 AS Sid_DiscAmount
			,
			--case when isnull(vwStock.Purchase_Item_Stock,0)-ISNULL(Sid_PurchaseQty,0)>=ISNULL(Sid_PurchaseQty,0) then ISNULL(Sid_PurchaseQty,0) else 0 end as Sid_PurchaseQty,
			ISNULL(Stod_PurchaseQty, 0) AS Sid_PurchaseQty
			,Stod_PurchaseUom as Sid_PurchaseUomId
			,Stod_PurchaseRate as Sid_PurchaseRate
			,Stoh_LmId as Sid_LmId
			,mm.Mm_Code AS Sid_Mm_Code
			,mm.Mm_Name AS Sid_Mm_Name
			,mm.Mm_StkUom AS Sid_UomId
			,mm.MM_PackSize AS Sid_Packsize
			,
			--case when vwStock.Item_Stock-Sid_SalesQty>=Sid_SalesQty then vwStock.Item_Stock  else vwStock.Item_Stock end as Sid_Stock_Qty,
			vwStock.Item_Stock AS Sid_Stock_Qty
			,
			--vwStock.Item_Stock+sid.Sid_SalesQty AS Sid_Stock_Qty,
			--case when vwStock.Purchase_Item_Stock-Sid_PurchaseQty>=Sid_PurchaseQty then vwStock.Purchase_Item_Stock  else vwStock.Purchase_Item_Stock end as Sid_Purchase_Stock_Qty,
			vwStock.Purchase_Item_Stock AS Sid_Purchase_Stock_Qty
			,
			--vwStock.Purchase_Item_Stock+sid.Sid_PurchaseQty AS Sid_Purchase_Stock_Qty,
			mm.MM_PackSize AS Sid_Packsize
			,mm.MM_PurchaseRatio
			,mm.MM_SalesRatio
			,lm.Lm_Name AS Sid_LmName
		FROM dbo.StockOutDetail (NOLOCK) sid
		LEFT JOIN dbo.MedicineMaster mm ON sid.Stod_MmId = mm.Mm_ID
		LEFT JOIN vwStock ON vwStock.Item_Id = sid.Stod_MmId
			AND vwStock.Item_Batchno = sid.Stod_BatchNo
			AND vwStock.Stk_LmId = Stoh_LmId
		LEFT JOIN dbo.LocationMaster lm ON sid.Stoh_LmId = lm.Lm_Id
		WHERE Stod_Stoh_Key = @Stoh_Key;
	END;
	ELSE IF @SP_STATUS = 'Update'
	BEGIN
		--DECLARE @MSG_OUT_UPDATE NVARCHAR(max)
		--EXEC SP_Tbl_Dependency 'SalesInvoiceHeader'
		--	,@Sih_Key
		--	,@MSG_OUT_UPDATE OUTPUT
		--IF (RTRIM(LTRIM(@MSG_OUT_UPDATE)) <> '')
		--	BEGIN
		--		RAISERROR (
		--				@MSG_OUT_UPDATE
		--				,14
		--				,9
		--				)
		--	END
		--ELSE
			UPDATE [dbo].StockOutHeader
			SET 
			Stoh_Date=@Stoh_Date,		
			Stoh_To=@Stoh_To,	
			Stoh_YearId=@Stoh_YearId,		
			Stoh_UpdatedBy=@User,	
			Stoh_UpdatedOn=Getdate(),	
			Stoh_Remarks=@Stoh_Remarks
			WHERE Stoh_Key = @Stoh_Key;

		DELETE FROM dbo.StockOutDetail WHERE Stod_Stoh_Key = @Stoh_Key;
		DELETE FROM dbo.StockRegister WHERE Stk_DocKey = @Stoh_Key AND Stk_DocType = 21;
		SELECT @ID = @Stoh_Key;
	END
	ELSE IF @sp_status='POST_STOCK_OUT'
	BEGIN
		DECLARE @ST_CODE VARCHAR(20) = '' 
        SELECT TOP (1) @ST_CODE = A.store_code 
        FROM   storemaster (nolock) A 

		Select @ST_CODE as Stoh_From,m.* 
		from StockOutHeader as m
		Where m.Stoh_Status='Pending'

		Select d.* from StockOutDetail as d
		inner join StockOutHeader as m
		on d.Stod_Stoh_Key=m.Stoh_Key
		Where m.Stoh_Status='Pending'
	END
	ELSE IF @sp_status='MARK_AS_DONE'
	BEGIN
		update StockOutHeader
		Set Stoh_Status='Done'
		Where Stoh_Key=@Stoh_Key
	END
	else if @sp_status='GetStoreGstNo'
	begin
		Select Store_GstNo from StoreMaster
	end
END

GO
/****** Object:  StoredProcedure [dbo].[SP_StockOut_Temp]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		VishalR	
-- Create date: 18.March.2019
-- Description:	For Insert in StockOut_Temp
-- =============================================
CREATE PROCEDURE [dbo].[SP_StockOut_Temp]
@sp_Status			varchar(200)='',
------------Header----------------------------
@tStoh_Key			bigint=0,
@tStoh_cStoh_Key	bigint=0,	
@tStoh_cStoh_From	nvarchar(50)='',
@tStoh_Date			datetime=null,	
@user				varchar(100)='',
@tStoh_YearId		int=0,	
@tStoh_Status		varchar(100)='',	
@tStoh_Remarks		varchar(5000)='',
-----------------Detail-----------------------
@tStod_Key			bigint=0,		
@tStod_tStoh_Key	bigint=0,	
@tStod_MmId			numeric(18, 0)=0,	
@tStod_BatchNo		varchar(500)='',	
@tStod_MnfDate		date=null,	
@tStod_ExpDate		date=null,	
@tStod_SalesQty		numeric(18, 2)=0,	
@tStod_SalesRate	numeric(18, 2)=0,	
@tStod_SalesUom		int=0,	
@tStod_Mrp			numeric(18, 2)=0,	
@tStod_PurchaseQty	numeric(18, 2)=0,	
@tStod_PurchaseUom	int=0,	
@tStod_PurchaseRate	numeric(18, 2)=0,	
@tStod_LmId			int=0,		
@ID			int=0 out		
AS
BEGIN
	If @sp_Status='Insert_header'
	begin
		Select @ID=ISNULL(MAX(tStoh_Key),0) + 1 from StockOutHeader_Temp
		insert into StockOutHeader_Temp
		(
			tStoh_Key,
			tStoh_cStoh_Key,
			tStoh_cStoh_From,
			tStoh_Date,
			tStoh_YearId,
			tStoh_CreatedBy,
			tStoh_CreatedOn,
			tStoh_Status,
			tStoh_Remarks
		)
		values
		(
			@ID,
			@tStoh_cStoh_Key,
			@tStoh_cStoh_From,
			@tStoh_Date,
			@tStoh_YearId,
			@user,
			GETDATE(),
			@tStoh_Status,
			@tStoh_Remarks
		)
		Select @ID
		--select * from StockOutHeader_Temp
		--Select * from StockOutDetail_Temp
	end
	else if @sp_Status='Insert_detail'
	begin
		Select @ID= ISNULL(MAx(tStod_Key),0) + 1 from StockOutDetail_Temp
		insert into StockOutDetail_Temp
		(
			tStod_Key,
			tStod_tStoh_Key,
			tStod_MmId,
			tStod_BatchNo,
			tStod_MnfDate,
			tStod_ExpDate,
			tStod_SalesQty,
			tStod_SalesRate,
			tStod_SalesUom,
			tStod_Mrp,
			tStod_PurchaseQty,
			tStod_PurchaseUom,
			tStod_PurchaseRate,
			tStod_LmId
		)
		Values
		(
			@ID,
			@tStod_tStoh_Key,
			@tStod_MmId,
			@tStod_BatchNo,
			@tStod_MnfDate,
			@tStod_ExpDate,
			@tStod_SalesQty,
			@tStod_SalesRate,
			@tStod_SalesUom,
			@tStod_Mrp,
			@tStod_PurchaseQty,
			@tStod_PurchaseUom,
			@tStod_PurchaseRate,
			@tStod_LmId
		)
		select @ID
	end
END

GO
/****** Object:  StoredProcedure [dbo].[Sp_StockRegister]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Sp_StockRegister] @SP_STATUS varchar(200) = '',
@Stk_ID NUMERIC(18,0) = 0,
@Stk_MmId NUMERIC(18,0) = 0,
@Stk_MmmId NUMERIC(18,0) = 0,
@Stk_Date datetime = NULL,
@Stk_Barcode varchar(150) = NULL,
@Stk_BatchNo varchar(50) = NULL,
@Stk_MnfDate datetime = NULL,
@Stk_ExpDate datetime = NULL,
@Stk_Qty numeric(18, 2) = NULL,
@Stk_Rate numeric(18, 3) = NULL,
@Stk_UomId int = 0,
@Stk_DocNo numeric(18, 0) = 0,
@Stk_DocRevNo numeric(18, 0) = 0,
@Stk_DocKey numeric(10, 0) = 0,
@Stk_DocType varchar(50) = NULL,
@Stk_BmId int = 0,
@Stk_FyId int = 0,
@Stk_LmId int = 0,
@Stk_Mrp numeric(18, 3) = NULL,
@Stk_User int = 0,
@Stk_Tran_Typ nvarchar(1) = NULL,
@Stk_PackId int = 0,
@Stk_PurchaseQty Decimal(18,2) = 0,
@Stk_PurchaseUom int = 0,
@Stk_PurchaseRate Decimal(18,2) = 0,
@DefaultNoGap nvarchar(10) = '',
@DefaultNoDigits int = 0,
@DefaultValue nvarchar(10) = '',
@ID NUMERIC(18,0) = 0 OUT
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME
	DECLARE @LAST_KEY	BIGINT

	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1

	SELECT	TOP(1)
			@LAST_KEY=MAX(DOC_KEY)
	FROM	YEAR_END_LAST_DOCUMNT_KEY A
	WHERE	A.DOC_TYPE='STK_KEY' 

  IF @SP_STATUS = 'insert'
    BEGIN
      SELECT @Stk_ID = ISNULL(MAX(Stk_ID), 0) + 1
      FROM StockRegister(NOLOCK);
		--SELECT @DefaultNoGap = [DefaultNoGap],
  --             @DefaultNoDigits = [DefaultNoDigits],
  --             @DefaultValue = [DefaultValue]
  --      FROM [dbo].[ConfigurationMaster](NOLOCK)
  --      SELECT @Stk_DocNo=[dbo].FUNC_GET_FINC_YEAR(ISNULL(RIGHT(@DefaultNoGap + CONVERT(varchar(max), MAX(ISNULL(CAST(Stk_ID AS bigint), 0) + 1)), @DefaultNoDigits), @DefaultValue))
  --      FROM StockRegister(NOLOCK)
  
		SELECT	@Stk_DocNo= [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stk_DocNo,0)))
		FROM	StockRegister(NOLOCK)
		WHERE	StockRegister.Stk_Date BETWEEN @FROM_DATE AND @TO_DATE AND Stk_DocNo>ISNULL(@LAST_KEY,0)
		 INSERT INTO [dbo].[StockRegister] (
          Stk_ID,
          [Stk_MmId],
          [Stk_MmmId],
          [Stk_Date],
          [Stk_Barcode],
          [Stk_BatchNo],
          [Stk_MnfDate],
          [Stk_ExpDate],
          [Stk_SalesQty],
          [Stk_SalesRate],
          [Stk_SalesUom],
          [Stk_DocNo],
          [Stk_DocRevNo],
          [Stk_DocKey],
          [Stk_DocType],
          [Stk_BmId],
          [Stk_FyId],
          [Stk_LmId],
          [Stk_CreatedBy],
          [Stk_CreatedDt],
          [Stk_Mrp],
          Stk_Tran_Typ,
          Stk_PurchaseQty,Stk_PurchaseUom,Stk_PurchaseRate )
      VALUES(@Stk_ID, @Stk_MmId, @Stk_MmmId, @Stk_Date, @Stk_Barcode, ISNULL(@Stk_BatchNo,''), @Stk_MnfDate, @Stk_ExpDate, @Stk_Qty,
      @Stk_Rate, @Stk_UomId, @Stk_DocNo, @Stk_DocRevNo, @Stk_DocKey, @Stk_DocType, @Stk_BmId, @Stk_FyId,
      @Stk_LmId, @Stk_User, CONVERT(date,GETDATE()), @Stk_Mrp, @Stk_Tran_Typ, @Stk_PurchaseQty,@Stk_PurchaseUom,@Stk_PurchaseRate);
      SELECT @ID = @Stk_ID;
    END;
  ELSE IF @SP_STATUS = 'Update'
    BEGIN
		Update StockRegister
		Set
			Stk_BatchNo=@Stk_BatchNo,
			Stk_MnfDate=@Stk_MnfDate,
			Stk_ExpDate=@Stk_ExpDate,
			Stk_Mrp=@Stk_Mrp,
			Stk_PurchaseQty=@Stk_PurchaseQty,
			Stk_PurchaseRate=@Stk_PurchaseRate,
			Stk_UpdatedBy=@Stk_User,
			Stk_UpdatedDt=GETDATE()
		  Where 
			Stk_ID=@Stk_ID
    END;
  
  ELSE IF @SP_STATUS = 'GET_ITEM_DETAIL'
    BEGIN
      SELECT Mm_ID,
             Mm_Code,
             Mm_Name,
             Uom_ID,
             Uom_Name,
             Mm_PurRate,
             mm.Mm_MRP,
			 mm.MM_PackSize as Stk_PackId,
			 mm.MM_ManufactureBy as Sm_Manufacture,
			 mm.MM_MarketingBy as Sm_MarketingBy,
			 (CASE WHEN mm.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus,---Add Hasmukh
			 ISNULL(mm.Mm_MtmId,0)AS Mm_MtmId---Add Hasmukh
      FROM MedicineMaster(NOLOCK) mm
      Left JOIN UomMaster(NOLOCK) uom
        ON mm.MM_PurchaseUom = uom.Uom_ID
      WHERE mm.Mm_ID = @Stk_MmId
      AND mm.Mm_IsActive = 1;
    END;
  
  
  ELSE IF @SP_STATUS = 'GET_ITEM'
    BEGIN
      SELECT *
      FROM MedicineMaster (NOLOCK) 
      WHERE Mm_IsActive = 1;
    END;
  --IF @SP_STATUS = 'AUTO_STOCK_NO'
  --  BEGIN
  --    SELECT ISNULL(MAX(Stk_DocNo), STR(YEAR(GETDATE()), 4) + '0000') + 1
  --    FROM StockRegister(NOLOCK)
  --    WHERE Stk_FyId = @Stk_FyId;
  --  END;
  --ELSE
  ELSE IF @SP_STATUS = 'AUTO_STOCK_NO'
    BEGIN
  --     SELECT @DefaultNoGap = [DefaultNoGap],
  --             @DefaultNoDigits = [DefaultNoDigits],
  --             @DefaultValue = [DefaultValue]
  --      FROM [dbo].[ConfigurationMaster](NOLOCK)
		--SELECT [dbo].FUNC_GET_FINC_YEAR(ISNULL(RIGHT(@DefaultNoGap + CONVERT(varchar(max), MAX(ISNULL(CAST(Stk_ID AS bigint), 0) + 1)), @DefaultNoDigits), @DefaultValue))
  --      FROM StockRegister(NOLOCK)
		DECLARE		@FormPrefix AS NVARCHAR(MAX) = '';
		SELECT		@FormPrefix = FormPrefix
		FROM		FormDetailTable (NOLOCK) 
		WHERE		Id = 13
		SELECT		@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Stk_DocNo,0)))
		FROM		StockRegister(NOLOCK)
		WHERE		StockRegister.Stk_Date BETWEEN @FROM_DATE AND @TO_DATE AND Stk_DocNo>ISNULL(@LAST_KEY,0)
    END;
  ELSE IF @SP_STATUS = 'AUTO_STOCK_DOC_NO'
    BEGIN
      SELECT ISNULL(MAX(Stk_DocKey), +'0000') + 1
      FROM StockRegister(NOLOCK);
    END;
  ELSE IF @SP_STATUS = 'GetBatchNumber'
    BEGIN
      SELECT DISTINCT (Stk_BatchNo)
      FROM StockRegister(NOLOCK)
      WHERE Stk_MmId = @Stk_MmId
      AND Stk_BatchNo = @Stk_BatchNo
	  --and Stk_LmId=@Stk_LmId
    END;
  --IF @SP_STATUS = 'GetMedcnwisePack'
  --  BEGIN
  --    SELECT MPS.Mps_Id,
  --           MPS.Mps_PsId,
  --           --ps.Ps_Code AS Mps_PsCode,
  --           MPS.Mps_PsName AS Mps_PsName
  --    FROM MedicinePacketSizeMaster AS MPS
    
  --    WHERE MPS.Mps_MmId = @Stk_MmId;
  --  END;
  --ELSE
  --  IF @SP_STATUS = 'GetMedcnAndUomWisePack'
  --  BEGIN
		--select Mps_Id as Mps_PsId,Mps_PsName as Mps_PsName from MedicineUomMaster muom left join MedicinePacketSizeMaster mps
		--on muom.MUom_Mm_ID=mps.Mps_MmId 
		--where muom.MUom_Mm_ID=@Stk_MmId and mps.Mps_UomId=muom.MUom_Id and MUom_PurchaseId=@Stk_UomId
		 
  --  END;
  --ELSE
  --   IF @SP_STATUS = 'GetMedcnAndUomWisePackForStock'
  --  BEGIN
		--select Mps_Id as Stk_PackId,Mps_PsName as Mps_PsName from MedicineUomMaster muom left join MedicinePacketSizeMaster mps
		--on muom.MUom_Mm_ID=mps.Mps_MmId 
		--where muom.MUom_Mm_ID=@Stk_MmId and mps.Mps_UomId=muom.MUom_Id and MUom_PurchaseId=@Stk_UomId
		 
  --  END;
  --ELSE
  ELSE IF @SP_STATUS = 'FillStockDetail'
    BEGIN
   --   SELECT vwStockBatchWise.*,DT.PQTY,
			-- (DT.PQTY*DT.Stk_Mrp)AS MRP_Total,
			-- (DT.PQTY*DT.Stk_PurchaseRate)AS PURCHASE_Total
   --   FROM vwStockBatchWise (NOLOCK)
	  --------Add By Hasmukh -Calculate Total Amount Of Purchase Medicine
	  --     INNER JOIN( SELECT Stk_BatchNo,
		 --                     Stk_MmId,
			--				  SUM(CASE WHEN B.Stk_Tran_Typ = 'C' THEN B.Stk_PurchaseQty ELSE 0 END - CASE WHEN B.Stk_Tran_Typ = 'D' THEN B.Stk_PurchaseQty ELSE 0 END) AS PQTY,
			--				  Stk_Mrp,
			--				  Stk_PurchaseRate
		 --                FROM StockRegister B
			--			      GROUP BY Stk_BatchNo,Stk_MmId,Stk_Mrp,Stk_PurchaseRate)AS DT
	  --  ON DT.Stk_MmId=vwStockBatchWise.Stk_MmId
		 --  AND DT.Stk_BatchNo=vwStockBatchWise.Stk_BatchNo
   --   WHERE ISNULL(vwStockBatchWise.QTY, 0) > 0

		SELECT	vwStockBatchWise.*,DT.PQTY,
				(DT.PQTY*DT.Stk_Mrp)AS MRP_Total,
				(DT.PQTY*DT.Stk_PurchaseRate)AS PURCHASE_Total
		FROM	vwStockBatchWise (NOLOCK)
	  ------Add By Hasmukh -Calculate Total Amount Of Purchase Medicine
				INNER JOIN(SELECT Stk_BatchNo,
		                      Stk_MmId,
							  SUM(CASE WHEN B.Stk_Tran_Typ = 'C' THEN B.Stk_PurchaseQty ELSE 0 END - CASE WHEN B.Stk_Tran_Typ = 'D' THEN B.Stk_PurchaseQty ELSE 0 END) AS PQTY,
							  Stk_Mrp,
							  (SELECT top 1 Stk_PurchaseRate FROM StockRegister SR WHERE SR.Stk_BatchNo=B.Stk_BatchNo
							  AND SR.Stk_MmId=B.Stk_MmId AND Stk_Tran_Typ='C' order by Stk_ID DESC)AS
							  Stk_PurchaseRate
		                 FROM StockRegister B GROUP BY Stk_BatchNo,Stk_MmId,Stk_Mrp) AS DT
						      
		ON			DT.Stk_MmId=vwStockBatchWise.Stk_MmId
				AND DT.Stk_BatchNo=vwStockBatchWise.Stk_BatchNo  
		WHERE		ISNULL(vwStockBatchWise.QTY, 0) > 0
    END
   ELSE IF @SP_STATUS = 'FillMedicinWiseStockDetail'
    BEGIN
	    --SELECT	
		   --     A.Item_Code,
		   --     A.Item_Name,
		   --     SUM(A.Item_Stock) AS Sales_Stock,
		   --     SUM(A.Purchase_Item_Stock) AS Purchase_Stock,
		   --     A.Item_Uom,
		   --     CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*A.Item_MRP)) AS MRP_Amount,
		   --     CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*A.Item_Rate)) AS Sales_Amount,
		   --     CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*A.Purchase_Item_Rate)) AS Purchas_Amount
     --     FROM	vwStock A
     --           GROUP BY A.Item_Code,A.Item_Name,Item_Uom
		  SELECT	
					A.Item_Code,
					A.Item_Name,
					SUM(A.Item_Stock) AS Sales_Stock,
					SUM(A.Purchase_Item_Stock) AS Purchase_Stock,
					A.Item_Uom,
					CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*A.Item_MRP)) AS MRP_Amount,
					CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*A.Item_Rate)) AS Sales_Amount,
					CONVERT(NUMERIC(12,2),SUM(A.Purchase_Item_Stock*Stk_PurchaseRate)) AS Purchas_Amount
          FROM		vwStock A
					INNER JOIN(SELECT Stk_BatchNo,
		                      Stk_MmId,
							  SUM(CASE WHEN B.Stk_Tran_Typ = 'C' THEN B.Stk_PurchaseQty ELSE 0 END - CASE WHEN B.Stk_Tran_Typ = 'D' THEN B.Stk_PurchaseQty ELSE 0 END) AS PQTY,
							  Stk_Mrp,
							  (SELECT top 1 Stk_PurchaseRate FROM StockRegister SR WHERE SR.Stk_BatchNo=B.Stk_BatchNo
							  AND SR.Stk_MmId=B.Stk_MmId AND Stk_Tran_Typ='C' order by Stk_ID DESC)AS
							  Stk_PurchaseRate
		                 FROM StockRegister B GROUP BY Stk_BatchNo,Stk_MmId,Stk_Mrp) AS DT
						      
			ON			DT.Stk_MmId=A.Item_Id
				AND		DT.Stk_BatchNo=A.Item_Batchno
			GROUP BY	A.Item_Code,A.Item_Name,Item_Uom
	END
  ELSE IF @SP_STATUS = 'FillOpeStockRegister'
    BEGIN
		Select * from (
		SELECT ROW_NUMBER() OVER(ORDER BY (SELECT 1)) AS SrNo,A.Stk_ID,B.Mm_Code,B.Mm_Name,A.Stk_PurchaseQty AS	QTY,
		C.Uom_Name,A.Stk_PurchaseRate,ISNULL(A.Stk_Mrp, 0) AS Stk_Mrp,A.Stk_BatchNo,A.Stk_MnfDate,A.Stk_ExpDate,ISNULL(ZZ.cnt,0) as cnt,
		(CASE WHEN mm.Mm_MaintainExp='true' THEN 'YES' ELSE 'NO' END)AS mm_MaintainExpStatus
		FROM   dbo.StockRegister AS A 
		LEFT OUTER JOIN dbo.MedicineMaster AS B 
		ON A.Stk_MmId = B.Mm_ID 
		LEFT OUTER JOIN dbo.UomMaster AS C 
		ON A.Stk_SalesUom = C.Uom_ID
		LEFT JOIN ( SELECT Z.Stk_MmId,Z.Stk_BatchNo,ISNULL(count(*),0) as cnt 
					FROM dbo.StockRegister AS Z 
					Where	Z.Stk_DocType <> 6 
						and convert(varchar(100),Z.Stk_MmId)+''+Z.Stk_BatchNo in (SELECT convert(varchar(100),Stk_MmId) +'' + Stk_BatchNo FROM dbo.StockRegister Where	Stk_DocType = 6)
					group by Z.Stk_MmId,Z.Stk_BatchNo
				  ) as ZZ
		ON A.Stk_MmId=ZZ.Stk_MmId AND A.Stk_BatchNo=zz.Stk_BatchNo
		LEFT JOIN MedicineMaster as MM
		ON MM.Mm_ID=A.Stk_MmId
		Where A.Stk_DocType=6		
		) as TT
		Where TT.cnt=case when @Stk_BmId=1 then 0 else TT.cnt end
    END
  ELSE IF @SP_STATUS = 'ExpiryStock'
    BEGIN
      --SELECT *
      --FROM vwStockBatchWise (NOLOCK) 
      --WHERE CONVERT(date, Stk_ExpDate) <= CONVERT(date, GETDATE())
      --AND ISNULL(QTY, 0) > 0
	    SELECT	*
		FROM	vwExpiredStockBatchWise (NOLOCK) 
		WHERE		CONVERT(date, Stk_ExpDate) <= CONVERT(date, GETDATE())
				AND ISNULL(QTY, 0) > 0
    END
  ELSE IF @SP_STATUS = 'GetOpeningAdjustList'
    BEGIN
      SELECT	sr.Stk_MmId, mm.Mm_Code,  mm.Mm_Name,
				sr.Stk_BatchNo,uom.Uom_Name,  sr.Stk_SalesQty AS QTY,sr.Stk_DocType,CONVERT(date,Stk_Date) as Stk_Date,lm.Lm_Name 
	  FROM      dbo.StockRegister  (NOLOCK) AS sr 
	  LEFT OUTER JOIN  dbo.MedicineMaster AS mm ON sr.Stk_MmId = mm.Mm_ID 
	  LEFT OUTER JOIN dbo.UomMaster AS uom ON sr.Stk_SalesUom = uom.Uom_ID
	  LEFT OUTER JOIN dbo.LocationMaster AS lm ON sr.Stk_LmId =lm.Lm_Id
	  where Stk_DocType=@Stk_DocType
    END
  
  ELSE IF @SP_STATUS = 'NearByExpiryStock'
    BEGIN
	     IF(@Stk_MmId!=0)
		 BEGIN
                SELECT vwStockBatchWise.*,
	                   Branch_Name, 
	            	   Branch_Address1 as Branch_Address, 
	            	   Branch_GstNo,
	            	   Mm_HsnCode AS HsnCode,
	                   MTM.Mtm_TypeName AS DrugType,
	                   MGM.Mgm_Name  AS DrugGroup,
	                   MCM.Mcm_Name AS DrugCategory
                  FROM vwStockBatchWise  (NOLOCK) 
	              left  join (select top 1 * from BranchMaster)as BranchMaster  on 0=0
	              Left join MedicineMaster  (NOLOCK) MM
	              ON MM.Mm_ID=vwStockBatchWise.Stk_MmId
	              Left join MedicineTypeMaster  (NOLOCK) MTM
	              ON MTM.Mtm_ID=MM.Mm_MtmId
	              Left join MedicineGroupMaster (NOLOCK)  MGM
	              ON MGM.Mgm_ID=MM.Mm_MgmId
	              Left join MedicineCategoryMaster (NOLOCK)  MCM
	              ON MCM.Mcm_ID=MM.Mm_McmId
                  --WHERE (CONVERT(date, Stk_ExpDate) <= @Stk_ExpDate
                  --AND CONVERT(date, Stk_ExpDate) >= CONVERT(date, GETDATE()))
				   WHERE (CONVERT(date, Stk_ExpDate) <= @Stk_ExpDate
                  AND CONVERT(date, Stk_ExpDate) >=  CONVERT(date, @Stk_MnfDate))
                  AND ISNULL(QTY, 0) > 0 AND MM.Mm_MtmId=@stk_MmId
		  END
		  ELSE
		  BEGIN
		        SELECT vwStockBatchWise.*,
	                   Branch_Name, 
	            	   Branch_Address1 as Branch_Address, 
	            	   Branch_GstNo,
	            	   Mm_HsnCode AS HsnCode,
	                   MTM.Mtm_TypeName AS DrugType,
	                   MGM.Mgm_Name  AS DrugGroup,
	                   MCM.Mcm_Name AS DrugCategory
                  FROM vwStockBatchWise  (NOLOCK) 
	              left  join (select top 1 * from BranchMaster)as BranchMaster  on 0=0
	              Left join MedicineMaster  (NOLOCK) MM
	              ON MM.Mm_ID=vwStockBatchWise.Stk_MmId
	              Left join MedicineTypeMaster MTM
	              ON MTM.Mtm_ID=MM.Mm_MtmId
	              Left join MedicineGroupMaster MGM
	              ON MGM.Mgm_ID=MM.Mm_MgmId
	              Left join MedicineCategoryMaster MCM
	              ON MCM.Mcm_ID=MM.Mm_McmId
				  WHERE (CONVERT(date, Stk_ExpDate) <=convert(date, @Stk_ExpDate)
                  AND CONVERT(date, Stk_ExpDate) >=  CONVERT(date, @Stk_MnfDate))
                  AND ISNULL(QTY, 0) > 0
		  END
    END
  ELSE IF @SP_STATUS = 'StockRegister'
    BEGIN
	     IF(@Stk_MmId!=0)
		 BEGIN
               SELECT  vwStockBatchWise.*,'' as Branch_Name, 
	                   '' as Branch_Address, 
	            	   '' as Branch_GstNo,
	            	   MM.Mm_HsnCode AS HsnCode,
	            	   MTM.Mtm_TypeName AS DrugType,
	            	   MGM.Mgm_Name  AS DrugGroup,
	            	   MCM.Mcm_Name AS DrugCategory
                 FROM vwStockBatchWise  (NOLOCK) 
	             --Left join BranchMaster  (NOLOCK) on 0=0
	             Left join MedicineMaster (NOLOCK)  MM
	             ON MM.Mm_ID=vwStockBatchWise.Stk_MmId
	             Left join MedicineTypeMaster (NOLOCK)  MTM
	             ON MTM.Mtm_ID=MM.Mm_MtmId
	             Left join MedicineGroupMaster (NOLOCK)  MGM
	             ON MGM.Mgm_ID=MM.Mm_MgmId
	             Left join MedicineCategoryMaster  (NOLOCK) MCM
	             ON MCM.Mcm_ID=MM.Mm_McmId
                 WHERE ISNULL(QTY, 0) > 0 AND MM.Mm_MtmId=@Stk_MmId
		    END
			ELSE
			BEGIN
			     SELECT  vwStockBatchWise.*,'' asBranch_Name, 
	                   '' as Branch_Address, 
	            	   '' as Branch_GstNo,
	            	   MM.Mm_HsnCode AS HsnCode,
	            	   MTM.Mtm_TypeName AS DrugType,
	            	   MGM.Mgm_Name  AS DrugGroup,
	            	   MCM.Mcm_Name AS DrugCategory
                 FROM vwStockBatchWise  (NOLOCK) 
	             --Left join BranchMaster  (NOLOCK) on 0=0
	             Left join MedicineMaster  (NOLOCK) MM
	             ON MM.Mm_ID=vwStockBatchWise.Stk_MmId
	             Left join MedicineTypeMaster (NOLOCK)  MTM
	             ON MTM.Mtm_ID=MM.Mm_MtmId
	             Left join MedicineGroupMaster (NOLOCK)  MGM
	             ON MGM.Mgm_ID=MM.Mm_MgmId
	             Left join MedicineCategoryMaster  (NOLOCK) MCM
	             ON MCM.Mcm_ID=MM.Mm_McmId
                 WHERE ISNULL(QTY, 0) > 0  
			END
		       
    END
   
  ELSE IF @SP_STATUS = 'FillStockTransfer'
    BEGIN
   --  select ROW_NUMBER() OVER(ORDER BY (SELECT 1)) as SrNo,
			--Item_Id as Mm_Id  ,
			--Item_Code as Mm_Code,
			--Item_Name  as Mm_Name,
			--Item_Batchno as Mm_BatchNo,
			--Stk_LmId as Mm_FromLocationId,
			--Lm_Name as Mm_FromLocation,
			--Sales_Qty as StockQty,
			----0 as	Mm_ToLocation,
			--0.00 as TransferQty
			--from vwStock where Item_Stock>0
			 select ROW_NUMBER() OVER(ORDER BY (SELECT 1)) as SrNo,
					Item_Id as Stk_MmId  ,
					Item_Code as Mm_Code,
					Item_Name  as Mm_Name,
					Item_Batchno as Stk_BatchNo,
					Stk_LmId as Mm_FromLocationId,
					Lm_Name as Mm_FromLocation,
					Stk_MnfDate,
					Stk_ExpDate,
					Item_Stock as Stk_SalesQty,
					Item_Rate as Stk_SalesRate,
					Stk_SalesUom as Stk_SalesUom,
					Stk_LmId as Stk_LmId,
					Item_MRP as Stk_Mrp,
					Purchase_Item_Stock as Stk_PurchaseQty,
					Purchase_Item_Uom_Id as Stk_PurchaseUom,
					Purchase_Item_Rate as Stk_PurchaseRate,
					0 as	Mm_ToLocation,
			0.00 as TransferQty
			from vwStock  (NOLOCK) where Item_Stock>0
    END
  ELSE IF @SP_STATUS = 'FillLocation'
    BEGIN
		if	@Stk_MmId > 0
		begin
			with cte as 
			(select Mlm_LmId as lm_id , Mlm_IsDefualt from MedicineLocationMaster  (NOLOCK) mlm 
			where Mlm_MmId=@Stk_MmId  
			
			union
			 
			select Lm_Id  as lm_id,-1 as Mlm_IsDefualt 
			from LocationMaster  where Lm_Id not in (select Mlm_LmId from MedicineLocationMaster  (NOLOCK) mlm where Mlm_MmId=@Stk_MmId) and Lm_IsActive=1
			and Lm_Id not in (Select Lm_LmId from LocationMaster)
			)
			select cte.lm_id as Stk_LmId ,Lm_Name from cte 
			left join LocationMaster lm on cte.lm_id=lm.Lm_Id
			WHERE lm.Lm_Id not in (Select Lm_LmId from LocationMaster (NOLOCK) ) and Lm_IsActive=1
			order by cte.Mlm_IsDefualt desc
		end
		else
		BEGIN
	  		--select Lm_Id  as Stk_LmId,Lm_Name from LocationMaster where Lm_IsActive=1
			Select Lm_Id  as Stk_LmId,Lm_Name from LocationMaster (NOLOCK) 
			WHERE Lm_Id not in (Select Lm_LmId from LocationMaster (NOLOCK) ) and  Lm_IsActive=1
		END
    END
	ELSE IF @SP_STATUS = 'FillLocationForStockTransfer'
		BEGIN
		  	--select Lm_Id  as Mm_ToLocation,Lm_Name from LocationMaster where Lm_IsActive=1 and Lm_Id not in (@Stk_LmId)	
			IF	(@Stk_MmId > 0 and @Stk_LmId > 0)
				BEGIN
					with cte as 
					(select Mlm_LmId as lm_id , Mlm_IsDefualt from MedicineLocationMaster  (NOLOCK) mlm 
					where Mlm_MmId=@Stk_MmId  
			
					union
			 
					select Lm_Id  as lm_id,-1 as Mlm_IsDefualt 
					from LocationMaster  where Lm_Id not in (select Mlm_LmId from MedicineLocationMaster  (NOLOCK) mlm where Mlm_MmId=@Stk_MmId) and Lm_IsActive=1
					and Lm_Id not in (Select Lm_LmId from LocationMaster)
					)
					select cte.lm_id as Mm_ToLocation ,Lm_Name from cte 
					left join LocationMaster lm on cte.lm_id=lm.Lm_Id
					WHERE	lm.Lm_Id not in (Select Lm_LmId from LocationMaster (NOLOCK) ) 
						and Lm_IsActive=1
						and cte.lm_id  <> @Stk_LmId
					order by cte.Mlm_IsDefualt desc
				END
			ELSE IF	@Stk_LmId > 0
				BEGIN
				  	--select Lm_Id  as Stk_LmId,Lm_Name from LocationMaster where Lm_IsActive=1
					Select Lm_Id  as Mm_ToLocation,Lm_Name 
					from LocationMaster (NOLOCK) 
					WHERE	Lm_Id not in (Select Lm_LmId from LocationMaster (NOLOCK) ) 
						and Lm_IsActive=1
						and Lm_Id <> @Stk_LmId
				END
			else
				begin
					--select Lm_Id  as Stk_LmId,Lm_Name from LocationMaster where Lm_IsActive=1
					Select Lm_Id  as Mm_ToLocation,Lm_Name 
					from LocationMaster (NOLOCK) 
					WHERE	Lm_Id not in (Select Lm_LmId from LocationMaster (NOLOCK) ) 
						and Lm_IsActive=1
				end
		END
	ELSE IF @SP_STATUS = 'GetMedicinIdFromCode'
		BEGIN
		  	select *,ISNULL(Mm_MtmId,0)AS MTMId from MedicineMaster  (NOLOCK) where Mm_IsActive=1 and Mm_Code=@Stk_Barcode
		END	
	
	ELSE IF @SP_STATUS = 'GetCreditDebitAcc'
		BEGIN
		  	select Lm_Id,Lm_Name from LedgerMaster (NOLOCK)  where Lm_IsActive=1
		END	
	ELSE IF @SP_STATUS = 'GetAuditDetail'
		BEGIN
			select cast(0 as bit) as chk,
						Item_Id as Stk_MmId  ,
						Item_Code as Mm_Code,
						Item_Name  as Mm_Name,
						Item_Batchno as Stk_BatchNo,
						Stk_LmId as Mm_FromLocationId,
						Lm_Name as Mm_FromLocation,
						Stk_MnfDate,
						Stk_ExpDate,
						Item_Stock as Stk_SalesQty,
						Item_Rate as Stk_SalesRate,
						Stk_SalesUom as Stk_SalesUom,
						Stk_LmId as Stk_LmId,
						Item_MRP as Stk_Mrp,
						Purchase_Item_Stock as Stk_PurchaseQty,
						Purchase_Item_Uom_Id as Stk_PurchaseUom,
						Purchase_Item_Rate as Stk_PurchaseRate,
						isnull(AuditMaster.Am_Qty,0) -isnull(AuditMaster.Am_AdjustQty,0) as AdjustQty,
						ISNULL(AuditMaster.Am_CrDr,'Cr') as AM_CrDr,
						AuditMaster.Am_Id
				from vwStock  (NOLOCK) 
				left join AuditMaster on  vwStock.Item_Id=Am_MmId and vwStock.Item_Batchno=Am_MmBatchNo and vwStock.Stk_LmId=Am_LmId
				where Item_Stock>0 and Am_Date=@Stk_Date
		END
	ELSE IF @SP_STATUS = 'GetAuditCurrentStock'
    BEGIN
	if @Stk_MmId=0
		select			cast(0 as bit) as chk,
					Item_Id as Am_MmId  ,
					Item_Code as Am_MmCode,
					Item_Name  as Am_MmName,
					Item_Batchno as Am_MmBatchNo,
					Stk_LmId as Am_LmId,
					Lm_Name as Am_Location,
					Item_Stock as Am_Stock
	from vwStock  (NOLOCK) where Item_Stock>0 
	else
	select			cast(0 as bit) as chk,
					Item_Id as Am_MmId  ,
					Item_Code as Am_MmCode,
					Item_Name  as Am_MmName,
					Item_Batchno as Am_MmBatchNo,
					Stk_LmId as Am_LmId,
					Lm_Name as Am_Location,
					Item_Stock as Am_Stock
	from vwStock    (NOLOCK) 
	where Item_Id=@Stk_MmId and Item_Stock>0 
			
	END	
	ELSE IF @SP_STATUS = 'SP_RPT_PurchaseReportSummary'
    BEGIN
	     IF(@Stk_MmId!=0)
		 BEGIN
		       SELECT CONVERT(varchar,SR.Stk_Date,105)AS DATE,  
                      COUNT(Distinct SR.Stk_DocKey)AS INVOICECOUNT,   
                      SUM(SR.Stk_PurchaseQty)AS QTY,    
                      SUM(SR.Stk_PurchaseQty*Stk_PurchaseRate)AS TOTALAMOUNT,
               	      BM.Branch_Name,
                      Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
                      bm.Branch_GstNo    
               FROM   StockRegister SR  
                      LEFT JOIN BranchMaster (NOLOCK)  BM
                  ON SR.Stk_BmId = BM.Branch_Id
				     LEFT JOIN MedicineMaster (NOLOCK)  MM
			      ON MM.Mm_ID=SR.Stk_MmId
               WHERE CONVERT(DATE,Stk_Date) BETWEEN CONVERT(DATE,@Stk_Date) AND CONVERT(DATE,@Stk_ExpDate) AND SR.Stk_Tran_Typ='C' AND Stk_DocType='4' AND MM.Mm_MtmId=@Stk_MmId
                     GROUP BY SR.Stk_Date,
               	      BM.Branch_Name,
               	      Bm.Branch_Address1,
               	      Bm.Branch_Address2,
               	      Bm.Branch_Address3,
               	      bm.Branch_GstNo     
                     ORDER BY SR.Stk_Date  ASC
		 END
		 ELSE
		 BEGIN
		       SELECT CONVERT(varchar,SR.Stk_Date,105)AS DATE,  
                      COUNT(Distinct SR.Stk_DocKey)AS INVOICECOUNT,   
                      SUM(SR.Stk_PurchaseQty)AS QTY,    
                      SUM(SR.Stk_PurchaseQty*Stk_PurchaseRate)AS TOTALAMOUNT,
               	      BM.Branch_Name,
                      Bm.Branch_Address1 + ' ' + Bm.Branch_Address2 + ' ' + Bm.Branch_Address3 AS Branch_Address,
                      bm.Branch_GstNo    
               FROM   StockRegister (NOLOCK)  SR  
                      LEFT JOIN BranchMaster (NOLOCK)  BM
                  ON SR.Stk_BmId = BM.Branch_Id
				     LEFT JOIN MedicineMaster (NOLOCK)  MM
			      ON MM.Mm_ID=SR.Stk_MmId
               WHERE CONVERT(DATE,Stk_Date) BETWEEN CONVERT(DATE,@Stk_Date) AND CONVERT(DATE,@Stk_ExpDate) AND SR.Stk_Tran_Typ='C' AND Stk_DocType='4' 
                     GROUP BY SR.Stk_Date,
               	      BM.Branch_Name,
               	      Bm.Branch_Address1,
               	      Bm.Branch_Address2,
               	      Bm.Branch_Address3,
               	      bm.Branch_GstNo     
                     ORDER BY SR.Stk_Date  ASC
		 END 
	End
	IF @SP_STATUS = 'GetCurrentStock'
		BEGIN
			if @Stk_MmId=0
			select cast(0 as bit) as chk,
					Item_Id as Stk_MmId  ,
					Item_Code as Mm_Code,
					Item_Name  as Mm_Name,
					Item_Batchno as Stk_BatchNo,
					Stk_LmId as Mm_FromLocationId,
					Lm_Name as Mm_FromLocation,
					Stk_MnfDate,
					Stk_ExpDate,
					Item_Stock as Stk_SalesQty,
					Item_Rate as Stk_SalesRate,
					Stk_SalesUom as Stk_SalesUom,
					Stk_LmId as Stk_LmId,
					Item_MRP as Stk_Mrp,
					Purchase_Item_Stock as Stk_PurchaseQty,
					Purchase_Item_Uom_Id as Stk_PurchaseUom,
					Purchase_Item_Rate as Stk_PurchaseRate
			from	vwStock  (NOLOCK) 
			where		Item_Stock>0 
		else
			select	cast(0 as bit) as chk,
					Item_Id as Stk_MmId  ,
					Item_Code as Mm_Code,
					Item_Name  as Mm_Name,
					Item_Batchno as Stk_BatchNo,
					Stk_LmId as Mm_FromLocationId,
					Lm_Name as Mm_FromLocation,
					Stk_MnfDate,
					Stk_ExpDate,
					Item_Stock as Stk_SalesQty,
					Item_Rate as Stk_SalesRate,
					Stk_SalesUom as Stk_SalesUom,
					Stk_LmId as Stk_LmId,
					Item_MRP as Stk_Mrp,
					Purchase_Item_Stock as Stk_PurchaseQty,
					Purchase_Item_Uom_Id as Stk_PurchaseUom,
					Purchase_Item_Rate as Stk_PurchaseRate
			from	vwStock (NOLOCK)  
			where		Item_Stock>0  
					and Item_Id=@Stk_MmId
		END
	ELSE	
	IF @SP_STATUS = 'GetStockBatchBlockList'
	BEGIN
	     SET @ID=(SELECT COUNT(*) 
                    FROM StockBatchBlock 
		           WHERE Sbb_MmId=@Stk_MmId 
		                 AND Sbb_BatchNo=@Stk_BatchNo);
		SELECT @ID;
	END
	ELSE IF @SP_STATUS = 'GET_STOCK_FOR_SYNCH'---Synch Stock List--Add Hasmukh
	BEGIN
	   SELECT	MM.Mm_ID AS Pms_Id,
				MM.Mm_Code AS Pms_Item_code,
				SM.Store_Code AS Pms_Store_Code,
				CONVERT(int,ISNULL(VW.Item_Stock,0)) AS Pms_Qty,
				ISNULL(VW.Item_Batchno,'') AS Pms_Batch_No,
				VW.Item_ExpDate	AS Pms_Exp_Date,
				VW.Item_MnfDate AS Pms_Mfg_Date,
				NULL AS Pms_Last_Updated,
				ISNULL(VW.Item_Rate,0) AS Pms_Sales_Rate,
				ISNULL(VW.Purchase_Item_Rate,0) AS Pms_Pur_Rate,
				ISNULL(VW.Item_MRP,0) AS Pms_Mrp
		FROM	MedicineMaster MM
				LEFT JOIN StoreMaster SM 
		ON		SM.Store_Id=1
				LEFT JOIN vwStock AS VW
		ON		VW.Item_Id=MM.Mm_ID 
		WHERE	MM.Mm_ID IN(SELECT Stk_MmId FROM StockRegister)
	END
	ELSE  IF @SP_STATUS = 'SP_RPT_StockLedgerReportProductwiseANDDatewise'
	BEGIN
	  IF(@Stk_MmId!=0)
	  BEGIN
           SELECT DT.*,
                  BM.Branch_Name,
		          ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
		          BM.Branch_GstNo   
             FROM   
                   (SELECT 1 AS ID, 
				           MTM.Mtm_TypeName AS DrugType,
						   MGM.Mgm_Name AS DrugGroup,
						   MCM.Mcm_Name AS DrugCategory, 
                           MM.Mm_Code AS DrugCode,  
                           MM.Mm_Name AS DrugName, 
                   	       MM.Mm_HsnCode AS HSNCODE, 
                           ISNULL(OPENINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
                           ISNULL(OPENINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
                           CONVERT(varchar,@Stk_Date,105) AS DATE,  
                           ('Opening Stock')AS Description,  
                           '' AS SUPPLIERNAME,  
                           '' AS BATCHNO,  
                           ISNULL((OPENINGSTOCK.SUPURCHASEQTY-OPENINGSTOCK.SUSALESQTY),0)AS SALEIN,  
                           0 AS SALESOUT,  
                           ISNULL((OPENINGSTOCK.PUPURCHASEQTY-OPENINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
                           0 AS PURCHASEOUT,  
                           1 AS TAGORDER  
                     FROM  MedicineMaster  (NOLOCK) MM 
					       LEFT JOIN MedicineTypeMaster (NOLOCK)  MTM
					   ON  MTM.Mtm_ID=MM.Mm_MtmId
					       LEFT JOIN MedicineGroupMaster (NOLOCK)  MGM
					   ON  MGM.Mgm_ID=MM.Mm_MgmId
					       LEFT JOIN MedicineCategoryMaster (NOLOCK)  MCM
					   ON  MCM.Mcm_ID=MM.Mm_MgmId
                           LEFT JOIN (SELECT SR.Stk_MmId,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
                                       SUOM.Uom_Name AS SALESUNIT,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
                                       PUOM.Uom_Name AS PURCHASEUNIT    
                                  FROM StockRegister  (NOLOCK) SR     
                                       INNER JOIN UomMaster (NOLOCK)  SUOM     
                                    ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                       INNER JOIN UomMaster (NOLOCK)  PUOM    
                                    ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                 WHERE CONVERT(DATE,Stk_Date)<CONVERT(DATE,@Stk_Date)   
                                       GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS OPENINGSTOCK  
                         ON MM.Mm_ID=OPENINGSTOCK.Stk_MmId  
                            INNER JOIN UomMaster  (NOLOCK) SSUOM     
                         ON SSUOM.Uom_ID=MM.MM_StkUom    
                            INNER JOIN UomMaster  (NOLOCK) PPUOM    
                         ON PPUOM.Uom_ID=MM.MM_PurchaseUom  
                      WHERE MM.Mm_MtmId=@Stk_MmId
                         UNION ALL  
                           
                         SELECT SR.Stk_Id AS ID,  
						        MTM.Mtm_TypeName AS DrugType,
						        MGM.Mgm_Name AS DrugGroup,
						        MCM.Mcm_Name AS DrugCategory, 
                                MM.Mm_Code AS DrugCode,  
                                MM.Mm_Name AS DrugName, 
                         	    MM.Mm_HsnCode AS HSNCODE, 
                                SUOM.Uom_Name AS SALESUNIT,  
                                PUOM.Uom_Name AS PURCHASEUNIT,  
                                CONVERT(VARCHAR,SR.Stk_Date,105) AS DATE,  
                               (CAST((CASE WHEN SR.Stk_DocType='6' THEN 'Add Opening Stock' ELSE   
                                     (CASE WHEN   
                                                SR.Stk_DocType='2'  
                                           THEN   
                                               'Sales Invoice'   
                                           ELSE   
                                           (CASE WHEN   
                                                     SR.Stk_DocType='3'  
                                                 THEN   
                                                     'Sales Return'  
                                                 ELSE  
                                                 (CASE WHEN   
                                                           Stk_DocType='4'  
                                                       THEN   
                                                            'Purchase Invoice'  
                                                       ELSE   
                                                       (CASE WHEN   
                                                                 Stk_DocType='5'  
                                                             THEN   
                                                                 'Purchase Return'  
                                                             ELSE (CASE WHEN   
                                                                            Stk_DocType='14'  
                                                                        THEN   
                                                                            'Stock Adjustment'  
                                                                   END)  
                                                        END)  
                                                  END)  
                                             END)  
                                         END)  
                                    END)AS VARCHAR(50))+''+  
                                    CAST((CASE WHEN SR.Stk_DocType='6' Then '' ELSE   
                                     (CASE WHEN   
                                                SR.Stk_DocType='2'  
                                           THEN   
                                               ',Bill No :'+CAST(SIH.Sih_No AS VARCHAR(20))  
                                           ELSE   
                                           (CASE WHEN   
                                                     SR.Stk_DocType='3'  
                                                 THEN   
                              ',Bill No :'+CAST(SRH.Srh_No AS VARCHAR(20))  
                                                 ELSE  
                                                 (CASE WHEN   
                                                           Stk_DocType='4'  
                                                       THEN   
                                                             ',Bill No :'+CAST(Pih_No AS VARCHAR(20))  
                                                       ELSE   
                                                       (CASE WHEN   
                                                                 Stk_DocType='5'  
                                                             THEN   
                                                                  ',Bill No :'+CAST(Prh_No AS VARCHAR(20))  
                                                              ELSE (CASE WHEN   
                                                                            Stk_DocType='14'  
                                                                        THEN   
                                                                             ''  
                                                                   END)  
                                                        END)  
                                                  END)  
                                             END)  
                                         END)  
                                    END)AS VARCHAR(200)))AS Description,  
                                       
                                ((CASE WHEN SR.Stk_DocType='6'   
                                           THEN ''   
                                           ELSE   
                                          (CASE WHEN   
                                                    SR.Stk_DocType='2'  
                                                THEN   
                                                     SIPM.Pm_FullName  
                                                ELSE   
                                                    (CASE WHEN   
                                                              SR.Stk_DocType='3'  
                                                           THEN   
                                                               SRPM.Pm_FullName  
                                                           ELSE  
                                                           (CASE WHEN   
                                                                     Stk_DocType='4'  
                                                                 THEN   
                                                                     PIVM.Vendor_Name  
                                                                 ELSE   
                                                                 (CASE WHEN   
                                                                           Stk_DocType='5'  
                                                                       THEN   
                                                                           PRVM.Vendor_Name  
                                                                   END)  
                                                              END)  
                                                      END)  
                                              END)  
                                         END)) AS SUPPLIERNAME,  
                                 SR.Stk_BatchNo AS BATCHNO,  
                                (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_SalesQty  ELSE 0 END)AS SALEIN,  
                                 (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_SalesQty  ELSE 0 END) AS SALESOUT,  
                                (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_PurchaseQty  ELSE 0 END)AS PURCHASIN,  
                                (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_PurchaseQty  ELSE 0 END) AS PURCHASEOUT,  
                                2 AS TAGORDER   
                           FROM StockRegister (NOLOCK)  SR   
                                INNER JOIN MedicineMaster  (NOLOCK) MM  
                             ON MM.Mm_ID=SR.Stk_MmId  
							    LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
					         ON MTM.Mtm_ID=MM.Mm_MtmId
					            LEFT JOIN MedicineGroupMaster (NOLOCK)  MGM
					         ON MGM.Mgm_ID=MM.Mm_MgmId
					            LEFT JOIN MedicineCategoryMaster (NOLOCK)  MCM
					         ON MCM.Mcm_ID=MM.Mm_MgmId
                                INNER JOIN UomMaster (NOLOCK)  SUOM     
                             ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                INNER JOIN UomMaster  (NOLOCK) PUOM    
                             ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                  
                                LEFT JOIN PurchaseInvoiceDetail  (NOLOCK) PID   
                             ON PID.Pid_MmId=SR.Stk_MmId AND PID.Pid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PID.Pid_PihKey  
                                LEFT JOIN PurchaseInvoiceHeader (NOLOCK)  PIH   
                             ON PIH.Pih_Key=PID.Pid_PihKey  
                                LEFT JOIN VendorMaster  (NOLOCK) PIVM   
                             ON PIVM.Vendor_ID=PIH.Pih_VenId  
                              
                                LEFT JOIN PurchaseReturnDetail  (NOLOCK) PRD   
                             ON PRD.Prd_MmId=SR.Stk_MmId AND PRD.Prd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PRD.Prd_PrhId  
                                LEFT JOIN PurchaseReturnHeader  (NOLOCK) PRH   
                             ON PRH.Prh_Id=PRD.Prd_PrhId  
                                LEFT JOIN VendorMaster (NOLOCK)  PRVM   
                             ON PRVM.Vendor_ID=PRH.Prh_VendorId  
                               
                                LEFT JOIN SalesInvoiceItemDetail (NOLOCK)  SIID   
                             ON SIID.Sid_Mm_Id=SR.Stk_MmId AND SIID.Sid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SIID.Sid_Sih_Key  
                                LEFT JOIN SalesInvoiceHeader  (NOLOCK) SIH  
                             ON SIH.Sih_key=SIID.Sid_Sih_Key  
                                LEFT JOIN PatientMaster (NOLOCK)  SIPM   
                             ON SIPM.Pm_Id=SIH.Sih_Pm_Id  
                               
                               
                                LEFT JOIN SalesReturnDetail  (NOLOCK) SRD  
                             ON SRD.Srd_MmId=SR.Stk_MmId AND SRD.Srd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SRD.Srd_SrhId  
                                LEFT JOIN SalesReturnHeader  (NOLOCK) SRH  
                             ON SRH.Srh_Id=SRD.Srd_SrhId  
                                LEFT JOIN PatientMaster  (NOLOCK) SRPM   
                             ON SRPM.Pm_Id=SRH.Srh_CustId  
                          WHERE CONVERT(DATE,SR.Stk_Date) BETWEEN CONVERT(DATE,@Stk_Date) AND CONVERT(DATE,@Stk_MnfDate)  
						        AND MM.Mm_MtmId=@Stk_MmId
                          UNION ALL    
                          SELECT  3 AS ID,  
							      MTM.Mtm_TypeName AS DrugType,
						          MGM.Mgm_Name AS DrugGroup,
						          MCM.Mcm_Name AS DrugCategory,  
                                  MM.Mm_Code AS DrugCode,  
                                  MM.Mm_Name AS DrugName,  
                          	      MM.Mm_HsnCode AS HSNCODE,
                                  ISNULL(CLOSINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
                                  ISNULL(CLOSINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
                                  CONVERT(varchar,@Stk_MnfDate,105) AS DATE,  
                                  ('Closing Stock')AS Description,  
                                  '' AS SUPPLIERNAME,  
                                  '' AS BATCHNO,  
                                  ISNULL((CLOSINGSTOCK.SUPURCHASEQTY-CLOSINGSTOCK.SUSALESQTY),0)AS SALEIN,  
                                  0 AS SALESOUT,  
                                  ISNULL((CLOSINGSTOCK.PUPURCHASEQTY-CLOSINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
                                  0 AS PURCHASEOUT,  
                                  3 AS TAGORDER  
                            FROM  MedicineMaster (NOLOCK)  MM
							      LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
					           ON MTM.Mtm_ID=MM.Mm_MtmId
					              LEFT JOIN MedicineGroupMaster (NOLOCK)  MGM
					           ON MGM.Mgm_ID=MM.Mm_MgmId
					              LEFT JOIN MedicineCategoryMaster (NOLOCK)  MCM
					           ON MCM.Mcm_ID=MM.Mm_MgmId 
                                  LEFT JOIN
                                  (SELECT SR.Stk_MmId,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
                                         SUOM.Uom_Name AS SALESUNIT,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
                                         PUOM.Uom_Name AS PURCHASEUNIT    
                                    FROM StockRegister  (NOLOCK) SR     
                                         INNER JOIN UomMaster SUOM     
                                      ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                         INNER JOIN UomMaster PUOM    
                                      ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                   WHERE CONVERT(DATE,Stk_Date)<= CONVERT(DATE,@Stk_MnfDate)    
                                         GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS CLOSINGSTOCK  
                                  
                               ON MM.Mm_ID=CLOSINGSTOCK.Stk_MmId  
                                  INNER JOIN UomMaster (NOLOCK)  SSUOM     
                               ON SSUOM.Uom_ID=MM.MM_StkUom    
                                  INNER JOIN UomMaster (NOLOCK)  PPUOM    
                               ON PPUOM.Uom_ID=MM.MM_PurchaseUom 
							WHERE MM.Mm_MtmId=@Stk_MmId)AS DT
	  LEFT JOIN BranchMaster (NOLOCK)  BM ON BM.Branch_Id=1
	  ORDER BY DrugCode,TAGORDER,DATE,ID ASC 
	END
	ELSE
	BEGIN
	      SELECT DT.*,
                  BM.Branch_Name,
		          ISNULL(BM.Branch_Address1,'')+' '+ISNULL(BM.Branch_Address2,'')+' '+ISNULL(BM.Branch_Address3,'')AS Branch_Address,
		          BM.Branch_GstNo   
             FROM   
                   (SELECT 1 AS ID, 
				           MTM.Mtm_TypeName AS DrugType,
						   MGM.Mgm_Name AS DrugGroup,
						   MCM.Mcm_Name AS DrugCategory, 
                           MM.Mm_Code AS DrugCode,  
                           MM.Mm_Name AS DrugName, 
                   	       MM.Mm_HsnCode AS HSNCODE, 
                           ISNULL(OPENINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
                           ISNULL(OPENINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
                           CONVERT(varchar,@Stk_Date,105) AS DATE,  
                           ('Opening Stock')AS Description,  
                           '' AS SUPPLIERNAME,  
                           '' AS BATCHNO,  
                           ISNULL((OPENINGSTOCK.SUPURCHASEQTY-OPENINGSTOCK.SUSALESQTY),0)AS SALEIN,  
                           0 AS SALESOUT,  
                           ISNULL((OPENINGSTOCK.PUPURCHASEQTY-OPENINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
                           0 AS PURCHASEOUT,  
                           1 AS TAGORDER  
                     FROM  MedicineMaster  (NOLOCK) MM 
					       LEFT JOIN MedicineTypeMaster (NOLOCK)  MTM
					   ON  MTM.Mtm_ID=MM.Mm_MtmId
					       LEFT JOIN MedicineGroupMaster (NOLOCK)  MGM
					   ON  MGM.Mgm_ID=MM.Mm_MgmId
					       LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
					   ON  MCM.Mcm_ID=MM.Mm_MgmId
                           LEFT JOIN (SELECT SR.Stk_MmId,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
                                       SUOM.Uom_Name AS SALESUNIT,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
                                       SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
                                       PUOM.Uom_Name AS PURCHASEUNIT    
                                  FROM StockRegister (NOLOCK)  SR     
                                       INNER JOIN UomMaster  (NOLOCK) SUOM     
                                    ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                       INNER JOIN UomMaster  (NOLOCK) PUOM    
                                    ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                 WHERE CONVERT(DATE,Stk_Date)<CONVERT(DATE,@Stk_Date)   
                                       GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS OPENINGSTOCK  
                         ON MM.Mm_ID=OPENINGSTOCK.Stk_MmId  
                            INNER JOIN UomMaster (NOLOCK)  SSUOM     
                         ON SSUOM.Uom_ID=MM.MM_StkUom    
                            INNER JOIN UomMaster  (NOLOCK) PPUOM    
                         ON PPUOM.Uom_ID=MM.MM_PurchaseUom 
                         UNION ALL  
                           
                         SELECT SR.Stk_Id AS ID,  
						        MTM.Mtm_TypeName AS DrugType,
						        MGM.Mgm_Name AS DrugGroup,
						        MCM.Mcm_Name AS DrugCategory, 
                                MM.Mm_Code AS DrugCode,  
                                MM.Mm_Name AS DrugName, 
                         	    MM.Mm_HsnCode AS HSNCODE, 
                                SUOM.Uom_Name AS SALESUNIT,  
                                PUOM.Uom_Name AS PURCHASEUNIT,  
                                CONVERT(VARCHAR,SR.Stk_Date,105) AS DATE,  
                               (CAST((CASE WHEN SR.Stk_DocType='6' THEN 'Add Opening Stock' ELSE   
                                     (CASE WHEN   
                                                SR.Stk_DocType='2'  
                                           THEN   
                                               'Sales Invoice'   
                                           ELSE   
                                           (CASE WHEN   
                                                     SR.Stk_DocType='3'  
                                                 THEN   
                                                     'Sales Return'  
                                                 ELSE  
                                                 (CASE WHEN   
                                                           Stk_DocType='4'  
                                                       THEN   
                                                            'Purchase Invoice'  
                                                       ELSE   
                                                       (CASE WHEN   
                                                                 Stk_DocType='5'  
                                                             THEN   
                                                                 'Purchase Return'  
                                                             ELSE (CASE WHEN   
                                                                            Stk_DocType='14'  
                                                                        THEN   
                                                                            'Stock Adjustment'  
                                                                   END)  
                                                        END)  
                                                  END)  
                                             END)  
                                         END)  
                                    END)AS VARCHAR(50))+''+  
                                    CAST((CASE WHEN SR.Stk_DocType='6' Then '' ELSE   
                                     (CASE WHEN   
                                                SR.Stk_DocType='2'  
                                           THEN   
                                               ',Bill No :'+CAST(SIH.Sih_No AS VARCHAR(20))  
                                           ELSE   
                                           (CASE WHEN   
                                                     SR.Stk_DocType='3'  
                                                 THEN   
                              ',Bill No :'+CAST(SRH.Srh_No AS VARCHAR(20))  
                                                 ELSE  
                                                 (CASE WHEN   
                                                           Stk_DocType='4'  
                                                       THEN   
                                                             ',Bill No :'+CAST(Pih_No AS VARCHAR(20))  
                                                       ELSE   
                                                       (CASE WHEN   
                                                                 Stk_DocType='5'  
                                                             THEN   
                                                                  ',Bill No :'+CAST(Prh_No AS VARCHAR(20))  
                                                              ELSE (CASE WHEN   
                                                                            Stk_DocType='14'  
                                                                        THEN   
                                                                             ''  
                                                                   END)  
                                                        END)  
                                                  END)  
                                             END)  
                                         END)  
                                    END)AS VARCHAR(200)))AS Description,  
                                       
                                ((CASE WHEN SR.Stk_DocType='6'   
                                           THEN ''   
                                           ELSE   
                                          (CASE WHEN   
                                                    SR.Stk_DocType='2'  
                                                THEN   
                                                     SIPM.Pm_FullName  
                                                ELSE   
                                                    (CASE WHEN   
                                                              SR.Stk_DocType='3'  
                                                           THEN   
                                                               SRPM.Pm_FullName  
                                                           ELSE  
                                                           (CASE WHEN   
                                                                     Stk_DocType='4'  
                                                                 THEN   
                                                                     PIVM.Vendor_Name  
                                                                 ELSE   
                                                                 (CASE WHEN   
                                                                           Stk_DocType='5'  
                                                                       THEN   
                                                                           PRVM.Vendor_Name  
                                                                   END)  
                                                              END)  
                                                      END)  
                                              END)  
                                         END)) AS SUPPLIERNAME,  
                                 SR.Stk_BatchNo AS BATCHNO,  
                                (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_SalesQty  ELSE 0 END)AS SALEIN,  
                                 (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_SalesQty  ELSE 0 END) AS SALESOUT,  
                                (CASE WHEN Stk_Tran_Typ='C' THEN  Stk_PurchaseQty  ELSE 0 END)AS PURCHASIN,  
                                (CASE WHEN Stk_Tran_Typ='D' THEN  Stk_PurchaseQty  ELSE 0 END) AS PURCHASEOUT,  
                                2 AS TAGORDER   
                           FROM StockRegister (NOLOCK)  SR   
                                INNER JOIN MedicineMaster (NOLOCK)  MM  
                             ON MM.Mm_ID=SR.Stk_MmId  
							    LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
					         ON MTM.Mtm_ID=MM.Mm_MtmId
					            LEFT JOIN MedicineGroupMaster  (NOLOCK) MGM
					         ON MGM.Mgm_ID=MM.Mm_MgmId
					            LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
					         ON MCM.Mcm_ID=MM.Mm_MgmId
                                INNER JOIN UomMaster (NOLOCK)  SUOM     
                             ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                INNER JOIN UomMaster (NOLOCK)  PUOM    
                             ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                  
                                LEFT JOIN PurchaseInvoiceDetail  (NOLOCK) PID   
                             ON PID.Pid_MmId=SR.Stk_MmId AND PID.Pid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PID.Pid_PihKey  
                                LEFT JOIN PurchaseInvoiceHeader  (NOLOCK) PIH   
                             ON PIH.Pih_Key=PID.Pid_PihKey  
                                LEFT JOIN VendorMaster (NOLOCK)  PIVM   
                             ON PIVM.Vendor_ID=PIH.Pih_VenId  
                              
                                LEFT JOIN PurchaseReturnDetail  (NOLOCK) PRD   
                             ON PRD.Prd_MmId=SR.Stk_MmId AND PRD.Prd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=PRD.Prd_PrhId  
                                LEFT JOIN PurchaseReturnHeader  (NOLOCK) PRH   
                             ON PRH.Prh_Id=PRD.Prd_PrhId  
                                LEFT JOIN VendorMaster (NOLOCK)  PRVM   
                             ON PRVM.Vendor_ID=PRH.Prh_VendorId  
                               
                                LEFT JOIN SalesInvoiceItemDetail  (NOLOCK) SIID   
                             ON SIID.Sid_Mm_Id=SR.Stk_MmId AND SIID.Sid_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SIID.Sid_Sih_Key  
                                LEFT JOIN SalesInvoiceHeader (NOLOCK)  SIH  
                             ON SIH.Sih_key=SIID.Sid_Sih_Key  
                                LEFT JOIN PatientMaster (NOLOCK)  SIPM   
                             ON SIPM.Pm_Id=SIH.Sih_Pm_Id  
                               
                               
                                LEFT JOIN SalesReturnDetail (NOLOCK)  SRD  
                             ON SRD.Srd_MmId=SR.Stk_MmId AND SRD.Srd_BatchNo=SR.Stk_BatchNo AND SR.Stk_DocKey=SRD.Srd_SrhId  
                                LEFT JOIN SalesReturnHeader  (NOLOCK) SRH  
                             ON SRH.Srh_Id=SRD.Srd_SrhId  
                                LEFT JOIN PatientMaster  (NOLOCK) SRPM   
                             ON SRPM.Pm_Id=SRH.Srh_CustId  
                          WHERE CONVERT(DATE,SR.Stk_Date) BETWEEN CONVERT(DATE,@Stk_Date) AND CONVERT(DATE,@Stk_MnfDate)  
						        
                          UNION ALL    
                          SELECT  3 AS ID,  
							      MTM.Mtm_TypeName AS DrugType,
						          MGM.Mgm_Name AS DrugGroup,
						          MCM.Mcm_Name AS DrugCategory,  
                                  MM.Mm_Code AS DrugCode,  
                                  MM.Mm_Name AS DrugName,  
                          	      MM.Mm_HsnCode AS HSNCODE,
                                  ISNULL(CLOSINGSTOCK.SALESUNIT,SSUOM.Uom_Name)AS SALESUNIT,  
                                  ISNULL(CLOSINGSTOCK.PURCHASEUNIT,PPUOM.Uom_Name)AS PURCHASEUNIT,  
                                  CONVERT(varchar,@Stk_MnfDate,105) AS DATE,  
                                  ('Closing Stock')AS Description,  
                                  '' AS SUPPLIERNAME,  
                                  '' AS BATCHNO,  
                                  ISNULL((CLOSINGSTOCK.SUPURCHASEQTY-CLOSINGSTOCK.SUSALESQTY),0)AS SALEIN,  
                                  0 AS SALESOUT,  
                                  ISNULL((CLOSINGSTOCK.PUPURCHASEQTY-CLOSINGSTOCK.PUSALESQTY),0)AS PURCHASIN,  
                                  0 AS PURCHASEOUT,  
                                  3 AS TAGORDER  
                            FROM  MedicineMaster  (NOLOCK) MM
							      LEFT JOIN MedicineTypeMaster  (NOLOCK) MTM
					           ON MTM.Mtm_ID=MM.Mm_MtmId
					              LEFT JOIN MedicineGroupMaster (NOLOCK)  MGM
					           ON MGM.Mgm_ID=MM.Mm_MgmId
					              LEFT JOIN MedicineCategoryMaster  (NOLOCK) MCM
					           ON MCM.Mcm_ID=MM.Mm_MgmId 
                                  LEFT JOIN
                                  (SELECT SR.Stk_MmId,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_SalesQty ELSE 0 END)AS SUSALESQTY,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_SalesQty ELSE 0 END)AS SUPURCHASEQTY,    
                                         SUOM.Uom_Name AS SALESUNIT,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='D' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUSALESQTY,    
                                         SUM(CASE WHEN SR.Stk_Tran_Typ='C' THEN SR.Stk_PurchaseQty ELSE 0 END)AS PUPURCHASEQTY,    
                                         PUOM.Uom_Name AS PURCHASEUNIT    
                                    FROM StockRegister (NOLOCK)  SR     
                                         INNER JOIN UomMaster  (NOLOCK) SUOM     
                                      ON SUOM.Uom_ID=SR.Stk_SalesUom    
                                         INNER JOIN UomMaster (NOLOCK)  PUOM    
                                      ON PUOM.Uom_ID=SR.Stk_PurchaseUom    
                                   WHERE CONVERT(DATE,Stk_Date)<= CONVERT(DATE,@Stk_MnfDate)    
                                         GROUP BY SR.Stk_MmId,SUOM.Uom_Name,PUOM.Uom_Name)AS CLOSINGSTOCK  
                                  
                               ON MM.Mm_ID=CLOSINGSTOCK.Stk_MmId  
                                  INNER JOIN UomMaster  (NOLOCK) SSUOM     
                               ON SSUOM.Uom_ID=MM.MM_StkUom    
                                  INNER JOIN UomMaster  (NOLOCK) PPUOM    
                               ON PPUOM.Uom_ID=MM.MM_PurchaseUom 
							   )AS DT
	  LEFT JOIN BranchMaster  (NOLOCK) BM ON BM.Branch_Id=1
	  ORDER BY DrugCode,TAGORDER,DATE,ID ASC 
	END 
END

 ELSE IF @SP_STATUS = 'ExpiredStock_Report'
    BEGIN
			--SELECT	vwStockBatchWise.*,
			--		Branch_Name, 
	  --          	Branch_Address1 as Branch_Address, 
	  --          	Branch_GstNo,
	  --          	Mm_HsnCode AS HsnCode,
	  --              MTM.Mtm_TypeName AS DrugType,
	  --              MGM.Mgm_Name  AS DrugGroup,
	  --              MCM.Mcm_Name AS DrugCategory
			--FROM		vwStockBatchWise  (NOLOCK) 
			--		left  join (select top 1 * from BranchMaster)as BranchMaster  
			--on			0=0
			--		Left join MedicineMaster  (NOLOCK) MM
			--ON			MM.Mm_ID=vwStockBatchWise.Stk_MmId
			--		Left join MedicineTypeMaster MTM
			--ON			MTM.Mtm_ID=MM.Mm_MtmId
			--		Left join MedicineGroupMaster MGM
			--ON			MGM.Mgm_ID=MM.Mm_MgmId
			--		Left join MedicineCategoryMaster MCM
			--ON			MCM.Mcm_ID=MM.Mm_McmId
			--WHERE		CONVERT(date, Stk_ExpDate) <=  CONVERT(date, GETDATE())
			--		AND ISNULL(QTY, 0) > 0
		SELECT	vwExpiredStockBatchWise.*,
				Branch_Name, 
	            Branch_Address1 as Branch_Address, 
	            Branch_GstNo,
	            Mm_HsnCode AS HsnCode,
	            MTM.Mtm_TypeName AS DrugType,
	            MGM.Mgm_Name  AS DrugGroup,
	            MCM.Mcm_Name AS DrugCategory
		FROM	vwExpiredStockBatchWise  (NOLOCK) 
	            left  join (select top 1 * from BranchMaster)as BranchMaster  on 0=0
	            Left join MedicineMaster  (NOLOCK) MM
		ON		MM.Mm_ID=vwExpiredStockBatchWise.Stk_MmId
	            Left join MedicineTypeMaster MTM
		ON			MTM.Mtm_ID=MM.Mm_MtmId
	            Left join MedicineGroupMaster MGM
		ON			MGM.Mgm_ID=MM.Mm_MgmId
				Left join MedicineCategoryMaster MCM
		ON			MCM.Mcm_ID=MM.Mm_McmId
		WHERE	CONVERT(date, Stk_ExpDate) <=  CONVERT(date, GETDATE())
                AND ISNULL(QTY, 0) > 0
    END
	 ELSE IF @SP_STATUS = 'Stock_Transaction'
    BEGIN
		IF(@Stk_BatchNo='All List')
		BEGIN
        	SELECT	(CASE WHEN BTM.Btm_ModeName IS NOT NULL 
        						THEN  BTM.Btm_ModeName 
        						ELSE (CASE WHEN SR.Stk_DocType=6 
        									THEN 'Opening Stock' 
        									ELSE 'Stock Adjustment' 
        							END)  
        				END)AS Type,
        				(CASE WHEN SR.Stk_DocType=2 
        						THEN SIH.Sih_No 
        						ELSE (CASE WHEN SR.Stk_DocType=3 
        									THEN Srh_No 
        									ELSE (CASE WHEN SR.Stk_DocType=4 
        												THEN PIH.Pih_No
        													ELSE (CASE WHEN SR.Stk_DocType=5 
        																THEN PRH.Prh_No 
        																ELSE SR.Stk_DocNo
        										  END)
        								END)
        					END)
        			END)AS InvoiceNo,
        			SR.Stk_Date AS DATE,
        			MM.Mm_Code AS  DRUGCODE,
        			MM.Mm_Name AS DRUGNAME,
					UOM.Uom_Name AS UOM,
        			Stk_BatchNo,
        			Stk_SalesQty,
        			Stk_Mrp,
        			(CASE WHEN Stk_Tran_Typ='C' THEN 'IN' ELSE 'OUT' END)AS Stk_Tran_Typ
          FROM StockRegister SR
        	   LEFT JOIN SalesInvoiceHeader SIH 
        	ON SIH.Sih_Key=SR.Stk_DocKey
        		AND SR.Stk_DocType=2
        		LEFT JOIN PurchaseInvoiceHeader	PIH
        	ON	PIH.Pih_Key=SR.Stk_DocKey
        		AND SR.Stk_DocType=4
        		LEFT JOIN SalesReturnHeader SRH
        	ON	SRH.Srh_Id=SR.Stk_DocKey
        		AND SR.Stk_DocType=3
        		LEFT JOIN PurchaseReturnHeader PRH
        	ON	PRH.Prh_Id=SR.Stk_DocKey
        		AND SR.Stk_DocType=5
        		LEFT JOIN BookTypeMaster BTM
        	ON	BTM.Btm_Id=SR.Stk_DocType
        		LEFT JOIN MedicineMaster  MM
        	ON	SR.Stk_MmId=MM.Mm_ID
				INNER JOIN UomMaster UOM
			ON	UOM.Uom_ID=SR.Stk_SalesUom
        	WHERE MM.Mm_Code=@Stk_Barcode  order by Stk_Date,Stk_BatchNo ASC
		END
		ELSE
		BEGIN
			 SELECT	(CASE WHEN BTM.Btm_ModeName IS NOT NULL 
        						THEN  BTM.Btm_ModeName 
        						ELSE (CASE WHEN SR.Stk_DocType=6 
        									THEN 'Opening Stock' 
        									ELSE 'Stock Adjustment' 
        							END)  
        				END)AS Type,
        				(CASE WHEN SR.Stk_DocType=2 
        						THEN SIH.Sih_No 
        						ELSE (CASE WHEN SR.Stk_DocType=3 
        									THEN Srh_No 
        									ELSE (CASE WHEN SR.Stk_DocType=4 
        												THEN PIH.Pih_No
        													ELSE (CASE WHEN SR.Stk_DocType=5 
        																THEN PRH.Prh_No 
        																ELSE SR.Stk_DocNo
        										  END)
        								END)
        					END)
        			END)AS InvoiceNo,
        			SR.Stk_Date AS DATE,
        			MM.Mm_Code AS  DRUGCODE,
        			MM.Mm_Name AS DRUGNAME,
					UOM.Uom_Name AS UOM,
        			Stk_BatchNo,
        			Stk_SalesQty,
        			Stk_Mrp,
        			(CASE WHEN Stk_Tran_Typ='C' THEN 'IN' ELSE 'OUT' END)AS Stk_Tran_Typ
          FROM StockRegister SR
        	   LEFT JOIN SalesInvoiceHeader SIH 
        	ON SIH.Sih_Key=SR.Stk_DocKey
        		AND SR.Stk_DocType=2
        		LEFT JOIN PurchaseInvoiceHeader	PIH
        	ON	PIH.Pih_Key=SR.Stk_DocKey
        		AND SR.Stk_DocType=4
        		LEFT JOIN SalesReturnHeader SRH
        	ON	SRH.Srh_Id=SR.Stk_DocKey
        		AND SR.Stk_DocType=3
        		LEFT JOIN PurchaseReturnHeader PRH
        	ON	PRH.Prh_Id=SR.Stk_DocKey
        		AND SR.Stk_DocType=5
        		LEFT JOIN BookTypeMaster BTM
        	ON	BTM.Btm_Id=SR.Stk_DocType
        		LEFT JOIN MedicineMaster  MM
        	ON	SR.Stk_MmId=MM.Mm_ID
				INNER JOIN UomMaster UOM
			ON	UOM.Uom_ID=SR.Stk_SalesUom
        	WHERE MM.Mm_Code=@Stk_Barcode AND Stk_BatchNo=@Stk_BatchNo order by Stk_Date ASC
		END
	END
END


	


GO
/****** Object:  StoredProcedure [dbo].[SP_StoreMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:    <Author,,Name>
-- Create date: <Create Date,,>
-- Description:  <Description,,>
-- =============================================
-- [dbo].[SP_StoreMaster] @SP_STATUS = 'MobileValidation', @Store_MobNo = '12121212', @Store_Id = 1
CREATE PROCEDURE [dbo].[SP_StoreMaster]
@SP_STATUS		nvarchar(100) = '',
@USER			int = 0,
@Store_Id		[bigint] = 0,
@Store_Name		[nvarchar](50) = '',
@Store_Address1 [nvarchar](199) = '',
@Store_Address2 [nvarchar](199) = '',
@Store_Address3 [nvarchar](199) = '',
@Store_CountryId [BIGINT] = 0,
@Store_StateId	[BIGINT] = 0,
@Store_CityId	[bigint] = 0,
@Store_AreaId	[bigint] = 0,
@Store_PhNo		[nvarchar](50) = '',
@Store_PhNo1	[nvarchar](50) = '',
@Store_MobNo	[nvarchar](50) = '',
@Store_FaxNo	[nvarchar](50) = '',
@Store_Email	[nvarchar](199) = '',
@Store_Web		[nvarchar](199) = '',
@Store_CstNo	[nvarchar](50) = '',
@Store_CstDt	[datetime] = null,
@Store_GstNo	[nvarchar](50) = '',
@Store_GstDt	[datetime] = null,
@Store_RegNo	[nvarchar](50) = '',
@Store_RegDt	[datetime] = null,
@Store_UsActive [bit] = 0,
@Store_Logo		image = NULL,
@Store_Pan_No	varchar(50) = '',
@Store_GstRegisted      bit=0,
@Store_UnderCompositeScheme  bit=0,

@Store_Code		  nvarchar(50)='',
@Store_Aadhar_No  nvarchar(50)='',
@Store_Taluka	[nvarchar](MAX) = '',
@Store_PoVillage [nvarchar](MAX) = '',
@Store_Landmark	[nvarchar](MAX) = '',
@Store_Pincode	[nvarchar](30) = '',
@Store_StoreOwner [nvarchar](500) = '',
@Store_ContactPerson [nvarchar](500) = '',
@Store_ContactPersonPh [nvarchar](50) = '',
@Store_Email2	[nvarchar](199) = '',
@Store_PanDoc	nvarchar(MAX) = '',
@Store_AdhaarDoc nvarchar(MAX) = '',
@Store_GstDoc	nvarchar(MAX) = '',
@Store_NoDecDoc nvarchar(MAX) = '',
@Store_DrugLice	nvarchar(50) ='',
@Store_DrugLiceDt [datetime] = NULL,
@Store_DrugLicDoc1 nvarchar(MAX) = '',
@Store_DrugLice2 nvarchar(50) = '',
@Store_DrugLiceDt2 datetime = NULL,
@Store_DrugLicDoc2 nvarchar(MAX) = '',
@Store_PermOpenDoc nvarchar(MAX) = '',
@Store_StoreAggreDoc nvarchar(MAX) = '',
@Store_AuthPersonPhoto nvarchar(MAX) = '',
@Store_AuthLetterDoc nvarchar(MAX) = '',
@Store_SecChequeDoc nvarchar(MAX) = '',
@Store_SecCheque2Doc nvarchar(MAX) = '',
@Store_SecCheque3Doc nvarchar(MAX) = '',
@PharmacistName   nvarchar(50)=''

AS
BEGIN
	IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Store_Id = ISNULL(MAX(Store_Id), 0) + 1
			FROM		StoreMaster (NOLOCK) 

			INSERT 
			INTO		StoreMaster (Store_Id,Store_Name,Store_Address1,Store_CountryId,Store_StateId,Store_CityId,Store_AreaId,Store_Taluka,Store_PoVillage,
									Store_Landmark,Store_Pincode,Store_StoreOwner,Store_ContactPerson,Store_ContactPersonPh,Store_Email2,
									Store_PhNo,Store_PhNo1,Store_MobNo,Store_FaxNo,Store_Email,Store_Web,Store_CstNo,Store_CstDt,Store_GstNo,Store_GstDt,Store_RegNo,Store_RegDt,Store_CreatedBy,
									Store_CreatedDt,Store_UsActive,Store_Logo,Store_Pan_No,Store_GstRegisted,Store_UnderCompositeScheme,Store_DrugLice,Store_DrugLiceDt,
									Store_Code,Store_Aadhar_No,Store_PanDoc,Store_AdhaarDoc,Store_GstDoc,Store_NoDecDoc,Store_DrugLicDoc1,Store_DrugLice2,Store_DrugLiceDt2,
									Store_DrugLicDoc2,Store_PermOpenDoc, Store_StoreAggreDoc,Store_AuthPersonPhoto,Store_AuthLetterDoc,Store_SecChequeDoc,Store_SecCheque2Doc,Store_SecCheque3Doc,PharmacistName)
			VALUES					(@Store_Id, @Store_Name, @Store_Address1, @Store_CountryId, @Store_StateId, @Store_CityId, @Store_AreaId,@Store_Taluka,@Store_PoVillage,
									@Store_Landmark,@Store_Pincode,@Store_StoreOwner,@Store_ContactPerson,@Store_ContactPersonPh,@Store_Email2,
									@Store_PhNo,@Store_PhNo1, @Store_MobNo, @Store_FaxNo, @Store_Email, @Store_Web, @Store_CstNo, @Store_CstDt, @Store_GstNo, @Store_GstDt, @Store_RegNo, @Store_RegDt, @USER, GETDATE(), 
									@Store_UsActive, @Store_Logo, @Store_Pan_No,@Store_GstRegisted, @Store_UnderCompositeScheme, @Store_DrugLice,@Store_DrugLiceDt,
									@Store_Code,@Store_Aadhar_No,@Store_PanDoc,@Store_AdhaarDoc,@Store_GstDoc,@Store_NoDecDoc,@Store_DrugLicDoc1,@Store_DrugLice2,@Store_DrugLiceDt2,
									@Store_DrugLicDoc2,@Store_PermOpenDoc, @Store_StoreAggreDoc,@Store_AuthPersonPhoto,@Store_AuthLetterDoc,@Store_SecChequeDoc,@Store_SecCheque2Doc,@Store_SecCheque3Doc,@PharmacistName)
		END

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		StoreMaster
			SET			Store_Name = @Store_Name, Store_Code = @Store_Code, Store_Address1 = @Store_Address1, Store_CountryId = @Store_CountryId, Store_StateId = @Store_StateId,
						Store_CityId = @Store_CityId, Store_AreaId = @Store_AreaId, Store_Taluka = @Store_Taluka, Store_PoVillage = @Store_PoVillage,Store_PanDoc = @Store_PanDoc,Store_AdhaarDoc = @Store_AdhaarDoc,
						Store_Landmark = @Store_Landmark, Store_Pincode = @Store_Pincode, Store_StoreOwner = @Store_StoreOwner,Store_ContactPerson = @Store_ContactPerson,
						Store_ContactPersonPh = @Store_ContactPersonPh,Store_Email2 = @Store_Email2,Store_PhNo = @Store_PhNo,Store_PhNo1 = @Store_PhNo1, Store_MobNo = @Store_MobNo,
						Store_FaxNo = @Store_FaxNo,Store_Email = @Store_Email,Store_Web = @Store_Web,Store_CstNo = @Store_CstNo,Store_CstDt = CAST(@Store_CstDt AS DATE),Store_GstNo = @Store_GstNo,
						Store_GstDt = @Store_GstDt,Store_RegNo = @Store_RegNo,Store_RegDt = CAST(@Store_RegDt AS DATE),Store_UpdatedBy = @USER,Store_UpdatedDt = GETDATE(),Store_UsActive = @Store_UsActive,
						Store_Logo = @Store_Logo,Store_Pan_No = @Store_Pan_No,Store_GstRegisted=@Store_GstRegisted,Store_UnderCompositeScheme=@Store_UnderCompositeScheme,
						Store_DrugLice=@Store_DrugLice,Store_DrugLiceDt=@Store_DrugLiceDt,Store_Aadhar_No=@Store_Aadhar_No,Store_GstDoc = @Store_GstDoc,Store_NoDecDoc = @Store_NoDecDoc,Store_DrugLicDoc1 = @Store_DrugLicDoc1,
						Store_DrugLice2=@Store_DrugLice2,Store_DrugLiceDt2 = @Store_DrugLiceDt2,Store_DrugLicDoc2 = @Store_DrugLicDoc2,Store_PermOpenDoc = @Store_PermOpenDoc, Store_StoreAggreDoc = @Store_StoreAggreDoc,
						Store_AuthPersonPhoto = @Store_AuthPersonPhoto,Store_AuthLetterDoc = @Store_AuthLetterDoc,Store_SecChequeDoc = @Store_SecChequeDoc,Store_SecCheque2Doc = @Store_SecCheque2Doc,Store_SecCheque3Doc = @Store_SecCheque3Doc
						,PharmacistName=@PharmacistName
			WHERE		Store_Id = @Store_Id
		END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'StoreMaster',
									@Store_Id,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT, 14, 9)
		END
	ELSE
		BEGIN
		DELETE FROM StoreMaster
		WHERE Store_Id = @Store_Id
		END
	END

	ELSE IF @SP_STATUS = 'FillBranch'
		BEGIN
	SELECT	BM.Store_Id,
				BM.Store_Name,
				BM.Store_Address1,
				BM.Store_CityId,
				BM.Store_AreaId,
				BM.Store_PhNo,
				BM.Store_PhNo1,
				BM.Store_MobNo,
				BM.Store_FaxNo,
				BM.Store_Email,
				BM.Store_Web,
				BM.Store_CstNo,
				BM.Store_CstDt,
				BM.Store_GstNo,
				BM.Store_GstDt,
				BM.Store_RegNo,
				BM.Store_RegDt,
				BM.Store_CreatedBy,
				BM.Store_CreatedDt,
				--BM.Store_UsActive,
				CASE
					WHEN BM.Store_UsActive = 1 THEN 'Yes'
					ELSE 'No'
				END AS Store_UsActive,
				BM.Store_Logo,
				CM.Country_Name,
				CM.Country_Id,
				CTM.City_Name,
				SM.State_Name,
				SM.State_ID,
				AM.Area_Name,
				UM.User_Name,
				Store_Pan_No,
				Store_Aadhar_No
	FROM StoreMaster(NOLOCK) BM
	LEFT JOIN CountryMaster(NOLOCK) CM
		ON BM.Store_CountryId = CM.Country_Id
	LEFT JOIN CityMaster(NOLOCK) CTM
		ON BM.Store_CityId = CTM.City_ID
	LEFT JOIN StateMaster(NOLOCK) SM
		ON BM.Store_StateId = SM.State_ID
	LEFT JOIN AreaMaster(NOLOCK) AM
		ON BM.Store_AreaId = AM.Area_ID
	LEFT JOIN UserMaster(NOLOCK) UM
		ON BM.Store_CreatedBy = UM.User_ID
	END

	ELSE IF @SP_STATUS = 'FillCountry'
		BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	Country_Id AS ID,
				Country_Name AS NAME
	FROM CountryMaster(NOLOCK)
	WHERE Country_IsActive = 1
	END

	ELSE IF @SP_STATUS = 'FillState'
		BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	State_ID AS ID,
				State_Name AS NAME
	FROM StateMaster (NOLOCK) 
	WHERE State_CountryId = @Store_CountryId
	AND State_IsActive = 1
	END

	ELSE IF @SP_STATUS = 'FillCity'
		BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	City_ID AS ID,
				City_Name AS NAME
	FROM CityMaster (NOLOCK) 
	WHERE City_StateId = @Store_StateId
	AND City_IsActive = 1
	END

	ELSE IF @SP_STATUS = 'FillArea'
		BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	Area_ID AS ID,
				Area_Name AS NAME
	FROM AreaMaster (NOLOCK) 
	WHERE Area_ContryId = @Store_CountryId
	AND Area_StateId = @Store_StateId
	AND Area_CityId = @Store_CityId
	AND Area_IsActive = 1
	END

	ELSE IF @SP_STATUS = 'CountDuplicate'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		StoreMaster (NOLOCK) 
			WHERE		Store_Name = @Store_Name
					AND Store_Id <> @Store_Id
		END

	ELSE IF @SP_STATUS = 'MobileValidation'
		BEGIN
			SELECT COUNT(*) AS ASCountOf
			FROM StoreMaster (NOLOCK) 
			WHERE Store_MobNo = @Store_MobNo
			AND Store_Id <> @Store_Id
		END

	ELSE IF @SP_STATUS ='Fill_StoreDetail'
	BEGIN
        SELECT * FROM StoreMaster (NOLOCK)
		WHERE Store_UsActive = 1
	END;

	ELSE IF @SP_STATUS ='UPDATE_VERSION'
		BEGIN
		update tblPOSVersion Set IsActive=0;	
		SELECT @Store_Id = ISNULL(MAX(id), 0) + 1 FROM tblPOSVersion (NOLOCK) 
		INSERT INTO tblPOSVersion
		(
			id,	
			Filepath,	
			FileType,
			[Filename],
			ExeId,
			[DbId],
			[Version],	
			SyncDate,	
			IsActive
		)
		VALUES
		(
			@Store_Id,
			@Store_Address1,
			@Store_Address2,
			@Store_Address3,
			@USER,
			Null,
			@Store_Code,
			GETDATE(),
			1
		)

	END	

	ELSE IF @SP_STATUS ='UPDATE_VERSION_1'
		BEGIN
			update tblPOSVersion Set [DbId]=@USER where IsActive=1;	
		END	
	ELSE IF @SP_STATUS ='CURRENT_VERSION'
		BEGIN
			Select CurrentVersion,CurrentExeId,CurrentDbId,CurrentAuId,CurrentAuVersion FROM ConfigurationMaster
		END	
	ELSE IF @SP_STATUS ='UPDATE_AU_VERSION'
		BEGIN
			Update ConfigurationMaster
			SEt CurrentAuId=@Store_AreaId,CurrentAuVersion=@Store_Code 
		END	
	ELSE IF @SP_STATUS='UPDATE_STORE_INFO'
	BEGIN
		if (Select Count(*) as cnt  from StoreMaster) = 0
		begin
			insert into StoreMaster
			(
				Store_Id,
				Store_Name,		
				Store_Address1,	
				Store_MobNo,		
				Store_Email,
				Store_UsActive,		
				Store_UpdatedBy, 
				Store_UpdatedDt, 
				Store_Code		
			)
			values
			(
				1,
				@Store_Name,		
				@Store_Address1,	
				@Store_MobNo,		
				@Store_Email,		
				1, 
				1,
				GETDATE(), 
				@Store_Code
			)
		end
		else
		begin
			UPDATE	StoreMaster
			SET	Store_Name		= @Store_Name,
				Store_Address1	= @Store_Address1,
				Store_MobNo		= @Store_MobNo,
				Store_FaxNo		= @Store_FaxNo,
				Store_Email		= @Store_Email,
				Store_UpdatedBy = @USER,
				Store_UpdatedDt = GETDATE(),
				Store_Code		=@Store_Code
			WHERE Store_Id=1
		end
		
	END
	ELSE IF @SP_STATUS='Get_StoreDetail_For_cPOS_Sync'
	BEGIN
		Select	top 1
				ISNULL(Store_Id,0) AS Store_Id, 
				ISNULL(Store_Code,'') AS Store_Code, 
				ISNULL(Store_Name,'') AS Store_Name, 
				ISNULL(Store_Address1,'') AS Store_Address1, 
				ISNULL(Store_CountryId,0) AS Store_CountryId, 
				ISNULL(Store_StateId,0) AS Store_StateId, 
				ISNULL(Store_CityId,0) AS Store_CityId, 
				ISNULL(Store_AreaId,0) AS Store_AreaId, 
				ISNULL(Store_Taluka,'') AS Store_Taluka, 
				ISNULL(Store_PoVillage,'') AS Store_PoVillage, 
				ISNULL(Store_Landmark,'') AS Store_Landmark, 
				ISNULL(Store_Pincode,'') AS Store_Pincode, 
				ISNULL(Store_StoreOwner,'') AS Store_StoreOwner, 
				ISNULL(Store_MobNo,'') AS Store_MobNo, 
				ISNULL(Store_ContactPerson,'') AS Store_ContactPerson, 
				ISNULL(Store_ContactPersonPh,'') AS Store_ContactPersonPh, 
				ISNULL(Store_PhNo,'') AS Store_PhNo, 
				ISNULL(Store_PhNo1,'') AS Store_PhNo1, 
				ISNULL(Store_Email,'') AS Store_Email, 
				ISNULL(Store_Email2,'') AS Store_Email2, 
				ISNULL(Store_Pan_No,'') AS Store_Pan_No, 
				ISNULL(Store_PanDoc,'') AS Store_PanDoc, 
				ISNULL(Store_Adhaar_No,'') AS Store_Adhaar_No, 
				ISNULL(Store_AdhaarDoc,'') AS Store_AdhaarDoc, 
				ISNULL(Store_FaxNo,'') AS Store_FaxNo, 
				ISNULL(Store_Web,'') AS Store_Web, 
				ISNULL(Store_CstNo,'') AS Store_CstNo, 
				ISNULL(Store_CstDt,GETDATE()) AS Store_CstDt, 
                ISNULL(Store_GstNo,'') AS Store_GstNo, 
				ISNULL(Store_GstDoc,'') AS Store_GstDoc, 
				ISNULL(Store_GstDt,GETDATE()) AS Store_GstDt, 
				ISNULL(Store_RegNo,'') AS Store_RegNo, 
				ISNULL(Store_RegDt,GETDATE()) AS Store_RegDt, 
				ISNULL(Store_CreatedBy,0) AS Store_CreatedBy, 
				ISNULL(Store_CreatedDt,GETDATE()) AS Store_CreatedDt, 
				ISNULL(Store_UpdatedBy,0) AS Store_UpdatedBy, 
				ISNULL(Store_UpdatedDt,GETDATE())AS Store_UpdatedDt, 
				ISNULL(Store_UsActive,0) AS Store_UsActive, 
				ISNULL(Store_Logo,'') AS Store_Logo, 
				ISNULL(Store_GstRegisted,0) AS Store_GstRegisted, 
				ISNULL(Store_UnderCompositeScheme,0) AS Store_UnderCompositeScheme, 
                ISNULL(Store_DrugLice,'') AS Store_DrugLice, 
				ISNULL(Store_DrugLiceDt,GETDATE()) AS Store_DrugLiceDt, 
				ISNULL(Store_Comm_Perc,0) AS Store_Comm_Perc, 
				ISNULL(Store_Aadhar_No,'') AS Store_Aadhar_No, 
				ISNULL(Store_NoDecDoc,'') AS Store_NoDecDoc, 
				ISNULL(Store_DrugLicDoc1,'') AS Store_DrugLicDoc1, 
				ISNULL(Store_DrugLicDoc2,'') AS Store_DrugLicDoc2, 
				ISNULL(Store_DrugLiceDt2,GETDATE())AS Store_DrugLiceDt2, 
				ISNULL(Store_DrugLice2,'')AS Store_DrugLice2, 
				ISNULL(Store_PermOpenDoc,'')AS Store_PermOpenDoc, 
				ISNULL(Store_StoreAggreDoc,'')AS Store_StoreAggreDoc, 
                ISNULL(Store_AuthPersonPhoto,'')AS Store_AuthPersonPhoto, 
				ISNULL(Store_AuthLetterDoc,'')AS Store_AuthLetterDoc, 
				ISNULL(Store_SecChequeDoc,'')AS Store_SecChequeDoc, 
				ISNULL(Store_SecCheque2Doc,'')AS Store_SecCheque2Doc, 
				ISNULL(Store_SecCheque3Doc,'')AS Store_SecCheque3Doc, 
				ISNULL(PharmacistName,'')AS PharmacistName
		from	StoreMaster
		--Select top 1 Store_Id,Store_Code,Store_Name from StoreMaster
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_SyncPoStatus_cPOS]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Vishal
-- Create date: 14.08.2018
-- Description:	For Sync PO Status
-- =============================================
CREATE PROCEDURE [dbo].[SP_SyncPoStatus_cPOS]

@SP_STATUS	varchar(200) = '',
@Poh_Id		NUMERIC(18,0)	=0,
@Poh_Po_Key	NUMERIC(18,0)	=0,
@Poh_Po_No	varchar(100)=0,
@Poh_ApproveStatus	varchar(100)='',
@Poh_SalesOrderNo	varchar(100)='',
@Poh_Remarks	nvarchar(MAX)=''
AS
BEGIN
	IF @SP_STATUS = 'SYNC_PO_STATUS'
		BEGIN
			if NOT EXISTS(Select * from cPOS_PoApprovalHistory Where Poh_Po_Key=@Poh_Po_Key)
				BEGIN
					INSERT INTO cPOS_PoApprovalHistory
					(
						Poh_Id,
						Poh_Po_Key,
						Poh_Po_No,
						Poh_ApproveStatus,
						Poh_SalesOrderNo,
						Poh_Remarks,
						Poh_UpdatedBy,
						Poh_UpdatedDt
					)
					VALUES
					(
						(Select ISNULL(MAX(Poh_Id),0) + 1 from cPOS_PoApprovalHistory),
						@Poh_Po_Key,
						@Poh_Po_No,
						@Poh_ApproveStatus,
						@Poh_SalesOrderNo,
						@Poh_Remarks,	
						-1,
						GETDATE()
					)
				END	
		END
END

GO
/****** Object:  StoredProcedure [dbo].[SP_TaxMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TaxMaster] @SP_STATUS varchar(200),
@Tax_ID int,
@Tax_Code varchar(200),
@Tax_Name varchar(200),
@Tax_BaseOn int,
@Tax_DefVal numeric(14, 3),
@Tax_On int,
@Tax_AddLess int,
@Tax_DisplayOrder int,
@Tax_User int,
@Tax_IsLocal bit,
@Tax_IsActive bit
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
	BEGIN
	SELECT COUNT(*) AS CountOf
	FROM TaxMaster (NOLOCK) 
	WHERE (
	Tax_Name = @Tax_Name
	OR Tax_Code = @Tax_Code
	)
	AND Tax_ID <> @Tax_ID
	AND Tax_ID <> @Tax_ID;
	END;
	ELSE
	IF @SP_STATUS = 'GET_AVAL_TAX'
	BEGIN
	SELECT Tax_Name
	FROM TaxMAster(NOLOCK)
	WHERE Tax_ID <> 1
	AND Tax_IsLocal = @Tax_IsLocal
	AND Tax_IsActive = 1
	END
	IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Tax_ID = ISNULL(MAX(Tax_ID), 0) + 1
	FROM TaxMaster;
	INSERT INTO TaxMaster (
		Tax_ID,
		Tax_Code,
		Tax_Name,
		Tax_BaseOn,
		Tax_DefVal,
		Tax_On,
		Tax_AddLess,
		Tax_DisplayOrder,
		Tax_CreatedBy,
		Tax_CreatedDt,
		Tax_IsActive,
		Tax_IsLocal )
	VALUES(@Tax_ID, @Tax_Code, @Tax_Name, @Tax_BaseOn, @Tax_DefVal, @Tax_On, @Tax_AddLess, @Tax_DisplayOrder, @Tax_User,
	GETDATE(), @Tax_IsActive, @Tax_IsLocal);
	END;
	ELSE
	IF @SP_STATUS = 'Update'
	BEGIN
	UPDATE TaxMaster
	SET	Tax_Code = @Tax_Code,
			Tax_Name = @Tax_Name,
			Tax_BaseOn = @Tax_BaseOn,
			Tax_DefVal = @Tax_DefVal,
			Tax_On = @Tax_On,
			Tax_AddLess = @Tax_AddLess,
			Tax_DisplayOrder = @Tax_DisplayOrder,
			Tax_UpdatedBy = @Tax_User,
			Tax_UpdatedDt = GETDATE(),
			Tax_IsActive = @Tax_IsActive,
			Tax_IsLocal = @Tax_IsLocal
	WHERE Tax_ID = @Tax_ID;
	END;
	ELSE
	IF @SP_STATUS = 'Delete'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'TaxMaster',
									@Tax_ID,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT, 14, 9)
		END
	ELSE
		BEGIN
		DELETE FROM TaxMaster
		WHERE Tax_ID = @Tax_ID;
		END;
	END
	ELSE
	IF @SP_STATUS = 'Fillgrid'
	BEGIN
	SELECT	A.Tax_ID,
				A.Tax_Code,
				A.Tax_Name,
				A.Tax_DefVal,
				A.Tax_On,
				A.Tax_AddLess,
				A.Tax_DisplayOrder,
				--A.Tax_IsActive,
				CASE
					WHEN A.Tax_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END AS Tax_IsActive,
				A.Tax_CreatedBy,
				A.Tax_CreatedDt,
				CASE
					WHEN A.Tax_IsLocal = 1 THEN 'Yes'
					ELSE 'No'
				END AS Tax_IsLocal,
				A.Tax_BaseOn AS Tax_BasedOn,
				CAST(0 AS numeric(18, 3)) AS TD_AMOUNT,
				B.User_Name AS Tax_USer,
				(SELECT
					Tax_Name
				FROM TaxMaster
				WHERE Tax_ID = A.Tax_BaseOn)
				AS Tax_BaseOnVal,
				CASE
					WHEN A.Tax_On = 1 THEN 'TOTAL'
					ELSE 'CUMM.'
				END AS Tax_On_Val,
				CASE
					WHEN A.Tax_AddLess = 1 THEN 'ADD'
					ELSE 'LESS'
				END AS Tax_Add_Less
	FROM TaxMaster(NOLOCK) AS A
	LEFT JOIN dbo.UserMaster(NOLOCK) B
		ON A.Tax_CreatedBy = B.User_ID;
	END;
	ELSE
	IF @SP_STATUS = 'FillParentCombo'
	BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	Tax_ID AS ID,
				Tax_Name AS NAME
	FROM TaxMaster (NOLOCK) 
	WHERE Tax_IsActive = 1;
	END;
	ELSE
	IF @SP_STATUS = 'FILL_COMBO_TAX_ON'
	BEGIN
	SELECT	CAST(0 AS int) AS TaxOnId,
				'--Select--' AS TaxOn
	UNION
	SELECT	CAST(1 AS int) AS TaxOnId,
				'TOTAL' AS TaxOn
	UNION
	SELECT	CAST(2 AS int) AS TaxOnId,
				'CUMM.' AS TaxOn
	END
	ELSE
	IF @SP_STATUS = 'FILL_COMBO_ADD_LESS'
	BEGIN
	SELECT	CAST(0 AS int) AS TaxAddLessId,
				'--Select--' AS TaxAddLess
	UNION
	SELECT	CAST(1 AS int) AS TaxAddLessId,
				'ADD' AS TaxAddLess
	UNION
	SELECT	CAST(2 AS int) AS TaxAddLessId,
				'LESS' AS TaxAddLess
	END
	ELSE
	IF @SP_STATUS = 'GET_TAX_DETAIL'
	BEGIN
	DECLARE	@DynamicPivotQuery AS nvarchar(max),
				@ColumnName AS nvarchar(max)
	SELECT @ColumnName = ISNULL(@ColumnName + ',', '') + QUOTENAME(TAX_NAME)
	FROM (SELECT
		TAX_NAME
	FROM TaxMaster (NOLOCK) 
	WHERE TAX_ID <> 1
	AND Tax_IsActive = 1
	AND Tax_IsLocal = @Tax_IsLocal) AS Courses
	SET @DynamicPivotQuery = N'SELECT ' + @ColumnName + ' FROM (SELECT TAX_NAME, CAST(0 as Bigint) as TaxVal FROM TaxMaster   ) x
						PIVOT (max(TaxVal) 
						FOR TAX_NAME IN (' + @ColumnName + ')) AS PVTTable
						
						'
	EXEC sp_executesql @DynamicPivotQuery
	END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_TaxTransaction]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- =============================================
CREATE PROCEDURE [dbo].[SP_TaxTransaction] @SP_STATUS nvarchar(200) = '',
@USER bigint = 0,
@Tr_key numeric(18, 0) = 0,
@Tr_DocId bigint = 0,
@Tr_DocRevNo bigint = 0,
@Tr_DocTyp nvarchar(30) = '',
@Tr_DocKey numeric(18, 0) = 0,
@Tr_DdocKey numeric(18, 0) = 0,
@Tr_TxId NUMERIC(18,0) = 0,
@Tr_TxType nvarchar(1) = '',
@Tr_TxBsSrNo bigint = 0,
@Tr_TxVal numeric(14, 3) = 0,
@Tr_TxOn nvarchar(1) = '',
@Tr_TxAddLess nvarchar(1) = '',
@Tr_TxOrder bigint = 0,
@Tr_TxCumTot numeric(14, 3) = 0,
@Tr_TxTot numeric(14, 3) = 0,
@Tr_CmpId bigint = 0,
@Tr_UnitId bigint = 0,
@Tr_Year bigint = 0,
@Tr_MmId numeric(18, 0) = 0
AS
BEGIN
	IF @SP_STATUS = 'INSERT_TaxTransaction'
		BEGIN
			SELECT @Tr_key = ISNULL(MAX(Tr_key), 0) + 1
			FROM TaxTransaction(NOLOCK)

			INSERT INTO [dbo].[TaxTransaction] (
				[Tr_key],
				[Tr_DocId],
				[Tr_DocRevNo],
				[Tr_DocTyp],
				[Tr_DocKey],
				[Tr_DdocKey],
				[Tr_TxId],
				[Tr_TxType],
				[Tr_TxBsSrNo],
				[Tr_TxVal],
				[Tr_TxOn],
				[Tr_TxAddLess],
				[Tr_TxOrder],
				[Tr_TxCumTot],
				[Tr_TxTot],
				[Tr_CmpId],
				[Tr_UnitId],
				[Tr_Year],
				Tr_MmId )
			VALUES(@Tr_key, @Tr_DocId, @Tr_DocRevNo, @Tr_DocTyp, @Tr_DocKey, @Tr_DdocKey, @Tr_TxId, @Tr_TxType, @Tr_TxBsSrNo,
			@Tr_TxVal, @Tr_TxOn, @Tr_TxAddLess, @Tr_TxOrder, @Tr_TxCumTot, @Tr_TxTot, @Tr_CmpId, @Tr_UnitId, @Tr_Year, @Tr_MmId)
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_TAX'
		BEGIN
			SELECT	TAX_ID,
						TAX_CODE,
						TAX_NAME
			FROM TaxMaster(NOLOCK)
		END

	ELSE IF @SP_STATUS = 'RETRIVE_TAX_DETAILS'
		BEGIN
			SELECT	TM.TAX_ID,
						TM.TAX_CODE,
						TM.TAX_NAME,
						TM.Tax_BaseOn,
						CASE
							WHEN ISNULL(TT.Tr_DocKey, 0) > 0 THEN TT.Tr_TxVal
							ELSE TM.Tax_DefVal
						END AS TAX_DEF_VAL,
						CASE
							WHEN ISNULL(TT.Tr_DocKey, 0) > 0 THEN TT.Tr_TxOn
							ELSE TM.TAX_ON
						END AS TAX_ON,
						CASE
							WHEN ISNULL(TT.Tr_DocKey, 0) > 0 THEN TT.Tr_TxAddLess
							ELSE TM.Tax_AddLess
						END AS TAX_ADD_LESS,
						TM.Tax_DisplayOrder,
						TM.Tax_CreatedBy,
						ISNULL(TT.Tr_TxTot, 0) AS TD_AMOUNT,
						ISNULL(TT.Tr_TxCumTot, 0) AS TD_CUM_AMOUNT
			FROM	TaxMaster(NOLOCK) AS TM
					LEFT JOIN TaxTransaction(NOLOCK) AS TT
			ON			TM.TAX_ID = TT.Tr_TxId
					AND TT.Tr_DocTyp = @Tr_DocTyp
					AND TT.Tr_DocKey = @Tr_DocKey
					AND TT.Tr_DdocKey = @Tr_DdocKey
		END

	ELSE IF @SP_STATUS = 'DELETE_TaxTransaction'
		BEGIN
			DELETE FROM TaxTransaction
			WHERE Tr_DocTyp = @Tr_DocTyp
				AND Tr_DocKey = @Tr_DocKey
				AND Tr_DdocKey = @Tr_DdocKey
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_TAX_ON'
		BEGIN
			SELECT	CAST(1 AS int) AS TaxOnId,
						'TOTAL' AS TaxOn
			UNION
			SELECT	CAST(2 AS int) AS TaxOnId,
						'CUMM.' AS TaxOn
		END

	ELSE IF @SP_STATUS = 'FILL_COMBO_ADD_LESS'
		BEGIN
			SELECT	CAST(1 AS int) AS TaxAddLessId,
						'ADD' AS TaxAddLess
			UNION
			SELECT	CAST(2 AS int) AS TaxAddLessId,
						'LESS' AS TaxAddLess
		END

	ELSE IF @SP_STATUS = 'FETCH_TAX_TRANSACTION'
		BEGIN
			--SELECT  	TOP 1 TR_DOC_ID, TR_DOC_REV_NO, TR_DOC_TYP, TR_DOC_KEY, TR_DDOC_KEY, TR_TX_ID, TR_TX_TOT
			SELECT TOP 1 ISNULL(Tr_TxTot, 0) AS TR_TX_TOT
			FROM TaxTransaction(NOLOCK)
			WHERE Tr_DocTyp = @Tr_DocTyp
			AND Tr_DocKey = @Tr_DocKey
			AND Tr_DdocKey = @Tr_DdocKey
		END

	ELSE IF @SP_STATUS = 'RetriveTaxDetailsNew'
		BEGIN
			SELECT	TM.Tax_ID,
						TM.Tax_Code,
						TM.Tax_Name,
						TM.Tax_BaseOn,
						0.00 AS TD_AMOUNT,
						0.00 AS TD_CUM_AMOUNT,
						CASE
							WHEN ISNULL(tr.Tr_TxVal, 0) > 0 THEN tr.Tr_TxVal
							WHEN ISNULL(it.Mtm_TaxValue, 0) > 0 THEN it.Mtm_TaxValue
							ELSE TM.Tax_DefVal
						END AS TAX_DEF_VAL,
						CASE
							WHEN ISNULL(tr.Tr_TxOn, 0) > 0 THEN tr.Tr_TxOn
							ELSE TM.TAX_ON
						END AS TAX_ON,
						CASE
							WHEN ISNULL(tr.Tr_TxAddLess, 0) > 0 THEN tr.Tr_TxAddLess
							ELSE tm.Tax_AddLess
						END AS TAX_ADD_LESS
			FROM	TaxMaster(NOLOCK) AS TM
					LEFT JOIN MedicineWiseTaxMaster  (NOLOCK) it
			ON			tm.Tax_ID = Mtm_TaxId
					AND it.Mtm_MmId = @Tr_TxId
					AND it.Mtm_TaxValue > 0
					LEFT JOIN TaxTransaction  (NOLOCK) tr
			ON			tm.TAX_ID = tr.Tr_TxId
					AND tr.Tr_MmId = @Tr_TxId
					AND Tr_DocKey = @Tr_DocKey
					AND Tr_DdocKey = @Tr_DdocKey
					AND Tr_DocTyp = @Tr_DocTyp
		END

	ELSE IF @SP_STATUS = 'RetriveTaxDetailsLocal'
		BEGIN
			Declare @count int=0
			select @count=Tr_MmId  from TaxTransaction where Tr_DocKey=@Tr_DocKey and Tr_DdocKey = @Tr_DdocKey and Tr_DocTyp = @Tr_DocTyp
			DECLARE	@IsRegisterd bit =0
			DECLARE	@UnderCompositeScheme bit =0
			SELECT @IsRegisterd=Store_GstRegisted,@UnderCompositeScheme=Store_UnderCompositeScheme FROM dbo.StoreMaster sm;
			IF(@IsRegisterd=1)
			BEGIN
				 IF(@UnderCompositeScheme=1)
				 BEGIN
					  SET @IsRegisterd=0
				 END
			END	
			if @count>0
					SELECT	TM.Tax_ID,
							TM.Tax_Code,
							TM.Tax_Name,
							TM.Tax_BaseOn,
							0.00 AS TD_AMOUNT,
							0.00 AS TD_CUM_AMOUNT,
							CASE WHEN  @IsRegisterd=0 
									THEN (CASE	WHEN @Tr_DocTyp in(1,4) 
												THEN ISNULL(tr.Tr_TxVal, 0) 
												ELSE 0 END)
									ELSE 
								ISNULL(tr.Tr_TxVal, 0) 
							END as  TAX_DEF_VAL,

							tr.Tr_TxOn AS TAX_ON,
							tr.Tr_TxAddLess AS TAX_ADD_LESS
					FROM	TaxMaster(NOLOCK) AS TM
							LEFT JOIN MedicineWiseTaxMaster (NOLOCK)  it
					ON			tm.Tax_ID = Mtm_TaxId
							AND it.Mtm_MmId = @Tr_TxId
							AND it.Mtm_TaxValue > 0
							LEFT JOIN TaxTransaction  (NOLOCK) tr
					ON			tm.TAX_ID = tr.Tr_TxId
							AND tr.Tr_MmId = @Tr_TxId
							AND Tr_DocKey = @Tr_DocKey
							AND Tr_DdocKey = @Tr_DdocKey
							AND Tr_DocTyp = @Tr_DocTyp
					WHERE	ISNULL(Tax_IsLocal, 1) = 1
							AND TM.Tax_IsActive = 1
			else
					SELECT	TM.Tax_ID,
							TM.Tax_Code,
							TM.Tax_Name,
							TM.Tax_BaseOn,
							0.00 AS TD_AMOUNT,
							0.00 AS TD_CUM_AMOUNT,
							CASE
								WHEN @IsRegisterd=0 
								THEN (CASE WHEN @Tr_DocTyp in(1,4) 
										   THEN (CASE WHEN ISNULL(it.Mtm_TaxValue, 0) > 0 
														THEN it.Mtm_TaxValue
														ELSE TM.Tax_DefVal
												END)
									ELSE 0 
									END)
								WHEN ISNULL(it.Mtm_TaxValue, 0) > 0 
								THEN it.Mtm_TaxValue
									ELSE TM.Tax_DefVal
								END AS TAX_DEF_VAL,
							
								CASE
									WHEN ISNULL(tr.Tr_TxOn, 0) > 0 THEN tr.Tr_TxOn
									ELSE TM.TAX_ON
								END AS TAX_ON,
								CASE
									WHEN ISNULL(tr.Tr_TxAddLess, 0) > 0 THEN tr.Tr_TxAddLess
									ELSE tm.Tax_AddLess
								END AS TAX_ADD_LESS
					FROM	TaxMaster(NOLOCK) AS TM
							LEFT JOIN MedicineWiseTaxMaster (NOLOCK)  it
					ON		tm.Tax_ID = Mtm_TaxId
							AND it.Mtm_MmId = @Tr_TxId
							AND it.Mtm_TaxValue > 0
							LEFT JOIN TaxTransaction  (NOLOCK) tr
					ON			tm.TAX_ID = tr.Tr_TxId
							AND tr.Tr_MmId = @Tr_TxId
							AND Tr_DocKey = @Tr_DocKey
							AND Tr_DdocKey = @Tr_DdocKey
							AND Tr_DocTyp = @Tr_DocTyp
					WHERE		ISNULL(Tax_IsLocal, 1) = 1
							AND TM.Tax_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'RetriveTaxDetailsInter'
		BEGIN
			DECLARE	@IsRegister bit =0
			DECLARE	@UnderCompositeScheme1 bit =0
			SELECT @IsRegister=Store_GstRegisted,@UnderCompositeScheme1=Store_UnderCompositeScheme FROM dbo.StoreMaster sm;
			IF(@IsRegister=1)
			BEGIN
				 IF(@UnderCompositeScheme1=1)
				 BEGIN
					  SET @IsRegister=0
				 END
			END	
			SELECT	TM.Tax_ID,
					TM.Tax_Code,
					TM.Tax_Name,
					TM.Tax_BaseOn,
					0.00 AS TD_AMOUNT,
					0.00 AS TD_CUM_AMOUNT,
					CASE
						WHEN ISNULL(@IsRegister, 0) = 0 
						THEN (CASE WHEN @Tr_DocTyp in(1,4) 
									THEN (CASE WHEN ISNULL(tr.Tr_TxVal, 0) > 0 
												THEN tr.Tr_TxVal
												ELSE (CASE WHEN ISNULL(it.Mtm_TaxValue, 0) > 0 
															THEN it.Mtm_TaxValue
															ELSE TM.Tax_DefVal 
													END)
											END)
									ELSE 0 
								END)
							WHEN ISNULL(tr.Tr_TxVal, 0) > 0 THEN tr.Tr_TxVal
							WHEN ISNULL(it.Mtm_TaxValue, 0) > 0 THEN it.Mtm_TaxValue
							ELSE TM.Tax_DefVal
						END AS TAX_DEF_VAL,
				
						CASE
							WHEN ISNULL(tr.Tr_TxOn, 0) > 0 THEN tr.Tr_TxOn
							ELSE TM.TAX_ON
						END AS TAX_ON,
						CASE
							WHEN ISNULL(tr.Tr_TxAddLess, 0) > 0 THEN tr.Tr_TxAddLess
							ELSE tm.Tax_AddLess
						END AS TAX_ADD_LESS
			FROM	TaxMaster(NOLOCK) AS TM
					LEFT JOIN MedicineWiseTaxMaster  (NOLOCK) it
			ON			tm.Tax_ID = Mtm_TaxId
					AND it.Mtm_MmId = @Tr_TxId
					AND it.Mtm_TaxValue > 0
					LEFT JOIN TaxTransaction (NOLOCK)  tr
			ON			tm.TAX_ID = tr.Tr_TxId
					AND tr.Tr_MmId = @Tr_TxId
					AND Tr_DocKey = @Tr_DocKey
					AND Tr_DdocKey = @Tr_DdocKey
					AND Tr_DocTyp = @Tr_DocTyp
			WHERE	ISNULL(Tax_IsLocal, 0) = 0
			AND TM.Tax_IsActive = 1
		END

	else IF @SP_STATUS = 'RetriveReturnTaxDetail'
		BEGIN
			SELECT		Tr_TxId	as Tax_ID,
						TM.Tax_Code,
						TM.Tax_Name,
						TM.Tax_BaseOn,
						0.00 AS TD_AMOUNT,
						0.00 AS TD_CUM_AMOUNT,
						Tr_TxVal as   TAX_DEF_VAL,
						Tr_TxOn as TAX_ON,
						Tr_TxAddLess AS TAX_ADD_LESS
			FROM	TaxTransaction (NOLOCK)  tr 
					left join TaxMaster  (NOLOCK) tm 
			on			tr.Tr_TxId=tm.Tax_ID 
			where	Tr_DocKey = @Tr_DocKey AND 
					Tr_DdocKey = @Tr_DdocKey AND 
					Tr_DocTyp = @Tr_DocTyp
					order BY Tr_TxId ASC
		END
	else IF @SP_STATUS = 'RetriveReturnTaxDetail_from_master'
		BEGIN

			SELECT		TR.Mtm_TaxId	as Tax_ID,
						TM.Tax_Code,
						TM.Tax_Name,
						TM.Tax_BaseOn,
						0.00 AS TD_AMOUNT,
						0.00 AS TD_CUM_AMOUNT,
						tm.Tax_DefVal as TAX_DEF_VAL,
						TM.Tax_On as TAX_ON,
						TM.Tax_AddLess AS TAX_ADD_LESS
			FROM	MedicineWiseTaxMaster (NOLOCK)  tr 
					left join TaxMaster  (NOLOCK) tm 
			on			tr.Mtm_TaxId=tm.Tax_ID 
			WHERE TR.Mtm_MmId=@Tr_MmId
			order BY tr.Mtm_TaxId ASC

		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_Tbl_Dependency]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- EXEC SP_Tbl_Dependency @Table = 'DEPARTMENT_MASTER', @Col = 'DEPT_ID', @Val = '1'
-- EXEC SP_Tbl_Dependency @Table = 'VENDOR_MASTER', @Val = 1
-- =============================================
CREATE PROCEDURE [dbo].[SP_Tbl_Dependency]
	@Table	nvarchar(50) = '',
	@Val	Bigint = 0,
	@MSG_OUT	VARCHAR(MAX)='' OUT
AS
BEGIN
	SET NOCOUNT ON
    DECLARE @RowsToProcess  int
	DECLARE @CurrentRow     int
	DECLARE @TempTbl TABLE ([SrNo] int identity(1,1) primary Key,
	[Id] [bigint] ,
	[No] [nvarchar](50) NULL,
	[Table] [nvarchar](50) NULL,
	[Col] [nvarchar](50) NULL,
	[DTable] [nvarchar](50) NULL,
	[Dcol] [nvarchar](50) NULL,
	[Active] [bit] NULL,
	[Msg] [nvarchar](250) NULL)
	
	INSERT INTO @TempTbl
	SELECT * FROM [dbo].tblDependency (NOLOCK) WHERE [Table] = @Table and Active=1
	SET @RowsToProcess = @@ROWCOUNT
	
	DECLARE @Msgs nvarchar(MAX) = ''
	SET @CurrentRow=0
	WHILE @CurrentRow < @RowsToProcess
		BEGIN
			SET @CurrentRow = @CurrentRow + 1
			DECLARE @Msg nvarchar(MAX) = ''
			DECLARE @param NVARCHAR(20) = '@Counter INT OUTPUT'
			DECLARE @DTbl nvarchar(50) = ''
			DECLARE @DColumn nvarchar(50) = ''
		
			DECLARE @Count int
	
			SELECT @DTbl = DTable, @DColumn = Dcol, @Msg = Msg FROM  @TempTbl WHERE SrNo = @CurrentRow 
			DECLARE @dynasql nvarchar(MAX)=''
			if @DTbl='PurchaseInvoiceDetail' and @Table='PoHeader'
			begin
		set	@dynasql= 'SELECT @Counter = count(*) FROM ' + @DTbl + ' (NOLOCK)
			left join PurchaseInvoiceHeader pih on Pih_Key=Pid_PihKey WHERE Pih_DocType =4 and  ' + @DColumn + ' = ' + cast(@Val as nvarchar(MAX))
			end
			else if @DTbl='PurchaseInvoiceDetail' and @Table='DispatchHeader'
			begin
		set	@dynasql= 'SELECT @Counter = count(*) FROM ' + @DTbl + ' (NOLOCK)
			left join PurchaseInvoiceHeader pih on Pih_Key=Pid_PihKey WHERE Pih_DocType =17 and  ' + @DColumn + ' = ' + cast(@Val as nvarchar(MAX))
			end
			else 
			begin
		set	@dynasql  = 'SELECT @Counter = count(*) FROM ' + @DTbl + ' (NOLOCK) WHERE ' + @DColumn + ' = ' + cast(@Val as nvarchar(MAX))
			end
			EXEC sp_executeSql @dynasql,@param,@Counter = @Count OUTPUT;
			IF @Count > 0
				BEGIN
					SET @Msgs += @Msg + CHAR(13) + CHAR(10)
				END
		END
	SET @MSG_OUT=ISNULL(@Msgs,'')
END

GO
/****** Object:  StoredProcedure [dbo].[SP_Tbl_Dependency1]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC SP_Tbl_Dependency1 @Table ='INDENT_DETAIL', @Val = '4,1,11'
--EXEC [SP_Tbl_Dependency1] 'SalesInvoiceItemDetail', '1,2,4'
CREATE PROCEDURE [dbo].[SP_Tbl_Dependency1]
	@Table	nvarchar(MAX) = '',
	@Val	nvarchar(MAX) = '',
	@MSG_OUT	VARCHAR(MAX)='' OUT
AS
BEGIN
	SET NOCOUNT ON;
    DECLARE @RowsToProcess  int
	DECLARE @CurrentRow     int
	DECLARE @TempTbl TABLE ([SrNo] int identity(1,1) primary Key,
	[Id] [bigint] ,
	[No] [nvarchar](50) NULL,
	[Table] [nvarchar](50) NULL,
	[Col] [nvarchar](50) NULL,
	[DTable] [nvarchar](50) NULL,
	[Dcol] [nvarchar](50) NULL,
	[Active] [bit] NULL,
	[Msg] [nvarchar](250) NULL)
	
	INSERT INTO @TempTbl
	SELECT * FROM [dbo].tblDependency (NOLOCK) WHERE [Table] = @Table and Active=1
	SET @RowsToProcess = @@ROWCOUNT
	
	DECLARE @Msgs nvarchar(MAX) = ''
	SET @CurrentRow=0
	WHILE @CurrentRow < @RowsToProcess
		BEGIN
		    SET @CurrentRow = @CurrentRow + 1
		
			DECLARE @param AS NVARCHAR(20) = '@COUNTER INT = 0 OUTPUT'
			DECLARE @Msg AS nvarchar(MAX) = '',@DTbl nvarchar(MAX) = '', @DColumn nvarchar(MAX) = '', @Count int
		    SELECT @DTbl = DTable, @DColumn = Dcol, @Msg = Msg FROM  @TempTbl WHERE SrNo = @CurrentRow  
			DECLARE @pos INT = 0,  @pos1 INT = 0, @len INT = 0, @len1 INT = 0
			DECLARE @value varchar(MAX)
			DECLARE @value1 varchar(MAX)
			
			IF @Val NOT LIKE '%,'
			BEGIN
			    set @Val = @Val + ','
				set @DColumn = @DColumn + ','
			END
			DECLARE @dynasql nvarchar(MAX) = 'SELECT @COUNTER = COUNT(*) FROM ' + @DTbl + ' WHERE '
			
			WHILE CHARINDEX(',', @Val, @pos + 1) > 0 and CHARINDEX(',', @DColumn, @pos1 + 1) > 0
				BEGIN
				    set @len = CHARINDEX(',', @Val, @pos + 1) - @pos
					set @len1 = CHARINDEX(',', @DColumn, @pos1 + 1) - @pos1
				    
					set @value = SUBSTRING(@Val, @pos, @len)
				    set @value1 = SUBSTRING(@DColumn, @pos1, @len1)
					set @dynasql += @value1 + ' = ' + @value + ' AND '
			
					set @pos = CHARINDEX(',', @Val, @pos + @len) + 1
					set @pos1 = CHARINDEX(',', @DColumn, @pos1 + @len1) + 1
				END
			
			IF RIGHT(RTRIM(LTRIM(@dynasql)),3) = 'AND'
				BEGIN
					SET @dynasql = SUBSTRING(@dynasql, 0, LEN(RTRIM(LTRIM(@dynasql)))-2)
				END
			EXEC SP_EXECUTESQL @dynasql,@param,@Counter = @Count OUTPUT;
			IF @@ROWCOUNT > 0 AND @Count > 0 
				BEGIN
					SET @Msgs += @Msg + CHAR(13) + CHAR(10)
				END
		END
	SET @MSG_OUT = ISNULL(@Msgs,'')
END

GO
/****** Object:  StoredProcedure [dbo].[SP_TERMS_CONDITION_MASTER]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TERMS_CONDITION_MASTER] (@SP_STATUS varchar(200),
@Tc_Id bigint,
@Tc_Name nvarchar(199),
@Tc_TcgId int,
@Tc_BranchID int,
@Tc_SeqNo int,
@Tc_IsActive bit,
@USER int)
AS
BEGIN
--========================BIND TERM GROUP=====================
	IF @SP_STATUS = 'FillComboTerm'
	BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	Tcg_Id AS ID,
				Tcg_Name AS NAME
	FROM TermsConditionGroupMaster (NOLOCK) 
	WHERE Tcg_IsActive = 1
	END
	--========================BIND BRANCH========================  	
	ELSE
	IF @SP_STATUS = 'FillComboBranch'
	BEGIN
	SELECT	0 AS ID,
				'--Select--' AS NAME
	UNION
	SELECT	Branch_Id AS ID,
				Branch_Name AS NAME
	FROM BranchMaster
	WHERE Branch_UsActive = 1
	END
	ELSE
	IF @SP_STATUS = 'Count'
	BEGIN
	SELECT COUNT(*) AS CountOf
	FROM TermsConditionMaster (NOLOCK) 
	WHERE Tc_Name = @Tc_Name
	AND Tc_Id <> @Tc_Id
	END
	ELSE
	IF @SP_STATUS = 'Insert'
	BEGIN
	SELECT @Tc_Id = ISNULL(MAX(Tc_Id), 0) + 1
	FROM TermsConditionMaster (NOLOCK) 
	INSERT TermsConditionMaster (
		Tc_Id,
		Tc_Name,
		Tc_TcgId,
		Tc_BranchID,
		Tc_SeqNo,
		Tc_CreatedBy,
		Tc_CreatedDt )
	VALUES(@Tc_Id, @Tc_Name, @Tc_TcgId, @Tc_BranchID, @Tc_SeqNo, @USER, GETDATE())
	END
	ELSE
	IF @SP_STATUS = 'Update'
	BEGIN
	UPDATE TermsConditionMaster
	SET	Tc_Name = @Tc_Name,
			Tc_TcgId = @Tc_TcgId,
			Tc_BranchID = @Tc_BranchID,
			Tc_SeqNo = @Tc_SeqNo,
			Tc_UpdatedBy = @USER,
			Tc_UpdatedDt = GETDATE(),
			Tc_IsActive = @Tc_IsActive
	WHERE Tc_Id = @Tc_Id
	END
	ELSE
	IF @SP_STATUS = 'Delete'
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'TermsConditionMaster',
									@Tc_Id,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT, 14, 9)
		END
	ELSE
		BEGIN
		DELETE FROM TermsConditionMaster
		WHERE Tc_Id = @Tc_Id
		END
	END
	ELSE
	IF @SP_STATUS = 'FillGrid'
	BEGIN
	SELECT	tcm.Tc_Id,
				tcm.Tc_Name,
				tcm.Tc_TcgId,
				tcm.Tc_BranchID,
				tcm.Tc_SeqNo,
				tcm.Tc_CreatedBy,
				tcm.Tc_CreatedDt,
				tcm.Tc_UpdatedBy,
				tcm.Tc_UpdatedDt,
				--tcm.Tc_IsActive,
				CASE
					WHEN tcm.Tc_IsActive = 1 THEN 'Yes'
					ELSE 'No'
				END AS Tc_IsActive,
				B.User_Name AS U_Name,
				C.Branch_Name AS BM_NAMEac,
				D.Tcg_Name AS TERM_GRP_NAME
	FROM TermsConditionMaster (NOLOCK)  AS tcm
	LEFT JOIN UserMAster  (NOLOCK) B
		ON tcm.Tc_CreatedBy = B.User_ID
	LEFT JOIN BranchMaster  (NOLOCK) AS C
		ON tcm.Tc_BranchID = C.Branch_Id
	LEFT JOIN TermsConditionGroupMaster  (NOLOCK) AS D
		ON tcm.Tc_Id = D.Tcg_Id
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_TermsConditionDetail]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TermsConditionDetail] 
	(@SP_STATUS varchar(200),
	@Tcd_Id int,
	@Tc_Id int,
	@Tc_TrId int)
AS
BEGIN
--========================BIND PARENT ID=====================
	IF @SP_STATUS = 'FillTree'
		BEGIN
			WITH CTE (id, ParentID, name, Tc_Id)
			AS (SELECT		Tcg_Id,Tcg_ParentId,Tcg_Name,0 AS Tc_Id
			FROM			TermsConditionGroupMaster (NOLOCK) 
			UNION ALL
			SELECT		0 AS Tcg_Id,tcm.Tc_TcgId AS Tcg_ParentId,tcm.Tc_Name,tcm.Tc_Id
			FROM		TermsConditionMaster (NOLOCK)  tcm)
			SELECT		id,ParentID,name,Tc_Id
			FROM		CTE
		END
	ELSE

	IF @SP_STATUS = 'GetAllForm'
		BEGIN
			SELECT	0 AS Mm_id,'--Select--' AS Mm_Name
			UNION
			SELECT		Mm_id,Mm_Name
			FROM		ModuleMaster
			WHERE		Mm_IsActive = 1;
		END

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Tcd_Id = ISNULL(MAX(Tcd_Id), 0) + 1
			FROM		TermsConditionDetail
			INSERT INTO		TermsConditionDetail 
							(Tcd_Id,Tc_Id,Tc_TrId )
			VALUES			(@Tcd_Id, @Tc_Id, @Tc_TrId)
		END
	ELSE

	IF @SP_STATUS = 'Update'
		BEGIN
			DELETE		FROM TermsConditionDetail
			WHERE		Tc_TrId = @Tc_TrId
			SELECT		@Tcd_Id = ISNULL(MAX(Tcd_Id), 0) + 1
			FROM		TermsConditionDetail (NOLOCK) 
			INSERT INTO		TermsConditionDetail 
							(Tcd_Id,Tc_Id,Tc_TrId )
			VALUES			(@Tcd_Id, @Tc_Id, @Tc_TrId)
		END

END
GO
/****** Object:  StoredProcedure [dbo].[SP_TermsConditionGroupMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TermsConditionGroupMaster] (@SP_STATUS varchar(200),
	@Tcg_Id bigint,
	@Tcg_Name nvarchar(199),
	@Tcg_ParentId int,
	@Tcg_SeqNo int,
	@Tcg_IsActive bit,
	@USER int)
AS
BEGIN
--========================BIND PARENT ID=====================
	IF @SP_STATUS = 'FillComboParentid'
		BEGIN
			SELECT		0 AS ID,
						'--Select--' AS NAME
			UNION
			SELECT		Tcg_Id AS ID,
						Tcg_Name AS NAME
			FROM		TermsConditionGroupMaster (NOLOCK) 
			WHERE		Tcg_IsActive = 1
		END

	ELSE IF @SP_STATUS = 'Count'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		TermsConditionGroupMaster (NOLOCK) 
			WHERE		Tcg_Name = @Tcg_Name
					AND Tcg_Id <> @Tcg_Id
		END

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Tcg_Id = ISNULL(MAX(Tcg_Id), 0) + 1
			FROM		TermsConditionGroupMaster (NOLOCK) 
			INSERT INTO		TermsConditionGroupMaster 
							(Tcg_Id,Tcg_Name,Tcg_ParentId,Tcg_SeqNo,Tcg_CreatedBy,Tcg_CreatedDt )
			VALUES			(@Tcg_Id, @Tcg_Name, @Tcg_ParentId, @Tcg_SeqNo, @USER, GETDATE())
		END
	ELSE

	IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		TermsConditionGroupMaster
			SET			Tcg_Name = @Tcg_Name,
						Tcg_ParentId = @Tcg_ParentId,
						Tcg_SeqNo = @Tcg_SeqNo,
						Tcg_UpdatedBy = @USER,
						Tcg_UpdatedDt = GETDATE(),
						Tcg_IsActive = @Tcg_IsActive
			WHERE		Tcg_Id = @Tcg_Id
		END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'TermsConditionGroupMaster',
											@Tcg_Id,
											@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT, 14, 9)
				END
			ELSE
				BEGIN
					DELETE FROM TermsConditionGroupMaster
					WHERE Tcg_Id = @Tcg_Id
				END
		END
	ELSE IF @SP_STATUS = 'FillGrid'
		BEGIN
			SELECT		tcg.Tcg_Id,tcg.Tcg_Name,tcg.Tcg_ParentId,tcg.Tcg_SeqNo,tcg.Tcg_CreatedBy,tcg.Tcg_CreatedDt,
						tcg.Tcg_UpdatedBy,tcg.Tcg_UpdatedDt,
						CASE
							WHEN tcg.Tcg_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END AS Tcg_IsActive,
						usr.User_Name AS U_NAME,parent.Tcg_Name AS PARENT
			FROM		TermsConditionGroupMaster (NOLOCK)  AS tcg
					LEFT JOIN UserMaster  (NOLOCK) usr
			ON			tcg.Tcg_CreatedBy = usr.User_ID
					LEFT JOIN TermsConditionGroupMaster  (NOLOCK) AS parent
			ON			tcg.Tcg_ParentId = parent.Tcg_Id
		END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_TradingMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_TradingMaster] @SP_STATUS nvarchar(100) = '',
		@Act_Key NUMERIC(18,0) = 0,
		@Act_DocType int = 0,
		@Act_No varchar(10) = NULL,
		@Act_DocKey NUMERIC(18,0) = 0,
		@Act_DocNo decimal(18,0) = 0,
		@Act_Date datetime = NULL,
		@Act_Amount decimal(18,2) = 0,
		@Act_DrCr varchar(2) = NULL,
		@Act_SrNo int = 0,
		@Act_LedgerId NUMERIC(18,0) = 0,
		@Act_Remarks varchar(500) = NULL,
		@Act_ChequeNo varchar(200) = NULL,
		@Act_ChequeDate datetime = NULL,
		@Act_BankName varchar(250) = NULL,
		@Act_VoucherNo decimal = 0,
		@Act_PaidAmount numeric(18,2) = 0,
		@Act_AdjustAmount numeric(18,2) = 0,
		@Act_EntryType varchar(10) = NULL,
		@DefaultNoGap nvarchar(10) = NULL,
		@DefaultNoDigits int = 0,
		@DefaultValue nvarchar(10) = NULL,
		@Act_Narration VARCHAR(MAX) = NULL,
		@ID NUMERIC(18,0) = 0 OUT
AS
BEGIN
	DECLARE @FROM_DATE	DATETIME
	DECLARE @TO_DATE	DATETIME
	DECLARE @LAST_KEY	BIGINT
	SELECT	TOP(1)
			@FROM_DATE=A.Year_FromDate,
			@TO_DATE=A.Year_ToDate
	FROM	YearMaster A
	WHERE	A.Year_IsDef=1

	SELECT	TOP(1)
			@LAST_KEY=DOC_KEY
	FROM	YEAR_END_LAST_DOCUMNT_KEY
	WHERE	DOC_TYPE='ACC_TRAN'

	IF @SP_STATUS = 'Insert'
		BEGIN
			IF @Act_SrNo = 1
				BEGIN
					SELECT		@Act_Key = ISNULL(MAX(Act_Key),0) + 1
					FROM		AccountTransaction(NOLOCK);

					SELECT		@Act_VoucherNo = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Act_VoucherNo,0)))
					FROM		AccountTransaction(NOLOCK)
					WHERE		Act_DocType = @Act_DocType AND 	Act_Date BETWEEN @FROM_DATE AND @TO_DATE
								AND Act_Key>ISNULL(@LAST_KEY,0)			

				END
			ELSE IF @Act_SrNo = 3
				BEGIN
					SELECT		@Act_Key = ISNULL(MAX(Act_Key),0)
					FROM		AccountTransaction(NOLOCK);
					SELECT		@Act_VoucherNo = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Act_VoucherNo,0)))
					FROM		AccountTransaction(NOLOCK)
					WHERE		Act_DocType = @Act_DocType AND 	Act_Date BETWEEN @FROM_DATE AND @TO_DATE
								AND Act_Key>ISNULL(@LAST_KEY,0)
				END
			ELSE 
				BEGIN
					SELECT		@Act_Key = ISNULL(MAX(Act_Key),0)
					FROM		AccountTransaction(NOLOCK);
					SELECT		@Act_VoucherNo = [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Act_VoucherNo,0))) - 1
					FROM		AccountTransaction(NOLOCK)
					WHERE		Act_DocType = @Act_DocType AND 	Act_Date BETWEEN @FROM_DATE AND @TO_DATE
								AND Act_Key>ISNULL(@LAST_KEY,0)
				END

			IF @Act_DocType < 7
			SET @Act_VoucherNo = 0

			INSERT INTO		[dbo].[AccountTransaction]
							([Act_Key],[Act_DocType],[Act_No],[Act_DocKey],[Act_DocNo],[Act_Date],[Act_Amount],[Act_DrCr],[Act_SrNo],[Act_LedgerId],[Act_Remarks],
							[Act_ChequeNo],[Act_ChequeDate],[Act_BankName],[Act_VoucherNo],Act_PaidAmount,Act_AdjustAmount,Act_EntryType,Act_Narration) 
			VALUES			(@Act_Key,@Act_DocType,@Act_No,@Act_DocKey,@Act_DocNo,@Act_Date,@Act_Amount,@Act_DrCr,@Act_SrNo,@Act_LedgerId,@Act_Remarks
							,@Act_ChequeNo,@Act_ChequeDate,@Act_BankName,@Act_VoucherNo,@Act_PaidAmount,@Act_AdjustAmount,@Act_EntryType,@Act_Narration)

			SELECT @ID = @Act_Key;
		END

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE			[dbo].[AccountTransaction]
			SET				[Act_DocType] = @Act_DocType,[Act_No] = @Act_No,[Act_DocKey] = @Act_DocKey,[Act_DocNo] = @Act_DocNo,
							[Act_Date] = @Act_Date,[Act_Amount] = @Act_Amount,[Act_DrCr] = @Act_DrCr,[Act_SrNo] = @Act_SrNo, [Act_LedgerId] = @Act_LedgerId,
							[Act_Remarks] = @Act_Remarks,[Act_ChequeNo] = @Act_ChequeNo,[Act_ChequeDate] = @Act_ChequeDate,[Act_BankName] = @Act_BankName,
							[Act_VoucherNo] = @Act_VoucherNo ,[Act_PaidAmount] = @Act_PaidAmount,[Act_AdjustAmount] = @Act_AdjustAmount, 
							[Act_EntryType] = @Act_EntryType,[Act_Narration] = @Act_Narration
			WHERE			[Act_Key] = @Act_Key

			SELECT			@ID = @Act_Key;
		END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DELETE 
			FROM		AccountTransactionRef
			WHERE		Acr_ActKey IN	(SELECT DISTINCT (Act_Key) 
										FROm		AccountTransaction
										WHERE		Act_DocType = @Act_DocType
										AND Act_DocKey = @Act_DocKey)
			DELETE 
			FROM		AccountTransaction
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey

			--DELETE 
			--FROM		AccountTransactionRef
			--WHERE		Acr_ActKey IN	(SELECT DISTINCT (Act_Key) 
			--							FROm		AccountTransaction
			--							WHERE		Act_DocKey = @Act_DocKey)
			--DELETE 
			--FROM		AccountTransaction
			--WHERE		Act_DocKey = @Act_DocKey




			SELECT @ID = @Act_DocKey;
		END

	ELSE IF @SP_STATUS = 'DeleteUpdateTime'
		BEGIN
			DELETE 
			FROM		AccountTransactionRef
			WHERE		Acr_ActKey = @Act_Key
			DELETE 
			FROM		AccountTransaction
			WHERE		Act_Key = @Act_Key
		END

	ELSE IF @SP_STATUS = 'UpdateAccountTransaction'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = ISNULL(Act_PaidAmount,0.00) + @Act_PaidAmount,
						Act_AdjustAmount = ISNULL(Act_AdjustAmount,0.00) + @Act_AdjustAmount
			WHERE		Act_Key = @Act_Key
					AND Act_DocType <> 16
		END

	ELSE IF @SP_STATUS = 'UpdateAccountTransactionUpdateTime'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = ISNULL(Act_PaidAmount,0.00) - @Act_PaidAmount,
						Act_AdjustAmount = ISNULL(Act_AdjustAmount,0.00) - @Act_AdjustAmount
			WHERE		Act_Key = @Act_Key
					AND Act_DocType <> 16
		END

	ELSE IF @SP_STATUS = 'UpdateAccountTransactionReturnTime'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = ISNULL(Act_PaidAmount,0.00) + @Act_PaidAmount,
						Act_AdjustAmount = ISNULL(Act_AdjustAmount,0.00) + @Act_AdjustAmount
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
					AND Act_DocNo = @Act_DocNo
					AND Act_DocType <> 16
			--and Act_PaidAmount+@Act_PaidAmount<=Act_Amount
			SELECT @ID = (SELECT TOP 1 Act_DocType FROM AccountTransaction(NOLOCK) WHERE Act_DocType = @Act_DocType AND Act_DocKey = @Act_DocKey AND Act_DocNo = @Act_DocNo)
		END
	--else  IF @SP_STATUS='UpdateAccountTransaction'
	--   BEGIN
	-- update  AccountTransaction set Act_PaidAmount=isnull(Act_PaidAmount,0.00)+@Act_PaidAmount 
	-- Delete From AccountTransaction where Act_DocType=@Act_DocType and Act_DocKey=@Act_DocKey
	--   END
	ELSE IF @SP_STATUS = 'GetCountBalance'
		BEGIN
			SELECT *
			FROM		AccountTransaction(NOLOCK)
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
					AND Act_DocNo = @Act_DocNo
		END

	ELSE IF @SP_STATUS = 'CheckPaidOrNot'
	BEGIN
		SELECT	*
		FROM		AccountTransactionRef(NOLOCK)
		WHERE		Acr_BookId = 2
				AND Acr_DocKey = @Act_DocKey
	END

	ELSE IF @SP_STATUS = 'CheckPaidOrNotPurchaseReturn'
		BEGIN
			SELECT	*
			FROM		AccountTransactionRef(NOLOCK)
			WHERE		Acr_BookId = 4
					AND	Acr_DocKey = @Act_DocKey
		END

	ELSE IF @SP_STATUS = 'AddBalanceInSalesInvoice'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = Act_PaidAmount + @Act_PaidAmount
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
					AND Act_DocNo = @Act_DocNo
					AND Act_DocType <> 16
		END
	IF @SP_STATUS = 'AddBalanceInSalesReturn'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = @Act_PaidAmount
			WHERe		Act_Key = @Act_Key
					AND Act_DocType <> 16
		END

	ELSE IF @SP_STATUS = 'UpdateAccountTransactionReturnTimeDelete'
		BEGIN
			UPDATE		AccountTransaction
			SET			Act_PaidAmount = ISNULL(Act_PaidAmount,0.00) - @Act_PaidAmount,
						Act_AdjustAmount = ISNULL(Act_AdjustAmount,0.00) - @Act_AdjustAmount
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
					AND Act_DocNo = @Act_DocNo
					AND Act_DocType <> 16
			SELECT @ID = (SELECT TOP 1 Act_Key FROM AccountTransaction(NOLOCK) WHERE Act_DocType = @Act_DocType AND Act_DocKey = @Act_DocKey AND Act_DocNo = @Act_DocNo)
		END

	ELSE IF @SP_STATUS = 'GetMaxKey'
		BEGIN
			DECLARE @FormPrefix AS nvarchar(max) = '';
				SELECT		@FormPrefix = FormPrefix
				FROM		FormDetailTable(NOLOCK)
				WHERE		Id =
														CASE
															WHEN @Act_DocType = 7 THEN 9
															WHEN @Act_DocType = 8 THEN 12
															WHEN @Act_DocType = 9 THEN 10
															WHEN @Act_DocType = 10 THEN 11
															WHEN @Act_DocType = 11 THEN 8
															WHEN @Act_DocType = 12 THEN 7
															WHEN @Act_DocType = 16 THEN 16
															ELSE 0
														END
				SELECT		@FormPrefix + [dbo].FUNC_GET_FINC_YEAR(MAX(ISNULL(Act_VoucherNo,0))) AS MaxNo
				FROM		AccountTransaction(NOLOCK)
				WHERE		Act_DocType = @Act_DocType AND 	Act_Date BETWEEN @FROM_DATE AND @TO_DATE AND Act_Key>ISNULL(@LAST_KEY,0)
		END

	ELSE IF @SP_STATUS = 'GetMaxNo'
		BEGIN
			SELECT		MAX(ISNULL(Act_VoucherNo,0)) AS MaxNo
			FROM		AccountTransaction(NOLOCK)
			WHERE		Act_DocType = @Act_DocType
		END

	ELSE IF @SP_STATUS = 'FillLedgerBank'
		BEGIN
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK) lm
			WHERE		Lm_IsActive = 1
					AND Lm_GroupId = 45
		END
	ELSE IF @SP_STATUS = 'FillLedgerCash'
		BEGIN
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK) lm
			WHERE		Lm_IsActive = 1
					AND Lm_GroupId = 44
		END
	ELSE IF @SP_STATUS = 'FillLedgerCredit'
		BEGIN
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK) lm
			WHERE		Lm_IsActive = 1
					AND Lm_GroupId IN (51)
		END

	ELSE IF @SP_STATUS = 'FillLedgerDebit'
		BEGIN
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK) lm
			WHERE		Lm_IsActive = 1
					AND Lm_GroupId IN (50)
		END
	ELSE IF @SP_STATUS = 'FillBookTypeBank'
		BEGIN
			SELECT Btm_Id,Btm_ModeName
			FROM BookTypeMaster(NOLOCK)
			WHERE Btm_Id IN (7,8)
		END

	ELSE IF @SP_STATUS = 'FillBookTypeCash'
		BEGIN
			SELECT		Btm_Id,Btm_ModeName
			FROM		BookTypeMaster(NOLOCK)
			WHERE		Btm_Id IN (9,10)
		END

	ELSE IF @SP_STATUS = 'FillBookTypeCreditDebit'
		BEGIN
			SELECT		Btm_Id,Btm_ModeName
			FROM		BookTypeMaster(NOLOCK)
			WHERE		Btm_Id IN (11,12)
		END

	ELSE IF @SP_STATUS = 'FillClientName'
		BEGIN
			--SELECT		Lm_Id,Lm_Name
			--FROM		LedgerMaster(NOLOCK) lm
			--WHERE		Lm_IsActive = 1
			--		AND Lm_Id NOT IN (@Act_LedgerId,1,2,3,4,5,6,7,13)

			SELECT		Lm_Id,Lm_Name, PM.StoreCode,PM.Contact_PersonName ,
						(case when   PM.Pm_Mob IS NOT NULL THEN  PM.Pm_Mob ELSE  VENADD.VendAdd_MobNo END)AS Pm_Mob
			FROM		LedgerMaster(NOLOCK) lm
				LEFT JOIN   PatientMaster (NOLOCK) PM
			ON			PM.Pm_Id = LM.Lm_PVId
			     AND	PM.Pm_Ledger_Id = LM.Lm_Id
				LEFT  JOIN   VendorMaster (NOLOCK)  VM
			ON			LM.Lm_Id =  VM.Vendor_Ledger_id
			    and		VM.Vendor_ID = lm.Lm_PVId
				LEFT JOIN    VendorAddMaster   (NOLOCK) VENADD
			ON          VENADD.VendAdd_Id= VM.Vendor_ID
			     
			WHERE		Lm_IsActive = 1
				AND		Lm_Id NOT IN (@Act_LedgerId,1,2,3,4,5,6,7,13)

		END

	ELSE IF @SP_STATUS = 'GetCreditDebitAcc'
		BEGIN
			SELECT		0 AS Lm_Id,'--Select One-- ' AS Lm_Name
			UNION
			SELECT		Lm_Id,Lm_Name
			FROM		LedgerMaster(NOLOCK) lm
			WHERE		Lm_IsActive = 1
					--AND Lm_Id NOT IN (8,9,@Act_LedgerId)
					and Lm_GroupId not in (44,45,50,51)--44 for Cash On Hand group and 45 for Bank A/c group,50 for debit,51 for credit
					and Lm_Id not in (@Act_LedgerId)
		END

	ELSE IF @SP_STATUS = 'FillJvDetail'
		BEGIN
			IF		@Act_Key = 0
					SELECT		Act_Key AS ActKey,Act_DocType AS ActDocType,Act_Date AS ActDate,Act_Amount AS ActAmount,Act_VoucherNo AS ActVoucherNo,
								(SELECT		Act_Remarks 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDrRemark,
								(SELECT Act_Remarks 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCrRemark,
								(SELECT Act_LedgerId 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDr,
								(SELECT Act_LedgerId 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCr,
								(SELECT LM.Lm_Name 
								FROM AccountTransaction(NOLOCK) AT1 LEFT JOIN LedgerMaster LM ON AT1.Act_LedgerId = LM.Lm_Id 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDrLedger,
								(SELECT LM.Lm_Name 
								FROM AccountTransaction(NOLOCK) AT1 LEFT JOIN LedgerMaster LM ON AT1.Act_LedgerId = LM.Lm_Id 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCrLedger
					FROM		AccountTransaction(NOLOCK) AT
					WHERE		Act_DocType = 16 
					GROUP BY Act_Key,Act_DocType,Act_Date,Act_Amount,Act_VoucherNo

			ELSE	SELECT		Act_Key AS ActKey,Act_DocType AS ActDocType,Act_Date AS ActDate,Act_Amount AS ActAmount,Act_VoucherNo AS ActVoucherNo,
								(SELECT Act_Remarks 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDrRemark,
								(SELECT Act_Remarks 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCrRemark,
								(SELECT Act_LedgerId 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDr,
								(SELECT Act_LedgerId 
								FROM AccountTransaction(NOLOCK) AT1 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCr,
								(SELECT LM.Lm_Name 
								FROM AccountTransaction(NOLOCK) AT1 LEFT JOIN LedgerMaster LM ON AT1.Act_LedgerId = LM.Lm_Id 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Dr' AND AT1.act_key = AT.Act_Key) AS ActDrLedger,
								(SELECT LM.Lm_Name 
								FROM AccountTransaction(NOLOCK) AT1 LEFT JOIN LedgerMaster LM ON AT1.Act_LedgerId = LM.Lm_Id 
								WHERE AT1.Act_DocType = AT.Act_DocType AND Act_DrCr = 'Cr' AND AT1.act_key = AT.Act_Key) AS ActCrLedger
					FROM		AccountTransaction(NOLOCK) AT
					WHERE		Act_DocType = 16
							AND Act_Key = @Act_Key GROUP BY Act_Key,Act_DocType,Act_Date,Act_Amount,Act_VoucherNo
		END

	ELSE IF @SP_STATUS = 'GetAllBill'
		BEGIN
			SELECT	*
			FROM		vwBillDetail(NOLOCK)
			WHERE		ISNULL(BillAmount,0.00) > ISNULL(BillPaidAmount,0.00) + ISNULL(BillAdjustAmount,0.00)
					AND Act_LedgerId = @Act_LedgerId
					AND Act_DocType = @Act_DocType
		END

	ELSE IF @SP_STATUS = 'GetAllBill1'
		BEGIN
			--SELECT		Act_DocType,BookType,BillDate,BillAmount,BillPayAmount,BillRemainingAmount,Act_LedgerId,Act_DrCr,
			--			(case	when Act_DocType=1 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 2) 
			--			when Act_DocType=2 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 3)
			--			when Act_DocType=3 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 5)
			--			when Act_DocType=4 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 4)
			--			when Act_DocType=5 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 6)
			--			when Act_DocType=7 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 9)
			--			when Act_DocType=8 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 12)
			--			when Act_DocType=9 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 10)
			--			when Act_DocType=10 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 11)
			--			when Act_DocType=11 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 8)
			--			when Act_DocType=12 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 7)
			--			when Act_DocType=16 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 16)
			--		end
			--			)+convert(varchar,BillNo)  as BillNo,
						
			--			Act_DocKey,
			--			BillAdjustAmount,BillPaidAmount,AdjustAmount,Act_Key
			--FROM		vwBillDetail(NOLOCK)
			--WHERE		ISNULL(BillAmount,0.00) > ISNULL(BillPaidAmount,0.00) + ISNULL(BillAdjustAmount,0.00)
			--		AND BillRemainingAmount > 0
			--		AND Act_LedgerId = @Act_LedgerId
			--		AND Act_DocType IN (SELECT	*
			--							FROM	DBO.STRING_SPLIT(@Act_Remarks,',') B) 
			--UNION

			--SELECT		Act_DocType,BookType,BillDate,BillAmount,BillPayAmount,BillRemainingAmount,Act_LedgerId,Act_DrCr,
			--			(case	when Act_DocType=1 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 2) 
			--			when Act_DocType=2 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 3)
			--			when Act_DocType=3 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 5)
			--			when Act_DocType=4 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 4)
			--			when Act_DocType=5 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 6)
			--			when Act_DocType=7 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 9)
			--			when Act_DocType=8 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 12)
			--			when Act_DocType=9 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 10)
			--			when Act_DocType=10 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 11)
			--			when Act_DocType=11 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 8)
			--			when Act_DocType=12 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 7)
			--			when Act_DocType=16 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 16)
			--		end
			--			)+convert(varchar,BillNo) as BillNo
			--			 ,Act_DocKey,
			--			BillAdjustAmount,BillPaidAmount,AdjustAmount,Act_Key
			--FROM		vwBillDetail(NOLOCK)
			--WHERE		((isnull(@Act_VoucherNo,0)=0 and BillRemainingAmount > 0 ) or (isnull(@Act_VoucherNo,0)!=0)) and
			--			vwBillDetail.Act_DocKey IN (SELECT		B.Acr_DocKey
			--										FROM		AccountTransaction(NOLOCK) AS A
			--												LEFT JOIN AccountTransactionRef AS B
			--										ON			A.Act_Key = B.Acr_ActKey
			--										WHERE		Act_VoucherNo = ISNULL(@Act_VoucherNo,0))
			--												AND Act_LedgerId = @Act_LedgerId
			--												AND Act_DocType IN (SELECT * FROM DBO.STRING_SPLIT(@Act_Remarks,',') B) 
			SELECT Act_DocType,
			       BookType,BillDate,BillAmount,BillPayAmount,BillRemainingAmount,Act_LedgerId,Act_DrCr,
				   (case when Act_DocType=1  then (SELECT FormPrefix FROM	FormDetailTable WHERE Id = 2) 
				         when Act_DocType=2  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 3)
				         when Act_DocType=3  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 5)
				         when Act_DocType=4  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 4)
				         when Act_DocType=5  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 6)
				         when Act_DocType=7  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 9)
				         when Act_DocType=8  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 12)
				         when Act_DocType=9  then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 10)
				         when Act_DocType=10 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 11)
				         when Act_DocType=11 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 8)
				         when Act_DocType=12 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 7)
				         when Act_DocType=16 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 16)
					end)+convert(varchar,BillNo)  as BillNo,
					Act_DocKey,
					BillAdjustAmount,
					BillPaidAmount,
					AdjustAmount,
					Act_Key,
					0 AS Acr_DocKey,
		            0 AS AA

			   FROM	vwBillDetail(NOLOCK)
			  WHERE	ISNULL(BillAmount,0.00) > ISNULL(BillPaidAmount,0.00) + ISNULL(BillAdjustAmount,0.00)
					AND BillRemainingAmount > 0
					AND Act_LedgerId = @Act_LedgerId
					AND Act_DocType IN (SELECT	*
										FROM DBO.STRING_SPLIT(@Act_Remarks,',') B) 
	        UNION ALL
            SELECT Act_DocType,BookType,
			       BillDate,BillAmount,
				   BillPayAmount,
				   BillRemainingAmount,
				   Act_LedgerId,
				   Act_DrCr,
			       (case when Act_DocType=1 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 2) 
			             when Act_DocType=2 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 3)
			             when Act_DocType=3 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 5)
			             when Act_DocType=4 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 4)
			             when Act_DocType=5 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 6)
			             when Act_DocType=7 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 9)
			             when Act_DocType=8 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 12)
			             when Act_DocType=9 then  (SELECT FormPrefix FROM FormDetailTable WHERE Id = 10)
			             when Act_DocType=10 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 11)
			             when Act_DocType=11 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 8)
			             when Act_DocType=12 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 7)
			             when Act_DocType=16 then (SELECT FormPrefix FROM FormDetailTable WHERE Id = 16)
		           end )+convert(varchar,BillNo) as BillNo,
		           Act_DocKey,
		           BillAdjustAmount,
		           BillPaidAmount,
		           AdjustAmount,
		           Act_Key,
		           B.Acr_DocKey,
		           (ISNULL(A.BillAmount,0) -ISNULL(A.BillPaidAmount,0)-ISNULL(A.BillAdjustAmount,0))+(ISNULL(B.Acr_PayAmount,0)+ISNULL(B.Acr_AdjAmount,0)) AS AA
              FROM vwBillDetail(NOLOCK) A
              	   INNER JOIN AccountTransactionRef B
                ON A.Act_DocKey=B.Acr_DocKey
              	   AND A.Act_DocType=B.Acr_BookId
              	   AND B.Acr_ActKey=@Act_KEY
             WHERE --(isnull(@Act_VoucherNo,0)=0 and BillRemainingAmount > 0 ) or 
			       BillRemainingAmount=0 ----Add Hasmukh
				   --AND ISNULL(B.Acr_PayAmount,0)+ISNULL(B.Acr_AdjAmount,0)>0----Add Hasmukh
			       --(ISNULL(A.BillAmount,0) -ISNULL(A.BillPaidAmount,0)-ISNULL(A.BillAdjustAmount,0))+(ISNULL(B.Acr_PayAmount,0)+ISNULL(B.Acr_AdjAmount,0)) >0
              	    AND A.Act_DocKey IN (SELECT B.Acr_DocKey
              							  FROM AccountTransaction(NOLOCK) AS A
              								   LEFT JOIN AccountTransactionRef AS B
              								ON A.Act_Key = B.Acr_ActKey
              							 WHERE Act_VoucherNo = ISNULL(@Act_VoucherNo,0))
              	   AND Act_LedgerId = @Act_LedgerId
              	   AND Act_DocType IN (SELECT * FROM DBO.STRING_SPLIT(@Act_Remarks,',') B)
              
		END
	ELSE IF @SP_STATUS = 'GetAllBill1UpdateTime'
		BEGIN
			SELECT		*
			FROM		vwBillDetail(NOLOCK)
			WHERE		Act_LedgerId = @Act_LedgerId
					AND Act_DocType IN (SELECT * FROM DBO.STRING_SPLIT(@Act_Remarks,',') B)
			UNION
			SELECT		Act_DocType,BookType,BillDate,BillAmount,BillPayAmount,BillRemainingAmount,Act_LedgerId,Act_DrCr,BillNo,Act_DocKey,
						BillAdjustAmount,BillPaidAmount,AdjustAmount,Act_Key
			FROM		vwBillDetail(NOLOCK)
			WHERE		BillRemainingAmount > 0 AND vwBillDetail.Act_DocKey IN (SELECT		B.Acr_DocKey
																				FROM		AccountTransaction(NOLOCK) AS A
																						LEFT JOIN AccountTransactionRef AS B
																				ON			A.Act_Key = B.Acr_ActKey
																				WHERE		Act_VoucherNo = ISNULL(@Act_VoucherNo,0))
																						AND Act_LedgerId = @Act_LedgerId
																						AND Act_DocType IN (SELECT  *
																											FROM DBO.STRING_SPLIT(@Act_Remarks,',') B)
		END
	ELSE IF @SP_STATUS = 'GetBillWiseDetail'
		BEGIN
			SELECT		*
			FROM		vwBillWiseList(NOLOCK)
			WHERE		Act_DocType = @Act_DocType
					AND Acr_PayAmount > 0
			ORDER BY Date DESC
		END
	ELSE IF @SP_STATUS = 'GetBillWiseDetail_Credit_debit_note'
		BEGIN
			--SELECT		*
			--FROM		vwBillWiseList(NOLOCK)
			--WHERE		Act_DocType = @Act_DocType
			--		--AND Acr_PayAmount > 0
			--ORDER BY Date DESC


			SELECT        act.Act_DocType, act.Act_Key, btm.Btm_ModeName, CONVERT(date, act.Act_Date) AS Date, act.Act_Amount, act.Act_DrCr, act.Act_LedgerId, act.Act_VoucherNo, 
                         act.Act_PaidAmount AS Acr_PayAmount, SUM(ISNULL(ref.Acr_AdjAmount, 0)) AS Acr_AdjAmount, lm.Lm_Name,Act_SrNo
			FROM            dbo.AccountTransaction AS act LEFT OUTER JOIN
			                         dbo.BookTypeMaster AS btm ON act.Act_DocType = btm.Btm_Id LEFT OUTER JOIN
			                         dbo.LedgerMaster AS lm ON act.Act_LedgerId = lm.Lm_Id LEFT OUTER JOIN
			                         dbo.AccountTransactionRef AS ref ON act.Act_Key = ref.Acr_ActKey
			WHERE        act.Act_SrNo=(case  when  @Act_DocType =11 then  2 else  1 end)  AND (act.Act_VoucherNo <> 0) and  Act_DocType = @Act_DocType
			GROUP BY		act.Act_DocType, act.Act_Key, btm.Btm_ModeName, CONVERT(date, act.Act_Date), act.Act_Amount, act.Act_DrCr, act.Act_LedgerId, act.Act_VoucherNo, 
                         act.Act_PaidAmount, lm.Lm_Name,Act_SrNo

		END

	ELSE IF @SP_STATUS = 'GetBankName'
		BEGIN
			SELECT		DISTINCT (Act_BankName) AS Act_BankName
			FROM		AccountTransaction
			WHERE		Act_BankName <> ''
		END

	ELSE IF @SP_STATUS = 'Retrive'
		BEGIN
			DECLARE @FormPrefix_Fill_Grid AS nvarchar(max) = '';
				SELECT		@FormPrefix_Fill_Grid = FormPrefix
				FROM		FormDetailTable(NOLOCK)
				WHERE		Id =
														CASE
															WHEN @Act_DocType = 7 THEN 9
															WHEN @Act_DocType = 8 THEN 12
															WHEN @Act_DocType = 9 THEN 10
															WHEN @Act_DocType = 10 THEN 11
															WHEN @Act_DocType = 11 THEN 8
															WHEN @Act_DocType = 12 THEN 7
															WHEN @Act_DocType = 16 THEN 16
															ELSE 0
														END
				SELECT		Act_Key,Act_DocType,Act_No,Act_DocKey,Act_DocNo,Act_Date,Act_Amount,Act_DrCr,Act_SrNo,Act_LedgerId,B.Lm_Name,Act_Remarks,Act_ChequeNo,Act_ChequeDate,
							Act_BankName,@FormPrefix_Fill_Grid + CAST(Act_VoucherNo AS nvarchar(max)) AS Act_VoucherNo,Act_PaidAmount,Act_AdjustAmount,Act_EntryType,
							Act_Narration
				FROM		dbo.AccountTransaction(NOLOCK) act
				LEFT JOIN LedgerMaster as B
				on act.Act_LedgerId=b.Lm_Id
				WHERE		Act_Key = @Act_Key
						AND Act_DocType = @Act_DocType;

				SELECT	*
				FROM		AccountTransactionRef(NOLOCK) ref
				WHERE		Acr_ActKey = @Act_Key;
		END;

	ELSE IF @SP_STATUS = 'GetLedger'
		BEGIN
			SELECT		Lm_Id,
						Lm_Name,
						ISNULL(PM.Contact_PersonName,'')AS  Contact_PersonName,
						ISNULL(Pm_Mob,'')AS Pm_Mob,
						ISNULL(StoreCode,'')AS StoreCode,
						Lm_GroupId,Lm_PVId,Lm_Address,Lm_PhoneNo,lgm.Lgm_Name AS Ledger_Group
			FROM		LedgerMaster (NOLOCK) lm
					LEFT JOIN LedgerGroupMaster (NOLOCK) lgm
			ON			lm.Lm_GroupId = lgm.Lgm_Id
					LEFT JOIN PatientMaster (NOLOCK) PM
			ON			PM.Pm_Id = lm.Lm_PVId
					

			WHERE		Lm_IsActive = 1;
		END

	ELSE IF @SP_STATUS = 'DELETE_TRANSACTIONS'
		BEGIN
			DELETE 
			FROM		AccountTransactionRef
			WHERE		Acr_ActKey IN	(SELECT		Act_Key
										FROM		AccountTransaction
										WHERE		Act_DocType = @Act_DocType
												AND Act_DocKey = @Act_DocKey)

			DELETE 
			FROM		AccountTransaction
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
		END


	ELSE IF @SP_STATUS = 'DELETE_TRANSACTIONS_ROUNDOFF'
		BEGIN
		
			DELETE		
			FROM		AccountTransaction
			WHERE		Act_DocType = @Act_DocType
					AND Act_DocKey = @Act_DocKey
					and Act_No=@Act_No
		END

	ELSE IF @SP_STATUS = 'GetLedgerReport'
		BEGIN
			IF EXISTS	(SELECT *
						FROM		tempdb.sys.tables
						WHERE		name = '##LEDGER_REPORT')
			BEGIN
				DROP TABLE ##LEDGER_REPORT
			END
			;
			WITH cte
			AS (SELECT
				act.Act_SrNo,
				act.Act_Key,
				ROW_NUMBER() OVER (ORDER BY act.Act_Key) + 1 AS row,
				--CASE
				--	WHEN act.Act_VoucherNo = 0 THEN act.Act_DocNo
				--	ELSE act.Act_VoucherNo
				--END AS Act_VoucherNo,

				CASE
					WHEN act.Act_VoucherNo = 0 
					THEN (case	when btm.Btm_Id=1 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 2) 
						when btm.Btm_Id=2 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 3)
						when btm.Btm_Id=3 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 5)
						when btm.Btm_Id=4 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 4)
						when btm.Btm_Id=5 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 6)
						when btm.Btm_Id=7 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 9)
						when btm.Btm_Id=8 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 12)
						when btm.Btm_Id=9 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 10)
						when btm.Btm_Id=10 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 11)
						when btm.Btm_Id=11 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 8)
						when btm.Btm_Id=12 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 7)
						when btm.Btm_Id=16 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 16)
					end
				)+CONVERT(VARCHAR,act.Act_DocNo)
					ELSE (case	when btm.Btm_Id=1 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 2) 
						when btm.Btm_Id=2 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 3)
						when btm.Btm_Id=3 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 5)
						when btm.Btm_Id=4 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 4)
						when btm.Btm_Id=5 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 6)
						when btm.Btm_Id=7 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 9)
						when btm.Btm_Id=8 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 12)
						when btm.Btm_Id=9 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 10)
						when btm.Btm_Id=10 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 11)
						when btm.Btm_Id=11 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 8)
						when btm.Btm_Id=12 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 7)
						when btm.Btm_Id=16 then (SELECT	FormPrefix FROM	FormDetailTable WHERE Id = 16)
					end
				)+CONVERT(VARCHAR,act.Act_VoucherNo)
				END AS  Act_VoucherNo,
				act.Act_Date AS Date,
				
				--btm.Btm_ModeName AS [Voc. Type],
				case when btm.Btm_Id=17 then '' else btm.Btm_ModeName end AS [Voc. Type],

				case when @Act_LedgerId=12 then
				 (select l.Lm_Name  from AccountTransaction at 
				 left join LedgerMaster l on at.Act_LedgerId=l.Lm_Id where at.Act_Key=act.Act_Key and at.Act_DocType=16 and Act_LedgerId!=12)
				 else lm.Lm_Name end AS Particulars,
				 --lm.Lm_Name   AS Particulars,
				CASE
					WHEN act.Act_DocType = 16  and @act_LedgerId<>12 THEN CASE
							WHEN act.Act_DrCr = 'Cr' THEN act.Act_Amount
							ELSE 0.00
						END
					ELSE CASE
							WHEN act.Act_DrCr = 'Dr' THEN act.Act_Amount
							ELSE 0.00
						END
				END AS Debit,
				CASE
					WHEN act.Act_DocType = 16  and  @act_LedgerId<>12 THEN CASE
							WHEN act.Act_DrCr = 'Dr' THEN act.Act_Amount
							ELSE 0.00
						END
					ELSE CASE
							WHEN act.Act_DrCr = 'Cr' THEN act.Act_Amount
							ELSE 0.00
						END
				END AS Credit,
				act.Act_LedgerId,
				(act.Act_Remarks+''+ (CASE  WHEN act.Act_Narration='' THEN '' ELSE ' ['+ act.Act_Narration+']' END)) AS Act_Remarks
			FROM		AccountTransaction(NOLOCK) act
					CROSS JOIN AccountTransaction act1
					LEFT JOIN BookTypeMaster(NOLOCK) btm
			ON			act.Act_DocType = btm.Btm_Id
					LEFT JOIN LedgerMaster(NOLOCK) lm
			ON			act.Act_LedgerId = lm.Lm_Id
					LEFT JOIN LedgerMaster(NOLOCK) lmACT1
			ON			act1.Act_LedgerId = lmACT1.Lm_Id
			WHERE  act1.act_Key IN (act.act_Key)
					AND ((@act_LedgerId = 12
					AND act.act_LedgerId = @act_LedgerId)
					OR (@act_LedgerId <> 12
					AND act1.Act_LedgerId = @act_LedgerId
					AND act.act_LedgerId <> @act_LedgerId))
				--	AND act.act_LedgerId <>
				--CASE
				--	WHEN lmACT1.Lm_GroupId IN (45,44,50,51) THEN 12
				--	ELSE 0
				--END
					AND btm.Btm_Id <>
				CASE
					WHEN lmACT1.Lm_GroupId IN (45,44,50,51) THEN 16
					ELSE 0
				END

			
			GROUP BY	Btm_Id,act.Act_DocType,
						act.Act_Date,
						btm.Btm_ModeName,
						lm.Lm_Name,
						act.Act_DrCr,
						act.Act_Amount,
						act.Act_Key,
						act.Act_LedgerId,
						act.Act_VoucherNo,
						act.Act_DocNo,
						act.Act_SrNo,act.Act_Remarks,
						act.Act_Narration
			)
			SELECT 0 AS Act_Key,1 AS Srno,NULL AS [VoucherNo],NULL AS Date,'' AS [VocType],'Opening Balance' AS Particulars,
					CASE WHEN Lm_OpeningDrCr = 'Dr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END AS Debit,CASE WHEN Lm_OpeningDrCr = 'Cr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END AS Credit,
			--0.00 AS Balance
			CASE WHEN ((CASE WHEN Lm_OpeningDrCr = 'Dr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END) - (CASE WHEN Lm_OpeningDrCr = 'Cr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END)) > 0 THEN ((CASE WHEN Lm_OpeningDrCr = 'Dr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END) - (CASE WHEN Lm_OpeningDrCr = 'Cr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END)) ELSE ((CASE WHEN Lm_OpeningDrCr = 'Dr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END) - (CASE WHEN Lm_OpeningDrCr = 'Cr' THEN ISNULL(Lm_OpeningBalance,0.00) ELSE 0.00 END)) * (-1) END AS Balance,Lm_OpeningDrCr AS [Type],
			'' AS REMARKS,A.Store_Name Branch_Name,A.Store_Address1 AS Branch_Address,A.Store_GstNo Branch_GstNo INTO ##LEDGER_REPORT
			FROM LedgerMaster(NOLOCK)
			LEFT JOIN StoreMaster(NOLOCK) A
				ON 0 = 0
			WHERE Lm_Id = @act_LedgerId
			AND A.Store_Id = 1
			UNION
			SELECT		cte.Act_Key,cte.row AS SrNo,cte.Act_VoucherNo AS [VoucherNo],cte.Date,cte.[Voc. Type] AS VocType,cte.Particulars,
						ISNULL(cte.Debit,0.00) AS Debit,ISNULL(cte.Credit,0.00) AS Credit,0 AS Balance,'' AS [Type],
						cte.Act_Remarks as REMARKS,
						'' AS Branch_Name,'' AS Branch_Address,'' AS Branch_GstNo
			FROM cte 
			GROUP BY	cte.Act_Remarks, cte.row,cte.Date,cte.[Voc. Type],cte.Particulars,cte.Debit,cte.Credit,cte.Act_Key,
						cte.Act_LedgerId,cte.Act_VoucherNo
			SELECT		a.Act_Key,a.SrNo,
						a.VoucherNo,a.Date,a.VocType,a.Particulars,a.Debit,a.Credit,
						CASE WHEN (SUM(b.Debit) - SUM(b.Credit)) > 0 THEN (SUM(b.Debit) - SUM(b.Credit)) ELSE (SUM(b.Debit) - SUM(b.Credit)) * (-1) END AS Balance,
						CASE WHEN (SUM(b.Debit) - SUM(b.Credit)) > 0 THEN 'Dr' ELSE 'Cr' END AS [Type],a.REMARKS,a.Branch_Name,a.Branch_Address,a.Branch_GstNo
			FROM		##LEDGER_REPORT a
					LEFT JOIN ##LEDGER_REPORT b
			ON			a.SrNo >= b.SrNo 
			GROUP BY	a.Act_Key,a.Srno,a.VoucherNo,a.Date,a.VocType,a.Particulars,a.Debit,a.Credit,a.Type,
						a.REMARKS,a.Branch_Name,a.Branch_Address,a.Branch_GstNo

			ORDER BY a.Act_Key
		END
	ELSE IF @SP_STATUS = 'GET_JV_NO'
		BEGIN
			SELECT		AT.Act_No
			FROM		AccountTransaction(NOLOCK) AT
			WHERE		AT.Act_Key = @Act_Key
		END
	ELSE IF @SP_STATUS = 'GetTransactionDetail'
		BEGIN
			SELECT		CONVERT(varchar,act.Act_Date,105) AS Date,act.Act_VoucherNo AS VoucherNo,act.Act_PaidAmount AS Amount,act.Act_Remarks Remarks,
						(SELECT		l.Lm_Name FROM AccountTransaction act1 
							LEFT JOIN LedgerMaster l ON act1.Act_LedgerId = l.Lm_Id 
						WHERE (act1.Act_SrNo = 2) AND Act_Key = act.Act_Key) AS Name,
						BM.Branch_Name,(ISNULL(BM.Branch_Address1,'') + ' ' + ISNULL(BM.Branch_Address2,'') + ' ' + ISNULL(BM.Branch_Address3,'')) AS Branch_Address,BM.Branch_GstNo
			FROM		dbo.AccountTransaction AS act
					LEFT OUTER JOIN dbo.LedgerMaster AS lm
			ON			act.Act_LedgerId = lm.Lm_Id
					LEFT JOIN BranchMaster(NOLOCK) BM
			ON			BM.Branch_Id = 1
			WHERE		(act.Act_SrNo IN (1,2))
					AND (act.Act_VoucherNo <> 0)
					AND act.Act_DocType = @Act_DocType
					AND act.Act_LedgerId = @Act_LedgerId
					AND Act_Date BETWEEN @Act_ChequeDate AND @Act_Date
		END
	ELSE IF @SP_STATUS = 'GET_CREDITNOTE'
		BEGIN
			--SELECT		pm.Pm_Fullname,StoreCode,Contact_PersonName, Pm_Mob AS mobile,Pm_PanNo,Gst_no,Drug_Lic,
			--			CAST(srh.Srh_Date AS DATE) Srh_Date,at.Act_No,CAST(at.Act_Date AS DATE) AS Act_Date,at.Act_DocNo,
			--			cast (SRH.Srh_No AS varchar(max)) + ','+ cast (cast(SRH.Srh_Date AS  DATE)AS varchar(max)) as   Description,
			--			Srh_Total  AS  Amount
			--FROM		AccountTransaction (NOLOCK) AT
			--		INNER JOIN SalesReturnHeader (NOLOCK) SRH
			--ON			AT.Act_DocType = @Act_DocType
			--		AND AT.Act_DocKey = SRH.Srh_Id
			--		LEFT JOIN  PatientMaster (NOLOCK) pm
			--ON			pm.Pm_Id = SRH.Srh_CustId
			--WHERE		AT.Act_LedgerId  =  @Act_LedgerId
			DECLARE		@TransactionOrDirect INT
			SET			@TransactionOrDirect=(SELECT		COUNT(*)	
												FROM		AccountTransaction ACT
  	            											INNER JOIN LedgerMaster LM
  												ON			LM.Lm_Id=ACT.Act_LedgerId
  	            											INNER JOIN BookTypeMaster BM
  												ON			BM.Btm_Id=ACT.Act_DocType
												WHERE		Act_DocType=@Act_DocType 
															AND Act_LedgerId=@Act_LedgerId 
															AND Act_VoucherNo=@Act_VoucherNo
															AND ACT.Act_Remarks LIKE '%PR%' 
															OR ACT.Act_Remarks LIKE '%SR%'
												); 
			IF(@TransactionOrDirect=0)
			BEGIN
				SELECT		'NR' AS Type,
							Act_VoucherNo,
							Convert(Date,ACT.Act_Date,105)AS Date,
							Act_Amount,
							Act_Remarks,
							LM.Lm_Name,
							BM.Btm_ModeName
				FROM		AccountTransaction ACT
  	            			INNER JOIN LedgerMaster LM
  	            ON			LM.Lm_Id=ACT.Act_LedgerId
  	            			INNER JOIN BookTypeMaster BM
  	            ON			BM.Btm_Id=ACT.Act_DocType
               WHERE		Act_DocType=@Act_DocType 
							AND Act_LedgerId=@Act_LedgerId 
							AND Act_VoucherNo=@Act_VoucherNo
			END
			ELSE IF(@Act_DocType=11)
			BEGIN
				SELECT		'TR' AS Type,
							'Credit' AS Note,
							ROW_NUMBER() OVER (ORDER BY PRD.Prd_Id ASC)AS SrNo,  
							DT.Act_VoucherNo,
							Convert(VARCHAR,DT.SDate,105)AS Date,
							Act_Amount,
							DT.Lm_Name,
							DT.Btm_ModeName,  
							PRH.Prh_No AS PihNo,    
							CONVERT(varchar,PRH.Prh_Date,105) AS PIhDate,    
							PIH.Pih_RefNo AS BillNo,    
							CONVERT(varchar,PIH.Pih_RefDate,105) AS BillDate,      
							 (CASE WHEN	VM.Vendor_Code like '%LS%' 
									THEN VM.Vendor_Code+' & '+VM.Vendor_Name
									ELSE VM.Vendor_Name
							END) AS VendorName,     
							ISNULL(VAM.VendAdd_Addr1,'') + ',' + ISNULL(VAM.VendAdd_Add2,'') + ',' + ISNULL(VAM.VendAdd_Add3,'')AS VendorAddress, 
							VAM.VendAdd_GstNo AS GstNo,    
							0 AS GrossValue,    
							PRH.Prh_TotalAmount AS TotalValue,    
							MM.Mm_HsnCode AS HsnCode,    
							MM.Mm_Code AS Code,    
							MM.Mm_Name AS Name,    
							UOMM.Uom_Name AS UomName,    
							PRD.Prd_BatchNo AS BatchNo,    
							PID.Pid_MfgDt AS Mnf,    
							(CASE WHEN PID.Pid_ExpiryDt IS NULL THEN '' ELSE RIGHT(CONVERT(VARCHAR(10),PID.Pid_ExpiryDt, 105) , 7) END) AS Expiry,
							PRD.Prd_Qty AS Quantity,    
							PRD.Prd_Rate AS Rate,    
							BB.SGST,    
							BB.CGST,    
							BB.IGST,    
							0 AS NetAmount,    
							(BB.SGST + BB.CGST +BB.IGST)AS TaxAmount,    
							0 AS Discount,    
							PRD.Prd_Amount AS Amount,    
							MTM.Mtm_TypeName AS DrugType,    
							MGM.Mgm_Name AS DrugGroup,    
							MCM.Mcm_Name AS DrugCategory,    
							SM.Store_Code+' & '+SM.Store_Name AS Store_Name,    
							SM.Store_Address1,    
							SM.Store_GstNo,    
							SM.Store_Email,    
							0 AS Po_No                                    
				FROM		PurchaseReturnDetail(NOLOCK) PRD
							INNER JOIN PurchaseReturnHeader(NOLOCK) PRH
				ON			PRH.Prh_Id=PRD.Prd_PrhId
							LEFT JOIN PurchaseInvoiceDetail(NOLOCK) PID 
				ON			PID.Pid_SrNo=PRD.Prd_PidSrNo
							AND PID.Pid_PihKey=PRD.Prd_PihKey  
							LEFT JOIN PurchaseInvoiceHeader(NOLOCK) PIH
				ON			PIH.Pih_Key=PID.Pid_PihKey     
							LEFT JOIN StoreMaster SM    
				ON			SM.Store_Id=1    
							INNER JOIN MedicineMaster(NOLOCK) MM    
				ON			MM.Mm_ID = PRD.Prd_MmId    
							LEFT JOIN UomMaster(NOLOCK) UOMM    
				ON			UOMM.Uom_ID = PID.Pid_UomId    
							LEFT JOIN VendorMaster(NOLOCK) VM    
				ON			PIH.Pih_VenId = VM.Vendor_ID    
							LEFT JOIN VendorAddMaster(NOLOCK) VAM    
				ON			PIH.Pih_VenAddId = VAM.VendAdd_Id    
							LEFT JOIN MedicineTypeMaster(NOLOCK) MTM    
				ON			MTM.Mtm_ID = MM.Mm_MtmId    
							LEFT JOIN MedicineGroupMaster(NOLOCK) MGM    
				ON			MGM.Mgm_ID = MM.Mm_MgmId    
							LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM    
				ON			MCM.Mcm_ID = MM.Mm_McmId    
							LEFT JOIN (SELECT		A.Prd_Id,    
													ISNULL(SUM(A.SGST),0) AS SGST,    
													ISNULL(SUM(A.CGST),0) AS CGST,    
													ISNULL(SUM(A.IGST),0) AS IGST    
										FROM		(SELECT			A.Prd_Id,    
																	B.Tr_TxTot AS CGST,    
																	C.Tr_TxTot AS SGST,    
																	D.Tr_TxTot AS IGST    
													FROM			PurchaseReturnDetail (NOLOCK) AS A    
																	LEFT JOIN TaxTransaction (NOLOCK) B    
													ON				A.Prd_Id = B.Tr_DdocKey    
																	AND A.Prd_PrhId = B.Tr_DocKey    
																	AND B.Tr_TxId = 2    
																	AND B.Tr_DocTyp = 5    
																	LEFT JOIN TaxTransaction (NOLOCK) C    
													ON				A.Prd_Id = C.Tr_DdocKey    
																	AND A.Prd_PrhId = C.Tr_DocKey    
																	AND C.Tr_DocTyp = 5    
																	AND C.Tr_TxId = 3    
																	LEFT JOIN TaxTransaction (NOLOCK) D    
													ON				A.Prd_Id = D.Tr_DdocKey    
																	AND A.Prd_PrhId = D.Tr_DocKey    
																	AND D.Tr_DocTyp = 5    
																	AND D.Tr_TxId = 4) AS A    
													GROUP BY		A.Prd_Id
													) AS BB    
				ON			PRD.Prd_Id = BB.Prd_Id 
							INNER JOIN (SELECT			Act_VoucherNo,
														Act_Amount,
														Convert(Date,ACT.Act_Date,105)AS SDate,
														CAST(ISNULL(REPLACE(Act_Remarks,'PR',''),'0') AS NUMERIC(18,0))AS Act_Remarks,
														LM.Lm_Name,
														BM.Btm_ModeName
										FROM			AccountTransaction ACT
				  	            						INNER JOIN LedgerMaster LM
				  						ON				LM.Lm_Id=ACT.Act_LedgerId
				  	            						INNER JOIN BookTypeMaster BM
				  						ON				BM.Btm_Id=ACT.Act_DocType
										WHERE			Act_DocType=@Act_DocType AND 
														Act_LedgerId=@Act_LedgerId AND 
														Act_VoucherNo=@Act_VoucherNo
										)AS DT
				ON			DT.Act_Remarks=PRH.Prh_No
			END	
			ELSE IF(@Act_DocType=12)
			BEGIN
				SELECT		'TR' AS Type,
							'Debit' AS Note,
							ROW_NUMBER() OVER (ORDER BY SRD.Srd_Id ASC)AS SrNo,  
							DT.Act_VoucherNo,
							Convert(VARCHAR,DT.SDate,105)AS Date,
							Act_Amount,
							DT.Lm_Name,
							DT.Btm_ModeName,  
							SRH.Srh_No AS SihNo,    
							CONVERT(varchar,SRH.Srh_Date,105) AS PIhDate,    
							SIH.Sih_No AS BillNo,    
							CONVERT(varchar,SIH.Sih_Date,105) AS BillDate,    
							 (CASE WHEN	PM.StoreCode like '%LS%' 
									THEN	PM.StoreCode+' & '+PM.Pm_Fullname
									ELSE	PM.Pm_Fullname
							END) AS VendorName,    
							PM.Pm_Address AS VendorAddress,   
							Gst_no AS GstNo,    
							0 AS GrossValue,    
							SRH.Srh_Total AS TotalValue,    
							MM.Mm_HsnCode AS HsnCode,    
							MM.Mm_Code AS Code,    
							MM.Mm_Name AS Name,    
							UOMM.Uom_Name AS UomName,    
							SRD.Srd_BatchNo AS BatchNo,    
							SID.Sid_MnfDate AS Mnf,    
							(CASE WHEN SID.Sid_ExpDate IS NULL THEN '' ELSE RIGHT(CONVERT(VARCHAR(10),SID.Sid_ExpDate, 105) , 7) END) AS Expiry,  
							SRD.Srd_Qty AS Quantity,    
							SRD.Srd_Rate AS Rate,    
							BB.SGST,    
							BB.CGST,    
							BB.IGST,    
							0 AS NetAmount,    
							(BB.SGST + BB.CGST +BB.IGST)AS TaxAmount,    
							0 AS Discount,    
							SRD.Srd_Amount AS Amount,    
							MTM.Mtm_TypeName AS DrugType,    
							MGM.Mgm_Name AS DrugGroup,    
							MCM.Mcm_Name AS DrugCategory,    
							SM.Store_Code+' & '+SM.Store_Name AS Store_Name,    
							SM.Store_Address1,    
							SM.Store_GstNo,    
							SM.Store_Email,    
							0 AS Po_No                                    
				FROM		SalesReturnDetail(NOLOCK) SRD
							INNER JOIN SalesReturnHeader(NOLOCK) SRH
				ON			SRH.Srh_Id=SRD.Srd_SrhId
							LEFT JOIN SalesInvoiceItemDetail(NOLOCK) SID 
				ON			SID.Sid_Key=SRD.Srd_SidSrNo
							AND SID.Sid_Sih_Key=SRD.Sid_SihKey  
							LEFT JOIN SalesInvoiceHeader(NOLOCK) SIH
				ON			SIH.Sih_Key=SID.Sid_Sih_Key     
							LEFT JOIN StoreMaster SM    
				ON			SM.Store_Id=1    
							INNER JOIN MedicineMaster(NOLOCK) MM    
				ON			MM.Mm_ID = SRD.Srd_MmId    
							LEFT JOIN UomMaster(NOLOCK) UOMM    
				ON			UOMM.Uom_ID = SID.Sid_SalesUomId    
							LEFT JOIN PatientMaster(NOLOCK) PM    
				ON			SIH.Sih_Pm_Id = PM.Pm_Id  
							LEFT JOIN MedicineTypeMaster(NOLOCK) MTM    
				ON			MTM.Mtm_ID = MM.Mm_MtmId    
							LEFT JOIN MedicineGroupMaster(NOLOCK) MGM    
				ON			MGM.Mgm_ID = MM.Mm_MgmId    
							LEFT JOIN MedicineCategoryMaster(NOLOCK) MCM    
				ON			MCM.Mcm_ID = MM.Mm_McmId    
							LEFT JOIN (SELECT		A.Srd_Id,    
													ISNULL(SUM(A.SGST),0) AS SGST,    
													ISNULL(SUM(A.CGST),0) AS CGST,    
													ISNULL(SUM(A.IGST),0) AS IGST    
										FROM		(SELECT			A.Srd_Id,    
																	B.Tr_TxTot AS CGST,    
																	C.Tr_TxTot AS SGST,    
																	D.Tr_TxTot AS IGST    
													FROM			SalesReturnDetail (NOLOCK) AS A    
																	LEFT JOIN TaxTransaction (NOLOCK) B    
													ON				A.Srd_Id = B.Tr_DdocKey    
																	AND A.Srd_SrhId = B.Tr_DocKey    
																	AND B.Tr_TxId = 2    
																	AND B.Tr_DocTyp = 3    
																	LEFT JOIN TaxTransaction (NOLOCK) C    
													ON				A.Srd_Id = C.Tr_DdocKey    
																	AND A.Srd_SrhId = C.Tr_DocKey    
																	AND C.Tr_DocTyp = 3   
																	AND C.Tr_TxId = 3    
																	LEFT JOIN TaxTransaction (NOLOCK) D    
													ON				A.Srd_Id = D.Tr_DdocKey    
																	AND A.Srd_SrhId = D.Tr_DocKey    
																	AND D.Tr_DocTyp = 3    
																	AND D.Tr_TxId = 4) AS A    
													GROUP BY		A.Srd_Id
													) AS BB    
				ON			SRD.Srd_Id = BB.Srd_Id 
							INNER JOIN (SELECT			Act_VoucherNo,
														Act_Amount,
														Convert(Date,ACT.Act_Date,105)AS SDate,
														CAST(ISNULL(REPLACE(Act_Remarks,'SR',''),'0') AS NUMERIC(18,0))AS Act_Remarks,
														LM.Lm_Name,
														BM.Btm_ModeName
										FROM			AccountTransaction ACT
				  	            						INNER JOIN LedgerMaster LM
				  						ON				LM.Lm_Id=ACT.Act_LedgerId
				  	            						INNER JOIN BookTypeMaster BM
				  						ON				BM.Btm_Id=ACT.Act_DocType
										WHERE			Act_DocType=@Act_DocType AND 
														Act_LedgerId=@Act_LedgerId AND 
														Act_VoucherNo=@Act_VoucherNo
										)AS DT
				ON			DT.Act_Remarks=SRH.Srh_No
			END
	END

END
GO
/****** Object:  StoredProcedure [dbo].[SP_UomMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- AUTHOR:    <AUTHOR,,NAME>
-- CREATE DATE: <CREATE DATE,,>
-- DESCRIPTION:	<DESCRIPTION,,>
-- =============================================
CREATE PROCEDURE [dbo].[SP_UomMaster] @SP_STATUS varchar(200),
	@Uom_ID int = 0,
	@Uom_Code varchar(200) = NULL,
	@Uom_Name varchar(500) = NULL,
	@Uom_IsActive bit = 0,
	@Uom_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'DuplicateCount'
	BEGIN
		SELECT		COUNT(*) CountOf
		FROM		UomMaster(NOLOCK)
		WHERE		(Uom_Code = @Uom_Code
				OR Uom_Name = @Uom_Name)
				AND Uom_ID <> @Uom_ID;
	END;

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Uom_ID = ISNULL(MAX(Uom_ID), 0) + 1
			FROM		UomMaster(NOLOCK);
			INSERT INTO		[dbo].[UomMaster] 
							(Uom_ID,Uom_Code,
							Uom_Name,Uom_CreatedBy,Uom_CreatedDate,Uom_IsActive )
			VALUES			(@Uom_ID, @Uom_Code, @Uom_Name, @Uom_User, GETDATE(), @Uom_IsActive);
		END;
	ELSE

	IF @SP_STATUS = 'Update'
	 BEGIN
		DECLARE @MSG_OUT_Update nvarchar(max)
		EXEC SP_Tbl_Dependency	'UomMaster',
									@Uom_ID,
									@MSG_OUT_Update OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT_Update)) <> '')
			BEGIN
				UPDATE		[dbo].[UomMaster]
				SET			[Uom_Name] = @Uom_Name,
							[Uom_Code] = @Uom_Code,
							[Uom_UpdatedBy] = @Uom_User,
							[Uom_UpdatedDate] = GETDATE()
				WHERE		Uom_ID = @Uom_ID
				RAISERROR ('But You Can''t Change Status.', 14, 9)
			END
		ELSE
			BEGIN
				UPDATE		[dbo].[UomMaster]
				SET			[Uom_Name] = @Uom_Name,
							[Uom_Code] = @Uom_Code,
							[Uom_UpdatedBy] = @Uom_User,
							[Uom_UpdatedDate] = GETDATE(),
							[Uom_IsActive] = @Uom_IsActive
				WHERE		Uom_ID = @Uom_ID
			END
	END

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'UomMaster',@Uom_ID,@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT, 14, 9)
				END
			ELSE
				BEGIN
					DELETE 
					FROM UomMaster
					WHERE Uom_ID = @Uom_ID;
				END
		END
	ELSE

	IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT		Uom.Uom_ID,Uom.Uom_Name,Uom.Uom_Code,
						Uom.Uom_CreatedBy,Uom.Uom_CreatedDate,Uom.Uom_UpdatedBy,Uom.Uom_UpdatedDate,
						CASE
							WHEN Uom.Uom_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END AS Uom_IsActive,
						Uom.Uom_IsSysGen,Uom.Uom_IsSync,Uom.Uom_LastSyncDate,C.User_Name AS Uom_User
			FROM		UomMaster AS Uom
					LEFT JOIN dbo.UserMaster C
			ON			Uom.Uom_CreatedBy = C.User_ID;
		END;
	ELSE
	IF @SP_STATUS = 'FillCombo'
	BEGIN
	SELECT	Uom_ID,
				Uom_Code
	FROM UomMaster
	WHERE Uom_IsActive = 1;
	END;
	/*========================================Sync cPOS=====================================================*/
	IF @SP_STATUS = 'Sync_UOM_cPOS'
	BEGIN
		SELECT @Uom_ID = Uom_ID FROM UomMaster  WHERE Uom_Name=@Uom_Name
		IF (@Uom_ID = 0)
		BEGIN
			SELECT @Uom_ID = ISNULL(MAX(Uom_ID), 0) + 1 FROM UomMaster(NOLOCK);
			INSERT INTO [dbo].[UomMaster] 
			(
				Uom_ID,
				Uom_Code,
				Uom_Name,
				Uom_CreatedBy,
				Uom_CreatedDate,
				Uom_IsActive )
			VALUES
			(
				@Uom_ID, 
				@Uom_Code, 
				@Uom_Name, 
				@Uom_User, 
				GETDATE(), 
				@Uom_IsActive
			);
		END
		ELSE
		BEGIN
				UPDATE [dbo].[UomMaster]
				SET	[Uom_Name] = @Uom_Name,
						[Uom_Code] = @Uom_Code,
						[Uom_UpdatedBy] = @Uom_User,
						[Uom_UpdatedDate] = GETDATE(),
						[Uom_IsActive] = @Uom_IsActive
				WHERE Uom_ID = @Uom_ID	
		END
	END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_User]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_User] @SP_STATUS varchar(200),
	@User_EmpId int=0,
	@User_ID	int=0,
	@User_Name varchar(20)='',
	@User_Password varchar(100)='',
	@User_UserType varchar(100)='',
	@User_BranchId int=0,
	@User_IsBlocked bit=0,
	@User_IsRemotAccess bit=0,
	@User_LastLoginDt date=NULL,
	@User_IsActive bit=1,
	@User_CreatedBy int=0
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			SELECT COUNT(*) AS CountOf
			FROM UserMaster
			WHERE User_Name = @User_Name
			AND User_ID <> @User_ID;
		END;
	ELSE
	IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT @User_ID = ISNULL(MAX(User_ID), 0) + 1
			FROM UserMaster;
			INSERT INTO UserMaster (
				User_ID,
				User_EmpId,
				User_Name,
				User_Password,
				User_UserType,
				User_BranchId,
				User_IsBlocked,
				User_IsRemotAccess,
				User_CreatedBy,
				User_CreatedDt,
				User_IsActive )
			VALUES(@User_ID, @User_EmpId, @User_Name, @User_Password, @User_UserType, @User_BranchId, @User_IsBlocked,
			@User_IsRemotAccess, @User_CreatedBy, GETDATE(), @User_IsActive);
		END;
	ELSE

	IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE UserMaster
			SET	User_EmpId = @User_EmpId,
					User_Name = @User_Name,
					User_Password = @User_Password,
					User_UserType = @User_UserType,
					User_BranchId = @User_BranchId,
					User_IsBlocked = @User_IsBlocked,
					User_IsRemotAccess = @User_IsRemotAccess,
					User_UpdatedBy = @User_CreatedBy,
					User_UpdatedDt = GETDATE(),
					User_IsActive = @User_IsActive
			WHERE User_ID = @User_ID;
	END;

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
			EXEC SP_Tbl_Dependency	'UserMaster',
											@User_ID,
											@MSG_OUT OUTPUT
			IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
				BEGIN
					RAISERROR (@MSG_OUT, 14, 9)
				END
			ELSE
				BEGIN
					DELETE FROM UserMaster
					WHERE User_ID = @User_ID;
				END;
		END
	ELSE

	IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT	usr.User_ID,usr.User_EmpId,usr.User_Name,usr.User_Password,usr.User_UserType,usr.User_BranchId,usr.User_IsBlocked,usr.User_IsRemotAccess,
					usr.User_LastLoginDt,usr.User_CreatedBy,usr.User_CreatedDt,usr.User_UpdatedBy,usr.User_UpdatedDt,
					CASE
					WHEN usr.User_IsActive = 1 THEN 'Yes'
					ELSE 'No'END AS User_IsActive,usrnew.User_Name AS User_User
			FROM	UserMaster AS usr
					LEFT JOIN UserMaster AS usrnew
			ON			usr.User_CreatedBy = usrnew.User_ID
		END;
	ELSE

	IF @SP_STATUS = 'CheckLogin'
		BEGIN
			--IF NOT EXISTS(SELECT * FROM YearMaster WHERE CAST(Year_ToDate AS DATE)>=CAST(GETDATE() AS DATE) AND CAST(Year_FromDate AS DATE)<=CAST(GETDATE() AS DATE))
			iF NOT EXiSTS(SELECT * FROM YearMaster WHERE Year_FromDate='2018-04-01')
				BEGiN
					iNSERT iNTO YearMaster
					SELECT	(SELECT ISNULL(MAX(Year_Id),0)+1 FROM YearMaster),'2018-04-01','2019-04-01',1
				END	

			IF(CAST(GETDATE() AS DATE)>='2019-04-02')
				BEGiN
					iF NOT EXISTS(SELECT * FROM YearMaster WHERE CAST(Year_FromDate AS DATE) IN('2019-04-01','2019-04-02'))
						BEGiN
							UPDATE	YearMaster SET Year_IsDef=0
							iNSERT iNTO YearMaster(Year_Id,Year_FromDate,Year_ToDate,Year_IsDef)
							SELECT	(SELECT ISNULL(MAX(Year_Id),0)+1 FROM YearMaster),'2019-04-02','2020-03-31',1
						END
					ELSE
						BEGiN
							UPDATE	YearMaster SET Year_IsDef=0
							UPDATE	YearMaster SET Year_IsDef=1  FROM YearMaster WHERE CAST(Year_FromDate AS DATE) IN('2019-04-01','2019-04-02')
						END
				END 
			ELSE
				BEGiN
					UPDATE YearMaster SET Year_IsDef=0
					UPDATE YearMaster SET Year_ToDate='2019-04-01',Year_IsDef=1 WHERE Year_FromDate='2018-04-01'
				END 
			--ELSE
			--	BEGIN
			--		DECLARE @Current_FinYearId INT
			--		DECLARE @Prev_FinYearId INT
			--		IF(SELECT COUNT(1) FROM YearMaster WHERE CAST(Year_FromDate AS DATE)='2019-04-01' AND Year_IsDef=1)>0
			--			BEGIN
			--				UPDATE YearMaster SET Year_IsDef=0 
			--				SET	   @Prev_FinYearId=(SELECT TOP 1 Year_Id FROM YearMaster  WHERE CAST(Year_ToDate AS DATE)<='2019-04-01' ORDER BY Year_FromDate DESC);
			--				UPDATE YearMaster SET Year_IsDef=1,Year_ToDate=(DATEADD(day, 1, Year_ToDate)) FROM YearMaster A WHERE Year_Id=@Prev_FinYearId;
			--			END 
			--	END
			
			SELECT	*
			FROM		UserMaster AS usr
			WHERE		User_Name = @User_Name
					AND User_Password = @User_Password 
					and User_IsActive=1
		END;
	

	ELSE IF @SP_STATUS = 'GetStoreInfo'
		BEGIN
			SELECT * 
			FROM		StoreMaster
			WHERE		Store_UsActive = 1
		END;

	ELSE IF @SP_STATUS = 'GetLastLogin'
		BEGIN
			SELECT TOP 1 *,(select MAX(LastExecutionTime) from SyncConfig)  as LastSyncTime
			FROM(
				SELECT TOP 2 * 
				FROM LoginHistory 
				ORDER BY Lh_Id DESC 
				) t                     
			ORDER BY Lh_Id
		END;

	ELSE IF @SP_STATUS = 'InsertHistory'
		BEGIN
			SELECT		@User_EmpId = ISNULL(MAX(Lh_Id), 0) + 1
			FROM		LoginHistory;
			INSERT INTO		[dbo].[LoginHistory]
							([Lh_Id]
							,[Lh_UserId]
							,[Lh_UserName]
							,[Lh_Date])
			 VALUES			(@User_EmpId,
							@User_ID,
							@User_Name,
							GETDATE())
		END;

	ELSE IF @SP_STATUS='GET_CONFIG'
		BEGIN
			Select	CposApi,CposApiKey,
					(Select TOP 1 Store_Code from StoreMaster) as Store_Code,
					(Select TOP 1 Store_StateId from StoreMaster) as Store_StateId,
					(Select TOP 1 Store_GstNo from StoreMaster) as Store_GstNo,
					POSStartUpPath,
					CurrentExeId,
					CurrentDbId,
					ISNULL(CheckForUpdate,0) as CheckForUpdate,
					CurrentVersion,
					AutoSyncDays,
					(select MAX(LastExecutionTime) from SyncConfig Where IsActive=1) as LastExecutionTime,
					IsForDpos
			FROM	ConfigurationMaster (NOLOCK)		
		END;	

	ELSE IF @SP_STATUS='GET_SYNC_CONFIG'
		BEGIN
			DECLARE @DT	DATETIME=GETDATE()--'2018-06-27 22:36'
			SELECT	DATEDIFF(MINUTE, CASE WHEN LastExecutionTime IS NULL THEN DATEADD(DAY,-1,@DT) ELSE LastExecutionTime  END ,@DT),* 
			FROM	SyncConfig A
			WHERE	DATEDIFF(MINUTE, CASE WHEN LastExecutionTime IS NULL THEN DATEADD(DAY,-1,@DT) ELSE LastExecutionTime  END ,@DT)>=Sync_Min
		END

	ELSe IF @SP_STATUS='UPDATE_ExecutionTime'
		BEGIN
			Update SyncConfig
			Set LastExecutionTime=GETDATE()
			WHERE id=@User_ID
		END
END;

GO
/****** Object:  StoredProcedure [dbo].[SP_UserRights]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_UserRights] @SP_STATUS nvarchar(200) = '',
		@ID int = 0 OUT,
		@M_PARENT_ID bigint = 0,
		@UserRights_ID bigint = 0,
		@UserRights_UserId bigint = 0,
		@UserRights_MenuId bigint = 0,
		@UserRights_View bit = 0,
		@UserRights_Add bit = 0,
		@UserRights_Update bit = 0,
		@UserRights_Delete bit = 0,
		@UserRights_Print bit = 0,
		@UserRights_Export bit = 0,
		@UserRights_Year numeric(4, 0) = 0,
		@UserRights_BranchId bigint = 0,
		@UserRights_User int = 0
AS
BEGIN
	IF @SP_STATUS = 'GET_MASTER_MENU'
		BEGIN
			SELECT		Menu_ID AS UR_DeptId,Menu_Name AS UR_DeptNm
			FROM		MenuMaster(NOLOCK)
			WHERE		Menu_ParentId = Menu_ID;
		END;

	ELSE IF @SP_STATUS = 'GET_MASTER_CHILD_MENU'
		BEGIN
			SELECT		ur.UserRights_ID AS R_USR_ID,MM.Menu_ID AS URD_Page_Id,
						MM.Menu_Name AS URD_Page,ISNULL(ur.UserRights_Add, 0) AS URD_Add,ISNULL(ur.UserRights_Update, 0) AS URD_Edit,ISNULL(ur.UserRights_View, 0) AS URD_View,
						ISNULL(ur.UserRights_Delete, 0) AS URD_Delete,ISNULL(ur.UserRights_Export, 0) AS URD_Export,ISNULL(ur.UserRights_Print, 0) AS URD_Print
			FROM		MenuMaster  (nolock) MM
					LEFT JOIN UserRights  (nolock) ur
			ON			MM.Menu_ID = ur.UserRights_MenuId
					AND ur.UserRights_UserId = @UserRights_UserId
			WHERE		MM.Menu_ParentId IN (SELECT Menu_ID FROM MenuMaster  (nolock) WHERE Menu_ParentId = @M_PARENT_ID AND Menu_ID <> Menu_ParentId)
					AND MM.Menu_IsActive=1
					AND MM.Menu_Type='E'
			UNION	ALL
			SELECT		ur.UserRights_ID AS R_USR_ID,MM.Menu_ID AS URD_Page_Id,MM.Menu_Name AS URD_Page,
						ISNULL(ur.UserRights_Add, 0) AS URD_Add,ISNULL(ur.UserRights_Update, 0) AS URD_Edit,ISNULL(ur.UserRights_View, 0) AS URD_View,
						ISNULL(ur.UserRights_Delete, 0) AS URD_Delete,ISNULL(ur.UserRights_Export, 0) AS URD_Export,ISNULL(ur.UserRights_Print, 0) AS URD_Print
			FROM		MenuMaster  (nolock) MM
					LEFT JOIN UserRights  (nolock) ur
			ON			MM.Menu_ID = ur.UserRights_MenuId
					AND ur.UserRights_UserId = @UserRights_UserId
			WHERE		MM.Menu_ParentId =@M_PARENT_ID
					AND MM.Menu_IsActive=1
					AND MM.Menu_ParentId<>MM.Menu_ID
					AND MM.Menu_Type='R'
		END;

	ELSE IF @SP_STATUS = 'FILL_EMPLOYEE_COMBO'
		BEGIN
			SELECT		0 AS EMP_ID,'--Select--' AS EMPNAME
			UNION

			SELECT		User_ID AS EMP_ID,User_Name AS EMPNAME
			FROM		UserMaster;
		END;
	ELSE IF @SP_STATUS = 'INSERT_USER_RIGHT'
		BEGIN
			SELECT		@UserRights_ID = ISNULL(MAX(UserRights_ID), 0) + 1
			FROM		UserRights;
			INSERT INTO		[dbo].[UserRights] 
							(UserRights_ID,UserRights_UserId,UserRights_MenuId,UserRights_View,UserRights_Add,UserRights_Update,UserRights_Delete,UserRights_Print,
							UserRights_Export,UserRights_Year,UserRights_BranchId,UserRights_CreatedBy,UserRights_CreatedDt )
			VALUES			(@UserRights_ID, @UserRights_UserId, @UserRights_MenuId, @UserRights_View, @UserRights_Add, @UserRights_Update,
							@UserRights_Delete, @UserRights_Print, @UserRights_Export, @UserRights_Year, @UserRights_BranchId,
							@UserRights_User, GETDATE());
		END;

	ELSE IF @SP_STATUS = 'DELETE_USER_RIGHT'
		BEGIN
			
			DELETE 
			FROM		[UserRights]
			WHERE		UserRights_UserId = @UserRights_UserId
					AND UserRights_MenuId IN (	SELECT		Menu_ID 
												FROM		MenuMaster A 
												WHERE		A.Menu_ParentId=@M_PARENT_ID
												UNION
												SELECT		A.Menu_ID
												FROM		MenuMaster A
														iNNER JOIN MenuMaster B
												ON			B.Menu_ID=A.Menu_ParentId
												WHERE		B.Menu_ParentId=@M_PARENT_ID
												)
					
		END

	ELSE iF @SP_STATUS='GET_USER_PERMISSION'
		BEGiN
			;WITH CTE_MENU(M_ID,M_PARENT_ID,M_NAME,M_FORM_NAME,M_ICON,M_ORDER,M_PARENT_NAME,M_IS_OPEN_FL_MODE,M_PRIFIX,Menu_Type,R_V,R_A,R_U,R_D,R_P,R_E)
			AS
			(
				SELECT		A.Menu_ID M_ID,A.Menu_ParentId M_PARENT_ID,A.Menu_Name M_NAME,A.Menu_FormName M_FORM_NAME,A.Menu_Icon M_ICON,A.Menu_Order M_ORDER,'' AS M_PARENT_NAME,
							ISNULL(A.Menu_IsOpenFlMode,0) M_IS_OPEN_FL_MODE,ISNULL(A.Menu_Prifix,'') AS M_PRIFIX,ISNULL(A.Menu_Type,'') AS Menu_Type,
							CONVERT(BIT,0) AS V,CONVERT(BIT,0) AS A,CONVERT(BIT,0) AS U,CONVERT(BIT,0) AS D,CONVERT(BIT,0) AS P,CONVERT(BIT,0) AS E
							
				FROM		MenuMaster A
				WHERE		A.Menu_Id=A.Menu_ParentId
						AND A.Menu_IsActive = 1
				UNiON	ALL
				SELECT		A.Menu_ID M_ID,A.Menu_ParentId M_PARENT_ID,A.Menu_Name M_NAME,A.Menu_FormName M_FORM_NAME,A.Menu_Icon M_ICON,A.Menu_Order M_ORDER,'' AS M_PARENT_NAME,
							ISNULL(A.Menu_IsOpenFlMode,0) M_IS_OPEN_FL_MODE,ISNULL(A.Menu_Prifix,'') AS M_PRIFIX,
							ISNULL(A.Menu_Type,'') AS Menu_Type,
							CONVERT(BIT,0) AS V,CONVERT(BIT,0) AS A,CONVERT(BIT,0) AS U,CONVERT(BIT,0) AS D,CONVERT(BIT,0) AS P,CONVERT(BIT,0) AS E
							
				FROM		MenuMaster A
						INNER JOIN CTE_MENU B
				ON			A.Menu_ParentId=B.M_ID
				WHERE		A.Menu_IsActive = 1
						AND A.Menu_ID <> A.Menu_ParentId
			)
			SELECT	*,(SELECT count(*) FROM MenuMaster AA
					        Inner JOIN MenuMaster AAA
							ON AA.Menu_ParentId=AAA.Menu_ID
							   INNER JOIN UserRights BB 
						  ON  AA.Menu_ID=BB.UserRights_MenuID
							WHERE AAA.Menu_ParentId=A.M_ID AND  BB.UserRights_View=1 AND BB.UserRights_UserId=@UserRights_UserId) AS COUNT 
			FROM	CTE_MENU A
			WHERE	ISNULL(A.M_FORM_NAME,'') = ''
			UNION	ALL
			SELECT	A.Menu_ID AS M_ID,A.Menu_ParentId AS  M_PARENT_ID,A.Menu_Name M_NAME,A.Menu_FormName M_FORM_NAME,A.Menu_Icon M_ICON,A.Menu_Order M_ORDER,'' AS M_PARENT_NAME,
					ISNULL(A.Menu_IsOpenFlMode,0) AS M_IS_OPEN_FL_MODE,ISNULL(A.Menu_Prifix,'') AS M_PRIFIX,ISNULL(A.Menu_Type,'') AS Menu_Type,
					CONVERT(BIT,B.UserRights_View) AS V,CONVERT(BIT,UserRights_Add) AS A,CONVERT(BIT,UserRights_Update) AS U,CONVERT(BIT,UserRights_Delete) AS D,
					CONVERT(BIT,UserRights_Print) AS P,CONVERT(BIT,UserRights_Export) AS E,
					0 AS COUNT
			FROM	MenuMaster A
					INNER JOIN UserRights B
			ON			A.Menu_ID=B.UserRights_MenuID
					AND	B.UserRights_UserId=@UserRights_UserId
					AND	ISNULL(B.UserRights_View,0)=1
			WHERE		A.Menu_IsActive=1
					AND	ISNULL(A.Menu_FormName,'')<>''
			order by A.M_ORDER
		END
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_VendorAddMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_VendorAddMaster]
		 (@SP_STATUS varchar(200)='',
		@VendAdd_Id NUMERIC(18,0) =0,
		@VendAdd_VendorId NUMERIC(18,0) =0,
		@VendAdd_Addr1 nvarchar(199) ='',
		@VendAdd_Add2 nvarchar(199) ='',
		@VendAdd_Add3 nvarchar(199) ='',
		@VendAdd_CityId bigint = 0,
		@VendAdd_AreaId bigint = 0,
		@VendAdd_PhNo nvarchar(50) = '',
		@VendAdd_PhNo1 nvarchar(50) = '',
		@VendAdd_MobNo nvarchar(50) ='',
		@VendAdd_FaxNo nvarchar(50) ='',
		@VendAdd_Email nvarchar(199) ='',
		@VendAdd_Web nvarchar(199) ='',
		@VendAdd_CstNo nvarchar(50)='',
		@VendAdd_CstDt datetime=null,
		@VendAdd_GstNo nvarchar(50)='',
		@VendAdd_GstDt datetime=null,
		@VendAdd_RegNo nvarchar(50)='',
		@VendAdd_RegDt datetime=null,
		@VendAdd_DrugLic1 nvarchar(50)='',
		@VendAdd_DrugLic2 nvarchar(50)='',
		@VendAdd_DrugLic3 nvarchar(50)='',
		@VendAdd_IsActive bit=0,
		@VendAdd_User int=0,
		--====================
		@VendAdd_StateId int=0,
		@VendAdd_CountryId int=0)
AS
BEGIN
	IF @SP_STATUS = 'FillComboCountry'
		BEGIN
			SELECT	0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		Country_Id AS ID,Country_Name AS NAME
			FROM		CountryMaster  (nolock) 
			WHERE		ISNULL(Country_IsActive, 0) = 1;
		END;
	ELSE

	IF @SP_STATUS = 'FillComboState'
		BEGIN
			SELECT		0 AS ID,
						'--Select--' AS NAME
			UNION
			SELECT		State_ID AS ID,
						State_Name AS NAME
			FROM		StateMaster  (nolock) 
			WHERE		State_CountryId = @VendAdd_CountryId;
		END;
	ELSE
	IF @SP_STATUS = 'FillComboCity'
		BEGIN
			SELECT	0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		City_ID AS ID,City_Name AS NAME
			FROM		CityMaster  (nolock) 
			WHERE		City_StateId = @VendAdd_StateId;
		END;
	ELSE
	IF @SP_STATUS = 'FillComboArea'
		BEGIN
			SELECT		0 AS ID,
						'--Select--' AS NAME
			UNION
			SELECT		Area_ID AS ID,
						Area_Name AS NAME
			FROM		AreaMaster  (nolock) 
			WHERE		Area_ContryId = @VendAdd_CountryId
					AND Area_StateId = @VendAdd_StateId
					AND Area_CityId = @VendAdd_CityId;
		END;
	--======================BIND VENDER=========================
	ELSE
	IF @SP_STATUS = 'FillComboVendor'
		BEGIN
			SELECT		0 AS ID,'--Select--' AS NAME
			UNION
			SELECT		Vendor_ID AS ID,
						Vendor_Name AS NAME
			FROM		VendorMaster  (nolock) ;
		END;

	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		VendorAddMaster  (nolock) 
			WHERE		VendAdd_VendorId = @VendAdd_VendorId
					AND VendAdd_Id <> @VendAdd_Id;
		END;

	ELSE IF @SP_STATUS = 'ValidateMobile'
		BEGIN
			SELECT		COUNT(*) ASCountOf
			FROM		VendorAddMaster  (nolock) 
			WHERE		VendAdd_MobNo = @VendAdd_MobNo
					AND VendAdd_Id <> @VendAdd_Id;
		END;

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@VendAdd_Id = ISNULL(MAX(VendAdd_Id), 0) + 1
			FROM		VendorAddMaster  (nolock) ;
			INSERT		VendorAddMaster 
						(	VendAdd_Id,VendAdd_VendorId,VendAdd_Addr1,VendAdd_Add2,VendAdd_Add3,
						VendAdd_CityId,VendAdd_AreaId,VendAdd_PhNo,VendAdd_PhNo1,VendAdd_MobNo,
						VendAdd_FaxNo,VendAdd_Email,VendAdd_Web,VendAdd_CstNo,VendAdd_CstDt,
						VendAdd_GstNo,VendAdd_GstDt,VendAdd_RegNo,VendAdd_RegDt,VendAdd_CreatedBy,
						VendAdd_DrugLic1,VendAdd_DrugLic2,VendAdd_DrugLic3,VendAdd_CreatedDt,VendAdd_IsActive )
			VALUES		(	@VendAdd_Id, @VendAdd_VendorId, @VendAdd_Addr1, @VendAdd_Add2, @VendAdd_Add3, 
						@VendAdd_CityId,@VendAdd_AreaId, @VendAdd_PhNo, @VendAdd_PhNo1, @VendAdd_MobNo, 
						@VendAdd_FaxNo, @VendAdd_Email, @VendAdd_Web,@VendAdd_CstNo, @VendAdd_CstDt, 
						@VendAdd_GstNo, @VendAdd_GstDt, @VendAdd_RegNo, @VendAdd_RegDt, @VendAdd_User, 
						@VendAdd_DrugLic1, @VendAdd_DrugLic2, @VendAdd_DrugLic3,GETDATE(), @VendAdd_IsActive);
		END;

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		VendorAddMaster
			SET			VendAdd_VendorId = @VendAdd_VendorId,
						VendAdd_Addr1 = @VendAdd_Addr1,
						VendAdd_Add2 = @VendAdd_Add2,
						VendAdd_Add3 = @VendAdd_Add3,
						VendAdd_CityId = @VendAdd_CityId,
						VendAdd_AreaId = @VendAdd_AreaId,
						VendAdd_PhNo = @VendAdd_PhNo,
						VendAdd_PhNo1 = @VendAdd_PhNo1,
						VendAdd_MobNo = @VendAdd_MobNo,
						VendAdd_FaxNo = @VendAdd_FaxNo,
						VendAdd_Email = @VendAdd_Email,
						VendAdd_Web = @VendAdd_Web,
						VendAdd_CstNo = @VendAdd_CstNo,
						VendAdd_CstDt = @VendAdd_CstDt,
						VendAdd_GstNo = @VendAdd_GstNo,
						VendAdd_GstDt = @VendAdd_GstDt,
						VendAdd_RegNo = @VendAdd_RegNo,
						VendAdd_RegDt = @VendAdd_RegDt,
						VendAdd_DrugLic1 = @VendAdd_DrugLic1,
						VendAdd_DrugLic2 = @VendAdd_DrugLic2,
						VendAdd_DrugLic3 = @VendAdd_DrugLic3,
						VendAdd_UpdatedBy = @VendAdd_User,
						VendAdd_UpdatedDt = GETDATE(),
						VendAdd_IsActive = @VendAdd_IsActive
			WHERE		VendAdd_Id = @VendAdd_Id;
		END;

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
		DECLARE @MSG_OUT nvarchar(max)
		EXEC SP_Tbl_Dependency	'VendorAddMaster',
										@VendAdd_Id,
										@MSG_OUT OUTPUT
		IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
			BEGIN
				RAISERROR (@MSG_OUT, 14, 9)
			END
		ELSE
			BEGIN
				DELETE		FROM VendorAddMaster
				WHERE		VendAdd_Id = @VendAdd_Id;
			END;
		END
	ELSE IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT		VendAdd.VendAdd_Id,VendAdd.VendAdd_VendorId,
						VendAdd.VendAdd_Addr1,VendAdd.VendAdd_Add2,VendAdd.VendAdd_Add3,VendAdd.VendAdd_CityId,VendAdd.VendAdd_AreaId,
						VendAdd.VendAdd_PhNo,VendAdd.VendAdd_PhNo1,VendAdd.VendAdd_MobNo,VendAdd.VendAdd_FaxNo,VendAdd.VendAdd_Email,
						VendAdd.VendAdd_Web,VendAdd.VendAdd_CstNo,VendAdd.VendAdd_CstDt,VendAdd.VendAdd_GstNo,VendAdd.VendAdd_GstDt,
						VendAdd.VendAdd_RegNo,VendAdd.VendAdd_RegDt,VendAdd_DrugLic1,VendAdd_DrugLic2,VendAdd_DrugLic3,
						VendAdd.VendAdd_CreatedBy,VendAdd.VendAdd_CreatedDt,VendAdd.VendAdd_UpdatedBy,VendAdd.VendAdd_UpdatedDt,
						CASE
							WHEN VendAdd.VendAdd_IsActive = 1 THEN 'Yes'
							ELSE 'No'
						END AS VendAdd_IsActive,
						(VendAdd.VendAdd_Addr1 + ' ' + VendAdd.VendAdd_Add2 + ' ' + VendAdd.VendAdd_Add3) AS VAAD_ADDRESS,
						ven.Vendor_Name,City.City_Name AS Vendor_City,Area.Area_Name AS Vender_Area,
						Area.Area_ContryId AS Country_Id,Area.Area_StateId AS State_Id,coun.Country_Name AS Country,[state].State_Name AS [State],UM.[User_Name]
			FROM		VendorAddMaster (nolock)  AS VendAdd
					LEFT JOIN VendorMaster (nolock)  AS ven
			ON			VendAdd.VendAdd_VendorId = ven.Vendor_ID
					LEFT JOIN CityMaster  (nolock) AS City
			ON			VendAdd.VendAdd_CityId = City.City_ID
					LEFT JOIN AreaMaster  (nolock) AS Area
			ON			VendAdd.VendAdd_AreaId = Area.Area_ID
					LEFT JOIN CountryMaster  (nolock) AS coun
			ON			coun.Country_Id = Area.Area_ContryId
					LEFT JOIN StateMaster  (nolock) AS [state]
			ON			[state].State_ID = Area.Area_StateId
					LEFT JOIN UserMaster (nolock)  AS UM
			ON			UM.[User_ID] = VendAdd.VendAdd_CreatedBy
			WHERE		VendAdd.VendAdd_VendorId =
														CASE
														WHEN ISNULL(@VendAdd_VendorId, 0) = 0 THEN ISNULL(VendAdd.VendAdd_VendorId, 0)
														ELSE @VendAdd_VendorId
														END;
		END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_VendorMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:    Jagruti Prajapati
-- Create date: 22/12/2017 12:06 pm
-- Description:	New
-- =============================================
CREATE PROCEDURE [dbo].[SP_VendorMaster] @SP_STATUS varchar(200) = NULL,
		@Vendor_ID NUMERIC(18,0) = 0,
		@Vendor_Code nvarchar(30) = NULL,
		@Vendor_Name nvarchar(250) = NULL,
		@Vendor_CreditDays int = 0,
		@Vendor_CreditLimit numeric(18,2) = 0,
		@Vendor_User int = 0,
		@Vendor_ISActive bit = 0,
		@Vendor_Vt_Id int=0,
		@ID NUMERIC(18,0) = 0 OUT
AS
BEGIN
	IF @SP_STATUS = 'DublicateCount'
		BEGIN
			SELECT		COUNT(*) AS CountOf
			FROM		vendormaster
			WHERE		(vendor_name = @Vendor_Name
					OR vendor_code = @Vendor_Code)
					AND vendor_id <> @Vendor_ID;
		END;

	ELSE IF @SP_STATUS = 'Insert'
		BEGIN
			SELECT		@Vendor_ID = ISNULL(MAX(vendor_id),0) + 1
			FROM		vendormaster(nolock);
			INSERT INTO		vendormaster
							(vendor_id,vendor_name,vendor_code,vendor_creditdays,vendor_createdby,vendor_createddt,vendor_creditlimit,Vendor_Vt_Id) 
			VALUES			(@Vendor_ID,@Vendor_Name,@Vendor_Code,@Vendor_CreditDays,@Vendor_User,GETDATE(),@Vendor_CreditLimit,@Vendor_Vt_Id);
			SELECT @ID = @Vendor_ID;
		END;

	ELSE IF @SP_STATUS = 'Update'
		BEGIN
			UPDATE		vendormaster
			SET			vendor_name = @Vendor_Name,
						vendor_code = @Vendor_Code,
						vendor_creditdays = @Vendor_CreditDays,
						vendor_updatedby = @Vendor_User,
						vendor_updateddt = GETDATE(),
						vendor_isactive = @Vendor_ISActive,
						vendor_creditlimit = @Vendor_CreditLimit,
						Vendor_Vt_Id=@Vendor_Vt_Id
			WHERE		vendor_id = @Vendor_ID;
			SELECT		@ID = @Vendor_ID;
		END;

	ELSE IF @SP_STATUS = 'Delete'
		BEGIN
			DECLARE @MSG_OUT nvarchar(max)
				EXEC Sp_tbl_dependency	'VendorMaster',@Vendor_ID,@MSG_OUT OUTPUT
				IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
					BEGIN
						RAISERROR (@MSG_OUT,14,9)
					END
				ELSE 
					BEGIN
						DELETE 
						FROM		ledgermaster
						WHERE		lm_id = (SELECT		vendor_ledger_id
											FROM		vendormaster
											WHERE		vendor_id = @Vendor_ID)
						DELETE		FROM vendormaster
						WHERE		vendor_id = @Vendor_ID;
					END;
		END
	ELSE IF @SP_STATUS = 'Fillgrid'
		BEGIN
			SELECT	A.vendor_id,A.vendor_name,A.vendor_code,A.vendor_creditdays,A.vendor_creditlimit,B.user_name AS Vendor_User,
					A.vendor_createddt,A.vendor_createdby,
					CASE WHEN A.vendor_isactive = 1 THEN 'Yes' ELSE 'No' END AS Vendor_IsActive,A.vendor_ledger_id,A.Vendor_Vt_Id,C.Vt_Name
			FROM vendormaster(nolock) AS A
			LEFT JOIN dbo.usermaster B
			ON A.vendor_createdby = B.user_id
			LEFT JOIN VendorTypeMaster as C
			ON A.Vendor_Vt_Id=C.Vt_Id
		END;
	ELSE IF @SP_STATUS ='Fill_VendorType_Combo'
	BEGIN
		SELECT Vt_Id as ID,Vt_Name as NAME
		FROM VendorTypeMaster
	END
	--====================Sync from cPOS==================================
	ELSE IF @SP_STATUS = 'Insert_cPOS'
		BEGIN
			if not exists(select * from vendormaster where vendor_code=@Vendor_Code)
			begin
				SELECT		@Vendor_ID = ISNULL(MAX(vendor_id),0) + 1
				FROM		vendormaster(nolock);
				INSERT INTO		vendormaster
				(vendor_id,vendor_name,vendor_code,vendor_createdby,vendor_createddt,Vendor_Vt_Id) 
				VALUES			
				(@Vendor_ID,@Vendor_Name,@Vendor_Code,@Vendor_User,GETDATE(),@Vendor_Vt_Id);
				SELECT @ID = @Vendor_ID;
			end
			else
			begin
				SELECT 0
			end
			SELECT @ID = @Vendor_ID;
		END;
END;
GO
/****** Object:  StoredProcedure [dbo].[SP_VoucherMaster]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_VoucherMaster] @Result nvarchar(100),
@Vm_Id int = NULL,
@Vm_VoucherNo nvarchar(100) = NULL,
@Vm_VoucherDate datetime = NULL,
@Vm_VoucherTypeId int = NULL,
@Vm_Description nvarchar(max) = NULL
AS
BEGIN
	IF @Result = 'Insert'--INSERT
	BEGIN
	INSERT INTO VoucherMaster (
		Vm_VoucherNo,
		Vm_VoucherDate,
		Vm_VoucherTypeId,
		Vm_Description )
	VALUES(@Vm_VoucherNo, @Vm_VoucherDate, @Vm_VoucherTypeId, @Vm_Description);
	END
	ELSE
	IF @Result = 'Update'--UPDATE
	BEGIN
	UPDATE VoucherMaster
	SET	Vm_VoucherNo = @Vm_VoucherNo,
			Vm_VoucherDate = @Vm_VoucherDate,
			Vm_VoucherTypeId = @Vm_VoucherTypeId,
			Vm_Description = @Vm_Description
	WHERE Vm_Id = @Vm_Id;
	END
	ELSE
	IF @Result = 'Delete'--DELETE
	BEGIN
	DECLARE @MSG_OUT nvarchar(max)
	EXEC SP_Tbl_Dependency	'VoucherMaster',
									@Vm_Id,
									@MSG_OUT OUTPUT
	IF (RTRIM(LTRIM(@MSG_OUT)) <> '')
		BEGIN
		RAISERROR (@MSG_OUT, 14, 9)
		END
	ELSE
		BEGIN
		DELETE FROM VoucherMaster
		WHERE Vm_Id = @Vm_Id
		END
	END
	ELSE
	IF @Result = 'Fillgrid'--FILLGRID
	BEGIN
	SELECT	v.*,
				vt.Vtm_Name AS VoucherTypeName
	FROM VoucherMaster (nolock) v
	LEFT JOIN VoucherTypeMaster  (nolock) vt
		ON v.Vm_VoucherTypeId = vt.Vtm_Id
	ORDER BY Vm_VoucherDate DESC;
	END
	ELSE
	IF @Result = 'FillVourcherType'--FILLVOURCHERTYPE
	BEGIN
	SELECT	0 AS Vm_Id,
				'--Select--' AS Name
	UNION
	SELECT	Vtm_Id,
				Vtm_Name
	FROM VoucherTypeMaster  (nolock) ;
	END
	ELSE
	IF @Result = 'Retrive'--GET
	BEGIN
	SELECT *
	FROM VoucherMaster  (nolock) 
	WHERE Vm_Id = @Vm_Id;
	END
	ELSE
	IF @Result = 'NextVoucherNo'--NEXTVOUCHERNO
	BEGIN
	SELECT CAST(Vtm_LastNo AS int) + 1
	FROM VoucherTypeMaster (nolock) 
	WHERE Vtm_Id = 9;
	END
END
GO
/****** Object:  UserDefinedFunction [dbo].[DateList]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[DateList]
    (
     @StartDate DATETIME ,
     @EndDate DATETIME
    )
RETURNS @DateList TABLE ([Date] DATETIME)
    BEGIN
        DECLARE @CurrentDate DATETIME
        SET @CurrentDate = @StartDate
        WHILE @CurrentDate <= @EndDate 
            BEGIN
                INSERT  INTO @DateList
                        ([Date])
                VALUES
                        (@CurrentDate  -- Date - datetime
                         )
                SET @CurrentDate = DATEADD(d, 1, @CurrentDate)
            END
        RETURN
    END
GO
/****** Object:  UserDefinedFunction [dbo].[FUNC_GET_FINC_YEAR]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[FUNC_GET_FINC_YEAR]
(
	@No numeric(18,0) = 0
)
RETURNS nvarchar(MAX)
AS
BEGIN
	DECLARE @FromYear AS NVARCHAR(MAX) = ''
	DECLARE @ToYear AS NVARCHAR(MAX) = ''
	DECLARE @DefaultNoGap nvarchar(10) = ''

	SELECT TOP 1 @FromYear=YEAR(Year_FromDate), @ToYear=Right(YEAR(Year_ToDate),2) FROM YearMaster (NOLOCK) WHERE Year_IsDef = 1

	SELECT		@DefaultNoGap = [DefaultNoGap]
	FROM		[dbo].ConfigurationMaster (NOLOCK)

	
	DECLARE		@tempCode AS NVARCHAR(MAX) =  
					case 
							--when ISNULL(MAX(@No),0) = 0 then @FromYear + @ToYear + @DefaultNoGap + CONVERT(VARCHAR(MAX),1)
							when ISNULL(CAST(MAX(@No) AS BIGINT),0) = 0 then @FromYear + @ToYear + @DefaultNoGap + CONVERT(VARCHAR(MAX),1)
					else 
							@FromYear + @ToYear + 
							CASE WHEN LEN(CONVERT(NVARCHAR(MAX), MAX(REPLACE(CAST(@No AS nvarchar(MAX)),@FromYear + @ToYear,'')) + 1,LEN(@DefaultNoGap) + 1)) < LEN(@DefaultNoGap) + 1
							THEN RIGHT(@DefaultNoGap + CONVERT(NVARCHAR(MAX), MAX(REPLACE(CAST(@No AS nvarchar(MAX)),@FromYear + @ToYear,'')) + 1,LEN(@DefaultNoGap) + 1),LEN(@DefaultNoGap) + 1)
							ELSE CONVERT(NVARCHAR(MAX), MAX(REPLACE(CAST(@No AS nvarchar(MAX)),@FromYear + @ToYear,'')) + 1,LEN(@DefaultNoGap) + 1)
							END
						end 
	
	RETURN		@tempCode
END
GO
/****** Object:  UserDefinedFunction [dbo].[Func_Tbl_Dependency]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
create FUNCTION [dbo].[Func_Tbl_Dependency]
(
	@Table nvarchar(50) = '',
	@Col nvarchar(50) = '',
	@Val Bigint = 0
)
RETURNS nvarchar(MAX)
AS
BEGIN
	DECLARE @RowsToProcess  int
	DECLARE @CurrentRow     int

	DECLARE @TempTbl TABLE ([SrNo] int identity(1,1) primary Key,
	[Id] [bigint] ,
	[No] [nvarchar](50) NULL,
	[Table] [nvarchar](50) NULL,
	[Col] [nvarchar](50) NULL,
	[DTable] [nvarchar](50) NULL,
	[Dcol] [nvarchar](50) NULL,
	[Active] [bit] NULL,
	[Msg] [nvarchar](250) NULL)
	
	DECLARE @ErrMsg nvarchar(250) = ''
	
	INSERT INTO @TempTbl
	SELECT * FROM [dbo].tblDependency (NOLOCK) WHERE [Table] = @Table
	SET @RowsToProcess = @@ROWCOUNT
	
	SET @CurrentRow=0
	WHILE @CurrentRow < @RowsToProcess
	BEGIN
	    SET @CurrentRow = @CurrentRow + 1
		
		DECLARE @DTbl nvarchar(50) = ''
		DECLARE @DColumn nvarchar(50) = ''
		DECLARE @Msg nvarchar(250)
	
	    SELECT @DTbl = DTable, @DColumn = Dcol, @Msg = Msg FROM  @TempTbl WHERE SrNo = @CurrentRow 
		DECLARE @dynasql nvarchar(MAX) = 'SELECT ' + @DColumn + ' FROM ' + @DTbl + ' WHERE ' + @DColumn + ' = ' + cast(@Val as nvarchar(MAX))
		--exec sp_executesql N'SELECT * FROM #MyTable WHERE Name LIKE ''%''+@Name+''%''', N'@Name nvarchar(200)',@Name=N'100024'
		EXEC sp_executesql @dynasql
		IF @@ROWCOUNT > 0
		BEGIN
			SET @ErrMsg = @Msg
		END
	END
	RETURN @ErrMsg
END

GO
/****** Object:  UserDefinedFunction [dbo].[funcGetTaxSum]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[funcGetTaxSum]
(
	@Tr_DocKey Bigint = 0,
	@Tr_TxId int = 0,
	@Tr_DocType int = 0
)
RETURNS NUMERIC(18,2)
AS
BEGIN
	DECLARE @TaxTotal AS NUMERIC(18,2) = 0
	
	SELECT @TaxTotal = SUM(Tr_TxTot) FROM TaxTransaction WHERE Tr_DocKey = @Tr_DocKey AND Tr_TxId = @Tr_TxId AND Tr_DocTyp = @Tr_DocType
	
	RETURN @TaxTotal
END

GO
/****** Object:  UserDefinedFunction [dbo].[funcGetTaxValue]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[funcGetTaxValue]
(
	@Tr_DocKey Bigint = 0,
	@Tr_TxId int = 0,
	@Tr_DocType int = 0
)
RETURNS NVARCHAR(MAX)
AS
	BEGIN
		DECLARE @VALUE AS NVARCHAR(MAX) = ''

		SELECT @VALUE = STUFF((SELECT ', ' + CAST(ISNULL(SUM(Tr_TxTot),0) AS NVARCHAR(MAX)) + ' ( ' + CAST(Tr_TxVal AS NVARCHAR(MAX)) + ' ) ' FROM TaxTransaction (NOLOCk) t2
		WHERE t1.Tr_DocTyp = t2.Tr_DocTyp AND t1.Tr_DocKey = t2.Tr_DocKey AND t1.Tr_TxId = t2.tr_TxId
		GROUP BY t2.Tr_TxVal
		FOR XML PATH ('')), 1, 1, '') FROM TaxTransaction (NOLOCK) t1 WHERE T1.Tr_DocKey = @Tr_DocKey
		AND t1.Tr_TxId = @Tr_TxId AND t1.Tr_DocTyp = @Tr_DocType GROUP BY t1.Tr_DocTyp,T1.Tr_DocKey,t1.Tr_TxId
	
		RETURN @VALUE
END

GO
/****** Object:  UserDefinedFunction [dbo].[funcItemWiseTax]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
--  [dbo].funcItemWiseTax (3,2,2,3)
CREATE FUNCTION [dbo].[funcItemWiseTax]
(
	@Tr_DocKey Bigint = 0,
	@Tr_TxId int = 0,
	@Tr_DocType int = 0,
	@Tr_DDocKey Bigint = 0
)
RETURNS NVARCHAR(MAX)
AS
BEGIN
	DECLARE @Value AS NVARCHAR(MAX) = ''

	--SELECT @VALUE = STUFF((SELECT ', ' + CAST(ISNULL(SUM(Tr_TxTot),0) AS NVARCHAR(MAX)) + ' ( ' + CAST(Tr_TxVal AS NVARCHAR(MAX)) + ' ) ' FROM TaxTransaction (NOLOCk) t2
	--WHERE t1.Tr_DocTyp = t2.Tr_DocTyp AND t1.Tr_DocKey = t2.Tr_DocKey AND t1.Tr_TxId = t2.tr_TxId AND t1.Tr_DDocKey = t2.Tr_DDocKey
	--GROUP BY t2.Tr_TxVal
	--FOR XML PATH ('')), 1, 1, '') FROM TaxTransaction (NOLOCK) t1 WHERE T1.Tr_DocKey = @Tr_DocKey
	--AND t1.Tr_TxId = @Tr_TxId AND t1.Tr_DocTyp = @Tr_DocType AND t1.Tr_DDocKey = @Tr_DDocKey GROUP BY t1.Tr_DocTyp,T1.Tr_DocKey,t1.Tr_TxId,t1.Tr_DDocKey

	SELECT @Value = Tr_TxTot FROM TaxTransaction (NOLOCK) WHERE Tr_DocTyp = @Tr_DocType AND Tr_DocKey = @Tr_DocKey AND Tr_DdocKey = @Tr_DDocKey AND Tr_TxId = @Tr_TxId

	RETURN @Value
END

GO
/****** Object:  UserDefinedFunction [dbo].[STRING_SPLIT]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create FUNCTION [dbo].[STRING_SPLIT]
(
    @String  VARCHAR(MAX), @Separator CHAR(1)
)
RETURNS @RESULT TABLE(Value VARCHAR(MAX))
AS
BEGIN     
	DECLARE @SeparatorPosition INT = CHARINDEX(@Separator, @String ),@Value VARCHAR(MAX), @StartPosition INT = 1
 
	IF @SeparatorPosition = 0  
	BEGIN
		INSERT INTO @RESULT VALUES(@String)
		RETURN
	END
     
	SET @String = @String + @Separator
	WHILE @SeparatorPosition > 0
		BEGIN
			SET @Value = SUBSTRING(@String , @StartPosition, @SeparatorPosition- @StartPosition)
 
			IF( @Value <> ''  ) 
				INSERT INTO @RESULT VALUES(@Value)
   
			SET @StartPosition = @SeparatorPosition + 1
			SET @SeparatorPosition = CHARINDEX(@Separator, @String , @StartPosition)
		END
	RETURN
END

GO
/****** Object:  UserDefinedFunction [dbo].[ToWordsWithPaisa]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- SELECT [dbo].[ToWordsWithPaisa](6223,'')
CREATE FUNCTION [dbo].[ToWordsWithPaisa]
	(	@Amt	Numeric(18,2),@Prifix	VARCHAR(10))
		RETURNS VARCHAR(1500) 
	AS 
BEGIN
		
			DECLARE @PAISA	NUMERIC(4)
		
			IF @Prifix='' 
				BEGIN
					SET @Prifix=' '
				END
			ELSE IF @Prifix='Paisa'
				BEGIN
					SET @Prifix='Paisa '
				END
			SET @PAISA=SUBSTRING(CONVERT(NVARCHAR(15),@AMT),CHARINDEX('.',@AMT)+1,LEN(@AMT))	
			
            if @amt < 0
				BEGIN
					set @amt = @amt * -1
				END
			DECLARE @Table_Of_Words Table (rows int,word VARCHAR(1200))
			DECLARE @PAmt Numeric(18,2)
            DECLARE @VcPaise varchar(10),@Words varchar(1500),@Rupee decimal(16,2),@Paise decimal(16,2),			
            @Rdc bigint,@Rd1 bigint,@Rd2 bigint,@Rd3 bigint,
			@Rd4 bigint,@Rd5 bigint,@Rd6 bigint,@Rd7 bigint,@P_No Decimal(16,2)

			SELECT @Rupee=0,
					@Paise=0,
					@Rdc=0,
					@Rd1=0,
					@Rd2=0,
					@Rd3=0,
					@Rd4=0,
					@Rd5=0,
					@Rd6=0,
					@Rd7=0,
					@P_No=0

			SET @PAmt=@Amt
			SET @Words=' '
			SET @VcPaise=' '
            
			INSERT INTO @Table_Of_Words  
			SELECT 0,'One ' UNION ALL SELECT 1,'Two ' 
            UNION ALL SELECT 2,'Three '            
            UNION ALL SELECT 3,'Four ' 
            UNION ALL SELECT 4,'Five '
            UNION ALL SELECT 5,'Six ' 
            UNION ALL SELECT 6,'Seven '
            UNION ALL SELECT 7,'Eight ' 
            UNION ALL SELECT 8,'Nine '
            UNION ALL SELECT 9,'Ten ' 
            UNION ALL SELECT 10,'Eleven '
            UNION ALL SELECT 11,'Twelve ' 
            UNION ALL SELECT 12,'Thirteen '
            UNION ALL SELECT 13,'Fourteen ' 
            UNION ALL SELECT 14,'Fifteen '
            UNION ALL SELECT 15,'Sixteen ' 
            UNION ALL SELECT 16,'Seventeen '
            UNION ALL SELECT 17,'Eightteen ' 
            UNION ALL SELECT 18,'Nineteen '
            UNION ALL SELECT 19,'Twenty ' 
            UNION ALL SELECT 20,'Thirty '
            UNION ALL SELECT 21,'Fourty ' 
            UNION ALL SELECT 22,'Fifty ' 
			UNION ALL SELECT 23,'Sixty ' 
			UNION ALL SELECT 24,'Seventy '  
			UNION ALL SELECT 25,'Eighty '  
			UNION ALL SELECT 26,'Ninety '
            
		IF (@Pamt <= 0)
           Set @Words='Zero '
		ELSE
			BEGIN
				Set @Rupee=((@Pamt*100)/100)
				
				Set @Paise=((@Pamt*100)%100)			
				--SET @PAISA=0
	            
				Set @P_No=@Rupee
				Set @Rdc=(@P_No/10000000)
				Set @P_No=(@P_No%10000000)
				Set @Rd1=(@P_No/1000000)
				Set @P_No = (@P_No%1000000)

				Set @Rd2 =(@P_No/100000)
				Set @P_No = (@P_No % 100000)

				Set @Rd3 = (@P_No/10000)
				Set @P_No = (@P_No % 10000)

				Set @Rd4=(@P_No/1000)
				Set @P_No=(@P_No%1000)

				Set @Rd5 = (@P_No/100)
				Set @P_No = (@P_No%100)

				Set @Rd6 = (@P_No/10)
				Set @Rd7 = (@P_No % 10)
			
            IF (@Rdc > 9999999)
				BEGIN
					SET @Words = 'Error -> Number Over Flowed Occured'
					return (RTRIM(LTRIM(@Words)))
				END
            ELSE IF (@Rdc > 0)
				BEGIN
					Select @Words = dbo.ToWordsWithPaisa(@Rdc,'')
					Select @Words=Substring(@Words,1,Len(@Words)-5)+ 'Crore '
				END
		    IF	(@Rd1>=2)
                SELECT @Words = @Words + Word FROM @Table_Of_Words
				WHERE ROWS=@Rd1+17           
            IF	(@Rd1 =1)          
                SELECT @Words = @Words + Word FROM @Table_Of_Words
				Where rows=@Rd2+9
	        else if (@Rd2 > 0)
            
				Select @Words = @Words + Word +' ' From @Table_Of_Words
				Where rows=@Rd2-1
			
            if (@Rd1 > 0 or @Rd2 > 0)
				Begin
					if (@Rd1 > 1 or @Rd2 > 1)
					   Set @Words = @Words + 'Lakhs ';                
					else                
						Set @Words =@Words + 'Lakh ';                
				End
            if (@Rd3 >= 2)
				--Select @Words = @Words + Word + ' ' From @Table_Of_Words Where rows=@Rd3+17
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd3+17
            if (@Rd3 = 1)
   				--Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd4+9
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd4+9
            Else if (@Rd4 > 0)
                --Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd4-1		
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd4-1				
            if (@Rd3 > 0 or @Rd4 > 0)            
                Set @Words = @Words + 'Thousand '            
            if (@Rd5 > 0)
				Begin
					--Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd5-1              
					Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd5-1                
					Set @Words = @Words + 'Hundred '
				End
            if (@Rd6 >= 2)            
                --Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd6+17         		
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd6+17         		
            if (@Rd6 = 1)            
				--Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd7+9                       
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd7+9                     
            else if (@Rd7 > 0)            
                --Select @Words = @Words + Word +' ' From @Table_Of_Words Where rows=@Rd7-1 
				Select @Words = @Words + Word From @Table_Of_Words Where rows=@Rd7-1 
		End
		
		DECLARE @NEW_WORDS	VARCHAR(1500)
			
			IF @PAISA>0
				BEGIN
					SET @NEW_WORDS=@Words+' And '+dbo.ToWordsWithPaisa(@PAISA,'Paisa')
				END
			ELSE 
				BEGIN
					--SET @NEW_WORDS=@Words+@Prifix +' Only'
					SET @NEW_WORDS = RTRIM(LTRIM(@Words)) + @Prifix +'Only'
				END
		
            --Set @Words = @Words+@Prifix + ' ONLY'
        return (@NEW_WORDS)
End


GO
/****** Object:  View [dbo].[vwMedicineTaxPrc]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwMedicineTaxPrc]
AS
SELECT	Mtm_MmId,
		SUM(Mtm_TaxValue) AS Tax_Prc 
FROM	MedicineWiseTaxMaster 
WHERE	Mtm_TaxId=4
GROUP BY Mtm_MmId
GO
/****** Object:  View [dbo].[vwStockDistributer]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwStockDistributer]
AS
SELECT  Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, SUM(Item_Stock) AS Item_Stock, CONVERT(varchar(100), SUM(Sales_Qty)) + '(' + Item_Uom + ')' AS Sales_Qty, 
		CONVERT(varchar(100), SUM(Purchase_Qty)) + '(' + Purchase_Item_Uom + ')' AS Purchase_Qty, SUM(Purchase_Item_Stock) AS Purchase_Item_Stock, 
        Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, 
        MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name
FROM	(SELECT CAST(0 AS bit) AS Chk, stock.Stk_MmId AS Item_Id, mm.Mm_Code AS Item_Code, mm.Mm_Name AS Item_Name, stock.Stk_BatchNo AS Item_Batchno, 
			SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) - SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Item_Stock, 
			SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) - SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty, 
			SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) - SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Qty, 
			SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) - SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Item_Stock, 
			0.00 AS Purchase_Item_Rate, 
			CASE WHEN IsForDpos = 1 THEN CONVERT(NUMERIC(12,2),((stock.Stk_Mrp - (stock.Stk_Mrp * ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
			ELSE CONVERT(NUMERIC(12,2),((stock.Stk_Mrp - (stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0)) / (100 + ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
			stock.Stk_ExpDate AS Item_ExpDate, stock.Stk_SalesUom, uom.Uom_Code AS Item_Uom, uomPurchase.Uom_Code AS Purchase_Item_Uom, 
			CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, stock.Stk_MnfDate AS Item_MnfDate, 
			ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, mm.MM_PackSize AS Ps_Code, mm.MM_PurchaseRatio, mm.MM_SalesRatio, uomPurchase.Uom_ID AS Purchase_Item_Uom_Id, 
			stock.Stk_LmId, lm.Lm_Name
FROM		dbo.StockRegister AS stock WITH (NOLOCK) 
		LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
ON			stock.Stk_MmId = mm.Mm_ID 
		LEFT OUTER JOIN dbo.LocationMaster AS lm 
ON			stock.Stk_LmId = lm.Lm_Id 
		LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
ON			uom.Uom_ID = stock.Stk_SalesUom 
		LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
		CROSS JOIN dbo.ConfigurationMaster
		LEFT JOIN vwMedicineTaxPrc taxprc
ON			stock.Stk_MmId=taxprc.Mtm_MmId
WHERE       (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) >= CONVERT(DATE, GETDATE())) OR
			(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0), stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
			DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
			DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
			stock.Stk_SalesUom, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
			mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
			uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
			mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name) AS FN
GROUP BY	Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, 
			Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name
GO
/****** Object:  View [dbo].[vwStock12032019]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[vwStock12032019]
AS
SELECT  Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, SUM(Item_Stock) AS Item_Stock, CONVERT(varchar(100), SUM(Sales_Qty)) + '(' + Item_Uom + ')' AS Sales_Qty, 
		CONVERT(varchar(100), SUM(Purchase_Qty)) + '(' + Purchase_Item_Uom + ')' AS Purchase_Qty, SUM(Purchase_Item_Stock) AS Purchase_Item_Stock, 
        Purchase_Item_Rate,
		Item_Rate, 
		Item_ExpDate, 
		Stk_SalesUom, 
		Item_Uom, 
		Purchase_Item_Uom, 
		Stk_ExpDate, 
		Stk_MnfDate, 
		Item_MnfDate, 
		Item_MRP, Ps_Code, 
        MM_PurchaseRatio, 
		MM_SalesRatio, 
		Purchase_Item_Uom_Id, 
		Stk_LmId, 
		Lm_Name
FROM	(SELECT        
				CAST(0 AS bit) AS Chk, 
				stock.Stk_MmId AS Item_Id, 
				mm.Mm_Code AS Item_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo AS Item_Batchno, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Item_Stock, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Item_Stock, 
				
				--stock.Stk_PurchaseRate AS Purchase_Item_Rate, 
				0.00 AS Purchase_Item_Rate, 

				CASE WHEN IsForDpos=1 THEN CONVERT(NUMERIC(12,4),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
				ELSE CONVERT(NUMERIC(12,4),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
				--stock.Stk_SalesRate AS Item_Rate, 

				stock.Stk_ExpDate AS Item_ExpDate, 
				stock.Stk_SalesUom, 
				uom.Uom_Code AS Item_Uom, 
				uomPurchase.Uom_Code AS Purchase_Item_Uom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				stock.Stk_MnfDate AS Item_MnfDate, 
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				mm.MM_PackSize AS Ps_Code, 
				mm.MM_PurchaseRatio, 
				mm.MM_SalesRatio, 
				uomPurchase.Uom_ID AS Purchase_Item_Uom_Id, 
				stock.Stk_LmId, 
				lm.Lm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
				LEFT JOIN vwMedicineTaxPrc taxprc
		ON		stock.Stk_MmId=taxprc.Mtm_MmId
		WHERE        (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) >= CONVERT(DATE, GETDATE())) OR
				(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
		GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0),
					stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					stock.Stk_SalesUom, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name) AS FN
GROUP BY	Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, 
			Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name





GO
/****** Object:  View [dbo].[vwExpiredStockBatchWise]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwExpiredStockBatchWise]
as
SELECT	Stk_MmId, 
		Mm_Code, 
		Stk_BatchNo, 
		ISNULL(Stk_Mrp, 0) AS Stk_Mrp, 
		ISNULL(Item_Rate, 0) AS STK_RATE,  
		Stk_ExpDate, 
		SUM(Sales_Qty)AS QTY,
		Mm_Name, 
		Stk_SalesUom AS Uom_Name
FROM    (SELECT stock.Stk_MmId, 
				mm.Mm_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo, 
				stock.Stk_Mrp, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty,  
				

				CASE WHEN IsForDpos=1 THEN CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
				ELSE CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
				
				uom.Uom_Name AS Stk_SalesUom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				Mm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
				LEFT JOIN vwMedicineTaxPrc taxprc
		ON		stock.Stk_MmId=taxprc.Mtm_MmId
		WHERE        (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) <= CONVERT(DATE, GETDATE())) OR
				(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
		GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0),
					stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					uom.Uom_Name, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name)AS DT
GROUP BY	Stk_MmId, Mm_Code, Stk_BatchNo,Stk_Mrp, Item_Rate, Stk_ExpDate, Mm_Name, Stk_SalesUom



GO
/****** Object:  View [dbo].[vwStockBatchWise]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwStockBatchWise]
as
SELECT	Stk_MmId, 
		Mm_Code, 
		Stk_BatchNo, 
		ISNULL(Stk_Mrp, 0) AS Stk_Mrp, 
		ISNULL(Item_Rate, 0) AS STK_RATE,  
		Stk_ExpDate, 
		SUM(Sales_Qty)AS QTY,
		Mm_Name, 
		Stk_SalesUom AS Uom_Name
FROM    (SELECT stock.Stk_MmId, 
				mm.Mm_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo, 
				stock.Stk_Mrp, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty,  
				

				CASE WHEN IsForDpos=1 THEN CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
				ELSE CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
				
				uom.Uom_Name AS Stk_SalesUom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				Mm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
				LEFT JOIN vwMedicineTaxPrc taxprc
		ON		stock.Stk_MmId=taxprc.Mtm_MmId
		WHERE        (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) >= CONVERT(DATE, GETDATE())) OR
				(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
		GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0),
					stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					uom.Uom_Name, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name)AS DT
GROUP BY	Stk_MmId, Mm_Code, Stk_BatchNo,Stk_Mrp, Item_Rate, Stk_ExpDate, Mm_Name, Stk_SalesUom

GO
/****** Object:  View [dbo].[vwStockWithExp]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwStockWithExp]
AS
SELECT  Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, SUM(Item_Stock) AS Item_Stock, CONVERT(varchar(100), SUM(Sales_Qty)) + '(' + Item_Uom + ')' AS Sales_Qty, 
		CONVERT(varchar(100), SUM(Purchase_Qty)) + '(' + Purchase_Item_Uom + ')' AS Purchase_Qty, SUM(Purchase_Item_Stock) AS Purchase_Item_Stock, 
        Purchase_Item_Rate,
		Item_Rate, 
		Item_ExpDate, 
		Stk_SalesUom, 
		Item_Uom, 
		Purchase_Item_Uom, 
		Stk_ExpDate, 
		Stk_MnfDate, 
		Item_MnfDate, 
		Item_MRP, Ps_Code, 
        MM_PurchaseRatio, 
		MM_SalesRatio, 
		Purchase_Item_Uom_Id, 
		Stk_LmId, 
		Lm_Name
FROM	(SELECT        
				CAST(0 AS bit) AS Chk, 
				stock.Stk_MmId AS Item_Id, 
				mm.Mm_Code AS Item_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo AS Item_Batchno, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Item_Stock, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Item_Stock, 
				
				--stock.Stk_PurchaseRate AS Purchase_Item_Rate, 
				0.00 AS Purchase_Item_Rate, 

				CASE WHEN IsForDpos=1 THEN CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
				ELSE CONVERT(NUMERIC(12,2),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
				--stock.Stk_SalesRate AS Item_Rate, 

				stock.Stk_ExpDate AS Item_ExpDate, 
				stock.Stk_SalesUom, 
				uom.Uom_Code AS Item_Uom, 
				uomPurchase.Uom_Code AS Purchase_Item_Uom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				stock.Stk_MnfDate AS Item_MnfDate, 
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				mm.MM_PackSize AS Ps_Code, 
				mm.MM_PurchaseRatio, 
				mm.MM_SalesRatio, 
				uomPurchase.Uom_ID AS Purchase_Item_Uom_Id, 
				stock.Stk_LmId, 
				lm.Lm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
				LEFT JOIN vwMedicineTaxPrc taxprc
		ON		stock.Stk_MmId=taxprc.Mtm_MmId
		
		GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0),
					stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					stock.Stk_SalesUom, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name) AS FN
GROUP BY	Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, 
			Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name





GO
/****** Object:  View [dbo].[vwStock]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[vwStock]
AS
SELECT  Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, SUM(Item_Stock) AS Item_Stock, CONVERT(varchar(100), SUM(Sales_Qty)) + '(' + Item_Uom + ')' AS Sales_Qty, 
		CONVERT(varchar(100), SUM(Purchase_Qty)) + '(' + Purchase_Item_Uom + ')' AS Purchase_Qty, SUM(Purchase_Item_Stock) AS Purchase_Item_Stock, 
        Purchase_Item_Rate,
		Item_Rate, 
		Item_ExpDate, 
		Stk_SalesUom, 
		Item_Uom, 
		Purchase_Item_Uom, 
		Stk_ExpDate, 
		Stk_MnfDate, 
		Item_MnfDate, 
		Item_MRP, Ps_Code, 
        MM_PurchaseRatio, 
		MM_SalesRatio, 
		Purchase_Item_Uom_Id, 
		Stk_LmId, 
		Lm_Name
FROM	(SELECT        
				CAST(0 AS bit) AS Chk, 
				stock.Stk_MmId AS Item_Id, 
				mm.Mm_Code AS Item_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo AS Item_Batchno, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Item_Stock, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Item_Stock, 
				
				--stock.Stk_PurchaseRate AS Purchase_Item_Rate, 
				0.00 AS Purchase_Item_Rate, 

				CASE WHEN IsForDpos=1 THEN CONVERT(NUMERIC(12,4),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/100*80))
				ELSE CONVERT(NUMERIC(12,4),((stock.Stk_Mrp-(stock.Stk_Mrp*ISNULL(taxprc.Tax_Prc,0))/(100+ISNULL(taxprc.Tax_Prc,0)))/1)) END AS Item_Rate,
				--stock.Stk_SalesRate AS Item_Rate, 

				stock.Stk_ExpDate AS Item_ExpDate, 
				stock.Stk_SalesUom, 
				uom.Uom_Code AS Item_Uom, 
				uomPurchase.Uom_Code AS Purchase_Item_Uom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				stock.Stk_MnfDate AS Item_MnfDate, 
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				mm.MM_PackSize AS Ps_Code, 
				mm.MM_PurchaseRatio, 
				mm.MM_SalesRatio, 
				uomPurchase.Uom_ID AS Purchase_Item_Uom_Id, 
				stock.Stk_LmId, 
				lm.Lm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
				LEFT JOIN vwMedicineTaxPrc taxprc
		ON		stock.Stk_MmId=taxprc.Mtm_MmId
		WHERE        (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) >= CONVERT(DATE, GETDATE())) OR
				(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
		GROUP BY	IsForDpos,ISNULL(taxprc.Tax_Prc,0),
					stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, --stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					stock.Stk_SalesUom, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name) AS FN
GROUP BY	Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, 
			Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name






GO
/****** Object:  View [dbo].[vwBillDetail]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwBillDetail]
AS
SELECT        at.Act_DocType, 
                         CASE WHEN Act_DocType = 2 THEN 'SalesInvoice' WHEN Act_DocType = 3 THEN 'SalesReturn' WHEN Act_DocType = 4 THEN 'PurchaseInvoice' WHEN Act_DocType
                          = 5 THEN 'PurchaseReturn' ELSE '' END AS BookType, at.Act_Date AS BillDate, CONVERT(decimal(18, 2), ISNULL(at.Act_Amount, 0.00)) AS BillAmount, 
                         CONVERT(decimal(18, 2), 0.00) AS BillPayAmount, CONVERT(decimal(18, 2), ISNULL(at.Act_Amount, 0.00)) - (CONVERT(decimal(18, 2), ISNULL(at.Act_PaidAmount, 
                         0.00)) + CONVERT(decimal(18, 2), ISNULL(at.Act_AdjustAmount, 0.00))) AS BillRemainingAmount, at.Act_LedgerId, at.Act_DrCr, at.Act_DocNo AS BillNo, at.Act_DocKey, 
                         CONVERT(decimal(18, 2), ISNULL(at.Act_AdjustAmount, 0.00)) AS BillAdjustAmount, CONVERT(decimal(18, 2), ISNULL(at.Act_PaidAmount, 0.00)) AS BillPaidAmount, 
                         CONVERT(decimal(18, 2), 0.00) AS AdjustAmount, at.Act_Key
FROM            dbo.AccountTransaction AS at LEFT OUTER JOIN
                         dbo.AccountTransactionRef AS atr ON at.Act_Key = atr.Acr_ActKey
GROUP BY at.Act_DocType, at.Act_Date, at.Act_Amount, at.Act_PaidAmount, at.Act_LedgerId, at.Act_DrCr, at.Act_DocNo, at.Act_DocKey, at.Act_AdjustAmount, at.Act_Key

GO
/****** Object:  View [dbo].[vwBillWiseList]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwBillWiseList]
AS
SELECT        act.Act_DocType, act.Act_Key, btm.Btm_ModeName, CONVERT(date, act.Act_Date) AS Date, act.Act_Amount, act.Act_DrCr, act.Act_LedgerId, act.Act_VoucherNo, 
                         act.Act_PaidAmount AS Acr_PayAmount, SUM(ISNULL(ref.Acr_AdjAmount, 0)) AS Acr_AdjAmount, lm.Lm_Name
FROM            dbo.AccountTransaction AS act LEFT OUTER JOIN
                         dbo.BookTypeMaster AS btm ON act.Act_DocType = btm.Btm_Id LEFT OUTER JOIN
                         dbo.LedgerMaster AS lm ON act.Act_LedgerId = lm.Lm_Id LEFT OUTER JOIN
                         dbo.AccountTransactionRef AS ref ON act.Act_Key = ref.Acr_ActKey
WHERE        (act.Act_SrNo = 2) AND (act.Act_VoucherNo <> 0)
GROUP BY act.Act_DocType, act.Act_Key, btm.Btm_ModeName, CONVERT(date, act.Act_Date), act.Act_Amount, act.Act_DrCr, act.Act_LedgerId, act.Act_VoucherNo, 
                         act.Act_PaidAmount, lm.Lm_Name

GO
/****** Object:  View [dbo].[vwChallanAllocated]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwChallanAllocated]
AS
SELECT	A.Scd_Mm_Id,
		A.Scd_BatchNo,
		SUM(ISNULL(Scd_SalesQty,0)-ISNULL(Scd_Sid_SalesQty,0)) AS Allocated_Challan_Qty
FROM	SalesChallenItemDetails A
GROUP BY A.Scd_Mm_Id,A.Scd_BatchNo
HAVING SUM(ISNULL(Scd_SalesQty,0)-ISNULL(Scd_Sid_SalesQty,0))>0
GO
/****** Object:  View [dbo].[vwStock_old]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[vwStock_old]
AS
SELECT  Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, SUM(Item_Stock) AS Item_Stock, CONVERT(varchar(100), SUM(Sales_Qty)) + '(' + Item_Uom + ')' AS Sales_Qty, 
		CONVERT(varchar(100), SUM(Purchase_Qty)) + '(' + Purchase_Item_Uom + ')' AS Purchase_Qty, SUM(Purchase_Item_Stock) AS Purchase_Item_Stock, 
        Purchase_Item_Rate,
		Item_Rate, 
		Item_ExpDate, 
		Stk_SalesUom, 
		Item_Uom, 
		Purchase_Item_Uom, 
		Stk_ExpDate, 
		Stk_MnfDate, 
		Item_MnfDate, 
		Item_MRP, Ps_Code, 
        MM_PurchaseRatio, 
		MM_SalesRatio, 
		Purchase_Item_Uom_Id, 
		Stk_LmId, 
		Lm_Name
FROM	(SELECT        
				CAST(0 AS bit) AS Chk, 
				stock.Stk_MmId AS Item_Id, 
				mm.Mm_Code AS Item_Code, 
				mm.Mm_Name AS Item_Name, 
				stock.Stk_BatchNo AS Item_Batchno, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Item_Stock, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_SalesQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_SalesQty ELSE 0 END) AS Sales_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Qty, 
				SUM(CASE WHEN stock.Stk_Tran_Typ = 'C' THEN stock.Stk_PurchaseQty ELSE 0 END) 
				- SUM(CASE WHEN stock.Stk_Tran_Typ = 'D' THEN stock.Stk_PurchaseQty ELSE 0 END) AS Purchase_Item_Stock, 
				stock.Stk_PurchaseRate AS Purchase_Item_Rate, 
				stock.Stk_SalesRate AS Item_Rate, 
				stock.Stk_ExpDate AS Item_ExpDate, 
				stock.Stk_SalesUom, 
				uom.Uom_Code AS Item_Uom, 
				uomPurchase.Uom_Code AS Purchase_Item_Uom, 
				CONVERT(date, stock.Stk_ExpDate) AS Stk_ExpDate, 
				CONVERT(date, stock.Stk_MnfDate) AS Stk_MnfDate, 
				stock.Stk_MnfDate AS Item_MnfDate, 
				ISNULL(stock.Stk_Mrp, 0.00) AS Item_MRP, 
				mm.MM_PackSize AS Ps_Code, 
				mm.MM_PurchaseRatio, 
				mm.MM_SalesRatio, 
				uomPurchase.Uom_ID AS Purchase_Item_Uom_Id, 
				stock.Stk_LmId, 
				lm.Lm_Name
		FROM    dbo.StockRegister AS stock WITH (NOLOCK) 
				LEFT OUTER JOIN dbo.MedicineMaster AS mm WITH (NOLOCK) 
		ON			stock.Stk_MmId = mm.Mm_ID 
				LEFT OUTER JOIN dbo.LocationMaster AS lm 
		ON			stock.Stk_LmId = lm.Lm_Id 
				LEFT OUTER JOIN dbo.UomMaster AS uom WITH (NOLOCK) 
		ON			uom.Uom_ID = stock.Stk_SalesUom 
				LEFT OUTER JOIN dbo.UomMaster AS uomPurchase WITH (NOLOCK) 
		ON			uomPurchase.Uom_ID = stock.Stk_PurchaseUom 
				CROSS JOIN dbo.ConfigurationMaster
		WHERE        (ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 1) AND (CONVERT(DATE, ISNULL(stock.Stk_ExpDate, GETDATE())) >= CONVERT(DATE, GETDATE())) OR
				(ISNULL(dbo.ConfigurationMaster.StockWithExpDate, 0) = 0) AND (1 = 1)
		GROUP BY	stock.Stk_MmId, stock.Stk_BatchNo, mm.Mm_Code, mm.Mm_Name, stock.Stk_SalesRate, 
					DATENAME(m, stock.Stk_ExpDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_ExpDate) AS varchar), 
					DATENAME(m, stock.Stk_MnfDate) + ' ' + CAST(DATEPART(yyyy, stock.Stk_MnfDate) AS varchar), 
					stock.Stk_SalesUom, uom.Uom_Code, stock.Stk_MnfDate, stock.Stk_ExpDate, stock.Stk_Mrp, 
					mm.MM_PackSize, dbo.ConfigurationMaster.StockWithExpDate, stock.Stk_PurchaseRate, 
					uomPurchase.Uom_Code, stock.Stk_PurchaseUom, mm.MM_PurchaseRatio, 
					mm.MM_SalesRatio, uomPurchase.Uom_ID, stock.Stk_LmId, lm.Lm_Name) AS FN
GROUP BY	Chk, Item_Id, Item_Code, Item_Name, Item_Batchno, Purchase_Item_Rate, Item_Rate, Item_ExpDate, Stk_SalesUom, Item_Uom, Purchase_Item_Uom, Stk_ExpDate, 
			Stk_MnfDate, Item_MnfDate, Item_MRP, Ps_Code, MM_PurchaseRatio, MM_SalesRatio, Purchase_Item_Uom_Id, Stk_LmId, Lm_Name


GO
/****** Object:  View [dbo].[VwTotalStock]    Script Date: 02-04-2019 18:36:09 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[VwTotalStock]
AS
SELECT        Stk_MmId AS STK_ITEM_ID, SUM(COALESCE (CASE WHEN STK_TRAN_Typ = 'C' THEN Stk_SalesQty END, 0)) 
                         - SUM(COALESCE (CASE WHEN STK_TRAN_Typ = 'D' THEN Stk_SalesQty END, 0)) AS STOCK
FROM            dbo.StockRegister WITH (NOLOCK)
GROUP BY Stk_MmId

GO

